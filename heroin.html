<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AblesAI Document Analyzer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #fafaf9;
      --bg-secondary: #f5f5f4;
      --bg-tertiary: #e7e5e4;
      --bg-card: #ffffff;
      --text-primary: #1c1917;
      --text-secondary: #44403c;
      --text-muted: #78716c;
      --border-primary: #d6d3d1;
      --border-secondary: #e7e5e4;
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --tier-a: #22c55e;
      --tier-b: #84cc16;
      --tier-c: #eab308;
      --tier-d: #f97316;
      --tier-e: #ef4444;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.12);
    }

    .dark-mode {
      --bg-primary: #0c0a09;
      --bg-secondary: #1c1917;
      --bg-tertiary: #292524;
      --bg-card: #1c1917;
      --text-primary: #fafaf9;
      --text-secondary: #d6d3d1;
      --text-muted: #a8a29e;
      --border-primary: #44403c;
      --border-secondary: #292524;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
    }

    .header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-primary);
      border-top: 3px solid;
      border-image: linear-gradient(90deg, #facc15, #eab308, #ca8a04) 1;
      padding: 12px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon { width: 40px; height: 40px; }
    .logo-icon svg { width: 100%; height: 100%; }

    .logo-text {
      font-weight: 700;
      font-size: 1.4rem;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    .logo-ai {
      color: var(--text-muted);
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .api-input {
      padding: 8px 14px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.85rem;
      width: 260px;
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .api-input::placeholder { color: var(--text-muted); }
    .api-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(234,179,8,0.15); }

    .api-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--tier-e);
    }

    .status-dot.active {
      background: var(--tier-a);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .theme-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .theme-btn:hover { background: var(--bg-tertiary); }
    .theme-btn svg { width: 18px; height: 18px; stroke: var(--text-muted); }
    .theme-btn .moon-icon { display: none; }
    .dark-mode .theme-btn .sun-icon { display: none; }
    .dark-mode .theme-btn .moon-icon { display: block; }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px 32px;
    }

    .tab-nav {
      display: flex;
      align-items: stretch;
      background: var(--bg-secondary);
      padding: 8px;
      border-radius: 16px;
      margin-bottom: 24px;
      overflow-x: auto;
      gap: 0;
    }

    .workflow-step {
      display: flex;
      align-items: center;
      position: relative;
    }

    .tab-btn {
      padding: 12px 16px;
      border: none;
      background: transparent;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
      position: relative;
    }

    .tab-btn .step-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      flex-shrink: 0;
      position: relative;
      transition: all 0.3s;
    }

    .tab-btn .step-icon svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      transition: all 0.3s;
    }

    /* Processing state - spinner around icon */
    .tab-btn.processing .step-icon {
      background: transparent;
      border: 2px solid var(--accent);
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    
    .tab-btn.processing .step-icon svg {
      display: none;
    }

    .tab-btn.processing .step-icon::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite reverse;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .workflow-step.processing .workflow-arrow svg {
      color: var(--accent);
      opacity: 1;
    }

    .tab-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .tab-btn:hover .step-icon { background: var(--bg-secondary); }
    .tab-btn.processing:hover .step-icon { background: transparent; }

    .tab-btn.active { 
      background: var(--bg-card); 
      color: var(--text-primary); 
      box-shadow: var(--shadow-sm); 
    }
    
    .tab-btn.active .step-icon {
      background: var(--bg-tertiary);
      border: 2px solid var(--accent);
    }
    
    .tab-btn.active .step-icon svg {
      color: var(--accent);
    }

    .tab-btn.active.processing .step-icon {
      background: transparent;
      border: 2px solid var(--accent);
      border-top-color: transparent;
    }

    /* Completed state - colored icon */
    .tab-btn.completed .step-icon {
      background: var(--tier-a);
      border: none;
    }
    
    .tab-btn.completed .step-icon svg {
      color: #fff;
    }
    
    .tab-btn.completed {
      color: var(--text-primary);
    }

    .tab-btn.completed.active .step-icon {
      background: var(--tier-a);
      border: 2px solid var(--tier-a);
    }
    
    /* Special tab colors when completed */
    .tab-btn.engine-tab.completed .step-icon { background: var(--accent); }
    .tab-btn.engine-tab.completed .step-icon svg { color: #000; }
    .tab-btn.review-tab.completed .step-icon { background: #3b82f6; }
    .tab-btn.compare-tab.completed .step-icon { background: #22c55e; }

    .tab-btn svg.tab-icon { display: none; } /* Hide old icons */
    
    /* Step status text */
    .step-status {
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-left: -4px;
    }
    
    .tab-btn.processing .step-status { color: var(--accent); }
    .tab-btn.completed .step-status { color: var(--tier-a); }

    .workflow-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent);
      padding: 0 6px;
      flex-shrink: 0;
    }

    .workflow-arrow svg {
      width: 20px;
      height: 20px;
      opacity: 0.6;
      transition: all 0.3s;
      stroke-width: 2.5;
    }

    .workflow-step.completed + .workflow-arrow svg,
    .workflow-step.completed .workflow-arrow svg {
      color: var(--tier-a);
      opacity: 1;
    }
    
    .workflow-step.processing + .workflow-arrow svg,
    .workflow-step.processing .workflow-arrow svg {
      color: var(--accent);
      opacity: 1;
      animation: arrowPulse 1s ease-in-out infinite;
    }
    
    @keyframes arrowPulse {
      0%, 100% { transform: translateX(0); opacity: 0.7; }
      50% { transform: translateX(3px); opacity: 1; }
    }

    .workflow-divider {
      width: 1px;
      height: 28px;
      background: var(--border-primary);
      margin: 0 8px;
      flex-shrink: 0;
    }

    .tab-btn .badge {
      background: var(--accent);
      color: #000;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 8px;
      font-weight: 700;
    }

    .tab-btn.completed .badge { background: var(--tier-a); color: #fff; }

    /* Step processing progress badge */
    .step-progress {
      display: none;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(234,179,8,0.2);
      border-radius: 10px;
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--accent);
      white-space: nowrap;
    }

    .tab-btn.processing .step-progress {
      display: flex;
    }

    .step-progress-spinner {
      width: 8px;
      height: 8px;
      border: 2px solid rgba(234,179,8,0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .tab-btn.completed .step-progress { display: none; }

    /* Hide old elements */
    .workflow-section-label { display: none; }

    /* Mobile responsive workflow */
    @media (max-width: 1200px) {
      .tab-btn {
        padding: 10px 12px;
        font-size: 0.75rem;
      }
      .tab-btn .step-icon {
        width: 28px;
        height: 28px;
      }
      .tab-btn .step-icon svg { width: 14px; height: 14px; }
      .workflow-arrow svg { width: 14px; height: 14px; }
    }

    @media (max-width: 900px) {
      .tab-nav {
        flex-wrap: wrap;
        justify-content: center;
      }
      .workflow-divider {
        width: 100%;
        height: 1px;
        margin: 8px 0;
      }
      .step-status { display: none; }
    }

    @media (max-width: 600px) {
      .tab-btn {
        padding: 8px 10px;
        font-size: 0.7rem;
      }
      .workflow-arrow { padding: 0 2px; }
      .workflow-arrow svg { width: 12px; height: 12px; }
      .tab-btn .step-icon { width: 26px; height: 26px; }
    }

    /* Special tab styling */
    .tab-btn.engine-tab { 
      background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05)); 
      border: 1px solid rgba(234,179,8,0.3);
    }
    .tab-btn.engine-tab:hover { background: linear-gradient(135deg, rgba(250,204,21,0.2), rgba(234,179,8,0.1)); }
    .tab-btn.engine-tab.active { background: linear-gradient(135deg, rgba(250,204,21,0.25), rgba(234,179,8,0.15)); }
    .tab-btn.engine-tab .step-icon { background: rgba(234,179,8,0.2); }
    .tab-btn.engine-tab .step-icon svg { color: var(--accent); }
    .tab-btn.engine-tab.active .step-icon { background: rgba(234,179,8,0.3); border-color: var(--accent); }

    .tab-btn.review-tab { 
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(37,99,235,0.05)); 
      border: 1px solid rgba(59,130,246,0.3);
    }
    .tab-btn.review-tab:hover { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1)); }
    .tab-btn.review-tab.active { background: linear-gradient(135deg, rgba(59,130,246,0.25), rgba(37,99,235,0.15)); }
    .tab-btn.review-tab .step-icon { background: rgba(59,130,246,0.2); }
    .tab-btn.review-tab .step-icon svg { color: #3b82f6; }
    .tab-btn.review-tab.active .step-icon { background: rgba(59,130,246,0.3); border-color: #3b82f6; }

    .tab-btn.compare-tab { 
      background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.05)); 
      border: 1px solid rgba(34,197,94,0.3);
    }
    .tab-btn.compare-tab:hover { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(22,163,74,0.1)); }
    .tab-btn.compare-tab.active { background: linear-gradient(135deg, rgba(34,197,94,0.25), rgba(22,163,74,0.15)); }
    .tab-btn.compare-tab .step-icon { background: rgba(34,197,94,0.2); }
    .tab-btn.compare-tab .step-icon svg { color: #22c55e; }
    .tab-btn.compare-tab.active .step-icon { background: rgba(34,197,94,0.3); border-color: #22c55e; }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Editable Application Form Styles */
    .app-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .app-form-section {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
    }

    .app-form-section.half {
      flex: 1;
    }

    .app-form-row {
      display: flex;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .app-form-row { flex-direction: column; }
    }

    .app-form-section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-primary);
    }

    .app-form-section-title svg {
      width: 20px;
      height: 20px;
      color: var(--accent);
    }

    .app-form-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .app-form-grid.single {
      grid-template-columns: 1fr;
    }

    @media (max-width: 1200px) {
      .app-form-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 900px) {
      .app-form-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 600px) {
      .app-form-grid { grid-template-columns: 1fr; }
    }

    .app-form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-form-field.full-width {
      grid-column: span 2;
    }

    @media (max-width: 600px) {
      .app-form-field.full-width { grid-column: span 1; }
    }

    .app-form-field label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .app-form-field input,
    .app-form-field select {
      padding: 10px 12px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .app-form-field input:focus,
    .app-form-field select:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-card);
      box-shadow: 0 0 0 3px rgba(234,179,8,0.1);
    }

    .app-form-field input:not(:placeholder-shown),
    .app-form-field input:valid:not([value=""]),
    .app-form-field select:valid:not([value=""]) {
      background: var(--bg-card);
      border-color: var(--tier-a);
    }

    .app-form-field input::placeholder {
      color: var(--text-muted);
      opacity: 0.6;
    }

    .app-form-field select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .app-form-field.has-value input,
    .app-form-field.has-value select {
      background: var(--bg-card);
      border-color: rgba(16, 185, 129, 0.4);
    }

    /* Workflow Progress Banner */
    .workflow-progress-banner {
      background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.05));
      border: 1px solid rgba(234,179,8,0.3);
      border-radius: 12px;
      padding: 14px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      animation: fadeIn 0.3s ease;
    }

    .workflow-progress-icon {
      flex-shrink: 0;
    }

    .workflow-progress-info {
      flex: 1;
      min-width: 0;
    }

    .workflow-progress-step {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .workflow-progress-detail {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .workflow-progress-bar-container {
      width: 200px;
      height: 6px;
      background: rgba(234,179,8,0.2);
      border-radius: 3px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .workflow-progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    @media (max-width: 768px) {
      .workflow-progress-banner {
        flex-wrap: wrap;
        gap: 12px;
      }
      .workflow-progress-bar-container {
        width: 100%;
        order: 3;
      }
    }

    .dropzone {
      border: 2px dashed var(--border-primary);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      background: var(--bg-card);
      transition: all 0.3s;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .dropzone.main-dropzone { padding: 48px; border-color: var(--accent); }
    .dropzone.main-dropzone .dropzone-icon { background: linear-gradient(135deg, rgba(250,204,21,0.15), rgba(234,179,8,0.1)); }
    .dropzone.main-dropzone .dropzone-icon svg { color: var(--accent); }
    .dropzone:hover, .dropzone.dragover { border-color: var(--accent); background: var(--bg-secondary); transform: translateY(-2px); }

    .dropzone-icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 14px;
      background: var(--bg-tertiary);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dropzone-icon svg { width: 28px; height: 28px; color: var(--text-muted); }
    .dropzone-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; }
    .dropzone-subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px; }

    .dropzone-formats { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }

    .format-badge {
      background: var(--bg-tertiary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .file-input { display: none; }

    .doc-thumbnails {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .doc-thumb {
      width: 80px;
      height: 100px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .doc-thumb:hover { transform: scale(1.05); box-shadow: var(--shadow-md); }
    .doc-thumb img { width: 100%; height: 100%; object-fit: cover; }

    .doc-thumb-pdf {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 8px;
    }

    .doc-thumb-pdf svg { width: 24px; height: 24px; color: var(--tier-e); margin-bottom: 4px; }
    .doc-thumb-pdf span { font-size: 0.55rem; color: var(--text-muted); text-align: center; word-break: break-word; line-height: 1.2; }

    .doc-thumb-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: #fff;
      padding: 12px 4px 4px;
      font-size: 0.5rem;
      font-weight: 600;
    }

    .doc-thumb.processing::after {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .doc-thumb.processing::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      margin: -12px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      z-index: 1;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .image-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 40px;
    }

    .image-modal.active { display: flex; }
    .image-modal img { max-width: 100%; max-height: 100%; border-radius: 12px; }

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title svg { width: 16px; height: 16px; }

    /* Section Header with Actions */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .section-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-header-title {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .section-header-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .section-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--bg-tertiary);
    }

    .section-status-dot.pending { background: var(--text-muted); }
    .section-status-dot.processing { 
      background: var(--accent);
      animation: pulse 1.5s ease-in-out infinite;
    }
    .section-status-dot.complete { background: var(--tier-a); }
    .section-status-dot.error { background: var(--tier-e); }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .section-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-rerun {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-rerun:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .btn-rerun:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-rerun svg {
      width: 14px;
      height: 14px;
    }

    .btn-rerun.processing svg {
      animation: spin 1s linear infinite;
    }

    /* Processing overlay - NON-BLOCKING */
    .processing-overlay {
      position: absolute;
      top: 8px;
      right: 8px;
      left: auto;
      bottom: auto;
      background: rgba(var(--bg-primary-rgb, 255,255,255), 0.95);
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 20px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.8rem;
    }

    .dark-mode .processing-overlay {
      background: rgba(30, 30, 30, 0.95);
    }

    .processing-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .processing-overlay .processing-spinner {
      width: 16px;
      height: 16px;
    }
    
    .processing-overlay .processing-progress {
      display: none;
    }

    .processing-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .processing-text {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .processing-progress {
      width: 200px;
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
    }

    .processing-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--tier-a));
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .kpi-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      transition: all 0.15s;
    }

    .kpi-card[onclick]:hover {
      background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(250,204,21,0.05));
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .kpi-value {
      font-size: 1.2rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      margin-bottom: 2px;
    }

    .kpi-value.positive { color: var(--tier-a); }
    .kpi-value.negative { color: var(--tier-e); }
    .kpi-value.warning { color: var(--tier-d); }

    .kpi-label {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .data-table th {
      padding: 10px 8px;
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      text-align: center;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-primary);
      white-space: nowrap;
    }

    .data-table th:first-child { text-align: left; }

    .data-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid var(--border-secondary);
      font-variant-numeric: tabular-nums;
    }

    .data-table td:first-child { text-align: left; font-weight: 600; }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: var(--bg-secondary); }

    .data-table tfoot { border-top: 2px solid var(--border-primary); }
    .data-table .totals-row td { 
      background: linear-gradient(135deg, rgba(234,179,8,0.08), rgba(250,204,21,0.05)); 
      font-weight: 700; 
      color: var(--accent);
      padding: 12px 10px;
    }
    .data-table .totals-row td:first-child { color: var(--text-primary); }

    .text-positive { color: var(--tier-a); }
    .text-negative { color: var(--tier-e); }
    .text-warning { color: var(--tier-d); }

    /* Clickable month rows */
    .data-table tr.clickable-row { cursor: pointer; transition: all 0.15s; }
    .data-table tr.clickable-row:hover td { background: linear-gradient(135deg, rgba(234,179,8,0.1), rgba(250,204,21,0.05)); }
    .data-table tr.clickable-row.active td { background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(250,204,21,0.08)); border-color: var(--accent); }

    /* Transaction detail panel */
    .txn-summary-item {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 12px;
      text-align: center;
    }
    .txn-summary-value { display: block; font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    .txn-summary-label { display: block; font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted); margin-top: 2px; }

    .txn-table td { font-size: 0.75rem; padding: 8px 6px; }
    .txn-table .txn-desc { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
    .txn-table .txn-type { text-transform: uppercase; font-size: 0.6rem; font-weight: 600; }
    .txn-table .txn-type.deposit { color: var(--tier-a); background: rgba(34,197,94,0.1); padding: 3px 8px; border-radius: 4px; }
    .txn-table .txn-type.debit { color: var(--tier-e); background: rgba(239,68,68,0.1); padding: 3px 8px; border-radius: 4px; }

    .btn.active { background: var(--accent); color: #000; }

    .chart-container { height: 220px; }

    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .three-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }

    @media (max-width: 900px) { .two-col, .three-col { grid-template-columns: 1fr; } }

    .score-display {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 14px;
      margin-bottom: 16px;
    }

    .score-ring {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: conic-gradient(var(--score-color, #8b5cf6) calc(var(--pct, 0) * 1%), var(--border-secondary) 0);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .score-ring-inner {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .score-number { font-size: 1.2rem; font-weight: 700; }
    .score-label-small { font-size: 0.45rem; color: var(--text-muted); text-transform: uppercase; }
    .score-info h3 { font-size: 0.95rem; margin-bottom: 2px; }
    .score-info p { color: var(--text-muted); font-size: 0.75rem; }

    .item-card {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 3px solid var(--border-primary);
    }

    .item-card.positive { border-left-color: var(--tier-a); }
    .item-card.negative { border-left-color: var(--tier-e); }

    .item-card-info { flex: 1; }
    .item-card-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
    .item-card-meta { font-size: 0.7rem; color: var(--text-muted); }
    .item-card-value { font-size: 0.95rem; font-weight: 700; }

    .empty-state {
      text-align: center;
      padding: 32px 20px;
      color: var(--text-muted);
    }

    .empty-state svg { width: 36px; height: 36px; margin-bottom: 8px; opacity: 0.4; }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--text-primary);
      color: var(--bg-primary);
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.85rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }

    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: var(--tier-e); color: white; }
    .toast.success { background: var(--tier-a); color: white; }

    .results-section { display: none; }
    .results-section.active { display: block; }

    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary { background: linear-gradient(135deg, #facc15, #eab308); color: #1c1917; font-weight: 600; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); background: linear-gradient(135deg, #fde047, #facc15); }
    .btn svg { width: 14px; height: 14px; }

    .branded-statement {
      background: #fff;
      color: #1c1917;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      margin-top: 16px;
    }

    .branded-header {
      background: linear-gradient(135deg, #1c1917, #292524);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 3px solid #eab308;
    }

    .branded-logo { display: flex; align-items: center; gap: 10px; color: #fff; }
    .branded-logo svg { width: 32px; height: 32px; }
    .branded-logo span { font-weight: 700; font-size: 1.2rem; }
    .branded-title { color: #a8a29e; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; }
    .branded-body { padding: 24px; }
    .branded-section { margin-bottom: 20px; }

    .branded-section-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #78716c;
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e7e5e4;
    }

    .branded-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .branded-table th { text-align: left; padding: 8px 10px; background: #f5f5f4; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; color: #78716c; }
    .branded-table td { padding: 10px; border-bottom: 1px solid #e7e5e4; }
    .branded-table tr:last-child td { border-bottom: none; }

    .branded-footer {
      background: #f5f5f4;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #78716c;
    }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
    .info-item { background: var(--bg-secondary); border-radius: 10px; padding: 12px; }
    .info-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); margin-bottom: 2px; }
    .info-value { font-weight: 600; font-size: 0.9rem; }

    .tradeline { background: var(--bg-secondary); border-radius: 12px; padding: 14px; margin-bottom: 10px; border: 1px solid var(--border-primary); transition: all 0.2s ease; }
    .tradeline:hover { border-color: var(--accent); box-shadow: 0 2px 8px rgba(139,92,246,0.1); }
    .tradeline-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 12px; }
    .tradeline-name { font-weight: 700; font-size: 0.9rem; color: var(--text-primary); }
    .tradeline-type { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }
    .tradeline-status { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
    .tradeline-status.current { background: #dcfce7; color: #16a34a; }
    .tradeline-status.delinquent { background: #fee2e2; color: #dc2626; }
    .tradeline-status.closed { background: #e5e7eb; color: #6b7280; }
    .tradeline-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .tradeline-stat { text-align: center; padding: 8px; background: var(--bg-primary); border-radius: 8px; }
    .tradeline-stat-value { font-weight: 700; font-size: 0.85rem; color: var(--text-primary); }
    .tradeline-stat-label { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; margin-top: 2px; }

    .insight-card { background: var(--bg-secondary); border-radius: 12px; padding: 14px; border-left: 3px solid var(--accent); }
    .insight-card h4 { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--accent); margin-bottom: 4px; font-weight: 700; }
    .insight-card p { font-size: 0.8rem; line-height: 1.5; color: var(--text-secondary); }
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }

    .loading-skeleton {
      background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Field Population Animations */
    @keyframes fieldPopulate {
      0% { 
        background: rgba(34, 197, 94, 0.5) !important; 
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.7), 0 0 25px rgba(34, 197, 94, 0.5); 
        transform: scale(1.02);
      }
      30% { 
        background: rgba(34, 197, 94, 0.35) !important; 
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5), 0 0 15px rgba(34, 197, 94, 0.3); 
        transform: scale(1.01);
      }
      100% { 
        background: transparent !important; 
        box-shadow: none; 
        transform: scale(1);
      }
    }
    
    @keyframes cellPopulate {
      0% { background: rgba(34, 197, 94, 0.4) !important; color: var(--tier-a) !important; }
      50% { background: rgba(34, 197, 94, 0.2) !important; }
      100% { background: transparent !important; color: inherit !important; }
    }
    
    @keyframes valueFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes rowSlideIn {
      0% { opacity: 0; transform: translateX(-20px); background: rgba(234, 179, 8, 0.15); }
      50% { background: rgba(234, 179, 8, 0.1); }
      100% { opacity: 1; transform: translateX(0); background: transparent; }
    }
    
    .field-populated {
      animation: fieldPopulate 1.5s ease-out forwards !important;
    }
    
    .cell-populated {
      animation: cellPopulate 1.5s ease-out forwards !important;
    }
    
    .value-updating {
      animation: valueFlash 0.3s ease-in-out 2 !important;
    }
    
    /* Metric value pulse animation */
    @keyframes metricPulse {
      0% { transform: scale(1.1); color: var(--tier-a); }
      100% { transform: scale(1); }
    }
    
    .metric-updating {
      animation: metricPulse 0.5s ease-out !important;
    }
    
    /* Score ring pulse */
    @keyframes scorePulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .score-ring.updating {
      animation: scorePulse 0.3s ease-out;
    }
    
    .table-row-animate {
      animation: rowSlideIn 0.6s ease-out forwards;
    }
    
    /* Completion success flash */
    @keyframes successFlash {
      0% { opacity: 0; transform: translateY(-20px); }
      15% { opacity: 1; transform: translateY(0); }
      85% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
    
    .completion-flash {
      position: fixed;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--tier-a), #10b981);
      color: white;
      padding: 12px 28px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
      z-index: 1000;
      animation: successFlash 3s ease-in-out forwards;
    }
    .completion-flash svg { width: 20px; height: 20px; }

    .processing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 20px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .processing-indicator .mini-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border-primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Business Intelligence / Background Styles */
    .bg-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(250,204,21,0.08), rgba(234,179,8,0.04));
      border: 1px solid rgba(234,179,8,0.2);
      border-radius: 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .bg-header-title { font-size: 1.3rem; font-weight: 700; }
    .bg-header-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
    .bg-header-actions { display: flex; gap: 12px; align-items: center; }

    .bg-search-input {
      padding: 10px 14px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.9rem;
      background: var(--bg-secondary);
      color: var(--text-primary);
      width: 240px;
    }
    .bg-search-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(234,179,8,0.15); }

    .bg-subtabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border-primary);
      padding-bottom: 16px;
    }

    .bg-subtab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      background: var(--bg-secondary);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.15s;
    }

    .bg-subtab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .bg-subtab.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .bg-subtab.active svg { stroke: #000; }

    .bg-subtab-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .bg-subtab.active .bg-subtab-badge { background: rgba(0,0,0,0.2); }

    .bg-subtab-badge.success { background: rgba(34,197,94,0.2); color: #22c55e; }
    .bg-subtab-badge.warning { background: rgba(245,158,11,0.2); color: #f59e0b; }
    .bg-subtab-badge.error { background: rgba(239,68,68,0.2); color: #ef4444; }
    .bg-subtab-badge.searching { background: rgba(139,92,246,0.2); color: #8b5cf6; animation: pulse 1.5s infinite; }

    .bg-section { display: none; }
    .bg-section.active { display: block; animation: fadeIn 0.3s ease; }

    .bg-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .bg-section-title { font-size: 1.1rem; font-weight: 700; }
    .bg-section-status {
      font-size: 0.75rem;
      padding: 4px 12px;
      border-radius: 20px;
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }

    .bg-section-status.success { background: rgba(34,197,94,0.15); color: #22c55e; }
    .bg-section-status.warning { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .bg-section-status.error { background: rgba(239,68,68,0.15); color: #ef4444; }

    .bg-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .bg-info-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 14px;
    }

    .bg-info-label {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .bg-info-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .bg-info-value.positive { color: var(--tier-a); }
    .bg-info-value.negative { color: var(--tier-e); }

    .bg-agent-info {
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-top: 12px;
    }

    .bg-social-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }

    .bg-social-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.2s;
    }

    .bg-social-card:hover { border-color: var(--accent); }
    .bg-social-card.found { border-color: var(--tier-a); background: linear-gradient(135deg, rgba(34,197,94,0.05), transparent); }

    .bg-social-icon { margin-bottom: 8px; }
    .bg-social-icon svg { width: 28px; height: 28px; stroke: var(--text-muted); }
    .bg-social-card.found .bg-social-icon svg { stroke: var(--tier-a); }

    .bg-social-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; }
    .bg-social-status { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; }
    .bg-social-card.found .bg-social-status { color: var(--tier-a); }
    .bg-social-followers { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }

    .bg-position-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px;
      background: var(--bg-secondary);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid var(--border-primary);
    }

    .bg-position-card.active { border-left-color: var(--tier-e); }
    .bg-position-card.paid { border-left-color: var(--tier-a); opacity: 0.7; }

    .bg-position-info { flex: 1; }
    .bg-position-lender { font-weight: 600; font-size: 0.95rem; }
    .bg-position-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .bg-position-amount { text-align: right; }
    .bg-position-balance { font-weight: 700; font-size: 1rem; }
    .bg-position-payment { font-size: 0.75rem; color: var(--text-muted); }

    .bg-filing-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .bg-filing-type { font-weight: 600; font-size: 0.9rem; }
    .bg-filing-date { font-size: 0.75rem; color: var(--text-muted); }

    /* Profile Summary Styles */
    .profile-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .profile-score-header {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05));
      border: 1px solid rgba(234,179,8,0.3);
      border-radius: 16px;
      margin-bottom: 20px;
    }

    .profile-score-ring { flex-shrink: 0; }

    .profile-score-info { flex: 1; }

    .profile-score-tier {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .profile-score-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .profile-divider {
      color: var(--border-primary);
    }

    .profile-score-actions {
      display: flex;
      gap: 10px;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 0.8rem;
    }

    .profile-completeness {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .profile-completeness-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .profile-completeness-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .profile-completeness-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--tier-a), var(--accent));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .profile-completeness-items {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .completeness-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .completeness-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--bg-tertiary);
    }

    .completeness-item.complete .dot {
      background: var(--tier-a);
    }

    .completeness-item.complete {
      color: var(--text-primary);
    }

    .profile-section {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .profile-section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .profile-section-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(250,204,21,0.15), rgba(234,179,8,0.08));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .profile-section-icon svg {
      width: 18px;
      height: 18px;
      stroke: var(--accent);
    }

    .profile-section-title {
      font-size: 1rem;
      font-weight: 700;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .profile-field {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 12px;
    }

    .profile-field-label {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .profile-field-value {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .profile-field-value.positive { color: var(--tier-a); }
    .profile-field-value.negative { color: var(--tier-e); }

    .profile-kpi-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .profile-kpi {
      flex: 1;
      min-width: 120px;
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .profile-kpi.large {
      flex: 1.5;
      background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05));
      border: 1px solid rgba(234,179,8,0.2);
    }

    .profile-kpi-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .profile-kpi.large .profile-kpi-value {
      font-size: 1.8rem;
      color: var(--accent);
    }

    .profile-kpi-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (max-width: 700px) {
      .profile-score-header {
        flex-direction: column;
        text-align: center;
      }
      .profile-score-actions {
        justify-content: center;
      }
      .profile-kpi-row {
        flex-direction: column;
      }
    }

    /* Ables Engine Styles */
    .engine-tab { background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05)) !important; border: 1px solid rgba(234,179,8,0.3) !important; }
    .engine-tab:hover { background: linear-gradient(135deg, rgba(250,204,21,0.2), rgba(234,179,8,0.1)) !important; }
    
    .engine-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(250,204,21,0.08), rgba(234,179,8,0.04));
      border: 1px solid rgba(234,179,8,0.2);
      border-radius: 16px;
      margin-bottom: 20px;
    }
    
    .engine-logo { display: flex; align-items: center; gap: 14px; }
    
    .engine-inputs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
    }
    
    .engine-input-group { display: flex; flex-direction: column; gap: 4px; }
    .engine-input-group label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
    .engine-input {
      padding: 10px 14px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .engine-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(234,179,8,0.15); }
    
    .engine-score-section {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 800px) { .engine-score-section { grid-template-columns: 1fr; } }
    
    .engine-score-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      box-shadow: var(--shadow-sm);
    }
    
    .engine-score-ring {
      width: 160px;
      height: 160px;
      margin: 0 auto 16px;
      position: relative;
    }
    
    .engine-score-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .engine-score-number {
      font-size: 2.8rem;
      font-weight: 800;
      line-height: 1;
      display: block;
    }
    
    .engine-score-label {
      font-size: 0.6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    
    .engine-tier-badge {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .engine-tier-label { font-size: 0.8rem; color: var(--text-muted); }
    
    .engine-components {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    
    .engine-component-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    
    .engine-component-bar {
      height: 10px;
      background: var(--bg-tertiary);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .engine-component-bar > div {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #facc15);
      border-radius: 5px;
      transition: width 0.6s ease-out;
    }
    
    .risk-metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    
    .risk-metric { text-align: center; }
    .risk-metric-value { font-size: 1.5rem; font-weight: 800; }
    .risk-metric-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
    
    .approval-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 16px;
    }
    
    @media (max-width: 900px) { .approval-options { grid-template-columns: 1fr; } }
    
    .approval-option {
      background: var(--bg-secondary);
      border: 2px solid var(--border-primary);
      border-radius: 14px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .approval-option:hover { border-color: var(--accent); transform: translateY(-2px); }
    .approval-option.recommended { border-color: var(--accent); background: linear-gradient(135deg, rgba(250,204,21,0.08), rgba(234,179,8,0.04)); }
    .approval-option.recommended::before {
      content: ' RECOMMENDED';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #facc15, #eab308);
      color: #1c1917;
      padding: 4px 12px;
      border-radius: 10px;
      font-size: 0.55rem;
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    
    .approval-option-name { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 8px; }
    .approval-option-funding { font-size: 1.8rem; font-weight: 800; color: var(--accent); margin-bottom: 4px; }
    .approval-option-details { display: flex; flex-direction: column; gap: 6px; margin-top: 12px; }
    .approval-option-row { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .approval-option-row span:first-child { color: var(--text-muted); }
    .approval-option-row span:last-child { font-weight: 600; }
    
    .approval-builder {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
      margin-top: 16px;
    }
    
    @media (max-width: 900px) { .approval-builder { grid-template-columns: 1fr; } }
    
    .approval-sliders { display: flex; flex-direction: column; gap: 20px; }
    .slider-group { display: flex; flex-direction: column; gap: 8px; }
    .slider-group label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
    .slider-group input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      appearance: none;
      cursor: pointer;
    }
    .slider-group input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #facc15, #eab308);
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      cursor: grab;
    }
    .slider-value { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
    
    .approval-preview {
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .approval-preview-header {
      background: linear-gradient(135deg, #1c1917, #292524);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #fff;
      font-weight: 700;
      font-size: 0.9rem;
      border-top: 3px solid var(--accent);
    }
    
    .approval-preview-body { padding: 16px 18px; }
    .preview-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border-secondary);
    }
    .preview-row:last-child { border-bottom: none; }
    .preview-row span:first-child { color: var(--text-muted); }
    .preview-row span:last-child { font-weight: 600; }
    .preview-row.main span:last-child { font-size: 1.1rem; font-weight: 800; color: var(--accent); }
    .preview-row.highlight { background: rgba(234,179,8,0.1); margin: 0 -18px; padding: 10px 18px; }
    .preview-row.highlight span:last-child { color: var(--tier-a); font-weight: 700; }
    .preview-row.fee { font-size: 0.75rem; color: var(--text-muted); }
    .preview-row.fee span:last-child { font-weight: 500; }
    
    .approval-preview-footer { padding: 14px 18px; background: var(--bg-secondary); }
    
    .decline-card {
      background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(239,68,68,0.03));
      border: 2px solid var(--tier-e);
      text-align: center;
      padding: 40px;
    }
    
    .decline-icon { font-size: 3rem; margin-bottom: 16px; }
    .decline-title { font-size: 1.4rem; font-weight: 700; color: var(--tier-e); margin-bottom: 8px; }
    .decline-reason { font-size: 0.9rem; color: var(--text-secondary); }

    /* Final Review Tab Styles */
    .review-tab { background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05)) !important; border: 1px solid rgba(234,179,8,0.3) !important; }
    .review-tab:hover { background: linear-gradient(135deg, rgba(250,204,21,0.2), rgba(234,179,8,0.1)) !important; }

    .review-container { max-width: 900px; margin: 0 auto; }

    .review-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(250,204,21,0.08), rgba(234,179,8,0.04));
      border: 1px solid rgba(234,179,8,0.2);
      border-radius: 16px;
      margin-bottom: 20px;
    }

    .review-logo { display: flex; align-items: center; gap: 14px; }

    .review-data-summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    @media (max-width: 700px) { .review-data-summary { grid-template-columns: repeat(2, 1fr); } }

    .review-summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.2s;
    }

    .review-summary-card.ready {
      border-color: rgba(34,197,94,0.4);
      background: linear-gradient(135deg, rgba(34,197,94,0.05), transparent);
    }

    .review-summary-icon { font-size: 1.5rem; margin-bottom: 8px; }
    .review-summary-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); margin-bottom: 4px; }
    .review-summary-status { font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); }
    .review-summary-card.ready .review-summary-status { color: #22c55e; }

    .review-content-area {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .review-placeholder {
      text-align: center;
      padding: 48px;
    }

    .review-output {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      overflow: hidden;
    }

    .review-output-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      background: linear-gradient(135deg, rgba(250,204,21,0.06), transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .review-output-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .review-output-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .review-output-body {
      padding: 24px;
      font-size: 0.95rem;
      line-height: 1.7;
      color: var(--text-primary);
    }

    .review-output-body h2 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 24px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-primary);
    }

    .review-output-body h2:first-child { margin-top: 0; }

    .review-output-body h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent);
      margin: 20px 0 10px 0;
    }

    .review-output-body p { margin: 0 0 12px 0; }
    .review-output-body ul { margin: 8px 0 16px 0; padding-left: 20px; }
    .review-output-body li { margin: 6px 0; }

    .review-output-body .highlight-box {
      background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05));
      border: 1px solid rgba(234,179,8,0.3);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
    }

    .review-output-body .risk-high { color: var(--tier-e); font-weight: 600; }
    .review-output-body .risk-medium { color: var(--tier-c); font-weight: 600; }
    .review-output-body .risk-low { color: var(--tier-a); font-weight: 600; }

    .review-output-body .recommendation {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 16px;
      margin: 16px 0;
      border-left: 4px solid var(--accent);
    }

    .review-output-body .recommendation.approve { border-left-color: #22c55e; }
    .review-output-body .recommendation.decline { border-left-color: var(--tier-e); }
    .review-output-body .recommendation.conditional { border-left-color: var(--tier-c); }

    .review-output-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-primary);
      background: var(--bg-secondary);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .review-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 48px;
    }

    .review-loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .review-loading-text {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    /* RC/TC Compare Tab Styles */
    .compare-tab { background: linear-gradient(135deg, rgba(250,204,21,0.1), rgba(234,179,8,0.05)) !important; border: 1px solid rgba(234,179,8,0.3) !important; }
    .compare-tab:hover { background: linear-gradient(135deg, rgba(250,204,21,0.2), rgba(234,179,8,0.1)) !important; }

    .compare-container { max-width: 1200px; margin: 0 auto; }

    .compare-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      background: linear-gradient(135deg, rgba(250,204,21,0.08), rgba(234,179,8,0.04));
      border: 1px solid rgba(234,179,8,0.2);
      border-radius: 16px;
      margin-bottom: 20px;
    }

    .compare-logo { display: flex; align-items: center; gap: 14px; }
    .compare-header-actions { display: flex; gap: 12px; }

    .compare-inputs {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 24px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .compare-inputs { grid-template-columns: 1fr; }
      .compare-divider { display: none; }
    }

    .compare-column {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      overflow: hidden;
    }

    .compare-column-header {
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-primary);
    }

    .compare-column-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .compare-column-subtitle { font-size: 0.75rem; color: var(--text-muted); }

    .compare-form { padding: 20px; display: flex; flex-direction: column; gap: 12px; }

    .compare-input-row {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      align-items: center;
    }

    .compare-input-row.full-width {
      grid-template-columns: 1fr;
    }

    .compare-input-row.full-width label {
      margin-bottom: 4px;
    }

    .compare-input-row label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .compare-input {
      padding: 10px 14px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .compare-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(234,179,8,0.15); }
    .compare-input[readonly] { background: var(--bg-tertiary); cursor: not-allowed; opacity: 0.8; }
    .compare-input[readonly]:focus { box-shadow: none; border-color: var(--border-primary); }

    textarea.compare-input { resize: vertical; min-height: 60px; }

    .compare-divider {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .compare-vs {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .compare-criteria {
      margin-bottom: 20px;
    }

    .criteria-section-label {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
      margin-top: 20px;
      margin-bottom: 4px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .criteria-section-label:first-of-type { margin-top: 12px; }

    .criteria-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .criteria-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .criteria-item label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .approval-type-toggle {
      display: flex;
      gap: 0;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      overflow: hidden;
    }

    .approval-type-btn {
      flex: 1;
      padding: 10px 20px;
      border: none;
      background: var(--bg-secondary);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      color: var(--text-secondary);
    }

    .approval-type-btn:first-child { border-right: 1px solid var(--border-primary); }

    .approval-type-btn:hover { background: var(--bg-tertiary); }

    .approval-type-btn.active {
      background: var(--accent);
      color: #000;
    }

    .approval-type-btn.active.rc { background: #3b82f6; color: #fff; }
    .approval-type-btn.active.tc { background: #22c55e; color: #fff; }

    .compare-results {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      overflow: hidden;
    }

    .compare-results-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      background: linear-gradient(135deg, rgba(250,204,21,0.06), transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .compare-results-title { font-size: 1.1rem; font-weight: 700; }
    .compare-results-meta { font-size: 0.75rem; color: var(--text-muted); }

    .compare-table-wrapper { overflow-x: auto; }

    .compare-table {
      width: 100%;
      border-collapse: collapse;
    }

    .compare-table th,
    .compare-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-primary);
    }

    .compare-table th {
      background: var(--bg-secondary);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .compare-table td { font-size: 0.9rem; }

    .compare-table .metric-name { font-weight: 600; }

    .compare-table .diff-positive { color: var(--tier-a); font-weight: 600; }
    .compare-table .diff-negative { color: var(--tier-e); font-weight: 600; }
    .compare-table .diff-neutral { color: var(--text-muted); }

    .compare-table .status-pass {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(34,197,94,0.15);
      color: #22c55e;
    }

    .compare-table .status-fail {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(239,68,68,0.15);
      color: #ef4444;
    }

    .compare-table .status-warn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(245,158,11,0.15);
      color: #f59e0b;
    }

    .compare-summary {
      padding: 20px 24px;
      border-top: 1px solid var(--border-primary);
      background: var(--bg-secondary);
    }

    .compare-summary-title { font-weight: 700; margin-bottom: 12px; }

    .compare-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 600px) { .compare-summary-grid { grid-template-columns: 1fr; } }

    .compare-summary-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .compare-summary-card.winner {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(250,204,21,0.08), transparent);
    }

    .compare-summary-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
    .compare-summary-value { font-size: 1.2rem; font-weight: 700; }

    .compare-actions {
      padding: 16px 24px;
      border-top: 1px solid var(--border-primary);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .compare-placeholder {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 48px;
      text-align: center;
    }

    /* Settings Button */
    .settings-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .settings-btn:hover { background: var(--accent); border-color: var(--accent); }
    .settings-btn:hover svg { stroke: #000; }
    .settings-btn svg { width: 18px; height: 18px; stroke: var(--text-muted); }

    /* Settings Modal */
    .settings-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .settings-modal.active { display: flex; }
    .settings-content {
      background: var(--bg-card);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      background: linear-gradient(135deg, rgba(234,179,8,0.08), transparent);
    }
    .settings-header h2 { font-size: 1.2rem; font-weight: 700; }
    .settings-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: var(--bg-secondary);
      font-size: 1.4rem;
      cursor: pointer;
      color: var(--text-muted);
    }
    .settings-close:hover { background: var(--tier-e); color: #fff; }
    .settings-body {
      padding: 20px 24px;
      max-height: 55vh;
      overflow-y: auto;
    }
    .settings-section { margin-bottom: 24px; }
    .settings-section:last-child { margin-bottom: 0; }
    .settings-section h3 {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 12px;
      letter-spacing: 0.04em;
    }
    .setting-row {
      display: grid;
      grid-template-columns: 1fr 1fr 60px;
      gap: 12px;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    .setting-row:last-child { border-bottom: none; }
    .setting-row label { font-size: 0.85rem; font-weight: 500; }
    .setting-row input[type="range"] {
      -webkit-appearance: none;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-tertiary);
    }
    .setting-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #facc15, #ca8a04);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .setting-value {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--accent);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .settings-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid var(--border-primary);
      background: var(--bg-secondary);
    }

    /* Profile Summary Bar */
    .profile-summary {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-primary);
      padding: 12px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
    }
    .profile-info { display: flex; align-items: center; gap: 12px; }
    .profile-avatar {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      background: linear-gradient(135deg, #facc15, #ca8a04);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      color: #000;
    }
    .profile-name { font-weight: 700; font-size: 1rem; }
    .profile-meta { font-size: 0.75rem; color: var(--text-muted); }
    .profile-stats { display: flex; gap: 24px; }
    .profile-stat { text-align: center; }
    .profile-stat-value { display: block; font-size: 1rem; font-weight: 700; color: var(--accent); }
    .profile-stat-label { display: block; font-size: 0.6rem; text-transform: uppercase; color: var(--text-muted); }

    /* Account Tabs for Bank */
    .account-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .account-tab {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-secondary);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .account-tab:hover { border-color: var(--accent); }
    .account-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .account-tab .acct-num { font-family: 'JetBrains Mono', monospace; margin-left: 4px; opacity: 0.7; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 100 100">
          <defs>
            <linearGradient id="planetGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#facc15"/>
              <stop offset="50%" style="stop-color:#eab308"/>
              <stop offset="100%" style="stop-color:#ca8a04"/>
            </linearGradient>
            <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#eab308;stop-opacity:0.2"/>
              <stop offset="50%" style="stop-color:#facc15;stop-opacity:0.8"/>
              <stop offset="100%" style="stop-color:#eab308;stop-opacity:0.2"/>
            </linearGradient>
          </defs>
          <ellipse cx="50" cy="50" rx="42" ry="10" fill="none" stroke="url(#ringGrad)" stroke-width="3" transform="rotate(-20 50 50)"/>
          <circle cx="50" cy="50" r="22" fill="url(#planetGrad)"/>
          <ellipse cx="50" cy="46" rx="12" ry="6" fill="rgba(255,255,255,0.25)"/>
        </svg>
      </div>
      <span class="logo-text">Ables<span class="logo-ai">AI</span></span>
    </div>
    <div class="header-right">
      <input type="password" class="api-input" id="apiKeyInput" placeholder="Gemini API Key..." onchange="saveApiKey()">
      <div class="api-status">
        <div class="status-dot" id="apiStatusDot"></div>
        <span id="apiStatusText">Not set</span>
      </div>
      <button class="btn btn-sm" onclick="shareProfile()" title="Share Profile">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      </button>
      <button class="btn btn-sm" onclick="resetProfile()" title="New Search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </button>
      <button class="settings-btn" onclick="toggleSettings()" title="Engine Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
      <button class="theme-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </header>

  <!-- Profile Summary Bar -->
  <div class="profile-summary" id="profileSummary" style="display:none;">
    <div class="profile-info">
      <div class="profile-avatar" id="profileAvatar">--</div>
      <div class="profile-details">
        <div class="profile-name" id="profileName">Business Name</div>
        <div class="profile-meta" id="profileMeta">Industry  Location</div>
      </div>
    </div>
    <div class="profile-stats">
      <div class="profile-stat">
        <span class="profile-stat-value" id="profileRevenue">--</span>
        <span class="profile-stat-label">Avg Revenue</span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-value" id="profileCredit">--</span>
        <span class="profile-stat-label">Credit Score</span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-value" id="profileTIB">--</span>
        <span class="profile-stat-label">Time in Business</span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-value" id="profileAccounts">--</span>
        <span class="profile-stat-label">Bank Accounts</span>
      </div>
      <div class="profile-stat">
        <span class="profile-stat-value" id="profileDocs">0</span>
        <span class="profile-stat-label">Documents</span>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="tab-nav">
      <!-- Upload Step -->
      <div class="workflow-step" data-step="1">
        <button class="tab-btn active" onclick="switchTab('all')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          </span>
          Upload
          <span id="processingCount" class="processing-indicator" style="display:none"><span class="mini-spinner"></span><span id="procCountText">0</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Application Step -->
      <div class="workflow-step" data-step="2">
        <button class="tab-btn" onclick="switchTab('application')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </span>
          Application
          <span class="step-progress" id="stepProgressApp"><span class="step-progress-spinner"></span><span id="stepProgressAppText">0/0</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Bank Statements Step -->
      <div class="workflow-step" data-step="3">
        <button class="tab-btn" onclick="switchTab('bank')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          </span>
          Bank
          <span class="step-progress" id="stepProgressBank"><span class="step-progress-spinner"></span><span id="stepProgressBankText">0/0</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Credit Report Step -->
      <div class="workflow-step" data-step="4">
        <button class="tab-btn" onclick="switchTab('credit')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
          </span>
          Credit
          <span class="step-progress" id="stepProgressCredit"><span class="step-progress-spinner"></span><span id="stepProgressCreditText">0/0</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Background Step -->
      <div class="workflow-step" data-step="5">
        <button class="tab-btn" onclick="switchTab('background')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          </span>
          Background
          <span class="step-progress" id="stepProgressBg"><span class="step-progress-spinner"></span><span id="stepProgressBgText">0/6</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Profile Summary Step -->
      <div class="workflow-step" data-step="6">
        <button class="tab-btn" onclick="switchTab('other')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </span>
          Profile
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Ables Engine Step -->
      <div class="workflow-step" data-step="7">
        <button class="tab-btn engine-tab" onclick="switchTab('engine')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          </span>
          Engine
          <span class="step-progress" id="stepProgressEngine"><span class="step-progress-spinner"></span><span id="stepProgressEngineText">Running...</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- Final Review Step -->
      <div class="workflow-step" data-step="8">
        <button class="tab-btn review-tab" onclick="switchTab('review')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          </span>
          Review
          <span class="step-progress" id="stepProgressReview"><span class="step-progress-spinner"></span><span id="stepProgressReviewText">Generating...</span></span>
        </button>
        <div class="workflow-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
      </div>

      <!-- RC/TC Compare Step -->
      <div class="workflow-step" data-step="9">
        <button class="tab-btn compare-tab" onclick="switchTab('compare')">
          <span class="step-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="18" rx="1"/><line x1="10" y1="8" x2="14" y2="8"/><line x1="10" y1="12" x2="14" y2="12"/><line x1="10" y1="16" x2="14" y2="16"/></svg>
          </span>
          Compare
          <span class="step-progress" id="stepProgressCompare"><span class="step-progress-spinner"></span><span id="stepProgressCompareText">Analyzing...</span></span>
        </button>
      </div>
    </div>

    <!-- Workflow Progress Banner -->
    <div class="workflow-progress-banner" id="workflowProgressBanner" style="display:none;">
      <div class="workflow-progress-icon">
        <div class="processing-spinner" style="width:20px;height:20px;border-width:3px;"></div>
      </div>
      <div class="workflow-progress-info">
        <div class="workflow-progress-step" id="workflowProgressStep">Processing...</div>
        <div class="workflow-progress-detail" id="workflowProgressDetail">Please wait</div>
      </div>
      <div class="workflow-progress-bar-container">
        <div class="workflow-progress-bar" id="workflowProgressBar" style="width:0%"></div>
      </div>
    </div>

    <!-- Tab: Upload All -->
    <div class="tab-content active" id="contentAll">
      <div class="dropzone main-dropzone" id="mainDropzone" onclick="document.getElementById('mainFileInput').click()">
        <div class="dropzone-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        </div>
        <div class="dropzone-title">Upload Any Documents</div>
        <div class="dropzone-subtitle">AI automatically sorts by document type</div>
        <div class="dropzone-formats">
          <span class="format-badge">PDF</span><span class="format-badge">PNG</span><span class="format-badge">JPG</span>
        </div>
      </div>
      <input type="file" class="file-input" id="mainFileInput" accept=".pdf,image/*" multiple onchange="handleMainUpload(event.target.files)">
      <div id="allThumbnails" class="doc-thumbnails"></div>
    </div>

    <!-- Tab: Application -->
    <div class="tab-content" id="contentApplication">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Application</div>
          <div class="section-header-status" id="appStatus">
            <span class="section-status-dot" id="appStatusDot"></span>
            <span id="appStatusText">No files</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="appRerunBtn" onclick="rerunProcessing('application')" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="dropzone" onclick="document.getElementById('appFileInput').click()">
        <div class="dropzone-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
        <div class="dropzone-title">Upload Application</div>
        <div class="dropzone-subtitle">Business applications, personal guarantees</div>
      </div>
      <input type="file" class="file-input" id="appFileInput" accept=".pdf,image/*" multiple onchange="handleTypedUpload(event.target.files, 'application')">
      <div id="applicationThumbnails" class="doc-thumbnails"></div>
      <div class="results-section" id="applicationResults" style="position:relative;">
        <div class="processing-overlay" id="appProcessingOverlay">
          <div class="processing-spinner"></div>
          <div class="processing-text" id="appProcessingText">Processing application...</div>
          <div class="processing-progress"><div class="processing-progress-bar" id="appProgressBar" style="width:0%"></div></div>
        </div>
        
        <!-- Editable Application Form -->
        <div class="app-form">
          <div class="app-form-section">
            <div class="app-form-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18"/><path d="M9 8h10"/><path d="M9 12h10"/><path d="M9 16h10"/><path d="M5 8h.01"/><path d="M5 12h.01"/><path d="M5 16h.01"/></svg>
              Business Information
            </div>
            <div class="app-form-grid">
              <div class="app-form-field full-width">
                <label>Legal Business Name</label>
                <input type="text" id="appBusinessName" data-field="businessName" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field full-width">
                <label>DBA (Doing Business As)</label>
                <input type="text" id="appDba" data-field="dba" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Entity Type</label>
                <select id="appEntityType" data-field="entityType" onchange="updateAppField(this)">
                  <option value="">Select...</option>
                  <option value="LLC">LLC</option>
                  <option value="Corporation">Corporation</option>
                  <option value="S-Corp">S-Corp</option>
                  <option value="Sole Proprietor">Sole Proprietor</option>
                  <option value="Partnership">Partnership</option>
                </select>
              </div>
              <div class="app-form-field">
                <label>State of Incorporation</label>
                <input type="text" id="appState" data-field="state" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>EIN / Tax ID</label>
                <input type="text" id="appEin" data-field="ein" placeholder="XX-XXXXXXX" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Date Established</label>
                <input type="text" id="appDateEstablished" data-field="dateEstablished" placeholder="MM/YYYY" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Industry / Business Type</label>
                <input type="text" id="appIndustry" data-field="industry" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>NAICS / SIC Code</label>
                <input type="text" id="appNaics" data-field="naicsCode" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field full-width">
                <label>Business Address</label>
                <input type="text" id="appAddress" data-field="address" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>City</label>
                <input type="text" id="appCity" data-field="city" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>State</label>
                <input type="text" id="appAddressState" data-field="addressState" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>ZIP Code</label>
                <input type="text" id="appZip" data-field="zip" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Business Phone</label>
                <input type="text" id="appPhone" data-field="phone" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Website</label>
                <input type="text" id="appWebsite" data-field="website" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Email</label>
                <input type="email" id="appEmail" data-field="email" onchange="updateAppField(this)">
              </div>
            </div>
          </div>

          <div class="app-form-section">
            <div class="app-form-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              Owner / Guarantor
            </div>
            <div class="app-form-grid">
              <div class="app-form-field">
                <label>Owner Name</label>
                <input type="text" id="appOwnerName" data-field="ownerName" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Title / Position</label>
                <input type="text" id="appOwnerTitle" data-field="ownerTitle" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Ownership %</label>
                <input type="text" id="appOwnership" data-field="ownershipPct" placeholder="%" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Date of Birth</label>
                <input type="text" id="appDob" data-field="dob" placeholder="MM/DD/YYYY" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>SSN (Last 4)</label>
                <input type="text" id="appSsn" data-field="ssn" placeholder="XXX-XX-XXXX" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Driver's License</label>
                <input type="text" id="appDriversLicense" data-field="driversLicense" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field full-width">
                <label>Home Address</label>
                <input type="text" id="appHomeAddress" data-field="homeAddress" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>City</label>
                <input type="text" id="appHomeCity" data-field="homeCity" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>State</label>
                <input type="text" id="appHomeState" data-field="homeState" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>ZIP</label>
                <input type="text" id="appHomeZip" data-field="homeZip" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Mobile Phone</label>
                <input type="text" id="appMobile" data-field="mobile" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Personal Email</label>
                <input type="email" id="appOwnerEmail" data-field="ownerEmail" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Credit Score (Est.)</label>
                <input type="text" id="appCreditScore" data-field="creditScore" onchange="updateAppField(this)">
              </div>
            </div>
          </div>

          <div class="app-form-row">
            <div class="app-form-section half">
              <div class="app-form-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                Funding Request
              </div>
              <div class="app-form-grid single">
                <div class="app-form-field">
                  <label>Amount Requested</label>
                  <input type="text" id="appAmountRequested" data-field="amountRequested" placeholder="$" onchange="updateAppField(this)">
                </div>
                <div class="app-form-field">
                  <label>Use of Funds</label>
                  <input type="text" id="appUseOfFunds" data-field="useOfFunds" onchange="updateAppField(this)">
                </div>
                <div class="app-form-field">
                  <label>Monthly Revenue</label>
                  <input type="text" id="appMonthlyRevenue" data-field="monthlyRevenue" placeholder="$" onchange="updateAppField(this)">
                </div>
                <div class="app-form-field">
                  <label>Annual Revenue</label>
                  <input type="text" id="appAnnualRevenue" data-field="annualRevenue" placeholder="$" onchange="updateAppField(this)">
                </div>
              </div>
            </div>
            
            <div class="app-form-section half">
              <div class="app-form-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                Bank Account
              </div>
              <div class="app-form-grid single">
                <div class="app-form-field">
                  <label>Bank Name</label>
                  <input type="text" id="appBankName" data-field="bankName" onchange="updateAppField(this)">
                </div>
                <div class="app-form-field">
                  <label>Account Number</label>
                  <input type="text" id="appAccountNumber" data-field="accountNumber" onchange="updateAppField(this)">
                </div>
                <div class="app-form-field">
                  <label>Routing Number</label>
                  <input type="text" id="appRoutingNumber" data-field="routingNumber" onchange="updateAppField(this)">
                </div>
                <div class="app-form-field">
                  <label>Average Balance</label>
                  <input type="text" id="appAvgBalance" data-field="avgBalance" placeholder="$" onchange="updateAppField(this)">
                </div>
              </div>
            </div>
          </div>

          <div class="app-form-section">
            <div class="app-form-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
              Additional Information
            </div>
            <div class="app-form-grid">
              <div class="app-form-field">
                <label>Existing MCA/Loans</label>
                <select id="appExistingDebt" data-field="existingDebt" onchange="updateAppField(this)">
                  <option value="">Select...</option>
                  <option value="None">None</option>
                  <option value="1 Position">1 Position</option>
                  <option value="2 Positions">2 Positions</option>
                  <option value="3+ Positions">3+ Positions</option>
                </select>
              </div>
              <div class="app-form-field">
                <label>Current Balance Owed</label>
                <input type="text" id="appBalanceOwed" data-field="balanceOwed" placeholder="$" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Bankruptcy History</label>
                <select id="appBankruptcy" data-field="bankruptcy" onchange="updateAppField(this)">
                  <option value="">Select...</option>
                  <option value="None">None</option>
                  <option value="Discharged">Discharged</option>
                  <option value="Open/Active">Open/Active</option>
                </select>
              </div>
              <div class="app-form-field">
                <label>Landlord / Property</label>
                <input type="text" id="appLandlord" data-field="landlord" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Monthly Rent</label>
                <input type="text" id="appMonthlyRent" data-field="monthlyRent" placeholder="$" onchange="updateAppField(this)">
              </div>
              <div class="app-form-field">
                <label>Number of Employees</label>
                <input type="text" id="appEmployees" data-field="employees" onchange="updateAppField(this)">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Bank Statements -->
    <div class="tab-content" id="contentBank">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Bank Statements</div>
          <div class="section-header-status" id="bankStatus">
            <span class="section-status-dot" id="bankStatusDot"></span>
            <span id="bankStatusText">No files</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="bankRerunBtn" onclick="rerunProcessing('bank')" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="dropzone" onclick="document.getElementById('bankFileInput').click()">
        <div class="dropzone-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
        <div class="dropzone-title">Upload Bank Statements</div>
        <div class="dropzone-subtitle">3-6 months of statements</div>
      </div>
      <input type="file" class="file-input" id="bankFileInput" accept=".pdf,image/*" multiple onchange="handleTypedUpload(event.target.files, 'bank')">
      <div id="bankThumbnails" class="doc-thumbnails"></div>

      <div class="results-section active" id="bankResults" style="position:relative;">
        <div class="processing-overlay" id="bankProcessingOverlay">
          <div class="processing-spinner"></div>
          <div class="processing-text" id="bankProcessingText">Processing statements...</div>
          <div class="processing-progress"><div class="processing-progress-bar" id="bankProgressBar" style="width:0%"></div></div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="score-display" style="flex:1;margin:0;">
              <div class="score-ring" id="bankScoreRing" style="--pct:0;--score-color:#8b5cf6">
                <div class="score-ring-inner">
                  <span class="score-number" id="bankScore">--</span>
                  <span class="score-label-small">Score</span>
                </div>
              </div>
              <div class="score-info">
                <h3 id="bankTier">Financial Health</h3>
                <p id="bankSummary">Upload statements to analyze</p>
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn" onclick="rerunProcessing('bank')" id="bankReScrubBtn" style="border-color:var(--accent);color:var(--accent);" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                Re-Scrub
              </button>
              <button class="btn btn-primary" onclick="generateBrandedStatement()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                Generate Statement
              </button>
            </div>
          </div>
        </div>

        <div class="kpi-grid" id="bankKpis">
          <div class="kpi-card" onclick="showAllTransactions('deposit')" style="cursor:pointer;" title="Click to view all deposits"><div class="kpi-value positive" id="kpiRevenue">$0</div><div class="kpi-label">Avg True Deposits </div></div>
          <div class="kpi-card"><div class="kpi-value" id="kpiExcluded" style="font-size:1.1rem;color:var(--text-muted);">$0</div><div class="kpi-label">Avg Excluded</div></div>
          <div class="kpi-card" onclick="showAllTransactions('debit')" style="cursor:pointer;" title="Click to view all debits"><div class="kpi-value negative" id="kpiWithdrawals">$0</div><div class="kpi-label">Avg True Debits </div></div>
          <div class="kpi-card"><div class="kpi-value" id="kpiAvgDaily">$0</div><div class="kpi-label">Avg Daily Bal</div></div>
          <div class="kpi-card"><div class="kpi-value" id="kpiBalance">$0</div><div class="kpi-label">Avg End Bal</div></div>
          <div class="kpi-card" onclick="showAllTransactions('deposit')" style="cursor:pointer;" title="Click to view all deposits"><div class="kpi-value" id="kpiDepCount">0</div><div class="kpi-label">Avg Deposits/Mo </div></div>
          <div class="kpi-card"><div class="kpi-value warning" id="kpiDebt">$0</div><div class="kpi-label">Monthly Debt</div></div>
          <div class="kpi-card"><div class="kpi-value" id="kpiNsf">0</div><div class="kpi-label">Total NSFs</div></div>
        </div>

        <div class="card">
          <div class="card-header" style="margin-bottom:0;">
            <div class="card-title">Monthly Financials</div>
            <button class="btn" onclick="showAllTransactions('all')">View All Transactions</button>
          </div>
          
          <!-- Account Tabs -->
          <div class="account-tabs" id="accountTabs" style="margin-top:12px;display:none;">
            <button class="account-tab active" onclick="switchAccountView('combined')">Combined</button>
          </div>
          
          <!-- Combined Table -->
          <div id="combinedTableSection">
            <div class="table-wrapper" style="margin-top:12px;">
              <table class="data-table">
                <thead>
                  <tr><th>Month</th><th>Total Deposits</th><th>Excluded</th><th>True Credits</th><th>Total Debits</th><th>True Debits</th><th>End Bal</th><th>Avg Daily</th><th>Dep #</th><th>NSF</th></tr>
                </thead>
                <tbody id="bankTableBody">
                  <tr><td colspan="10" class="empty-state">Upload statements</td></tr>
                </tbody>
                <tfoot id="bankTableFoot" style="display:none;">
                  <tr class="totals-row" id="bankTotalsRow"></tr>
                </tfoot>
              </table>
            </div>
          </div>
          
          <!-- Per-Account Tables -->
          <div id="accountTablesContainer" style="display:none;margin-top:12px;"></div>
        </div>

        <div class="two-col">
          <div class="card"><div class="card-title">Cash Flow</div><div class="chart-container"><canvas id="bankCashFlowChart"></canvas></div></div>
          <div class="card"><div class="card-title">Revenue Trend</div><div class="chart-container"><canvas id="bankRevenueChart"></canvas></div></div>
        </div>

        <div class="card">
          <div class="card-header" style="margin-bottom:12px;">
            <div class="card-title">Large Transactions (>$7,500 or 10%)</div>
            <div style="font-size:0.75rem;color:var(--text-muted);" id="largeTxnCount">0 flagged</div>
          </div>
          <div id="largeTxnContainer"><div class="empty-state">No large transactions</div></div>
        </div>
        
        <div class="card" id="excludedTxnCard">
          <div class="card-header" style="margin-bottom:12px;">
            <div class="card-title" style="color:var(--text-muted);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;display:inline;vertical-align:middle;margin-right:6px;"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
              Excluded from Revenue
            </div>
            <div style="font-size:0.75rem;color:var(--text-muted);" id="excludedTxnCount">0 items</div>
          </div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:12px;">
            These deposits were excluded from True Revenue calculations (lender funding, transfers, returns, refunds)
          </div>
          <div id="excludedTxnContainer"><div class="empty-state">No excluded transactions</div></div>
        </div>

        <div class="card">
          <div class="card-title">Detected Debt Obligations</div>
          <div class="table-wrapper" style="margin-top:12px;">
            <table class="data-table" id="debtTable">
              <thead>
                <tr><th>Lender</th><th>Type</th><th>Est. Balance</th><th>Monthly Payment</th></tr>
              </thead>
              <tbody id="debtTableBody">
                <tr><td colspan="4" class="empty-state">No debts detected</td></tr>
              </tbody>
              <tfoot id="debtTableFoot" style="display:none;">
                <tr class="totals-row"><td colspan="2"><strong>TOTALS</strong></td><td id="debtTotalBalance"><strong>$0</strong></td><td id="debtTotalMonthly"><strong>$0</strong></td></tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Transaction Detail Panel -->
        <div class="card" id="transactionDetailCard" style="display:none;">
          <div class="card-header" style="margin-bottom:0;">
            <div class="card-title">Transaction Details - <span id="txnDetailMonth">Month</span></div>
            <div style="display:flex;gap:8px;">
              <button class="btn" onclick="filterTxnType('all')" id="txnFilterAll">All</button>
              <button class="btn" onclick="filterTxnType('deposit')" id="txnFilterDeposit">Deposits</button>
              <button class="btn" onclick="filterTxnType('debit')" id="txnFilterDebit">Debits</button>
            </div>
          </div>
          <div class="txn-summary" id="txnSummary" style="margin:16px 0;display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
            <div class="txn-summary-item"><span class="txn-summary-value positive" id="txnTotalDeposits">$0</span><span class="txn-summary-label">Total Deposits</span></div>
            <div class="txn-summary-item"><span class="txn-summary-value negative" id="txnTotalDebits">$0</span><span class="txn-summary-label">Total Debits</span></div>
            <div class="txn-summary-item"><span class="txn-summary-value" id="txnDepositCount">0</span><span class="txn-summary-label">Deposit Count</span></div>
            <div class="txn-summary-item"><span class="txn-summary-value" id="txnDebitCount">0</span><span class="txn-summary-label">Debit Count</span></div>
          </div>
          <div class="table-wrapper" style="max-height:400px;overflow-y:auto;">
            <table class="data-table txn-table">
              <thead style="position:sticky;top:0;background:var(--bg-card);z-index:1;">
                <tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th><th>Balance</th></tr>
              </thead>
              <tbody id="txnDetailBody"></tbody>
            </table>
          </div>
        </div>

        <div id="brandedStatementContainer"></div>
      </div>
    </div>

    <!-- Tab: Credit Report -->
    <div class="tab-content" id="contentCredit">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Credit Report</div>
          <div class="section-header-status" id="creditStatus">
            <span class="section-status-dot" id="creditStatusDot"></span>
            <span id="creditStatusText">No files</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="creditRerunBtn" onclick="rerunProcessing('credit')" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="dropzone" onclick="document.getElementById('creditFileInput').click()">
        <div class="dropzone-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg></div>
        <div class="dropzone-title">Upload Credit Report</div>
        <div class="dropzone-subtitle">Personal or business credit</div>
      </div>
      <input type="file" class="file-input" id="creditFileInput" accept=".pdf,image/*" multiple onchange="handleTypedUpload(event.target.files, 'credit')">
      <div id="creditThumbnails" class="doc-thumbnails"></div>
      <div class="results-section" id="creditResults" style="position:relative;">
        <div class="processing-overlay" id="creditProcessingOverlay">
          <div class="processing-spinner"></div>
          <div class="processing-text" id="creditProcessingText">Processing credit report...</div>
          <div class="processing-progress"><div class="processing-progress-bar" id="creditProgressBar" style="width:0%"></div></div>
        </div>
        
        <!-- Credit Score Hero Card -->
        <div class="card" style="background: linear-gradient(135deg, rgba(139,92,246,0.1) 0%, rgba(99,102,241,0.05) 100%);">
          <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap;">
            <div class="score-ring" id="creditScoreRing" style="--pct:0;--score-color:#8b5cf6;width:100px;height:100px;">
              <div class="score-ring-inner" style="width:80px;height:80px;">
                <span class="score-number" id="creditScoreValue" style="font-size:1.8rem;">---</span>
                <span class="score-label-small">FICO</span>
              </div>
            </div>
            <div style="flex:1;min-width:200px;">
              <h3 id="creditTier" style="margin:0 0 4px 0;font-size:1.4rem;">Credit Score</h3>
              <p id="creditSummary" style="margin:0;color:var(--text-muted);font-size:0.9rem;">Upload to analyze</p>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;min-width:280px;">
              <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                <div style="font-size:1.5rem;font-weight:700;color:var(--accent);" id="creditTotalAccounts">0</div>
                <div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;">Accounts</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                <div style="font-size:1.5rem;font-weight:700;color:#22c55e;" id="creditOpenAccounts">0</div>
                <div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;">Open</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:10px;">
                <div style="font-size:1.5rem;font-weight:700;color:#ef4444;" id="creditDerogatory">0</div>
                <div style="font-size:0.65rem;color:var(--text-muted);text-transform:uppercase;">Derogatory</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Credit Metrics Grid -->
        <div class="kpi-grid" style="grid-template-columns:repeat(5,1fr);">
          <div class="kpi-card">
            <div class="kpi-value negative" id="creditTotalDebt">$0</div>
            <div class="kpi-label">Total Debt</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="creditUtilization">0%</div>
            <div class="kpi-label">Utilization</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="creditInquiries">0</div>
            <div class="kpi-label">Inquiries</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="creditOldestAccount">--</div>
            <div class="kpi-label">Oldest Acct</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="creditAvgAge">--</div>
            <div class="kpi-label">Avg Age</div>
          </div>
        </div>
        
        <!-- Trade Lines Section -->
        <div class="card">
          <div class="card-header" style="margin-bottom:12px;">
            <div class="card-title">Trade Lines</div>
            <div style="font-size:0.75rem;color:var(--text-muted);" id="tradelineCount">0 accounts</div>
          </div>
          <div id="tradelinesContainer">
            <div class="empty-state">Upload credit report</div>
          </div>
        </div>
        
        <!-- Credit Analysis Section -->
        <div class="card">
          <div class="card-title" style="margin-bottom:16px;">Credit Analysis</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;">
            <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" style="width:18px;height:18px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <h4 style="margin:0;font-size:0.85rem;">Payment History</h4>
              </div>
              <p id="creditInsightPayment" style="margin:0;font-size:0.8rem;color:var(--text-secondary);line-height:1.4;">--</p>
            </div>
            <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" style="width:18px;height:18px;"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                <h4 style="margin:0;font-size:0.85rem;">Credit Mix</h4>
              </div>
              <p id="creditInsightMix" style="margin:0;font-size:0.8rem;color:var(--text-secondary);line-height:1.4;">--</p>
            </div>
            <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="width:18px;height:18px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <h4 style="margin:0;font-size:0.85rem;">Risk Factors</h4>
              </div>
              <p id="creditInsightRisk" style="margin:0;font-size:0.8rem;color:var(--text-secondary);line-height:1.4;">--</p>
            </div>
          </div>
        </div>
        
        <!-- Public Records / Collections -->
        <div class="card" id="creditPublicRecordsCard" style="display:none;">
          <div class="card-title" style="margin-bottom:12px;color:#ef4444;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;display:inline;vertical-align:middle;margin-right:6px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            Public Records & Collections
          </div>
          <div id="creditPublicRecordsContainer"></div>
        </div>
      </div>
    </div>

    <!-- Tab: Background / Business Intelligence -->
    <div class="tab-content" id="contentBackground">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Business Intelligence</div>
          <div class="section-header-status" id="bgStatus">
            <span class="section-status-dot" id="bgStatusDot"></span>
            <span id="bgStatusText">No data</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="bgRerunBtn" onclick="rerunProcessing('background')" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="bg-header">
        <div class="bg-header-info">
          <div class="bg-header-title">Business Intelligence Report</div>
          <div class="bg-header-subtitle" id="bgBusinessName">Upload documents or run search</div>
        </div>
        <div class="bg-header-actions">
          <input type="text" id="bgSearchInput" class="bg-search-input" placeholder="Business name or EIN...">
          <button class="btn btn-primary" id="bgSearchBtn" onclick="runBusinessSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Run Search
          </button>
          <button class="btn" id="bgDeepResearchBtn" onclick="runDeepResearch(document.getElementById('bgSearchInput').value || null)" style="border-color: var(--accent); color: var(--accent);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/><path d="M10 7v3m0 0v3m0-3h3m-3 0H7"/></svg>
            Deep Research
          </button>
        </div>
      </div>

      <div class="dropzone" onclick="document.getElementById('bgFileInput').click()" style="margin-bottom:16px;">
        <div class="dropzone-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
        <div class="dropzone-title">Upload Background Documents</div>
        <div class="dropzone-subtitle">SOS filings, background checks, reviews</div>
      </div>
      <input type="file" class="file-input" id="bgFileInput" accept=".pdf,image/*" multiple onchange="handleTypedUpload(event.target.files, 'background')">
      <div id="backgroundThumbnails" class="doc-thumbnails"></div>

      <div class="processing-overlay" id="bgProcessingOverlay">
        <div class="processing-spinner"></div>
        <div class="processing-text" id="bgProcessingText">Processing background...</div>
        <div class="processing-progress"><div class="processing-progress-bar" id="bgProgressBar" style="width:0%"></div></div>
      </div>

      <!-- Sub-tabs for different sections -->
      <div class="bg-subtabs" id="bgSubtabs" style="position:relative;">
        <button class="bg-subtab active" onclick="switchBgTab('research')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          Research
          <span class="bg-subtab-badge" id="bgResearchBadge">--</span>
        </button>
        <button class="bg-subtab" onclick="switchBgTab('background')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Background
          <span class="bg-subtab-badge" id="bgBackgroundBadge">--</span>
        </button>
        <button class="bg-subtab" onclick="switchBgTab('reviews')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Reviews
          <span class="bg-subtab-badge" id="bgReviewsBadge">--</span>
        </button>
        <button class="bg-subtab" onclick="switchBgTab('social')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
          Social
          <span class="bg-subtab-badge" id="bgSocialBadge">--</span>
        </button>
        <button class="bg-subtab" onclick="switchBgTab('footprint')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Footprint
          <span class="bg-subtab-badge" id="bgFootprintBadge">--</span>
        </button>
        <button class="bg-subtab" onclick="switchBgTab('debt')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Debt
          <span class="bg-subtab-badge" id="bgDebtBadge">--</span>
        </button>
      </div>

      <!-- Research Section -->
      <div class="bg-section active" id="bgSectionResearch">
        <div class="bg-section-header">
          <div class="bg-section-title">Business Research</div>
          <div class="bg-section-status" id="bgResearchStatus">Not searched</div>
        </div>
        <div class="bg-cards-grid">
          <div class="bg-info-card">
            <div class="bg-info-label">Legal Name</div>
            <div class="bg-info-value" id="bgLegalName">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">DBA / Trade Name</div>
            <div class="bg-info-value" id="bgDBA">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">Entity Type</div>
            <div class="bg-info-value" id="bgEntityType">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">State of Formation</div>
            <div class="bg-info-value" id="bgStateFormation">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">Date Formed</div>
            <div class="bg-info-value" id="bgDateFormed">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">Status</div>
            <div class="bg-info-value" id="bgEntityStatus">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">SOS File Number</div>
            <div class="bg-info-value" id="bgSOSNumber">--</div>
          </div>
          <div class="bg-info-card">
            <div class="bg-info-label">EIN</div>
            <div class="bg-info-value" id="bgEIN">--</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">Registered Agent</div>
          <div class="bg-agent-info" id="bgAgentInfo">
            <div class="empty-state">No agent information</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">Officers / Members</div>
          <div id="bgOfficers">
            <div class="empty-state">No officer information</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">Filing History</div>
          <div id="bgFilings">
            <div class="empty-state">No filings found</div>
          </div>
        </div>
      </div>

      <!-- Background Section -->
      <div class="bg-section" id="bgSectionBackground">
        <div class="bg-section-header">
          <div class="bg-section-title">Background Check</div>
          <div class="bg-section-status" id="bgBackgroundStatus">Not checked</div>
        </div>
        <div class="kpi-grid" style="margin-bottom:16px;">
          <div class="kpi-card"><div class="kpi-value positive" id="bgCriminal">Clear</div><div class="kpi-label">Criminal</div></div>
          <div class="kpi-card"><div class="kpi-value positive" id="bgCivil">Clear</div><div class="kpi-label">Civil</div></div>
          <div class="kpi-card"><div class="kpi-value positive" id="bgBankruptcy">None</div><div class="kpi-label">Bankruptcy</div></div>
          <div class="kpi-card"><div class="kpi-value positive" id="bgLiens">None</div><div class="kpi-label">Liens/Judgments</div></div>
          <div class="kpi-card"><div class="kpi-value positive" id="bgUCC">None</div><div class="kpi-label">UCC Filings</div></div>
          <div class="kpi-card"><div class="kpi-value positive" id="bgTaxLiens">None</div><div class="kpi-label">Tax Liens</div></div>
        </div>
        <div class="card">
          <div class="card-title">Findings & Records</div>
          <div id="bgFindings">
            <div class="empty-state">No findings</div>
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="bg-section" id="bgSectionReviews">
        <div class="bg-section-header">
          <div class="bg-section-title">Online Reviews</div>
          <div class="bg-section-status" id="bgReviewsStatus">Not searched</div>
        </div>
        <div class="kpi-grid" style="margin-bottom:16px;">
          <div class="kpi-card"><div class="kpi-value" id="bgAvgRating">--</div><div class="kpi-label">Avg Rating</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgTotalReviews">--</div><div class="kpi-label">Total Reviews</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgGoogleRating">--</div><div class="kpi-label">Google</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgYelpRating">--</div><div class="kpi-label">Yelp</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgBBBRating">--</div><div class="kpi-label">BBB</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgTrustpilot">--</div><div class="kpi-label">Trustpilot</div></div>
        </div>
        <div class="card">
          <div class="card-title">Review Highlights</div>
          <div id="bgReviewHighlights">
            <div class="empty-state">No reviews found</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">Complaints</div>
          <div id="bgComplaints">
            <div class="empty-state">No complaints found</div>
          </div>
        </div>
      </div>

      <!-- Social Section -->
      <div class="bg-section" id="bgSectionSocial">
        <div class="bg-section-header">
          <div class="bg-section-title">Social Media Presence</div>
          <div class="bg-section-status" id="bgSocialStatus">Not searched</div>
        </div>
        <div class="bg-social-grid">
          <div class="bg-social-card" id="bgFacebook">
            <div class="bg-social-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg></div>
            <div class="bg-social-name">Facebook</div>
            <div class="bg-social-status">Not found</div>
            <div class="bg-social-followers">--</div>
          </div>
          <div class="bg-social-card" id="bgInstagram">
            <div class="bg-social-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg></div>
            <div class="bg-social-name">Instagram</div>
            <div class="bg-social-status">Not found</div>
            <div class="bg-social-followers">--</div>
          </div>
          <div class="bg-social-card" id="bgLinkedin">
            <div class="bg-social-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></div>
            <div class="bg-social-name">LinkedIn</div>
            <div class="bg-social-status">Not found</div>
            <div class="bg-social-followers">--</div>
          </div>
          <div class="bg-social-card" id="bgTwitter">
            <div class="bg-social-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/></svg></div>
            <div class="bg-social-name">Twitter/X</div>
            <div class="bg-social-status">Not found</div>
            <div class="bg-social-followers">--</div>
          </div>
          <div class="bg-social-card" id="bgYoutube">
            <div class="bg-social-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/></svg></div>
            <div class="bg-social-name">YouTube</div>
            <div class="bg-social-status">Not found</div>
            <div class="bg-social-followers">--</div>
          </div>
          <div class="bg-social-card" id="bgTiktok">
            <div class="bg-social-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12a4 4 0 1 0 4 4V4a5 5 0 0 0 5 5"/></svg></div>
            <div class="bg-social-name">TikTok</div>
            <div class="bg-social-status">Not found</div>
            <div class="bg-social-followers">--</div>
          </div>
        </div>
      </div>

      <!-- Footprint Section -->
      <div class="bg-section" id="bgSectionFootprint">
        <div class="bg-section-header">
          <div class="bg-section-title">Digital Footprint</div>
          <div class="bg-section-status" id="bgFootprintStatus">Not searched</div>
        </div>
        <div class="kpi-grid" style="margin-bottom:16px;">
          <div class="kpi-card"><div class="kpi-value" id="bgWebsite">--</div><div class="kpi-label">Website</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgDomainAge">--</div><div class="kpi-label">Domain Age</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgSSLStatus">--</div><div class="kpi-label">SSL Status</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgWebTraffic">--</div><div class="kpi-label">Est. Traffic</div></div>
        </div>
        <div class="card">
          <div class="card-title">Online Presence</div>
          <div id="bgOnlinePresence">
            <div class="empty-state">No presence data</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">Business Directories</div>
          <div id="bgDirectories">
            <div class="empty-state">No directory listings found</div>
          </div>
        </div>
      </div>

      <!-- Debt Section -->
      <div class="bg-section" id="bgSectionDebt">
        <div class="bg-section-header">
          <div class="bg-section-title">Existing Debt / Positions</div>
          <div class="bg-section-status" id="bgDebtStatus">Not searched</div>
        </div>
        <div class="kpi-grid" style="margin-bottom:16px;">
          <div class="kpi-card"><div class="kpi-value" id="bgTotalPositions">0</div><div class="kpi-label">Total Positions</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgEstDebt">$0</div><div class="kpi-label">Est. Total Debt</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgMonthlyPmts">$0</div><div class="kpi-label">Monthly Payments</div></div>
          <div class="kpi-card"><div class="kpi-value" id="bgStackPosition">--</div><div class="kpi-label">Stack Position</div></div>
        </div>
        <div class="card">
          <div class="card-title">MCA / Loan Positions</div>
          <div id="bgDebtPositions">
            <div class="empty-state">No positions found</div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-title">UCC Filings</div>
          <div id="bgUCCFilings">
            <div class="empty-state">No UCC filings found</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Profile Summary -->
    <div class="tab-content" id="contentOther">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Profile Summary</div>
          <div class="section-header-status" id="profileStatus">
            <span class="section-status-dot" id="profileStatusDot"></span>
            <span id="profileStatusText">No data</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="profileRerunBtn" onclick="updateProfileTab()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Refresh
          </button>
        </div>
      </div>
      <div class="profile-container">
        <!-- Ables Score Header -->
        <div class="profile-score-header" id="profileScoreHeader">
          <div class="profile-score-ring">
            <div class="score-ring" id="profileScoreRing" style="--pct:0;--score-color:#8b5cf6">
              <div class="score-ring-inner">
                <span class="score-number" id="profileScoreNum">--</span>
                <span class="score-label-small">ABLESCORE</span>
              </div>
            </div>
          </div>
          <div class="profile-score-info">
            <div class="profile-score-tier" id="profileTier">Run Engine to Calculate</div>
            <div class="profile-score-meta">
              <span id="profileFunding">--</span>
              <span class="profile-divider">|</span>
              <span id="profileFactor">--</span>
              <span class="profile-divider">|</span>
              <span id="profileTerm">--</span>
            </div>
            <div class="profile-score-actions">
              <button class="btn btn-primary btn-sm" onclick="switchTab('engine')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Open Engine
              </button>
              <button class="btn btn-secondary btn-sm" onclick="generateProfilePDF()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Data Completeness -->
        <div class="profile-completeness">
          <div class="profile-completeness-title">Data Completeness</div>
          <div class="profile-completeness-bar">
            <div class="profile-completeness-fill" id="profileCompleteness" style="width:0%"></div>
          </div>
          <div class="profile-completeness-items">
            <span class="completeness-item" id="compApp"><span class="dot"></span> Application</span>
            <span class="completeness-item" id="compBank"><span class="dot"></span> Bank</span>
            <span class="completeness-item" id="compCredit"><span class="dot"></span> Credit</span>
            <span class="completeness-item" id="compBg"><span class="dot"></span> Background</span>
          </div>
        </div>

        <!-- Business Overview Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <div class="profile-section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
            <div class="profile-section-title">Business Overview</div>
          </div>
          <div class="profile-grid" id="profileBusiness">
            <div class="profile-field"><div class="profile-field-label">Legal Name</div><div class="profile-field-value" id="profBizName">--</div></div>
            <div class="profile-field"><div class="profile-field-label">DBA</div><div class="profile-field-value" id="profBizDBA">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Industry</div><div class="profile-field-value" id="profBizIndustry">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Entity Type</div><div class="profile-field-value" id="profBizEntity">--</div></div>
            <div class="profile-field"><div class="profile-field-label">State</div><div class="profile-field-value" id="profBizState">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Time in Business</div><div class="profile-field-value" id="profBizTIB">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Address</div><div class="profile-field-value" id="profBizAddress">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Phone</div><div class="profile-field-value" id="profBizPhone">--</div></div>
          </div>
        </div>

        <!-- Owner Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <div class="profile-section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="profile-section-title">Owner / Guarantor</div>
          </div>
          <div class="profile-grid" id="profileOwner">
            <div class="profile-field"><div class="profile-field-label">Name</div><div class="profile-field-value" id="profOwnerName">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Title</div><div class="profile-field-value" id="profOwnerTitle">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Ownership %</div><div class="profile-field-value" id="profOwnerPct">--</div></div>
            <div class="profile-field"><div class="profile-field-label">DOB</div><div class="profile-field-value" id="profOwnerDOB">--</div></div>
            <div class="profile-field"><div class="profile-field-label">SSN</div><div class="profile-field-value" id="profOwnerSSN">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Address</div><div class="profile-field-value" id="profOwnerAddress">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Phone</div><div class="profile-field-value" id="profOwnerPhone">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Email</div><div class="profile-field-value" id="profOwnerEmail">--</div></div>
          </div>
        </div>

        <!-- Financial Summary Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <div class="profile-section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            </div>
            <div class="profile-section-title">Financial Summary</div>
          </div>
          <div class="profile-kpi-row">
            <div class="profile-kpi"><div class="profile-kpi-value" id="profAvgRevenue">--</div><div class="profile-kpi-label">Avg Monthly Revenue</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profAvgBalance">--</div><div class="profile-kpi-label">Avg Daily Balance</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profDeposits">--</div><div class="profile-kpi-label">Avg Deposits</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profMonths">--</div><div class="profile-kpi-label">Months Analyzed</div></div>
          </div>
          <div class="profile-grid" style="margin-top:16px;">
            <div class="profile-field"><div class="profile-field-label">Bank Name</div><div class="profile-field-value" id="profBankName">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Account Number</div><div class="profile-field-value" id="profBankAcct">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Total NSF/OD</div><div class="profile-field-value" id="profNSF">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Negative Days</div><div class="profile-field-value" id="profNegDays">--</div></div>
          </div>
        </div>

        <!-- Credit Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <div class="profile-section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            </div>
            <div class="profile-section-title">Credit Profile</div>
          </div>
          <div class="profile-kpi-row">
            <div class="profile-kpi large"><div class="profile-kpi-value" id="profFICO">--</div><div class="profile-kpi-label">FICO Score</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profUtilization">--</div><div class="profile-kpi-label">Utilization</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profDerogs">--</div><div class="profile-kpi-label">Derogatories</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profInquiries">--</div><div class="profile-kpi-label">Inquiries (6mo)</div></div>
          </div>
          <div class="profile-grid" style="margin-top:16px;">
            <div class="profile-field"><div class="profile-field-label">Public Records</div><div class="profile-field-value" id="profPublicRecords">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Bankruptcies</div><div class="profile-field-value" id="profBankruptcies">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Oldest Account</div><div class="profile-field-value" id="profOldestAcct">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Total Accounts</div><div class="profile-field-value" id="profTotalAccts">--</div></div>
          </div>
        </div>

        <!-- Background / Risk Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <div class="profile-section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div class="profile-section-title">Background & Risk</div>
          </div>
          <div class="profile-kpi-row">
            <div class="profile-kpi"><div class="profile-kpi-value" id="profBgStatus">--</div><div class="profile-kpi-label">Overall Status</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profPositions">--</div><div class="profile-kpi-label">Existing Positions</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profExistingDebt">--</div><div class="profile-kpi-label">Est. Debt Balance</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profMonthlyPmts">--</div><div class="profile-kpi-label">Monthly Payments</div></div>
          </div>
          <div class="profile-grid" style="margin-top:16px;">
            <div class="profile-field"><div class="profile-field-label">Criminal</div><div class="profile-field-value" id="profCriminal">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Civil</div><div class="profile-field-value" id="profCivil">--</div></div>
            <div class="profile-field"><div class="profile-field-label">Liens</div><div class="profile-field-value" id="profLiens">--</div></div>
            <div class="profile-field"><div class="profile-field-label">UCC Filings</div><div class="profile-field-value" id="profUCC">--</div></div>
          </div>
        </div>

        <!-- Funding Request Section -->
        <div class="profile-section">
          <div class="profile-section-header">
            <div class="profile-section-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            </div>
            <div class="profile-section-title">Funding Request</div>
          </div>
          <div class="profile-kpi-row">
            <div class="profile-kpi large"><div class="profile-kpi-value" id="profAmtRequested">--</div><div class="profile-kpi-label">Amount Requested</div></div>
            <div class="profile-kpi"><div class="profile-kpi-value" id="profUseOfFunds">--</div><div class="profile-kpi-label">Use of Funds</div></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Tab: Ables Engine -->
    <div class="tab-content" id="contentEngine">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Ables Engine</div>
          <div class="section-header-status" id="engineStatus">
            <span class="section-status-dot" id="engineStatusDot"></span>
            <span id="engineStatusText">Not run</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="engineRerunBtn" onclick="runUnderwriting()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="engine-header">
        <div class="engine-logo">
          <svg viewBox="0 0 100 100" style="width:48px;height:48px;">
            <defs>
              <linearGradient id="enginePlanet" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#facc15"/>
                <stop offset="50%" style="stop-color:#eab308"/>
                <stop offset="100%" style="stop-color:#ca8a04"/>
              </linearGradient>
            </defs>
            <ellipse cx="50" cy="50" rx="42" ry="10" fill="none" stroke="rgba(234,179,8,0.5)" stroke-width="3" transform="rotate(-20 50 50)"/>
            <circle cx="50" cy="50" r="22" fill="url(#enginePlanet)"/>
          </svg>
          <div>
            <div style="font-size:1.4rem;font-weight:700;">Ables Engine</div>
            <div style="font-size:0.75rem;color:var(--text-muted);">ABLESCORE Underwriting Model v4.2.1</div>
          </div>
        </div>
        <button class="btn btn-primary" id="engineRunBtn" onclick="runUnderwriting()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>
          Run Analysis
        </button>
      </div>

      <div id="engineProcessingOverlay" class="processing-overlay">
        <div class="processing-spinner"></div>
        <div class="processing-text">Running Ables Engine analysis...</div>
        <div class="processing-progress"><div class="processing-progress-bar" id="engineProgressBar" style="width:0%"></div></div>
      </div>

      <div id="engineInputsCard" class="card" style="position:relative;">
        <div class="card-title">Collected Data Summary</div>
        <div class="engine-inputs-grid" style="margin-top:16px;">
          <div class="engine-input-group">
            <label>Monthly Revenue</label>
            <input type="number" id="engineRevenue" class="engine-input" placeholder="$0">
          </div>
          <div class="engine-input-group">
            <label>Avg Daily Balance</label>
            <input type="number" id="engineBalance" class="engine-input" placeholder="$0">
          </div>
          <div class="engine-input-group">
            <label>Credit Score</label>
            <input type="number" id="engineCredit" class="engine-input" placeholder="650" min="300" max="850">
          </div>
          <div class="engine-input-group">
            <label>Time in Business (mo)</label>
            <input type="number" id="engineTIB" class="engine-input" placeholder="24">
          </div>
          <div class="engine-input-group">
            <label>NSF Count (90 days)</label>
            <input type="number" id="engineNSF" class="engine-input" placeholder="0" min="0">
          </div>
          <div class="engine-input-group">
            <label>Negative Days</label>
            <input type="number" id="engineNegDays" class="engine-input" placeholder="0" min="0">
          </div>
          <div class="engine-input-group">
            <label>Industry</label>
            <select id="engineIndustry" class="engine-input">
              <option value="retail">Retail</option>
              <option value="restaurant">Restaurant</option>
              <option value="medical">Medical</option>
              <option value="construction">Construction</option>
              <option value="trucking">Trucking</option>
              <option value="manufacturing">Manufacturing</option>
              <option value="professional">Professional Services</option>
              <option value="auto_repair">Auto Repair</option>
              <option value="salon">Salon/Spa</option>
              <option value="wholesale">Wholesale</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="engine-input-group">
            <label>Existing Debt (monthly)</label>
            <input type="number" id="engineExistingDebt" class="engine-input" placeholder="$0">
          </div>
        </div>
      </div>

      <div id="engineResults" style="display:none;">
        <!-- Score Display -->
        <div class="engine-score-section">
          <div class="engine-score-card">
            <div class="engine-score-ring" id="engineScoreRing">
              <svg viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="42" fill="none" stroke="var(--bg-tertiary)" stroke-width="8"/>
                <circle cx="50" cy="50" r="42" fill="none" stroke-width="8" stroke-linecap="round" id="engineScoreCircle" style="stroke-dasharray:264;stroke-dashoffset:264;transform:rotate(-90deg);transform-origin:center;transition:stroke-dashoffset 1s ease-out;"/>
              </svg>
              <div class="engine-score-inner">
                <span class="engine-score-number" id="engineScoreValue">--</span>
                <span class="engine-score-label">ABLESCORE</span>
              </div>
            </div>
            <div class="engine-tier-badge" id="engineTierBadge">--</div>
            <div class="engine-tier-label" id="engineTierLabel">Run analysis to score</div>
          </div>
          <div class="engine-components">
            <div class="engine-component">
              <div class="engine-component-header"><span>Credit Score</span><span id="compCreditPts">0/20</span></div>
              <div class="engine-component-bar"><div id="compCreditBar" style="width:0%"></div></div>
            </div>
            <div class="engine-component">
              <div class="engine-component-header"><span>Bank Behavior</span><span id="compBehaviorPts">0/30</span></div>
              <div class="engine-component-bar"><div id="compBehaviorBar" style="width:0%"></div></div>
            </div>
            <div class="engine-component">
              <div class="engine-component-header"><span>Revenue</span><span id="compRevenuePts">0/20</span></div>
              <div class="engine-component-bar"><div id="compRevenueBar" style="width:0%"></div></div>
            </div>
            <div class="engine-component">
              <div class="engine-component-header"><span>Stability (TIB)</span><span id="compStabilityPts">0/20</span></div>
              <div class="engine-component-bar"><div id="compStabilityBar" style="width:0%"></div></div>
            </div>
            <div class="engine-component">
              <div class="engine-component-header"><span>Cash Buffer</span><span id="compBufferPts">0/10</span></div>
              <div class="engine-component-bar"><div id="compBufferBar" style="width:0%"></div></div>
            </div>
          </div>
        </div>

        <!-- Risk Metrics -->
        <div class="two-col" style="margin-bottom:16px;">
          <div class="card">
            <div class="card-title"> Risk Metrics</div>
            <div class="risk-metrics-grid">
              <div class="risk-metric">
                <div class="risk-metric-value" id="riskPD">--</div>
                <div class="risk-metric-label">Probability of Default</div>
              </div>
              <div class="risk-metric">
                <div class="risk-metric-value" id="riskDSCR">--</div>
                <div class="risk-metric-label">Debt Service Coverage</div>
              </div>
              <div class="risk-metric">
                <div class="risk-metric-value" id="riskLevel">--</div>
                <div class="risk-metric-label">Risk Level</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Score Distribution</div>
            <div class="chart-container" style="height:160px;"><canvas id="engineScoreChart"></canvas></div>
          </div>
        </div>

        <!-- 3 Approval Options -->
        <div class="card">
          <div class="card-title">Recommended Approval Options</div>
          <div class="approval-options" id="approvalOptions">
            <!-- Generated by JS -->
          </div>
        </div>

        <!-- Adjustable Approval Preview -->
        <div class="card approval-preview-card">
          <div class="card-title"> Custom Approval Builder</div>
          <div class="approval-builder">
            <div class="approval-sliders">
              <div class="slider-group">
                <label>Funding Amount</label>
                <input type="range" id="sliderFunding" min="10000" max="165000" step="1000" oninput="updateApprovalPreview()">
                <div class="slider-value" id="sliderFundingValue">$50,000</div>
              </div>
              <div class="slider-group">
                <label>Factor Rate</label>
                <input type="range" id="sliderFactor" min="1.15" max="1.50" step="0.01" oninput="updateApprovalPreview()">
                <div class="slider-value" id="sliderFactorValue">1.30</div>
              </div>
              <div class="slider-group">
                <label>Term (months)</label>
                <input type="range" id="sliderTerm" min="4" max="12" step="1" oninput="updateApprovalPreview()">
                <div class="slider-value" id="sliderTermValue">9 mo</div>
              </div>
              <div class="slider-group">
                <label>Payment Frequency</label>
                <select id="sliderFreq" class="engine-input" onchange="updateApprovalPreview()">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                </select>
              </div>
            </div>
            <div class="approval-preview" id="approvalPreview">
              <div class="approval-preview-header">
                <svg viewBox="0 0 100 100" style="width:32px;height:32px;">
                  <defs><linearGradient id="prevPlanet" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#facc15"/><stop offset="100%" style="stop-color:#ca8a04"/></linearGradient></defs>
                  <ellipse cx="50" cy="50" rx="42" ry="10" fill="none" stroke="rgba(250,204,21,0.6)" stroke-width="2" transform="rotate(-20 50 50)"/>
                  <circle cx="50" cy="50" r="22" fill="url(#prevPlanet)"/>
                </svg>
                <span>Approval Preview</span>
              </div>
              <div class="approval-preview-body">
                <div class="preview-row main"><span>Funding</span><span id="prevFunding">$50,000</span></div>
                <div class="preview-row"><span>Factor Rate</span><span id="prevFactor">1.30</span></div>
                <div class="preview-row"><span>Payback</span><span id="prevPayback">$65,000</span></div>
                <div class="preview-row"><span>Term</span><span id="prevTerm">9 months</span></div>
                <div class="preview-row highlight"><span id="prevPaymentLabel">Daily Payment</span><span id="prevPayment">$327.27</span></div>
                <div class="preview-row"><span>Holdback %</span><span id="prevHoldback">14.5%</span></div>
                <div class="preview-row"><span>Est. APR</span><span id="prevAPR">45.2%</span></div>
                <hr style="border:none;border-top:1px dashed var(--border-primary);margin:12px 0;">
                <div class="preview-row fee"><span>Origination (3%)</span><span id="prevOrigFee">$1,500</span></div>
                <div class="preview-row fee"><span>Admin Fee</span><span>$995</span></div>
                <div class="preview-row fee"><span>Wire Fee</span><span>$50</span></div>
                <div class="preview-row main"><span>Net Wire</span><span id="prevNetWire">$47,455</span></div>
              </div>
              <div class="approval-preview-footer">
                <button class="btn btn-primary" onclick="shareApproval()" style="width:100%;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
                  Share Calculator Link
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Decline Message -->
        <div class="card decline-card" id="engineDecline" style="display:none;">
          <div class="decline-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
          <div class="decline-title" id="declineTitle">Application Declined</div>
          <div class="decline-reason" id="declineReason">Reason will appear here</div>
        </div>
      </div>
    </div>

    <!-- Tab: Final Review -->
    <div class="tab-content" id="contentReview">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">Final Review</div>
          <div class="section-header-status" id="reviewStatus">
            <span class="section-status-dot" id="reviewStatusDot"></span>
            <span id="reviewStatusText">Not generated</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="reviewRerunBtn" onclick="generateFinalReview()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="review-container" style="position:relative;">
        <div class="processing-overlay" id="reviewProcessingOverlay">
          <div class="processing-spinner"></div>
          <div class="processing-text" id="reviewProcessingText">Generating final review...</div>
          <div class="processing-progress"><div class="processing-progress-bar" id="reviewProgressBar" style="width:0%"></div></div>
        </div>
        <div class="review-header">
          <div class="review-logo">
            <svg viewBox="0 0 100 100" style="width:48px;height:48px;">
              <defs>
                <linearGradient id="reviewPlanet" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#facc15"/>
                  <stop offset="50%" style="stop-color:#eab308"/>
                  <stop offset="100%" style="stop-color:#ca8a04"/>
                </linearGradient>
              </defs>
              <ellipse cx="50" cy="50" rx="42" ry="10" fill="none" stroke="rgba(234,179,8,0.5)" stroke-width="3" transform="rotate(-20 50 50)"/>
              <circle cx="50" cy="50" r="22" fill="url(#reviewPlanet)"/>
            </svg>
            <div>
              <div style="font-size:1.4rem;font-weight:700;">Final Review</div>
              <div style="font-size:0.75rem;color:var(--text-muted);">Ables<span style="color:#78716c">AI</span> Underwriting Analysis</div>
            </div>
          </div>
          <button class="btn btn-primary" id="generateReviewBtn" onclick="generateFinalReview()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M12 2a10 10 0 1 0 10 10H12V2z"/><path d="M20 12a8 8 0 0 0-8-8v8h8z"/></svg>
            Generate Review
          </button>
        </div>

        <!-- Data Summary Cards -->
        <div class="review-data-summary" id="reviewDataSummary">
          <div class="review-summary-card">
            <div class="review-summary-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
            <div class="review-summary-title">Application Data</div>
            <div class="review-summary-status" id="reviewAppStatus">Not loaded</div>
          </div>
          <div class="review-summary-card">
            <div class="review-summary-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><path d="M3 21h18"/><path d="M3 10h18"/><path d="M5 6l7-3 7 3"/><path d="M4 10v11"/><path d="M20 10v11"/><path d="M8 14v3"/><path d="M12 14v3"/><path d="M16 14v3"/></svg></div>
            <div class="review-summary-title">Bank Statements</div>
            <div class="review-summary-status" id="reviewBankStatus">Not loaded</div>
          </div>
          <div class="review-summary-card">
            <div class="review-summary-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>
            <div class="review-summary-title">Credit Report</div>
            <div class="review-summary-status" id="reviewCreditStatus">Not loaded</div>
          </div>
          <div class="review-summary-card">
            <div class="review-summary-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
            <div class="review-summary-title">Engine Score</div>
            <div class="review-summary-status" id="reviewEngineStatus">Not calculated</div>
          </div>
        </div>

        <!-- Review Content Area -->
        <div class="review-content-area" id="reviewContentArea">
          <div class="review-placeholder">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;opacity:0.3;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            <div style="margin-top:16px;font-size:1.1rem;color:var(--text-muted);">
              Upload documents and run the Ables Engine to generate a final review
            </div>
            <div style="margin-top:8px;font-size:0.85rem;color:var(--text-muted);opacity:0.7;">
              The AI will analyze all collected data and provide a comprehensive underwriting recommendation
            </div>
          </div>
        </div>

        <!-- Generated Review Output -->
        <div class="review-output" id="reviewOutput" style="display:none;">
          <div class="review-output-header">
            <div class="review-output-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              Ables<span style="color:#78716c">AI</span> Underwriting Review
            </div>
            <div class="review-output-meta" id="reviewMeta"></div>
          </div>
          <div class="review-output-body" id="reviewBody"></div>
          <div class="review-output-footer">
            <button class="btn btn-secondary" onclick="copyReview()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              Copy Review
            </button>
            <button class="btn btn-secondary" onclick="regenerateReview()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
              Regenerate
            </button>
            <button class="btn btn-primary" onclick="exportReview()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: RC/TC Compare -->
    <div class="tab-content" id="contentCompare">
      <div class="section-header">
        <div class="section-header-left">
          <div class="section-header-title">RC/TC Compare</div>
          <div class="section-header-status" id="compareStatus">
            <span class="section-status-dot" id="compareStatusDot"></span>
            <span id="compareStatusText">Not run</span>
          </div>
        </div>
        <div class="section-header-actions">
          <button class="btn-rerun" id="compareRerunBtn" onclick="runComparison()" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Re-run
          </button>
        </div>
      </div>
      <div class="compare-container" style="position:relative;">
        <div class="processing-overlay" id="compareProcessingOverlay">
          <div class="processing-spinner"></div>
          <div class="processing-text">Running comparison analysis...</div>
          <div class="processing-progress"><div class="processing-progress-bar" id="compareProgressBar" style="width:0%"></div></div>
        </div>
        <div class="compare-header">
          <div class="compare-logo">
            <svg viewBox="0 0 100 100" style="width:48px;height:48px;">
              <defs>
                <linearGradient id="comparePlanet" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#facc15"/>
                  <stop offset="50%" style="stop-color:#eab308"/>
                  <stop offset="100%" style="stop-color:#ca8a04"/>
                </linearGradient>
              </defs>
              <ellipse cx="50" cy="50" rx="42" ry="10" fill="none" stroke="rgba(234,179,8,0.5)" stroke-width="3" transform="rotate(-20 50 50)"/>
              <circle cx="50" cy="50" r="22" fill="url(#comparePlanet)"/>
            </svg>
            <div>
              <div style="font-size:1.4rem;font-weight:700;">RC/TC Compare</div>
              <div style="font-size:0.75rem;color:var(--text-muted);">Approval Comparison Analysis</div>
            </div>
          </div>
          <div class="compare-header-actions">
            <button class="btn btn-secondary" onclick="loadSavedComparison()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
              Load Saved
            </button>
            <button class="btn btn-primary" id="compareRunBtn" onclick="runComparison()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              Compare
            </button>
          </div>
        </div>

        <!-- Comparison Input Section -->
        <div class="compare-inputs">
          <div class="compare-column">
            <div class="compare-column-header">
              <div class="compare-column-title">External Approval</div>
              <div class="compare-column-subtitle">Enter funder's approval terms</div>
            </div>
            <div class="compare-form">
              <div class="compare-input-row">
                <label>Approval Type</label>
                <div class="approval-type-toggle">
                  <button type="button" class="approval-type-btn active" id="extTypeRC" onclick="setApprovalType('RC')">RC</button>
                  <button type="button" class="approval-type-btn" id="extTypeTC" onclick="setApprovalType('TC')">TC</button>
                </div>
              </div>
              <div class="compare-input-row">
                <label>Funder Name</label>
                <input type="text" id="extFunderName" class="compare-input" placeholder="e.g., Capytal, Forward, etc.">
              </div>
              <div class="compare-input-row">
                <label>Funding Amount</label>
                <input type="number" id="extFunding" class="compare-input" placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Factor Rate</label>
                <input type="number" id="extFactor" class="compare-input" placeholder="1.30" step="0.01">
              </div>
              <div class="compare-input-row">
                <label>Payback Amount</label>
                <input type="number" id="extPayback" class="compare-input" placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Term (months)</label>
                <input type="number" id="extTerm" class="compare-input" placeholder="6">
              </div>
              <div class="compare-input-row">
                <label>Payment Frequency</label>
                <select id="extFrequency" class="compare-input">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                </select>
              </div>
              <div class="compare-input-row">
                <label>Payment Amount</label>
                <input type="number" id="extPayment" class="compare-input" placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Origination Fee</label>
                <input type="number" id="extOrigFee" class="compare-input" placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Net Funding</label>
                <input type="number" id="extNetFunding" class="compare-input" placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Position</label>
                <select id="extPosition" class="compare-input">
                  <option value="1st">1st Position</option>
                  <option value="2nd">2nd Position</option>
                  <option value="3rd">3rd Position</option>
                  <option value="4th+">4th+ Position</option>
                </select>
              </div>
              <div class="compare-input-row full-width">
                <label>Notes / Special Terms</label>
                <textarea id="extNotes" class="compare-input" rows="3" placeholder="Stips, conditions, special terms..."></textarea>
              </div>
            </div>
          </div>

          <div class="compare-divider">
            <div class="compare-vs">VS</div>
          </div>

          <div class="compare-column">
            <div class="compare-column-header">
              <div class="compare-column-title">Ables Engine Approval</div>
              <div class="compare-column-subtitle">Auto-populated from engine analysis</div>
            </div>
            <div class="compare-form">
              <div class="compare-input-row">
                <label>Engine Tier</label>
                <input type="text" id="ablesEngineTier" class="compare-input" readonly placeholder="Run Engine first">
              </div>
              <div class="compare-input-row">
                <label>Funding Amount</label>
                <input type="number" id="ablesFunding" class="compare-input" readonly placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Factor Rate</label>
                <input type="number" id="ablesFactor" class="compare-input" readonly placeholder="1.30" step="0.01">
              </div>
              <div class="compare-input-row">
                <label>Payback Amount</label>
                <input type="number" id="ablesPayback" class="compare-input" readonly placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Term (months)</label>
                <input type="number" id="ablesTerm" class="compare-input" readonly placeholder="6">
              </div>
              <div class="compare-input-row">
                <label>Payment Frequency</label>
                <input type="text" id="ablesFrequency" class="compare-input" readonly placeholder="Daily">
              </div>
              <div class="compare-input-row">
                <label>Payment Amount</label>
                <input type="number" id="ablesPayment" class="compare-input" readonly placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Origination Fee</label>
                <input type="number" id="ablesOrigFee" class="compare-input" readonly placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>Net Funding</label>
                <input type="number" id="ablesNetFunding" class="compare-input" readonly placeholder="$0">
              </div>
              <div class="compare-input-row">
                <label>ABLESCORE</label>
                <input type="text" id="ablesScore" class="compare-input" readonly placeholder="--">
              </div>
              <div class="compare-input-row full-width">
                <label>Engine Notes</label>
                <textarea id="ablesNotes" class="compare-input" rows="3" readonly placeholder="Engine recommendation details..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Client Criteria Section -->
        <div class="compare-criteria card">
          <div class="card-title">Client Criteria / Underwriting Guidelines</div>
          
          <div class="criteria-section-label">Business Qualifications</div>
          <div class="criteria-grid">
            <div class="criteria-item">
              <label>Min FICO Score</label>
              <input type="number" id="criteriaMinFico" class="compare-input" placeholder="550">
            </div>
            <div class="criteria-item">
              <label>Min Time in Business</label>
              <select id="criteriaMinTIB" class="compare-input">
                <option value="">Any</option>
                <option value="6">6+ months</option>
                <option value="12">12+ months</option>
                <option value="18">18+ months</option>
                <option value="24">24+ months</option>
                <option value="36">36+ months</option>
              </select>
            </div>
            <div class="criteria-item">
              <label>Industry Restrictions</label>
              <select id="criteriaIndustry" class="compare-input">
                <option value="none">No Restrictions</option>
                <option value="standard">Standard Prohibited List</option>
                <option value="strict">Strict (No High Risk)</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            <div class="criteria-item">
              <label>Min Monthly Revenue</label>
              <input type="number" id="criteriaMinRevenue" class="compare-input" placeholder="10000">
            </div>
            <div class="criteria-item">
              <label>Min Avg Daily Balance</label>
              <input type="number" id="criteriaMinADB" class="compare-input" placeholder="1000">
            </div>
            <div class="criteria-item">
              <label>Min Monthly Deposits</label>
              <input type="number" id="criteriaMinDeposits" class="compare-input" placeholder="10000">
            </div>
          </div>

          <div class="criteria-section-label">Approval Limits</div>
          <div class="criteria-grid">
            <div class="criteria-item">
              <label>Max Factor Rate</label>
              <input type="number" id="criteriaMaxFactor" class="compare-input" placeholder="1.45" step="0.01">
            </div>
            <div class="criteria-item">
              <label>Max Holdback %</label>
              <input type="number" id="criteriaMaxHoldback" class="compare-input" placeholder="20" step="1">
            </div>
            <div class="criteria-item">
              <label>Min Term (months)</label>
              <input type="number" id="criteriaMinTerm" class="compare-input" placeholder="4">
            </div>
            <div class="criteria-item">
              <label>Max Existing Debt Pmts</label>
              <input type="number" id="criteriaMaxExistingDebt" class="compare-input" placeholder="5000">
            </div>
            <div class="criteria-item">
              <label>Max Debt Service %</label>
              <input type="number" id="criteriaMaxDebtService" class="compare-input" placeholder="25">
            </div>
            <div class="criteria-item">
              <label>Preferred Position</label>
              <select id="criteriaPosition" class="compare-input">
                <option value="any">Any</option>
                <option value="1st">1st Only</option>
                <option value="1st-2nd">1st or 2nd</option>
                <option value="1st-3rd">Up to 3rd</option>
              </select>
            </div>
            <div class="criteria-item">
              <label>Min Net Funding %</label>
              <input type="number" id="criteriaMinNet" class="compare-input" placeholder="90" step="1">
            </div>
            <div class="criteria-item">
              <label>Approval Type Pref</label>
              <select id="criteriaApprovalType" class="compare-input">
                <option value="any">Any (RC or TC)</option>
                <option value="rc">RC Preferred</option>
                <option value="tc">TC Required</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Comparison Results -->
        <div class="compare-results" id="compareResults" style="display:none;">
          <div class="compare-results-header">
            <div class="compare-results-title">Comparison Analysis</div>
            <div class="compare-results-meta" id="compareMeta"></div>
          </div>

          <!-- Client Metrics Section -->
          <div class="client-metrics-section" id="clientMetricsSection" style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border-primary);">
            <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;">Client Profile</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;" id="clientMetricsGrid">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="compare-table-wrapper">
            <table class="compare-table">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>External (RC/TC)</th>
                  <th>Ables Engine</th>
                  <th>Difference</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="compareTableBody">
              </tbody>
            </table>
          </div>

          <div class="compare-summary" id="compareSummary"></div>

          <div class="compare-actions">
            <button class="btn btn-secondary" onclick="saveComparison()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              Save Comparison
            </button>
            <button class="btn btn-secondary" onclick="shareComparison()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
              Share Link
            </button>
            <button class="btn btn-primary" onclick="exportComparison()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export Report
            </button>
          </div>
        </div>

        <!-- Placeholder when no comparison -->
        <div class="compare-placeholder" id="comparePlaceholder">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;opacity:0.3;">
            <rect x="3" y="3" width="7" height="18" rx="1"/>
            <rect x="14" y="3" width="7" height="18" rx="1"/>
            <line x1="10" y1="8" x2="14" y2="8"/>
            <line x1="10" y1="12" x2="14" y2="12"/>
            <line x1="10" y1="16" x2="14" y2="16"/>
          </svg>
          <div style="margin-top:16px;font-size:1.1rem;color:var(--text-muted);">
            Enter external approval terms and click Compare
          </div>
          <div style="margin-top:8px;font-size:0.85rem;color:var(--text-muted);opacity:0.7;">
            Run the Ables Engine first for automatic population of internal approval
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <button class="image-modal-close"></button>
    <img id="modalImage" src="" alt="Preview">
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content" onclick="event.stopPropagation()">
      <div class="settings-header">
        <h2>Engine Model Settings</h2>
        <button class="settings-close" onclick="toggleSettings()"></button>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <h3>Score Component Weights</h3>
          <div class="setting-row">
            <label>Credit Score Weight</label>
            <input type="range" min="0.5" max="2" step="0.1" id="setCreditWeight" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setCreditWeightVal">1.0x</span>
          </div>
          <div class="setting-row">
            <label>Time in Business Weight</label>
            <input type="range" min="0.5" max="2" step="0.1" id="setTibWeight" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setTibWeightVal">1.0x</span>
          </div>
          <div class="setting-row">
            <label>NSF Penalty (pts each)</label>
            <input type="range" min="1" max="10" step="1" id="setNsfPenalty" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setNsfPenaltyVal">5</span>
          </div>
          <div class="setting-row">
            <label>Negative Days Penalty (pts each)</label>
            <input type="range" min="1" max="10" step="1" id="setNegDaysPenalty" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setNegDaysPenaltyVal">3</span>
          </div>
        </div>
        <div class="settings-section">
          <h3>Funding Parameters</h3>
          <div class="setting-row">
            <label>Revenue Multiplier</label>
            <input type="range" min="0.5" max="2" step="0.1" id="setRevenueMultiplier" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setRevenueMultiplierVal">1.0x</span>
          </div>
          <div class="setting-row">
            <label>Term Length Weight</label>
            <input type="range" min="0.5" max="2" step="0.1" id="setTermLengthWeight" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setTermLengthWeightVal">1.0x</span>
          </div>
          <div class="setting-row">
            <label>Base Multiplier</label>
            <input type="range" min="0.2" max="0.8" step="0.05" id="setBaseMultiplier" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setBaseMultiplierVal">0.40x</span>
          </div>
          <div class="setting-row">
            <label>Max Debt Service %</label>
            <input type="range" min="15" max="40" step="1" id="setMaxDebtService" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setMaxDebtServiceVal">25%</span>
          </div>
        </div>
        <div class="settings-section">
          <h3>Limits</h3>
          <div class="setting-row">
            <label>Max Funding</label>
            <input type="range" min="50000" max="500000" step="5000" id="setMaxFunding" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setMaxFundingVal">$165K</span>
          </div>
          <div class="setting-row">
            <label>Min Funding</label>
            <input type="range" min="5000" max="25000" step="1000" id="setMinFunding" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setMinFundingVal">$10K</span>
          </div>
          <div class="setting-row">
            <label>Min Revenue Required</label>
            <input type="range" min="5000" max="15000" step="500" id="setMinRevenue" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setMinRevenueVal">$7.5K</span>
          </div>
          <div class="setting-row">
            <label>Min Credit Score</label>
            <input type="range" min="400" max="600" step="10" id="setMinCredit" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setMinCreditVal">500</span>
          </div>
          <div class="setting-row">
            <label>Buffer Threshold %</label>
            <input type="range" min="5" max="20" step="1" id="setBufferThreshold" oninput="updateSettingValue(this)">
            <span class="setting-value" id="setBufferThresholdVal">10%</span>
          </div>
        </div>
      </div>
      <div class="settings-footer">
        <button class="btn" onclick="resetSettings()">Reset Defaults</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let apiKey = localStorage.getItem('gemini_api_key') || '';
    let darkMode = localStorage.getItem('ables_dark_mode') === 'true';
    let processingCount = 0;
    
    const data = {
      application: { files: [], previews: [], extracted: null },
      bank: { files: [], previews: [], accounts: {}, months: [], largeTransactions: [], debts: [], insights: {}, transactions: [], excludedDeposits: [] },
      credit: { files: [], previews: [], extracted: null },
      background: { 
        files: [], 
        previews: [], 
        research: {},
        checks: {},
        reviews: {},
        social: {},
        footprint: {},
        debt: { positions: [], uccFilings: [] }
      },
      other: { files: [], previews: [], extracted: [] }
    };
    
    // Engine Model Settings (adjustable)
    const engineSettings = {
      revenueMultiplier: 1.0,
      termLengthWeight: 1.0,
      creditScoreWeight: 1.0,
      tibWeight: 1.0,
      nsfPenalty: 5,
      negDaysPenalty: 3,
      bufferThreshold: 10,
      maxDebtService: 25,
      baseMultiplier: 0.40,
      maxFunding: 165000,
      minFunding: 10000,
      minRevenue: 7500,
      minCredit: 500
    };
    
    // Load saved settings
    const savedSettings = localStorage.getItem('engine_settings');
    if (savedSettings) Object.assign(engineSettings, JSON.parse(savedSettings));
    
    let charts = {};

    document.addEventListener('DOMContentLoaded', () => {
      if (apiKey) { document.getElementById('apiKeyInput').value = apiKey; updateApiStatus(true); }
      if (darkMode) document.body.classList.add('dark-mode');
      setupDropzones();
      initSettingsSliders();
      
      // Initialize section statuses
      ['application', 'bank', 'credit', 'background'].forEach(type => {
        updateSectionStatus(type);
      });
      updateWorkflowSteps();
      
      // Check for shared comparison in URL
      const urlParams = new URLSearchParams(window.location.search);
      const sharedComparison = urlParams.get('comparison');
      if (sharedComparison) {
        try {
          loadSharedComparison(sharedComparison);
        } catch (e) {
          console.error('Failed to load shared comparison:', e);
        }
      }
    });

    function toggleTheme() {
      darkMode = !darkMode;
      document.body.classList.toggle('dark-mode', darkMode);
      localStorage.setItem('ables_dark_mode', darkMode);
    }

    // Settings Modal Functions
    function toggleSettings() {
      document.getElementById('settingsModal').classList.toggle('active');
    }

    function initSettingsSliders() {
      // Initialize slider values from engineSettings
      const mappings = {
        'setCreditWeight': { key: 'creditScoreWeight', suffix: 'x' },
        'setTibWeight': { key: 'tibWeight', suffix: 'x' },
        'setNsfPenalty': { key: 'nsfPenalty', suffix: '' },
        'setNegDaysPenalty': { key: 'negDaysPenalty', suffix: '' },
        'setRevenueMultiplier': { key: 'revenueMultiplier', suffix: 'x' },
        'setTermLengthWeight': { key: 'termLengthWeight', suffix: 'x' },
        'setBaseMultiplier': { key: 'baseMultiplier', suffix: 'x' },
        'setMaxDebtService': { key: 'maxDebtService', suffix: '%' },
        'setMaxFunding': { key: 'maxFunding', suffix: '', format: 'currency' },
        'setMinFunding': { key: 'minFunding', suffix: '', format: 'currency' },
        'setMinRevenue': { key: 'minRevenue', suffix: '', format: 'currency' },
        'setMinCredit': { key: 'minCredit', suffix: '' },
        'setBufferThreshold': { key: 'bufferThreshold', suffix: '%' }
      };
      
      Object.entries(mappings).forEach(([id, config]) => {
        const slider = document.getElementById(id);
        const valueEl = document.getElementById(id + 'Val');
        if (slider && valueEl) {
          slider.value = engineSettings[config.key];
          updateSettingDisplay(valueEl, engineSettings[config.key], config);
        }
      });
    }

    function updateSettingValue(slider) {
      const id = slider.id;
      const valueEl = document.getElementById(id + 'Val');
      const mappings = {
        'setCreditWeight': { key: 'creditScoreWeight', suffix: 'x' },
        'setTibWeight': { key: 'tibWeight', suffix: 'x' },
        'setNsfPenalty': { key: 'nsfPenalty', suffix: '' },
        'setNegDaysPenalty': { key: 'negDaysPenalty', suffix: '' },
        'setRevenueMultiplier': { key: 'revenueMultiplier', suffix: 'x' },
        'setTermLengthWeight': { key: 'termLengthWeight', suffix: 'x' },
        'setBaseMultiplier': { key: 'baseMultiplier', suffix: 'x' },
        'setMaxDebtService': { key: 'maxDebtService', suffix: '%' },
        'setMaxFunding': { key: 'maxFunding', suffix: '', format: 'currency' },
        'setMinFunding': { key: 'minFunding', suffix: '', format: 'currency' },
        'setMinRevenue': { key: 'minRevenue', suffix: '', format: 'currency' },
        'setMinCredit': { key: 'minCredit', suffix: '' },
        'setBufferThreshold': { key: 'bufferThreshold', suffix: '%' }
      };
      
      const config = mappings[id];
      if (config) {
        const value = parseFloat(slider.value);
        engineSettings[config.key] = value;
        updateSettingDisplay(valueEl, value, config);
      }
    }

    function updateSettingDisplay(el, value, config) {
      if (config.format === 'currency') {
        el.textContent = '$' + (value / 1000).toFixed(value >= 100000 ? 0 : 1) + 'K';
      } else {
        el.textContent = value + config.suffix;
      }
    }

    function saveSettings() {
      localStorage.setItem('engine_settings', JSON.stringify(engineSettings));
      toggleSettings();
      showToast('Settings saved', 'success');
    }

    function resetSettings() {
      const defaults = {
        revenueMultiplier: 1.0,
        termLengthWeight: 1.0,
        creditScoreWeight: 1.0,
        tibWeight: 1.0,
        nsfPenalty: 5,
        negDaysPenalty: 3,
        bufferThreshold: 10,
        maxDebtService: 25,
        baseMultiplier: 0.40,
        maxFunding: 165000,
        minFunding: 10000,
        minRevenue: 7500,
        minCredit: 500
      };
      Object.assign(engineSettings, defaults);
      localStorage.removeItem('engine_settings');
      initSettingsSliders();
      showToast('Settings reset to defaults', 'success');
    }

    // Profile Summary Functions
    function updateProfileSummary() {
      const profile = document.getElementById('profileSummary');
      const hasData = data.application.extracted || data.bank.months.length || data.credit.extracted;
      
      if (!hasData) {
        profile.style.display = 'none';
      } else {
        profile.style.display = 'flex';
        
        // Business name and initials
        const bizName = data.application.extracted?.business?.legalName || 
                        data.application.extracted?.business?.dba || 
                        'Business';
        const initials = bizName.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
        document.getElementById('profileAvatar').textContent = initials || '--';
        document.getElementById('profileName').textContent = bizName;
        
        // Meta info
        const industry = data.application.extracted?.business?.industry || '';
        const city = data.application.extracted?.business?.city || '';
        const state = data.application.extracted?.business?.state || '';
        const location = [city, state].filter(Boolean).join(', ');
        document.getElementById('profileMeta').textContent = [industry, location].filter(Boolean).join('  ') || 'Business';
        
        // Stats - use trueCredits (actual revenue) if available
        if (data.bank.months.length) {
          const avgRev = data.bank.months.reduce((s, m) => s + (m.trueCredits || m.deposits || m.revenue || 0), 0) / data.bank.months.length;
          document.getElementById('profileRevenue').textContent = formatCurrency(avgRev);
        }
        
        if (data.credit.extracted?.score) {
          document.getElementById('profileCredit').textContent = data.credit.extracted.score;
        }
        
        if (data.application.tib) {
          const months = data.application.tib;
          const years = Math.floor(months / 12);
          const mo = months % 12;
          document.getElementById('profileTIB').textContent = years > 0 ? `${years}y ${mo}m` : `${mo}m`;
          console.log('Set profileTIB to:', document.getElementById('profileTIB').textContent);
        } else if (data.application.extracted?.business?.dateEstablished || data.application.extracted?.business?.startDate) {
          const dateStr = data.application.extracted.business.dateEstablished || data.application.extracted.business.startDate;
          console.log('TIB not calculated, using date string:', dateStr);
          document.getElementById('profileTIB').textContent = dateStr;
          // Try to calculate TIB from the date string
          const calcTib = calculateTIB(dateStr);
          if (calcTib > 0) {
            data.application.tib = calcTib;
            const years = Math.floor(calcTib / 12);
            const mo = calcTib % 12;
            document.getElementById('profileTIB').textContent = years > 0 ? `${years}y ${mo}m` : `${mo}m`;
          }
        }
        
        // Account count
        const acctCount = Object.keys(data.bank.accounts).length;
        document.getElementById('profileAccounts').textContent = acctCount || (data.bank.months.length ? '1' : '--');
        
        // Doc count
        const docCount = data.application.files.length + data.bank.files.length + 
                         data.credit.files.length + data.background.files.length;
        document.getElementById('profileDocs').textContent = docCount;
      }
      
      // Update Profile Tab
      updateProfileTab();
    }

    function updateProfileTab() {
      // Data completeness
      const hasApp = !!data.application.extracted;
      const hasBank = data.bank.months.length > 0;
      const hasCredit = !!data.credit.extracted;
      const hasBg = Object.keys(data.background.research || {}).length > 0 || Object.keys(data.background.checks || {}).length > 0;
      
      const completePct = [hasApp, hasBank, hasCredit, hasBg].filter(Boolean).length * 25;
      document.getElementById('profileCompleteness').style.width = completePct + '%';
      
      document.getElementById('compApp').classList.toggle('complete', hasApp);
      document.getElementById('compBank').classList.toggle('complete', hasBank);
      document.getElementById('compCredit').classList.toggle('complete', hasCredit);
      document.getElementById('compBg').classList.toggle('complete', hasBg);

      // Ables Score section
      if (currentUnderwritingResult?.score) {
        const s = currentUnderwritingResult.score;
        const o = currentUnderwritingResult.offer;
        
        // Use purple color gradient based on tier
        const tierColors = { a: '#6366f1', b: '#8b5cf6', c: '#a78bfa', d: '#c4b5fd', e: '#ef4444' };
        const scoreColor = tierColors[s.tier?.toLowerCase()] || '#8b5cf6';
        
        document.getElementById('profileScoreNum').textContent = s.score;
        document.getElementById('profileScoreRing').style.setProperty('--pct', s.score);
        document.getElementById('profileScoreRing').style.setProperty('--score-color', scoreColor);
        document.getElementById('profileTier').textContent = o?.declined ? 'DECLINED' : `Tier ${s.tier} Approval`;
        
        if (!o?.declined) {
          document.getElementById('profileFunding').textContent = formatCurrency(o?.funding || 0);
          document.getElementById('profileFactor').textContent = `${(o?.factor || 0).toFixed(2)} factor`;
          document.getElementById('profileTerm').textContent = `${o?.termMonths || 0} months`;
        } else {
          document.getElementById('profileFunding').textContent = 'N/A';
          document.getElementById('profileFactor').textContent = o?.declineReason || 'Declined';
          document.getElementById('profileTerm').textContent = '';
        }
      }

      // Business Overview
      const biz = data.application.extracted?.business || {};
      document.getElementById('profBizName').textContent = biz.legalName || '--';
      document.getElementById('profBizDBA').textContent = biz.dba || '--';
      document.getElementById('profBizIndustry').textContent = biz.industry || '--';
      document.getElementById('profBizEntity').textContent = biz.entityType || '--';
      document.getElementById('profBizState').textContent = biz.stateOfIncorporation || biz.state || '--';
      
      if (data.application.tib) {
        const months = data.application.tib;
        const years = Math.floor(months / 12);
        const mo = months % 12;
        document.getElementById('profBizTIB').textContent = years > 0 ? `${years} years, ${mo} months` : `${mo} months`;
      } else {
        const dateEst = biz.dateEstablished || biz.startDate;
        if (dateEst) {
          // Try to calculate and set TIB
          const calcTib = calculateTIB(dateEst);
          if (calcTib > 0) {
            data.application.tib = calcTib;
            const years = Math.floor(calcTib / 12);
            const mo = calcTib % 12;
            document.getElementById('profBizTIB').textContent = years > 0 ? `${years} years, ${mo} months` : `${mo} months`;
          } else {
            document.getElementById('profBizTIB').textContent = dateEst;
          }
        } else {
          document.getElementById('profBizTIB').textContent = '--';
        }
      }
      
      const fullAddress = [biz.address, biz.city, biz.state, biz.zip].filter(Boolean).join(', ');
      document.getElementById('profBizAddress').textContent = fullAddress || '--';
      document.getElementById('profBizPhone').textContent = biz.phone || '--';

      // Owner Info
      const owner = data.application.extracted?.owner || {};
      document.getElementById('profOwnerName').textContent = owner.name || '--';
      document.getElementById('profOwnerTitle').textContent = owner.title || '--';
      document.getElementById('profOwnerPct').textContent = owner.ownership ? owner.ownership + '%' : '--';
      document.getElementById('profOwnerDOB').textContent = owner.dob || '--';
      document.getElementById('profOwnerSSN').textContent = owner.ssn ? '***-**-' + owner.ssn.slice(-4) : '--';
      const ownerAddr = [owner.address, owner.city, owner.state, owner.zip].filter(Boolean).join(', ');
      document.getElementById('profOwnerAddress').textContent = ownerAddr || '--';
      document.getElementById('profOwnerPhone').textContent = owner.phone || '--';
      document.getElementById('profOwnerEmail').textContent = owner.email || '--';

      // Financial Summary - use trueCredits for actual revenue
      if (data.bank.months.length) {
        const avgTrueRev = data.bank.months.reduce((s, m) => s + (m.trueCredits || m.deposits || m.revenue || 0), 0) / data.bank.months.length;
        const avgBal = data.bank.months.reduce((s, m) => s + (m.avgDailyBal || m.endingBal || 0), 0) / data.bank.months.length;
        const avgDep = data.bank.months.reduce((s, m) => s + (m.deposits || m.revenue || 0), 0) / data.bank.months.length;
        const totalNSF = data.bank.months.reduce((s, m) => s + (m.nsfs || 0), 0);
        const totalNeg = data.bank.months.reduce((s, m) => s + (m.negatives || 0), 0);
        
        document.getElementById('profAvgRevenue').textContent = formatCurrency(avgTrueRev);
        document.getElementById('profAvgBalance').textContent = formatCurrency(avgBal);
        document.getElementById('profDeposits').textContent = formatCurrency(avgDep);
        document.getElementById('profMonths').textContent = data.bank.months.length;
        document.getElementById('profNSF').textContent = totalNSF;
        document.getElementById('profNegDays').textContent = totalNeg;
        
        // Get bank info from first account
        const acctKeys = Object.keys(data.bank.accounts);
        if (acctKeys.length > 0) {
          const firstAcct = data.bank.accounts[acctKeys[0]];
          document.getElementById('profBankName').textContent = firstAcct.bankName || '--';
          document.getElementById('profBankAcct').textContent = firstAcct.accountNumber ? '****' + firstAcct.accountNumber.slice(-4) : '--';
        }
      }

      // Credit Profile
      const credit = data.credit.extracted || {};
      const creditSummary = credit.summary || {};
      document.getElementById('profFICO').textContent = credit.score || '--';
      document.getElementById('profUtilization').textContent = creditSummary.utilization ? creditSummary.utilization + '%' : '--';
      document.getElementById('profDerogs').textContent = creditSummary.derogatoryMarks ?? '--';
      document.getElementById('profInquiries').textContent = creditSummary.inquiries ?? '--';
      document.getElementById('profPublicRecords').textContent = creditSummary.publicRecords ?? '--';
      document.getElementById('profBankruptcies').textContent = creditSummary.bankruptcies ?? '--';
      document.getElementById('profOldestAcct').textContent = credit.oldestAccount || '--';
      document.getElementById('profTotalAccts').textContent = creditSummary.totalAccounts ?? '--';

      // Background & Risk
      const bg = data.background;
      const checks = bg.checks || {};
      document.getElementById('profBgStatus').textContent = checks.overallStatus === 'clear' ? 'Clear' : (checks.overallStatus === 'flags' ? 'Flags' : '--');
      document.getElementById('profBgStatus').className = 'profile-kpi-value ' + (checks.overallStatus === 'clear' ? 'positive' : (checks.overallStatus === 'flags' ? 'negative' : ''));
      
      const positions = bg.debt?.positions?.filter(p => p.status === 'active') || [];
      document.getElementById('profPositions').textContent = positions.length || '0';
      
      const totalDebt = positions.reduce((s, p) => s + (parseFloat(p.balance) || 0), 0);
      document.getElementById('profExistingDebt').textContent = formatCurrency(totalDebt);
      
      const monthlyPmts = positions.reduce((s, p) => {
        const pmt = parseFloat(p.payment) || 0;
        const mult = p.frequency === 'daily' ? 22 : (p.frequency === 'weekly' ? 4.33 : 1);
        return s + (pmt * mult);
      }, 0);
      document.getElementById('profMonthlyPmts').textContent = formatCurrency(monthlyPmts);
      
      document.getElementById('profCriminal').textContent = checks.criminal || '--';
      document.getElementById('profCivil').textContent = checks.civil || '--';
      document.getElementById('profLiens').textContent = checks.liens || '--';
      document.getElementById('profUCC').textContent = checks.uccFilings || '--';

      // Funding Request
      const funding = data.application.extracted?.funding || {};
      document.getElementById('profAmtRequested').textContent = funding.amountRequested ? formatCurrency(funding.amountRequested) : '--';
      document.getElementById('profUseOfFunds').textContent = funding.useOfFunds || '--';
    }

    function generateProfilePDF() {
      const bizName = data.application.extracted?.business?.legalName || 
                      data.application.extracted?.business?.dba || 
                      'Business Profile';
      
      const content = document.querySelector('.profile-container').cloneNode(true);
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${bizName} - Profile Summary</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; }
            .profile-score-header { display: flex; gap: 20px; padding: 20px; background: #fffbeb; border: 1px solid #fde68a; border-radius: 12px; margin-bottom: 20px; }
            .profile-section { border: 1px solid #e5e5e5; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
            .profile-section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
            .profile-section-title { font-size: 14px; font-weight: 700; }
            .profile-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
            .profile-field { background: #f9f9f9; padding: 10px; border-radius: 6px; }
            .profile-field-label { font-size: 9px; font-weight: 600; text-transform: uppercase; color: #888; margin-bottom: 4px; }
            .profile-field-value { font-size: 13px; font-weight: 500; }
            .profile-kpi-row { display: flex; gap: 16px; margin-bottom: 16px; }
            .profile-kpi { flex: 1; background: #f5f5f5; padding: 16px; border-radius: 8px; text-align: center; }
            .profile-kpi-value { font-size: 18px; font-weight: 700; }
            .profile-kpi-label { font-size: 9px; font-weight: 600; text-transform: uppercase; color: #888; }
            .profile-completeness, .profile-score-actions, .btn { display: none !important; }
            .score-ring { display: none; }
            @media print { body { padding: 20px; } }
          </style>
        </head>
        <body>
          <h1 style="margin-bottom:20px;font-size:24px;">${bizName}</h1>
          <p style="color:#666;margin-bottom:20px;">Profile Summary  Generated ${new Date().toLocaleDateString()}</p>
          ${content.innerHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKeyInput').value.trim();
      if (apiKey) { localStorage.setItem('gemini_api_key', apiKey); updateApiStatus(true); showToast('API key saved', 'success'); }
      else { localStorage.removeItem('gemini_api_key'); updateApiStatus(false); }
    }

    function updateApiStatus(active) {
      document.getElementById('apiStatusDot').classList.toggle('active', active);
      document.getElementById('apiStatusText').textContent = active ? 'Connected' : 'Not set';
    }

    function updateProcessingCount(delta) {
      processingCount += delta;
      const el = document.getElementById('processingCount');
      const txt = document.getElementById('procCountText');
      if (processingCount > 0) { el.style.display = 'inline-flex'; txt.textContent = processingCount; }
      else { el.style.display = 'none'; }
    }

    function setupDropzones() {
      document.querySelectorAll('.dropzone').forEach(dz => {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dz.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(e => dz.addEventListener(e, () => dz.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(e => dz.addEventListener(e, () => dz.classList.remove('dragover')));
      });
      document.getElementById('mainDropzone').addEventListener('drop', e => handleMainUpload(e.dataTransfer.files));
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabId = tab === 'all' ? 'All' : tab.charAt(0).toUpperCase() + tab.slice(1);
      document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`)?.classList.add('active');
      document.getElementById('content' + tabId)?.classList.add('active');
      
      // Update workflow step states
      updateWorkflowSteps();
    }

    // Processing state tracking
    const processingState = {
      application: { status: 'idle', filesProcessing: 0, filesTotal: 0, complete: false },
      bank: { status: 'idle', filesProcessing: 0, filesTotal: 0, complete: false },
      credit: { status: 'idle', filesProcessing: 0, filesTotal: 0, complete: false },
      background: { status: 'idle', filesProcessing: 0, filesTotal: 0, complete: false },
      engine: { status: 'idle', complete: false },
      review: { status: 'idle', complete: false },
      compare: { status: 'idle', complete: false }
    };

    function updateSectionStatus(type) {
      const state = processingState[type];
      const typeKey = type === 'application' ? 'app' : (type === 'background' ? 'bg' : type);
      const dotEl = document.getElementById(`${typeKey}StatusDot`);
      const textEl = document.getElementById(`${typeKey}StatusText`);
      const btnEl = document.getElementById(`${typeKey}RerunBtn`);
      const overlayEl = document.getElementById(`${typeKey}ProcessingOverlay`);
      const progressBarEl = document.getElementById(`${typeKey}ProgressBar`);
      const processingTextEl = document.getElementById(`${typeKey}ProcessingText`);
      
      // Extra re-scrub button for bank section
      const reScrubBtn = type === 'bank' ? document.getElementById('bankReScrubBtn') : null;
      
      // Update step progress badge
      const stepKey = type === 'application' ? 'App' : (type === 'background' ? 'Bg' : type.charAt(0).toUpperCase() + type.slice(1));
      const stepProgressEl = document.getElementById(`stepProgress${stepKey}`);
      const stepProgressTextEl = document.getElementById(`stepProgress${stepKey}Text`);
      
      if (dotEl) {
        // Remove all state classes
        dotEl.classList.remove('pending', 'processing', 'complete', 'error');
        
        const fileCount = data[type]?.files?.length || 0;
        
        if (state.status === 'processing') {
          dotEl.classList.add('processing');
          const processed = state.filesTotal - state.filesProcessing;
          const progress = state.filesTotal > 0 ? Math.round(processed / state.filesTotal * 100) : 0;
          textEl.textContent = `Processing ${processed + 1} of ${state.filesTotal}...`;
          if (btnEl) { btnEl.disabled = true; btnEl.classList.add('processing'); }
          if (reScrubBtn) { reScrubBtn.disabled = true; }
          if (overlayEl) overlayEl.classList.add('active');
          if (progressBarEl) progressBarEl.style.width = progress + '%';
          if (processingTextEl) processingTextEl.textContent = `Processing ${type}... (${processed + 1}/${state.filesTotal})`;
          if (stepProgressTextEl) stepProgressTextEl.textContent = `${processed + 1}/${state.filesTotal}`;
        } else if (state.complete) {
          dotEl.classList.add('complete');
          textEl.textContent = fileCount > 0 ? `Complete (${fileCount} files)` : 'Complete';
          if (btnEl) { btnEl.disabled = false; btnEl.classList.remove('processing'); }
          if (reScrubBtn) { reScrubBtn.disabled = false; }
          if (overlayEl) overlayEl.classList.remove('active');
        } else if (fileCount > 0) {
          dotEl.classList.add('pending');
          textEl.textContent = `${fileCount} files uploaded`;
          if (btnEl) { btnEl.disabled = false; btnEl.classList.remove('processing'); }
          if (reScrubBtn) { reScrubBtn.disabled = false; }
          if (overlayEl) overlayEl.classList.remove('active');
        } else {
          textEl.textContent = 'No files';
          if (btnEl) btnEl.disabled = true;
          if (reScrubBtn) reScrubBtn.disabled = true;
          if (overlayEl) overlayEl.classList.remove('active');
        }
      }
      
      // Handle special types (engine, review, compare)
      if (type === 'engine' || type === 'review' || type === 'compare') {
        const specialDot = document.getElementById(`${type}StatusDot`);
        const specialText = document.getElementById(`${type}StatusText`);
        const specialBtn = document.getElementById(`${type}RerunBtn`);
        const specialOverlay = document.getElementById(`${type}ProcessingOverlay`);
        
        if (specialDot) {
          specialDot.classList.remove('pending', 'processing', 'complete', 'error');
          if (state.status === 'processing') {
            specialDot.classList.add('processing');
            specialText.textContent = 'Processing...';
            if (specialBtn) specialBtn.disabled = true;
            if (specialOverlay) specialOverlay.classList.add('active');
          } else if (state.complete) {
            specialDot.classList.add('complete');
            // Show meaningful status text
            if (type === 'engine' && currentUnderwritingResult) {
              specialText.textContent = `Score: ${currentUnderwritingResult.score.score} (Tier ${currentUnderwritingResult.score.tier})`;
            } else if (type === 'compare' && currentComparison) {
              const winner = currentComparison.extWins > currentComparison.ablesWins ? 'External' : 
                            (currentComparison.ablesWins > currentComparison.extWins ? 'Ables' : 'Tie');
              specialText.textContent = winner === 'Tie' ? 'Complete (Tie)' : `Complete (${winner} wins)`;
            } else {
              specialText.textContent = 'Complete';
            }
            if (specialBtn) specialBtn.disabled = false;
            if (specialOverlay) specialOverlay.classList.remove('active');
          } else {
            specialText.textContent = 'Not run';
            // Enable rerun button if there's data to work with
            if (specialBtn) {
              const hasData = data.bank.months.length > 0 || data.application.extracted;
              specialBtn.disabled = !hasData;
            }
            if (specialOverlay) specialOverlay.classList.remove('active');
          }
        }
      }
      
      updateWorkflowSteps();
    }

    function setProcessingState(type, status, filesProcessing = 0, filesTotal = 0) {
      processingState[type].status = status;
      processingState[type].filesProcessing = filesProcessing;
      processingState[type].filesTotal = filesTotal;
      if (status === 'complete') processingState[type].complete = true;
      updateSectionStatus(type);
      updateWorkflowProgressBanner();
      updateWorkflowSteps(); // Update workflow tab icons (green checkmarks)
    }

    function updateWorkflowProgressBanner() {
      const banner = document.getElementById('workflowProgressBanner');
      const stepEl = document.getElementById('workflowProgressStep');
      const detailEl = document.getElementById('workflowProgressDetail');
      const barEl = document.getElementById('workflowProgressBar');
      
      if (!banner) return;
      
      // Check what's currently processing
      const processingTypes = [];
      const typeNames = {
        application: 'Extracting Application Data',
        bank: 'Analyzing Bank Statements',
        credit: 'Processing Credit Report',
        background: 'Running Background Search',
        engine: 'Running Ables Engine',
        review: 'Generating Final Review',
        compare: 'Running RC/TC Comparison'
      };
      
      let currentType = null;
      let progress = 0;
      
      for (const [type, state] of Object.entries(processingState)) {
        if (state.status === 'processing') {
          currentType = type;
          if (state.filesTotal > 0) {
            progress = Math.round(((state.filesTotal - state.filesProcessing) / state.filesTotal) * 100);
          } else {
            progress = 50; // Indeterminate
          }
          break;
        }
      }
      
      if (currentType) {
        banner.style.display = 'flex';
        stepEl.textContent = typeNames[currentType] || 'Processing...';
        
        const state = processingState[currentType];
        if (state.filesTotal > 0) {
          const current = state.filesTotal - state.filesProcessing;
          detailEl.textContent = `File ${current} of ${state.filesTotal}`;
        } else if (currentType === 'background') {
          detailEl.textContent = 'Searching business intelligence sources...';
        } else if (currentType === 'engine') {
          detailEl.textContent = 'Calculating score and approval parameters...';
        } else if (currentType === 'review') {
          detailEl.textContent = 'AI generating comprehensive review...';
        } else if (currentType === 'compare') {
          detailEl.textContent = 'Comparing RC vs TC approval scenarios...';
        } else {
          detailEl.textContent = 'Please wait...';
        }
        
        barEl.style.width = progress + '%';
      } else {
        // Check if anything completed
        const completedCount = Object.values(processingState).filter(s => s.complete).length;
        if (completedCount > 0 && completedCount < 7) {
          // Show completion status briefly then hide
          banner.style.display = 'flex';
          stepEl.textContent = `${completedCount} of 7 steps complete`;
          detailEl.textContent = 'Workflow in progress';
          barEl.style.width = Math.round((completedCount / 7) * 100) + '%';
        } else if (completedCount >= 7) {
          banner.style.display = 'none';
          // Show completion flash
          if (typeof showCompletionFlash === 'function') {
            showCompletionFlash('All processing complete!');
          }
        } else {
          banner.style.display = 'none';
        }
      }
    }

    function updateWorkflowSteps() {
      // Check which steps have data/are complete
      const hasAnyData = data.application.extracted || data.bank.months.length > 0 || data.credit.extracted || Object.keys(data.background.research || {}).length > 0;
      
      // Profile is only complete when ALL document types are complete
      const allDocsComplete = processingState.application.complete && 
                              processingState.bank.complete && 
                              processingState.credit.complete && 
                              processingState.background.complete;
      
      // Profile is processing if any document type is still processing
      const anyDocProcessing = processingState.application.status === 'processing' ||
                               processingState.bank.status === 'processing' ||
                               processingState.credit.status === 'processing' ||
                               processingState.background.status === 'processing';
      
      // States: processing (spinner), complete (checkmark), or neither
      const stepStates = {
        1: { processing: false, complete: true }, // Upload is always available
        2: { processing: processingState.application.status === 'processing', complete: processingState.application.complete, current: processingState.application.filesTotal - processingState.application.filesProcessing + 1, total: processingState.application.filesTotal },
        3: { processing: processingState.bank.status === 'processing', complete: processingState.bank.complete, current: processingState.bank.filesTotal - processingState.bank.filesProcessing + 1, total: processingState.bank.filesTotal },
        4: { processing: processingState.credit.status === 'processing', complete: processingState.credit.complete, current: processingState.credit.filesTotal - processingState.credit.filesProcessing + 1, total: processingState.credit.filesTotal },
        5: { processing: processingState.background.status === 'processing', complete: processingState.background.complete, current: processingState.background.filesTotal - processingState.background.filesProcessing + 1, total: processingState.background.filesTotal },
        6: { processing: anyDocProcessing && hasAnyData, complete: allDocsComplete },
        7: { processing: processingState.engine.status === 'processing', complete: processingState.engine.complete || currentUnderwritingResult !== null },
        8: { processing: processingState.review.status === 'processing', complete: processingState.review.complete },
        9: { processing: processingState.compare.status === 'processing', complete: processingState.compare.complete || currentComparison !== null }
      };

      document.querySelectorAll('.workflow-step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        const btn = step.querySelector('.tab-btn');
        const state = stepStates[stepNum];
        
        // Remove all state classes
        step.classList.remove('completed', 'processing');
        btn.classList.remove('completed', 'processing');
        
        if (state.processing) {
          step.classList.add('processing');
          btn.classList.add('processing');
        } else if (state.complete) {
          step.classList.add('completed');
          btn.classList.add('completed');
        }
      });
      
      // Update Profile tab status
      const profileDot = document.getElementById('profileStatusDot');
      const profileText = document.getElementById('profileStatusText');
      const profileBtn = document.getElementById('profileRerunBtn');
      if (profileDot) {
        profileDot.classList.remove('pending', 'processing', 'complete');
        if (hasAnyData) {
          profileDot.classList.add('complete');
          const sections = [data.application.extracted, data.bank.months.length > 0, data.credit.extracted, Object.keys(data.background.research || {}).length > 0].filter(Boolean).length;
          profileText.textContent = `${sections}/4 sections loaded`;
          if (profileBtn) profileBtn.disabled = false;
        } else {
          profileText.textContent = 'No data';
          if (profileBtn) profileBtn.disabled = true;
        }
      }
    }

    async function rerunProcessing(type) {
      if (data[type].files.length === 0) {
        showToast('No files to process', 'error');
        return;
      }
      
      // Reset data for this type
      if (type === 'application') {
        data.application.extracted = null;
        data.application.tib = 0;
        data.application.industry = '';
      } else if (type === 'bank') {
        data.bank.accounts = {};
        data.bank.months = [];
        data.bank.largeTransactions = [];
        data.bank.debts = [];
        data.bank.transactions = [];
        data.bank.insights = {};
      } else if (type === 'credit') {
        data.credit.extracted = null;
      } else if (type === 'background') {
        data.background.research = {};
        data.background.checks = {};
        data.background.reviews = {};
        data.background.social = {};
        data.background.footprint = {};
        data.background.debt = { positions: [], uccFilings: [] };
      }
      
      processingState[type].complete = false;
      
      // Re-process all files
      const files = data[type].files;
      const previews = data[type].previews;
      setProcessingState(type, 'processing', files.length, files.length);
      
      for (let i = 0; i < files.length; i++) {
        // Add delay between files to prevent rate limiting (except for first file)
        if (i > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        setProcessingState(type, 'processing', files.length - i, files.length);
        try {
          const mimeType = files[i].type || 'application/pdf';
          const imageData = [{ data: previews[i].split(',')[1], mimeType }];
          
          switch (type) {
            case 'application': await processApplication(imageData); break;
            case 'bank': await processBank(imageData); break;
            case 'credit': await processCredit(imageData); break;
            case 'background': await processBackground(imageData); break;
          }
        } catch (e) {
          console.error(`Error reprocessing ${type}:`, e);
        }
      }
      
      setProcessingState(type, 'complete');
      showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} reprocessed`, 'success');
    }

    function updateBadge(type, count) {
      const badge = document.getElementById('badge' + type.charAt(0).toUpperCase() + type.slice(1));
      if (badge) { badge.textContent = count; badge.style.display = count > 0 ? 'inline' : 'none'; }
      
      // Also update section status
      updateSectionStatus(type);
    }

    function addThumbnail(type, file, preview, thumbId) {
      const containers = [`${type}Thumbnails`, 'allThumbnails'];
      const isPdf = file.name.toLowerCase().endsWith('.pdf');
      
      containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const thumb = document.createElement('div');
        thumb.className = 'doc-thumb processing';
        thumb.id = thumbId + '-' + containerId;
        thumb.onclick = () => openImageModal(preview);
        
        if (isPdf) {
          thumb.innerHTML = `<div class="doc-thumb-pdf"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>${file.name}</span></div><div class="doc-thumb-label">${type.toUpperCase()}</div>`;
        } else {
          thumb.innerHTML = `<img src="${preview}" alt="${file.name}"><div class="doc-thumb-label">${type.toUpperCase()}</div>`;
        }
        container.appendChild(thumb);
      });
    }

    function finishThumbnail(thumbId, type) {
      [`${type}Thumbnails`, 'allThumbnails'].forEach(containerId => {
        const el = document.getElementById(thumbId + '-' + containerId);
        if (el) el.classList.remove('processing');
      });
    }

    function openImageModal(src) {
      document.getElementById('modalImage').src = src;
      document.getElementById('imageModal').classList.add('active');
    }

    function closeImageModal() { document.getElementById('imageModal').classList.remove('active'); }

    // BATCH UPLOAD - Send ALL files to Gemini at once for parallel extraction
    async function handleMainUpload(files) {
      if (!apiKey) { showToast('Enter API key first', 'error'); return; }
      if (!files.length) return;

      switchTab('other');
      
      const banner = document.getElementById('workflowProgressBanner');
      const stepEl = document.getElementById('workflowProgressStep');
      const detailEl = document.getElementById('workflowProgressDetail');
      const barEl = document.getElementById('workflowProgressBar');
      
      if (banner) banner.style.display = 'flex';
      
      const filesArray = Array.from(files);
      const totalFiles = filesArray.length;
      
      // STEP 1: Convert all files to base64 and add thumbnails
      if (stepEl) stepEl.textContent = 'Loading Documents';
      if (detailEl) detailEl.textContent = `${totalFiles} files...`;
      if (barEl) barEl.style.width = '5%';
      
      const allPreviews = [];
      const thumbIds = [];
      
      for (let i = 0; i < filesArray.length; i++) {
        const file = filesArray[i];
        const preview = await fileToBase64(file);
        const thumbId = 'thumb-' + Date.now() + '-' + Math.random().toString(36).substr(2,9);
        addThumbnail('other', file, preview, thumbId);
        allPreviews.push({ file, preview, thumbId, index: i });
        thumbIds.push(thumbId);
        
        // Store in 'other' initially
        data.other.files.push(file);
        data.other.previews.push(preview);
      }
      
      if (barEl) barEl.style.width = '10%';
      
      // STEP 2: Send ALL files to Gemini at once with batch extraction prompt
      if (stepEl) stepEl.textContent = 'Analyzing All Documents';
      if (detailEl) detailEl.textContent = `Processing ${totalFiles} files in batch...`;
      
      // Mark all as processing
      setProcessingState('application', 'processing', 1, 1);
      setProcessingState('bank', 'processing', 1, 1);
      setProcessingState('credit', 'processing', 1, 1);
      
      const batchPrompt = `You are analyzing ${totalFiles} document images for an MCA (Merchant Cash Advance) underwriting system.

STEP 1 - CLASSIFY EACH IMAGE:
Look at each image and classify it as one of:
- "application" = MCA application form, ISO application, merchant application
- "bank" = Bank statement (Chase, Wells Fargo, BOA, etc.)
- "credit" = Credit report (Experian, Equifax, TransUnion)
- "other" = Any other document

STEP 2 - EXTRACT DATA FROM EACH TYPE:

FOR APPLICATION DOCUMENTS - Extract:
- business.legalName, business.dba, business.address, business.city, business.state, business.zip
- business.phone, business.email, business.website, business.taxId, business.entityType
- business.startDate, business.industry
- owner.name, owner.title, owner.ownership, owner.ssn, owner.dob, owner.address
- owner.city, owner.state, owner.zip, owner.phone, owner.email
- request.amount, request.useOfFunds

FOR BANK STATEMENTS - Extract for EACH MONTH found:
- accountInfo: bankName, accountNumber, accountType, accountHolder
- For each month: monthKey (YYYY-MM), monthLabel, deposits (total), withdrawals (total)
- beginningBal, endingBal, avgDailyBal (CRITICAL - find "Average Daily Balance" on statement)
- excludedDeposits (lender deposits, transfers in, refunds)
- trueCredits = deposits - excludedDeposits
- excludedDebits (internal transfers, reversals)
- trueDebits = withdrawals - excludedDebits
- depositCount, nsfs, negatives
- Any MCA/lender payments found (lender name, payment amount, type)

FOR CREDIT REPORTS - Extract:
- score (FICO/credit score - usually 300-850 range), bureau (Experian/Equifax/TransUnion)
- summary: totalAccounts, openAccounts, closedAccounts, delinquentAccounts
- summary: totalDebt, utilization (percentage), inquiries, publicRecords, collections, derogatoryMarks
- tradelines: array of accounts with creditor, accountType, balance, limit, status, opened, payment

Return ONLY valid JSON in this exact structure:
{
  "classifications": [
    {"imageIndex": 0, "type": "application"},
    {"imageIndex": 1, "type": "bank"},
    {"imageIndex": 2, "type": "bank"},
    {"imageIndex": 3, "type": "credit"}
  ],
  "application": {
    "business": {
      "legalName": "",
      "dba": "",
      "address": "",
      "city": "",
      "state": "",
      "zip": "",
      "phone": "",
      "email": "",
      "website": "",
      "taxId": "",
      "entityType": "LLC|Corp|Partnership|Sole Prop",
      "startDate": "MM/DD/YYYY or YYYY",
      "dateEstablished": "MM/DD/YYYY or YYYY",
      "industry": ""
    },
    "owner": {
      "name": "",
      "title": "",
      "ownership": 0,
      "ssn": "",
      "dob": "",
      "address": "",
      "city": "",
      "state": "",
      "zip": "",
      "phone": "",
      "email": ""
    },
    "request": {"amount": 0, "useOfFunds": ""}
  },
  "bank": {
    "accountInfo": {"bankName": "", "accountNumber": "", "accountType": "", "accountHolder": ""},
    "months": [
      {"monthKey": "2024-10", "monthLabel": "Oct 2024", "deposits": 0, "withdrawals": 0, "excludedDeposits": 0, "excludedDebits": 0, "trueCredits": 0, "trueDebits": 0, "beginningBal": 0, "endingBal": 0, "avgDailyBal": 0, "depositCount": 0, "nsfs": 0, "negatives": 0}
    ],
    "debts": [{"lender": "", "type": "", "monthlyPayment": 0}],
    "excludedItems": [
      {"date": "2024-10-15", "amount": 50000, "description": "WIRE FROM BLUEVINE CAPITAL", "reason": "MCA Funding"}
    ]
  },
  "credit": {
    "score": 650,
    "bureau": "Experian",
    "summary": {
      "totalAccounts": 0,
      "openAccounts": 0,
      "totalDebt": 0,
      "utilization": 0,
      "inquiries": 0,
      "derogatoryMarks": 0,
      "collections": 0,
      "publicRecords": 0
    },
    "tradelines": [{"creditor": "", "accountType": "", "balance": 0, "limit": 0, "status": "current", "payment": 0, "opened": ""}],
    "publicRecords": [{"type": "", "date": "", "amount": 0, "court": ""}],
    "collections": [{"creditor": "", "balance": 0, "date": "", "status": ""}],
    "insights": {
      "paymentHistory": "",
      "creditMix": "",
      "riskFactors": ""
    }
  }
}

IMPORTANT:
- Image indices are 0-based (first image is 0)
- Combine data from multiple bank statements into one months array
- Extract EXACT numbers from statements - preserve cents
- If avgDailyBal not shown, calculate: (beginningBal + endingBal) / 2
- Calculate trueCredits and trueDebits for each month
- List ALL excluded deposits (MCA funding, transfers, refunds) in excludedItems array
- For credit score, extract the actual FICO score number (usually 300-850)
- For application, look for business start date or date established`;

      try {
        // Build parts array with all images
        const parts = [{ text: batchPrompt }];
        for (const { preview, file } of allPreviews) {
          const mimeType = file.type || 'application/pdf';
          const base64Data = preview.split(',')[1];
          parts.push({ inline_data: { mime_type: mimeType, data: base64Data } });
        }
        
        // Progress animation
        let progress = 15;
        const progressInterval = setInterval(() => {
          progress += 3;
          if (progress < 75 && barEl) barEl.style.width = `${progress}%`;
        }, 800);
        
        // Single API call with all files
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts }],
            generationConfig: { temperature: 0.1, maxOutputTokens: 32000 }
          })
        });
        
        clearInterval(progressInterval);
        if (barEl) barEl.style.width = '75%';
        
        const result = await response.json();
        
        if (result.error) {
          console.error('Batch API error:', result.error);
          showToast('API Error: ' + result.error.message, 'error');
          // Fallback to sequential processing
          await handleMainUploadFallback(filesArray, allPreviews, thumbIds);
          return;
        }
        
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
        console.log('Batch response length:', text.length);
        console.log('Batch response preview:', text.substring(0, 1000));
        
        const parsed = parseJSON(text);
        if (!parsed) {
          console.error('Could not parse batch response');
          console.log('Raw text:', text);
          await handleMainUploadFallback(filesArray, allPreviews, thumbIds);
          return;
        }
        
        console.log('Parsed keys:', Object.keys(parsed));
        console.log('Classifications:', parsed.classifications);
        console.log('Has application:', !!parsed.application, parsed.application ? Object.keys(parsed.application) : []);
        console.log('Has bank:', !!parsed.bank, parsed.bank ? Object.keys(parsed.bank) : []);
        console.log('Has credit:', !!parsed.credit, parsed.credit ? Object.keys(parsed.credit) : []);
        
        // STEP 3: Process classifications and update thumbnails
        if (stepEl) stepEl.textContent = 'Processing Results';
        if (detailEl) detailEl.textContent = 'Organizing extracted data...';
        
        // Update file classifications
        const classifications = parsed.classifications || [];
        for (const c of classifications) {
          const idx = c.imageIndex;
          const type = c.type || 'other';
          if (idx >= 0 && idx < allPreviews.length && type !== 'other') {
            const { file, preview, thumbId } = allPreviews[idx];
            
            // Move from 'other' to correct type
            data[type].files.push(file);
            data[type].previews.push(preview);
            updateBadge(type, data[type].files.length);
            
            // Update thumbnail
            const thumbEl = document.getElementById(thumbId + '-allThumbnails');
            if (thumbEl) thumbEl.querySelector('.doc-thumb-label').textContent = type.toUpperCase();
            finishThumbnail(thumbId, type);
          }
        }
        
        // STEP 4: Populate extracted data
        if (barEl) barEl.style.width = '85%';
        
        // Application data
        if (parsed.application) {
          console.log('Application data found:', JSON.stringify(parsed.application).substring(0, 500));
          // Normalize startDate to dateEstablished
          if (parsed.application.business?.startDate && !parsed.application.business?.dateEstablished) {
            parsed.application.business.dateEstablished = parsed.application.business.startDate;
          }
          data.application.extracted = parsed.application;
          
          // Calculate TIB from date established
          const dateEst = parsed.application.business?.dateEstablished || parsed.application.business?.startDate;
          if (dateEst) {
            data.application.tib = calculateTIB(dateEst);
            console.log('Calculated TIB:', data.application.tib, 'from date:', dateEst);
          }
          
          renderApplicationResults();
          setProcessingState('application', 'complete');
          showToast('Application extracted', 'success');
        } else {
          console.log('No application data in batch response');
          // Don't mark as complete if no app files
          if (data.application.files.length === 0) {
            // Leave status as-is
          } else {
            setProcessingState('application', 'complete');
          }
        }
        
        // Bank data
        if (parsed.bank && (parsed.bank.months?.length > 0 || parsed.bank.accountInfo)) {
          console.log('Bank data found:', JSON.stringify(parsed.bank).substring(0, 500));
          if (parsed.bank.accountInfo) mergeAccountInfo(parsed.bank.accountInfo);
          if (parsed.bank.months?.length > 0) {
            // Ensure math is correct
            parsed.bank.months.forEach(m => {
              const dep = parseFloat(m.deposits) || 0;
              const excDep = parseFloat(m.excludedDeposits) || 0;
              const wdr = parseFloat(m.withdrawals) || 0;
              const excDeb = parseFloat(m.excludedDebits) || 0;
              if (!m.trueCredits) m.trueCredits = dep - excDep;
              if (!m.trueDebits) m.trueDebits = wdr - excDeb;
              if (!m.avgDailyBal && m.endingBal) m.avgDailyBal = m.endingBal;
            });
            mergeMonths(parsed.bank.months, parsed.bank.accountInfo?.accountNumber);
          }
          if (parsed.bank.debts?.length > 0) mergeDebts(parsed.bank.debts);
          // Store excluded items
          if (parsed.bank.excludedItems?.length > 0) {
            parsed.bank.excludedItems.forEach(item => {
              if (!data.bank.excludedDeposits.some(x => x.date === item.date && Math.abs(x.amount - item.amount) < 1)) {
                data.bank.excludedDeposits.push(item);
              }
            });
          }
          renderBankResults();
          setProcessingState('bank', 'complete');
          showToast(`Bank: ${parsed.bank.months?.length || 0} months`, 'success');
        } else {
          console.log('No bank data in batch response');
          // Don't mark as complete if no bank files
          if (data.bank.files.length === 0) {
            // Leave status as-is
          } else {
            setProcessingState('bank', 'complete');
          }
        }
        
        // Credit data
        const hasCreditData = parsed.credit && (
          parsed.credit.score > 0 || 
          parsed.credit.tradelines?.length > 0 || 
          parsed.credit.summary?.totalAccounts > 0
        );
        
        if (hasCreditData) {
          console.log('Credit data found:', JSON.stringify(parsed.credit).substring(0, 500));
          data.credit.extracted = parsed.credit;
          renderCreditResults();
          setProcessingState('credit', 'complete');
          showToast('Credit report extracted', 'success');
        } else {
          console.log('No credit data in batch response. parsed.credit:', parsed.credit);
          // Don't mark as complete if no credit files were uploaded
          if (data.credit.files.length === 0) {
            // Leave status as-is (no files)
          } else {
            setProcessingState('credit', 'complete');
          }
        }
        
        // Update summaries
        updateProfileSummary();
        updateProfileTab();
        
        // STEP 5: Run Background/Deep Research
        if (barEl) barEl.style.width = '90%';
        if (stepEl) stepEl.textContent = 'Running Deep Research';
        
        const bizName = parsed.application?.business?.legalName || 
                       parsed.application?.business?.dba ||
                       document.getElementById('appBusinessName')?.value;
        const bizState = parsed.application?.business?.state || '';
        
        console.log('Deep Research - Business Name:', bizName, 'State:', bizState);
        
        if (bizName) {
          setProcessingState('background', 'processing', 1, 1);
          if (detailEl) detailEl.textContent = `Searching for ${bizName}...`;
          try {
            await runDeepResearch(bizName, bizState);
          } catch (e) {
            console.warn('Research error:', e);
            showToast('Research partially complete', 'warning');
          }
        } else {
          console.log('No business name found for deep research');
          showToast('No business name found for research', 'warning');
        }
        setProcessingState('background', 'complete');
        
        // STEP 6: Auto-run Engine
        if (barEl) barEl.style.width = '95%';
        if (stepEl) stepEl.textContent = 'Running Ables Engine';
        if (detailEl) detailEl.textContent = 'Calculating approvals...';
        
        populateEngineInputs();
        await new Promise(r => setTimeout(r, 300));
        runUnderwriting();
        
        if (barEl) barEl.style.width = '100%';
        
        // Done
        setTimeout(() => {
          if (banner) banner.style.display = 'none';
          switchTab('engine');
          showCompletionFlash('Analysis complete!');
        }, 1000);
        
      } catch (e) {
        console.error('Batch processing error:', e);
        showToast('Error: ' + e.message, 'error');
        // Fallback
        await handleMainUploadFallback(filesArray, allPreviews, thumbIds);
      }
    }
    
    // Fallback to sequential processing if batch fails
    async function handleMainUploadFallback(filesArray, allPreviews, thumbIds) {
      console.log('Using fallback sequential processing...');
      
      const banner = document.getElementById('workflowProgressBanner');
      const stepEl = document.getElementById('workflowProgressStep');
      const detailEl = document.getElementById('workflowProgressDetail');
      const barEl = document.getElementById('workflowProgressBar');
      
      if (stepEl) stepEl.textContent = 'Processing Sequentially';
      
      for (let i = 0; i < allPreviews.length; i++) {
        const { file, preview, thumbId } = allPreviews[i];
        if (detailEl) detailEl.textContent = `File ${i + 1} of ${allPreviews.length}...`;
        if (barEl) barEl.style.width = `${20 + (i / allPreviews.length) * 60}%`;
        
        try {
          // Classify
          const docType = await classifyDocument(file, preview);
          
          // Move to correct type
          if (docType !== 'other') {
            data[docType].files.push(file);
            data[docType].previews.push(preview);
            updateBadge(docType, data[docType].files.length);
          }
          
          // Update thumbnail
          const thumbEl = document.getElementById(thumbId + '-allThumbnails');
          if (thumbEl) thumbEl.querySelector('.doc-thumb-label').textContent = docType.toUpperCase();
          
          // Process
          await processFileForType(file, preview, docType);
          finishThumbnail(thumbId, docType);
          
          // Small delay
          if (i < allPreviews.length - 1) await new Promise(r => setTimeout(r, 1000));
          
        } catch (e) {
          console.error('Fallback error:', e);
        }
      }
      
      // Mark complete
      setProcessingState('application', 'complete');
      setProcessingState('bank', 'complete');
      setProcessingState('credit', 'complete');
      setProcessingState('background', 'complete');
      
      // Run engine
      populateEngineInputs();
      runUnderwriting();
      
      if (barEl) barEl.style.width = '100%';
      setTimeout(() => {
        if (banner) banner.style.display = 'none';
        switchTab('engine');
      }, 1000);
    }

    async function processFileAsync(file) {
      const thumbId = 'thumb-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      updateProcessingCount(1);
      
      try {
        const preview = await fileToBase64(file);
        
        // Show thumbnail immediately as processing
        addThumbnail('other', file, preview, thumbId); // Temporary type
        
        // Classify document
        const docType = await classifyDocument(file, preview);
        
        // Update thumbnail with correct type
        [`otherThumbnails`, 'allThumbnails'].forEach(c => {
          const el = document.getElementById(thumbId + '-' + c);
          if (el) {
            el.querySelector('.doc-thumb-label').textContent = docType.toUpperCase();
            // Move to correct container if needed
            if (c === 'otherThumbnails' && docType !== 'other') {
              el.remove();
              const correctContainer = document.getElementById(docType + 'Thumbnails');
              if (correctContainer) {
                el.id = thumbId + '-' + docType + 'Thumbnails';
                correctContainer.appendChild(el);
              }
            }
          }
        });
        
        data[docType].files.push(file);
        data[docType].previews.push(preview);
        updateBadge(docType, data[docType].files.length);
        
        // Mark this document type as processing (shows spinner on workflow tab)
        if (docType !== 'other') {
          setProcessingState(docType, 'processing', 1, 1);
        }
        
        // Small delay between classify and process to prevent rate limiting
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Process file for its type
        await processFileForType(file, preview, docType);
        
        // Mark this document type as complete (turns workflow tab green)
        if (docType !== 'other') {
          setProcessingState(docType, 'complete');
        }
        
        finishThumbnail(thumbId, docType);
        
        // Show toast for each completed file
        showToast(`${docType.charAt(0).toUpperCase() + docType.slice(1)}: ${file.name.substring(0, 20)}...`, 'success');
        
      } catch (err) {
        console.error(err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        updateProcessingCount(-1);
      }
    }

    async function handleTypedUpload(files, type) {
      if (!apiKey) { showToast('Enter API key first', 'error'); return; }
      if (!files.length) return;

      // Check max upload limit of 12 documents total
      const MAX_DOCUMENTS = 12;
      const totalDocs = data.application.files.length + data.bank.files.length + 
                        data.credit.files.length + data.background.files.length;
      const filesArray = Array.from(files);
      
      if (totalDocs + filesArray.length > MAX_DOCUMENTS) {
        const remaining = MAX_DOCUMENTS - totalDocs;
        if (remaining <= 0) {
          showToast(`Maximum ${MAX_DOCUMENTS} documents allowed. Please remove some files first.`, 'error');
          return;
        }
        showToast(`Only ${remaining} more document(s) can be uploaded. Max ${MAX_DOCUMENTS} total.`, 'error');
        filesArray.splice(remaining); // Only process up to the limit
        if (filesArray.length === 0) return;
      }
      const currentTotal = processingState[type].filesTotal + filesArray.length;
      const currentProcessing = processingState[type].filesProcessing + filesArray.length;
      
      setProcessingState(type, 'processing', currentProcessing, currentTotal);
      
      for (let i = 0; i < filesArray.length; i++) {
        // Add delay between files to prevent rate limiting (except for first file)
        if (i > 0) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        await processTypedFileAsync(filesArray[i], type);
      }
      
      setProcessingState(type, 'complete');
      
      // Auto-run next steps after processing completes (with delay to prevent rate limiting)
      setTimeout(() => {
        triggerAutoWorkflow(type);
      }, 2500);
    }

    // Auto-workflow: run tabs in linear order
    // Order: Application  Bank  Credit  Background  Engine  Review
    function triggerAutoWorkflow(completedType) {
      console.log('Triggering auto-workflow after:', completedType);
      
      const TAB_ORDER = ['application', 'bank', 'credit', 'background', 'engine', 'review'];
      const currentIndex = TAB_ORDER.indexOf(completedType);
      
      if (currentIndex === -1) return;
      
      // Determine next step based on what just completed
      setTimeout(() => {
        if (completedType === 'application') {
          // After application, switch to bank tab
          switchTab('bank');
        } else if (completedType === 'bank') {
          // After bank, switch to credit tab
          switchTab('credit');
        } else if (completedType === 'credit') {
          // After credit, switch to background tab
          switchTab('background');
        } else if (completedType === 'background') {
          // After background, check if we can run engine
          autoRunNextStep();
        }
      }, 500);
    }

    async function processTypedFileAsync(file, type) {
      const thumbId = 'thumb-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      updateProcessingCount(1);
      
      try {
        const preview = await fileToBase64(file);
        addThumbnail(type, file, preview, thumbId);
        
        data[type].files.push(file);
        data[type].previews.push(preview);
        updateBadge(type, data[type].files.length);
        
        await processFileForType(file, preview, type);
        finishThumbnail(thumbId, type);
        
        // Update processing count
        if (processingState[type].filesProcessing > 0) {
          setProcessingState(type, 'processing', processingState[type].filesProcessing - 1, processingState[type].filesTotal);
        }
        
      } catch (err) {
        console.error(err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        updateProcessingCount(-1);
      }
    }

    async function classifyDocument(file, preview) {
      const prompt = `Classify this document into ONE category. Respond with ONLY the category name:
application, bank, credit, background, other`;
      const mimeType = file.type || 'application/pdf';
      const response = await callGemini(prompt, [{ data: preview.split(',')[1], mimeType }], 50);
      const text = response.toLowerCase().trim();
      if (text.includes('application')) return 'application';
      if (text.includes('bank')) return 'bank';
      if (text.includes('credit')) return 'credit';
      if (text.includes('background')) return 'background';
      return 'other';
    }

    async function processFileForType(file, preview, type) {
      const mimeType = file.type || 'application/pdf';
      const imageData = [{ data: preview.split(',')[1], mimeType }];

      switch (type) {
        case 'application': await processApplication(imageData); break;
        case 'bank': await processBank(imageData); break;
        case 'credit': await processCredit(imageData); break;
        case 'background': await processBackground(imageData); break;
        case 'other': await processOther(imageData, file.name); break;
      }
    }

    async function processApplication(images) {
      const prompt = `Extract ALL information from this business funding application. Return ONLY valid JSON:
{
  "business": {
    "legalName": "",
    "dba": "",
    "address": "",
    "city": "",
    "state": "",
    "zip": "",
    "phone": "",
    "email": "",
    "website": "",
    "entityType": "",
    "stateOfIncorporation": "",
    "dateEstablished": "",
    "industry": "",
    "naicsCode": "",
    "taxId": "",
    "annualRevenue": 0,
    "monthlyRevenue": 0,
    "numberOfEmployees": 0
  },
  "owner": {
    "name": "",
    "title": "",
    "ownership": "",
    "ssn": "",
    "dob": "",
    "address": "",
    "city": "",
    "state": "",
    "zip": "",
    "phone": "",
    "email": "",
    "driversLicense": "",
    "creditScore": 0
  },
  "funding": {
    "amountRequested": 0,
    "useOfFunds": "",
    "urgency": "",
    "preferredTerms": ""
  },
  "bank": {
    "bankName": "",
    "routingNumber": "",
    "accountNumber": "",
    "accountType": "",
    "averageBalance": 0
  },
  "additional": {
    "landlordName": "",
    "monthlyRent": 0,
    "hasExistingLoans": false,
    "existingLoanDetails": "",
    "bankruptcyHistory": "",
    "criminalHistory": "",
    "references": ""
  }
}
Extract every field you can find. Use 0 for missing numbers, "" for missing text.`;
      const result = await callGemini(prompt, images);
      if (result) {
        try {
          const parsed = parseJSON(result);
          if (!parsed) {
            console.error('Could not parse application JSON:', result.substring(0, 200));
            showToast('Could not parse application data', 'error');
            return;
          }
          
          // Initialize extracted if null
          if (!data.application.extracted) {
            data.application.extracted = { business: {}, owner: {}, funding: {}, bank: {}, additional: {} };
          }
          
          // Merge each section
          if (parsed.business) data.application.extracted.business = { ...data.application.extracted.business, ...parsed.business };
          if (parsed.owner) data.application.extracted.owner = { ...data.application.extracted.owner, ...parsed.owner };
          if (parsed.funding) data.application.extracted.funding = { ...data.application.extracted.funding, ...parsed.funding };
          if (parsed.bank) data.application.extracted.bank = { ...data.application.extracted.bank, ...parsed.bank };
          if (parsed.additional) data.application.extracted.additional = { ...data.application.extracted.additional, ...parsed.additional };
          
          data.application.tib = calculateTIB(parsed.business?.dateEstablished);
          data.application.industry = parsed.business?.industry;
          renderApplicationResults();
          updateProfileTab();
        } catch (e) { 
          console.error('Application parse error:', e, result.substring(0, 500));
          showToast('Error parsing application: ' + e.message, 'error');
        }
      }
    }

    function calculateTIB(dateStr) {
      if (!dateStr) return 0;
      try {
        const est = new Date(dateStr);
        const now = new Date();
        return Math.floor((now - est) / (1000 * 60 * 60 * 24 * 30));
      } catch { return 0; }
    }

    function renderApplicationResults() {
      document.getElementById('applicationResults').classList.add('active');
      const d = data.application.extracted;
      if (!d) return;
      
      // Populate editable form fields
      populateAppForm(d);
      
      updateProfileSummary();
      
      // Deep research will be triggered during background processing phase
      // (moved from here to maintain ordered workflow: App  Bank  Credit  Background)
    }
    
    function populateAppForm(d) {
      // Business fields
      if (d.business) {
        setFormField('appBusinessName', d.business.legalName || d.business.businessName || d.business.name || '');
        setFormField('appDba', d.business.dba || d.business.tradeName || '');
        setFormField('appEntityType', d.business.entityType || d.business.type || '');
        setFormField('appState', d.business.stateOfIncorporation || d.business.state || '');
        setFormField('appEin', d.business.ein || d.business.taxId || d.business.federalTaxId || '');
        setFormField('appDateEstablished', d.business.dateEstablished || d.business.established || d.business.startDate || '');
        setFormField('appIndustry', d.business.industry || d.business.businessType || d.business.type || '');
        setFormField('appNaics', d.business.naicsCode || d.business.sicCode || d.business.naics || '');
        setFormField('appAddress', d.business.address || d.business.streetAddress || '');
        setFormField('appCity', d.business.city || '');
        setFormField('appAddressState', d.business.addressState || d.business.state || '');
        setFormField('appZip', d.business.zip || d.business.zipCode || d.business.postalCode || '');
        setFormField('appPhone', d.business.phone || d.business.businessPhone || '');
        setFormField('appWebsite', d.business.website || d.business.url || '');
        setFormField('appEmail', d.business.email || d.business.businessEmail || '');
      }
      
      // Owner fields
      if (d.owner) {
        setFormField('appOwnerName', d.owner.name || d.owner.ownerName || d.owner.fullName || '');
        setFormField('appOwnerTitle', d.owner.title || d.owner.position || '');
        setFormField('appOwnership', d.owner.ownershipPct || d.owner.ownership || d.owner.percentOwnership || '');
        setFormField('appDob', d.owner.dob || d.owner.dateOfBirth || d.owner.birthDate || '');
        setFormField('appSsn', d.owner.ssn || d.owner.socialSecurity || '');
        setFormField('appDriversLicense', d.owner.driversLicense || d.owner.dl || d.owner.licenseNumber || '');
        setFormField('appHomeAddress', d.owner.homeAddress || d.owner.address || '');
        setFormField('appHomeCity', d.owner.homeCity || d.owner.city || '');
        setFormField('appHomeState', d.owner.homeState || d.owner.state || '');
        setFormField('appHomeZip', d.owner.homeZip || d.owner.zip || '');
        setFormField('appMobile', d.owner.mobile || d.owner.phone || d.owner.cellPhone || '');
        setFormField('appOwnerEmail', d.owner.email || d.owner.personalEmail || '');
        setFormField('appCreditScore', d.owner.creditScore || d.owner.fico || '');
      }
      
      // Funding fields
      if (d.funding) {
        setFormField('appAmountRequested', formatCurrencyInput(d.funding.amountRequested || d.funding.amount || d.funding.requestedAmount || ''));
        setFormField('appUseOfFunds', d.funding.useOfFunds || d.funding.purpose || '');
        setFormField('appMonthlyRevenue', formatCurrencyInput(d.funding.monthlyRevenue || d.funding.monthlyGross || ''));
        setFormField('appAnnualRevenue', formatCurrencyInput(d.funding.annualRevenue || d.funding.annualGross || ''));
      }
      
      // Bank fields
      if (d.bank) {
        setFormField('appBankName', d.bank.bankName || d.bank.name || '');
        setFormField('appAccountNumber', d.bank.accountNumber || d.bank.account || '');
        setFormField('appRoutingNumber', d.bank.routingNumber || d.bank.routing || d.bank.aba || '');
        setFormField('appAvgBalance', formatCurrencyInput(d.bank.avgBalance || d.bank.averageBalance || ''));
      }
      
      // Additional fields
      if (d.additional) {
        setFormField('appExistingDebt', d.additional.existingDebt || d.additional.mcaPositions || '');
        setFormField('appBalanceOwed', formatCurrencyInput(d.additional.balanceOwed || d.additional.currentBalance || ''));
        setFormField('appBankruptcy', d.additional.bankruptcy || '');
        setFormField('appLandlord', d.additional.landlord || d.additional.propertyOwner || '');
        setFormField('appMonthlyRent', formatCurrencyInput(d.additional.monthlyRent || d.additional.rent || ''));
        setFormField('appEmployees', d.additional.employees || d.additional.employeeCount || '');
      }
    }
    
    function setFormField(id, value) {
      const el = document.getElementById(id);
      if (el && value) {
        const oldValue = el.value;
        el.value = String(value).trim();
        el.parentElement?.classList.add('has-value');
        
        // Add animation if value changed
        if (oldValue !== el.value) {
          el.classList.add('field-populated');
          setTimeout(() => el.classList.remove('field-populated'), 1500);
        }
      }
    }
    
    // Animate a field with visible flash effect
    function animateField(el, value) {
      if (!el || !value) return;
      const oldValue = el.value;
      el.value = value;
      
      if (oldValue !== value) {
        el.classList.add('field-populated');
        el.style.transform = 'scale(1.02)';
        setTimeout(() => {
          el.style.transform = '';
          el.classList.remove('field-populated');
        }, 1500);
      }
    }
    
    // Show completion flash message
    function showCompletionFlash(message) {
      document.querySelectorAll('.completion-flash').forEach(el => el.remove());
      
      const flash = document.createElement('div');
      flash.className = 'completion-flash';
      flash.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
        <span>${message}</span>
      `;
      document.body.appendChild(flash);
      
      setTimeout(() => flash.remove(), 3000);
    }
    
    function formatCurrencyInput(val) {
      if (!val) return '';
      const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
      if (isNaN(num)) return val;
      return '$' + num.toLocaleString();
    }
    
    function updateAppField(input) {
      const field = input.dataset.field;
      const value = input.value.trim();
      
      // Update has-value class
      if (value) {
        input.parentElement?.classList.add('has-value');
      } else {
        input.parentElement?.classList.remove('has-value');
      }
      
      // Store in data.application.extracted for other functions to use
      if (!data.application.extracted) {
        data.application.extracted = { business: {}, owner: {}, funding: {}, bank: {}, additional: {} };
      }
      
      // Map field to correct section
      const businessFields = ['businessName', 'dba', 'entityType', 'state', 'ein', 'dateEstablished', 'industry', 'naicsCode', 'address', 'city', 'addressState', 'zip', 'phone', 'website', 'email'];
      const ownerFields = ['ownerName', 'ownerTitle', 'ownershipPct', 'dob', 'ssn', 'driversLicense', 'homeAddress', 'homeCity', 'homeState', 'homeZip', 'mobile', 'ownerEmail', 'creditScore'];
      const fundingFields = ['amountRequested', 'useOfFunds', 'monthlyRevenue', 'annualRevenue'];
      const bankFields = ['bankName', 'accountNumber', 'routingNumber', 'avgBalance'];
      const additionalFields = ['existingDebt', 'balanceOwed', 'bankruptcy', 'landlord', 'monthlyRent', 'employees'];
      
      if (businessFields.includes(field)) {
        if (!data.application.extracted.business) data.application.extracted.business = {};
        data.application.extracted.business[field] = value;
      } else if (ownerFields.includes(field)) {
        if (!data.application.extracted.owner) data.application.extracted.owner = {};
        data.application.extracted.owner[field] = value;
      } else if (fundingFields.includes(field)) {
        if (!data.application.extracted.funding) data.application.extracted.funding = {};
        data.application.extracted.funding[field] = value;
      } else if (bankFields.includes(field)) {
        if (!data.application.extracted.bank) data.application.extracted.bank = {};
        data.application.extracted.bank[field] = value;
      } else if (additionalFields.includes(field)) {
        if (!data.application.extracted.additional) data.application.extracted.additional = {};
        data.application.extracted.additional[field] = value;
      }
      
      // Update profile summary bar
      updateProfileSummary();
      updateProfileTab();
    }
    
    async function processBank(images) {
      const prompt = `Analyze this bank statement. Extract EXACT numbers from the statement summary.

CRITICAL - EXACT NUMERICAL ACCURACY:
* deposits = EXACT "Total Credits" or "Total Deposits" from statement summary (raw total)
* withdrawals = EXACT "Total Debits" or "Total Withdrawals" from statement summary (raw total)
* beginningBal = EXACT "Beginning Balance" or "Opening Balance" from statement
* endingBal = EXACT "Ending Balance" or "Closing Balance" from statement
* avgDailyBal = EXACT "Average Daily Balance" or "Average Ledger Balance" - THIS IS CRITICAL, find and extract this value
* Copy numbers exactly as shown - preserve cents (e.g., $45,231.87 not $45,232)

NOTE: If Average Daily Balance is not explicitly shown, calculate it as: (beginningBal + endingBal) / 2

MATH FOR TRUE VALUES - YOU MUST CALCULATE:
* excludedDeposits = SUM of: lender/MCA deposits + internal transfers IN + returned items credited + refunds
* trueCredits = deposits - excludedDeposits (this is actual business revenue)
* excludedDebits = SUM of: internal transfers OUT + reversed transactions
* trueDebits = withdrawals - excludedDebits (this is actual business expenses)

WHAT TO EXCLUDE FROM DEPOSITS (count towards excludedDeposits):
- Lender deposits: "WIRE FROM [LENDER]", MCA funding, large round deposits ($50,000, $100,000)
- Internal transfers: "TRANSFER FROM SAVINGS", "MOBILE DEPOSIT" from same bank
- Returns/refunds: "RETURNED ITEM", "CHARGEBACK CREDIT", "REFUND"

WHAT TO EXCLUDE FROM DEBITS (count towards excludedDebits):
- Internal transfers: "TRANSFER TO SAVINGS", same-bank transfers
- Reversals: "REVERSAL", "CORRECTION"

IMPORTANT: For each excluded deposit, add it to the excludedItems array with date, description, amount, and reason.

Extract all data and return valid JSON.`;

      // Define the response schema for structured output
      const bankSchema = {
        type: "object",
        properties: {
          accountInfo: {
            type: "object",
            properties: {
              bankName: { type: "string" },
              accountNumber: { type: "string" },
              accountType: { type: "string" },
              accountHolder: { type: "string" }
            }
          },
          months: {
            type: "array",
            items: {
              type: "object",
              properties: {
                monthKey: { type: "string" },
                monthLabel: { type: "string" },
                deposits: { type: "number", description: "Raw Total Deposits from statement" },
                withdrawals: { type: "number", description: "Raw Total Withdrawals from statement" },
                excludedDeposits: { type: "number", description: "Lender deposits + transfers + returns to exclude" },
                excludedDebits: { type: "number", description: "Internal transfers + reversals to exclude" },
                trueCredits: { type: "number", description: "deposits - excludedDeposits = actual revenue" },
                trueDebits: { type: "number", description: "withdrawals - excludedDebits = actual expenses" },
                beginningBal: { type: "number", description: "Beginning/Opening Balance for the month" },
                endingBal: { type: "number", description: "Ending/Closing Balance for the month" },
                avgDailyBal: { type: "number", description: "Average Daily Balance - CRITICAL: extract this exact value from statement" },
                depositCount: { type: "number" },
                nsfs: { type: "number" },
                negatives: { type: "number" },
                debtService: { type: "number" }
              },
              required: ["monthKey", "monthLabel", "deposits", "withdrawals", "endingBal", "avgDailyBal", "trueCredits", "trueDebits"]
            }
          },
          debts: {
            type: "array",
            items: {
              type: "object",
              properties: {
                lender: { type: "string" },
                type: { type: "string" },
                monthlyPayment: { type: "number" },
                estimatedBalance: { type: "number" }
              }
            }
          },
          largeTransactions: {
            type: "array",
            items: {
              type: "object",
              properties: {
                date: { type: "string" },
                description: { type: "string" },
                amount: { type: "number" },
                type: { type: "string" }
              }
            }
          },
          excludedItems: {
            type: "array",
            description: "Individual deposits excluded from revenue (MCA funding, transfers, refunds)",
            items: {
              type: "object",
              properties: {
                date: { type: "string" },
                description: { type: "string" },
                amount: { type: "number" },
                reason: { type: "string", description: "Why excluded: MCA Funding, Transfer, Refund, Return" }
              }
            }
          }
        },
        required: ["accountInfo", "months"]
      };

      const apiKey = document.getElementById('apiKeyInput')?.value;
      if (!apiKey) {
        showToast('API key required', 'error');
        return;
      }
      
      try {
        // Build request with images
        const parts = [{ text: prompt }];
        for (const img of images) {
          parts.push({ inline_data: { mime_type: img.mimeType, data: img.data } });
        }

        // Use structured output with response schema
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts }],
            generationConfig: { 
              temperature: 0.1,
              responseMimeType: "application/json",
              responseSchema: bankSchema
            }
          })
        });

        const result = await response.json();
        
        if (result.error) {
          console.error('Bank API error:', result.error);
          // Fallback to regular call without schema
          console.log('Falling back to non-schema call...');
          await processBankFallback(images);
          return;
        }
        
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
        console.log('Bank API response (structured):', text.substring(0, 500));
        
        const parsed = parseJSON(text);
        if (!parsed) {
          console.error('Could not parse structured bank JSON');
          await processBankFallback(images);
          return;
        }

        console.log('Parsed bank data:', {
          hasAccountInfo: !!parsed.accountInfo,
          monthsCount: parsed.months?.length || 0,
          debtsCount: parsed.debts?.length || 0
        });

        // Merge data
        if (parsed.accountInfo) mergeAccountInfo(parsed.accountInfo);
        if (parsed.months && parsed.months.length > 0) {
          mergeMonths(parsed.months, parsed.accountInfo?.accountNumber);
          console.log('Merged months, total now:', data.bank.months.length);
        }
        if (parsed.largeTransactions && parsed.largeTransactions.length > 0) {
          mergeLargeTxns(parsed.largeTransactions);
        }
        if (parsed.debts && parsed.debts.length > 0) {
          mergeDebts(parsed.debts);
        }
        // Store excluded items
        if (parsed.excludedItems && parsed.excludedItems.length > 0) {
          parsed.excludedItems.forEach(item => {
            if (!data.bank.excludedDeposits.some(x => x.date === item.date && Math.abs(x.amount - item.amount) < 1)) {
              data.bank.excludedDeposits.push(item);
            }
          });
        }

        // Render results
        renderBankResults();
        updateProfileSummary();
        updateProfileTab();

        // Show success message with true revenue
        const monthsAdded = parsed.months?.length || 0;
        const trueRevenue = parsed.months?.reduce((s, m) => s + (parseFloat(m.trueCredits) || parseFloat(m.deposits) || parseFloat(m.revenue) || 0), 0) || 0;
        showToast(`Bank: ${monthsAdded} month(s), ${formatCurrency(trueRevenue)} true revenue`, 'success');

      } catch (e) {
        console.error('Bank processing error:', e);
        // Try fallback
        await processBankFallback(images);
      }
    }

    // Fallback bank processing without structured schema
    async function processBankFallback(images) {
      const prompt = `Analyze this bank statement. Extract EXACT numbers from the statement summary.

CRITICAL FIELDS TO EXTRACT:
- deposits = Total Credits/Deposits from statement (raw total)
- withdrawals = Total Debits from statement (raw total)
- beginningBal = Beginning/Opening Balance
- endingBal = Ending/Closing Balance
- avgDailyBal = Average Daily Balance (IMPORTANT - find this on the statement, often near summary)

MATH REQUIRED:
- excludedDeposits = lender deposits + transfers + returns (items to exclude)
- trueCredits = deposits - excludedDeposits (actual business revenue)
- excludedDebits = internal transfers + reversals (items to exclude)
- trueDebits = withdrawals - excludedDebits (actual business expenses)

NOTE: If Average Daily Balance is not shown, calculate: (beginningBal + endingBal) / 2

Return ONLY valid JSON:
{
  "accountInfo": {"bankName": "", "accountNumber": "", "accountType": "", "accountHolder": ""},
  "months": [{"monthKey": "YYYY-MM", "monthLabel": "Mon YYYY", "deposits": 0, "withdrawals": 0, "excludedDeposits": 0, "excludedDebits": 0, "trueCredits": 0, "trueDebits": 0, "beginningBal": 0, "endingBal": 0, "avgDailyBal": 0, "depositCount": 0, "nsfs": 0, "negatives": 0, "debtService": 0}],
  "debts": [{"lender": "", "type": "", "monthlyPayment": 0, "estimatedBalance": 0}],
  "largeTransactions": [{"date": "", "description": "", "amount": 0, "type": "inflow|outflow"}]
}

Extract EXACT numbers from statement summaries. Calculate trueCredits and trueDebits.`;

      try {
        const result = await callGemini(prompt, images, 16000);
        if (result) {
          console.log('Bank fallback response:', result.substring(0, 500));
          const parsed = parseJSON(result);
          if (!parsed) {
            console.error('Could not parse bank JSON:', result.substring(0, 500));
            showToast('Could not parse bank statement data', 'error');
            return;
          }

          // Merge data
          if (parsed.accountInfo) mergeAccountInfo(parsed.accountInfo);
          if (parsed.months && parsed.months.length > 0) {
            // Ensure math is correct for each month
            parsed.months.forEach(m => {
              const dep = parseFloat(m.deposits) || parseFloat(m.revenue) || 0;
              const excDep = parseFloat(m.excludedDeposits) || 0;
              const wdr = parseFloat(m.withdrawals) || 0;
              const excDeb = parseFloat(m.excludedDebits) || 0;
              const beginBal = parseFloat(m.beginningBal) || 0;
              const endBal = parseFloat(m.endingBal) || 0;
              
              // Calculate if not provided
              if (!m.trueCredits) m.trueCredits = dep - excDep;
              if (!m.trueDebits) m.trueDebits = wdr - excDeb;
              if (!m.deposits) m.deposits = dep;
              // Calculate avgDailyBal if not provided
              if (!m.avgDailyBal || m.avgDailyBal === 0) {
                if (beginBal > 0 && endBal > 0) {
                  m.avgDailyBal = (beginBal + endBal) / 2;
                } else if (endBal > 0) {
                  m.avgDailyBal = endBal;
                }
              }
            });
            mergeMonths(parsed.months, parsed.accountInfo?.accountNumber);
          }
          if (parsed.largeTransactions && parsed.largeTransactions.length > 0) {
            mergeLargeTxns(parsed.largeTransactions);
          }
          if (parsed.debts && parsed.debts.length > 0) {
            mergeDebts(parsed.debts);
          }

          renderBankResults();
          updateProfileSummary();
          updateProfileTab();

          const monthsAdded = parsed.months?.length || 0;
          const trueRevenue = parsed.months?.reduce((s, m) => s + (parseFloat(m.trueCredits) || parseFloat(m.deposits) || 0), 0) || 0;
          showToast(`Bank: ${monthsAdded} month(s), ${formatCurrency(trueRevenue)} true revenue`, 'success');
        }
      } catch (e) {
        console.error('Bank fallback error:', e);
        showToast('Error processing bank statement: ' + e.message, 'error');
      }
    }

    function mergeAccountInfo(acctInfo) {
      if (!acctInfo.accountNumber) return;
      const last4 = acctInfo.accountNumber.slice(-4);
      if (!data.bank.accounts[last4]) {
        data.bank.accounts[last4] = {
          bankName: acctInfo.bankName,
          accountNumber: acctInfo.accountNumber,
          last4: last4,
          accountType: acctInfo.accountType,
          accountHolder: acctInfo.accountHolder,
          months: []
        };
      }
    }

    function mergeTransactions(newTxns, accountNumber) {
      const last4 = accountNumber ? accountNumber.slice(-4) : 'MAIN';
      for (const t of newTxns) {
        t.accountLast4 = last4;
        // Avoid duplicates by checking date+amount+description
        const isDupe = data.bank.transactions.some(x => 
          x.date === t.date && 
          Math.abs(x.amount - t.amount) < 0.01 && 
          x.description === t.description &&
          x.accountLast4 === last4
        );
        if (!isDupe) {
          data.bank.transactions.push(t);
        }
      }
      data.bank.transactions.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    }

    function mergeMonths(newMonths, accountNumber) {
      const last4 = accountNumber ? accountNumber.slice(-4) : 'MAIN';
      for (const m of newMonths) {
        m.accountLast4 = last4;
        
        // Calculate avgDailyBal fallback if not provided
        // If avgDailyBal is missing or 0, estimate from ending balance
        if (!m.avgDailyBal || m.avgDailyBal === 0) {
          // Best estimate: use ending balance, or average of deposits minus withdrawals
          if (m.endingBal && m.endingBal > 0) {
            m.avgDailyBal = m.endingBal;
          } else if (m.beginningBal && m.endingBal) {
            // Average of beginning and ending
            m.avgDailyBal = (m.beginningBal + m.endingBal) / 2;
          }
        }
        
        const existing = data.bank.months.find(x => x.monthKey === m.monthKey && x.accountLast4 === last4);
        if (existing) {
          // Only update if new value is non-zero or existing is zero
          Object.keys(m).forEach(k => {
            if (m[k] !== 0 && m[k] !== null && m[k] !== undefined) existing[k] = m[k];
          });
        } else {
          data.bank.months.push(m);
        }
        // Also add to account-specific months
        if (data.bank.accounts[last4]) {
          const acctExisting = data.bank.accounts[last4].months.find(x => x.monthKey === m.monthKey);
          if (acctExisting) {
            Object.keys(m).forEach(k => {
              if (m[k] !== 0 && m[k] !== null && m[k] !== undefined) acctExisting[k] = m[k];
            });
          } else {
            data.bank.accounts[last4].months.push({...m});
          }
          data.bank.accounts[last4].months.sort((a, b) => (a.monthKey || '').localeCompare(b.monthKey || ''));
        }
      }
      data.bank.months.sort((a, b) => (a.monthKey || '').localeCompare(b.monthKey || ''));
    }

    function mergeLargeTxns(txns) {
      for (const t of txns) {
        if (!data.bank.largeTransactions.some(x => x.date === t.date && Math.abs(x.amount - t.amount) < 1)) {
          data.bank.largeTransactions.push(t);
        }
      }
      data.bank.largeTransactions.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    }

    function mergeDebts(debts) {
      for (const d of debts) {
        const existing = data.bank.debts.find(x => x.lender?.toLowerCase() === d.lender?.toLowerCase());
        if (existing) Object.assign(existing, d);
        else data.bank.debts.push(d);
      }
    }

    function mergeExcludedDeposits(excluded) {
      for (const e of excluded) {
        // Avoid duplicates
        const isDupe = data.bank.excludedDeposits.some(x => 
          x.date === e.date && 
          Math.abs(x.amount - e.amount) < 0.01 && 
          x.description === e.description
        );
        if (!isDupe) {
          data.bank.excludedDeposits.push(e);
        }
      }
      data.bank.excludedDeposits.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    }

    function renderBankResults() {
      document.getElementById('bankResults').classList.add('active');
      const months = data.bank.months;
      if (!months.length) return;

      const count = months.length;
      const avg = (key) => months.reduce((s, m) => s + (parseFloat(m[key]) || 0), 0) / count;
      const total = (key) => months.reduce((s, m) => s + (parseFloat(m[key]) || 0), 0);
      
      // Calculate monthly debt payments
      const totalDebtPayments = data.bank.debts.reduce((s, d) => s + (parseFloat(d.monthlyPayment) || 0), 0);

      // Score calculation - use trueCredits for accurate revenue trend
      let score = 50;
      if (count >= 2) {
        const f = months.slice(0, Math.floor(count/2)).reduce((s, m) => s + (m.trueCredits || m.deposits || m.revenue || 0), 0) / Math.floor(count/2);
        const sec = months.slice(Math.floor(count/2)).reduce((s, m) => s + (m.trueCredits || m.deposits || m.revenue || 0), 0) / Math.ceil(count/2);
        if (sec > f * 1.1) score += 15;
        else if (sec < f * 0.9) score -= 10;
        else score += 5;
      }
      score -= Math.min(total('nsfs') * 5, 20);
      score -= Math.min(total('negatives') * 3, 15);
      score = Math.max(0, Math.min(100, Math.round(score)));

      let tier, color;
      if (score >= 80) { tier = 'Excellent'; color = '#6366f1'; }  // Indigo
      else if (score >= 65) { tier = 'Good'; color = '#8b5cf6'; }  // Purple
      else if (score >= 50) { tier = 'Fair'; color = '#a78bfa'; }  // Light purple
      else if (score >= 35) { tier = 'Caution'; color = '#c4b5fd'; }  // Lavender
      else { tier = 'High Risk'; color = '#ef4444'; }  // Red for risk

      document.getElementById('bankScoreRing').style.setProperty('--pct', score);
      document.getElementById('bankScoreRing').style.setProperty('--score-color', color);
      
      const scoreEl = document.getElementById('bankScore');
      const oldScore = scoreEl.textContent;
      scoreEl.textContent = score;
      scoreEl.style.color = color;
      if (oldScore !== String(score)) {
        scoreEl.classList.add('value-updating');
        setTimeout(() => scoreEl.classList.remove('value-updating'), 600);
      }
      
      document.getElementById('bankTier').textContent = tier;
      document.getElementById('bankTier').style.color = color;
      document.getElementById('bankSummary').textContent = `${count} months, ${formatCurrency(avg('trueCredits') || avg('deposits'))} avg true revenue`;

      // KPIs with animations
      updateKPI('kpiRevenue', avg('trueCredits') || avg('deposits'), 'currency');
      updateKPI('kpiExcluded', avg('excludedDeposits'), 'currency');
      updateKPI('kpiWithdrawals', avg('trueDebits') || avg('withdrawals'), 'currency');
      updateKPI('kpiAvgDaily', avg('avgDailyBal'), 'currency');
      updateKPI('kpiBalance', avg('endingBal'), 'currency');
      updateKPI('kpiDepCount', Math.round(avg('depositCount')));
      updateKPI('kpiDebt', totalDebtPayments, 'currency');
      updateKPI('kpiNsf', total('nsfs'));

      // Table with all deposit/debit columns - MATH SHOWN
      document.getElementById('bankTableBody').innerHTML = months.map((m, rowIdx) => {
        // Raw values from statement
        const totalDeposits = parseFloat(m.deposits) || parseFloat(m.revenue) || 0;
        const totalWithdrawals = parseFloat(m.withdrawals) || 0;
        
        // Excluded amounts
        const excludedDep = parseFloat(m.excludedDeposits) || 0;
        const excludedDeb = parseFloat(m.excludedDebits) || 0;
        
        // True values (calculated if not provided)
        const trueCredits = parseFloat(m.trueCredits) || (totalDeposits - excludedDep);
        const trueDebits = parseFloat(m.trueDebits) || (totalWithdrawals - excludedDeb);
        
        return `
        <tr class="clickable-row table-row-animate" onclick="showMonthTransactions('${m.monthKey}', '${m.monthLabel || m.monthKey}')" data-month="${m.monthKey}" style="animation-delay: ${rowIdx * 0.05}s;">
          <td>${m.monthLabel || m.monthKey} <span style="font-size:0.6rem;color:var(--text-muted);margin-left:4px;"></span></td>
          <td>${formatCurrency(totalDeposits)}</td>
          <td class="${excludedDep > 0 ? 'text-warning' : ''}" style="font-size:0.8rem;">${excludedDep > 0 ? '-'+formatCurrency(excludedDep) : '-'}</td>
          <td class="text-positive"><strong>${formatCurrency(trueCredits)}</strong></td>
          <td>${formatCurrency(totalWithdrawals)}</td>
          <td class="text-negative"><strong>${formatCurrency(trueDebits)}</strong></td>
          <td>${formatCurrency(m.endingBal)}</td>
          <td>${formatCurrency(m.avgDailyBal)}</td>
          <td>${m.depositCount || 0}</td>
          <td class="${m.nsfs ? 'text-negative' : ''}">${m.nsfs || 0}</td>
        </tr>
      `}).join('');

      // Add AVG/TOTAL row
      const bankFoot = document.getElementById('bankTableFoot');
      bankFoot.style.display = 'table-footer-group';
      
      const avgDeposits = avg('deposits') || avg('revenue');
      const avgWithdrawals = avg('withdrawals');
      const avgExcludedDep = avg('excludedDeposits');
      const avgTrueCredits = avg('trueCredits') || (avgDeposits - avgExcludedDep);
      const avgTrueDebits = avg('trueDebits') || avgWithdrawals;
      
      document.getElementById('bankTotalsRow').innerHTML = `
        <td><strong>AVERAGES</strong></td>
        <td><strong>${formatCurrency(avgDeposits)}</strong></td>
        <td class="text-warning" style="font-size:0.8rem;"><strong>${avgExcludedDep > 0 ? '-'+formatCurrency(avgExcludedDep) : '-'}</strong></td>
        <td class="text-positive"><strong>${formatCurrency(avgTrueCredits)}</strong></td>
        <td><strong>${formatCurrency(avgWithdrawals)}</strong></td>
        <td class="text-negative"><strong>${formatCurrency(avgTrueDebits)}</strong></td>
        <td><strong>${formatCurrency(avg('endingBal'))}</strong></td>
        <td><strong>${formatCurrency(avg('avgDailyBal'))}</strong></td>
        <td><strong>${Math.round(avg('depositCount'))}</strong></td>
        <td class="text-negative"><strong>${total('nsfs')}</strong></td>
      `;

      renderBankCharts();

      // Large Transactions
      const ltContainer = document.getElementById('largeTxnContainer');
      const ltCount = document.getElementById('largeTxnCount');
      if (data.bank.largeTransactions.length) {
        ltCount.textContent = `${data.bank.largeTransactions.length} flagged`;
        ltContainer.innerHTML = data.bank.largeTransactions.slice(0, 10).map(t => `
          <div class="item-card ${t.type === 'inflow' ? 'positive' : 'negative'}">
            <div class="item-card-info">
              <div class="item-card-title">${t.description || 'Transaction'}</div>
              <div class="item-card-meta">${t.date || ''}  ${t.category || ''}</div>
            </div>
            <div class="item-card-value ${t.type === 'inflow' ? 'text-positive' : 'text-negative'}">
              ${t.type === 'inflow' ? '+' : '-'}${formatCurrency(Math.abs(t.amount || 0))}
            </div>
          </div>
        `).join('');
      } else {
        ltCount.textContent = '0 flagged';
        ltContainer.innerHTML = '<div class="empty-state">No large transactions detected</div>';
      }
      
      // Excluded Transactions
      const exContainer = document.getElementById('excludedTxnContainer');
      const exCount = document.getElementById('excludedTxnCount');
      const exCard = document.getElementById('excludedTxnCard');
      
      // Build excluded list from months data
      const excludedItems = [];
      months.forEach(m => {
        if (m.excludedDeposits && m.excludedDeposits > 0) {
          // Add a summary item for each month's excluded deposits
          excludedItems.push({
            month: m.monthLabel || m.monthKey,
            amount: m.excludedDeposits,
            type: 'deposit',
            description: 'Excluded deposits (lender funding, transfers, returns)'
          });
        }
      });
      
      // Also add from excludedDeposits array if available
      if (data.bank.excludedDeposits?.length) {
        data.bank.excludedDeposits.forEach(e => {
          excludedItems.push({
            date: e.date,
            amount: e.amount,
            type: 'deposit',
            description: e.description || e.reason || 'Excluded deposit'
          });
        });
      }
      
      if (excludedItems.length > 0) {
        exCard.style.display = 'block';
        exCount.textContent = `${excludedItems.length} items  ${formatCurrency(excludedItems.reduce((s, e) => s + (e.amount || 0), 0))} total`;
        exContainer.innerHTML = excludedItems.slice(0, 15).map(e => `
          <div class="item-card" style="border-left:3px solid var(--text-muted);opacity:0.8;">
            <div class="item-card-info">
              <div class="item-card-title" style="color:var(--text-muted);">${e.description}</div>
              <div class="item-card-meta">${e.date || e.month || ''}</div>
            </div>
            <div class="item-card-value" style="color:var(--text-muted);">
              ${formatCurrency(e.amount || 0)}
            </div>
          </div>
        `).join('');
      } else {
        exCard.style.display = 'none';
      }

      // Debts Table
      const debtTableBody = document.getElementById('debtTableBody');
      const debtTableFoot = document.getElementById('debtTableFoot');
      if (data.bank.debts.length) {
        const totalBalance = data.bank.debts.reduce((s, d) => s + (parseFloat(d.estimatedBalance) || 0), 0);
        const totalMonthlyPmt = data.bank.debts.reduce((s, d) => s + (parseFloat(d.monthlyPayment) || 0), 0);
        
        debtTableBody.innerHTML = data.bank.debts.map(d => `
          <tr>
            <td>${d.lender || 'Unknown'}</td>
            <td>${d.type || 'Debt'}</td>
            <td>${formatCurrency(d.estimatedBalance)}</td>
            <td class="text-negative">${formatCurrency(d.monthlyPayment)}</td>
          </tr>
        `).join('');
        
        debtTableFoot.style.display = 'table-footer-group';
        document.getElementById('debtTotalBalance').innerHTML = `<strong>${formatCurrency(totalBalance)}</strong>`;
        document.getElementById('debtTotalMonthly').innerHTML = `<strong class="text-negative">${formatCurrency(totalMonthlyPmt)}</strong>`;
      } else {
        debtTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">No debts detected</td></tr>';
        debtTableFoot.style.display = 'none';
      }

      // Render account tabs and per-account tables if multiple accounts
      renderAccountTabs();

      // Auto-generate branded statement
      generateBrandedStatement();
    }

    let currentAccountView = 'combined';

    function renderAccountTabs() {
      const accounts = Object.keys(data.bank.accounts);
      const tabsContainer = document.getElementById('accountTabs');
      
      if (accounts.length > 1) {
        tabsContainer.style.display = 'flex';
        tabsContainer.innerHTML = `
          <button class="account-tab ${currentAccountView === 'combined' ? 'active' : ''}" onclick="switchAccountView('combined')">Combined</button>
          ${accounts.map(last4 => {
            const acct = data.bank.accounts[last4];
            return `<button class="account-tab ${currentAccountView === last4 ? 'active' : ''}" onclick="switchAccountView('${last4}')">
              ${acct.bankName || 'Account'} <span class="acct-num">****${last4}</span>
            </button>`;
          }).join('')}
        `;
        
        // Render per-account tables
        const container = document.getElementById('accountTablesContainer');
        container.innerHTML = accounts.map(last4 => {
          const acct = data.bank.accounts[last4];
          const acctMonths = acct.months || [];
          if (!acctMonths.length) return '';
          
          const count = acctMonths.length;
          const avg = (key) => acctMonths.reduce((s, m) => s + (parseFloat(m[key]) || 0), 0) / count;
          const total = (key) => acctMonths.reduce((s, m) => s + (parseFloat(m[key]) || 0), 0);
          
          return `
            <div class="account-table-section" id="acctTable_${last4}" style="display:${currentAccountView === last4 ? 'block' : 'none'};">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div style="font-weight:700;font-size:1rem;">${acct.bankName || 'Bank Account'}</div>
                <div style="font-size:0.8rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;">****${last4}</div>
                <div style="font-size:0.75rem;color:var(--text-muted);">${acct.accountType || 'Checking'}</div>
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr><th>Month</th><th>True Deposits</th><th>Excluded</th><th>True Debits</th><th>End Bal</th><th>Avg Daily</th><th>Dep #</th><th>OD</th><th>NSF</th><th>Neg</th></tr>
                  </thead>
                  <tbody>
                    ${acctMonths.map(m => {
                      const excluded = parseFloat(m.excludedDeposits) || 0;
                      return `
                      <tr class="clickable-row" onclick="showMonthTransactions('${m.monthKey}', '${m.monthLabel || m.monthKey}')">
                        <td>${m.monthLabel || m.monthKey}</td>
                        <td class="text-positive">${formatCurrency(m.revenue)}</td>
                        <td class="${excluded > 0 ? 'text-muted' : ''}" style="font-size:0.75rem;">${excluded > 0 ? formatCurrency(excluded) : '-'}</td>
                        <td class="text-negative">${formatCurrency(m.withdrawals)}</td>
                        <td>${formatCurrency(m.endingBal)}</td>
                        <td>${formatCurrency(m.avgDailyBal)}</td>
                        <td>${m.revenueDepositCount || m.depositCount || 0}</td>
                        <td class="${m.overdraftFees ? 'text-warning' : ''}">${formatCurrency(m.overdraftFees)}</td>
                        <td class="${m.nsfs ? 'text-negative' : ''}">${m.nsfs || 0}</td>
                        <td class="${m.negatives ? 'text-warning' : ''}">${m.negatives || 0}</td>
                      </tr>
                    `}).join('')}
                  </tbody>
                  <tfoot>
                    <tr class="totals-row">
                      <td><strong>AVG/TOTAL</strong></td>
                      <td class="text-positive"><strong>${formatCurrency(avg('revenue'))}</strong></td>
                      <td class="text-muted" style="font-size:0.75rem;"><strong>${formatCurrency(avg('excludedDeposits'))}</strong></td>
                      <td class="text-negative"><strong>${formatCurrency(avg('withdrawals'))}</strong></td>
                      <td><strong>${formatCurrency(avg('endingBal'))}</strong></td>
                      <td><strong>${formatCurrency(avg('avgDailyBal'))}</strong></td>
                      <td><strong>${Math.round(avg('revenueDepositCount') || avg('depositCount'))}</strong></td>
                      <td><strong>${formatCurrency(total('overdraftFees'))}</strong></td>
                      <td class="text-negative"><strong>${total('nsfs')}</strong></td>
                      <td><strong>${total('negatives')}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          `;
        }).join('');
      } else if (accounts.length === 1) {
        // Single account - show account info in combined view
        const last4 = accounts[0];
        const acct = data.bank.accounts[last4];
        tabsContainer.style.display = 'flex';
        tabsContainer.innerHTML = `
          <div class="account-tab active" style="cursor:default;">
            ${acct.bankName || 'Bank Account'} <span class="acct-num">****${last4}</span>
            <span style="margin-left:8px;font-size:0.7rem;opacity:0.7;">${acct.accountType || 'Checking'}</span>
          </div>
        `;
      } else {
        tabsContainer.style.display = 'none';
      }
    }

    function switchAccountView(view) {
      currentAccountView = view;
      
      // Update tab active states
      document.querySelectorAll('.account-tab').forEach(t => t.classList.remove('active'));
      event.target.closest('.account-tab').classList.add('active');
      
      // Toggle visibility
      const combinedSection = document.getElementById('combinedTableSection');
      const accountsContainer = document.getElementById('accountTablesContainer');
      
      if (view === 'combined') {
        combinedSection.style.display = 'block';
        accountsContainer.style.display = 'none';
      } else {
        combinedSection.style.display = 'none';
        accountsContainer.style.display = 'block';
        
        // Show only selected account table
        document.querySelectorAll('.account-table-section').forEach(s => s.style.display = 'none');
        const selectedTable = document.getElementById(`acctTable_${view}`);
        if (selectedTable) selectedTable.style.display = 'block';
      }
    }

    let currentTxnFilter = 'all';
    let currentMonthKey = null;

    function showMonthTransactions(monthKey, monthLabel) {
      currentMonthKey = monthKey;
      currentTxnFilter = 'all';
      
      // Highlight active row
      document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active'));
      document.querySelector(`[data-month="${monthKey}"]`)?.classList.add('active');
      
      // Show panel
      const panel = document.getElementById('transactionDetailCard');
      panel.style.display = 'block';
      document.getElementById('txnDetailMonth').textContent = monthLabel;
      
      // Reset filter buttons
      document.querySelectorAll('#transactionDetailCard .btn').forEach(b => b.classList.remove('active'));
      document.getElementById('txnFilterAll').classList.add('active');
      
      renderTransactionDetails(monthKey, 'all');
      
      // Scroll to panel
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function filterTxnType(type) {
      currentTxnFilter = type;
      document.querySelectorAll('#transactionDetailCard .btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`txnFilter${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('active');
      renderTransactionDetails(currentMonthKey, type);
    }

    function renderTransactionDetails(monthKey, filter) {
      let txns = monthKey === 'ALL' 
        ? [...data.bank.transactions]
        : data.bank.transactions.filter(t => t.monthKey === monthKey);
      
      if (filter === 'deposit') txns = txns.filter(t => t.type === 'deposit');
      else if (filter === 'debit') txns = txns.filter(t => t.type === 'debit');
      
      // Sort by date desc
      txns.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
      
      // Calculate summaries
      const allTxns = monthKey === 'ALL' 
        ? [...data.bank.transactions]
        : data.bank.transactions.filter(t => t.monthKey === monthKey);
      const deposits = allTxns.filter(t => t.type === 'deposit');
      const debits = allTxns.filter(t => t.type === 'debit');
      const totalDeposits = deposits.reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
      const totalDebits = debits.reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
      
      document.getElementById('txnTotalDeposits').textContent = formatCurrency(totalDeposits);
      document.getElementById('txnTotalDebits').textContent = formatCurrency(totalDebits);
      document.getElementById('txnDepositCount').textContent = deposits.length;
      document.getElementById('txnDebitCount').textContent = debits.length;
      
      const tbody = document.getElementById('txnDetailBody');
      if (txns.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-state">No ${filter === 'all' ? '' : filter} transactions found${monthKey !== 'ALL' ? ' for this month' : ''}</td></tr>`;
        return;
      }
      
      tbody.innerHTML = txns.map(t => `
        <tr>
          <td>${t.date || '--'}</td>
          <td class="txn-desc" title="${t.description || ''}">${t.description || '--'}</td>
          <td><span class="txn-type ${t.type}">${t.type}</span></td>
          <td class="${t.type === 'deposit' ? 'text-positive' : 'text-negative'}">${t.type === 'deposit' ? '+' : '-'}${formatCurrency(t.amount)}</td>
          <td>${t.balance ? formatCurrency(t.balance) : '--'}</td>
        </tr>
      `).join('');
    }

    function showAllTransactions(filterType = 'all') {
      currentMonthKey = 'ALL';
      currentTxnFilter = filterType;
      
      // Remove active from month rows
      document.querySelectorAll('.clickable-row').forEach(r => r.classList.remove('active'));
      
      // Show panel
      const panel = document.getElementById('transactionDetailCard');
      panel.style.display = 'block';
      document.getElementById('txnDetailMonth').textContent = filterType === 'all' ? 'All Months' : filterType === 'deposit' ? 'All Deposits' : 'All Debits';
      
      // Update filter buttons
      document.querySelectorAll('#transactionDetailCard .btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`txnFilter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`).classList.add('active');
      
      renderTransactionDetails('ALL', filterType);
      
      // Scroll to panel
      panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderBankCharts() {
      const months = data.bank.months;
      const labels = months.map(m => m.monthLabel || m.monthKey);

      const ctx1 = document.getElementById('bankCashFlowChart').getContext('2d');
      if (charts.bankCashFlow) charts.bankCashFlow.destroy();
      charts.bankCashFlow = new Chart(ctx1, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'True Credits', data: months.map(m => m.trueCredits || m.deposits || 0), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.4 },
            { label: 'True Debits', data: months.map(m => m.trueDebits || m.withdrawals || 0), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.4 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
      });

      const ctx2 = document.getElementById('bankRevenueChart').getContext('2d');
      if (charts.bankRevenue) charts.bankRevenue.destroy();
      charts.bankRevenue = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'True Revenue', data: months.map(m => m.trueCredits || m.deposits || m.revenue || 0), backgroundColor: 'rgba(34,197,94,0.6)', borderColor: '#22c55e', borderWidth: 2, borderRadius: 4 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }

    function generateBrandedStatement() {
      const months = data.bank.months;
      if (!months.length) { showToast('No bank data', 'error'); return; }

      const container = document.getElementById('brandedStatementContainer');
      const count = months.length;
      const avg = (key) => months.reduce((s, m) => s + (parseFloat(m[key]) || 0), 0) / count;
      const total = (key) => months.reduce((s, m) => s + (parseFloat(m[key]) || 0), 0);
      const totalDebt = data.bank.debts.reduce((s, d) => s + (parseFloat(d.monthlyPayment) || 0), 0);
      const now = new Date().toLocaleDateString();

      container.innerHTML = `
        <div class="branded-statement">
          <div class="branded-header">
            <div class="branded-logo">
                            <svg viewBox="0 0 100 100"><defs><linearGradient id="bsPlanetGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#facc15"/><stop offset="100%" style="stop-color:#ca8a04"/></linearGradient></defs><ellipse cx="50" cy="50" rx="42" ry="10" fill="none" stroke="rgba(250,204,21,0.6)" stroke-width="3" transform="rotate(-20 50 50)"/><circle cx="50" cy="50" r="22" fill="url(#bsPlanetGrad)"/></svg>
              <span>Ables<span style="color:#78716c">AI</span></span>
            </div>
            <div class="branded-title">Bank Statement Analysis</div>
          </div>
          <div class="branded-body">
            <div class="branded-section">
              <div class="branded-section-title">Summary Metrics</div>
              <table class="branded-table">
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td>Analysis Period</td><td>${months[0]?.monthLabel || ''} - ${months[months.length-1]?.monthLabel || ''}</td></tr>
                <tr><td>Months Analyzed</td><td>${count}</td></tr>
                <tr><td>Average Monthly Revenue</td><td>${formatCurrency(avg('revenue'))}</td></tr>
                <tr><td>Average Daily Balance</td><td>${formatCurrency(avg('avgDailyBal'))}</td></tr>
                <tr><td>Average Deposit Count</td><td>${Math.round(avg('depositCount'))}</td></tr>
                <tr><td>Monthly Debt Payments</td><td>${formatCurrency(totalDebt)}</td></tr>
                <tr><td>Total NSFs</td><td>${total('nsfs')}</td></tr>
              </table>
            </div>
            <div class="branded-section">
              <div class="branded-section-title">Monthly Detail</div>
              <table class="branded-table">
                <tr><th>Month</th><th>True Deposits</th><th>Excluded</th><th>True Debits</th><th>Avg Daily Bal</th><th>End Bal</th><th>NSF</th></tr>
                ${months.map(m => {
                  const excluded = parseFloat(m.excludedDeposits) || 0;
                  return `<tr><td>${m.monthLabel || m.monthKey}</td><td>${formatCurrency(m.revenue)}</td><td style="color:#78716c;font-size:0.75rem;">${excluded > 0 ? formatCurrency(excluded) : '-'}</td><td>${formatCurrency(m.withdrawals)}</td><td>${formatCurrency(m.avgDailyBal)}</td><td>${formatCurrency(m.endingBal)}</td><td>${m.nsfs || 0}</td></tr>`;
                }).join('')}
                <tr style="background:#f5f5f4;font-weight:700;border-top:2px solid #d6d3d1;"><td>AVG/TOTAL</td><td>${formatCurrency(avg('revenue'))}</td><td style="color:#78716c;font-size:0.75rem;">${formatCurrency(avg('excludedDeposits'))}</td><td>${formatCurrency(avg('withdrawals'))}</td><td>${formatCurrency(avg('avgDailyBal'))}</td><td>${formatCurrency(avg('endingBal'))}</td><td>${total('nsfs')}</td></tr>
              </table>
            </div>
            ${data.bank.debts.length ? `
            <div class="branded-section">
              <div class="branded-section-title">Detected Debt Obligations</div>
              <table class="branded-table">
                <tr><th>Lender</th><th>Type</th><th>Est. Balance</th><th>Monthly Payment</th></tr>
                ${data.bank.debts.map(d => `<tr><td>${d.lender || 'Unknown'}</td><td>${d.type || '--'}</td><td>${formatCurrency(d.estimatedBalance)}</td><td>${formatCurrency(d.monthlyPayment)}</td></tr>`).join('')}
                <tr style="background:#f5f5f4;font-weight:700;border-top:2px solid #d6d3d1;"><td colspan="2">TOTALS</td><td>${formatCurrency(data.bank.debts.reduce((s,d)=>s+(parseFloat(d.estimatedBalance)||0),0))}</td><td>${formatCurrency(totalDebt)}</td></tr>
              </table>
            </div>` : ''}
          </div>
          <div class="branded-footer"><span>Generated by Ables<span style="color:#78716c">AI</span></span><span>${now}</span></div>
        </div>
      `;
      // Only scroll if button was clicked manually
      if (event && event.type === 'click') {
        container.scrollIntoView({ behavior: 'smooth' });
      }
    }

    async function processCredit(images) {
      const prompt = `Extract from credit report. Return ONLY JSON:
{"score":0,"bureau":"","summary":{"totalAccounts":0,"openAccounts":0,"totalDebt":0,"utilization":0,"inquiries":0,"derogatoryMarks":0},"tradelines":[{"creditor":"","accountType":"","status":"current|delinquent|closed","balance":0,"limit":0,"payment":0}],"insights":{"paymentHistory":"","creditMix":"","riskFactors":""}}`;
      const result = await callGemini(prompt, images);
      if (result) {
        try {
          const parsed = parseJSON(result);
          if (!parsed) {
            console.error('Could not parse credit JSON:', result.substring(0, 200));
            showToast('Could not parse credit data', 'error');
            return;
          }
          
          // Initialize if null
          if (!data.credit.extracted) {
            data.credit.extracted = { score: 0, bureau: '', summary: {}, tradelines: [], insights: {} };
          }
          
          // Merge data
          if (parsed.score) data.credit.extracted.score = parsed.score;
          if (parsed.bureau) data.credit.extracted.bureau = parsed.bureau;
          if (parsed.summary) data.credit.extracted.summary = { ...data.credit.extracted.summary, ...parsed.summary };
          if (parsed.tradelines?.length) data.credit.extracted.tradelines = parsed.tradelines;
          if (parsed.insights) data.credit.extracted.insights = { ...data.credit.extracted.insights, ...parsed.insights };
          
          renderCreditResults();
          updateProfileTab();
        } catch (e) { 
          console.error('Credit parse error:', e, result.substring(0, 500));
          showToast('Error parsing credit: ' + e.message, 'error');
        }
      }
    }

    function renderCreditResults() {
      console.log('renderCreditResults called, data.credit.extracted:', data.credit.extracted);
      document.getElementById('creditResults').classList.add('active');
      const d = data.credit.extracted;
      if (!d) {
        console.log('No credit data to render');
        return;
      }

      const score = d.score || 0;
      console.log('Credit score:', score, 'Bureau:', d.bureau, 'Summary:', d.summary);
      let color = '#8b5cf6', tier = 'Fair';
      if (score >= 750) { color = '#6366f1'; tier = 'Excellent'; }
      else if (score >= 700) { color = '#8b5cf6'; tier = 'Good'; }
      else if (score >= 650) { color = '#a78bfa'; tier = 'Fair'; }
      else if (score >= 600) { color = '#c4b5fd'; tier = 'Poor'; }
      else if (score > 0) { color = '#ef4444'; tier = 'Very Poor'; }

      const pct = score > 0 ? ((score - 300) / 550) * 100 : 0;
      document.getElementById('creditScoreRing').style.setProperty('--pct', pct);
      document.getElementById('creditScoreRing').style.setProperty('--score-color', color);
      document.getElementById('creditScoreValue').textContent = score || '---';
      document.getElementById('creditScoreValue').style.color = color;
      document.getElementById('creditTier').textContent = tier;
      document.getElementById('creditTier').style.color = color;
      document.getElementById('creditSummary').textContent = d.bureau || 'Credit analyzed';

      const s = d.summary || {};
      document.getElementById('creditTotalAccounts').textContent = s.totalAccounts || 0;
      document.getElementById('creditOpenAccounts').textContent = s.openAccounts || 0;
      document.getElementById('creditTotalDebt').textContent = formatCurrency(s.totalDebt || 0);
      document.getElementById('creditUtilization').textContent = (s.utilization || 0) + '%';
      document.getElementById('creditInquiries').textContent = s.inquiries || 0;
      document.getElementById('creditDerogatory').textContent = (s.derogatoryMarks || 0) + (s.collections || 0) + (s.publicRecords || 0);
      
      // Additional metrics
      document.getElementById('creditOldestAccount').textContent = s.oldestAccount || d.oldestAccount || '--';
      document.getElementById('creditAvgAge').textContent = s.avgAge || d.avgAccountAge || '--';

      // Tradelines with improved layout
      const container = document.getElementById('tradelinesContainer');
      const countEl = document.getElementById('tradelineCount');
      if (d.tradelines?.length) {
        countEl.textContent = `${d.tradelines.length} accounts`;
        container.innerHTML = d.tradelines.slice(0, 12).map(t => {
          const statusClass = (t.status || 'current').toLowerCase().replace(/\s+/g, '-');
          const statusColor = statusClass.includes('current') || statusClass.includes('open') ? '#22c55e' : 
                             statusClass.includes('closed') || statusClass.includes('paid') ? '#6b7280' :
                             statusClass.includes('delinquent') || statusClass.includes('late') ? '#ef4444' : '#eab308';
          const util = t.limit > 0 ? Math.round((t.balance / t.limit) * 100) : 0;
          const utilColor = util > 70 ? '#ef4444' : util > 30 ? '#eab308' : '#22c55e';
          
          return `
          <div class="tradeline">
            <div class="tradeline-header">
              <div style="flex:1;">
                <div class="tradeline-name">${t.creditor || 'Unknown'}</div>
                <div class="tradeline-type">${t.accountType || t.type || ''}</div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                ${t.opened ? `<span style="font-size:0.65rem;color:var(--text-muted);">Opened ${t.opened}</span>` : ''}
                <span class="tradeline-status" style="background:${statusColor}20;color:${statusColor};">${t.status || 'Current'}</span>
              </div>
            </div>
            <div class="tradeline-stats">
              <div class="tradeline-stat">
                <div class="tradeline-stat-value">${formatCurrency(t.balance)}</div>
                <div class="tradeline-stat-label">Balance</div>
              </div>
              <div class="tradeline-stat">
                <div class="tradeline-stat-value">${t.limit ? formatCurrency(t.limit) : '--'}</div>
                <div class="tradeline-stat-label">Limit</div>
              </div>
              <div class="tradeline-stat">
                <div class="tradeline-stat-value">${t.payment ? formatCurrency(t.payment) : '--'}</div>
                <div class="tradeline-stat-label">Payment</div>
              </div>
              <div class="tradeline-stat">
                <div class="tradeline-stat-value" style="color:${utilColor};">${t.limit > 0 ? util + '%' : '--'}</div>
                <div class="tradeline-stat-label">Util</div>
              </div>
            </div>
          </div>
        `}).join('');
      } else {
        countEl.textContent = '0 accounts';
        container.innerHTML = '<div class="empty-state">No tradelines found</div>';
      }

      // Credit insights
      if (d.insights) {
        document.getElementById('creditInsightPayment').textContent = d.insights.paymentHistory || '--';
        document.getElementById('creditInsightMix').textContent = d.insights.creditMix || '--';
        document.getElementById('creditInsightRisk').textContent = d.insights.riskFactors || '--';
      }
      
      // Public records & collections
      const publicRecordsCard = document.getElementById('creditPublicRecordsCard');
      const publicRecordsContainer = document.getElementById('creditPublicRecordsContainer');
      const hasPublicRecords = (s.publicRecords > 0) || (s.collections > 0) || d.publicRecords?.length || d.collections?.length;
      
      if (hasPublicRecords) {
        publicRecordsCard.style.display = 'block';
        let recordsHtml = '';
        
        if (d.publicRecords?.length) {
          recordsHtml += d.publicRecords.map(pr => `
            <div class="item-card negative" style="border-left:3px solid #ef4444;">
              <div class="item-card-info">
                <div class="item-card-title">${pr.type || 'Public Record'}</div>
                <div class="item-card-meta">${pr.date || ''}  ${pr.court || pr.source || ''}</div>
              </div>
              <div class="item-card-value text-negative">${formatCurrency(pr.amount)}</div>
            </div>
          `).join('');
        }
        
        if (d.collections?.length) {
          recordsHtml += d.collections.map(c => `
            <div class="item-card negative" style="border-left:3px solid #ef4444;">
              <div class="item-card-info">
                <div class="item-card-title">${c.creditor || 'Collection'}</div>
                <div class="item-card-meta">${c.date || ''}  ${c.status || ''}</div>
              </div>
              <div class="item-card-value text-negative">${formatCurrency(c.balance)}</div>
            </div>
          `).join('');
        }
        
        if (!recordsHtml && (s.publicRecords > 0 || s.collections > 0)) {
          recordsHtml = `<div class="empty-state" style="color:#ef4444;">
            ${s.publicRecords || 0} public records, ${s.collections || 0} collections found
          </div>`;
        }
        
        publicRecordsContainer.innerHTML = recordsHtml;
      } else {
        publicRecordsCard.style.display = 'none';
      }
      
      updateProfileSummary();
    }

    // ========== Business Intelligence / Background Functions ==========
    let currentBgTab = 'research';

    function switchBgTab(tab) {
      currentBgTab = tab;
      document.querySelectorAll('.bg-subtab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.bg-subtab[onclick="switchBgTab('${tab}')"]`)?.classList.add('active');
      document.querySelectorAll('.bg-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`bgSection${tab.charAt(0).toUpperCase() + tab.slice(1)}`)?.classList.add('active');
    }

    async function processBackground(images) {
      const prompt = `Extract comprehensive business intelligence from this document. Return ONLY JSON:
{
  "documentType": "sos_filing|background_check|review_report|ucc_filing|other",
  "research": {
    "legalName": "",
    "dba": "",
    "entityType": "LLC|Corp|Sole Prop|Partnership",
    "stateOfFormation": "",
    "dateFormed": "",
    "status": "Active|Inactive|Dissolved",
    "sosFileNumber": "",
    "ein": "",
    "registeredAgent": {"name": "", "address": ""},
    "officers": [{"name": "", "title": "", "address": ""}],
    "filings": [{"type": "", "date": "", "status": ""}]
  },
  "background": {
    "overallStatus": "clear|flags",
    "criminal": "clear|found",
    "civil": "clear|found", 
    "bankruptcy": "none|found",
    "liens": "none|found",
    "uccFilings": "none|found",
    "taxLiens": "none|found",
    "findings": [{"type": "", "date": "", "description": "", "amount": 0, "status": ""}]
  },
  "reviews": {
    "avgRating": 0,
    "totalReviews": 0,
    "google": {"rating": 0, "count": 0},
    "yelp": {"rating": 0, "count": 0},
    "bbb": {"rating": "", "accredited": false},
    "trustpilot": {"rating": 0, "count": 0},
    "highlights": [{"source": "", "text": "", "rating": 0}],
    "complaints": [{"source": "", "date": "", "description": "", "status": ""}]
  },
  "social": {
    "facebook": {"found": false, "url": "", "followers": 0},
    "instagram": {"found": false, "url": "", "followers": 0},
    "linkedin": {"found": false, "url": "", "followers": 0},
    "twitter": {"found": false, "url": "", "followers": 0},
    "youtube": {"found": false, "url": "", "subscribers": 0},
    "tiktok": {"found": false, "url": "", "followers": 0}
  },
  "footprint": {
    "website": "",
    "domainAge": "",
    "sslStatus": "valid|invalid|none",
    "webTraffic": "",
    "directories": [{"name": "", "listed": true, "url": ""}],
    "onlinePresence": []
  },
  "debt": {
    "positions": [{"lender": "", "type": "MCA|Loan|LOC", "originalAmount": 0, "balance": 0, "payment": 0, "frequency": "daily|weekly|monthly", "status": "active|paid", "filedDate": ""}],
    "uccFilings": [{"securedParty": "", "filingNumber": "", "filedDate": "", "type": "", "collateral": ""}]
  }
}`;
      const result = await callGemini(prompt, images);
      if (result) {
        try {
          const parsed = parseJSON(result);
          if (!parsed) {
            console.error('Could not parse background JSON:', result.substring(0, 200));
            showToast('Could not parse background data', 'error');
            return;
          }
          
          // Merge into existing data
          if (parsed.research && Object.keys(parsed.research).length > 0) {
            data.background.research = { ...data.background.research, ...parsed.research };
          }
          if (parsed.background && Object.keys(parsed.background).length > 0) {
            data.background.checks = { ...data.background.checks, ...parsed.background };
          }
          if (parsed.reviews && Object.keys(parsed.reviews).length > 0) {
            data.background.reviews = { ...data.background.reviews, ...parsed.reviews };
          }
          if (parsed.social && Object.keys(parsed.social).length > 0) {
            data.background.social = { ...data.background.social, ...parsed.social };
          }
          if (parsed.footprint && Object.keys(parsed.footprint).length > 0) {
            data.background.footprint = { ...data.background.footprint, ...parsed.footprint };
          }
          if (parsed.debt) {
            if (parsed.debt.positions?.length) {
              data.background.debt.positions = [...(data.background.debt.positions || []), ...parsed.debt.positions];
            }
            if (parsed.debt.uccFilings?.length) {
              data.background.debt.uccFilings = [...(data.background.debt.uccFilings || []), ...parsed.debt.uccFilings];
            }
          }
          
          renderBackgroundResults();
          updateProfileTab();
        } catch (e) { 
          console.error('Background parse error:', e, result.substring(0, 500));
          showToast('Error parsing background: ' + e.message, 'error');
        }
      }
    }

    async function runBusinessSearch() {
      const searchTerm = document.getElementById('bgSearchInput').value.trim();
      if (!searchTerm) {
        showToast('Enter a business name or EIN', 'error');
        return;
      }

      const apiKey = document.getElementById('apiKeyInput').value;
      if (!apiKey) {
        showToast('Please enter Gemini API key', 'error');
        return;
      }

      // Show processing state
      setProcessingState('background', 'processing', 1, 1);
      const searchBtn = document.getElementById('bgSearchBtn');
      if (searchBtn) {
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="processing-spinner" style="width:14px;height:14px;border-width:2px;"></div> Searching...';
      }

      const prompt = `You are a business research assistant. For the business "${searchTerm}", provide comprehensive intelligence. Return ONLY valid JSON with these sections filled out based on what you know:
{
  "research": {
    "legalName": "${searchTerm}",
    "dba": "",
    "entityType": "Unknown",
    "stateOfFormation": "",
    "dateFormed": "",
    "status": "Unknown",
    "sosFileNumber": "",
    "ein": "",
    "registeredAgent": {"name": "", "address": ""},
    "officers": [],
    "filings": []
  },
  "background": {
    "overallStatus": "unknown",
    "criminal": "unknown",
    "civil": "unknown",
    "bankruptcy": "unknown",
    "liens": "unknown",
    "uccFilings": "unknown",
    "taxLiens": "unknown",
    "findings": []
  },
  "reviews": {
    "avgRating": 0,
    "totalReviews": 0,
    "google": {"rating": 0, "count": 0},
    "yelp": {"rating": 0, "count": 0},
    "bbb": {"rating": "", "accredited": false},
    "trustpilot": {"rating": 0, "count": 0},
    "highlights": [],
    "complaints": []
  },
  "social": {
    "facebook": {"found": false, "url": "", "followers": 0},
    "instagram": {"found": false, "url": "", "followers": 0},
    "linkedin": {"found": false, "url": "", "followers": 0},
    "twitter": {"found": false, "url": "", "followers": 0},
    "youtube": {"found": false, "url": "", "subscribers": 0},
    "tiktok": {"found": false, "url": "", "followers": 0}
  },
  "footprint": {
    "website": "",
    "domainAge": "",
    "sslStatus": "unknown",
    "webTraffic": "",
    "directories": [],
    "onlinePresence": []
  },
  "debt": {
    "positions": [],
    "uccFilings": []
  }
}

Fill in as much information as you reasonably can infer or know about this business. Be realistic - if you don't know something, leave it empty or mark as unknown.`;

      try {
        // Model fallback like working file
        const models = ['gemini-2.5-flash', 'gemini-2.0-flash'];
        let text = '';
        let lastErr;
        
        for (const model of models) {
          try {
            console.log('Trying business search with model:', model);
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.3 }
              })
            });

            const result = await response.json();
            
            if (result.error) {
              console.warn('Model', model, 'failed:', result.error.message);
              lastErr = result.error.message;
              continue;
            }
            
            text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
            if (text) break;
          } catch (err) {
            console.warn('Model', model, 'error:', err);
            lastErr = err.message;
          }
        }
        
        if (!text) {
          throw new Error(lastErr || 'All models failed');
        }
        
        const parsed = parseJSON(text);
        
        if (!parsed) {
          showToast('Could not parse search results', 'error');
          return;
        }

        // Store search results
        data.background.research = parsed.research || {};
        data.background.checks = parsed.background || {};
        data.background.reviews = parsed.reviews || {};
        data.background.social = parsed.social || {};
        data.background.footprint = parsed.footprint || {};
        data.background.debt = parsed.debt || { positions: [], uccFilings: [] };

        document.getElementById('bgBusinessName').textContent = searchTerm;
        renderBackgroundResults();
        updateProfileTab();
        showToast('Business search complete', 'success');

      } catch (error) {
        console.error('Search error:', error);
        showToast(error.message || 'Search failed', 'error');
      } finally {
        // Reset button and processing state
        setProcessingState('background', 'complete');
        const searchBtn = document.getElementById('bgSearchBtn');
        if (searchBtn) {
          searchBtn.disabled = false;
          searchBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Run Search';
        }
      }
    }

    // Deep Research with Grounding API - Parallel Micro-Searches
    async function runDeepResearch(businessName, state = '') {
      if (!businessName) {
        // Try to get from application data
        businessName = data.application.extracted?.business?.legalName || 
                       data.application.extracted?.business?.dba ||
                       document.getElementById('appBusinessName')?.value;
        state = data.application.extracted?.business?.state || 
                document.getElementById('appState')?.value || '';
      }
      
      if (!businessName) {
        console.log('No business name for deep research');
        return;
      }
      
      const apiKey = document.getElementById('apiKeyInput')?.value;
      if (!apiKey) return;
      
      console.log('Running Deep Research for:', businessName);
      setProcessingState('background', 'processing', 1, 1);
      
      // Update progress banner
      const banner = document.getElementById('workflowProgressBanner');
      const stepEl = document.getElementById('workflowProgressStep');
      const detailEl = document.getElementById('workflowProgressDetail');
      if (banner) {
        banner.style.display = 'flex';
        stepEl.textContent = 'Running Deep Research';
        detailEl.textContent = `Searching for ${businessName}...`;
      }
      
      // Set all badges to searching state
      updateBgBadge('Research', '...');
      updateBgBadge('Background', '...');
      updateBgBadge('Reviews', '...');
      updateBgBadge('Social', '...');
      updateBgBadge('Footprint', '...');
      updateBgBadge('Debt', '...');
      
      // === SEQUENTIAL MICRO-SEARCHES with Grounding ===
      const microSearches = [
        {
          name: 'SOS/Entity',
          prompt: `Search for "${businessName}" business entity registration.
${state ? `State: ${state}` : 'Search all states'}
Return JSON only: {"legal_name":"","dba":"","entity_type":"","state":"","formation_date":"","status":"","registered_agent":"","address":"","filing_number":""}`
        },
        {
          name: 'UCC/Liens',
          prompt: `Search for UCC filings and liens against "${businessName}".
Return JSON only: {"ucc_filings":[{"file_number":"","secured_party":"","filed_date":"","status":""}],"liens":[{"type":"","amount":"","filed_date":""}],"judgments":[{"case":"","amount":"","date":""}]}`
        },
        {
          name: 'Reviews',
          prompt: `Search for "${businessName}" business reviews and BBB rating.
Return JSON only: {"bbb_rating":"","bbb_accredited":false,"google_rating":"","google_reviews":0,"yelp_rating":"","yelp_reviews":0,"complaints":0,"review_summary":""}`
        },
        {
          name: 'Website',
          prompt: `Search for "${businessName}" business website and online presence.
Return JSON only: {"website":"","domain_age":"","ssl_valid":true,"traffic_estimate":"","social_facebook":"","social_instagram":"","social_linkedin":"","social_twitter":"","directories":["Google Business","Yelp","BBB"]}`
        },
        {
          name: 'News',
          prompt: `Search for recent news about "${businessName}" business.
Return JSON only: {"news":[{"title":"","source":"","date":"","summary":"","sentiment":"positive/negative/neutral"}],"press_releases":[],"awards":[]}`
        },
        {
          name: 'Operations',
          prompt: `Search for "${businessName}" business operations info.
Return JSON only: {"industry":"","naics":"","description":"","employee_count":"","revenue_estimate":"","years_in_business":0,"locations":[],"services":[]}`
        }
      ];
      
      const results = [];
      
      // Run searches SEQUENTIALLY with delay between each
      for (let i = 0; i < microSearches.length; i++) {
        const search = microSearches[i];
        
        if (detailEl) detailEl.textContent = `${search.name} (${i + 1}/${microSearches.length})...`;
        
        // Add delay between searches (except first)
        if (i > 0) {
          await new Promise(r => setTimeout(r, 1000));
        }
        
        try {
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: search.prompt }] }],
              tools: [{ google_search: {} }],  // Grounding with Google Search
              generationConfig: { temperature: 0.1, maxOutputTokens: 1000 }
            })
          });
          
          if (!res.ok) throw new Error(`API ${res.status}`);
          
          const apiData = await res.json();
          const text = apiData.candidates?.[0]?.content?.parts?.[0]?.text || '';
          const parsed = parseJSON(text);
          
          results.push({ name: search.name, data: parsed });
          console.log(`Deep Research ${search.name}:`, parsed);
          
        } catch (err) {
          console.warn(`Micro-search ${search.name} failed:`, err);
          results.push({ name: search.name, data: null });
        }
      }
      
      try {
        // Merge results into background data structure
        for (const result of results) {
          if (!result.data) continue;
          
          if (result.name === 'SOS/Entity') {
            data.background.research = {
              ...data.background.research,
              legalName: result.data.legal_name || '',
              dba: result.data.dba || '',
              entityType: result.data.entity_type || '',
              stateOfFormation: result.data.state || '',
              dateFormed: result.data.formation_date || '',
              status: result.data.status || '',
              sosFileNumber: result.data.filing_number || '',
              registeredAgent: { name: result.data.registered_agent || '', address: result.data.address || '' }
            };
          } else if (result.name === 'UCC/Liens') {
            data.background.debt.uccFilings = (result.data.ucc_filings || []).map(u => ({
              securedParty: u.secured_party || '',
              filingNumber: u.file_number || '',
              filedDate: u.filed_date || '',
              status: u.status || ''
            }));
            data.background.checks = {
              ...data.background.checks,
              uccFilings: (result.data.ucc_filings?.length || 0) > 0 ? 'found' : 'none',
              liens: (result.data.liens?.length || 0) > 0 ? 'found' : 'none'
            };
          } else if (result.name === 'Reviews') {
            data.background.reviews = {
              ...data.background.reviews,
              avgRating: parseFloat(result.data.google_rating) || parseFloat(result.data.yelp_rating) || 0,
              totalReviews: (result.data.google_reviews || 0) + (result.data.yelp_reviews || 0),
              google: { rating: parseFloat(result.data.google_rating) || 0, count: result.data.google_reviews || 0 },
              yelp: { rating: parseFloat(result.data.yelp_rating) || 0, count: result.data.yelp_reviews || 0 },
              bbb: { rating: result.data.bbb_rating || '', accredited: result.data.bbb_accredited || false }
            };
          } else if (result.name === 'News') {
            data.background.research.news = result.data.news || [];
            data.background.research.awards = result.data.awards || [];
          } else if (result.name === 'Website') {
            // Populate footprint data
            data.background.footprint = {
              ...data.background.footprint,
              website: result.data.website || '',
              domainAge: result.data.domain_age || '',
              sslStatus: result.data.ssl_valid ? 'Valid' : 'Invalid',
              webTraffic: result.data.traffic_estimate || '',
              directories: (result.data.directories || []).map(d => ({ name: d, listed: true }))
            };
            // Populate social data
            if (result.data.social_facebook) {
              data.background.social.facebook = { found: true, url: result.data.social_facebook };
            }
            if (result.data.social_instagram) {
              data.background.social.instagram = { found: true, url: result.data.social_instagram };
            }
            if (result.data.social_linkedin) {
              data.background.social.linkedin = { found: true, url: result.data.social_linkedin };
            }
            if (result.data.social_twitter) {
              data.background.social.twitter = { found: true, url: result.data.social_twitter };
            }
          } else if (result.name === 'Operations') {
            // Apply operations data to application if available
            if (result.data.industry && !data.application.extracted?.business?.industry) {
              if (data.application.extracted?.business) {
                data.application.extracted.business.industry = result.data.industry;
              }
            }
            data.background.footprint = {
              ...data.background.footprint,
              description: result.data.description || '',
              services: result.data.services || [],
              locations: result.data.locations || []
            };
          }
        }
        
        // Determine overall status
        const hasFlags = data.background.checks?.liens === 'found' || 
                         data.background.checks?.uccFilings === 'found';
        data.background.checks.overallStatus = hasFlags ? 'flags' : 'clear';
        
        // Render results
        renderBackgroundResults();
        updateProfileTab();
        
        showToast('Deep Research Complete', 'success');
        
      } catch (err) {
        console.warn('Deep research failed:', err);
        showToast('Research partially complete', 'error');
      } finally {
        setProcessingState('background', 'complete');
        if (banner) {
          banner.style.display = 'none';
        }
      }
    }

    // Auto-run next steps in the workflow
    function autoRunNextStep() {
      // Check if we have enough data to run engine
      const hasApp = data.application.files.length > 0 || document.getElementById('appBusinessName')?.value?.trim();
      const hasBank = data.bank.months.length > 0;
      const hasCredit = data.credit.reports.length > 0 || Object.keys(data.credit.profile || {}).length > 0;
      
      if (hasApp && (hasBank || hasCredit) && !processingState.engine.complete && processingState.engine.status !== 'processing') {
        console.log('Auto-running engine...');
        switchTab('engine');
        setTimeout(() => runUnderwriting(), 500);
      }
    }

    function renderBackgroundResults() {
      const d = data.background;
      
      // Render Research Section FIRST, then update badge based on actual populated fields
      let researchHasData = false;
      if (d.research) {
        const legalName = d.research.legalName || '';
        const status = d.research.status || '';
        
        document.getElementById('bgResearchStatus').textContent = status || 'Searched';
        document.getElementById('bgResearchStatus').className = 'bg-section-status ' + (status === 'Active' ? 'success' : '');
        
        document.getElementById('bgLegalName').textContent = legalName || '--';
        document.getElementById('bgDBA').textContent = d.research.dba || '--';
        document.getElementById('bgEntityType').textContent = d.research.entityType || '--';
        document.getElementById('bgStateFormation').textContent = d.research.stateOfFormation || '--';
        document.getElementById('bgDateFormed').textContent = d.research.dateFormed || '--';
        document.getElementById('bgEntityStatus').textContent = status || '--';
        document.getElementById('bgEntityStatus').className = 'bg-info-value ' + (status === 'Active' ? 'positive' : 'negative');
        document.getElementById('bgSOSNumber').textContent = d.research.sosFileNumber || '--';
        document.getElementById('bgEIN').textContent = d.research.ein || '--';
        
        // Check if we have real data
        researchHasData = !!(legalName || d.research.entityType || d.research.stateOfFormation);

        // Registered Agent
        if (d.research.registeredAgent?.name) {
          document.getElementById('bgAgentInfo').innerHTML = `
            <div style="font-weight:600;">${d.research.registeredAgent.name}</div>
            <div style="font-size:0.85rem;color:var(--text-muted);margin-top:4px;">${d.research.registeredAgent.address || ''}</div>
          `;
        }

        // Officers
        if (d.research.officers?.length) {
          document.getElementById('bgOfficers').innerHTML = d.research.officers.map(o => `
            <div class="bg-filing-item">
              <div>
                <div class="bg-filing-type">${o.name}</div>
                <div class="bg-filing-date">${o.title || 'Officer'}</div>
              </div>
            </div>
          `).join('');
        }

        // Filings
        if (d.research.filings?.length) {
          document.getElementById('bgFilings').innerHTML = d.research.filings.map(f => `
            <div class="bg-filing-item">
              <div>
                <div class="bg-filing-type">${f.type}</div>
                <div class="bg-filing-date">${f.date || ''}</div>
              </div>
              <div style="font-size:0.8rem;color:${f.status === 'Filed' ? 'var(--tier-a)' : 'var(--text-muted)'}">${f.status || ''}</div>
            </div>
          `).join('');
        }
      }

      // Render Background Section
      if (d.checks) {
        const isClean = d.checks.overallStatus === 'clear';
        document.getElementById('bgBackgroundStatus').textContent = isClean ? 'Clear' : (d.checks.overallStatus === 'flags' ? 'Flags Found' : 'Not checked');
        document.getElementById('bgBackgroundStatus').className = 'bg-section-status ' + (isClean ? 'success' : (d.checks.overallStatus === 'flags' ? 'error' : ''));

        const setStatus = (id, val) => {
          const el = document.getElementById(id);
          if (!el) return;
          const isGood = val === 'clear' || val === 'none' || val === 'unknown';
          el.textContent = val || '--';
          el.className = 'kpi-value ' + (isGood ? 'positive' : 'negative');
        };
        setStatus('bgCriminal', d.checks.criminal);
        setStatus('bgCivil', d.checks.civil);
        setStatus('bgBankruptcy', d.checks.bankruptcy);
        setStatus('bgLiens', d.checks.liens);
        setStatus('bgUCC', d.checks.uccFilings);
        setStatus('bgTaxLiens', d.checks.taxLiens);

        if (d.checks.findings?.length) {
          document.getElementById('bgFindings').innerHTML = d.checks.findings.map(f => `
            <div class="item-card negative">
              <div class="item-card-info">
                <div class="item-card-title">${f.type?.toUpperCase() || 'Finding'}</div>
                <div class="item-card-meta">${f.date || ''} ${f.status ? ' ' + f.status : ''}</div>
                <div style="font-size:0.75rem;margin-top:4px">${f.description || ''}</div>
              </div>
              ${f.amount ? `<div class="item-card-value text-negative">${formatCurrency(f.amount)}</div>` : ''}
            </div>
          `).join('');
        }
      }

      // Render Reviews Section
      if (d.reviews) {
        document.getElementById('bgReviewsStatus').textContent = d.reviews.totalReviews > 0 ? `${d.reviews.totalReviews} reviews` : 'Not searched';
        document.getElementById('bgReviewsStatus').className = 'bg-section-status ' + (d.reviews.avgRating >= 4 ? 'success' : (d.reviews.avgRating >= 3 ? 'warning' : ''));

        document.getElementById('bgAvgRating').textContent = d.reviews.avgRating ? d.reviews.avgRating.toFixed(1) : '--';
        document.getElementById('bgTotalReviews').textContent = d.reviews.totalReviews || '--';
        document.getElementById('bgGoogleRating').textContent = d.reviews.google?.rating || '--';
        document.getElementById('bgYelpRating').textContent = d.reviews.yelp?.rating || '--';
        document.getElementById('bgBBBRating').textContent = d.reviews.bbb?.rating || '--';
        document.getElementById('bgTrustpilot').textContent = d.reviews.trustpilot?.rating || '--';

        if (d.reviews.highlights?.length) {
          document.getElementById('bgReviewHighlights').innerHTML = d.reviews.highlights.map(h => `
            <div class="bg-filing-item">
              <div style="flex:1;">
                <div class="bg-filing-type">${h.source}</div>
                <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">"${h.text}"</div>
              </div>
              <div style="font-weight:600;color:var(--accent);">${h.rating}/5</div>
            </div>
          `).join('');
        }

        if (d.reviews.complaints?.length) {
          document.getElementById('bgComplaints').innerHTML = d.reviews.complaints.map(c => `
            <div class="item-card negative">
              <div class="item-card-info">
                <div class="item-card-title">${c.source}</div>
                <div class="item-card-meta">${c.date || ''}  ${c.status || ''}</div>
                <div style="font-size:0.75rem;margin-top:4px">${c.description || ''}</div>
              </div>
            </div>
          `).join('');
        }
      }

      // Render Social Section
      if (d.social) {
        const count = countFoundSocials(d.social);
        document.getElementById('bgSocialStatus').textContent = count > 0 ? `${count} profiles found` : 'Not searched';
        document.getElementById('bgSocialStatus').className = 'bg-section-status ' + (count > 0 ? 'success' : '');

        ['facebook', 'instagram', 'linkedin', 'twitter', 'youtube', 'tiktok'].forEach(platform => {
          const card = document.getElementById(`bg${platform.charAt(0).toUpperCase() + platform.slice(1)}`);
          const data_platform = d.social[platform];
          if (card && data_platform) {
            card.classList.toggle('found', data_platform.found);
            card.querySelector('.bg-social-status').textContent = data_platform.found ? 'Found' : 'Not found';
            const followers = data_platform.followers || data_platform.subscribers || 0;
            card.querySelector('.bg-social-followers').textContent = followers > 0 ? formatNumber(followers) : '--';
          }
        });
      }

      // Render Footprint Section
      if (d.footprint) {
        document.getElementById('bgFootprintStatus').textContent = d.footprint.website ? 'Website found' : 'Not searched';
        document.getElementById('bgFootprintStatus').className = 'bg-section-status ' + (d.footprint.website ? 'success' : '');

        document.getElementById('bgWebsite').textContent = d.footprint.website || '--';
        document.getElementById('bgDomainAge').textContent = d.footprint.domainAge || '--';
        document.getElementById('bgSSLStatus').textContent = d.footprint.sslStatus || '--';
        document.getElementById('bgWebTraffic').textContent = d.footprint.webTraffic || '--';

        if (d.footprint.directories?.length) {
          document.getElementById('bgDirectories').innerHTML = d.footprint.directories.map(dir => `
            <div class="bg-filing-item">
              <div class="bg-filing-type">${dir.name}</div>
              <div style="color:${dir.listed ? 'var(--tier-a)' : 'var(--text-muted)'}">${dir.listed ? 'Listed' : 'Not listed'}</div>
            </div>
          `).join('');
        }
      }

      // Render Debt Section
      if (d.debt) {
        const positions = d.debt.positions || [];
        const activePositions = positions.filter(p => p.status === 'active');
        const totalDebt = activePositions.reduce((s, p) => s + (parseFloat(p.balance) || 0), 0);
        const monthlyPmts = activePositions.reduce((s, p) => s + (parseFloat(p.payment) || 0) * (p.frequency === 'daily' ? 22 : (p.frequency === 'weekly' ? 4.33 : 1)), 0);

        document.getElementById('bgDebtStatus').textContent = positions.length > 0 ? `${activePositions.length} active` : 'Not searched';
        document.getElementById('bgDebtStatus').className = 'bg-section-status ' + (activePositions.length === 0 ? 'success' : (activePositions.length <= 2 ? 'warning' : 'error'));

        document.getElementById('bgTotalPositions').textContent = activePositions.length;
        document.getElementById('bgEstDebt').textContent = formatCurrency(totalDebt);
        document.getElementById('bgMonthlyPmts').textContent = formatCurrency(monthlyPmts);
        document.getElementById('bgStackPosition').textContent = activePositions.length > 0 ? ordinal(activePositions.length + 1) : '1st';

        if (positions.length) {
          document.getElementById('bgDebtPositions').innerHTML = positions.map(p => `
            <div class="bg-position-card ${p.status}">
              <div class="bg-position-info">
                <div class="bg-position-lender">${p.lender || 'Unknown Lender'}</div>
                <div class="bg-position-meta">${p.type || 'MCA'}  ${p.frequency || 'daily'}  ${p.filedDate || ''}</div>
              </div>
              <div class="bg-position-amount">
                <div class="bg-position-balance">${formatCurrency(p.balance)}</div>
                <div class="bg-position-payment">${formatCurrency(p.payment)}/${p.frequency?.charAt(0) || 'd'}</div>
              </div>
            </div>
          `).join('');
        }

        if (d.debt.uccFilings?.length) {
          document.getElementById('bgUCCFilings').innerHTML = d.debt.uccFilings.map(u => `
            <div class="bg-filing-item">
              <div>
                <div class="bg-filing-type">${u.securedParty}</div>
                <div class="bg-filing-date">${u.filingNumber || ''}  ${u.filedDate || ''}</div>
                <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;">${u.collateral || ''}</div>
              </div>
              <div style="font-size:0.75rem;">${u.type || 'UCC-1'}</div>
            </div>
          `).join('');
        }
      }
      
      // NOW update badges AFTER all data has been rendered to DOM
      // Check actual populated field values, not just object existence
      
      // Research badge - check if we have meaningful data
      const researchLegalName = document.getElementById('bgLegalName')?.textContent;
      const researchStatus = document.getElementById('bgEntityStatus')?.textContent;
      if (researchLegalName && researchLegalName !== '--') {
        updateBgBadge('Research', researchStatus === 'Active' ? 'Active' : 'Found');
      } else {
        updateBgBadge('Research', '--');
      }
      
      // Background badge - check if we have status
      const bgStatus = document.getElementById('bgBackgroundStatus')?.textContent;
      if (bgStatus && bgStatus !== 'Not checked') {
        updateBgBadge('Background', bgStatus === 'Clear' ? 'Clear' : 'Flags');
      } else {
        updateBgBadge('Background', '--');
      }
      
      // Reviews badge - check actual rating
      const avgRating = document.getElementById('bgAvgRating')?.textContent;
      if (avgRating && avgRating !== '--' && parseFloat(avgRating) > 0) {
        updateBgBadge('Reviews', avgRating);
      } else {
        updateBgBadge('Reviews', '--');
      }
      
      // Social badge - count found profiles
      const socialCount = countFoundSocials(d.social);
      if (socialCount > 0) {
        updateBgBadge('Social', socialCount + ' profiles');
      } else {
        updateBgBadge('Social', '--');
      }
      
      // Footprint badge - check website
      const website = document.getElementById('bgWebsite')?.textContent;
      if (website && website !== '--') {
        updateBgBadge('Footprint', 'Found');
      } else {
        updateBgBadge('Footprint', '--');
      }
      
      // Debt badge - check positions
      const debtPositions = d.debt?.positions?.length || 0;
      const debtStatus = document.getElementById('bgDebtStatus')?.textContent;
      if (debtStatus && debtStatus !== 'Not searched') {
        updateBgBadge('Debt', debtPositions + ' positions');
      } else {
        updateBgBadge('Debt', '--');
      }
    }

    function updateBgBadge(section, value) {
      const badge = document.getElementById(`bg${section}Badge`);
      if (badge) {
        badge.textContent = value;
        badge.classList.remove('success', 'warning', 'error', 'searching');
        
        // Searching state
        if (value === '...') {
          badge.classList.add('searching');
          return;
        }
        
        // Mark as success if we have real data (not '--')
        if (value && value !== '--' && value !== '0 positions' && value !== '0 profiles') {
          if (value === 'Clear' || value === 'Active' || value === 'Found') {
            badge.classList.add('success');
          } else if (value === 'Flags') {
            badge.classList.add('error');
          } else if (value.includes('profiles') || value.includes('positions') || parseFloat(value) > 0) {
            badge.classList.add('success');
          }
        }
      }
    }

    function countFoundSocials(social) {
      if (!social) return 0;
      return ['facebook', 'instagram', 'linkedin', 'twitter', 'youtube', 'tiktok'].filter(p => social[p]?.found).length;
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function ordinal(n) {
      const s = ['th', 'st', 'nd', 'rd'];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    async function processOther(images, filename) {
      const prompt = `Analyze document. Return ONLY JSON:
{"documentType":"","title":"","summary":"","keyData":{}}`;
      const result = await callGemini(prompt, images);
      if (result) {
        try {
          const parsed = parseJSON(result);
          if (parsed) {
            parsed.filename = filename;
            data.other.extracted.push(parsed);
            renderOtherResults();
          }
        } catch (e) { console.error(e); }
      }
    }

    function renderOtherResults() {
      document.getElementById('otherResults').classList.add('active');
      const container = document.getElementById('otherAnalysis');
      if (data.other.extracted.length) {
        container.innerHTML = data.other.extracted.map(d => `
          <div class="item-card">
            <div class="item-card-info">
              <div class="item-card-title">${d.documentType || d.filename || 'Document'}</div>
              <div class="item-card-meta">${d.title || ''}</div>
              <div style="font-size:0.8rem;margin-top:4px">${d.summary || ''}</div>
            </div>
          </div>
        `).join('');
      }
    }

    // Model fallback - tries multiple models like working file
    async function callGemini(prompt, images, maxTokens = 8192) {
      const models = ['gemini-2.5-flash', 'gemini-2.0-flash'];
      const parts = [{ text: prompt }];
      for (const img of images) parts.push({ inline_data: { mime_type: img.mimeType, data: img.data } });

      let lastErr;
      for (const model of models) {
        try {
          console.log('Trying model:', model);
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts }],
              generationConfig: { temperature: 0.1 }
            })
          });

          const data = await res.json();
          
          // Check for API errors - try next model
          if (data.error) {
            console.warn('Model', model, 'failed:', data.error.message);
            lastErr = data.error.message;
            continue;
          }
          
          // If we got a response, return it
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
          if (text) {
            return text;
          }
        } catch (err) {
          console.warn('Model', model, 'error:', err);
          lastErr = err.message;
        }
      }
      throw new Error(lastErr || 'All models failed');
    }

    // Streaming API for real-time field population
    async function callGeminiStreaming(prompt, images, onChunk, onComplete) {
      const models = ['gemini-2.5-flash', 'gemini-2.0-flash'];
      const parts = [{ text: prompt }];
      for (const img of images) parts.push({ inline_data: { mime_type: img.mimeType, data: img.data } });

      let lastErr;
      for (const model of models) {
        try {
          console.log('Trying streaming model:', model);
          const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts }],
              generationConfig: { temperature: 0.1 }
            })
          });

          if (!res.ok) {
            lastErr = `HTTP ${res.status}`;
            continue;
          }

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let fullText = '';
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            
            // Parse JSON lines from buffer
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';

            for (const line of lines) {
              if (!line.trim() || line.startsWith(',')) continue;
              try {
                const cleaned = line.replace(/^\[?\s*/, '').replace(/\s*\]?$/, '');
                if (!cleaned || cleaned === '[' || cleaned === ']') continue;
                
                const json = JSON.parse(cleaned);
                const text = json.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (text) {
                  fullText += text;
                  if (typeof onChunk === 'function') {
                    onChunk(text, fullText);
                  }
                }
              } catch (e) {
                // Continue on parse errors
              }
            }
          }

          if (fullText) {
            if (typeof onComplete === 'function') {
              onComplete(fullText);
            }
            return fullText;
          }
        } catch (err) {
          console.warn('Streaming model', model, 'error:', err);
          lastErr = err.message;
        }
      }
      throw new Error(lastErr || 'All streaming models failed');
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function formatCurrency(val) {
      return '$' + (parseFloat(val) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Animate a metric value with flash effect
    function animateMetric(el, value, format = 'text') {
      if (!el) return;
      const oldValue = el.textContent;
      let newValue = value;
      
      if (format === 'currency') {
        newValue = formatCurrency(value);
      } else if (format === 'number') {
        newValue = (parseFloat(value) || 0).toLocaleString();
      }
      
      if (oldValue !== newValue) {
        el.textContent = newValue;
        el.classList.add('value-updating');
        setTimeout(() => el.classList.remove('value-updating'), 600);
      }
    }

    // Update KPI with animation
    function updateKPI(id, value, format = 'text') {
      const el = document.getElementById(id);
      if (el) {
        animateMetric(el, value, format);
      }
    }

    // Exact copy of safeJsonFromText from working file
    function parseJSON(text) {
      const t = String(text || '');
      
      // Try to find JSON in different formats
      // 1. Try full JSON object match
      let m = t.match(/\{[\s\S]*\}/);
      if (!m) {
        // 2. Try after markdown code block
        const codeMatch = t.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (codeMatch) {
          m = codeMatch[1].match(/\{[\s\S]*\}/);
        }
      }
      
      if (!m) return null;
      
      let raw = m[0]
        .replace(/```json/g, '')
        .replace(/```/g, '')
        .replace(/\u201c|\u201d/g, '"')
        .replace(/\u2018|\u2019/g, "'")
        .replace(/[\x00-\x1F\x7F]/g, ' ')
        .trim();
      
      // Try multiple parse strategies
      try { 
        return JSON.parse(raw); 
      } catch (e1) {
        // Try fixing common issues
        try {
          raw = raw.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
          return JSON.parse(raw);
        } catch (e2) {
          // Try stripping everything before first { and after last }
          try {
            const firstBrace = raw.indexOf('{');
            const lastBrace = raw.lastIndexOf('}');
            if (firstBrace >= 0 && lastBrace > firstBrace) {
              const cleaned = raw.substring(firstBrace, lastBrace + 1);
              return JSON.parse(cleaned);
            }
          } catch (e3) {
            console.warn('JSON parse attempts failed:', e3);
          }
        }
        return null;
      }
    }

    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (type ? ' ' + type : '');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ============================================
    // ABLES ENGINE - Underwriting Model v4.2.1
    // ============================================
    
    const TIER_COLORS = {
      A: { main: '#4f46e5', rgb: '79, 70, 229', label: 'Prime', grade: 'Excellent' },        // Indigo
      B: { main: '#6366f1', rgb: '99, 102, 241', label: 'Near-Prime', grade: 'Good' },       // Indigo lighter
      C: { main: '#8b5cf6', rgb: '139, 92, 246', label: 'Mid-Prime', grade: 'Fair' },        // Purple
      D: { main: '#a78bfa', rgb: '167, 139, 250', label: 'Sub-Prime', grade: 'Below Average' }, // Light purple
      E: { main: '#ef4444', rgb: '239, 68, 68', label: 'High-Risk', grade: 'Poor' }          // Keep red for high risk
    };

    const TIER_DATA = {
      A: { factor: 1.18, multiplier: 1.40, termMonths: 12, maxAdvance: 1.50 },
      B: { factor: 1.24, multiplier: 1.00, termMonths: 10, maxAdvance: 1.25 },
      C: { factor: 1.32, multiplier: 0.65, termMonths: 9, maxAdvance: 1.00 },
      D: { factor: 1.38, multiplier: 0.50, termMonths: 6, maxAdvance: 0.75 },
      E: { factor: 1.45, multiplier: 0.40, termMonths: 4, maxAdvance: 0.50 }
    };

    const TIER_PD = { A: 3, B: 6, C: 10, D: 18, E: 28 };
    const TIER_THRESHOLDS = { A: 80, B: 65, C: 50, D: 35, E: 0 };
    
    const PROHIBITED_INDUSTRIES = ['gambling', 'adult', 'cannabis', 'firearms', 'crypto', 'collection', 'telemarketing', 'pawn'];
    
    const INDUSTRY_CLASSIFICATION = {
      low: { industries: ['medical', 'dental', 'veterinary', 'pharmacy', 'legal', 'accounting', 'engineering'], pdMultiplier: 0.9, maxAdvanceBonus: 0.10 },
      standard: { industries: ['retail', 'wholesale', 'manufacturing', 'technology', 'professional', 'construction', 'other'], pdMultiplier: 1.0, maxAdvanceBonus: 0 },
      elevated: { industries: ['restaurant', 'food_service', 'hospitality', 'entertainment', 'salon', 'auto_repair'], pdMultiplier: 1.15, maxAdvanceBonus: -0.05 },
      high: { industries: ['trucking', 'transportation', 'gas_station', 'convenience', 'seasonal'], pdMultiplier: 1.3, maxAdvanceBonus: -0.10 }
    };

    const FUNDING_LIMITS = { minFunding: 10000, maxFunding: 165000, minRevenue: 7500, maxDebtServiceRatio: 0.25, minCredit: 500 };
    const FEE_STRUCTURE = { originationRate: 0.03, adminFee: 995, wireFee: 50 };
    const MODEL_WEIGHTS = { credit: 20, behavior: 30, revenue: 20, stability: 20, buffer: 10 };

    let currentUnderwritingResult = null;
    let engineScoreChart = null;

    function getEngineTier(score) {
      if (score >= TIER_THRESHOLDS.A) return 'A';
      if (score >= TIER_THRESHOLDS.B) return 'B';
      if (score >= TIER_THRESHOLDS.C) return 'C';
      if (score >= TIER_THRESHOLDS.D) return 'D';
      return 'E';
    }

    function getIndustryRisk(industry) {
      if (PROHIBITED_INDUSTRIES.includes(industry)) return { category: 'prohibited', pdMultiplier: 999, maxAdvanceBonus: -1 };
      for (const [category, d] of Object.entries(INDUSTRY_CLASSIFICATION)) {
        if (d.industries.includes(industry)) return { category, ...d };
      }
      return { category: 'standard', ...INDUSTRY_CLASSIFICATION.standard };
    }

    function calculateEngineScore(inputs) {
      const { revenue = 0, balance = 0, credit = 0, tib = 0, nsf = 0, negDays = 0, industry = '' } = inputs;
      const isProhibited = PROHIBITED_INDUSTRIES.includes(industry);
      const industryRisk = getIndustryRisk(industry);
      
      // Apply settings weights
      const adjustedWeights = {
        credit: MODEL_WEIGHTS.credit * engineSettings.creditScoreWeight,
        behavior: MODEL_WEIGHTS.behavior,
        revenue: MODEL_WEIGHTS.revenue * engineSettings.revenueMultiplier,
        stability: MODEL_WEIGHTS.stability * engineSettings.tibWeight,
        buffer: MODEL_WEIGHTS.buffer
      };
      
      const rawTotal = adjustedWeights.credit + adjustedWeights.behavior + adjustedWeights.revenue + adjustedWeights.stability + adjustedWeights.buffer;
      const normalize = 100 / rawTotal;
      const weights = {
        credit: adjustedWeights.credit * normalize,
        behavior: adjustedWeights.behavior * normalize,
        revenue: adjustedWeights.revenue * normalize,
        stability: adjustedWeights.stability * normalize,
        buffer: adjustedWeights.buffer * normalize
      };

      const creditPts = credit < engineSettings.minCredit ? 0 : Math.min(weights.credit, ((credit - 500) / 300) * weights.credit);
      const events = (nsf || 0) + (negDays || 0);
      const eventPenalty = (nsf * engineSettings.nsfPenalty) + (negDays * engineSettings.negDaysPenalty);
      const behavePts = events > 10 ? 0 : Math.max(0, weights.behavior - (eventPenalty * (weights.behavior / 40)));
      const revPts = revenue < engineSettings.minRevenue ? 0 : Math.min(weights.revenue, ((revenue - 7500) / 92500) * weights.revenue);
      let stabPts;
      if (tib >= 36) stabPts = weights.stability;
      else if (tib >= 24) stabPts = weights.stability * 0.7;
      else if (tib >= 12) stabPts = weights.stability * 0.4;
      else stabPts = weights.stability * 0.1;
      const bufferRatio = revenue > 0 ? balance / revenue : 0;
      const bufferThreshold = engineSettings.bufferThreshold / 100;
      let bufferPts;
      if (bufferRatio >= bufferThreshold) bufferPts = weights.buffer;
      else if (bufferRatio >= bufferThreshold / 2) bufferPts = weights.buffer * 0.5;
      else bufferPts = 0;

      let totalScore = Math.round(creditPts + behavePts + revPts + stabPts + bufferPts);
      totalScore = Math.max(0, Math.min(100, totalScore));

      let tier = getEngineTier(totalScore);
      if (credit < 520) tier = 'E';
      else if (credit < 550 && ['A', 'B', 'C'].includes(tier)) tier = 'D';
      else if (credit < 600 && ['A', 'B'].includes(tier)) tier = 'C';

      return {
        score: totalScore, tier, tierData: TIER_DATA[tier], tierColors: TIER_COLORS[tier],
        isProhibited, industryRisk, events, bufferRatio,
        components: {
          credit: { points: Math.round(creditPts * 10) / 10, max: Math.round(weights.credit), pct: weights.credit > 0 ? (creditPts / weights.credit) * 100 : 0, input: credit },
          behavior: { points: Math.round(behavePts * 10) / 10, max: Math.round(weights.behavior), pct: weights.behavior > 0 ? (behavePts / weights.behavior) * 100 : 0, events, nsf, negDays },
          revenue: { points: Math.round(revPts * 10) / 10, max: Math.round(weights.revenue), pct: weights.revenue > 0 ? (revPts / weights.revenue) * 100 : 0, input: revenue },
          stability: { points: Math.round(stabPts * 10) / 10, max: Math.round(weights.stability), pct: weights.stability > 0 ? (stabPts / weights.stability) * 100 : 0, input: tib },
          buffer: { points: Math.round(bufferPts * 10) / 10, max: Math.round(weights.buffer), pct: weights.buffer > 0 ? (bufferPts / weights.buffer) * 100 : 0, ratio: bufferRatio, balance }
        },
        weights
      };
    }

    function calculateEngineOffer(inputs, scoreResult) {
      const { revenue, tib, credit, nsf = 0, negDays = 0, balance = 0, existingDebt = 0 } = inputs;
      const { tier, tierData, industryRisk, isProhibited } = scoreResult;
      const events = nsf + negDays;

      if (isProhibited) return { declined: true, reason: 'Prohibited industry', code: 'PROHIBITED_INDUSTRY' };
      if (credit < engineSettings.minCredit) return { declined: true, reason: `Credit below ${engineSettings.minCredit}`, code: 'LOW_CREDIT' };
      if (revenue < engineSettings.minRevenue) return { declined: true, reason: `Revenue below $${engineSettings.minRevenue}`, code: 'LOW_REVENUE' };
      if (events > 10) return { declined: true, reason: 'Too many risk events (NSF + Negative Days > 10)', code: 'HIGH_EVENTS' };

      let fundingMult = engineSettings.baseMultiplier;
      if (tib >= 240) fundingMult += 0.95;
      else if (tib >= 120) fundingMult += 0.80;
      else if (tib >= 60) fundingMult += 0.50;
      else if (tib >= 36) fundingMult += 0.08;
      else if (tib < 24) fundingMult -= 0.05;
      if (credit >= 780) fundingMult += 0.06;
      else if (credit >= 700) fundingMult += 0.03;
      else if (credit < 600) fundingMult -= 0.05;
      if (tib >= 60 && tib < 120) fundingMult -= events * 0.16;
      else if (tib >= 120) fundingMult -= events * 0.08;
      else fundingMult -= events * 0.03;
      fundingMult += industryRisk.maxAdvanceBonus;
      let fundingFloor = revenue >= 100000 ? 0.40 : (revenue >= 50000 ? 0.35 : 0.33);
      fundingMult = Math.max(fundingMult, fundingFloor) * (1 + (engineSettings.revenueMultiplier - 1) * 0.1);
      let funding = Math.min(Math.floor(revenue * fundingMult), engineSettings.maxFunding);

      const maxDebtServiceRatio = engineSettings.maxDebtService / 100;
      if (existingDebt > 0) {
        const maxDebtService = revenue * maxDebtServiceRatio;
        if (existingDebt >= maxDebtService) return { declined: true, reason: 'Existing debt exceeds capacity', code: 'DEBT_EXCEEDED' };
        const availableForNew = Math.max(0, maxDebtService - existingDebt);
        const monthlyPaymentPerDollar = tierData.factor / (tierData.termMonths * engineSettings.termLengthWeight);
        const maxFundingFromDebt = availableForNew / monthlyPaymentPerDollar;
        if (maxFundingFromDebt < funding) funding = Math.max(engineSettings.minFunding, Math.floor(maxFundingFromDebt));
      }

      funding = Math.max(funding, engineSettings.minFunding);
      if (funding < engineSettings.minFunding) return { declined: true, reason: `Funding below $${engineSettings.minFunding}`, code: 'LOW_FUNDING' };

      const adjustedTermMonths = Math.round(tierData.termMonths * engineSettings.termLengthWeight);
      const payback = Math.floor(funding * tierData.factor);
      const termDays = adjustedTermMonths * 22;
      const dailyRevenue = revenue / 22;
      const daily = Math.floor(payback / termDays * 100) / 100;
      const weekly = Math.floor(payback / (adjustedTermMonths * 4.33) * 100) / 100;
      const holdback = ((daily / dailyRevenue) * 100).toFixed(2);
      const cashBuffer = balance / revenue;
      const debtBurdenPct = (existingDebt / revenue) * 100;
      const monthlyPaymentWeekly = weekly * 4.33;
      const availableCash = revenue * maxDebtServiceRatio;
      const totalMonthlyDebtWeekly = monthlyPaymentWeekly + existingDebt;
      const dscrWeekly = totalMonthlyDebtWeekly > 0 ? availableCash / totalMonthlyDebtWeekly : 999;
      let paymentFreq = 'daily';
      if (dscrWeekly >= 1.5 && debtBurdenPct <= 15 && cashBuffer >= 0.08 && events <= 3) paymentFreq = 'weekly';
      const payment = paymentFreq === 'weekly' ? weekly : daily;
      const totalCost = payback - funding;
      const effectiveRate = totalCost / funding;
      const termYears = adjustedTermMonths / 12;
      const apr = (effectiveRate / termYears) * 100 * (paymentFreq === 'weekly' ? 1.05 : 1.0);
      const origFee = Math.floor(funding * FEE_STRUCTURE.originationRate);
      const netWire = funding - origFee - FEE_STRUCTURE.adminFee - FEE_STRUCTURE.wireFee;

      return {
        declined: false, funding, factor: tierData.factor, termMonths: adjustedTermMonths, payback,
        daily, weekly, payment, paymentFreq, holdback: parseFloat(holdback), apr: parseFloat(apr.toFixed(1)),
        fees: { origination: origFee, admin: FEE_STRUCTURE.adminFee, wire: FEE_STRUCTURE.wireFee, netWire }
      };
    }

    function generateAlternatives(baseOffer, scoreResult, inputs) {
      if (baseOffer.declined) return [];
      const { tier, tierData } = scoreResult;
      const { revenue } = inputs;
      const alts = [];

      // Conservative
      const consFunding = Math.floor(baseOffer.funding * 0.70);
      const consFactor = tierData.factor - 0.04;
      const consPayback = Math.floor(consFunding * consFactor);
      const consDaily = Math.floor(consPayback / (tierData.termMonths * 22) * 100) / 100;
      alts.push({ name: 'Conservative', desc: 'Lower funding, better terms', funding: consFunding, factor: consFactor, termMonths: tierData.termMonths, payback: consPayback, daily: consDaily });

      // Standard
      alts.push({ name: 'Standard', desc: 'Model recommendation', funding: baseOffer.funding, factor: baseOffer.factor, termMonths: baseOffer.termMonths, payback: baseOffer.payback, daily: baseOffer.daily, isRecommended: true });

      // Aggressive
      const aggFunding = Math.min(Math.floor(baseOffer.funding * 1.25), FUNDING_LIMITS.maxFunding, Math.floor(revenue * 1.5));
      const aggFactor = tierData.factor + 0.06;
      const aggTerm = Math.max(tierData.termMonths - 2, 4);
      const aggPayback = Math.floor(aggFunding * aggFactor);
      const aggDaily = Math.floor(aggPayback / (aggTerm * 22) * 100) / 100;
      alts.push({ name: 'Aggressive', desc: 'Maximum funding, higher cost', funding: aggFunding, factor: aggFactor, termMonths: aggTerm, payback: aggPayback, daily: aggDaily });

      return alts;
    }

    function calculateRisk(inputs, scoreResult, offer) {
      const { revenue, existingDebt = 0 } = inputs;
      const { tier, industryRisk } = scoreResult;
      const { funding, payback, termMonths } = offer;
      const basePD = TIER_PD[tier] || 10;
      const adjustedPD = basePD * industryRisk.pdMultiplier;
      const monthlyDebt = payback / termMonths;
      const totalMonthlyDebt = monthlyDebt + existingDebt;
      const dscr = totalMonthlyDebt > 0 ? revenue / totalMonthlyDebt : 999;
      let riskLevel = 'Low', riskColor = '#10b981';
      if (adjustedPD > 20 || dscr < 1.25) { riskLevel = 'High'; riskColor = '#ef4444'; }
      else if (adjustedPD > 12 || dscr < 1.5) { riskLevel = 'Medium'; riskColor = '#eab308'; }
      return { pd: adjustedPD, pdFormatted: adjustedPD.toFixed(1) + '%', dscr, dscrFormatted: dscr.toFixed(2) + 'x', riskLevel, riskColor };
    }

    function populateEngineInputs() {
      const months = data.bank.months;
      if (months.length) {
        // Use trueCredits (actual revenue) if available, fallback to deposits or revenue
        const avgRevenue = months.reduce((s, m) => s + (m.trueCredits || m.deposits || m.revenue || 0), 0) / months.length;
        const avgBalance = months.reduce((s, m) => s + (m.avgDailyBal || m.endingBal || 0), 0) / months.length;
        const totalNSF = months.reduce((s, m) => s + (m.nsfs || 0), 0);
        const totalNeg = months.reduce((s, m) => s + (m.negatives || 0), 0);
        document.getElementById('engineRevenue').value = Math.round(avgRevenue);
        document.getElementById('engineBalance').value = Math.round(avgBalance);
        document.getElementById('engineNSF').value = totalNSF;
        document.getElementById('engineNegDays').value = totalNeg;
        const totalDebt = data.bank.debts.reduce((s, d) => s + (d.monthlyPayment || 0), 0);
        document.getElementById('engineExistingDebt').value = Math.round(totalDebt);
      }
      if (data.credit.extracted?.score) document.getElementById('engineCredit').value = data.credit.extracted.score;
      if (data.application.tib) document.getElementById('engineTIB').value = data.application.tib;
      if (data.application.industry) {
        const sel = document.getElementById('engineIndustry');
        const ind = data.application.industry.toLowerCase();
        for (let i = 0; i < sel.options.length; i++) {
          if (ind.includes(sel.options[i].value) || sel.options[i].value.includes(ind)) {
            sel.selectedIndex = i; break;
          }
        }
      }
    }

    function runUnderwriting() {
      // Show processing state
      setProcessingState('engine', 'processing');
      const overlay = document.getElementById('engineProcessingOverlay');
      const progressBar = document.getElementById('engineProgressBar');
      const runBtn = document.getElementById('engineRunBtn');
      const rerunBtn = document.getElementById('engineRerunBtn');
      
      if (overlay) overlay.classList.add('active');
      if (runBtn) runBtn.disabled = true;
      if (rerunBtn) rerunBtn.disabled = true;
      
      // Animate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        if (progressBar) progressBar.style.width = Math.min(progress, 90) + '%';
      }, 100);
      
      // Simulate processing time for UX
      setTimeout(() => {
        clearInterval(progressInterval);
        if (progressBar) progressBar.style.width = '100%';
        
        const inputs = {
          revenue: parseFloat(document.getElementById('engineRevenue').value) || 0,
          balance: parseFloat(document.getElementById('engineBalance').value) || 0,
          credit: parseInt(document.getElementById('engineCredit').value) || 650,
          tib: parseInt(document.getElementById('engineTIB').value) || 24,
          nsf: parseInt(document.getElementById('engineNSF').value) || 0,
          negDays: parseInt(document.getElementById('engineNegDays').value) || 0,
          industry: document.getElementById('engineIndustry').value,
          existingDebt: parseFloat(document.getElementById('engineExistingDebt').value) || 0
        };

        const scoreResult = calculateEngineScore(inputs);
        const offer = calculateEngineOffer(inputs, scoreResult);

        document.getElementById('engineResults').style.display = 'block';
        document.getElementById('engineDecline').style.display = 'none';

        if (offer.declined) {
          document.getElementById('engineDecline').style.display = 'block';
          document.getElementById('declineReason').textContent = offer.reason;
          document.getElementById('approvalOptions').innerHTML = '<div class="empty-state">Application declined</div>';
          
          // Update status
          if (overlay) overlay.classList.remove('active');
          if (runBtn) runBtn.disabled = false;
          if (rerunBtn) rerunBtn.disabled = false;
          setProcessingState('engine', 'complete');
          return;
        }

        currentUnderwritingResult = { inputs, score: scoreResult, offer };

        // Update score display
        const scoreCircle = document.getElementById('engineScoreCircle');
        const circumference = 2 * Math.PI * 42;
        const offset = circumference - (scoreResult.score / 100) * circumference;
        scoreCircle.style.stroke = scoreResult.tierColors.main;
        scoreCircle.style.strokeDashoffset = offset;
        document.getElementById('engineScoreValue').textContent = scoreResult.score;
        document.getElementById('engineScoreValue').style.color = scoreResult.tierColors.main;
        document.getElementById('engineTierBadge').textContent = `Tier ${scoreResult.tier} - ${scoreResult.tierColors.label}`;
        document.getElementById('engineTierBadge').style.background = scoreResult.tierColors.main;
        document.getElementById('engineTierBadge').style.color = '#fff';
        document.getElementById('engineTierLabel').textContent = scoreResult.tierColors.grade + ' Financial Health';

        // Update components
        const c = scoreResult.components;
        document.getElementById('compCreditPts').textContent = `${c.credit.points}/${c.credit.max}`;
        document.getElementById('compCreditBar').style.width = c.credit.pct + '%';
        document.getElementById('compBehaviorPts').textContent = `${c.behavior.points}/${c.behavior.max}`;
        document.getElementById('compBehaviorBar').style.width = c.behavior.pct + '%';
        document.getElementById('compRevenuePts').textContent = `${c.revenue.points}/${c.revenue.max}`;
        document.getElementById('compRevenueBar').style.width = c.revenue.pct + '%';
        document.getElementById('compStabilityPts').textContent = `${c.stability.points}/${c.stability.max}`;
        document.getElementById('compStabilityBar').style.width = c.stability.pct + '%';
        document.getElementById('compBufferPts').textContent = `${c.buffer.points}/${c.buffer.max}`;
        document.getElementById('compBufferBar').style.width = c.buffer.pct + '%';

        // Risk metrics - add to result object
        const risk = calculateRisk(inputs, scoreResult, offer);
        currentUnderwritingResult.risk = risk;  // Store risk for compare fields
        document.getElementById('riskPD').textContent = risk.pdFormatted;
        document.getElementById('riskPD').style.color = risk.pd > 15 ? '#ef4444' : (risk.pd > 8 ? '#eab308' : '#10b981');
        document.getElementById('riskDSCR').textContent = risk.dscrFormatted;
        document.getElementById('riskDSCR').style.color = risk.dscr < 1.25 ? '#ef4444' : (risk.dscr < 1.5 ? '#eab308' : '#10b981');
        document.getElementById('riskLevel').textContent = risk.riskLevel;
        document.getElementById('riskLevel').style.color = risk.riskColor;

        // Score chart
        renderEngineScoreChart(scoreResult);

        // Approval options
        const alts = generateAlternatives(offer, scoreResult, inputs);
        document.getElementById('approvalOptions').innerHTML = alts.map(a => `
          <div class="approval-option ${a.isRecommended ? 'recommended' : ''}" onclick="selectApprovalOption(${a.funding}, ${a.factor}, ${a.termMonths})">
            <div class="approval-option-name">${a.name}</div>
            <div class="approval-option-funding">${formatCurrency(a.funding)}</div>
            <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">${a.desc}</div>
            <div class="approval-option-details">
              <div class="approval-option-row"><span>Factor Rate</span><span>${a.factor.toFixed(2)}</span></div>
              <div class="approval-option-row"><span>Payback</span><span>${formatCurrency(a.payback)}</span></div>
              <div class="approval-option-row"><span>Term</span><span>${a.termMonths} months</span></div>
              <div class="approval-option-row"><span>Daily Payment</span><span>${formatCurrency(a.daily)}</span></div>
            </div>
          </div>
        `).join('');

        // Initialize sliders
        document.getElementById('sliderFunding').value = offer.funding;
        document.getElementById('sliderFunding').max = Math.min(FUNDING_LIMITS.maxFunding, inputs.revenue * 1.5);
        document.getElementById('sliderFactor').value = offer.factor;
        document.getElementById('sliderTerm').value = offer.termMonths;
        document.getElementById('sliderFreq').value = offer.paymentFreq;
        updateApprovalPreview();
        
        // Update status
        if (overlay) overlay.classList.remove('active');
        if (runBtn) runBtn.disabled = false;
        if (rerunBtn) rerunBtn.disabled = false;
        setProcessingState('engine', 'complete');
        showToast('Engine analysis complete', 'success');
        
        // Auto-populate compare fields from engine results
        populateCompareInputs();
        
        // Auto-run review after engine completes
        setTimeout(() => {
          if (!processingState.review.complete && processingState.review.status !== 'processing') {
            console.log('Auto-running final review...');
            generateFinalReview();
          }
        }, 500);
      }, 500);
    }

    function selectApprovalOption(funding, factor, term) {
      document.getElementById('sliderFunding').value = funding;
      document.getElementById('sliderFactor').value = factor;
      document.getElementById('sliderTerm').value = term;
      updateApprovalPreview();
    }

    function updateApprovalPreview() {
      const funding = parseFloat(document.getElementById('sliderFunding').value);
      const factor = parseFloat(document.getElementById('sliderFactor').value);
      const term = parseInt(document.getElementById('sliderTerm').value);
      const freq = document.getElementById('sliderFreq').value;
      const revenue = currentUnderwritingResult?.inputs?.revenue || 50000;

      document.getElementById('sliderFundingValue').textContent = formatCurrency(funding);
      document.getElementById('sliderFactorValue').textContent = factor.toFixed(2);
      document.getElementById('sliderTermValue').textContent = term + ' mo';

      const payback = Math.floor(funding * factor);
      const daily = Math.floor(payback / (term * 22) * 100) / 100;
      const weekly = Math.floor(payback / (term * 4.33) * 100) / 100;
      const payment = freq === 'weekly' ? weekly : daily;
      const holdback = ((daily / (revenue / 22)) * 100).toFixed(1);
      const totalCost = payback - funding;
      const apr = ((totalCost / funding) / (term / 12)) * 100 * (freq === 'weekly' ? 1.05 : 1.0);
      const origFee = Math.floor(funding * 0.03);
      const netWire = funding - origFee - 995 - 50;

      document.getElementById('prevFunding').textContent = formatCurrency(funding);
      document.getElementById('prevFactor').textContent = factor.toFixed(2);
      document.getElementById('prevPayback').textContent = formatCurrency(payback);
      document.getElementById('prevTerm').textContent = term + ' months';
      document.getElementById('prevPaymentLabel').textContent = freq === 'weekly' ? 'Weekly Payment' : 'Daily Payment';
      document.getElementById('prevPayment').textContent = formatCurrency(payment);
      document.getElementById('prevHoldback').textContent = holdback + '%';
      document.getElementById('prevAPR').textContent = apr.toFixed(1) + '%';
      document.getElementById('prevOrigFee').textContent = formatCurrency(origFee);
      document.getElementById('prevNetWire').textContent = formatCurrency(netWire);
    }

    function renderEngineScoreChart(scoreResult) {
      const ctx = document.getElementById('engineScoreChart').getContext('2d');
      if (engineScoreChart) engineScoreChart.destroy();
      const c = scoreResult.components;
      engineScoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Credit', 'Behavior', 'Revenue', 'Stability', 'Buffer'],
          datasets: [{
            label: 'Points',
            data: [c.credit.points, c.behavior.points, c.revenue.points, c.stability.points, c.buffer.points],
            backgroundColor: ['rgba(234,179,8,0.7)', 'rgba(234,179,8,0.7)', 'rgba(234,179,8,0.7)', 'rgba(234,179,8,0.7)', 'rgba(234,179,8,0.7)'],
            borderColor: '#eab308',
            borderWidth: 2,
            borderRadius: 4
          }, {
            label: 'Max',
            data: [c.credit.max, c.behavior.max, c.revenue.max, c.stability.max, c.buffer.max],
            backgroundColor: 'rgba(120,113,108,0.2)',
            borderColor: 'transparent',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, max: 35 } }
        }
      });
    }

    // Share entire profile as URL
    function shareProfile() {
      try {
        // Gather profile data
        const profileData = {
          business: {
            name: document.getElementById('profBizName')?.textContent || '',
            dba: document.getElementById('profBizDBA')?.textContent || '',
            industry: document.getElementById('profBizIndustry')?.textContent || '',
            state: document.getElementById('profBizState')?.textContent || '',
            tib: document.getElementById('profBizTIB')?.textContent || ''
          },
          owner: {
            name: document.getElementById('profOwnerName')?.textContent || '',
            fico: document.getElementById('profOwnerFICO')?.textContent || ''
          },
          bank: {
            revenue: document.getElementById('profileRevenue')?.textContent || '',
            months: data.bank.months.length
          },
          score: currentUnderwritingResult?.score?.score || 0,
          tier: currentUnderwritingResult?.score?.tier || ''
        };
        
        const shareData = btoa(JSON.stringify(profileData));
        const url = `${window.location.origin}${window.location.pathname}?profile=${shareData}`;
        
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).then(() => {
            showToast('Profile link copied to clipboard!', 'success');
          });
        } else {
          prompt('Copy this link:', url);
        }
      } catch (err) {
        console.error('Share error:', err);
        showToast('Could not generate share link', 'error');
      }
    }
    
    // Reset profile for new search
    function resetProfile() {
      if (!confirm('Start a new search? This will clear all current data.')) return;
      
      // Reset all data
      data = {
        application: { files: [], previews: [], extracted: null, industry: '', tib: 0 },
        bank: { files: [], previews: [], accounts: {}, months: [], transactions: [], largeTransactions: [], debts: [] },
        credit: { files: [], previews: [], reports: [], profile: {}, tradelines: [], inquiries: [], publicRecords: [] },
        background: { files: [], previews: [], research: {}, checks: {}, reviews: {}, social: {}, footprint: {}, debt: { positions: [], uccFilings: [] } }
      };
      
      // Reset processing states
      Object.keys(processingState).forEach(key => {
        processingState[key] = { status: 'idle', complete: false, filesProcessing: 0, filesTotal: 0 };
      });
      
      // Clear UI
      document.querySelectorAll('.doc-thumbnails').forEach(el => el.innerHTML = '');
      document.querySelectorAll('[id$="Results"]').forEach(el => el.classList.remove('active'));
      document.getElementById('profileSummary').style.display = 'none';
      
      // Reset form fields
      document.querySelectorAll('input[type="text"], input[type="number"]').forEach(el => {
        if (!el.id?.includes('api') && !el.id?.includes('slider')) {
          el.value = '';
        }
      });
      
      // Update workflow
      updateWorkflowSteps();
      
      // Switch to upload tab
      switchTab('all');
      
      showToast('Ready for new search', 'success');
    }

    function shareApproval() {
      const funding = document.getElementById('sliderFunding').value;
      const factor = document.getElementById('sliderFactor').value;
      const term = document.getElementById('sliderTerm').value;
      const freq = document.getElementById('sliderFreq').value;
      const score = currentUnderwritingResult?.score?.score || 0;
      const tier = currentUnderwritingResult?.score?.tier || 'C';

      const params = new URLSearchParams({
        f: funding, r: factor, t: term, q: freq, s: score, g: tier
      });
      const url = window.location.origin + window.location.pathname + '?calc=' + btoa(params.toString());

      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => showToast('Calculator link copied!', 'success'));
      } else {
        prompt('Copy this link:', url);
      }
    }

    // Check for shared calculator link on load
    function checkSharedCalc() {
      const urlParams = new URLSearchParams(window.location.search);
      const calcData = urlParams.get('calc');
      if (calcData) {
        try {
          const params = new URLSearchParams(atob(calcData));
          switchTab('engine');
          setTimeout(() => {
            document.getElementById('engineResults').style.display = 'block';
            document.getElementById('sliderFunding').value = params.get('f') || 50000;
            document.getElementById('sliderFactor').value = params.get('r') || 1.30;
            document.getElementById('sliderTerm').value = params.get('t') || 9;
            document.getElementById('sliderFreq').value = params.get('q') || 'daily';
            const score = parseInt(params.get('s')) || 65;
            const tier = params.get('g') || 'C';
            document.getElementById('engineScoreValue').textContent = score;
            document.getElementById('engineTierBadge').textContent = `Tier ${tier}`;
            document.getElementById('engineTierBadge').style.background = TIER_COLORS[tier]?.main || '#eab308';
            document.getElementById('engineTierBadge').style.color = '#fff';
            currentUnderwritingResult = { inputs: { revenue: 50000 }, score: { score, tier } };
            updateApprovalPreview();
            showToast('Loaded shared calculator', 'success');
          }, 100);
        } catch (e) { console.error('Invalid calc link'); }
      }
    }

    // Override switchTab to populate engine inputs
    const originalSwitchTab = switchTab;
    switchTab = function(tab) {
      originalSwitchTab(tab);
      if (tab === 'engine') populateEngineInputs();
      if (tab === 'review') updateReviewStatus();
    };

    // Check for shared calc on load
    setTimeout(checkSharedCalc, 500);

    // ========== Final Review Functions ==========
    let currentReviewData = null;

    function updateReviewStatus() {
      // Application status
      const appStatus = document.getElementById('reviewAppStatus');
      const hasApp = data.application && Object.keys(data.application).length > 0;
      appStatus.textContent = hasApp ? 'Ready' : 'Not loaded';
      appStatus.parentElement.classList.toggle('ready', hasApp);

      // Bank status
      const bankStatus = document.getElementById('reviewBankStatus');
      const hasBank = data.bank.months && data.bank.months.length > 0;
      const monthCount = hasBank ? data.bank.months.length : 0;
      bankStatus.textContent = hasBank ? `${monthCount} months` : 'Not loaded';
      bankStatus.parentElement.classList.toggle('ready', hasBank);

      // Credit status
      const creditStatus = document.getElementById('reviewCreditStatus');
      const hasCredit = data.credit && data.credit.extracted?.score;
      creditStatus.textContent = hasCredit ? `Score: ${data.credit.extracted.score}` : 'Not loaded';
      creditStatus.parentElement.classList.toggle('ready', hasCredit);

      // Engine status
      const engineStatus = document.getElementById('reviewEngineStatus');
      const hasEngine = currentUnderwritingResult && currentUnderwritingResult.score;
      if (hasEngine) {
        engineStatus.textContent = `${currentUnderwritingResult.score.tier} (${currentUnderwritingResult.score.score})`;
      } else {
        engineStatus.textContent = 'Not calculated';
      }
      engineStatus.parentElement.classList.toggle('ready', hasEngine);

      // Enable/disable generate button
      const btn = document.getElementById('generateReviewBtn');
      const canGenerate = hasBank || hasApp || hasCredit;
      btn.disabled = !canGenerate;
      btn.style.opacity = canGenerate ? '1' : '0.5';
    }

    async function generateFinalReview() {
      const apiKey = document.getElementById('apiKeyInput').value;
      if (!apiKey) {
        showToast('Please enter Gemini API key', 'error');
        return;
      }

      // Show processing state
      setProcessingState('review', 'processing');
      const overlay = document.getElementById('reviewProcessingOverlay');
      const progressBar = document.getElementById('reviewProgressBar');
      const genBtn = document.getElementById('generateReviewBtn');
      const rerunBtn = document.getElementById('reviewRerunBtn');
      const processingText = document.getElementById('reviewProcessingText');
      
      if (overlay) overlay.classList.add('active');
      if (genBtn) genBtn.disabled = true;
      if (rerunBtn) rerunBtn.disabled = true;
      
      // Animate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 5;
        if (progressBar) progressBar.style.width = Math.min(progress, 90) + '%';
        if (processingText) {
          if (progress < 30) processingText.textContent = 'Compiling data...';
          else if (progress < 60) processingText.textContent = 'Analyzing financials...';
          else processingText.textContent = 'Generating narrative...';
        }
      }, 200);

      // Show loading state
      const contentArea = document.getElementById('reviewContentArea');
      const output = document.getElementById('reviewOutput');
      output.style.display = 'none';
      contentArea.style.display = 'flex';
      contentArea.innerHTML = `
        <div class="review-loading">
          <div class="review-loading-spinner"></div>
          <div class="review-loading-text">Analyzing all documents and generating underwriting review...</div>
        </div>
      `;

      // Compile all data for the prompt
      const reviewData = compileReviewData();
      currentReviewData = reviewData;

      const prompt = buildReviewPrompt(reviewData);

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.7, maxOutputTokens: 4000 }
          })
        });

        if (!response.ok) throw new Error('API request failed');

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';

        // Parse and display the review
        displayReview(text, reviewData);
        
        // Update status
        clearInterval(progressInterval);
        if (progressBar) progressBar.style.width = '100%';
        if (overlay) overlay.classList.remove('active');
        if (genBtn) genBtn.disabled = false;
        if (rerunBtn) rerunBtn.disabled = false;
        setProcessingState('review', 'complete');
        showToast('Review generated successfully', 'success');
        
        // Auto-run compare after review completes
        setTimeout(() => {
          if (!processingState.compare.complete && processingState.compare.status !== 'processing') {
            console.log('Auto-running comparison...');
            runComparison();
          }
        }, 500);

      } catch (error) {
        console.error('Review generation error:', error);
        clearInterval(progressInterval);
        contentArea.innerHTML = `
          <div class="review-placeholder" style="color:var(--tier-e);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;">
              <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <div style="margin-top:16px;">Error generating review. Please try again.</div>
          </div>
        `;
        
        // Update status
        if (overlay) overlay.classList.remove('active');
        if (genBtn) genBtn.disabled = false;
        if (rerunBtn) rerunBtn.disabled = false;
        processingState.review.status = 'idle';
        processingState.review.complete = false;
        updateWorkflowSteps();
        showToast('Error generating review', 'error');
      }
    }

    function compileReviewData() {
      const months = data.bank.months || [];
      const avgRevenue = months.length ? months.reduce((s, m) => s + (parseFloat(m.revenue) || 0), 0) / months.length : 0;
      const avgBalance = months.length ? months.reduce((s, m) => s + (parseFloat(m.avgDailyBal) || 0), 0) / months.length : 0;
      const totalNSF = months.reduce((s, m) => s + (parseInt(m.nsfs) || 0), 0);
      const totalNegDays = months.reduce((s, m) => s + (parseInt(m.negativeDays) || 0), 0);
      const totalDebt = data.bank.debts.reduce((s, d) => s + (parseFloat(d.monthlyPayment) || 0), 0);
      const accounts = Object.keys(data.bank.accounts || {}).length;

      return {
        application: data.application || {},
        bank: {
          months: months.length,
          avgRevenue,
          avgBalance,
          totalNSF,
          totalNegDays,
          totalDebt,
          accounts,
          debts: data.bank.debts || [],
          largeTxns: data.bank.largeTxns || []
        },
        credit: data.credit || {},
        engine: currentUnderwritingResult || null,
        settings: engineSettings
      };
    }

    function buildReviewPrompt(reviewData) {
      const { application, bank, credit, engine } = reviewData;

      let prompt = `You are an expert merchant cash advance underwriter for AblesAI. Analyze the following merchant application and provide a comprehensive underwriting review.

## COLLECTED DATA

### Business Information
${application.businessLegalName ? `- Business Name: ${application.businessLegalName}` : ''}
${application.dba ? `- DBA: ${application.dba}` : ''}
${application.entityType ? `- Entity Type: ${application.entityType}` : ''}
${application.industry ? `- Industry: ${application.industry}` : ''}
${application.businessAddress ? `- Address: ${application.businessAddress}` : ''}
${application.dateEstablished ? `- Established: ${application.dateEstablished}` : ''}
${application.timeInBusiness ? `- Time in Business: ${application.timeInBusiness}` : ''}
${application.ein ? `- EIN: ${application.ein}` : ''}

### Owner Information
${application.ownerName ? `- Owner: ${application.ownerName}` : ''}
${application.ownerTitle ? `- Title: ${application.ownerTitle}` : ''}
${application.ownershipPct ? `- Ownership: ${application.ownershipPct}%` : ''}
${application.ownerDOB ? `- DOB: ${application.ownerDOB}` : ''}
${application.ownerSSN ? `- SSN: ${application.ownerSSN}` : ''}

### Funding Request
${application.fundingAmount ? `- Requested Amount: $${application.fundingAmount}` : ''}
${application.useOfFunds ? `- Use of Funds: ${application.useOfFunds}` : ''}

### Bank Statement Analysis (${bank.months} months analyzed, ${bank.accounts} account${bank.accounts !== 1 ? 's' : ''})
- Average Monthly Revenue: $${bank.avgRevenue.toFixed(2)}
- Average Daily Balance: $${bank.avgBalance.toFixed(2)}
- Total NSF/OD Fees: ${bank.totalNSF}
- Total Negative Balance Days: ${bank.totalNegDays}
- Monthly Debt Obligations: $${bank.totalDebt.toFixed(2)}
${bank.debts.length ? `\nDetected Debts:\n${bank.debts.map(d => `  - ${d.lender}: $${d.monthlyPayment}/mo (${d.type})`).join('\n')}` : ''}
${bank.largeTxns.length ? `\nLarge Transactions Flagged: ${bank.largeTxns.length}` : ''}

### Credit Report
${credit.score ? `- Credit Score: ${credit.score} (${credit.bureau || 'Unknown Bureau'})` : 'No credit data available'}
${credit.summary ? `
- Total Accounts: ${credit.summary.totalAccounts || 0}
- Total Debt: $${credit.summary.totalDebt || 0}
- Utilization: ${credit.summary.utilization || 0}%
- Inquiries: ${credit.summary.inquiries || 0}
- Derogatory Marks: ${credit.summary.derogatoryMarks || 0}` : ''}

### Ables Engine Score
${engine && engine.score ? `
- ABLESCORE: ${engine.score.score}/100 (Tier ${engine.score.tier})
- Probability of Default: ${engine.score.pd}%
- Recommended Funding: $${engine.offer?.funding || 'N/A'}
- Recommended Factor: ${engine.offer?.factor || 'N/A'}
- Recommended Term: ${engine.offer?.termMonths || 'N/A'} months
${engine.offer?.declined ? `- DECLINED: ${engine.offer.declineReason}` : ''}` : 'Engine analysis not yet run'}

## YOUR TASK

Provide a comprehensive underwriting review with the following sections:

1. **Executive Summary** - Brief overview of the application and your recommendation (APPROVE, CONDITIONAL APPROVE, or DECLINE)

2. **Business Assessment** - Analysis of the business viability, industry risk, and time in business

3. **Financial Analysis** - Deep dive into cash flow patterns, revenue consistency, and balance management

4. **Credit Analysis** - Assessment of owner's credit profile and any concerns

5. **Risk Factors** - List and explain any red flags or concerns identified:
   - High NSF/OD activity
   - Negative balance days
   - Existing debt burden
   - Credit concerns
   - Revenue volatility
   - Large unusual transactions

6. **Strengths** - Positive factors supporting approval

7. **Recommendation** - Your final recommendation with:
   - Approval/Decline decision
   - If approved: recommended funding amount, factor rate, and term
   - Any conditions or stipulations required
   - Justification for your recommendation

8. **Additional Notes** - Any other observations or suggestions

Format your response in clean markdown with clear section headers. Use bullet points for lists. Highlight critical concerns. Be specific and reference actual numbers from the data provided.`;

      return prompt;
    }

    function displayReview(text, reviewData) {
      const contentArea = document.getElementById('reviewContentArea');
      const output = document.getElementById('reviewOutput');
      const body = document.getElementById('reviewBody');
      const meta = document.getElementById('reviewMeta');

      // Hide placeholder, show output
      contentArea.style.display = 'none';
      output.style.display = 'block';

      // Set meta info
      const now = new Date();
      meta.textContent = `Generated ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}`;

      // Parse markdown to HTML
      let html = parseMarkdownToHTML(text);

      // Add recommendation styling
      html = html.replace(/<p>([^<]*APPROVE[^<]*)<\/p>/gi, '<div class="recommendation approve">$1</div>');
      html = html.replace(/<p>([^<]*DECLINE[^<]*)<\/p>/gi, '<div class="recommendation decline">$1</div>');
      html = html.replace(/<p>([^<]*CONDITIONAL[^<]*)<\/p>/gi, '<div class="recommendation conditional">$1</div>');

      // Highlight risk levels
      html = html.replace(/\b(HIGH RISK|High Risk)\b/g, '<span class="risk-high">$1</span>');
      html = html.replace(/\b(MEDIUM RISK|Medium Risk|Moderate Risk)\b/g, '<span class="risk-medium">$1</span>');
      html = html.replace(/\b(LOW RISK|Low Risk)\b/g, '<span class="risk-low">$1</span>');

      body.innerHTML = html;
    }

    function parseMarkdownToHTML(text) {
      let html = text
        // Headers
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h2>$1</h2>')
        // Bold
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Bullet lists
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        // Numbered lists
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        // Line breaks
        .replace(/\n/g, '<br>');

      // Wrap in paragraph tags
      html = '<p>' + html + '</p>';

      // Fix list wrapping
      html = html.replace(/(<li>.*?<\/li>)+/gs, match => '<ul>' + match + '</ul>');

      // Clean up empty paragraphs
      html = html.replace(/<p>\s*<\/p>/g, '');
      html = html.replace(/<p><br>/g, '<p>');
      html = html.replace(/<br><\/p>/g, '</p>');

      return html;
    }

    function copyReview() {
      const body = document.getElementById('reviewBody');
      const text = body.innerText;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Review copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy', 'error');
      });
    }

    function regenerateReview() {
      generateFinalReview();
    }

    async function exportReview() {
      const body = document.getElementById('reviewBody');
      const businessName = data.application?.businessLegalName || data.application?.dba || 'Merchant';

      // Create a styled HTML for printing
      const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>Underwriting Review - ${businessName}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; color: #1c1917; line-height: 1.6; }
    h1 { color: #78716c; font-size: 1.5rem; border-bottom: 2px solid #eab308; padding-bottom: 8px; margin-bottom: 24px; }
    h2 { color: #44403c; font-size: 1.1rem; margin-top: 24px; border-bottom: 1px solid #d6d3d1; padding-bottom: 6px; }
    h3 { color: #eab308; font-size: 0.95rem; margin-top: 16px; }
    ul { padding-left: 20px; }
    li { margin: 6px 0; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .header-title { font-size: 1.4rem; font-weight: 700; }
    .header-subtitle { font-size: 0.85rem; color: #78716c; }
    .recommendation { background: #f5f5f4; padding: 12px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #eab308; }
    .risk-high { color: #ef4444; font-weight: 600; }
    .risk-medium { color: #f59e0b; font-weight: 600; }
    .risk-low { color: #22c55e; font-weight: 600; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <div class="header-title">Ables<span style="color:#78716c">AI</span> Underwriting Review</div>
      <div class="header-subtitle">${businessName}</div>
    </div>
    <div class="header-subtitle">${new Date().toLocaleDateString()}</div>
  </div>
  ${body.innerHTML}
</body>
</html>`;

      // Open print dialog
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.onload = () => {
        printWindow.print();
      };
    }

    // ========== RC/TC Compare Functions ==========
    let currentComparison = null;
    let currentApprovalType = 'RC';

    function setApprovalType(type) {
      currentApprovalType = type;
      document.getElementById('extTypeRC').classList.toggle('active', type === 'RC');
      document.getElementById('extTypeTC').classList.toggle('active', type === 'TC');
      document.getElementById('extTypeRC').classList.toggle('rc', type === 'RC');
      document.getElementById('extTypeTC').classList.toggle('tc', type === 'TC');
    }

    function populateCompareInputs() {
      // Populate Ables Engine side from currentUnderwritingResult
      if (currentUnderwritingResult && currentUnderwritingResult.offer && !currentUnderwritingResult.offer.declined) {
        const offer = currentUnderwritingResult.offer;
        const score = currentUnderwritingResult.score;
        const risk = currentUnderwritingResult.risk || {};
        const inputs = currentUnderwritingResult.inputs || {};
        
        const frequency = offer.paymentFreq === 'weekly' ? 'Weekly' : 'Daily';
        const payment = offer.paymentFreq === 'weekly' ? offer.weekly : offer.daily;
        const origFee = offer.fees?.origination || Math.round(offer.funding * 0.03);
        const netFunding = offer.fees?.netWire || (offer.funding - origFee - 995 - 50);
        
        document.getElementById('ablesEngineTier').value = `Tier ${score.tier} (${score.score}/100)`;
        document.getElementById('ablesFunding').value = offer.funding || 0;
        document.getElementById('ablesFactor').value = offer.factor?.toFixed(2) || '';
        document.getElementById('ablesPayback').value = offer.payback || 0;
        document.getElementById('ablesTerm').value = offer.termMonths || '';
        document.getElementById('ablesFrequency').value = frequency;
        document.getElementById('ablesPayment').value = payment || 0;
        document.getElementById('ablesOrigFee').value = origFee;
        document.getElementById('ablesNetFunding').value = netFunding;
        document.getElementById('ablesScore').value = `${score.score}/100 (${risk.pdFormatted || '--'} PD)`;
        document.getElementById('ablesNotes').value = `Tier ${score.tier} approval. DSCR: ${risk.dscrFormatted || '--'}. Risk Level: ${risk.riskLevel || '--'}. Holdback: ${offer.holdback || '--'}%`;
        
        console.log('Populated compare inputs:', { offer, score, risk });
      } else if (currentUnderwritingResult?.offer?.declined) {
        document.getElementById('ablesEngineTier').value = 'DECLINED';
        document.getElementById('ablesNotes').value = currentUnderwritingResult.offer.reason || 'Application declined';
      }

      // Auto-populate criteria from data if available
      if (data.credit?.extracted?.score) {
        const el = document.getElementById('criteriaMinFico');
        if (!el.value) el.placeholder = data.credit.extracted.score;
      }
      if (data.application?.extracted?.timeInBusiness) {
        // Already handled by TIB dropdown
      }
      if (data.bank?.insights?.avgRevenue) {
        const el = document.getElementById('criteriaMinRevenue');
        if (!el.value) el.placeholder = Math.round(data.bank.insights.avgRevenue);
      }
      if (data.bank?.insights?.avgBalance) {
        const el = document.getElementById('criteriaMinADB');
        if (!el.value) el.placeholder = Math.round(data.bank.insights.avgBalance);
      }
    }

    function runComparison() {
      // Show processing state
      setProcessingState('compare', 'processing');
      const overlay = document.getElementById('compareProcessingOverlay');
      const progressBar = document.getElementById('compareProgressBar');
      const runBtn = document.getElementById('compareRunBtn');
      const rerunBtn = document.getElementById('compareRerunBtn');
      
      if (overlay) overlay.classList.add('active');
      if (runBtn) runBtn.disabled = true;
      if (rerunBtn) rerunBtn.disabled = true;
      
      // Animate progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 15;
        if (progressBar) progressBar.style.width = Math.min(progress, 90) + '%';
      }, 80);
      
      // Simulate small delay for UX
      setTimeout(() => {
        clearInterval(progressInterval);
        if (progressBar) progressBar.style.width = '100%';
        
        // Get external values
        const ext = {
          approvalType: currentApprovalType,
          funder: document.getElementById('extFunderName').value || 'External Funder',
          funding: parseFloat(document.getElementById('extFunding').value) || 0,
          factor: parseFloat(document.getElementById('extFactor').value) || 0,
          payback: parseFloat(document.getElementById('extPayback').value) || 0,
          term: parseInt(document.getElementById('extTerm').value) || 0,
          frequency: document.getElementById('extFrequency').value,
          payment: parseFloat(document.getElementById('extPayment').value) || 0,
          origFee: parseFloat(document.getElementById('extOrigFee').value) || 0,
          netFunding: parseFloat(document.getElementById('extNetFunding').value) || 0,
          position: document.getElementById('extPosition').value,
          notes: document.getElementById('extNotes').value
        };

        // Get Ables values
        const ables = {
          tier: document.getElementById('ablesEngineTier').value,
          funding: parseFloat(document.getElementById('ablesFunding').value) || 0,
          factor: parseFloat(document.getElementById('ablesFactor').value) || 0,
          payback: parseFloat(document.getElementById('ablesPayback').value) || 0,
          term: parseInt(document.getElementById('ablesTerm').value) || 0,
          frequency: document.getElementById('ablesFrequency').value,
          payment: parseFloat(document.getElementById('ablesPayment').value) || 0,
          origFee: parseFloat(document.getElementById('ablesOrigFee').value) || 0,
          netFunding: parseFloat(document.getElementById('ablesNetFunding').value) || 0,
          score: document.getElementById('ablesScore').value,
          notes: document.getElementById('ablesNotes').value
        };

        // Get criteria (expanded)
        const criteria = {
          minFico: parseFloat(document.getElementById('criteriaMinFico').value) || 0,
          minTIB: parseInt(document.getElementById('criteriaMinTIB').value) || 0,
          industry: document.getElementById('criteriaIndustry').value,
          minRevenue: parseFloat(document.getElementById('criteriaMinRevenue').value) || 0,
          minADB: parseFloat(document.getElementById('criteriaMinADB').value) || 0,
          minDeposits: parseFloat(document.getElementById('criteriaMinDeposits').value) || 0,
          maxFactor: parseFloat(document.getElementById('criteriaMaxFactor').value) || 999,
          maxHoldback: parseFloat(document.getElementById('criteriaMaxHoldback').value) || 100,
          minTerm: parseInt(document.getElementById('criteriaMinTerm').value) || 0,
          maxExistingDebt: parseFloat(document.getElementById('criteriaMaxExistingDebt').value) || 999999,
          maxDebtService: parseFloat(document.getElementById('criteriaMaxDebtService').value) || 100,
          position: document.getElementById('criteriaPosition').value,
          minNet: parseFloat(document.getElementById('criteriaMinNet').value) || 0,
          approvalType: document.getElementById('criteriaApprovalType').value
        };

        // Calculate derived metrics
        const extHoldback = ext.funding > 0 ? ((ext.payment * (ext.frequency === 'weekly' ? 4.33 : 22)) / (currentUnderwritingResult?.inputs?.revenue || 50000)) * 100 : 0;
        const ablesHoldback = ables.funding > 0 ? ((ables.payment * (ables.frequency === 'Weekly' ? 4.33 : 22)) / (currentUnderwritingResult?.inputs?.revenue || 50000)) * 100 : 0;
        const extNetPct = ext.funding > 0 ? (ext.netFunding / ext.funding) * 100 : 0;
        const ablesNetPct = ables.funding > 0 ? (ables.netFunding / ables.funding) * 100 : 0;
        const extAPR = ext.funding > 0 && ext.term > 0 ? (((ext.payback - ext.funding) / ext.funding) / (ext.term / 12)) * 100 : 0;
        const ablesAPR = ables.funding > 0 && ables.term > 0 ? (((ables.payback - ables.funding) / ables.funding) / (ables.term / 12)) * 100 : 0;

        // Check approval type against criteria
        let approvalTypePass = true;
        if (criteria.approvalType === 'tc' && ext.approvalType !== 'TC') {
          approvalTypePass = false;
        }

        // Build comparison rows
        const rows = [
          { metric: 'Approval Type', ext: ext.approvalType, ables: 'TC', diff: 0, format: 'text', criteria: criteria.approvalType, extVal: ext.approvalType, pass: approvalTypePass },
          { metric: 'Funding Amount', ext: formatCurrency(ext.funding), ables: formatCurrency(ables.funding), diff: ext.funding - ables.funding, format: 'currency', better: 'higher' },
          { metric: 'Factor Rate', ext: ext.factor.toFixed(2), ables: ables.factor.toFixed(2), diff: ext.factor - ables.factor, format: 'factor', better: 'lower', criteria: criteria.maxFactor, extVal: ext.factor, ablesVal: ables.factor },
          { metric: 'Payback Amount', ext: formatCurrency(ext.payback), ables: formatCurrency(ables.payback), diff: ext.payback - ables.payback, format: 'currency', better: 'lower' },
          { metric: 'Term (months)', ext: ext.term, ables: ables.term, diff: ext.term - ables.term, format: 'number', better: 'higher', criteria: criteria.minTerm, extVal: ext.term, ablesVal: ables.term, criteriaType: 'min' },
          { metric: 'Payment Amount', ext: formatCurrency(ext.payment) + ` (${ext.frequency})`, ables: formatCurrency(ables.payment) + ` (${ables.frequency})`, diff: ext.payment - ables.payment, format: 'currency', better: 'lower' },
          { metric: 'Est. Holdback %', ext: extHoldback.toFixed(1) + '%', ables: ablesHoldback.toFixed(1) + '%', diff: extHoldback - ablesHoldback, format: 'pct', better: 'lower', criteria: criteria.maxHoldback, extVal: extHoldback, ablesVal: ablesHoldback },
          { metric: 'Origination Fee', ext: formatCurrency(ext.origFee), ables: formatCurrency(ables.origFee), diff: ext.origFee - ables.origFee, format: 'currency', better: 'lower' },
          { metric: 'Net Funding', ext: formatCurrency(ext.netFunding), ables: formatCurrency(ables.netFunding), diff: ext.netFunding - ables.netFunding, format: 'currency', better: 'higher' },
          { metric: 'Net Funding %', ext: extNetPct.toFixed(1) + '%', ables: ablesNetPct.toFixed(1) + '%', diff: extNetPct - ablesNetPct, format: 'pct', better: 'higher', criteria: criteria.minNet, extVal: extNetPct, ablesVal: ablesNetPct, criteriaType: 'min' },
          { metric: 'Est. APR', ext: extAPR.toFixed(1) + '%', ables: ablesAPR.toFixed(1) + '%', diff: extAPR - ablesAPR, format: 'pct', better: 'lower' },
          { metric: 'Position', ext: ext.position, ables: '1st', diff: 0, format: 'text', criteria: criteria.position, extVal: ext.position }
        ];

        // Render table
        const tbody = document.getElementById('compareTableBody');
        let extWins = 0, ablesWins = 0, criteriaFails = 0;

        tbody.innerHTML = rows.map(row => {
          let diffClass = 'diff-neutral';
          let diffText = '--';
          let status = '';

          if (row.format === 'currency' && row.diff !== 0) {
            const absDiff = Math.abs(row.diff);
            diffText = (row.diff > 0 ? '+' : '-') + formatCurrency(absDiff);
            if (row.better === 'higher') {
              diffClass = row.diff > 0 ? 'diff-positive' : 'diff-negative';
              if (row.diff > 0) extWins++; else ablesWins++;
            } else {
              diffClass = row.diff < 0 ? 'diff-positive' : 'diff-negative';
              if (row.diff < 0) extWins++; else ablesWins++;
            }
          } else if ((row.format === 'factor' || row.format === 'pct' || row.format === 'number') && row.diff !== 0) {
            diffText = (row.diff > 0 ? '+' : '') + row.diff.toFixed(row.format === 'number' ? 0 : 2);
            if (row.format === 'pct') diffText += '%';
            if (row.better === 'higher') {
              diffClass = row.diff > 0 ? 'diff-positive' : 'diff-negative';
              if (row.diff > 0) extWins++; else ablesWins++;
            } else {
              diffClass = row.diff < 0 ? 'diff-positive' : 'diff-negative';
              if (row.diff < 0) extWins++; else ablesWins++;
            }
          }

          // Check criteria
          if (row.criteria !== undefined) {
            if (row.metric === 'Approval Type') {
              let typeOk = true;
              if (row.criteria === 'tc' && row.extVal !== 'TC') typeOk = false;
              if (row.criteria === 'rc' && row.extVal !== 'RC') typeOk = false;
              status = typeOk ? '<span class="status-pass">PASS</span>' : '<span class="status-warn">WARN</span>';
              if (!typeOk && row.criteria === 'tc') criteriaFails++;
            } else if (row.metric === 'Position') {
              const posOk = row.criteria === 'any' || 
                            (row.criteria === '1st' && row.extVal === '1st') ||
                            (row.criteria === '1st-2nd' && (row.extVal === '1st' || row.extVal === '2nd')) ||
                            (row.criteria === '1st-3rd' && (row.extVal === '1st' || row.extVal === '2nd' || row.extVal === '3rd'));
              status = posOk ? '<span class="status-pass">PASS</span>' : '<span class="status-fail">FAIL</span>';
              if (!posOk) criteriaFails++;
            } else if (row.criteriaType === 'min') {
              const extPass = row.extVal >= row.criteria;
              if (!extPass) criteriaFails++;
              status = extPass ? '<span class="status-pass">PASS</span>' : '<span class="status-fail">FAIL</span>';
            } else {
              const extPass = row.extVal <= row.criteria;
              if (!extPass) criteriaFails++;
              status = extPass ? '<span class="status-pass">PASS</span>' : '<span class="status-fail">FAIL</span>';
            }
          }

          return `<tr>
            <td class="metric-name">${row.metric}</td>
            <td>${row.ext}</td>
            <td>${row.ables}</td>
            <td class="${diffClass}">${diffText}</td>
            <td>${status}</td>
          </tr>`;
        }).join('');

        // Render summary
        const summary = document.getElementById('compareSummary');
        const winner = extWins > ablesWins ? 'External' : (ablesWins > extWins ? 'Ables' : 'Tie');
        summary.innerHTML = `
          <div class="compare-summary-title">Comparison Summary</div>
          <div class="compare-summary-grid">
            <div class="compare-summary-card ${winner === 'External' ? 'winner' : ''}">
              <div class="compare-summary-label">External Wins</div>
              <div class="compare-summary-value">${extWins}</div>
            </div>
            <div class="compare-summary-card ${winner === 'Ables' ? 'winner' : ''}">
              <div class="compare-summary-label">Ables Wins</div>
              <div class="compare-summary-value">${ablesWins}</div>
            </div>
            <div class="compare-summary-card ${criteriaFails > 0 ? '' : 'winner'}">
              <div class="compare-summary-label">Criteria Failures</div>
              <div class="compare-summary-value" style="color:${criteriaFails > 0 ? 'var(--tier-e)' : 'var(--tier-a)'}">${criteriaFails}</div>
            </div>
          </div>
        `;

        // Populate client metrics grid
        const clientInputs = currentUnderwritingResult?.inputs || {};
        const clientMetrics = [
          { label: 'FICO', value: clientInputs.credit || data.credit?.extracted?.score || '--' },
          { label: 'TIB (mo)', value: clientInputs.tib || '--' },
          { label: 'Revenue', value: formatCurrency(clientInputs.revenue || 0) },
          { label: 'Avg Daily Bal', value: formatCurrency(clientInputs.balance || 0) },
          { label: 'NSF Count', value: clientInputs.nsf ?? '--' },
          { label: 'Neg Days', value: clientInputs.negDays ?? '--' },
          { label: 'Industry', value: clientInputs.industry || '--' },
          { label: 'Existing Debt', value: formatCurrency(clientInputs.existingDebt || 0) }
        ];
        
        const metricsGrid = document.getElementById('clientMetricsGrid');
        metricsGrid.innerHTML = clientMetrics.map(m => `
          <div style="background: var(--bg-primary); padding: 10px 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent);">${m.value}</div>
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 2px;">${m.label}</div>
          </div>
        `).join('');

        // Show results, hide placeholder
        document.getElementById('compareResults').style.display = 'block';
        document.getElementById('comparePlaceholder').style.display = 'none';
        document.getElementById('compareMeta').textContent = `${ext.approvalType} Comparison  Generated ${new Date().toLocaleString()}`;

        // Update table header to show approval type
        document.querySelector('.compare-table thead th:nth-child(2)').textContent = `External (${ext.approvalType})`;

        // Store comparison with client metrics
        currentComparison = { 
          ext, ables, criteria, rows, extWins, ablesWins, criteriaFails, 
          timestamp: Date.now(),
          clientMetrics: clientInputs,
          businessName: data.application?.extracted?.business?.legalName || data.application?.extracted?.business?.dba || 'Unknown Business'
        };
        
        // Update status
        if (overlay) overlay.classList.remove('active');
        if (runBtn) runBtn.disabled = false;
        if (rerunBtn) rerunBtn.disabled = false;
        setProcessingState('compare', 'complete');
        showToast('Comparison complete', 'success');
      }, 400);
    }

    function saveComparison() {
      if (!currentComparison) {
        showToast('Run comparison first', 'error');
        return;
      }

      const businessName = data.application?.businessLegalName || data.application?.dba || 'Merchant';
      const saved = JSON.parse(localStorage.getItem('saved_comparisons') || '[]');
      saved.push({
        ...currentComparison,
        businessName,
        savedAt: Date.now()
      });
      localStorage.setItem('saved_comparisons', JSON.stringify(saved));
      showToast('Comparison saved', 'success');
    }

    function loadSavedComparison() {
      const saved = JSON.parse(localStorage.getItem('saved_comparisons') || '[]');
      if (!saved.length) {
        showToast('No saved comparisons found', 'error');
        return;
      }

      // Load most recent
      const latest = saved[saved.length - 1];
      
      // Populate external fields
      document.getElementById('extFunderName').value = latest.ext.funder || '';
      document.getElementById('extFunding').value = latest.ext.funding || '';
      document.getElementById('extFactor').value = latest.ext.factor || '';
      document.getElementById('extPayback').value = latest.ext.payback || '';
      document.getElementById('extTerm').value = latest.ext.term || '';
      document.getElementById('extFrequency').value = latest.ext.frequency || 'daily';
      document.getElementById('extPayment').value = latest.ext.payment || '';
      document.getElementById('extOrigFee').value = latest.ext.origFee || '';
      document.getElementById('extNetFunding').value = latest.ext.netFunding || '';
      document.getElementById('extPosition').value = latest.ext.position || '1st';
      document.getElementById('extNotes').value = latest.ext.notes || '';

      // Populate criteria
      if (latest.criteria) {
        document.getElementById('criteriaMaxFactor').value = latest.criteria.maxFactor < 999 ? latest.criteria.maxFactor : '';
        document.getElementById('criteriaMaxHoldback').value = latest.criteria.maxHoldback < 100 ? latest.criteria.maxHoldback : '';
        document.getElementById('criteriaMinTerm').value = latest.criteria.minTerm > 0 ? latest.criteria.minTerm : '';
        document.getElementById('criteriaMaxDebtService').value = latest.criteria.maxDebtService < 100 ? latest.criteria.maxDebtService : '';
        document.getElementById('criteriaPosition').value = latest.criteria.position || 'any';
        document.getElementById('criteriaMinNet').value = latest.criteria.minNet > 0 ? latest.criteria.minNet : '';
      }

      showToast(`Loaded comparison for ${latest.businessName}`, 'success');
    }

    function shareComparison() {
      if (!currentComparison) {
        showToast('Run comparison first', 'error');
        return;
      }

      // Encode full comparison data for static shareable view
      const shareData = {
        v: 2, // Version for future compatibility
        ts: currentComparison.timestamp,
        biz: currentComparison.businessName,
        ext: currentComparison.ext,
        ables: currentComparison.ables,
        client: currentComparison.clientMetrics,
        rows: currentComparison.rows.map(r => ({
          m: r.metric, e: r.ext, a: r.ables, d: r.diff
        })),
        summary: {
          extWins: currentComparison.extWins,
          ablesWins: currentComparison.ablesWins,
          fails: currentComparison.criteriaFails
        }
      };
      
      const encoded = btoa(encodeURIComponent(JSON.stringify(shareData)));
      const url = `${window.location.origin}${window.location.pathname}?comparison=${encoded}`;
      
      navigator.clipboard.writeText(url).then(() => {
        showToast('Share link copied to clipboard', 'success');
      }).catch(() => {
        // Fallback - show in prompt
        prompt('Copy this share link:', url);
      });
    }

    function loadSharedComparison(encoded) {
      const decoded = JSON.parse(decodeURIComponent(atob(encoded)));
      
      // Switch to compare tab
      switchTab('compare');
      
      // Build the static comparison view
      const ext = decoded.ext || {};
      const ables = decoded.ables || {};
      const client = decoded.client || {};
      const rows = decoded.rows || [];
      const summary = decoded.summary || {};
      const businessName = decoded.biz || 'Unknown Business';
      const timestamp = decoded.ts ? new Date(decoded.ts).toLocaleString() : 'Unknown';
      
      // Populate client metrics grid
      const clientMetrics = [
        { label: 'FICO', value: client.credit || '--' },
        { label: 'TIB (mo)', value: client.tib || '--' },
        { label: 'Revenue', value: client.revenue ? formatCurrency(client.revenue) : '--' },
        { label: 'Avg Daily Bal', value: client.balance ? formatCurrency(client.balance) : '--' },
        { label: 'NSF Count', value: client.nsf ?? '--' },
        { label: 'Neg Days', value: client.negDays ?? '--' },
        { label: 'Industry', value: client.industry || '--' },
        { label: 'Existing Debt', value: client.existingDebt ? formatCurrency(client.existingDebt) : '--' }
      ];
      
      const metricsGrid = document.getElementById('clientMetricsGrid');
      metricsGrid.innerHTML = clientMetrics.map(m => `
        <div style="background: var(--bg-primary); padding: 10px 12px; border-radius: 8px; text-align: center;">
          <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent);">${m.value}</div>
          <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-top: 2px;">${m.label}</div>
        </div>
      `).join('');
      
      // Populate comparison table
      const tbody = document.getElementById('compareTableBody');
      tbody.innerHTML = rows.map(row => `
        <tr>
          <td class="metric-name">${row.m}</td>
          <td>${row.e}</td>
          <td>${row.a}</td>
          <td class="diff-neutral">${row.d !== 0 ? (row.d > 0 ? '+' : '') + (typeof row.d === 'number' ? row.d.toFixed(2) : row.d) : '--'}</td>
          <td></td>
        </tr>
      `).join('');
      
      // Populate summary
      const summaryEl = document.getElementById('compareSummary');
      const winner = summary.extWins > summary.ablesWins ? 'External' : (summary.ablesWins > summary.extWins ? 'Ables' : 'Tie');
      summaryEl.innerHTML = `
        <div class="compare-summary-title">Comparison Summary</div>
        <div class="compare-summary-grid">
          <div class="compare-summary-card ${winner === 'External' ? 'winner' : ''}">
            <div class="compare-summary-label">External Wins</div>
            <div class="compare-summary-value">${summary.extWins || 0}</div>
          </div>
          <div class="compare-summary-card ${winner === 'Ables' ? 'winner' : ''}">
            <div class="compare-summary-label">Ables Wins</div>
            <div class="compare-summary-value">${summary.ablesWins || 0}</div>
          </div>
          <div class="compare-summary-card ${summary.fails > 0 ? '' : 'winner'}">
            <div class="compare-summary-label">Criteria Failures</div>
            <div class="compare-summary-value" style="color:${summary.fails > 0 ? 'var(--tier-e)' : 'var(--tier-a)'}">${summary.fails || 0}</div>
          </div>
        </div>
      `;
      
      // Update header
      document.getElementById('compareMeta').textContent = `${ext.approvalType || 'RC'} Comparison  ${businessName}  Shared ${timestamp}`;
      
      // Update table header
      const thElement = document.querySelector('.compare-table thead th:nth-child(2)');
      if (thElement) thElement.textContent = `External (${ext.approvalType || 'RC'})`;
      
      // Show results, hide placeholder and inputs
      document.getElementById('compareResults').style.display = 'block';
      document.getElementById('comparePlaceholder').style.display = 'none';
      
      // Hide input sections and show "Shared View" banner
      const inputsSection = document.querySelector('.compare-inputs');
      if (inputsSection) inputsSection.style.display = 'none';
      
      const criteriaSection = document.querySelector('.compare-criteria');
      if (criteriaSection) criteriaSection.style.display = 'none';
      
      // Add shared view banner
      const resultsHeader = document.querySelector('.compare-results-header');
      if (resultsHeader && !document.getElementById('sharedBanner')) {
        const banner = document.createElement('div');
        banner.id = 'sharedBanner';
        banner.style.cssText = 'background: linear-gradient(135deg, rgba(234,179,8,0.2), rgba(234,179,8,0.1)); border: 1px solid rgba(234,179,8,0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;';
        banner.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;color:var(--accent);flex-shrink:0;">
            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
          </svg>
          <div>
            <div style="font-weight:600;color:var(--accent);">Shared Comparison View</div>
            <div style="font-size:0.8rem;color:var(--text-muted);">This is a read-only snapshot shared on ${timestamp}</div>
          </div>
          <button class="btn btn-secondary" onclick="window.location.href=window.location.pathname" style="margin-left:auto;">
            Start New Analysis
          </button>
        `;
        resultsHeader.parentNode.insertBefore(banner, resultsHeader);
      }
      
      showToast('Shared comparison loaded', 'success');
    }

    function exportComparison() {
      if (!currentComparison) {
        showToast('Run comparison first', 'error');
        return;
      }

      const businessName = currentComparison.businessName || data.application?.businessLegalName || data.application?.dba || 'Merchant';
      const { ext, ables, rows, extWins, ablesWins, criteriaFails, clientMetrics } = currentComparison;
      const client = clientMetrics || {};

      const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>RC/TC Comparison - ${businessName}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 40px; color: #1c1917; }
    h1 { color: #78716c; font-size: 1.4rem; border-bottom: 2px solid #eab308; padding-bottom: 8px; margin-bottom: 24px; }
    h2 { color: #78716c; font-size: 1.1rem; margin-top: 32px; }
    .header { display: flex; justify-content: space-between; margin-bottom: 32px; }
    .header-title { font-size: 1.4rem; font-weight: 700; }
    .header-sub { font-size: 0.85rem; color: #78716c; }
    .client-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; background: #f5f5f4; padding: 16px; border-radius: 8px; }
    .client-metric { text-align: center; }
    .client-metric-value { font-size: 1.2rem; font-weight: 700; color: #eab308; }
    .client-metric-label { font-size: 0.7rem; text-transform: uppercase; color: #78716c; }
    table { width: 100%; border-collapse: collapse; margin: 24px 0; }
    th, td { padding: 10px 12px; border: 1px solid #d6d3d1; text-align: left; }
    th { background: #f5f5f4; font-size: 0.75rem; text-transform: uppercase; }
    .positive { color: #22c55e; }
    .negative { color: #ef4444; }
    .summary { display: flex; gap: 24px; margin-top: 24px; }
    .summary-card { flex: 1; background: #f5f5f4; padding: 16px; border-radius: 8px; text-align: center; }
    .summary-label { font-size: 0.7rem; text-transform: uppercase; color: #78716c; }
    .summary-value { font-size: 1.5rem; font-weight: 700; margin-top: 4px; }
    @media print { body { padding: 20px; } }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <div class="header-title">Ables<span style="color:#78716c">AI</span> RC/TC Comparison</div>
      <div class="header-sub">${businessName}</div>
    </div>
    <div class="header-sub">${new Date().toLocaleDateString()}</div>
  </div>
  
  <h2>Client Profile</h2>
  <div class="client-metrics">
    <div class="client-metric"><div class="client-metric-value">${client.credit || '--'}</div><div class="client-metric-label">FICO Score</div></div>
    <div class="client-metric"><div class="client-metric-value">${client.tib || '--'}</div><div class="client-metric-label">TIB (months)</div></div>
    <div class="client-metric"><div class="client-metric-value">$${(client.revenue || 0).toLocaleString()}</div><div class="client-metric-label">Revenue</div></div>
    <div class="client-metric"><div class="client-metric-value">$${(client.balance || 0).toLocaleString()}</div><div class="client-metric-label">Avg Daily Bal</div></div>
    <div class="client-metric"><div class="client-metric-value">${client.nsf ?? '--'}</div><div class="client-metric-label">NSF Count</div></div>
    <div class="client-metric"><div class="client-metric-value">${client.negDays ?? '--'}</div><div class="client-metric-label">Neg Days</div></div>
    <div class="client-metric"><div class="client-metric-value">${client.industry || '--'}</div><div class="client-metric-label">Industry</div></div>
    <div class="client-metric"><div class="client-metric-value">$${(client.existingDebt || 0).toLocaleString()}</div><div class="client-metric-label">Existing Debt</div></div>
  </div>
  
  <h1>External Approval: ${ext.funder}</h1>
  
  <table>
    <tr><th>Metric</th><th>External (${ext.funder})</th><th>Ables Engine</th><th>Difference</th></tr>
    ${rows.map(r => `<tr><td>${r.metric}</td><td>${r.ext}</td><td>${r.ables}</td><td>${typeof r.diff === 'number' && r.diff !== 0 ? (r.diff > 0 ? '+' : '') + r.diff.toFixed(2) : '--'}</td></tr>`).join('')}
  </table>
  
  <div class="summary">
    <div class="summary-card"><div class="summary-label">External Wins</div><div class="summary-value">${extWins}</div></div>
    <div class="summary-card"><div class="summary-label">Ables Wins</div><div class="summary-value">${ablesWins}</div></div>
    <div class="summary-card"><div class="summary-label">Criteria Failures</div><div class="summary-value" style="color:${criteriaFails > 0 ? '#ef4444' : '#22c55e'}">${criteriaFails}</div></div>
  </div>
  
  ${ext.notes ? `<h2 style="margin-top:32px;font-size:1rem;">External Notes</h2><p>${ext.notes}</p>` : ''}
</body>
</html>`;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.onload = () => printWindow.print();
    }

    // Check for shared comparison link
    function checkSharedComparison() {
      const params = new URLSearchParams(window.location.search);
      const compareData = params.get('compare');
      if (compareData) {
        try {
          const decoded = JSON.parse(atob(compareData));
          
          // Populate external fields
          if (decoded.ext) {
            document.getElementById('extFunderName').value = decoded.ext.funder || '';
            document.getElementById('extFunding').value = decoded.ext.funding || '';
            document.getElementById('extFactor').value = decoded.ext.factor || '';
            document.getElementById('extPayback').value = decoded.ext.payback || '';
            document.getElementById('extTerm').value = decoded.ext.term || '';
            document.getElementById('extFrequency').value = decoded.ext.frequency || 'daily';
            document.getElementById('extPayment').value = decoded.ext.payment || '';
            document.getElementById('extOrigFee').value = decoded.ext.origFee || '';
            document.getElementById('extNetFunding').value = decoded.ext.netFunding || '';
            document.getElementById('extPosition').value = decoded.ext.position || '1st';
            document.getElementById('extNotes').value = decoded.ext.notes || '';
          }

          if (decoded.criteria) {
            document.getElementById('criteriaMaxFactor').value = decoded.criteria.maxFactor < 999 ? decoded.criteria.maxFactor : '';
            document.getElementById('criteriaMaxHoldback').value = decoded.criteria.maxHoldback < 100 ? decoded.criteria.maxHoldback : '';
            document.getElementById('criteriaMinTerm').value = decoded.criteria.minTerm > 0 ? decoded.criteria.minTerm : '';
            document.getElementById('criteriaMaxDebtService').value = decoded.criteria.maxDebtService < 100 ? decoded.criteria.maxDebtService : '';
            document.getElementById('criteriaPosition').value = decoded.criteria.position || 'any';
            document.getElementById('criteriaMinNet').value = decoded.criteria.minNet > 0 ? decoded.criteria.minNet : '';
          }

          // Switch to compare tab
          switchTab('compare');
          showToast('Loaded shared comparison', 'success');
        } catch (e) {
          console.error('Invalid comparison link');
        }
      }
    }

    // Update switchTab to handle compare tab
    const baseSwitchTab = switchTab;
    switchTab = function(tab) {
      baseSwitchTab(tab);
      if (tab === 'compare') {
        populateCompareInputs();
      }
    };

    // Check for shared comparison on load
    setTimeout(checkSharedComparison, 600);
  </script>
</body>
</html>
