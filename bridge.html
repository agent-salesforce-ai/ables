
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bridge - Sutton Funding</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-panel: #12121a;
            --bg-card: #16161f;
            --bg-input: #1a1a24;
            --border: #2a2a3a;
            --text: #e0e0e0;
            --text-dim: #888;
            --text-muted: #555;
            --gold: #d4af37;
            --gold-light: #f4e4a6;
            --red: #e74c3c;
            --green: #27ae60;
            --orange: #f39c12;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); min-height: 100vh; color: var(--text); }

        /* Header */
        header { text-align: center; padding: 20px; border-bottom: 1px solid var(--gold); }
        header img { height: 40px; margin-bottom: 5px; }
        h1 { font-size: 28px; background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 3px; }
        .tagline { color: var(--text-dim); font-size: 10px; letter-spacing: 3px; text-transform: uppercase; }

        /* Layout */
        .container { display: grid; grid-template-columns: 320px 1fr; min-height: calc(100vh - 100px); }

        /* Sidebar */
        .sidebar { background: var(--bg-panel); padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-title { color: var(--gold); font-size: 10px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; }

        .upload-zone {
            border: 2px dashed var(--border); border-radius: 10px; padding: 25px; text-align: center;
            cursor: pointer; transition: all 0.3s; background: var(--bg-input); margin-bottom: 15px;
        }
        .upload-zone:hover { border-color: var(--gold); background: rgba(212,175,55,0.05); }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 32px; opacity: 0.5; }
        .upload-text { color: var(--text-dim); font-size: 12px; margin-top: 8px; }
        .upload-text span { color: var(--gold); }

        .file-list { flex: 1; overflow-y: auto; margin-bottom: 15px; }
        .file-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: var(--bg-input); border-radius: 8px; margin-bottom: 6px;
            border-left: 3px solid var(--border); cursor: pointer;
        }
        .file-item:hover { background: var(--bg-card); }
        .file-item.active { border-left-color: var(--gold); }
        .file-item.clean { border-left-color: var(--green); }
        .file-item.warning { border-left-color: var(--orange); }
        .file-item.danger { border-left-color: var(--red); }
        .file-thumb { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; background: var(--border); }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-meta { font-size: 10px; color: var(--text-muted); }
        .file-badge { font-size: 8px; padding: 2px 6px; border-radius: 8px; font-weight: 600; text-transform: uppercase; }
        .file-badge.clean { background: rgba(39,174,96,0.2); color: var(--green); }
        .file-badge.warning { background: rgba(243,156,18,0.2); color: var(--orange); }
        .file-badge.danger { background: rgba(231,76,60,0.2); color: var(--red); }
        .file-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; }
        .file-remove:hover { color: var(--red); }

        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 12px;
            font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;
        }
        .btn-gold { background: linear-gradient(135deg, var(--gold), #b8960c); color: var(--bg-primary); }
        .btn-gold:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(212,175,55,0.3); }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { border-color: var(--gold); color: var(--gold); }

        /* Main Content */
        .main { padding: 20px; overflow-y: auto; }

        /* Preview Section */
        .preview-section { margin-bottom: 25px; }
        .preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-title { color: var(--gold); font-size: 11px; text-transform: uppercase; letter-spacing: 2px; }
        .preview-box {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            min-height: 450px; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .preview-box canvas { max-width: 100%; max-height: 550px; }
        .placeholder { text-align: center; color: var(--text-muted); }
        .placeholder-icon { font-size: 48px; opacity: 0.3; margin-bottom: 10px; }

        /* Watermark Controls */
        .watermark-controls { display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
        .control { flex: 1; min-width: 120px; }
        .control label { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .control label span { color: var(--gold); }
        .control input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            outline: none;
            background: linear-gradient(to right, var(--gold) 0%, var(--border) 0%);
        }
        .control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .control input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .control input[type="range"]::-moz-range-progress {
            background: var(--gold);
            height: 6px;
            border-radius: 3px;
        }
        .control input[type="range"]::-moz-range-track {
            background: var(--border);
            height: 6px;
            border-radius: 3px;
        }
        .btn-save-defaults {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: auto;
        }
        .btn-save-defaults:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Bank Data Section */
        .bank-data { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 25px; }
        .data-box {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
            padding: 15px; text-align: center;
        }
        .data-box.highlight { border-color: var(--gold); background: rgba(212,175,55,0.05); }
        .data-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .data-value { font-size: 18px; font-weight: 700; color: var(--gold); }

        /* Lender Results */
        .lenders-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .match-count { color: var(--green); font-size: 12px; font-weight: 600; }

        .lender-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .lender-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; transition: all 0.2s;
        }
        .lender-card:hover { border-color: var(--gold); }
        .lender-card.high { border-left: 4px solid var(--green); }
        .lender-card.medium { border-left: 4px solid var(--orange); }
        .lender-card.low { border-left: 4px solid var(--red); opacity: 0.6; }

        .lender-top { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .lender-name { font-size: 14px; font-weight: 700; }
        .lender-match { padding: 3px 10px; border-radius: 10px; font-size: 10px; font-weight: 700; }
        .lender-match.high { background: rgba(39,174,96,0.2); color: var(--green); }
        .lender-match.medium { background: rgba(243,156,18,0.2); color: var(--orange); }
        .lender-match.low { background: rgba(231,76,60,0.2); color: var(--red); }

        .lender-terms { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .term { text-align: center; }
        .term-label { font-size: 8px; color: var(--text-muted); text-transform: uppercase; }
        .term-value { font-size: 13px; font-weight: 700; color: var(--text); }
        .term-value.gold { color: var(--gold); }

        .lender-bottom { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid var(--border); }
        .lender-method { font-size: 11px; color: var(--text-dim); }
        .lender-method a { color: var(--gold); text-decoration: none; }
        .lender-method code { background: rgba(212,175,55,0.15); padding: 2px 6px; border-radius: 4px; color: var(--gold); cursor: pointer; font-size: 10px; }
        .lender-freq { font-size: 10px; color: var(--text-muted); }

        /* Settings */
        .settings-btn { position: fixed; top: 20px; right: 20px; width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-dim); cursor: pointer; font-size: 16px; z-index: 100; }
        .settings-btn:hover { border-color: var(--gold); color: var(--gold); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 25px; width: 90%; max-width: 400px; }
        .modal-title { color: var(--gold); font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; }
        .modal-close { float: right; background: none; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
        .input-group input { width: 100%; padding: 10px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; }
        .input-group input:focus { outline: none; border-color: var(--gold); }
        .input-group small { display: block; margin-top: 4px; font-size: 10px; color: var(--text-muted); }

        /* Download file list */
        .download-file-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border-radius: 8px; margin-bottom: 8px; }
        .download-file-thumb { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; background: var(--border); flex-shrink: 0; }
        .download-file-input { flex: 1; padding: 8px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 13px; }
        .download-file-input:focus { outline: none; border-color: var(--gold); }
        .download-file-ext { color: var(--text-muted); font-size: 12px; flex-shrink: 0; }

        /* Status Toast */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; font-size: 13px; z-index: 100; display: none; }
        .toast.success { border-color: var(--green); color: var(--green); }
        .toast.error { border-color: var(--red); color: var(--red); }

        /* Responsive */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { border-right: none; border-bottom: 1px solid var(--border); }
            .bank-data { grid-template-columns: repeat(2, 1fr); }
            .lender-terms { grid-template-columns: repeat(2, 1fr); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-input); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <header>
        <img src="https://i.imgur.com/MXMqYLc.png" alt="Sutton Funding">
        <h1>THE BRIDGE</h1>
        <div class="tagline">Upload • Watermark • Match • Submit</div>
    </header>

    <button class="settings-btn" onclick="openSettings()">⚙</button>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-title">Bank Statements</div>

            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" multiple accept="image/*,.pdf">
                <div class="upload-text">Drop files or <span>browse</span></div>
            </div>

            <button class="btn btn-gold" id="processBtn" disabled onclick="processAll()">
                Process & Match Lenders
            </button>
            <button class="btn btn-outline" id="downloadBtn" disabled onclick="openDownloadModal()">
                Download Watermarked
            </button>

            <div class="file-list" id="fileList"></div>
        </div>

        <!-- Main Content -->
        <div class="main">
            <!-- Preview -->
            <div class="preview-section">
                <div class="preview-header">
                    <div class="section-title">Preview</div>
                </div>
                <div class="preview-box" id="previewBox">
                    <div class="placeholder">
                        <div>Upload bank statements to preview</div>
                    </div>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <div class="watermark-controls">
                    <div class="control">
                        <label>Opacity <span id="opacityVal">25%</span></label>
                        <input type="range" id="opacity" min="5" max="50" value="25">
                    </div>
                    <div class="control">
                        <label>Size <span id="sizeVal">15%</span></label>
                        <input type="range" id="size" min="5" max="40" value="15">
                    </div>
                    <div class="control">
                        <label>Density <span id="densityVal">50%</span></label>
                        <input type="range" id="density" min="20" max="80" value="50">
                    </div>
                    <div class="control">
                        <label>Rotation <span id="rotationVal">45°</span></label>
                        <input type="range" id="rotation" min="0" max="90" value="45">
                    </div>
                    <button class="btn-save-defaults" onclick="saveDefaults()">Save as Default</button>
                </div>
            </div>

            <!-- Bank Data (hidden until processed) -->
            <div id="resultsSection" style="display:none;">
                <div class="section-title" style="margin-bottom:12px;">Extracted Bank Data</div>
                <div class="bank-data">
                    <div class="data-box highlight">
                        <div class="data-label">Monthly Deposits</div>
                        <div class="data-value" id="dataDeposits">--</div>
                    </div>
                    <div class="data-box">
                        <div class="data-label">Avg Daily Balance</div>
                        <div class="data-value" id="dataADB">--</div>
                    </div>
                    <div class="data-box">
                        <div class="data-label">NSF/Negatives</div>
                        <div class="data-value" id="dataNSF">--</div>
                    </div>
                    <div class="data-box">
                        <div class="data-label"># Deposits</div>
                        <div class="data-value" id="dataNumDeps">--</div>
                    </div>
                </div>

                <!-- Lender Results -->
                <div class="lenders-header">
                    <div class="section-title">Matched Lenders</div>
                    <div class="match-count" id="matchCount"></div>
                </div>
                <div class="lender-grid" id="lenderGrid"></div>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal" id="downloadModal">
        <div class="modal-box" style="max-width:500px;">
            <button class="modal-close" onclick="closeDownloadModal()">×</button>
            <div class="modal-title">Download Files</div>
            <div id="downloadFileList" style="margin-bottom:20px;max-height:300px;overflow-y:auto;"></div>
            <button class="btn btn-gold" onclick="downloadWithNames()">Download All</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-box">
            <button class="modal-close" onclick="closeSettings()">×</button>
            <div class="modal-title">Settings</div>
            <div class="input-group">
                <label>Gemini API Key</label>
                <input type="password" id="apiKey" placeholder="Enter API key...">
                <small>Required for fraud detection & OCR</small>
            </div>
            <div class="input-group">
                <label>Watermark Image URL</label>
                <input type="url" id="watermarkUrl" placeholder="https://...">
            </div>
            <div class="input-group">
                <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                    <input type="checkbox" id="verifiedBadge" style="width:auto;">
                    <span style="text-transform:none;font-size:13px;letter-spacing:0;">Show Verified Badge on Clean Documents</span>
                </label>
                <small>Overlays a verification stamp on documents that pass fraud check</small>
            </div>
            <button class="btn btn-gold" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Lender data
        const lenders = [
            {name:"Kapitus",method:"portal",portal:"https://partner.kapitus.com",min_rate:1.15,max_rate:1.35,min_term:6,max_term:24,max_amount:200000,avg_amount:67625,frequency:"Weekly",notes:"File must be clean, best rates"},
            {name:"Ondeck",method:"portal",portal:"https://partner.ondeck.com",min_rate:1.20,max_rate:1.35,min_term:6,max_term:24,max_amount:250000,avg_amount:91250,frequency:"Weekly"},
            {name:"Kalamata Capital",min_credit:600,min_tib:12,min_deposits:40000,min_num_deps:5,min_adb:5000,max_nsf:3,method:"email",email:"submissions@kalamatacapital.com",min_rate:1.18,max_rate:1.45,min_term:6,max_term:15,max_amount:275000,avg_amount:275000,frequency:"Weekly",notes:"Quick turnaround, white label"},
            {name:"Trust Capital Funding",min_credit:550,min_tib:6,min_deposits:20000,min_num_deps:10,min_adb:2500,max_nsf:3,method:"email",email:"submissions@trustcapitalfunding.com",min_rate:1.28,max_rate:1.42,min_term:6,max_term:12,max_amount:480000,avg_amount:58577,frequency:"Daily",notes:"White label available"},
            {name:"JRG Funding",min_credit:500,min_tib:12,min_deposits:15000,min_num_deps:4,min_adb:1000,max_nsf:4,method:"email",email:"deals@jrgfunding.com",min_rate:1.29,max_rate:1.40,min_term:3,max_term:12,max_amount:200000,avg_amount:142500,frequency:"Weekly"},
            {name:"eFinancial Tree",min_credit:500,min_tib:6,min_deposits:15000,min_num_deps:2,min_adb:1000,max_nsf:3,method:"email",email:"submit@efinancialtree.com",min_rate:1.30,max_rate:1.45,min_term:3,max_term:10,max_amount:105000,avg_amount:85000,frequency:"Weekly",notes:"White label, offers weeklys"},
            {name:"Reliable Capital",min_credit:525,min_tib:12,min_deposits:25000,max_nsf:3,method:"email",email:"submit@reliablecapital.com",min_rate:1.35,max_rate:1.42,min_term:6,max_term:12,max_amount:45000,frequency:"Weekly"},
            {name:"Alternative Funding Group",min_credit:550,min_tib:12,min_deposits:20000,min_num_deps:4,min_adb:1000,max_nsf:4,method:"email",email:"deals@altfundinggroup.com",min_rate:1.37,max_rate:1.46,min_term:4,max_term:10,max_amount:150000,frequency:"Weekly",notes:"Reverses available"},
            {name:"Forward Financing",method:"portal",portal:"https://broker.forwardfinancing.com",min_rate:1.37,max_rate:1.51,min_term:4,max_term:15,max_amount:65000,frequency:"Weekly"},
            {name:"Credibly",method:"portal",portal:"https://portal.credibly.com",min_rate:1.40,max_rate:1.49,min_term:6,max_term:18,max_amount:116200,frequency:"Weekly"},
            {name:"Silverline Funding",min_credit:500,min_tib:5,min_deposits:25000,min_adb:1000,max_nsf:3,method:"email",email:"submissions@silverlinefunding.com",min_rate:1.40,max_rate:1.48,min_term:3,max_term:12,max_amount:15000,frequency:"Weekly"},
            {name:"1DC Funding",method:"email",email:"submissions@1dcfunding.com",min_rate:1.45,max_rate:1.60,min_term:3,max_term:12,max_amount:260000,frequency:"Daily"},
            {name:"Fundfi",min_tib:12,min_deposits:35000,min_num_deps:6,max_nsf:5,method:"email",email:"submit@fundfi.com",min_rate:1.45,max_rate:1.46,min_term:6,max_term:12,max_amount:85000,frequency:"Daily"},
            {name:"Wide Merchant Group",min_credit:480,min_tib:6,min_deposits:8000,min_num_deps:2,min_adb:750,max_nsf:0,method:"email",email:"deals@widemerchantgroup.com",min_rate:1.46,max_rate:1.49,min_term:3,max_term:9,max_amount:25000,frequency:"Daily",notes:"No NSFs allowed"},
            {name:"Rapid Finance",min_credit:620,min_tib:36,min_deposits:10000,method:"portal",portal:"https://portal.rapidfinance.com",min_rate:1.28,max_rate:1.48,min_term:3,max_term:12,max_amount:400000,frequency:"Weekly"},
            {name:"Bitty Advance",min_credit:500,min_tib:12,min_deposits:5000,max_nsf:7,method:"email",email:"submissions@bittyadvance.com",min_rate:1.55,max_rate:1.59,min_term:2,max_term:6,max_amount:35000,frequency:"Daily",notes:"Multi-tier programs"},
            {name:"Smart Step Funding",min_credit:600,min_tib:24,min_deposits:10000,min_num_deps:6,method:"email",email:"deals@smartstepfunding.com",min_rate:1.25,max_rate:1.35,min_term:9,max_term:17,max_amount:110000,frequency:"Weekly"}
        ];

        // State
        let files = [];
        let activeIdx = -1;
        let logo = null;
        let bankData = null;
        let settings = { opacity: 0.25, size: 0.15, density: 0.50, rotation: 45 };
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Init
        function init() {
            document.getElementById('apiKey').value = localStorage.getItem('gemini_key') || '';
            document.getElementById('watermarkUrl').value = localStorage.getItem('watermark_url') || 'https://i.imgur.com/MXMqYLc.png';
            document.getElementById('verifiedBadge').checked = localStorage.getItem('verified_badge') === 'true';
            loadLogo(localStorage.getItem('watermark_url') || 'https://i.imgur.com/MXMqYLc.png');

            const zone = document.getElementById('uploadZone');
            zone.onclick = () => document.getElementById('fileInput').click();
            zone.ondragover = e => { e.preventDefault(); zone.style.borderColor = 'var(--gold)'; };
            zone.ondragleave = () => zone.style.borderColor = '';
            zone.ondrop = e => { e.preventDefault(); zone.style.borderColor = ''; handleFiles(e.dataTransfer.files); };
            document.getElementById('fileInput').onchange = e => handleFiles(e.target.files);

            ['opacity','size','density','rotation'].forEach(id => {
                const slider = document.getElementById(id);
                const updateSlider = () => {
                    const v = parseInt(slider.value);
                    const min = parseInt(slider.min);
                    const max = parseInt(slider.max);
                    const pct = ((v - min) / (max - min)) * 100;
                    slider.style.background = `linear-gradient(to right, var(--gold) ${pct}%, var(--border) ${pct}%)`;
                    document.getElementById(id+'Val').textContent = id === 'rotation' ? v+'°' : v+'%';
                    settings[id] = id === 'rotation' ? v : v/100;
                    if (activeIdx >= 0) render();
                };
                slider.oninput = updateSlider;
                updateSlider(); // Initialize fill on load
            });
        }

        function loadLogo(url) {
            logo = new Image();
            logo.crossOrigin = 'anonymous';
            logo.onload = () => { if (activeIdx >= 0) render(); };
            logo.src = url;
        }

        // Files
        async function handleFiles(fileList) {
            for (const f of fileList) {
                if (f.type === 'application/pdf') await loadPDF(f);
                else if (f.type.startsWith('image/')) await loadImage(f);
            }
            updateList();
            if (files.length && activeIdx === -1) select(0);
            document.getElementById('processBtn').disabled = !files.length;
            document.getElementById('downloadBtn').disabled = !files.length;

            // Auto-process after upload
            if (files.length) {
                processAll();
            }
        }

        async function loadPDF(file) {
            const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
            const pages = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const vp = page.getViewport({ scale: 2 });
                const c = document.createElement('canvas');
                c.width = vp.width; c.height = vp.height;
                await page.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
                const img = new Image(); img.src = c.toDataURL();
                await new Promise(r => img.onload = r);
                pages.push(img);
            }
            files.push({ name: file.name, pages, page: 0, thumb: pages[0].src, status: null });
        }

        async function loadImage(file) {
            return new Promise(r => {
                const fr = new FileReader();
                fr.onload = e => {
                    const img = new Image();
                    img.onload = () => { files.push({ name: file.name, pages: [img], page: 0, thumb: img.src, status: null }); r(); };
                    img.src = e.target.result;
                };
                fr.readAsDataURL(file);
            });
        }

        function updateList() {
            document.getElementById('fileList').innerHTML = files.map((f,i) => `
                <div class="file-item ${f.status||''} ${i===activeIdx?'active':''}" onclick="select(${i})">
                    <img class="file-thumb" src="${f.thumb}">
                    <div class="file-info">
                        <div class="file-name">${f.name}</div>
                        <div class="file-meta">${f.pages.length} page${f.pages.length>1?'s':''}</div>
                    </div>
                    ${f.status ? `<span class="file-badge ${f.status}">${f.status==='clean'?'✓':f.status==='warning'?'⚠':'✕'}</span>` : ''}
                    <button class="file-remove" onclick="event.stopPropagation();remove(${i})">×</button>
                </div>
            `).join('');
        }

        function select(i) {
            activeIdx = i;
            document.querySelector('.placeholder').style.display = 'none';
            canvas.style.display = 'block';
            render();
            updateList();
        }

        function remove(i) {
            files.splice(i, 1);
            if (activeIdx >= files.length) activeIdx = files.length - 1;
            updateList();
            if (!files.length) {
                document.querySelector('.placeholder').style.display = '';
                canvas.style.display = 'none';
                document.getElementById('resultsSection').style.display = 'none';
            } else select(Math.max(0, activeIdx));
            document.getElementById('processBtn').disabled = !files.length;
            document.getElementById('downloadBtn').disabled = !files.length;
        }

        function render() {
            if (activeIdx < 0 || !logo) return;
            const f = files[activeIdx], img = f.pages[f.page];
            canvas.width = img.width; canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            ctx.globalAlpha = settings.opacity;
            const w = img.width * settings.size * 1.5;
            const h = (logo.height / logo.width) * w;
            const gap = 1.5 - settings.density;
            const spX = w * gap + 80, spY = h * gap + 80;
            const rad = settings.rotation * Math.PI / 180;
            for (let y = -h; y < img.height + h; y += spY) {
                for (let x = -w; x < img.width + w; x += spX) {
                    ctx.save();
                    ctx.translate(x + w/2, y + h/2);
                    ctx.rotate(rad);
                    ctx.drawImage(logo, -w/2, -h/2, w, h);
                    ctx.restore();
                }
            }
            ctx.globalAlpha = 1;

            // Verified badge overlay - small, bottom-right corner, out of OCR way
            if (localStorage.getItem('verified_badge') === 'true' && f.status === 'clean') {
                const badgeH = Math.min(img.width, img.height) * 0.04;
                const badgeW = badgeH * 4;
                const margin = 15;
                const x = img.width - badgeW - margin;
                const y = img.height - badgeH - margin;

                ctx.save();
                ctx.globalAlpha = 0.7;

                // Pill background
                const radius = badgeH / 2;
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + badgeW - radius, y);
                ctx.arc(x + badgeW - radius, y + radius, radius, -Math.PI/2, Math.PI/2);
                ctx.lineTo(x + radius, y + badgeH);
                ctx.arc(x + radius, y + radius, radius, Math.PI/2, -Math.PI/2);
                ctx.closePath();
                ctx.fillStyle = '#27ae60';
                ctx.fill();

                // Checkmark icon
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = badgeH * 0.12;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                const iconX = x + badgeH * 0.5;
                const iconY = y + badgeH * 0.5;
                ctx.beginPath();
                ctx.moveTo(iconX - badgeH * 0.2, iconY);
                ctx.lineTo(iconX - badgeH * 0.05, iconY + badgeH * 0.18);
                ctx.lineTo(iconX + badgeH * 0.22, iconY - badgeH * 0.15);
                ctx.stroke();

                // Text
                ctx.globalAlpha = 1;
                ctx.fillStyle = '#fff';
                ctx.font = `bold ${badgeH * 0.55}px sans-serif`;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText('VERIFIED', x + badgeH * 1.1, y + badgeH * 0.52);

                ctx.restore();
            }
        }

        // Process
        async function processAll() {
            const key = localStorage.getItem('gemini_key');
            if (!key) { toast('Set Gemini API key in settings', 'error'); return; }

            toast('Processing documents...');

            // Fraud scan
            for (let i = 0; i < files.length; i++) {
                files[i].status = await fraudScan(files[i], key);
                updateList();
            }

            // OCR
            toast('Extracting bank data...');
            bankData = await extractData(key);
            showData();

            // Match
            const matched = matchLenders(bankData);
            showLenders(matched);

            document.getElementById('resultsSection').style.display = '';
            toast('Done!', 'success');
        }

        async function fraudScan(file, key) {
            try {
                const c = document.createElement('canvas');
                const img = file.pages[0];
                c.width = img.width; c.height = img.height;
                c.getContext('2d').drawImage(img, 0, 0);
                const b64 = c.toDataURL('image/jpeg', 0.8).split(',')[1];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [
                        { text: 'Analyze this bank statement for fraud. Look for manipulation, font inconsistencies, altered numbers. End with RISK_LEVEL:CLEAN or RISK_LEVEL:WARNING or RISK_LEVEL:DANGER' },
                        { inlineData: { mimeType: 'image/jpeg', data: b64 } }
                    ]}]})
                });
                const d = await res.json();
                const t = d.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (t.includes('DANGER')) return 'danger';
                if (t.includes('WARNING')) return 'warning';
                return 'clean';
            } catch { return 'warning'; }
        }

        function parseNum(v) {
            if (v == null) return null;
            if (typeof v === 'number') return v;
            const m = String(v).replace(/\$/g,'').match(/[\d,]+\.?\d*/);
            if (!m) return null;
            const n = parseFloat(m[0].replace(/,/g,''));
            return isNaN(n) ? null : n;
        }

        async function extractData(key) {
            const imgs = [];
            for (const f of files.slice(0,3)) {
                for (const p of f.pages.slice(0,2)) {
                    const c = document.createElement('canvas');
                    c.width = p.width; c.height = p.height;
                    c.getContext('2d').drawImage(p, 0, 0);
                    imgs.push(c.toDataURL('image/jpeg', 0.8).split(',')[1]);
                }
            }
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: 'Extract from these bank statements as SINGLE numbers (average if multiple months). Return JSON only:\n{"monthly_deposits":NUMBER,"average_daily_balance":NUMBER,"nsf_negative_days":NUMBER,"num_deposits_monthly":NUMBER}\nExample: {"monthly_deposits":50000,"average_daily_balance":5000,"nsf_negative_days":2,"num_deposits_monthly":15}' },
                            ...imgs.slice(0,4).map(d => ({ inlineData: { mimeType: 'image/jpeg', data: d } }))
                        ]}],
                        generationConfig: { temperature: 0.1 }
                    })
                });
                const d = await res.json();
                let t = d.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
                t = t.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
                const p = JSON.parse(t);
                return {
                    monthly_deposits: parseNum(p.monthly_deposits),
                    average_daily_balance: parseNum(p.average_daily_balance),
                    nsf_negative_days: parseNum(p.nsf_negative_days),
                    num_deposits_monthly: parseNum(p.num_deposits_monthly)
                };
            } catch { return { monthly_deposits: null, average_daily_balance: null, nsf_negative_days: null, num_deposits_monthly: null }; }
        }

        function showData() {
            document.getElementById('dataDeposits').textContent = bankData.monthly_deposits ? '$'+Math.round(bankData.monthly_deposits).toLocaleString() : '--';
            document.getElementById('dataADB').textContent = bankData.average_daily_balance ? '$'+Math.round(bankData.average_daily_balance).toLocaleString() : '--';
            document.getElementById('dataNSF').textContent = bankData.nsf_negative_days ?? '--';
            document.getElementById('dataNumDeps').textContent = bankData.num_deposits_monthly ?? '--';
        }

        function matchLenders(data) {
            const deps = data.monthly_deposits || 0;
            const adb = data.average_daily_balance || 0;
            const nsf = data.nsf_negative_days ?? 99;
            const numD = data.num_deposits_monthly || 0;

            return lenders.map(L => {
                let pass = 0, fail = 0, total = 0;
                const chk = (min, val, isMax) => {
                    if (min == null) return;
                    total++;
                    if (isMax ? val <= min : val >= min) pass++; else fail++;
                };
                if (L.min_deposits) chk(L.min_deposits, deps);
                if (L.min_adb) chk(L.min_adb, adb);
                if (L.max_nsf !== undefined) chk(L.max_nsf, nsf, true);
                if (L.min_num_deps) chk(L.min_num_deps, numD);

                const score = total === 0 ? 50 : Math.round((pass/total)*100);
                const level = fail === 0 && pass > 0 ? 'high' : score >= 50 ? 'medium' : 'low';

                const base = deps > 0 ? deps * 1.5 : L.avg_amount || 50000;
                const amt = Math.min(L.max_amount || 100000, base);
                const rate = level === 'high' ? L.min_rate : level === 'medium' ? (L.min_rate + L.max_rate)/2 : L.max_rate;
                const term = level === 'high' ? L.max_term : level === 'medium' ? Math.round((L.min_term + L.max_term)/2) : L.min_term;
                const weeks = term * 4.33;
                const payback = amt * (rate || 1.4);
                const weekly = payback / weeks;
                const pmt = L.frequency === 'Daily' ? Math.round(weekly/5) : Math.round(weekly);

                return { ...L, score, level, amt: Math.round(amt), rate: (rate||1.4).toFixed(2), term: term||6, pmt: pmt||0 };
            }).sort((a,b) => b.score - a.score);
        }

        function showLenders(list) {
            const high = list.filter(l => l.level === 'high').length;
            document.getElementById('matchCount').textContent = high + ' strong match' + (high !== 1 ? 'es' : '');

            document.getElementById('lenderGrid').innerHTML = list.map(L => `
                <div class="lender-card ${L.level}">
                    <div class="lender-top">
                        <div class="lender-name">${L.name}</div>
                        <span class="lender-match ${L.level}">${L.score}%</span>
                    </div>
                    <div class="lender-terms">
                        <div class="term"><div class="term-label">Amount</div><div class="term-value gold">$${L.amt.toLocaleString()}</div></div>
                        <div class="term"><div class="term-label">Rate</div><div class="term-value">${L.rate}</div></div>
                        <div class="term"><div class="term-label">Term</div><div class="term-value">${L.term} mo</div></div>
                        <div class="term"><div class="term-label">${L.frequency}</div><div class="term-value">$${L.pmt.toLocaleString()}</div></div>
                    </div>
                    <div class="lender-bottom">
                        <div class="lender-method">
                            ${L.method === 'email' ? `<code onclick="copy('${L.email}')">${L.email}</code>` : `<a href="${L.portal}" target="_blank">Portal</a>`}
                        </div>
                        ${L.notes ? `<div class="lender-freq">${L.notes}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function copy(t) { navigator.clipboard.writeText(t); toast('Copied!', 'success'); }

        // Download modal
        function openDownloadModal() {
            const list = document.getElementById('downloadFileList');
            list.innerHTML = files.map((f, i) => {
                const baseName = f.name.replace(/\.[^.]+$/, '').replace(/[^a-z0-9_\-\s]/gi, '_');
                const ext = f.pages.length === 1 ? '.png' : '.pdf';
                return `
                    <div class="download-file-item">
                        <img class="download-file-thumb" src="${f.thumb}">
                        <input type="text" class="download-file-input" id="fileName${i}" value="${baseName}_watermarked">
                        <span class="download-file-ext">${ext}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('downloadModal').classList.add('active');
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.remove('active');
        }

        async function downloadWithNames() {
            closeDownloadModal();
            const { jsPDF } = window.jspdf;
            for (let i = 0; i < files.length; i++) {
                const f = files[i];
                const customName = document.getElementById('fileName' + i).value.replace(/[^a-z0-9_\-\s]/gi, '_') || 'file_' + i;
                if (f.pages.length === 1) {
                    activeIdx = i; render();
                    const a = document.createElement('a');
                    a.download = customName + '.png';
                    a.href = canvas.toDataURL('image/png');
                    a.click();
                } else {
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    for (let j = 0; j < f.pages.length; j++) {
                        f.page = j; activeIdx = i; render();
                        await new Promise(r => setTimeout(r, 100));
                        if (j > 0) pdf.addPage();
                        pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, canvas.width, canvas.height);
                    }
                    pdf.save(customName + '.pdf');
                }
                await new Promise(r => setTimeout(r, 300));
            }
            toast('Downloads complete!', 'success');
        }

        async function downloadAll() {
            const { jsPDF } = window.jspdf;
            for (const f of files) {
                const name = f.name.replace(/\.[^.]+$/, '').replace(/[^a-z0-9_-]/gi, '_');
                if (f.pages.length === 1) {
                    activeIdx = files.indexOf(f); render();
                    const a = document.createElement('a');
                    a.download = name + '_watermarked.png';
                    a.href = canvas.toDataURL('image/png');
                    a.click();
                } else {
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    for (let i = 0; i < f.pages.length; i++) {
                        f.page = i; activeIdx = files.indexOf(f); render();
                        await new Promise(r => setTimeout(r, 100));
                        if (i > 0) pdf.addPage();
                        pdf.addImage(canvas.toDataURL('image/jpeg', 0.9), 'JPEG', 0, 0, canvas.width, canvas.height);
                    }
                    pdf.save(name + '_watermarked.pdf');
                }
                await new Promise(r => setTimeout(r, 300));
            }
            toast('Downloads complete!', 'success');
        }

        // Settings
        function openSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('active'); }
        function saveSettings() {
            localStorage.setItem('gemini_key', document.getElementById('apiKey').value);
            localStorage.setItem('watermark_url', document.getElementById('watermarkUrl').value);
            localStorage.setItem('verified_badge', document.getElementById('verifiedBadge').checked);
            loadLogo(document.getElementById('watermarkUrl').value);
            closeSettings();
            toast('Settings saved!', 'success');
        }

        function toast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast' + (type ? ' ' + type : '');
            t.style.display = 'block';
            if (type) setTimeout(() => t.style.display = 'none', 3000);
        }

        function saveDefaults() {
            localStorage.setItem('watermark_defaults', JSON.stringify(settings));
            toast('Defaults saved!', 'success');
        }

        function loadDefaults() {
            const saved = localStorage.getItem('watermark_defaults');
            if (saved) {
                const d = JSON.parse(saved);
                settings = { ...settings, ...d };
                ['opacity','size','density','rotation'].forEach(id => {
                    const slider = document.getElementById(id);
                    const val = id === 'rotation' ? settings[id] : settings[id] * 100;
                    slider.value = val;
                    const min = parseInt(slider.min);
                    const max = parseInt(slider.max);
                    const pct = ((val - min) / (max - min)) * 100;
                    slider.style.background = `linear-gradient(to right, var(--gold) ${pct}%, var(--border) ${pct}%)`;
                    document.getElementById(id+'Val').textContent = id === 'rotation' ? val+'°' : Math.round(val)+'%';
                });
            }
        }

        init();
        loadDefaults();
    </script>
</body>
</html>
