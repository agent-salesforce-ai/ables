<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hubble | Business Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-tertiary: #1a1a1a;
      --bg-card: #111111;
      --text-primary: #f5f5f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --tier-a: #22c55e;
      --tier-b: #84cc16;
      --tier-c: #eab308;
      --tier-d: #f97316;
      --tier-e: #ef4444;
      --accent-blue: #3b82f6;
      --accent-purple: #a855f7;
      --border-primary: #27272a;
      --border-secondary: #1f1f22;
      --glow-gold: rgba(234, 179, 8, 0.15);
    }
    
    body.light-mode {
      --bg-primary: #f8f8f8;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f0f0f0;
      --bg-card: #ffffff;
      --text-primary: #18181b;
      --text-secondary: #52525b;
      --text-muted: #71717a;
      --border-primary: #e4e4e7;
      --border-secondary: #d4d4d8;
      --glow-gold: rgba(234, 179, 8, 0.25);
    }
    body.light-mode .bg-grid {
      background-image: linear-gradient(rgba(234, 179, 8, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.05) 1px, transparent 1px);
    }
    body.light-mode .bg-gradient {
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(234, 179, 8, 0.12), transparent);
    }
    
    .theme-toggle {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .theme-toggle svg { width: 18px; height: 18px; }
    .theme-toggle .sun-icon { display: none; }
    .theme-toggle .moon-icon { display: block; }
    body.light-mode .theme-toggle .sun-icon { display: block; }
    body.light-mode .theme-toggle .moon-icon { display: none; }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { overflow-x: hidden; width: 100%; max-width: 100vw; }
    body {
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(234, 179, 8, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.02) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }
    .bg-gradient {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 600px;
      background: radial-gradient(ellipse 80% 50% at 50% 0%, var(--glow-gold), transparent);
      pointer-events: none;
      z-index: 0;
    }

    /* Orbital Animation */
    .orbit-system {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 700px;
      height: 700px;
      pointer-events: none;
      z-index: 0;
      opacity: 0.5;
      transition: opacity 0.5s;
    }
    .orbit-system.dimmed { opacity: 0.08; }
    .orbit-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(234, 179, 8, 0.4) 0%, rgba(234, 179, 8, 0.1) 40%, transparent 70%);
      border-radius: 50%;
      filter: blur(20px);
    }
    .orbit-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      border: 1px solid rgba(234, 179, 8, 0.12);
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    .orbit-ring-1 { width: 250px; height: 250px; animation: orbit-rotate 30s linear infinite; }
    .orbit-ring-2 { width: 400px; height: 400px; animation: orbit-rotate 45s linear infinite reverse; }
    .orbit-ring-3 { width: 550px; height: 550px; animation: orbit-rotate 60s linear infinite; }
    @keyframes orbit-rotate {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .orbit-particle { position: absolute; border-radius: 50%; top: 50%; left: 50%; }
    .particle-1 { width: 10px; height: 10px; background: #eab308; box-shadow: 0 0 15px 5px rgba(234, 179, 8, 0.5); animation: orb1 20s linear infinite; }
    .particle-2 { width: 8px; height: 8px; background: #a855f7; box-shadow: 0 0 12px 4px rgba(168, 85, 247, 0.5); animation: orb2 25s linear infinite; }
    .particle-3 { width: 6px; height: 6px; background: #22c55e; box-shadow: 0 0 10px 3px rgba(34, 197, 94, 0.5); animation: orb3 18s linear infinite reverse; }
    .particle-4 { width: 8px; height: 8px; background: #f97316; box-shadow: 0 0 12px 4px rgba(249, 115, 22, 0.5); animation: orb4 30s linear infinite; }
    @keyframes orb1 { from { transform: translate(-50%, -50%) rotate(0deg) translateX(125px); } to { transform: translate(-50%, -50%) rotate(360deg) translateX(125px); } }
    @keyframes orb2 { from { transform: translate(-50%, -50%) rotate(60deg) translateX(200px); } to { transform: translate(-50%, -50%) rotate(420deg) translateX(200px); } }
    @keyframes orb3 { from { transform: translate(-50%, -50%) rotate(120deg) translateX(275px); } to { transform: translate(-50%, -50%) rotate(480deg) translateX(275px); } }
    @keyframes orb4 { from { transform: translate(-50%, -50%) rotate(180deg) translateX(150px); } to { transform: translate(-50%, -50%) rotate(540deg) translateX(150px); } }

    /* HEADER */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: transparent;
      z-index: 100;
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo svg { width: 36px; height: 36px; border-radius: 10px; }
    .header-logo h1 { font-size: 1.25rem; font-weight: 800; letter-spacing: -0.5px; }
    .header-logo h1 .ables { color: var(--text-primary); }
    .header-logo h1 .ai { color: var(--accent); font-weight: 700; }
    
    .header-nav {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    .nav-link {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-link:hover { color: var(--text-primary); }
    .nav-link.active { color: var(--accent); }
    .nav-badge {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .nav-badge.lite { background: var(--accent); color: #000; }
    .nav-badge.free { background: #22c55e; color: #000; }
    
    .header-actions { display: flex; align-items: center; gap: 12px; }
    
    /* Hero title with telescope */
    .hero-title-wrap {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 4px;
      margin-bottom: 0.5rem;
      position: relative;
    }
    .telescope-icon {
      position: absolute;
      right: -36px;
      top: -8px;
    }
    
    /* API Key in search box */
    .api-key-input {
      width: 100px;
      padding: 0.6rem 0;
      background: transparent;
      border: none;
      border-left: 1px solid var(--border-primary);
      padding-left: 12px;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-family: inherit;
      text-align: right;
    }
    .api-key-input:focus { outline: none; color: var(--text-primary); }
    .api-key-input::placeholder { color: var(--text-muted); }

    /* HERO SECTION */
    .hero-section {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-bottom: 12vh;
      position: relative;
      z-index: 1;
      transition: all 0.4s ease;
    }
    .hero-section.hidden { display: none; }
    .hero-logo { width: 100px; height: 100px; margin-bottom: 1.5rem; }
    .hero-logo svg { width: 100%; height: 100%; }
    .hero-title { font-size: clamp(2.75rem, 5.5vw, 4rem); font-weight: 700; letter-spacing: -2px; text-align: center; margin: 0; }
    .hero-title .hubble { 
      font-style: normal; 
      background: linear-gradient(90deg, #ffffff, #facc15, #eab308, #facc15, #ffffff); 
      background-size: 200% auto;
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text;
      animation: gradient-shift 3s ease-in-out infinite;
    }
    @keyframes gradient-shift {
      0% { background-position: 0% center; }
      50% { background-position: 100% center; }
      100% { background-position: 0% center; }
    }
    .hero-subtitle { font-size: 1rem; color: var(--text-muted); margin-bottom: 2rem; text-align: center; }
    .search-box { width: 100%; max-width: 650px; }
    .search-input-container {
      display: flex;
      align-items: center;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 50px;
      padding: 8px 8px 8px 24px;
      gap: 12px;
      margin-bottom: 1.25rem;
      transition: all 0.2s;
    }
    .search-input-container:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow-gold);
    }
    .search-input-container input#businessInput {
      flex: 1;
      min-width: 0;
      padding: 0.75rem 0;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-family: inherit;
    }
    .search-input-container input#businessInput:focus { outline: none; }
    .search-input-container input#businessInput::placeholder { color: var(--text-muted); }
    .search-btn {
      width: 52px;
      height: 52px;
      min-width: 52px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      color: #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .search-btn:hover { transform: scale(1.05); box-shadow: 0 8px 24px rgba(234, 179, 8, 0.4); }
    .search-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .search-btn svg { width: 24px; height: 24px; }
    
    .hero-footer {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .hero-footer a { color: var(--accent); text-decoration: none; }
    .hero-footer a:hover { text-decoration: underline; }

    /* RESULTS SECTION */
    .results-section {
      display: none;
      padding: 88px 24px 24px;
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
    }
    .results-section.active { display: block; }
    .results-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .results-title { font-size: 1.35rem; font-weight: 700; }
    .results-title span { color: var(--accent); }
    .btn-secondary {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    .btn-secondary svg { width: 14px; height: 14px; }

    /* INTEL TABS */
    .intel-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .intel-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .intel-tab:hover { color: var(--text-primary); background: var(--bg-secondary); }
    .intel-tab.active { background: var(--bg-secondary); color: var(--accent); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .intel-tab svg { width: 14px; height: 14px; }
    .tab-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--bg-primary);
      min-width: 20px;
      text-align: center;
    }
    .intel-tab.active .tab-badge { background: rgba(234, 179, 8, 0.2); color: var(--accent); }
    .intel-tab.has-data .tab-badge { background: rgba(34, 197, 94, 0.2); color: var(--tier-a); }
    .intel-tab.has-warning .tab-badge { background: rgba(239, 68, 68, 0.2); color: var(--tier-e); }
    .intel-tab.loading .tab-badge { background: rgba(234, 179, 8, 0.15); }
    
    .badge-spinner {
      display: inline-block;
      width: 10px;
      height: 10px;
      border: 2px solid rgba(234, 179, 8, 0.3);
      border-top-color: #eab308;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .intel-panel { display: none; }
    .intel-panel.active { display: block; }

    /* CARD */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      box-sizing: border-box;
    }
    .card-accent::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      border-radius: 16px 16px 0 0;
    }
    .card-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-title-left { display: flex; align-items: center; gap: 8px; }
    .card-title svg { width: 16px; height: 16px; }

    /* LOADING / EMPTY STATES */
    /* MINI GAME */
    .game-container {
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px;
      margin-top: 20px;
      text-align: center;
    }
    .game-container.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
    .game-scores {
      display: flex;
      gap: 16px;
    }
    .game-score {
      font-weight: 600;
      color: var(--accent);
    }
    .game-high {
      font-weight: 600;
      color: var(--tier-a);
    }
    #brickGame {
      background: var(--bg-primary);
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }
    .game-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.3; }
    .empty-state p { font-size: 0.9rem; }
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 16px;
    }
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-primary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-state p { color: var(--text-muted); font-size: 0.9rem; }
    .loading-status {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .loading-status-text {
      font-size: 0.8rem;
      color: var(--accent);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .loading-progress {
      width: 200px;
      height: 3px;
      background: var(--border-primary);
      border-radius: 2px;
      overflow: hidden;
    }
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: 2px;
      animation: progress 8s ease-in-out infinite;
    }
    @keyframes progress {
      0% { width: 0%; }
      20% { width: 25%; }
      50% { width: 60%; }
      80% { width: 85%; }
      100% { width: 95%; }
    }
    .loading-fact {
      max-width: 450px;
      text-align: center;
      margin-top: 20px;
      padding: 20px 24px;
      background: rgba(234, 179, 8, 0.05);
      border: 1px solid rgba(234, 179, 8, 0.15);
      border-radius: 12px;
      animation: fadeInFact 0.5s ease;
    }
    @keyframes fadeInFact {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loading-fact-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .loading-fact-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    /* STREAMING STATES */
    .streaming-container {
      min-height: 200px;
    }
    .streaming-field {
      animation: fieldFadeIn 0.3s ease forwards;
    }
    @keyframes fieldFadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .streaming-text {
      display: inline;
    }
    .streaming-cursor {
      display: inline-block;
      width: 2px;
      height: 1em;
      background: var(--accent);
      margin-left: 2px;
      animation: cursorBlink 0.8s ease-in-out infinite;
      vertical-align: text-bottom;
    }
    @keyframes cursorBlink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .stream-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(234, 179, 8, 0.08);
      border: 1px solid rgba(234, 179, 8, 0.2);
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: var(--accent);
    }
    .stream-status-dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: statusPulse 1s ease-in-out infinite;
    }
    @keyframes statusPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.7; }
    }
    .stream-complete .stream-status {
      background: rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.2);
      color: var(--tier-a);
    }
    .stream-complete .stream-status-dot {
      background: var(--tier-a);
      animation: none;
    }
    .data-field-streaming {
      background: rgba(234, 179, 8, 0.05);
      border-radius: 6px;
      transition: background 0.3s ease;
    }
    .data-field-complete {
      background: transparent;
    }
    .section-box.streaming {
      position: relative;
      overflow: hidden;
    }
    .section-box.streaming::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(234, 179, 8, 0.1), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      to { left: 100%; }
    }
    .section-box.complete::after {
      display: none;
    }

    /* DATA STYLES */
    .section-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .data-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .data-grid .label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
    .data-grid .value { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); word-break: break-word; }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
    .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    
    .risk-banner {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .risk-banner.low { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); }
    .risk-banner.medium { background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); }
    .risk-banner.high { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
    .risk-badge {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
    }
    .risk-banner.low .risk-badge { background: var(--tier-a); color: #000; }
    .risk-banner.medium .risk-badge { background: var(--accent); color: #000; }
    .risk-banner.high .risk-badge { background: var(--tier-e); color: #fff; }
    .risk-info h3 { font-size: 1.1rem; font-weight: 700; }
    .risk-info p { font-size: 0.85rem; color: var(--text-muted); }
    
    .record-item {
      padding: 12px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    .record-item:last-child { border-bottom: none; }
    .record-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .record-title { font-weight: 600; font-size: 0.9rem; }
    .record-meta { font-size: 0.8rem; color: var(--text-muted); }
    .status-badge {
      font-size: 0.65rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .status-badge.good { background: rgba(34, 197, 94, 0.15); color: var(--tier-a); }
    .status-badge.warning { background: rgba(234, 179, 8, 0.15); color: var(--accent); }
    .status-badge.active { background: rgba(239, 68, 68, 0.15); color: var(--tier-e); }
    
    .red-flags {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
    }
    .red-flags h4 { color: var(--tier-e); font-size: 0.85rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .red-flags h4 svg { width: 16px; height: 16px; }
    .red-flags ul { list-style: none; }
    .red-flags li { font-size: 0.85rem; color: var(--text-secondary); padding: 4px 0; padding-left: 16px; position: relative; }
    .red-flags li::before { content: '!'; position: absolute; left: 0; color: var(--tier-e); font-weight: 700; }
    
    .summary-box {
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.05), rgba(168, 85, 247, 0.05));
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    .summary-box h4 { font-size: 0.8rem; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
    .summary-box p { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7; }
    
    .social-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .social-card { background: var(--bg-tertiary); border-radius: 10px; padding: 16px; }
    .social-platform { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
    .social-followers { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
    .social-link { font-size: 0.75rem; color: var(--accent-blue); text-decoration: none; }
    .social-link:hover { text-decoration: underline; }
    
    .review-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
    .review-card { background: var(--bg-tertiary); border-radius: 10px; padding: 16px; text-align: center; }
    .review-platform { font-weight: 600; font-size: 0.8rem; margin-bottom: 8px; }
    .review-rating { font-size: 1.8rem; font-weight: 800; margin-bottom: 4px; }
    .review-rating.good { color: var(--tier-a); }
    .review-rating.ok { color: var(--accent); }
    .review-rating.bad { color: var(--tier-e); }
    .review-count { font-size: 0.75rem; color: var(--text-muted); }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 0.85rem;
      color: var(--text-primary);
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }
    .toast strong { color: var(--accent); margin-right: 8px; }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .data-grid { grid-template-columns: repeat(2, 1fr); }
      .stats-row { grid-template-columns: 1fr; }
      .review-grid { grid-template-columns: repeat(2, 1fr); }
      .intel-tabs { flex-wrap: nowrap; }
      .intel-tab { padding: 8px 12px; font-size: 0.75rem; }
      .header-nav { display: none; }
      .api-key-input { width: 80px; font-size: 0.8rem; }
    }

    /* API KEY MODAL */
    .api-modal-overlay {
      position: fixed;
      inset: 0;
      background: #f8f8f8;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      overflow-y: auto;
      --modal-bg-primary: #f8f8f8;
      --modal-bg-secondary: #ffffff;
      --modal-bg-tertiary: #f0f0f0;
      --modal-bg-card: #ffffff;
      --modal-text-primary: #18181b;
      --modal-text-secondary: #52525b;
      --modal-text-muted: #71717a;
      --modal-border-primary: #e4e4e7;
      --modal-border-secondary: #d4d4d8;
    }
    .api-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .api-explainer {
      background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%);
      border-bottom: 1px solid var(--modal-border-primary);
      padding: 32px 24px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .api-explainer-inner {
      max-width: 800px;
      margin: 0 auto;
    }
    .api-modal-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }
    .api-modal-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .api-modal-icon svg {
      width: 28px;
      height: 28px;
      color: #000;
    }
    .api-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #18181b;
      margin-bottom: 4px;
    }
    .api-modal-subtitle {
      font-size: 0.9rem;
      color: #71717a;
    }
    .api-explainer-content {
      display: flex;
      gap: 32px;
      align-items: flex-start;
    }
    .api-steps {
      flex: 1;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .api-step {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f0f0f0;
      padding: 12px 16px;
      border-radius: 10px;
      flex: 1;
      min-width: 180px;
    }
    .api-step-num {
      width: 28px;
      height: 28px;
      min-width: 28px;
      background: var(--accent);
      color: #000;
      font-size: 0.8rem;
      font-weight: 700;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .api-step-text {
      font-size: 0.85rem;
      color: #52525b;
    }
    .api-step-text a {
      color: var(--accent-dark);
      text-decoration: none;
      font-weight: 600;
    }
    .api-step-text a:hover {
      text-decoration: underline;
    }
    .api-cta-buttons {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
    }
    .api-modal-btn {
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
    }
    .api-modal-btn.primary {
      background: var(--accent);
      border: none;
      color: #000;
    }
    .api-modal-btn.primary:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
    }
    .api-modal-btn.secondary {
      background: transparent;
      border: 1px solid #e4e4e7;
      color: #52525b;
    }
    .api-modal-btn.secondary:hover {
      border-color: #a1a1aa;
      color: #18181b;
    }
    .api-modal-close {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 40px;
      height: 40px;
      background: #f0f0f0;
      border: 1px solid #e4e4e7;
      color: #71717a;
      cursor: pointer;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 20;
    }
    .api-modal-close:hover {
      background: #ffffff;
      color: #18181b;
      border-color: #a1a1aa;
    }
    .demo-results-container {
      padding: 24px;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }
    .demo-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    
    /* Force light mode for all demo content */
    .demo-results-container .intel-tabs {
      background: #ffffff;
      border-color: #e4e4e7;
    }
    .demo-results-container .intel-tab {
      color: #71717a;
      border-color: transparent;
    }
    .demo-results-container .intel-tab:hover {
      color: #18181b;
      background: #f0f0f0;
    }
    .demo-results-container .intel-tab.active {
      color: var(--accent-dark);
      border-color: var(--accent);
      background: rgba(234, 179, 8, 0.1);
    }
    .demo-results-container .tab-badge {
      background: #f0f0f0;
      color: #52525b;
    }
    .demo-results-container .intel-tab.active .tab-badge {
      background: var(--accent);
      color: #000;
    }
    .demo-results-container .card {
      background: #ffffff;
      border-color: #e4e4e7;
    }
    .demo-results-container .card-title {
      color: #18181b;
      border-color: #e4e4e7;
    }
    .demo-results-container .section-box {
      background: #f8f8f8;
      border-color: #e4e4e7;
    }
    .demo-results-container .section-title {
      color: #18181b;
    }
    .demo-results-container .label {
      color: #71717a;
    }
    .demo-results-container .value {
      color: #18181b;
    }
    .demo-results-container .record-item {
      border-color: #e4e4e7;
    }
    .demo-results-container .record-title {
      color: #18181b;
    }
    .demo-results-container .record-meta {
      color: #71717a;
    }
    .demo-results-container .summary-box {
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
      border-color: rgba(234, 179, 8, 0.3);
    }
    .demo-results-container .summary-box h4 {
      color: var(--accent-dark);
    }
    .demo-results-container .summary-box p {
      color: #52525b;
    }
    .demo-results-container .risk-banner {
      border-color: #e4e4e7;
    }
    .demo-results-container .risk-info h3 {
      color: #18181b;
    }
    .demo-results-container .risk-info p {
      color: #71717a;
    }
    .demo-results-container .stat-card {
      background: #ffffff;
      border-color: #e4e4e7;
    }
    .demo-results-container .stat-value {
      color: #18181b;
    }
    .demo-results-container .stat-label {
      color: #71717a;
    }
    .demo-results-container .review-card {
      background: #ffffff;
      border-color: #e4e4e7;
    }
    .demo-results-container .review-platform {
      color: #71717a;
    }
    .demo-results-container .social-card {
      background: #ffffff;
      border-color: #e4e4e7;
    }
    .demo-results-container .social-platform {
      color: #18181b;
    }
    .demo-results-container .social-followers {
      color: #71717a;
    }
    .demo-results-container .data-grid > div {
      background: #ffffff;
      border-color: #e4e4e7;
    }
    
    @media (max-width: 900px) {
      .api-explainer-content {
        flex-direction: column;
      }
      .api-cta-buttons {
        width: 100%;
      }
      .api-modal-btn {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="bg-gradient"></div>

  <div class="orbit-system" id="orbitSystem">
    <div class="orbit-center"></div>
    <div class="orbit-ring orbit-ring-1"></div>
    <div class="orbit-ring orbit-ring-2"></div>
    <div class="orbit-ring orbit-ring-3"></div>
    <div class="orbit-particle particle-1"></div>
    <div class="orbit-particle particle-2"></div>
    <div class="orbit-particle particle-3"></div>
    <div class="orbit-particle particle-4"></div>
  </div>

  <header class="main-header">
    <div class="header-logo">
      <svg viewBox="0 0 64 64" fill="none"><defs><radialGradient id="pg" cx="35%" cy="35%" r="60%"><stop offset="0%" stop-color="#fcd34d"/><stop offset="50%" stop-color="#eab308"/><stop offset="100%" stop-color="#ca8a04"/></radialGradient><linearGradient id="rg" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#ffab40"/><stop offset="50%" stop-color="#ff8c00"/><stop offset="100%" stop-color="#ff6d00"/></linearGradient></defs><ellipse cx="32" cy="32" rx="26" ry="7" stroke="url(#rg)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="65 130" opacity="0.6"/><circle cx="32" cy="32" r="11" fill="url(#pg)"/><ellipse cx="28" cy="28" rx="3.5" ry="2.5" fill="#fef3c7" opacity="0.4"/><ellipse cx="32" cy="32" rx="26" ry="7" stroke="url(#rg)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="65 130" stroke-dashoffset="-65"/></svg>
      <h1><span class="ables">Ables</span><span class="ai">AI</span></h1>
    </div>
    <nav class="header-nav">
      <a href="#" class="nav-link">HOME</a>
      <a href="#" class="nav-link">CALCULATOR <span class="nav-badge lite">LITE</span></a>
      <a href="#" class="nav-link">TOOLBOX <span class="nav-badge free">FREE</span></a>
      <a href="#" class="nav-link active">HUBBLE</a>
    </nav>
    <div class="header-actions">
      <button class="theme-toggle" onclick="toggleTheme()">
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </header>

  <!-- HERO SECTION -->
  <section class="hero-section" id="heroSection">
    <div class="hero-logo">
      <svg viewBox="0 0 64 64" fill="none"><defs><radialGradient id="hg" cx="35%" cy="35%" r="60%"><stop offset="0%" stop-color="#fcd34d"/><stop offset="50%" stop-color="#eab308"/><stop offset="100%" stop-color="#ca8a04"/></radialGradient><linearGradient id="hrg" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#ffab40"/><stop offset="50%" stop-color="#ff8c00"/><stop offset="100%" stop-color="#ff6d00"/></linearGradient><filter id="glow"><feGaussianBlur stdDeviation="2" result="g"/><feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><ellipse cx="32" cy="32" rx="26" ry="7" stroke="url(#hrg)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="65 130" opacity="0.6"/><circle cx="32" cy="32" r="13" fill="#eab308" opacity="0.2" filter="url(#glow)"/><circle cx="32" cy="32" r="11" fill="url(#hg)" filter="url(#glow)"/><ellipse cx="28" cy="28" rx="3.5" ry="2.5" fill="#fef3c7" opacity="0.4"/><ellipse cx="32" cy="32" rx="26" ry="7" stroke="url(#hrg)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="65 130" stroke-dashoffset="-65"/></svg>
    </div>
    <div class="hero-title-wrap">
      <h1 class="hero-title"><span class="hubble">Hubble</span></h1>
      <svg class="telescope-icon" viewBox="0 0 40 40" fill="none" width="28" height="28">
        <defs>
          <linearGradient id="tg1" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#c084fc"/>
            <stop offset="100%" stop-color="#7c3aed"/>
          </linearGradient>
          <linearGradient id="tg2" x1="0%" y1="100%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#60a5fa"/>
            <stop offset="100%" stop-color="#3b82f6"/>
          </linearGradient>
        </defs>
        <!-- Telescope body pointing up-left -->
        <rect x="16" y="16" width="18" height="5" rx="2" fill="url(#tg1)" transform="rotate(-50 25 18)"/>
        <!-- Telescope lens/eyepiece -->
        <circle cx="30" cy="30" r="3.5" fill="url(#tg2)"/>
        <!-- Signal waves going up toward planet -->
        <path d="M8 12 L4 8" stroke="#60a5fa" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 8 L6 2" stroke="#a855f7" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 14 L2 10" stroke="#c084fc" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
      </svg>
    </div>
    <p class="hero-subtitle">AI-powered business intelligence</p>
    <div class="search-box">
      <div class="search-input-container">
        <input type="text" id="businessInput" placeholder="Enter business name" onkeydown="if(event.key==='Enter') runSearch()">
        <input type="text" id="apiKey" class="api-key-input" placeholder="API Key">
        <button class="search-btn" onclick="runSearch()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        </button>
      </div>
    </div>
    <div class="hero-footer">
      Powered by <a href="#">AblesAI</a> | Gemini API with Google Search Grounding
    </div>
  </section>

  <!-- RESULTS SECTION -->
  <section class="results-section" id="resultsSection">
    <div class="results-header">
      <h2 class="results-title">Intel: <span id="businessDisplay"></span></h2>
      <button class="btn-secondary" onclick="newSearch()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Search
      </button>
    </div>

    <!-- INTEL TABS -->
    <div class="intel-tabs">
      <button class="intel-tab active" onclick="switchIntelTab('research')" id="tabResearch">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        RESEARCH
        <span class="tab-badge" id="badgeResearch">--</span>
      </button>
      <button class="intel-tab" onclick="switchIntelTab('background')" id="tabBackground">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        BACKGROUND
        <span class="tab-badge" id="badgeBackground">--</span>
      </button>
      <button class="intel-tab" onclick="switchIntelTab('reviews')" id="tabReviews">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        REVIEWS
        <span class="tab-badge" id="badgeReviews">--</span>
      </button>
      <button class="intel-tab" onclick="switchIntelTab('social')" id="tabSocial">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
        SOCIAL
        <span class="tab-badge" id="badgeSocial">--</span>
      </button>
      <button class="intel-tab" onclick="switchIntelTab('footprint')" id="tabFootprint">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        FOOTPRINT
        <span class="tab-badge" id="badgeFootprint">--</span>
      </button>
      <button class="intel-tab" onclick="switchIntelTab('debt')" id="tabDebt">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        DEBT
        <span class="tab-badge" id="badgeDebt">--</span>
      </button>
    </div>

    <!-- RESEARCH PANEL -->
    <div class="intel-panel active" id="panelResearch">
      <div class="card card-accent">
        <div class="card-title">
          <span class="card-title-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Deep Research
          </span>
          <button class="btn-secondary" onclick="runSOSLookup(); runFullResearchAuto();">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Run
          </button>
        </div>
        <div id="researchContent"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><p>Run a search to get deep business research</p></div></div>
      </div>
    </div>

    <!-- BACKGROUND PANEL -->
    <div class="intel-panel" id="panelBackground">
      <div class="card card-accent">
        <div class="card-title">
          <span class="card-title-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Background Check
          </span>
          <button class="btn-secondary" onclick="runBackgroundAuto()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Run
          </button>
        </div>
        <div id="backgroundContent"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg><p>Run a search to check UCC filings, liens & judgments</p></div></div>
      </div>
    </div>

    <!-- REVIEWS PANEL -->
    <div class="intel-panel" id="panelReviews">
      <div class="card card-accent">
        <div class="card-title">
          <span class="card-title-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            Reviews & Ratings
          </span>
          <button class="btn-secondary" onclick="runReviewsAuto()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Run
          </button>
        </div>
        <div id="reviewsContent"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg><p>Run a search to find reviews and ratings</p></div></div>
      </div>
    </div>

    <!-- SOCIAL PANEL -->
    <div class="intel-panel" id="panelSocial">
      <div class="card card-accent">
        <div class="card-title">
          <span class="card-title-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
            Social Media
          </span>
          <button class="btn-secondary" onclick="runSocialAuto()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Run
          </button>
        </div>
        <div id="socialContent"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg><p>Run a search to find social media profiles</p></div></div>
      </div>
    </div>

    <!-- FOOTPRINT PANEL -->
    <div class="intel-panel" id="panelFootprint">
      <div class="card card-accent">
        <div class="card-title">
          <span class="card-title-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            Digital Footprint
          </span>
          <button class="btn-secondary" onclick="runFootprintAuto()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Run
          </button>
        </div>
        <div id="footprintContent"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/></svg><p>Run a search to analyze online presence</p></div></div>
      </div>
    </div>

    <!-- DEBT PANEL -->
    <div class="intel-panel" id="panelDebt">
      <div class="card card-accent">
        <div class="card-title">
          <span class="card-title-left">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Debt Positions
          </span>
          <button class="btn-secondary" onclick="runDebtAuto()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Run
          </button>
        </div>
        <div id="debtContent"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><p>Run a search to find debt and financing positions</p></div></div>
      </div>
    </div>

    <!-- MINI GAME WHILE LOADING -->
    <div class="game-container" id="gameContainer">
      <div class="game-header">
        <span> Play while you wait</span>
        <div class="game-scores">
          <span class="game-score">Score: <span id="gameScore">0</span></span>
          <span class="game-high">Best: <span id="gameHigh">0</span></span>
        </div>
      </div>
      <canvas id="brickGame" width="400" height="250"></canvas>
      <p class="game-hint">  to move | CLICK or SPACE to fire lasers</p>
    </div>
  </section>

  <!-- API KEY MODAL WITH DEMO -->
  <div class="api-modal-overlay" id="apiModal">
    <button class="api-modal-close" onclick="closeApiModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    
    <div class="api-explainer">
      <div class="api-explainer-inner">
        <div class="api-modal-header">
          <div class="api-modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          </div>
          <div>
            <div class="api-modal-title">Get Your Free API Key</div>
            <div class="api-modal-subtitle">Unlock real AI-powered business intelligence in 30 seconds</div>
          </div>
        </div>
        <div class="api-explainer-content">
          <div class="api-steps">
            <div class="api-step">
              <div class="api-step-num">1</div>
              <div class="api-step-text">Go to <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a></div>
            </div>
            <div class="api-step">
              <div class="api-step-num">2</div>
              <div class="api-step-text">Sign in with Google</div>
            </div>
            <div class="api-step">
              <div class="api-step-num">3</div>
              <div class="api-step-text">Click Create API Key</div>
            </div>
            <div class="api-step">
              <div class="api-step-num">4</div>
              <div class="api-step-text">Paste in search bar above</div>
            </div>
          </div>
          <div class="api-cta-buttons">
            <a href="https://aistudio.google.com/apikey" target="_blank" class="api-modal-btn primary">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
              Get Free API Key
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <div class="demo-results-container">
      <div class="demo-label">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Demo Preview  Sample data shown below
      </div>
      
      <!-- Demo Intel Tabs -->
      <div class="intel-tabs" id="demoTabs">
        <button class="intel-tab active" onclick="switchDemoTab('research')" id="demoTabResearch">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          RESEARCH
          <span class="tab-badge" id="demoBadgeResearch">85%</span>
        </button>
        <button class="intel-tab" onclick="switchDemoTab('background')" id="demoTabBackground">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          BACKGROUND
          <span class="tab-badge" id="demoBadgeBackground">Low</span>
        </button>
        <button class="intel-tab" onclick="switchDemoTab('reviews')" id="demoTabReviews">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          REVIEWS
          <span class="tab-badge" id="demoBadgeReviews">4.4</span>
        </button>
        <button class="intel-tab" onclick="switchDemoTab('social')" id="demoTabSocial">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
          SOCIAL
          <span class="tab-badge" id="demoBadgeSocial">4 profiles</span>
        </button>
        <button class="intel-tab" onclick="switchDemoTab('footprint')" id="demoTabFootprint">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          FOOTPRINT
          <span class="tab-badge" id="demoBadgeFootprint">78/100</span>
        </button>
        <button class="intel-tab" onclick="switchDemoTab('debt')" id="demoTabDebt">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          DEBT
          <span class="tab-badge" id="demoBadgeDebt">2 positions</span>
        </button>
      </div>
      
      <!-- Demo Panels -->
      <div class="intel-panel active" id="demoPanelResearch">
        <div class="card card-accent">
          <div class="card-title">
            <span class="card-title-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Deep Research
            </span>
          </div>
          <div id="demoResearchContent"></div>
        </div>
      </div>
      <div class="intel-panel" id="demoPanelBackground">
        <div class="card card-accent">
          <div class="card-title">
            <span class="card-title-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              Background Check
            </span>
          </div>
          <div id="demoBackgroundContent"></div>
        </div>
      </div>
      <div class="intel-panel" id="demoPanelReviews">
        <div class="card card-accent">
          <div class="card-title">
            <span class="card-title-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              Reviews & Ratings
            </span>
          </div>
          <div id="demoReviewsContent"></div>
        </div>
      </div>
      <div class="intel-panel" id="demoPanelSocial">
        <div class="card card-accent">
          <div class="card-title">
            <span class="card-title-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
              Social Presence
            </span>
          </div>
          <div id="demoSocialContent"></div>
        </div>
      </div>
      <div class="intel-panel" id="demoPanelFootprint">
        <div class="card card-accent">
          <div class="card-title">
            <span class="card-title-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              Digital Footprint
            </span>
          </div>
          <div id="demoFootprintContent"></div>
        </div>
      </div>
      <div class="intel-panel" id="demoPanelDebt">
        <div class="card card-accent">
          <div class="card-title">
            <span class="card-title-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Debt Analysis
            </span>
          </div>
          <div id="demoDebtContent"></div>
        </div>
      </div>
    </div>
  </div>

<script>
let currentBusiness = '';
let selectedModel = 'gemini-3-pro-preview';
let researchData = null, backgroundData = null, footprintData = null, debtData = null, reviewsData = null, socialData = null;

const loadingFacts = [
  "UCC filings remain public record for 5 years and reveal secured creditors.",
  "Secretary of State databases contain entity formation dates and registered agents.",
  "A single negative review can cost a business up to 30 customers.",
  "Companies with consistent NAP data rank 50% higher in local search.",
  "Federal tax liens filed after 2018 no longer appear on credit reports.",
  "PACER contains over 1 billion federal court documents.",
  "The MCA industry processes over $20 billion annually.",
  "Businesses with complete Google profiles get 7x more clicks.",
  "SSL certificates became a Google ranking signal in 2014.",
  "A one-star Yelp increase correlates with 5-9% revenue increase.",
  "Stacked debt positions are a leading indicator of financial distress.",
  "The BBB maintains complaint records for 3 years.",
  "Court records often contain revenue figures disclosed during litigation.",
  "Trademark filings can reveal upcoming product launches."
];

function toggleTheme() {
  document.body.classList.toggle('light-mode');
}

function switchIntelTab(tab) {
  // Scope to only the main results section, not the demo modal
  const resultsSection = document.getElementById('resultsSection');
  resultsSection.querySelectorAll('.intel-tab').forEach(t => t.classList.remove('active'));
  resultsSection.querySelectorAll('.intel-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('panel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

async function runSearch() {
  const input = document.getElementById('businessInput').value.trim();
  if (!input) return;
  currentBusiness = input;
  document.getElementById('businessDisplay').textContent = currentBusiness;
  
  const apiKey = getApiKey();
  
  // If no API key, show demo mode
  if (!apiKey) {
    showDemoMode();
    return;
  }
  
  document.getElementById('heroSection').classList.add('hidden');
  document.getElementById('resultsSection').classList.add('active');
  document.getElementById('orbitSystem').classList.add('dimmed');
  
  // Force light mode for results
  document.body.classList.add('light-mode');
  
  // Reset all panels and show loading states
  ['Research', 'Background', 'Reviews', 'Social', 'Footprint', 'Debt'].forEach(t => {
    document.getElementById('badge' + t).innerHTML = '<span class="badge-spinner"></span>';
    document.getElementById('tab' + t).classList.remove('has-data', 'has-warning');
    document.getElementById('tab' + t).classList.add('loading');
  });
  window.sosData = null;
  window.researchCompleted = false;
  
  // Show initial loading content in ALL panels
  setLoading('research', 'Searching Secretary of State...');
  setLoading('background', 'Scanning court records & UCC filings...');
  setLoading('reviews', 'Finding reviews on Google, Yelp, BBB...');
  setLoading('social', 'Discovering social media profiles...');
  setLoading('footprint', 'Analyzing digital presence...');
  setLoading('debt', 'Searching debt & MCA positions...');
  
  // Start mini game while loading
  startGame();
  
  // ALL IN PARALLEL - fastest possible loading
  runSOSLookup();
  runFullResearchAuto();
  runBackgroundAuto();
  runReviewsAuto();
  runSocialAuto();
  runFootprintAuto();
  runDebtAuto();
}

// Ultra-fast SOS lookup - minimal prompt = faster response
async function runSOSLookup() {
  if (!currentBusiness) return;
  // Don't overwrite loading state - just run the query
  
  const sosPrompt = `Secretary of State lookup for "${currentBusiness}". Return ONLY: {"state":"","status":"","filed_date":"","entity_type":"","entity_number":"","sos_url":""}`;

  try {
    const response = await callGemini(sosPrompt);
    const data = safeJson(response);
    if (data) {
      // Might be nested or flat
      const sr = data.state_registration || data;
      if (sr.state || sr.status) {
        window.sosData = sr; // Store for merge with full research
        // Only render SOS preview if full research hasn't already completed
        if (!window.researchCompleted) {
          renderResearchSOS(sr);
          document.getElementById('badgeResearch').textContent = 'SOS ';
        }
      }
    }
    
  } catch (e) {
    console.log('SOS error:', e);
    
  }
}

// Full research - runs in parallel, merges with SOS when done
async function runFullResearchAuto() {
  if (!currentBusiness) return;
  
  
  const prompt = `Research "${currentBusiness}": company overview, key people, industry, competitors, news, financials. Return ONLY JSON:
{
  "company_name": "",
  "dba": "",
  "industry": "",
  "founded": "",
  "headquarters": "",
  "website": "",
  "employees": "",
  "annual_revenue": "",
  "description": "",
  "key_people": [{"name": "", "title": ""}],
  "competitors": [{"name": "", "website": ""}],
  "recent_news": [{"title": "", "date": "", "summary": "", "url": ""}],
  "products_services": [],
  "confidence_score": 85,
  "summary": ""
}`;
  
  try {
    const response = await callGemini(prompt);
    researchData = safeJson(response);
    if (researchData) {
      // Merge with SOS data if it loaded
      if (window.sosData) {
        researchData.state_registration = window.sosData;
      }
      renderResearchSection(researchData);
      document.getElementById('badgeResearch').textContent = researchData.confidence_score + '%';
      document.getElementById('tabResearch').classList.add('has-data');
      showToast('Research Complete', researchData.company_name || currentBusiness);
    } else if (window.sosData) {
      // SOS succeeded but full research failed - show SOS with error for rest
      renderResearchSOSWithError(window.sosData, 'Could not load full company details - click Run to retry');
      document.getElementById('badgeResearch').textContent = 'SOS ';
    } else {
      setEmpty('research', 'Could not parse research data');
      document.getElementById('badgeResearch').textContent = '--';
    }
    
  } catch (e) {
    if (window.sosData) {
      // SOS succeeded but full research errored - show SOS with error for rest
      renderResearchSOSWithError(window.sosData, 'Error loading details: ' + e.message + ' - click Run to retry');
      document.getElementById('badgeResearch').textContent = 'SOS ';
    } else {
      setEmpty('research', 'Error: ' + e.message);
      document.getElementById('badgeResearch').textContent = 'ERR';
    }
  }
  window.researchCompleted = true; // Mark that full research has finished
  document.getElementById('tabResearch').classList.remove('loading');
}

function newSearch() {
  document.getElementById('heroSection').classList.remove('hidden');
  document.getElementById('resultsSection').classList.remove('active');
  document.getElementById('orbitSystem').classList.remove('dimmed');
  document.body.classList.remove('light-mode');
  document.getElementById('businessInput').value = '';
  currentBusiness = '';
  researchData = backgroundData = footprintData = debtData = reviewsData = socialData = null;
  window.sosData = null;
  window.researchCompleted = false;
  switchIntelTab('research');
  ['researchContent', 'backgroundContent', 'reviewsContent', 'socialContent', 'footprintContent', 'debtContent'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = el.dataset.empty || '<div class="empty-state"><p>Run a search to get data</p></div>';
  });
}

function getApiKey() {
  const input = document.getElementById('apiKey');
  const key = input.value.trim();
  if (key) {
    localStorage.setItem('hubble_api_key', key);
  }
  return key || localStorage.getItem('hubble_api_key') || '';
}

// Load saved API key on page load
document.addEventListener('DOMContentLoaded', () => {
  const savedKey = localStorage.getItem('hubble_api_key');
  if (savedKey) {
    document.getElementById('apiKey').value = savedKey;
  }
});

async function callGemini(prompt) {
  const apiKey = getApiKey();
  if (!apiKey) throw new Error('Please enter your Gemini API key');
  
  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { temperature: 0.7, maxOutputTokens: 8192 },
      tools: [{ googleSearch: {} }]
    })
  });
  
  if (!response.ok) {
    const err = await response.json();
    throw new Error(err.error?.message || 'API Error');
  }
  
  const data = await response.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
}

function safeJson(text) {
  if (!text) return null;
  
  try {
    // Try direct parse first
    return JSON.parse(text);
  } catch (e) {}
  
  try {
    // Try to extract from markdown code block
    const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
    if (codeBlockMatch) {
      return JSON.parse(codeBlockMatch[1]);
    }
  } catch (e) {}
  
  try {
    // Try to extract JSON object
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      let jsonStr = jsonMatch[0];
      // Clean up common issues
      jsonStr = jsonStr.replace(/,\s*}/g, '}'); // trailing commas in objects
      jsonStr = jsonStr.replace(/,\s*]/g, ']'); // trailing commas in arrays
      jsonStr = jsonStr.replace(/'/g, '"'); // single quotes to double
      jsonStr = jsonStr.replace(/(\w+):/g, '"$1":'); // unquoted keys
      jsonStr = jsonStr.replace(/""/g, '"'); // fix double-double quotes
      return JSON.parse(jsonStr);
    }
  } catch (e) {}
  
  // Last resort: try to build object from key patterns
  try {
    const result = {};
    
    // Extract digital_score
    const scoreMatch = text.match(/"?digital_score"?\s*:\s*(\d+)/i);
    if (scoreMatch) result.digital_score = parseInt(scoreMatch[1]);
    
    // Extract web_presence object
    const wpMatch = text.match(/"?web_presence"?\s*:\s*\{([^}]+)\}/i);
    if (wpMatch) {
      result.web_presence = {};
      const wpFields = ['website', 'domain_age', 'ssl_status', 'seo_visibility', 'traffic_estimate'];
      wpFields.forEach(field => {
        const fieldMatch = wpMatch[1].match(new RegExp(`"?${field}"?\\s*:\\s*"([^"]*)"`, 'i'));
        if (fieldMatch) result.web_presence[field] = fieldMatch[1];
      });
    }
    
    // Extract summary
    const summaryMatch = text.match(/"?summary"?\s*:\s*"([^"]*)"/i);
    if (summaryMatch) result.summary = summaryMatch[1];
    
    if (Object.keys(result).length > 0) return result;
  } catch (e) {}
  
  return null;
}

const loadingStatuses = {
  research: [
    "Searching corporate databases...",
    "Analyzing company structure...",
    "Finding key personnel...",
    "Gathering competitor intel...",
    "Compiling financial indicators..."
  ],
  background: [
    "Searching state filings...",
    "Checking UCC records...",
    "Scanning court databases...",
    "Reviewing lien filings...",
    "Analyzing compliance history..."
  ],
  reviews: [
    "Scanning review platforms...",
    "Analyzing sentiment patterns...",
    "Aggregating ratings data...",
    "Identifying review trends...",
    "Calculating reputation score..."
  ],
  social: [
    "Finding social profiles...",
    "Analyzing engagement metrics...",
    "Tracking follower growth...",
    "Evaluating content strategy...",
    "Measuring social authority..."
  ],
  footprint: [
    "Analyzing web presence...",
    "Checking domain authority...",
    "Scanning technology stack...",
    "Reviewing SEO signals...",
    "Mapping digital assets..."
  ],
  debt: [
    "Searching financing records...",
    "Analyzing debt structure...",
    "Checking MCA positions...",
    "Reviewing payment history...",
    "Calculating exposure levels..."
  ]
};

let currentFactIndex = 0;
let factInterval = null;

function getRandomFact() {
  return loadingFacts[Math.floor(Math.random() * loadingFacts.length)];
}

function cycleFacts(containerId) {
  const factText = document.querySelector(`#${containerId} .loading-fact-text`);
  if (factText) {
    currentFactIndex = (currentFactIndex + 1) % loadingFacts.length;
    factText.style.opacity = '0';
    setTimeout(() => {
      factText.textContent = loadingFacts[currentFactIndex];
      factText.style.opacity = '1';
    }, 300);
  }
}

function setLoading(section, msg) {
  const fact = getRandomFact();
  const statuses = loadingStatuses[section] || loadingStatuses.research;
  const containerId = section + 'Content';
  
  document.getElementById(containerId).innerHTML = `
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>${msg}</p>
      <div class="loading-status">
        <div class="loading-status-text" id="${section}Status">${statuses[0]}</div>
        <div class="loading-progress"><div class="loading-progress-bar"></div></div>
      </div>
      <div class="loading-fact">
        <div class="loading-fact-label">While you wait</div>
        <div class="loading-fact-text" style="transition: opacity 0.3s ease;">${fact}</div>
      </div>
    </div>`;
  
  // Cycle through status messages
  let statusIndex = 0;
  const statusInterval = setInterval(() => {
    statusIndex = (statusIndex + 1) % statuses.length;
    const statusEl = document.getElementById(section + 'Status');
    if (statusEl) {
      statusEl.textContent = statuses[statusIndex];
    } else {
      clearInterval(statusInterval);
    }
  }, 3000);
  
  // Cycle through facts every 8 seconds
  const factCycleInterval = setInterval(() => {
    cycleFacts(containerId);
  }, 8000);
  
  // Store interval IDs to clear them later
  if (!window.loadingIntervals) window.loadingIntervals = {};
  if (window.loadingIntervals[section]) {
    clearInterval(window.loadingIntervals[section].status);
    clearInterval(window.loadingIntervals[section].fact);
  }
  window.loadingIntervals[section] = { status: statusInterval, fact: factCycleInterval };
}

function setEmpty(section, msg) {
  // Clear any running intervals
  if (window.loadingIntervals && window.loadingIntervals[section]) {
    clearInterval(window.loadingIntervals[section].status);
    clearInterval(window.loadingIntervals[section].fact);
  }
  document.getElementById(section + 'Content').innerHTML = `<div class="empty-state"><p>${msg}</p></div>`;
}

function clearLoadingInterval(section) {
  if (window.loadingIntervals && window.loadingIntervals[section]) {
    clearInterval(window.loadingIntervals[section].status);
    clearInterval(window.loadingIntervals[section].fact);
  }
}

// ==================== RESEARCH ====================
// Render just the SOS section first while rest loads
function renderResearchSOS(sr) {
  const status = (sr.status || '').toLowerCase();
  let h = `<div class="section-box" style="border-left:4px solid var(--accent-gold);"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>State Registration</div><div class="data-grid" style="grid-template-columns:1fr 1fr;">`;
  if (sr.state) h += `<div><div class="label">State</div><div class="value">${sr.state}</div></div>`;
  if (sr.status) h += `<div><div class="label">Status</div><div class="value"><span class="status-badge ${status.includes('active') ? 'good' : 'active'}">${sr.status}</span></div></div>`;
  if (sr.filed_date) h += `<div><div class="label">Filed Date</div><div class="value">${sr.filed_date}</div></div>`;
  if (sr.entity_type) h += `<div><div class="label">Entity Type</div><div class="value">${sr.entity_type}</div></div>`;
  if (sr.entity_number) h += `<div><div class="label">Entity Number</div><div class="value">${sr.entity_number}</div></div>`;
  if (sr.registered_agent) h += `<div><div class="label">Registered Agent</div><div class="value">${sr.registered_agent}</div></div>`;
  if (sr.sos_url) h += `<div style="grid-column:span 2;"><div class="label">Secretary of State</div><div class="value"><a href="${sr.sos_url}" target="_blank" style="color:var(--accent-blue)">View Official Filing </a></div></div>`;
  h += `</div></div>`;
  
  // Show SOS first, then loading indicator for rest
  h += `<div class="section-box" style="text-align:center;padding:30px;color:var(--text-muted);"><div class="spinner" style="margin:0 auto 12px;"></div><p>Loading company details...</p></div>`;
  
  document.getElementById('researchContent').innerHTML = h;
}

// Render SOS with error message when full research fails
function renderResearchSOSWithError(sr, errorMsg) {
  clearLoadingInterval('research');
  stopGame();
  const status = (sr.status || '').toLowerCase();
  let h = `<div class="section-box" style="border-left:4px solid var(--accent-gold);"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>State Registration</div><div class="data-grid" style="grid-template-columns:1fr 1fr;">`;
  if (sr.state) h += `<div><div class="label">State</div><div class="value">${sr.state}</div></div>`;
  if (sr.status) h += `<div><div class="label">Status</div><div class="value"><span class="status-badge ${status.includes('active') ? 'good' : 'active'}">${sr.status}</span></div></div>`;
  if (sr.filed_date) h += `<div><div class="label">Filed Date</div><div class="value">${sr.filed_date}</div></div>`;
  if (sr.entity_type) h += `<div><div class="label">Entity Type</div><div class="value">${sr.entity_type}</div></div>`;
  if (sr.entity_number) h += `<div><div class="label">Entity Number</div><div class="value">${sr.entity_number}</div></div>`;
  if (sr.registered_agent) h += `<div><div class="label">Registered Agent</div><div class="value">${sr.registered_agent}</div></div>`;
  if (sr.sos_url) h += `<div style="grid-column:span 2;"><div class="label">Secretary of State</div><div class="value"><a href="${sr.sos_url}" target="_blank" style="color:var(--accent-blue)">View Official Filing </a></div></div>`;
  h += `</div></div>`;
  
  // Show error message instead of loading spinner
  h += `<div class="section-box" style="text-align:center;padding:30px;color:var(--text-muted);border-left:4px solid var(--tier-d);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;margin-bottom:8px;color:var(--tier-d);"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>${errorMsg}</p></div>`;
  
  document.getElementById('researchContent').innerHTML = h;
}

function updateLoadingStatus(section, message) {
  const el = document.querySelector(`#${section}Content .loading-status`);
  if (el) el.textContent = message;
}

function renderResearchSection(d) {
  clearLoadingInterval('research');
  stopGame(); // Hide game when data arrives
  let h = `<div class="risk-banner low"><div class="risk-badge"><span>${d.confidence_score || 0}</span></div><div class="risk-info"><h3>Confidence Score: ${d.confidence_score || 0}%</h3><p>Data reliability assessment</p></div></div>`;
  
  h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Company Overview</div><div class="data-grid">`;
  if (d.company_name) h += `<div><div class="label">Company Name</div><div class="value">${d.company_name}</div></div>`;
  if (d.dba) h += `<div><div class="label">DBA</div><div class="value">${d.dba}</div></div>`;
  if (d.industry) h += `<div><div class="label">Industry</div><div class="value">${d.industry}</div></div>`;
  if (d.founded) h += `<div><div class="label">Founded</div><div class="value">${d.founded}</div></div>`;
  if (d.headquarters) h += `<div><div class="label">Headquarters</div><div class="value">${d.headquarters}</div></div>`;
  if (d.website) h += `<div><div class="label">Website</div><div class="value"><a href="${d.website.startsWith('http') ? d.website : 'https://' + d.website}" target="_blank" style="color:var(--accent-blue)">${d.website}</a></div></div>`;
  if (d.employees) h += `<div><div class="label">Employees</div><div class="value">${d.employees}</div></div>`;
  if (d.annual_revenue) h += `<div><div class="label">Annual Revenue</div><div class="value">${d.annual_revenue}</div></div>`;
  h += `</div></div>`;
  
  // State Registration section
  if (d.state_registration) {
    const sr = d.state_registration;
    const status = (sr.status || '').toLowerCase();
    h += `<div class="section-box" style="border-left:4px solid var(--accent-gold);"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>State Registration</div><div class="data-grid" style="grid-template-columns:1fr 1fr;">`;
    if (sr.state) h += `<div><div class="label">State</div><div class="value">${sr.state}</div></div>`;
    if (sr.status) h += `<div><div class="label">Status</div><div class="value"><span class="status-badge ${status.includes('active') ? 'good' : 'active'}">${sr.status}</span></div></div>`;
    if (sr.filed_date) h += `<div><div class="label">Filed Date</div><div class="value">${sr.filed_date}</div></div>`;
    if (sr.entity_type) h += `<div><div class="label">Entity Type</div><div class="value">${sr.entity_type}</div></div>`;
    if (sr.entity_number) h += `<div><div class="label">Entity Number</div><div class="value">${sr.entity_number}</div></div>`;
    if (sr.registered_agent) h += `<div><div class="label">Registered Agent</div><div class="value">${sr.registered_agent}</div></div>`;
    if (sr.sos_url) h += `<div style="grid-column:span 2;"><div class="label">Secretary of State</div><div class="value"><a href="${sr.sos_url}" target="_blank" style="color:var(--accent-blue)">View Official Filing </a></div></div>`;
    h += `</div></div>`;
  }
  
  if (d.description) h += `<div class="section-box"><div class="section-title">Description</div><p style="font-size:0.9rem;color:var(--text-secondary);line-height:1.7;">${d.description}</p></div>`;
  
  if (d.key_people?.length) {
    h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Key People</div>`;
    d.key_people.forEach(p => {
      const link = p.linkedin_url ? `<a href="${p.linkedin_url}" target="_blank" style="color:var(--accent-blue);font-size:0.75rem;margin-left:8px;">LinkedIn</a>` : '';
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${p.name}${link}</span><span class="status-badge good">${p.title}</span></div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.products_services?.length) h += `<div class="section-box"><div class="section-title">Products & Services</div><p style="font-size:0.9rem;color:var(--text-secondary);">${d.products_services.join(', ')}</p></div>`;
  
  if (d.competitors?.length) {
    h += `<div class="section-box"><div class="section-title">Competitors</div><p style="font-size:0.9rem;color:var(--text-secondary);">`;
    const compLinks = d.competitors.map(c => {
      if (typeof c === 'string') return c;
      return c.website ? `<a href="${c.website.startsWith('http') ? c.website : 'https://' + c.website}" target="_blank" style="color:var(--accent-blue)">${c.name}</a>` : c.name;
    });
    h += compLinks.join(', ') + `</p></div>`;
  }
  
  if (d.recent_news?.length) {
    h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>Recent News</div>`;
    d.recent_news.forEach(n => {
      const link = n.url ? `<a href="${n.url}" target="_blank" style="color:var(--accent-blue)">${n.title}</a>` : n.title;
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${link}</span><span class="status-badge warning">${n.date || 'Recent'}</span></div><div class="record-meta">${n.summary || ''}</div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Summary</h4><p>${d.summary}</p></div>`;
  document.getElementById('researchContent').innerHTML = h;
}

// ==================== BACKGROUND ====================
async function runBackgroundAuto() {
  if (!currentBusiness) return;
  document.getElementById('tabBackground').classList.add('loading');
  setLoading('background', 'Running background check on ' + currentBusiness + '...');
  
  
  const prompt = `Search for legal and compliance information about "${currentBusiness}" including UCC filings, liens, judgments, lawsuits, bankruptcies. Include source URLs where available. Return ONLY valid JSON (no markdown, no explanation):
{
  "ucc_filings": [{"filing_number": "", "secured_party": "", "filed_date": "", "status": "", "source_url": ""}],
  "liens": [{"type": "", "amount": "", "filed_date": "", "status": "", "court_url": ""}],
  "judgments": [{"case": "", "amount": "", "date": "", "status": "", "court_url": ""}],
  "lawsuits": [{"case_name": "", "case_number": "", "court": "", "type": "", "status": "", "date": "", "court_url": ""}],
  "bankruptcies": [{"case_number": "", "chapter": "", "date": "", "status": "", "pacer_url": ""}],
  "risk_score": 25,
  "red_flags": [],
  "summary": ""
}`;
  
  try {
    const response = await callGemini(prompt);
    console.log('Background raw response:', response?.substring(0, 500));
    backgroundData = safeJson(response);
    
    if (backgroundData && (backgroundData.risk_score !== undefined || backgroundData.ucc_filings || backgroundData.summary)) {
      renderBackgroundSection(backgroundData);
      const score = backgroundData.risk_score || 0;
      document.getElementById('badgeBackground').textContent = score <= 30 ? 'Low' : score <= 60 ? 'Med' : 'High';
      document.getElementById('tabBackground').classList.add('has-data');
      if (score > 50) document.getElementById('tabBackground').classList.add('has-warning');
      showToast('Background Complete', `Risk score: ${score}`);
    } else {
      console.log('Background parse failed, data:', backgroundData);
      setEmpty('background', 'Could not parse background data - try clicking Run to retry');
      document.getElementById('badgeBackground').textContent = '--';
    }
  } catch (e) {
    console.error('Background error:', e);
    setEmpty('background', 'Error: ' + e.message);
    document.getElementById('badgeBackground').textContent = 'ERR';
  }
  
  document.getElementById('tabBackground').classList.remove('loading');
}

function renderBackgroundSection(d) {
  clearLoadingInterval('background');
  stopGame(); // Hide game when data arrives
  const score = d.risk_score || 0;
  const cls = score <= 30 ? 'low' : score <= 60 ? 'medium' : 'high';
  let h = `<div class="risk-banner ${cls}"><div class="risk-badge"><span>${score}</span></div><div class="risk-info"><h3>Risk Score: ${score}/100</h3><p>${cls.charAt(0).toUpperCase() + cls.slice(1)} risk assessment</p></div></div>`;
  
  const renderRecords = (items, title, icon) => {
    if (!items?.length) return '';
    let s = `<div class="section-box"><div class="section-title">${icon}${title} (${items.length})</div>`;
    items.forEach(i => {
      const status = (i.status || '').toLowerCase();
      const cls = status.includes('active') || status.includes('open') ? 'active' : 'good';
      const url = i.source_url || i.court_url || i.pacer_url;
      const titleText = i.filing_number || i.case || i.case_name || i.case_number || i.type || 'Record';
      const titleLink = url ? `<a href="${url}" target="_blank" style="color:var(--accent-blue)">${titleText}</a>` : titleText;
      s += `<div class="record-item"><div class="record-header"><span class="record-title">${titleLink}</span><span class="status-badge ${cls}">${i.status || 'N/A'}</span></div><div class="record-meta">${i.court || ''} ${i.filed_date || i.date || ''} ${i.amount ? '| ' + i.amount : ''} ${i.secured_party ? '| ' + i.secured_party : ''} ${i.chapter ? '| Chapter ' + i.chapter : ''}</div></div>`;
    });
    return s + '</div>';
  };
  
  h += renderRecords(d.ucc_filings, 'UCC Filings', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:8px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>');
  h += renderRecords(d.liens, 'Liens', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:8px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg>');
  h += renderRecords(d.judgments, 'Judgments', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:8px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>');
  h += renderRecords(d.lawsuits, 'Lawsuits', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:8px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>');
  h += renderRecords(d.bankruptcies, 'Bankruptcies', '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;margin-right:8px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>');
  
  if (d.red_flags?.length) {
    h += `<div class="red-flags"><h4><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Red Flags</h4><ul>${d.red_flags.map(f => `<li>${f}</li>`).join('')}</ul></div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('backgroundContent').innerHTML = h;
}

// ==================== REVIEWS ====================
async function runReviewsAuto() {
  if (!currentBusiness) return;
  document.getElementById('tabReviews').classList.add('loading');
  setLoading('reviews', 'Finding reviews for ' + currentBusiness + '...');
  
  
  const prompt = `Search for reviews and ratings for "${currentBusiness}" on Google, Yelp, BBB, Trustpilot, and other review platforms. Find at least 3-5 actual reviews with the review text. Return ONLY valid JSON:
{
  "google": {"rating": 0, "count": 0, "url": "", "recent_reviews": [{"text": "", "author": "", "rating": 0, "date": ""}]},
  "yelp": {"rating": 0, "count": 0, "url": "", "recent_reviews": [{"text": "", "author": "", "rating": 0, "date": ""}]},
  "bbb": {"rating": "", "accredited": false, "complaints": 0, "years_accredited": 0, "url": ""},
  "trustpilot": {"rating": 0, "count": 0, "url": ""},
  "other_platforms": [{"platform": "", "rating": 0, "count": 0, "url": ""}],
  "overall_sentiment": "Positive/Mixed/Negative",
  "average_rating": 0,
  "total_reviews": 0,
  "summary": ""
}`;
  
  try {
    const response = await callGemini(prompt);
    reviewsData = safeJson(response);
    if (reviewsData) {
      renderReviewsSection(reviewsData);
      const avg = reviewsData.average_rating || 0;
      document.getElementById('badgeReviews').textContent = avg.toFixed(1) + ' avg';
      document.getElementById('tabReviews').classList.add('has-data');
      if (avg < 3) document.getElementById('tabReviews').classList.add('has-warning');
      showToast('Reviews Complete', `${reviewsData.total_reviews || 0} reviews found`);
    } else {
      setEmpty('reviews', 'Could not parse reviews data');
      document.getElementById('badgeReviews').textContent = 'ERR';
    }
  } catch (e) {
    setEmpty('reviews', 'Error: ' + e.message);
    document.getElementById('badgeReviews').textContent = 'ERR';
  }
  
  document.getElementById('tabReviews').classList.remove('loading');
}

function renderReviewsSection(d) {
  clearLoadingInterval('reviews');
  const avg = d.average_rating || 0;
  const cls = avg >= 4 ? 'low' : avg >= 3 ? 'medium' : 'high';
  let h = `<div class="risk-banner ${cls}"><div class="risk-badge"><span>${avg.toFixed(1)}</span></div><div class="risk-info"><h3>Average Rating: ${avg.toFixed(1)}/5</h3><p>${d.total_reviews || 0} total reviews - ${d.overall_sentiment || 'Mixed'} sentiment</p></div></div>`;
  
  h += `<div class="stats-row"><div class="stat-card"><div class="stat-value">${d.total_reviews || 0}</div><div class="stat-label">Total Reviews</div></div><div class="stat-card"><div class="stat-value">${avg.toFixed(1)}</div><div class="stat-label">Avg Rating</div></div><div class="stat-card"><div class="stat-value">${d.overall_sentiment || 'N/A'}</div><div class="stat-label">Sentiment</div></div></div>`;
  
  h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Platform Ratings</div><div class="review-grid">`;
  
  if (d.google) { 
    const r = d.google.rating || 0; 
    const link = d.google.url ? `<a href="${d.google.url}" target="_blank" class="social-link" style="display:block;margin-top:8px;">View on Google</a>` : '';
    h += `<div class="review-card"><div class="review-platform">Google</div><div class="review-rating ${r >= 4 ? 'good' : r >= 3 ? 'ok' : 'bad'}">${r.toFixed(1)}</div><div class="review-count">${d.google.count || 0} reviews</div>${link}</div>`; 
  }
  if (d.yelp) { 
    const r = d.yelp.rating || 0; 
    const link = d.yelp.url ? `<a href="${d.yelp.url}" target="_blank" class="social-link" style="display:block;margin-top:8px;">View on Yelp</a>` : '';
    h += `<div class="review-card"><div class="review-platform">Yelp</div><div class="review-rating ${r >= 4 ? 'good' : r >= 3 ? 'ok' : 'bad'}">${r.toFixed(1)}</div><div class="review-count">${d.yelp.count || 0} reviews</div>${link}</div>`; 
  }
  if (d.bbb) {
    const link = d.bbb.url ? `<a href="${d.bbb.url}" target="_blank" class="social-link" style="display:block;margin-top:8px;">View on BBB</a>` : '';
    h += `<div class="review-card"><div class="review-platform">BBB</div><div class="review-rating good">${d.bbb.rating || '--'}</div><div class="review-count">${d.bbb.complaints || 0} complaints</div>${link}</div>`;
  }
  if (d.trustpilot) { 
    const r = d.trustpilot.rating || 0; 
    const link = d.trustpilot.url ? `<a href="${d.trustpilot.url}" target="_blank" class="social-link" style="display:block;margin-top:8px;">View on Trustpilot</a>` : '';
    h += `<div class="review-card"><div class="review-platform">Trustpilot</div><div class="review-rating ${r >= 4 ? 'good' : r >= 3 ? 'ok' : 'bad'}">${r.toFixed(1)}</div><div class="review-count">${d.trustpilot.count || 0} reviews</div>${link}</div>`; 
  }
  
  // Add other platforms
  if (d.other_platforms?.length) {
    d.other_platforms.forEach(p => {
      if (p.platform) {
        const r = p.rating || 0;
        const link = p.url ? `<a href="${p.url}" target="_blank" class="social-link" style="display:block;margin-top:8px;">View</a>` : '';
        h += `<div class="review-card"><div class="review-platform">${p.platform}</div><div class="review-rating ${r >= 4 ? 'good' : r >= 3 ? 'ok' : 'bad'}">${r.toFixed(1)}</div><div class="review-count">${p.count || 0} reviews</div>${link}</div>`;
      }
    });
  }
  
  h += `</div></div>`;
  
  // Recent reviews - show at least 3
  const allReviews = [...(d.google?.recent_reviews || []).map(r => ({...r, source: 'Google'})), 
                      ...(d.yelp?.recent_reviews || []).map(r => ({...r, source: 'Yelp'}))];
  if (allReviews.length) {
    h += `<div class="section-box"><div class="section-title">Recent Reviews (${allReviews.length})</div>`;
    allReviews.slice(0, 6).forEach(r => {
      const stars = r.rating || 0;
      const starDisplay = Array(5).fill(0).map((_, i) => i < stars ? '<span style="color:var(--accent);">*</span>' : '<span style="color:var(--text-muted);">*</span>').join('');
      h += `<div class="record-item" style="padding:16px 0;">
        <div class="record-header" style="margin-bottom:8px;">
          <span class="record-title">${r.author || 'Anonymous'} <span style="font-weight:400;color:var(--text-muted);font-size:0.8rem;">via ${r.source}</span></span>
          <span class="status-badge ${stars >= 4 ? 'good' : stars >= 3 ? 'warning' : 'active'}">${stars}/5</span>
        </div>
        <div style="font-size:0.9rem;color:var(--text-secondary);line-height:1.6;margin-bottom:6px;">"${r.text || 'No review text'}"</div>
        <div class="record-meta">${r.date || 'Recent'}</div>
      </div>`;
    });
    h += `</div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('reviewsContent').innerHTML = h;
}

// ==================== SOCIAL ====================
async function runSocialAuto() {
  if (!currentBusiness) return;
  document.getElementById('tabSocial').classList.add('loading');
  setLoading('social', 'Finding social profiles for ' + currentBusiness + '...');
  
  
  const prompt = `Search for social media profiles and presence for "${currentBusiness}" on Facebook, Instagram, Twitter/X, LinkedIn, YouTube, TikTok, and other platforms. Return ONLY valid JSON:
{
  "profiles": [
    {"platform": "Facebook", "url": "", "followers": "", "engagement": "", "last_post": "", "verified": false},
    {"platform": "Instagram", "url": "", "followers": "", "engagement": "", "last_post": "", "verified": false},
    {"platform": "Twitter/X", "url": "", "followers": "", "engagement": "", "last_post": "", "verified": false},
    {"platform": "LinkedIn", "url": "", "followers": "", "engagement": "", "last_post": "", "verified": false},
    {"platform": "YouTube", "url": "", "subscribers": "", "videos": "", "verified": false},
    {"platform": "TikTok", "url": "", "followers": "", "likes": "", "verified": false}
  ],
  "total_followers": "",
  "most_active_platform": "",
  "social_score": 75,
  "summary": ""
}`;
  
  try {
    const response = await callGemini(prompt);
    socialData = safeJson(response);
    if (socialData) {
      renderSocialSection(socialData);
      const count = socialData.profiles?.filter(p => p.url).length || 0;
      document.getElementById('badgeSocial').textContent = count + ' profiles';
      document.getElementById('tabSocial').classList.add('has-data');
      showToast('Social Complete', `Found ${count} profiles`);
    } else {
      setEmpty('social', 'Could not parse social data');
      document.getElementById('badgeSocial').textContent = 'ERR';
    }
  } catch (e) {
    setEmpty('social', 'Error: ' + e.message);
    document.getElementById('badgeSocial').textContent = 'ERR';
  }
  
  document.getElementById('tabSocial').classList.remove('loading');
}

function renderSocialSection(d) {
  clearLoadingInterval('social');
  const score = d.social_score || 0;
  const cls = score >= 70 ? 'low' : score >= 40 ? 'medium' : 'high';
  let h = `<div class="risk-banner ${cls}"><div class="risk-badge"><span>${score}</span></div><div class="risk-info"><h3>Social Score: ${score}/100</h3><p>Social media presence strength</p></div></div>`;
  
  const activeProfiles = d.profiles?.filter(p => p.url || p.followers || p.subscribers) || [];
  h += `<div class="stats-row"><div class="stat-card"><div class="stat-value">${activeProfiles.length}</div><div class="stat-label">Active Profiles</div></div><div class="stat-card"><div class="stat-value">${d.total_followers || 'N/A'}</div><div class="stat-label">Total Followers</div></div><div class="stat-card"><div class="stat-value">${d.most_active_platform || 'N/A'}</div><div class="stat-label">Most Active</div></div></div>`;
  
  if (activeProfiles.length) {
    h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>Social Profiles</div><div class="social-grid">`;
    activeProfiles.forEach(p => {
      const platformLink = p.url ? `<a href="${p.url}" target="_blank" style="color:var(--accent-blue);font-weight:600;">${p.platform}</a>` : p.platform;
      h += `<div class="social-card">
        <div class="social-platform">${platformLink} ${p.verified ? '<span style="color:var(--accent-blue);">&#10003;</span>' : ''}</div>
        <div class="social-followers">${p.followers || p.subscribers || 'N/A'} followers</div>
        ${p.engagement ? `<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:4px;">Engagement: ${p.engagement}</div>` : ''}
        ${p.last_post ? `<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px;">Last post: ${p.last_post}</div>` : ''}
        ${p.url ? `<a href="${p.url}" target="_blank" class="social-link">View Profile</a>` : ''}
      </div>`;
    });
    h += `</div></div>`;
  } else {
    h += `<div class="section-box" style="text-align:center;padding:40px;color:var(--text-muted);"><p>No social media profiles found</p></div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('socialContent').innerHTML = h;
}

// ==================== FOOTPRINT ====================
async function runFootprintAuto() {
  if (!currentBusiness) return;
  document.getElementById('tabFootprint').classList.add('loading');
  setLoading('footprint', 'Analyzing digital footprint for ' + currentBusiness + '...');
  
  
  const prompt = `Search for digital footprint information about "${currentBusiness}" including website details, SEO visibility, domain info, and news mentions. Include URLs. Return ONLY valid JSON (no markdown, no explanation):
{
  "web_presence": {
    "website": "",
    "domain_age": "",
    "ssl_status": "",
    "seo_visibility": "",
    "traffic_estimate": "",
    "technologies": []
  },
  "news_mentions": [{"title": "", "source": "", "date": "", "sentiment": "Positive/Neutral/Negative", "url": ""}],
  "digital_score": 75,
  "summary": ""
}`;
  
  try {
    const response = await callGemini(prompt);
    console.log('Footprint raw response:', response?.substring(0, 500));
    footprintData = safeJson(response);
    
    if (footprintData && (footprintData.web_presence || footprintData.digital_score)) {
      renderFootprintSection(footprintData);
      document.getElementById('badgeFootprint').textContent = (footprintData.digital_score || 50) + '/100';
      document.getElementById('tabFootprint').classList.add('has-data');
      showToast('Footprint Complete', `Digital score: ${footprintData.digital_score || 'N/A'}`);
    } else {
      console.log('Footprint parse failed, data:', footprintData);
      setEmpty('footprint', 'Could not parse footprint data - try clicking Run to retry');
      document.getElementById('badgeFootprint').textContent = '--';
    }
  } catch (e) {
    console.error('Footprint error:', e);
    setEmpty('footprint', 'Error: ' + e.message);
    document.getElementById('badgeFootprint').textContent = 'ERR';
  }
  
  document.getElementById('tabFootprint').classList.remove('loading');
}

function renderFootprintSection(d) {
  clearLoadingInterval('footprint');
  const score = d.digital_score || 0;
  const cls = score >= 70 ? 'low' : score >= 40 ? 'medium' : 'high';
  let h = `<div class="risk-banner ${cls}"><div class="risk-badge"><span>${score}</span></div><div class="risk-info"><h3>Digital Score: ${score}/100</h3><p>Online presence strength</p></div></div>`;
  
  if (d.web_presence) {
    h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/></svg>Web Presence</div><div class="data-grid" style="grid-template-columns:1fr 1fr;">`;
    if (d.web_presence.website) h += `<div><div class="label">Website</div><div class="value"><a href="${d.web_presence.website.startsWith('http') ? d.web_presence.website : 'https://' + d.web_presence.website}" target="_blank" style="color:var(--accent-blue)">${d.web_presence.website}</a></div></div>`;
    if (d.web_presence.domain_age) h += `<div><div class="label">Domain Age</div><div class="value">${d.web_presence.domain_age}</div></div>`;
    if (d.web_presence.ssl_status) h += `<div><div class="label">SSL</div><div class="value">${d.web_presence.ssl_status}</div></div>`;
    if (d.web_presence.seo_visibility) h += `<div><div class="label">SEO</div><div class="value">${d.web_presence.seo_visibility}</div></div>`;
    if (d.web_presence.traffic_estimate) h += `<div><div class="label">Traffic</div><div class="value">${d.web_presence.traffic_estimate}</div></div>`;
    if (d.web_presence.technologies?.length) h += `<div style="grid-column:span 2;"><div class="label">Technologies</div><div class="value">${d.web_presence.technologies.join(', ')}</div></div>`;
    h += `</div></div>`;
  }
  
  if (d.news_mentions?.length) {
    h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>News Mentions (${d.news_mentions.length})</div>`;
    d.news_mentions.slice(0, 5).forEach(n => {
      const sent = (n.sentiment || '').toLowerCase();
      const cls = sent.includes('positive') ? 'good' : sent.includes('negative') ? 'active' : 'warning';
      const titleLink = n.url ? `<a href="${n.url}" target="_blank" style="color:var(--accent-blue)">${n.title || 'News'}</a>` : (n.title || 'News');
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${titleLink}</span><span class="status-badge ${cls}">${n.sentiment || 'Neutral'}</span></div><div class="record-meta">${n.source || ''} ${n.date ? '| ' + n.date : ''}</div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('footprintContent').innerHTML = h;
}

// ==================== DEBT ====================
async function runDebtAuto() {
  if (!currentBusiness) return;
  document.getElementById('tabDebt').classList.add('loading');
  setLoading('debt', 'Analyzing debt for ' + currentBusiness + '...');
  
  
  const prompt = `Search for debt and financing information about "${currentBusiness}" including MCA positions, term loans, lines of credit, stacking indicators. Include source URLs where available. Return ONLY valid JSON:
{
  "mca_positions": [{"funder": "", "original_amount": "", "estimated_balance": "", "daily_payment": "", "status": "Active/Paid Off", "ucc_url": ""}],
  "term_loans": [{"lender": "", "type": "", "original_amount": "", "monthly_payment": "", "status": "", "source_url": ""}],
  "lines_of_credit": [{"lender": "", "limit": "", "utilization": "", "status": "", "source_url": ""}],
  "stacking_indicators": [],
  "active_positions": 0,
  "estimated_total_debt": "$0",
  "estimated_monthly_obligations": "$0",
  "risk_level": "Low/Medium/High",
  "summary": ""
}`;
  
  try {
    const response = await callGemini(prompt);
    debtData = safeJson(response);
    if (debtData) {
      renderDebtSection(debtData);
      const positions = debtData.active_positions || 0;
      document.getElementById('badgeDebt').textContent = positions + ' positions';
      document.getElementById('tabDebt').classList.add('has-data');
      if (positions > 0) document.getElementById('tabDebt').classList.add('has-warning');
      showToast('Debt Analysis Complete', `${positions} positions found`);
    } else {
      setEmpty('debt', 'Could not parse debt data');
      document.getElementById('badgeDebt').textContent = 'ERR';
    }
  } catch (e) {
    setEmpty('debt', 'Error: ' + e.message);
    document.getElementById('badgeDebt').textContent = 'ERR';
  }
  
  document.getElementById('tabDebt').classList.remove('loading');
}

function renderDebtSection(d) {
  clearLoadingInterval('debt');
  const risk = (d.risk_level || 'medium').toLowerCase();
  const letter = risk === 'low' ? 'L' : risk === 'high' ? 'H' : 'M';
  let h = `<div class="risk-banner ${risk}"><div class="risk-badge"><span>${letter}</span></div><div class="risk-info"><h3>${d.risk_level || 'Medium'} Debt Risk</h3><p>${d.active_positions || 0} active positions</p></div></div>`;
  
  h += `<div class="stats-row"><div class="stat-card"><div class="stat-value">${d.active_positions || 0}</div><div class="stat-label">Positions</div></div><div class="stat-card"><div class="stat-value">${d.estimated_total_debt || '$0'}</div><div class="stat-label">Est. Total Debt</div></div><div class="stat-card"><div class="stat-value">${d.estimated_monthly_obligations || '$0'}</div><div class="stat-label">Monthly Obligations</div></div></div>`;
  
  const renderPos = (items, title) => {
    if (!items?.length) return '';
    let s = `<div class="section-box"><div class="section-title">${title} (${items.length})</div>`;
    items.forEach(i => {
      const status = (i.status || '').toLowerCase();
      const cls = status.includes('active') ? 'active' : 'good';
      const url = i.ucc_url || i.source_url;
      const name = i.funder || i.lender || 'Unknown';
      const nameLink = url ? `<a href="${url}" target="_blank" style="color:var(--accent-blue)">${name}</a>` : name;
      s += `<div class="record-item"><div class="record-header"><span class="record-title">${nameLink}</span><span class="status-badge ${cls}">${i.status || 'Active'}</span></div><div class="record-meta">Original: ${i.original_amount || 'N/A'} | Payment: ${i.daily_payment || i.monthly_payment || 'N/A'}${i.limit ? ' | Limit: ' + i.limit : ''}${i.utilization ? ' | Utilization: ' + i.utilization : ''}</div></div>`;
    });
    return s + '</div>';
  };
  
  h += renderPos(d.mca_positions, 'MCA Positions');
  h += renderPos(d.term_loans, 'Term Loans');
  h += renderPos(d.lines_of_credit, 'Lines of Credit');
  
  if (d.stacking_indicators?.length) {
    h += `<div class="red-flags"><h4><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Stacking Indicators</h4><ul>${d.stacking_indicators.map(s => `<li>${s}</li>`).join('')}</ul></div>`;
  }
  
  if (!d.mca_positions?.length && !d.term_loans?.length && !d.lines_of_credit?.length) {
    h += `<div class="section-box" style="text-align:center;padding:40px;color:var(--tier-a);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:32px;height:32px;margin-bottom:8px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><p style="font-weight:600;">No Debt Positions Found</p></div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('debtContent').innerHTML = h;
}

function showToast(title, msg) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = `<strong>${title}</strong>${msg}`;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

// ==================== API KEY MODAL & DEMO MODE ====================
function showApiModal() {
  document.getElementById('apiModal').classList.add('active');
  loadDemoData();
}

function closeApiModal() {
  document.getElementById('apiModal').classList.remove('active');
}

function switchDemoTab(tab) {
  document.querySelectorAll('#demoTabs .intel-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.demo-results-container .intel-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('demoTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('demoPanel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

function showDemoMode() {
  showApiModal();
}

function renderDemoResearch(d) {
  let h = `<div class="risk-banner low"><div class="risk-badge"><span>${d.confidence_score || 0}</span></div><div class="risk-info"><h3>Confidence Score: ${d.confidence_score || 0}%</h3><p>Data reliability assessment</p></div></div>`;
  
  h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Company Overview</div><div class="data-grid">`;
  if (d.company_name) h += `<div><div class="label">Company Name</div><div class="value">${d.company_name}</div></div>`;
  if (d.industry) h += `<div><div class="label">Industry</div><div class="value">${d.industry}</div></div>`;
  if (d.founded) h += `<div><div class="label">Founded</div><div class="value">${d.founded}</div></div>`;
  if (d.headquarters) h += `<div><div class="label">Headquarters</div><div class="value">${d.headquarters}</div></div>`;
  if (d.website) h += `<div><div class="label">Website</div><div class="value" style="color:var(--accent-blue)">${d.website}</div></div>`;
  if (d.employees) h += `<div><div class="label">Employees</div><div class="value">${d.employees}</div></div>`;
  if (d.annual_revenue) h += `<div><div class="label">Annual Revenue</div><div class="value">${d.annual_revenue}</div></div>`;
  h += `</div></div>`;
  
  if (d.key_people?.length) {
    h += `<div class="section-box"><div class="section-title"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Key People</div>`;
    d.key_people.forEach(p => {
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${p.name}</span><span class="status-badge good">${p.title}</span></div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Summary</h4><p>${d.summary}</p></div>`;
  document.getElementById('demoResearchContent').innerHTML = h;
}

function renderDemoBackground(d) {
  const risk = (d.risk_score || 'low').toLowerCase();
  let h = `<div class="risk-banner ${risk}"><div class="risk-badge"><span>${risk.charAt(0).toUpperCase()}</span></div><div class="risk-info"><h3>${d.risk_score || 'Low'} Risk</h3><p>Legal & compliance assessment</p></div></div>`;
  
  if (d.state_registration) {
    h += `<div class="section-box"><div class="section-title">State Registration</div><div class="data-grid">`;
    h += `<div><div class="label">State</div><div class="value">${d.state_registration.state}</div></div>`;
    h += `<div><div class="label">Status</div><div class="value">${d.state_registration.status}</div></div>`;
    h += `<div><div class="label">Filed Date</div><div class="value">${d.state_registration.filed_date}</div></div>`;
    h += `<div><div class="label">Entity Type</div><div class="value">${d.state_registration.entity_type}</div></div>`;
    h += `</div></div>`;
  }
  
  if (d.ucc_filings?.length) {
    h += `<div class="section-box"><div class="section-title">UCC Filings (${d.ucc_filings.length})</div>`;
    d.ucc_filings.forEach(f => {
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${f.secured_party}</span><span class="status-badge ${f.status === 'Active' ? 'active' : 'good'}">${f.status}</span></div><div class="record-meta">Filing: ${f.filing_number} | Filed: ${f.filed_date}</div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('demoBackgroundContent').innerHTML = h;
}

function renderDemoReviews(d) {
  const rating = d.overall_rating || 0;
  const cls = rating >= 4 ? 'good' : rating >= 3 ? 'ok' : 'bad';
  let h = `<div class="review-grid">`;
  d.platforms?.forEach(p => {
    h += `<div class="review-card"><div class="review-platform">${p.name}</div><div class="review-rating ${cls}">${p.rating}</div><div class="review-count">${p.count} reviews</div></div>`;
  });
  h += `</div>`;
  
  h += `<div class="stats-row"><div class="stat-card"><div class="stat-value">${d.overall_rating}</div><div class="stat-label">Overall Rating</div></div><div class="stat-card"><div class="stat-value">${d.total_reviews}</div><div class="stat-label">Total Reviews</div></div><div class="stat-card"><div class="stat-value">${d.sentiment}</div><div class="stat-label">Sentiment</div></div></div>`;
  
  if (d.summary) h += `<div class="summary-box"><h4>Summary</h4><p>${d.summary}</p></div>`;
  document.getElementById('demoReviewsContent').innerHTML = h;
}

function renderDemoSocial(d) {
  const score = d.social_score || 0;
  const cls = score >= 70 ? 'low' : score >= 40 ? 'medium' : 'high';
  let h = `<div class="risk-banner ${cls}"><div class="risk-badge"><span>${score}</span></div><div class="risk-info"><h3>Social Score: ${score}/100</h3><p>Social media presence strength</p></div></div>`;
  
  h += `<div class="stats-row"><div class="stat-card"><div class="stat-value">${d.profiles?.length || 0}</div><div class="stat-label">Active Profiles</div></div><div class="stat-card"><div class="stat-value">${d.total_followers || 'N/A'}</div><div class="stat-label">Total Followers</div></div><div class="stat-card"><div class="stat-value">${d.most_active_platform || 'N/A'}</div><div class="stat-label">Most Active</div></div></div>`;
  
  if (d.profiles?.length) {
    h += `<div class="section-box"><div class="section-title">Social Profiles</div><div class="social-grid">`;
    d.profiles.forEach(p => {
      h += `<div class="social-card"><div class="social-platform">${p.platform} ${p.verified ? '<span style="color:var(--accent-blue);"></span>' : ''}</div><div class="social-followers">${p.followers || p.subscribers || 'N/A'} followers</div></div>`;
    });
    h += `</div></div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Summary</h4><p>${d.summary}</p></div>`;
  document.getElementById('demoSocialContent').innerHTML = h;
}

function renderDemoFootprint(d) {
  const score = d.digital_score || 0;
  const cls = score >= 70 ? 'low' : score >= 40 ? 'medium' : 'high';
  let h = `<div class="risk-banner ${cls}"><div class="risk-badge"><span>${score}</span></div><div class="risk-info"><h3>Digital Score: ${score}/100</h3><p>Online presence strength</p></div></div>`;
  
  if (d.web_presence) {
    h += `<div class="section-box"><div class="section-title">Web Presence</div><div class="data-grid" style="grid-template-columns:1fr 1fr;">`;
    if (d.web_presence.website) h += `<div><div class="label">Website</div><div class="value" style="color:var(--accent-blue)">${d.web_presence.website}</div></div>`;
    if (d.web_presence.domain_age) h += `<div><div class="label">Domain Age</div><div class="value">${d.web_presence.domain_age}</div></div>`;
    if (d.web_presence.ssl_status) h += `<div><div class="label">SSL</div><div class="value">${d.web_presence.ssl_status}</div></div>`;
    if (d.web_presence.seo_visibility) h += `<div><div class="label">SEO</div><div class="value">${d.web_presence.seo_visibility}</div></div>`;
    if (d.web_presence.traffic_estimate) h += `<div><div class="label">Traffic</div><div class="value">${d.web_presence.traffic_estimate}</div></div>`;
    if (d.web_presence.technologies?.length) h += `<div style="grid-column:span 2;"><div class="label">Technologies</div><div class="value">${d.web_presence.technologies.join(', ')}</div></div>`;
    h += `</div></div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('demoFootprintContent').innerHTML = h;
}

function renderDemoDebt(d) {
  const risk = (d.risk_level || 'low').toLowerCase();
  const letter = risk === 'low' ? 'L' : risk === 'high' ? 'H' : 'M';
  let h = `<div class="risk-banner ${risk}"><div class="risk-badge"><span>${letter}</span></div><div class="risk-info"><h3>${d.risk_level || 'Low'} Debt Risk</h3><p>${d.active_positions || 0} active positions</p></div></div>`;
  
  h += `<div class="stats-row"><div class="stat-card"><div class="stat-value">${d.active_positions || 0}</div><div class="stat-label">Positions</div></div><div class="stat-card"><div class="stat-value">${d.estimated_total_debt || '$0'}</div><div class="stat-label">Est. Total Debt</div></div><div class="stat-card"><div class="stat-value">${d.estimated_monthly_obligations || '$0'}</div><div class="stat-label">Monthly Obligations</div></div></div>`;
  
  if (d.term_loans?.length) {
    h += `<div class="section-box"><div class="section-title">Term Loans (${d.term_loans.length})</div>`;
    d.term_loans.forEach(i => {
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${i.lender}</span><span class="status-badge active">${i.status}</span></div><div class="record-meta">Original: ${i.original_amount} | Payment: ${i.monthly_payment}</div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.lines_of_credit?.length) {
    h += `<div class="section-box"><div class="section-title">Lines of Credit (${d.lines_of_credit.length})</div>`;
    d.lines_of_credit.forEach(i => {
      h += `<div class="record-item"><div class="record-header"><span class="record-title">${i.lender}</span><span class="status-badge active">${i.status}</span></div><div class="record-meta">Limit: ${i.limit} | Utilization: ${i.utilization}</div></div>`;
    });
    h += `</div>`;
  }
  
  if (d.summary) h += `<div class="summary-box"><h4>Assessment</h4><p>${d.summary}</p></div>`;
  document.getElementById('demoDebtContent').innerHTML = h;
}

function loadDemoData() {
  const businessName = currentBusiness || 'Acme Corporation';
  
  // Demo Research Data
  const demoResearch = {
    company_name: businessName,
    industry: "Technology / Business Services",
    founded: "2018",
    headquarters: "San Francisco, CA",
    website: "www.example.com",
    employees: "50-200",
    annual_revenue: "$5M - $10M (estimated)",
    state_registration: { 
      state: "California", 
      status: "Active", 
      filed_date: "2018-03-15", 
      entity_type: "LLC",
      entity_number: "201812345678",
      registered_agent: "CT Corporation System",
      sos_url: "https://bizfileonline.sos.ca.gov/search/business"
    },
    key_people: [
      { name: "John Smith", title: "CEO & Founder" },
      { name: "Sarah Johnson", title: "COO" },
      { name: "Mike Chen", title: "CTO" }
    ],
    confidence_score: 85,
    summary: "This is a demo preview showing sample data. To get real AI-powered research on " + businessName + ", please add your free Gemini API key in the search bar."
  };
  
  const demoBackground = {
    ucc_filings: [
      { filing_number: "DEMO-12345", secured_party: "Sample Bank", filed_date: "2023-06-01", status: "Active" }
    ],
    risk_score: 25,
    summary: "This is demo data. Real background checks will show actual UCC filings, liens, judgments, and legal records."
  };
  
  const demoReviews = {
    platforms: [
      { name: "Google", rating: 4.5, count: 127 },
      { name: "Yelp", rating: 4.2, count: 45 },
      { name: "BBB", rating: "A+", count: 8 },
      { name: "Trustpilot", rating: 4.3, count: 89 }
    ],
    overall_rating: 4.4,
    total_reviews: 269,
    sentiment: "Positive",
    summary: "Demo preview showing sample review data. Connect your Gemini API key for real reviews and sentiment analysis."
  };
  
  const demoSocial = {
    profiles: [
      { platform: "LinkedIn", followers: "5.2K", verified: true },
      { platform: "Twitter/X", followers: "12.8K", verified: false },
      { platform: "Facebook", followers: "8.4K", verified: false },
      { platform: "Instagram", followers: "3.1K", verified: false }
    ],
    total_followers: "29.5K",
    most_active_platform: "Twitter/X",
    social_score: 72,
    summary: "Demo data showing sample social media presence. Add your API key for real social intelligence."
  };
  
  const demoFootprint = {
    web_presence: {
      website: "www.example.com",
      domain_age: "6 years",
      ssl_status: "Valid",
      seo_visibility: "Good",
      traffic_estimate: "10K-50K/month",
      technologies: ["React", "Node.js", "AWS", "Cloudflare"]
    },
    digital_score: 78,
    summary: "Demo digital footprint data. Connect your API key for real web presence analysis."
  };
  
  const demoDebt = {
    term_loans: [
      { lender: "Sample Bank", original_amount: "$250,000", monthly_payment: "$5,200", status: "Active" }
    ],
    lines_of_credit: [
      { lender: "Credit Union", limit: "$100,000", utilization: "45%", status: "Active" }
    ],
    active_positions: 2,
    estimated_total_debt: "$350,000",
    estimated_monthly_obligations: "$8,500",
    risk_level: "Low",
    summary: "Demo debt analysis showing sample financing positions. Add your API key for real debt intelligence."
  };
  
  // Render all demo sections
  renderDemoResearch(demoResearch);
  renderDemoBackground(demoBackground);
  renderDemoReviews(demoReviews);
  renderDemoSocial(demoSocial);
  renderDemoFootprint(demoFootprint);
  renderDemoDebt(demoDebt);
}

// Close modal when clicking outside
document.getElementById('apiModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeApiModal();
  }
});

// ==================== BRICK BREAKER GAME ====================
let gameRunning = false;
let gameAnimationId = null;

function startGame() {
  const container = document.getElementById('gameContainer');
  container.classList.add('active');
  
  // Load high score
  const highScore = parseInt(localStorage.getItem('hubble_game_high') || '0');
  document.getElementById('gameHigh').textContent = highScore;
  
  if (gameRunning) return;
  gameRunning = true;
  
  const canvas = document.getElementById('brickGame');
  const ctx = canvas.getContext('2d');
  
  // Game state
  let score = 0;
  let level = 1;
  const paddleWidth = 65, paddleHeight = 12;
  let paddleX = (canvas.width - paddleWidth) / 2;
  const ballRadius = 5;
  let ballX = canvas.width / 2, ballY = canvas.height - 40;
  let ballDX = 2.5, ballDY = -2.5;  // Slower speed
  
  // Lasers
  let lasers = [];
  let laserCooldown = 0;
  const laserSpeed = 6;  // Slower lasers too
  
  // Bricks - more rows = harder
  const brickRows = 5, brickCols = 10;
  const brickWidth = 35, brickHeight = 14, brickPadding = 4;
  const brickOffsetTop = 15, brickOffsetLeft = 8;
  
  // Use site accent colors
  const brickColors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#14b8a6', '#3b82f6', '#8b5cf6', '#a855f7', '#ec4899'];
  
  let bricks = [];
  function initBricks() {
    bricks = [];
    for (let r = 0; r < brickRows; r++) {
      bricks[r] = [];
      for (let c = 0; c < brickCols; c++) {
        // Some bricks take 2 hits (armored)
        const hp = (r < 2 && Math.random() > 0.5) ? 2 : 1;
        bricks[r][c] = { x: 0, y: 0, status: hp, maxHp: hp };
      }
    }
  }
  initBricks();
  
  // Update score helper
  function updateScore(points) {
    score += points;
    document.getElementById('gameScore').textContent = score;
    // Update high score if beaten
    if (score > highScore) {
      localStorage.setItem('hubble_game_high', score.toString());
      document.getElementById('gameHigh').textContent = score;
    }
  }
  
  // Controls
  let rightPressed = false, leftPressed = false, spacePressed = false;
  
  function keyDownHandler(e) {
    if (e.key === 'Right' || e.key === 'ArrowRight') rightPressed = true;
    if (e.key === 'Left' || e.key === 'ArrowLeft') leftPressed = true;
    if (e.key === ' ' || e.key === 'Spacebar') { spacePressed = true; e.preventDefault(); }
  }
  function keyUpHandler(e) {
    if (e.key === 'Right' || e.key === 'ArrowRight') rightPressed = false;
    if (e.key === 'Left' || e.key === 'ArrowLeft') leftPressed = false;
    if (e.key === ' ' || e.key === 'Spacebar') spacePressed = false;
  }
  function mouseMoveHandler(e) {
    const rect = canvas.getBoundingClientRect();
    const relX = e.clientX - rect.left;
    if (relX > paddleWidth/2 && relX < canvas.width - paddleWidth/2) {
      paddleX = relX - paddleWidth / 2;
    }
  }
  function touchMoveHandler(e) {
    const rect = canvas.getBoundingClientRect();
    const relX = e.touches[0].clientX - rect.left;
    if (relX > paddleWidth/2 && relX < canvas.width - paddleWidth/2) {
      paddleX = relX - paddleWidth / 2;
    }
  }
  function clickHandler() {
    fireLaser();
  }
  
  document.addEventListener('keydown', keyDownHandler);
  document.addEventListener('keyup', keyUpHandler);
  canvas.addEventListener('mousemove', mouseMoveHandler);
  canvas.addEventListener('touchmove', touchMoveHandler);
  canvas.addEventListener('click', clickHandler);
  
  function fireLaser() {
    if (laserCooldown <= 0) {
      lasers.push({ x: paddleX + paddleWidth/2 - 2, y: canvas.height - paddleHeight - 10 });
      lasers.push({ x: paddleX + paddleWidth/2 + 2, y: canvas.height - paddleHeight - 10 });
      laserCooldown = 15; // Frames between shots
    }
  }
  
  function drawBall(isLight) {
    ctx.beginPath();
    ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
    const gradient = ctx.createRadialGradient(ballX-2, ballY-2, 0, ballX, ballY, ballRadius);
    gradient.addColorStop(0, isLight ? '#fff' : '#fef3c7');
    gradient.addColorStop(1, '#f59e0b');
    ctx.fillStyle = gradient;
    ctx.fill();
    ctx.strokeStyle = isLight ? '#d97706' : '#fbbf24';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.closePath();
  }
  
  function drawPaddle(isLight) {
    // Main paddle (accent gold from site)
    ctx.beginPath();
    ctx.roundRect(paddleX, canvas.height - paddleHeight - 5, paddleWidth, paddleHeight, 4);
    const gradient = ctx.createLinearGradient(paddleX, canvas.height - paddleHeight - 5, paddleX, canvas.height - 5);
    gradient.addColorStop(0, '#facc15'); // --accent-light
    gradient.addColorStop(1, '#ca8a04'); // --accent-dark
    ctx.fillStyle = gradient;
    ctx.fill();
    ctx.strokeStyle = isLight ? '#a16207' : '#fbbf24';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.closePath();
    
    // Gun turret
    const gunWidth = 8, gunHeight = 10;
    ctx.beginPath();
    ctx.roundRect(paddleX + paddleWidth/2 - gunWidth/2, canvas.height - paddleHeight - 5 - gunHeight + 2, gunWidth, gunHeight, 2);
    ctx.fillStyle = isLight ? '#374151' : '#4b5563';
    ctx.fill();
    ctx.strokeStyle = isLight ? '#1f2937' : '#6b7280';
    ctx.stroke();
    ctx.closePath();
    
    // Gun barrel
    ctx.beginPath();
    ctx.roundRect(paddleX + paddleWidth/2 - 2, canvas.height - paddleHeight - 5 - gunHeight - 4, 4, 6, 1);
    ctx.fillStyle = isLight ? '#6b7280' : '#9ca3af';
    ctx.fill();
    ctx.closePath();
  }
  
  function drawLasers(isLight) {
    lasers.forEach(laser => {
      // Laser glow
      ctx.beginPath();
      ctx.rect(laser.x - 1, laser.y, 4, 12);
      ctx.fillStyle = isLight ? 'rgba(239, 68, 68, 0.3)' : 'rgba(239, 68, 68, 0.5)';
      ctx.fill();
      // Laser core
      ctx.beginPath();
      ctx.rect(laser.x, laser.y + 2, 2, 8);
      ctx.fillStyle = '#ef4444';
      ctx.fill();
      ctx.closePath();
    });
  }
  
  function drawBricks(isLight) {
    for (let r = 0; r < brickRows; r++) {
      for (let c = 0; c < brickCols; c++) {
        if (bricks[r][c].status > 0) {
          const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
          const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
          bricks[r][c].x = brickX;
          bricks[r][c].y = brickY;
          
          ctx.beginPath();
          ctx.roundRect(brickX, brickY, brickWidth, brickHeight, 3);
          
          // Armored bricks - theme aware
          if (bricks[r][c].maxHp === 2 && bricks[r][c].status === 2) {
            ctx.fillStyle = isLight ? '#374151' : '#1f2937';
            ctx.fill();
            ctx.strokeStyle = brickColors[c % brickColors.length];
            ctx.lineWidth = 2;
            ctx.stroke();
          } else {
            const gradient = ctx.createLinearGradient(brickX, brickY, brickX, brickY + brickHeight);
            gradient.addColorStop(0, brickColors[c % brickColors.length]);
            gradient.addColorStop(1, brickColors[(c + 1) % brickColors.length]);
            ctx.fillStyle = gradient;
            ctx.fill();
          }
          ctx.closePath();
        }
      }
    }
  }
  
  function collisionDetection() {
    // Ball collision
    for (let r = 0; r < brickRows; r++) {
      for (let c = 0; c < brickCols; c++) {
        const b = bricks[r][c];
        if (b.status > 0) {
          if (ballX > b.x && ballX < b.x + brickWidth && ballY > b.y && ballY < b.y + brickHeight) {
            ballDY = -ballDY;
            b.status--;
            updateScore(b.status === 0 ? 10 : 5);
          }
        }
      }
    }
    
    // Laser collision
    lasers = lasers.filter(laser => {
      for (let r = 0; r < brickRows; r++) {
        for (let c = 0; c < brickCols; c++) {
          const b = bricks[r][c];
          if (b.status > 0) {
            if (laser.x > b.x && laser.x < b.x + brickWidth && laser.y > b.y && laser.y < b.y + brickHeight) {
              b.status--;
              updateScore(b.status === 0 ? 15 : 5);
              return false; // Remove laser
            }
          }
        }
      }
      return laser.y > 0; // Keep if still on screen
    });
    
    // Check level clear
    let allCleared = true;
    for (let r = 0; r < brickRows; r++) {
      for (let c = 0; c < brickCols; c++) {
        if (bricks[r][c].status > 0) allCleared = false;
      }
    }
    if (allCleared) {
      level++;
      initBricks();
      ballDX *= 1.08;
      ballDY *= 1.08;
    }
  }
  
  function draw() {
    if (!gameRunning) return;
    
    // Detect theme - match site exactly
    const isLight = document.body.classList.contains('light-mode');
    
    // Theme-aware background (matches --bg-primary)
    ctx.fillStyle = isLight ? '#f8f8f8' : '#0a0a0a';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Subtle grid (matches .bg-grid)
    ctx.strokeStyle = isLight ? 'rgba(234, 179, 8, 0.05)' : 'rgba(234, 179, 8, 0.03)';
    ctx.lineWidth = 1;
    for (let i = 0; i < canvas.width; i += 20) {
      ctx.beginPath();
      ctx.moveTo(i, 0);
      ctx.lineTo(i, canvas.height);
      ctx.stroke();
    }
    for (let i = 0; i < canvas.height; i += 20) {
      ctx.beginPath();
      ctx.moveTo(0, i);
      ctx.lineTo(canvas.width, i);
      ctx.stroke();
    }
    
    drawBricks(isLight);
    drawLasers(isLight);
    drawBall(isLight);
    drawPaddle(isLight);
    collisionDetection();
    
    // Update lasers
    lasers.forEach(laser => laser.y -= laserSpeed);
    if (laserCooldown > 0) laserCooldown--;
    
    // Auto-fire with space
    if (spacePressed) fireLaser();
    
    // Ball wall collision
    if (ballX + ballDX > canvas.width - ballRadius || ballX + ballDX < ballRadius) {
      ballDX = -ballDX;
    }
    if (ballY + ballDY < ballRadius) {
      ballDY = -ballDY;
    } else if (ballY + ballDY > canvas.height - ballRadius - paddleHeight - 5) {
      if (ballX > paddleX && ballX < paddleX + paddleWidth) {
        const hitPos = (ballX - paddleX) / paddleWidth;
        ballDX = 5 * (hitPos - 0.5);
        ballDY = -Math.abs(ballDY);
      } else if (ballY + ballDY > canvas.height - ballRadius) {
        // Ball lost - reset but keep score
        ballX = canvas.width / 2;
        ballY = canvas.height - 40;
        ballDX = 2.5 * (Math.random() > 0.5 ? 1 : -1);
        ballDY = -2.5 - level * 0.3;
      }
    }
    
    // Paddle movement
    if (rightPressed && paddleX < canvas.width - paddleWidth) paddleX += 5;
    if (leftPressed && paddleX > 0) paddleX -= 5;
    
    ballX += ballDX;
    ballY += ballDY;
    
    gameAnimationId = requestAnimationFrame(draw);
  }
  
  draw();
}

function stopGame() {
  gameRunning = false;
  if (gameAnimationId) {
    cancelAnimationFrame(gameAnimationId);
    gameAnimationId = null;
  }
  document.getElementById('gameContainer').classList.remove('active');
}
</script>
</body>
</html>
