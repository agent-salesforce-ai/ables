<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSGA SNOOD - Dodge Ed's Dweebery!</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2a 50%, #0a1a2a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'VT323', monospace;
            overflow-x: hidden;
            user-select: none;
        }
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 1000;
        }
        .header { text-align: center; padding: 10px; }
        .title {
            font-family: 'Press Start 2P', cursive;
            font-size: 28px;
            color: #bf0a30;
            text-shadow: 0 0 10px #bf0a30, 0 0 20px #bf0a30, 3px 3px 0 #000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 50% { text-shadow: 0 0 20px #bf0a30, 0 0 40px #bf0a30, 3px 3px 0 #000; } }
        .subtitle { font-size: 18px; color: #ffd700; text-shadow: 0 0 10px #ffd700; margin-top: 5px; }
        .game-wrapper { display: flex; gap: 20px; padding: 10px; flex-wrap: wrap; justify-content: center; align-items: flex-start; }
        .hud { display: flex; justify-content: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
        .hud-box {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 2px solid #bf0a30;
            border-radius: 8px;
            padding: 6px 12px;
            text-align: center;
            box-shadow: 0 0 15px rgba(191, 10, 48, 0.3);
            min-width: 70px;
        }
        .hud-label { font-size: 11px; color: #888; }
        .hud-value { font-family: 'Press Start 2P', cursive; font-size: 12px; color: #00ff00; text-shadow: 0 0 8px #00ff00; }
        .hud-value.gold { color: #ffd700; text-shadow: 0 0 8px #ffd700; }
        .hud-value.red { color: #ff4444; text-shadow: 0 0 8px #ff4444; }
        .hud-value.cyan { color: #00ffff; text-shadow: 0 0 8px #00ffff; }
        #gameCanvas {
            border: 4px solid #ffd700;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), inset 0 0 50px rgba(0,0,0,0.5);
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a1a 100%);
            cursor: crosshair;
            display: block;
        }
        .side-panel {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            min-width: 170px;
            max-width: 190px;
        }
        .panel-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 9px;
            color: #ffd700;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        .controls { font-size: 13px; color: #aaa; line-height: 1.7; }
        .controls span { color: #ffd700; }
        .leaderboard { margin-top: 12px; }
        .lb-entry { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; border-bottom: 1px solid #222; }
        .lb-entry:nth-child(1) { color: #ffd700; }
        .lb-entry:nth-child(2) { color: #c0c0c0; }
        .lb-entry:nth-child(3) { color: #cd7f32; }
        .powerups-section { margin-top: 12px; }
        .powerup-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 12px; color: #888; }
        .powerup-item.active { color: #00ff00; }
        .powerup-icon-small { font-size: 16px; }
        .music-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 999;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            color: #ffd700;
        }
        .music-toggle:hover { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .combo-popup {
            position: absolute;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700, 2px 2px 0 #000;
            pointer-events: none;
            animation: comboAnim 0.8s ease-out forwards;
            white-space: nowrap;
        }
        @keyframes comboAnim {
            0% { transform: scale(0.5); opacity: 1; }
            50% { transform: scale(1.2); }
            100% { transform: translateY(-30px) scale(1); opacity: 0; }
        }
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .overlay.hidden { display: none; }
        .overlay-content {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 4px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 420px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }
        .overlay-title { font-family: 'Press Start 2P', cursive; font-size: 20px; color: #bf0a30; margin-bottom: 15px; text-shadow: 0 0 20px #bf0a30; }
        .overlay-text { font-size: 16px; color: #fff; margin-bottom: 10px; line-height: 1.5; }
        .name-input {
            background: #0a0a1a;
            border: 2px solid #ffd700;
            border-radius: 5px;
            padding: 10px 18px;
            font-family: 'Press Start 2P', cursive;
            font-size: 11px;
            color: #00ff00;
            text-align: center;
            text-transform: uppercase;
            width: 200px;
            margin: 12px 0;
            outline: none;
        }
        .name-input:focus { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
        .btn {
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: linear-gradient(180deg, #bf0a30 0%, #8b0000 100%);
            color: #ffd700;
            border: 2px solid #ffd700;
            transition: all 0.2s;
            margin: 5px;
        }
        .btn:hover { transform: scale(1.05); box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
        .btn:active { transform: scale(0.98); }
        .stats-row { display: flex; justify-content: space-around; margin: 12px 0; flex-wrap: wrap; gap: 10px; }
        .stat-item { text-align: center; min-width: 60px; }
        .stat-value { font-family: 'Press Start 2P', cursive; font-size: 14px; color: #00ff00; }
        .stat-label { font-size: 10px; color: #888; margin-top: 2px; }
        .new-record { color: #ffd700; font-family: 'Press Start 2P', cursive; font-size: 9px; animation: pulse 0.5s infinite; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="music-toggle" id="musicToggle">MUSIC: OFF</div>
    <div class="header">
        <div class="title">MSGA SNOOD</div>
        <div class="subtitle">Make Speedboats Great Again!</div>
    </div>
    
    <div class="hud">
        <div class="hud-box"><div class="hud-label">SCORE</div><div class="hud-value" id="score">0</div></div>
        <div class="hud-box"><div class="hud-label">LEVEL</div><div class="hud-value gold" id="level">1</div></div>
        <div class="hud-box"><div class="hud-label">COMBO</div><div class="hud-value gold" id="combo">x1</div></div>
        <div class="hud-box"><div class="hud-label">LIVES</div><div class="hud-value red" id="lives">3</div></div>
        <div class="hud-box"><div class="hud-label">SHIELD</div><div class="hud-value cyan" id="shield">-</div></div>
        <div class="hud-box"><div class="hud-label">DODGED</div><div class="hud-value" id="dodged">0</div></div>
    </div>

    <div class="game-wrapper">
        <div style="position: relative;">
            <canvas id="gameCanvas" width="520" height="620"></canvas>
            <div id="comboContainer"></div>
        </div>
        <div class="side-panel">
            <div class="panel-title">CONTROLS</div>
            <div class="controls">
                <span>A/D</span> Move<br>
                <span>MOUSE</span> Aim<br>
                <span>CLICK</span> Shoot<br>
                <span>SPACE</span> Dash<br>
                <span>M</span> Music<br>
            </div>
            <div class="powerups-section">
                <div class="panel-title">POWER-UPS</div>
                <div class="powerup-item" id="pu-shield"><span class="powerup-icon-small">üõ°</span> Shield</div>
                <div class="powerup-item" id="pu-bomb"><span class="powerup-icon-small">üí£</span> Row Bomb</div>
                <div class="powerup-item" id="pu-slow"><span class="powerup-icon-small">üêå</span> Slow Ed</div>
                <div class="powerup-item" id="pu-multi"><span class="powerup-icon-small">‚ú®</span> Multi-Shot</div>
            </div>
            <div class="leaderboard">
                <div class="panel-title">HIGH SCORES</div>
                <div id="leaderboard"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="nameOverlay">
        <div class="overlay-content">
            <div class="overlay-title">MSGA SNOOD</div>
            <div class="overlay-text">
                Match <span style="color:#00ff00">3+ snoods</span> to clear!<br>
                <span style="color:#ff4444">DODGE Ed's dweebery!</span><br>
                Collect <span style="color:#00ffff">power-ups</span> to survive!
            </div>
            <input type="text" id="playerNameInput" class="name-input" placeholder="ENTER NAME" maxlength="10" autocomplete="off">
            <br>
            <button class="btn" onclick="startGame()">START</button>
        </div>
    </div>

    <div class="overlay hidden" id="gameOverOverlay">
        <div class="overlay-content">
            <div class="overlay-title" id="gameOverTitle">GAME OVER</div>
            <div class="stats-row">
                <div class="stat-item"><div class="stat-value" id="finalScore">0</div><div class="stat-label">SCORE</div></div>
                <div class="stat-item"><div class="stat-value" id="finalLevel">1</div><div class="stat-label">LEVEL</div></div>
                <div class="stat-item"><div class="stat-value" id="finalDodged">0</div><div class="stat-label">DODGED</div></div>
                <div class="stat-item"><div class="stat-value" id="finalCombo">1</div><div class="stat-label">BEST COMBO</div></div>
            </div>
            <div id="newRecord" class="new-record" style="display:none">NEW HIGH SCORE!</div>
            <button class="btn" onclick="restartGame()">RETRY</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ========== 80's CHIPTUNE MUSIC ENGINE ==========
        let audioCtx = null;
        let musicPlaying = false;
        let musicNodes = [];
        let masterGain = null;
        let musicInterval = null;
        let bassInterval = null;
        let arpInterval = null;
        
        // 80's inspired melody patterns (notes in Hz)
        const NOTES = {
            C3: 130.81, D3: 146.83, E3: 164.81, F3: 174.61, G3: 196.00, A3: 220.00, B3: 246.94,
            C4: 261.63, D4: 293.66, E4: 329.63, F4: 349.23, G4: 392.00, A4: 440.00, B4: 493.88,
            C5: 523.25, D5: 587.33, E5: 659.25, F5: 698.46, G5: 783.99, A5: 880.00, B5: 987.77,
            REST: 0
        };
        
        // Catchy 80's arcade melody
        const melody = [
            { note: 'E4', dur: 0.15 }, { note: 'E4', dur: 0.15 }, { note: 'REST', dur: 0.15 }, { note: 'E4', dur: 0.15 },
            { note: 'REST', dur: 0.15 }, { note: 'C4', dur: 0.15 }, { note: 'E4', dur: 0.3 },
            { note: 'G4', dur: 0.3 }, { note: 'REST', dur: 0.3 }, { note: 'G3', dur: 0.3 },
            
            { note: 'C4', dur: 0.3 }, { note: 'REST', dur: 0.15 }, { note: 'G3', dur: 0.3 },
            { note: 'REST', dur: 0.15 }, { note: 'E3', dur: 0.3 }, { note: 'REST', dur: 0.15 },
            { note: 'A3', dur: 0.15 }, { note: 'B3', dur: 0.15 }, { note: 'A3', dur: 0.15 }, { note: 'A3', dur: 0.15 },
            
            { note: 'G3', dur: 0.2 }, { note: 'E4', dur: 0.2 }, { note: 'G4', dur: 0.2 },
            { note: 'A4', dur: 0.3 }, { note: 'F4', dur: 0.15 }, { note: 'G4', dur: 0.15 },
            { note: 'REST', dur: 0.15 }, { note: 'E4', dur: 0.15 }, { note: 'C4', dur: 0.15 },
            { note: 'D4', dur: 0.15 }, { note: 'B3', dur: 0.3 },
        ];
        
        // Bass line
        const bassLine = [
            'C3', 'C3', 'G3', 'G3', 'A3', 'A3', 'E3', 'E3',
            'F3', 'F3', 'C3', 'C3', 'G3', 'G3', 'G3', 'G3',
        ];
        
        // Arpeggio pattern
        const arpPattern = ['C4', 'E4', 'G4', 'E4'];
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.15;
                masterGain.connect(audioCtx.destination);
            }
        }
        
        function playNote(freq, duration, type, volume, delay = 0) {
            if (!audioCtx || freq === 0) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type || 'square';
                osc.frequency.value = freq;
                
                const startTime = audioCtx.currentTime + delay;
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(volume || 0.1, startTime + 0.01);
                gain.gain.linearRampToValueAtTime(volume * 0.7, startTime + duration * 0.3);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start(startTime);
                osc.stop(startTime + duration);
                
                musicNodes.push({ osc, gain });
            } catch(e) {}
        }
        
        function playMelodyNote(noteObj, time) {
            const freq = NOTES[noteObj.note];
            if (freq > 0) {
                playNote(freq, noteObj.dur * 0.9, 'square', 0.12, time);
                // Add slight vibrato/chorus effect
                playNote(freq * 1.005, noteObj.dur * 0.9, 'square', 0.04, time);
            }
        }
        
        function playBassNote(noteName, time) {
            const freq = NOTES[noteName];
            if (freq > 0) {
                playNote(freq, 0.2, 'triangle', 0.15, time);
            }
        }
        
        function playArpNote(noteName, time) {
            const freq = NOTES[noteName];
            if (freq > 0) {
                playNote(freq * 2, 0.08, 'sine', 0.06, time);
            }
        }
        
        let melodyIndex = 0;
        let bassIndex = 0;
        let arpIndex = 0;
        
        function startMusic() {
            if (musicPlaying) return;
            initAudio();
            musicPlaying = true;
            document.getElementById('musicToggle').textContent = 'MUSIC: ON';
            
            melodyIndex = 0;
            bassIndex = 0;
            arpIndex = 0;
            
            // Main melody loop
            let melodyTime = 0;
            function scheduleMelody() {
                if (!musicPlaying) return;
                const note = melody[melodyIndex % melody.length];
                playMelodyNote(note, 0);
                melodyIndex++;
                setTimeout(scheduleMelody, note.dur * 1000);
            }
            scheduleMelody();
            
            // Bass line
            bassInterval = setInterval(() => {
                if (!musicPlaying) return;
                playBassNote(bassLine[bassIndex % bassLine.length], 0);
                bassIndex++;
            }, 250);
            
            // Arpeggio
            arpInterval = setInterval(() => {
                if (!musicPlaying) return;
                playArpNote(arpPattern[arpIndex % arpPattern.length], 0);
                arpIndex++;
            }, 150);
            
            // Drum beat
            musicInterval = setInterval(() => {
                if (!musicPlaying) return;
                // Kick
                playNote(60, 0.1, 'triangle', 0.2, 0);
                playNote(50, 0.15, 'sine', 0.15, 0);
                // Hi-hat
                setTimeout(() => {
                    if (musicPlaying) {
                        const noise = audioCtx.createOscillator();
                        const noiseGain = audioCtx.createGain();
                        noise.type = 'square';
                        noise.frequency.value = 800 + Math.random() * 400;
                        noiseGain.gain.setValueAtTime(0.03, audioCtx.currentTime);
                        noiseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                        noise.connect(noiseGain);
                        noiseGain.connect(masterGain);
                        noise.start();
                        noise.stop(audioCtx.currentTime + 0.05);
                    }
                }, 125);
            }, 250);
        }
        
        function stopMusic() {
            musicPlaying = false;
            document.getElementById('musicToggle').textContent = 'MUSIC: OFF';
            if (musicInterval) clearInterval(musicInterval);
            if (bassInterval) clearInterval(bassInterval);
            if (arpInterval) clearInterval(arpInterval);
            musicNodes.forEach(n => { try { n.osc.stop(); } catch(e) {} });
            musicNodes = [];
        }
        
        function toggleMusic() {
            initAudio();
            if (musicPlaying) stopMusic();
            else startMusic();
        }
        
        document.getElementById('musicToggle').addEventListener('click', toggleMusic);
        
        // ========== SOUND EFFECTS ==========
        function sfxShoot() { playNote(440, 0.08, 'square', 0.08); }
        function sfxPop() { playNote(600 + Math.random()*300, 0.12, 'sine', 0.1); }
        function sfxCombo() { playNote(800, 0.08, 'square', 0.08); setTimeout(() => playNote(1000, 0.08, 'square', 0.08), 60); }
        function sfxHit() { playNote(120, 0.25, 'sawtooth', 0.15); }
        function sfxPowerup() { playNote(600, 0.1, 'sine', 0.1); setTimeout(() => playNote(900, 0.1, 'sine', 0.1), 80); }
        function sfxBomb() { playNote(100, 0.4, 'sawtooth', 0.18); }
        function sfxLevelUp() { 
            [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playNote(f, 0.15, 'square', 0.1), i * 100));
        }

        // ========== GAME CONSTANTS ==========
        const SNOOD_RADIUS = 18;
        const ROW_HEIGHT = SNOOD_RADIUS * 1.73;
        const COLS = 13;
        const SHOOT_Y = canvas.height - 55;
        const DANGER_LINE = canvas.height - 95;

        const SNOOD_TYPES = [
            { emoji: 'üö§', color: '#00aaff', name: 'SPEEDBOAT' },
            { emoji: '‚≠ê', color: '#ffd700', name: 'STAR' },
            { emoji: 'üî•', color: '#ff4400', name: 'FIRE' },
            { emoji: 'üí∞', color: '#00cc00', name: 'MONEY' },
            { emoji: 'ü¶Ö', color: '#c49a6c', name: 'EAGLE' },
            { emoji: 'üíé', color: '#00ffff', name: 'DIAMOND' },
            { emoji: 'üèÜ', color: '#ffaa00', name: 'TROPHY' },
        ];

        const ED_TYPES = [
            { emoji: 'ü§ì', color: '#555', speed: 1.0, size: 18, points: 5 },
            { emoji: 'üìä', color: '#444', speed: 0.8, size: 20, points: 8 },
            { emoji: 'ü•±', color: '#4a4a4a', speed: 1.2, size: 16, points: 4 },
            { emoji: 'üí§', color: '#3a3a3a', speed: 0.6, size: 22, points: 10 },
            { emoji: 'üìâ', color: '#333', speed: 1.4, size: 15, points: 3 },
        ];

        const POWERUP_TYPES = [
            { emoji: 'üõ°', color: '#00aaff', type: 'shield', name: 'Shield' },
            { emoji: 'üí£', color: '#ff4444', type: 'bomb', name: 'Bomb' },
            { emoji: 'üêå', color: '#88ff88', type: 'slow', name: 'Slow' },
            { emoji: '‚ú®', color: '#ffff00', type: 'multi', name: 'Multi' },
            { emoji: '‚ù§Ô∏è', color: '#ff0066', type: 'life', name: 'Life' },
        ];

        // ========== GAME STATE ==========
        let grid = [];
        let currentSnood = null;
        let nextSnood = null;
        let shootingSnood = null;
        let extraShots = [];
        let score = 0;
        let level = 1;
        let lives = 3;
        let combo = 1;
        let maxCombo = 1;
        let dodgedCount = 0;
        let gameOver = false;
        let gameStarted = false;
        let aimAngle = -Math.PI / 2;
        let playerName = '';
        let animating = false;
        let launcherX = canvas.width / 2;
        let fallingEds = [];
        let fallingPowerups = [];
        let particles = [];
        let edSpawnTimer = 0;
        let powerupSpawnTimer = 0;
        let dashCooldown = 0;
        let invincible = false;
        let invincibleTimer = 0;
        let shieldTimer = 0;
        let slowTimer = 0;
        let multiShot = false;
        let multiShotTimer = 0;
        let screenShake = 0;
        let keys = { left: false, right: false };
        let leaderboard = JSON.parse(localStorage.getItem('msgaSnoodLB4')) || [];

        // ========== INPUT ==========
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') keys.left = true;
            if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') keys.right = true;
            if (e.key.toLowerCase() === 'm') toggleMusic();
            if (e.key === ' ' && gameStarted && !gameOver && dashCooldown <= 0) {
                e.preventDefault();
                const dir = keys.left ? -1 : (keys.right ? 1 : 0);
                if (dir !== 0) {
                    launcherX += dir * 85;
                    launcherX = Math.max(35, Math.min(canvas.width - 35, launcherX));
                    dashCooldown = 0.6;
                    for (let i = 0; i < 8; i++) {
                        particles.push({ x: launcherX - dir * 40, y: SHOOT_Y, vx: -dir * (2 + Math.random() * 3), vy: (Math.random() - 0.5) * 2, life: 0.3, color: '#00ffff', size: 4 });
                    }
                    playNote(350, 0.08, 'sine', 0.06);
                }
            }
        });
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') keys.left = false;
            if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') keys.right = false;
        });
        canvas.addEventListener('mousemove', (e) => {
            if (gameOver || !gameStarted || shootingSnood) return;
            const rect = canvas.getBoundingClientRect();
            const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
            const my = (e.clientY - rect.top) * (canvas.height / rect.height);
            aimAngle = Math.atan2(my - SHOOT_Y, mx - launcherX);
            aimAngle = Math.max(-Math.PI + 0.15, Math.min(-0.15, aimAngle));
        });
        canvas.addEventListener('click', () => {
            initAudio();
            if (gameOver || !gameStarted || shootingSnood || animating) return;
            shoot();
        });
        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        // ========== GAME FUNCTIONS ==========
        function startGame() {
            initAudio();
            playerName = document.getElementById('playerNameInput').value.trim().toUpperCase() || 'PATRIOT';
            localStorage.setItem('msgaSnoodName', playerName);
            document.getElementById('nameOverlay').classList.add('hidden');
            resetGame();
            gameStarted = true;
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function restartGame() {
            document.getElementById('gameOverOverlay').classList.add('hidden');
            resetGame();
            gameOver = false;
            gameStarted = true;
        }

        function resetGame() {
            grid = [];
            score = 0; level = 1; lives = 3; combo = 1; maxCombo = 1; dodgedCount = 0;
            fallingEds = []; fallingPowerups = []; particles = []; extraShots = [];
            launcherX = canvas.width / 2;
            edSpawnTimer = 0; powerupSpawnTimer = 0; dashCooldown = 0;
            invincible = false; shieldTimer = 0; slowTimer = 0; multiShot = false; multiShotTimer = 0;
            screenShake = 0;
            
            for (let row = 0; row < 5; row++) {
                grid[row] = [];
                const offset = row % 2 === 0 ? 0 : SNOOD_RADIUS;
                for (let col = 0; col < COLS - (row % 2); col++) {
                    grid[row][col] = { type: Math.floor(Math.random() * 4), x: col * SNOOD_RADIUS * 2 + SNOOD_RADIUS + offset, y: row * ROW_HEIGHT + SNOOD_RADIUS + 25 };
                }
            }
            currentSnood = createSnood();
            nextSnood = createSnood();
            updateDisplay();
        }

        function createSnood() {
            const maxTypes = Math.min(4 + Math.floor(level / 2), SNOOD_TYPES.length);
            return { type: Math.floor(Math.random() * maxTypes), x: launcherX, y: SHOOT_Y };
        }

        function shoot() {
            sfxShoot();
            const speed = 15;
            shootingSnood = { type: currentSnood.type, x: launcherX, y: SHOOT_Y, vx: Math.cos(aimAngle) * speed, vy: Math.sin(aimAngle) * speed };
            
            if (multiShot) {
                extraShots.push({ type: currentSnood.type, x: launcherX, y: SHOOT_Y, vx: Math.cos(aimAngle - 0.15) * speed, vy: Math.sin(aimAngle - 0.15) * speed });
                extraShots.push({ type: currentSnood.type, x: launcherX, y: SHOOT_Y, vx: Math.cos(aimAngle + 0.15) * speed, vy: Math.sin(aimAngle + 0.15) * speed });
            }
            
            currentSnood = nextSnood;
            currentSnood.x = launcherX;
            currentSnood.y = SHOOT_Y;
            nextSnood = createSnood();
        }

        function spawnEd() {
            const type = ED_TYPES[Math.floor(Math.random() * ED_TYPES.length)];
            const speedMult = slowTimer > 0 ? 0.4 : (1 + (level - 1) * 0.15);
            fallingEds.push({ x: 40 + Math.random() * (canvas.width - 80), y: -25, type: type, speed: (1 + Math.random() * 1.2) * type.speed * speedMult, rotation: 0, rotSpeed: (Math.random() - 0.5) * 5, wobble: Math.random() * Math.PI * 2, wobbleSpeed: 2 + Math.random() * 2 });
        }

        function spawnPowerup() {
            const type = POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];
            fallingPowerups.push({ x: 50 + Math.random() * (canvas.width - 100), y: -20, type: type, speed: 1.5 + Math.random(), rotation: 0 });
        }

        let lastTime = performance.now();

        function gameLoop(time) {
            const dt = Math.min((time - lastTime) / 1000, 0.1);
            lastTime = time;
            if (!gameOver) update(dt);
            render();
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            if (keys.left) launcherX = Math.max(35, launcherX - 5.5);
            if (keys.right) launcherX = Math.min(canvas.width - 35, launcherX + 5.5);
            
            dashCooldown = Math.max(0, dashCooldown - dt);
            screenShake = Math.max(0, screenShake - dt * 10);
            
            if (shieldTimer > 0) shieldTimer -= dt;
            if (slowTimer > 0) slowTimer -= dt;
            if (multiShotTimer > 0) { multiShotTimer -= dt; if (multiShotTimer <= 0) multiShot = false; }

            if (currentSnood && !shootingSnood) currentSnood.x = launcherX;

            if (shootingSnood) {
                shootingSnood.x += shootingSnood.vx;
                shootingSnood.y += shootingSnood.vy;
                if (shootingSnood.x < SNOOD_RADIUS + 5) { shootingSnood.vx = Math.abs(shootingSnood.vx); shootingSnood.x = SNOOD_RADIUS + 5; }
                if (shootingSnood.x > canvas.width - SNOOD_RADIUS - 5) { shootingSnood.vx = -Math.abs(shootingSnood.vx); shootingSnood.x = canvas.width - SNOOD_RADIUS - 5; }
                if (shootingSnood.y < SNOOD_RADIUS + 25) { snap(0, shootingSnood); shootingSnood = null; }
                else if (checkSnoodCollision(shootingSnood)) { shootingSnood = null; }
            }

            for (let i = extraShots.length - 1; i >= 0; i--) {
                const s = extraShots[i];
                s.x += s.vx; s.y += s.vy;
                if (s.x < SNOOD_RADIUS + 5 || s.x > canvas.width - SNOOD_RADIUS - 5) s.vx *= -1;
                if (s.y < SNOOD_RADIUS + 25 || checkSnoodCollision(s)) { extraShots.splice(i, 1); }
            }

            edSpawnTimer += dt;
            const spawnRate = Math.max(0.35, 1.6 - level * 0.1);
            if (edSpawnTimer > spawnRate) { edSpawnTimer = 0; spawnEd(); if (level >= 4 && Math.random() < 0.25) spawnEd(); }

            powerupSpawnTimer += dt;
            if (powerupSpawnTimer > 8 + Math.random() * 5) { powerupSpawnTimer = 0; spawnPowerup(); }

            const edSpeed = slowTimer > 0 ? 0.4 : 1;
            for (let i = fallingEds.length - 1; i >= 0; i--) {
                const ed = fallingEds[i];
                ed.y += ed.speed * 55 * dt * edSpeed;
                ed.rotation += ed.rotSpeed * dt;
                ed.wobble += ed.wobbleSpeed * dt;
                ed.x += Math.sin(ed.wobble) * 0.4;

                if (!invincible && shieldTimer <= 0) {
                    const dx = launcherX - ed.x, dy = SHOOT_Y - ed.y;
                    if (Math.sqrt(dx*dx + dy*dy) < SNOOD_RADIUS + ed.type.size - 5) {
                        lives--;
                        invincible = true;
                        invincibleTimer = 1.5;
                        screenShake = 7;
                        sfxHit();
                        for (let j = 0; j < 15; j++) { const a = (j/15)*Math.PI*2; particles.push({ x: launcherX, y: SHOOT_Y, vx: Math.cos(a)*(3+Math.random()*3), vy: Math.sin(a)*(3+Math.random()*3), life: 0.5, color: '#ff0000', size: 5 }); }
                        fallingEds.splice(i, 1);
                        combo = 1;
                        if (lives <= 0) { endGame('ED GOT YOU!'); return; }
                        continue;
                    }
                } else if (shieldTimer > 0) {
                    const dx = launcherX - ed.x, dy = SHOOT_Y - ed.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 45) {
                        for (let j = 0; j < 8; j++) particles.push({ x: ed.x, y: ed.y, vx: (Math.random()-0.5)*6, vy: (Math.random()-0.5)*6, life: 0.4, color: '#00aaff', size: 4 });
                        fallingEds.splice(i, 1);
                        score += ed.type.points * 2;
                        continue;
                    }
                }
                if (ed.y > canvas.height + 30) { fallingEds.splice(i, 1); dodgedCount++; score += ed.type.points * level; }
            }

            for (let i = fallingPowerups.length - 1; i >= 0; i--) {
                const p = fallingPowerups[i];
                p.y += p.speed * 50 * dt;
                p.rotation += 2 * dt;
                const dx = launcherX - p.x, dy = SHOOT_Y - p.y;
                if (Math.sqrt(dx*dx + dy*dy) < 40) {
                    collectPowerup(p.type);
                    fallingPowerups.splice(i, 1);
                    continue;
                }
                if (p.y > canvas.height + 20) fallingPowerups.splice(i, 1);
            }

            if (invincible) { invincibleTimer -= dt; if (invincibleTimer <= 0) invincible = false; }

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.vy += 0.12;
                p.life -= dt;
                if (p.life <= 0) particles.splice(i, 1);
            }

            updateDisplay();
        }

        function checkSnoodCollision(snood) {
            for (let r = 0; r < grid.length; r++) {
                if (!grid[r]) continue;
                for (let c = 0; c < grid[r].length; c++) {
                    const s = grid[r][c];
                    if (s) {
                        const dx = snood.x - s.x, dy = snood.y - s.y;
                        if (Math.sqrt(dx*dx + dy*dy) < SNOOD_RADIUS * 1.85) { snap(r, snood); return true; }
                    }
                }
            }
            return false;
        }

        function collectPowerup(type) {
            sfxPowerup();
            for (let i = 0; i < 12; i++) { const a = (i/12)*Math.PI*2; particles.push({ x: launcherX, y: SHOOT_Y, vx: Math.cos(a)*4, vy: Math.sin(a)*4, life: 0.5, color: type.color, size: 5 }); }
            
            switch(type.type) {
                case 'shield': shieldTimer = 8; break;
                case 'bomb': activateBomb(); break;
                case 'slow': slowTimer = 6; break;
                case 'multi': multiShot = true; multiShotTimer = 10; break;
                case 'life': lives = Math.min(lives + 1, 5); break;
            }
            score += 50;
        }

        function activateBomb() {
            sfxBomb();
            screenShake = 5;
            let maxRow = 0;
            for (let r = 0; r < grid.length; r++) { if (grid[r]) for (let c = 0; c < grid[r].length; c++) if (grid[r][c]) maxRow = Math.max(maxRow, r); }
            
            if (grid[maxRow]) {
                for (let c = 0; c < grid[maxRow].length; c++) {
                    const s = grid[maxRow][c];
                    if (s) {
                        for (let j = 0; j < 6; j++) particles.push({ x: s.x, y: s.y, vx: (Math.random()-0.5)*8, vy: -Math.random()*5, life: 0.6, color: SNOOD_TYPES[s.type].color, size: 5 });
                        grid[maxRow][c] = null;
                        score += 15;
                    }
                }
            }
            setTimeout(() => removeFloating(), 100);
        }

        function snap(nearRow, snood) {
            let bestRow = nearRow, bestCol = 0, bestDist = Infinity;
            for (let r = Math.max(0, nearRow - 1); r <= nearRow + 1; r++) {
                const offset = r % 2 === 0 ? 0 : SNOOD_RADIUS;
                const maxC = COLS - (r % 2);
                for (let c = 0; c < maxC; c++) {
                    const x = c * SNOOD_RADIUS * 2 + SNOOD_RADIUS + offset;
                    const y = r * ROW_HEIGHT + SNOOD_RADIUS + 25;
                    if (!grid[r]) grid[r] = [];
                    if (grid[r][c]) continue;
                    const dx = snood.x - x, dy = snood.y - y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < bestDist) { bestDist = dist; bestRow = r; bestCol = c; }
                }
            }
            if (!grid[bestRow]) grid[bestRow] = [];
            const offset = bestRow % 2 === 0 ? 0 : SNOOD_RADIUS;
            grid[bestRow][bestCol] = { type: snood.type, x: bestCol * SNOOD_RADIUS * 2 + SNOOD_RADIUS + offset, y: bestRow * ROW_HEIGHT + SNOOD_RADIUS + 25 };
            checkMatches(bestRow, bestCol);
        }

        function checkMatches(row, col) {
            if (!grid[row] || !grid[row][col]) { combo = 1; checkGameOver(); return; }
            const type = grid[row][col].type;
            const matches = [], visited = new Set();
            function flood(r, c) {
                const key = r+','+c;
                if (visited.has(key) || !grid[r] || !grid[r][c] || grid[r][c].type !== type) return;
                visited.add(key);
                matches.push({ r, c });
                const odd = r % 2 === 1;
                const neighbors = odd ? [[r-1,c],[r-1,c+1],[r,c-1],[r,c+1],[r+1,c],[r+1,c+1]] : [[r-1,c-1],[r-1,c],[r,c-1],[r,c+1],[r+1,c-1],[r+1,c]];
                for (let n of neighbors) flood(n[0], n[1]);
            }
            flood(row, col);

            if (matches.length >= 3) {
                animating = true;
                for (let m of matches) {
                    if (grid[m.r] && grid[m.r][m.c]) {
                        const s = grid[m.r][m.c];
                        sfxPop();
                        for (let j = 0; j < 6; j++) { const a = Math.random()*Math.PI*2, sp = 2+Math.random()*3; particles.push({ x: s.x, y: s.y, vx: Math.cos(a)*sp, vy: Math.sin(a)*sp-1, life: 0.4+Math.random()*0.2, color: SNOOD_TYPES[s.type].color, size: 4 }); }
                        grid[m.r][m.c] = null;
                    }
                }
                const pts = matches.length * 10 * level + Math.floor(matches.length * 10 * level * (combo-1) * 0.4);
                score += pts;
                if (combo > 1) { showCombo(matches[0].c * SNOOD_RADIUS * 2 + SNOOD_RADIUS, matches[0].r * ROW_HEIGHT + SNOOD_RADIUS + 25, combo, pts); sfxCombo(); }
                combo++;
                maxCombo = Math.max(maxCombo, combo);
                setTimeout(() => { removeFloating(); if (checkWin()) { level++; sfxLevelUp(); addRows(); } animating = false; checkGameOver(); }, 150);
            } else { combo = 1; checkGameOver(); }
        }

        function showCombo(x, y, c, pts) {
            const popup = document.createElement('div');
            popup.className = 'combo-popup';
            popup.innerHTML = 'x'+c+' <span style="color:#0f0">+'+pts+'</span>';
            const rect = canvas.getBoundingClientRect();
            popup.style.left = (rect.left + x * rect.width / canvas.width - 40) + 'px';
            popup.style.top = (rect.top + y * rect.height / canvas.height) + 'px';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 800);
        }

        function removeFloating() {
            const connected = new Set();
            function mark(r, c) {
                const key = r+','+c;
                if (connected.has(key) || !grid[r] || !grid[r][c]) return;
                connected.add(key);
                const odd = r % 2 === 1;
                const neighbors = odd ? [[r-1,c],[r-1,c+1],[r,c-1],[r,c+1],[r+1,c],[r+1,c+1]] : [[r-1,c-1],[r-1,c],[r,c-1],[r,c+1],[r+1,c-1],[r+1,c]];
                for (let n of neighbors) mark(n[0], n[1]);
            }
            if (grid[0]) for (let c = 0; c < grid[0].length; c++) if (grid[0][c]) mark(0, c);
            let floating = 0;
            for (let r = 0; r < grid.length; r++) {
                if (!grid[r]) continue;
                for (let c = 0; c < grid[r].length; c++) {
                    if (grid[r][c] && !connected.has(r+','+c)) {
                        const s = grid[r][c];
                        sfxPop();
                        for (let j = 0; j < 5; j++) particles.push({ x: s.x, y: s.y, vx: (Math.random()-0.5)*4, vy: Math.random()*3, life: 0.5, color: SNOOD_TYPES[s.type].color, size: 5 });
                        grid[r][c] = null;
                        floating++;
                    }
                }
            }
            if (floating > 0) score += floating * 20 * level;
        }

        function checkWin() { for (let r = 0; r < grid.length; r++) if (grid[r]) for (let c = 0; c < grid[r].length; c++) if (grid[r][c]) return false; return true; }

        function addRows() {
            const numRows = Math.min(3 + Math.floor(level / 3), 5);
            const maxTypes = Math.min(4 + Math.floor(level / 2), SNOOD_TYPES.length);
            for (let row = 0; row < numRows; row++) {
                grid[row] = [];
                const offset = row % 2 === 0 ? 0 : SNOOD_RADIUS;
                for (let col = 0; col < COLS - (row % 2); col++) grid[row][col] = { type: Math.floor(Math.random() * maxTypes), x: col * SNOOD_RADIUS * 2 + SNOOD_RADIUS + offset, y: row * ROW_HEIGHT + SNOOD_RADIUS + 25 };
            }
        }

        function checkGameOver() { for (let r = 0; r < grid.length; r++) if (grid[r]) for (let c = 0; c < grid[r].length; c++) if (grid[r][c] && grid[r][c].y > DANGER_LINE) { endGame('SNOODS TOO LOW!'); return; } }

        function endGame(reason) {
            gameOver = true;
            stopMusic();
            document.getElementById('gameOverTitle').textContent = reason;
            document.getElementById('finalScore').textContent = score.toLocaleString();
            document.getElementById('finalLevel').textContent = level;
            document.getElementById('finalDodged').textContent = dodgedCount;
            document.getElementById('finalCombo').textContent = 'x' + maxCombo;
            const isRecord = saveScore();
            document.getElementById('newRecord').style.display = isRecord ? 'block' : 'none';
            document.getElementById('gameOverOverlay').classList.remove('hidden');
        }

        function saveScore() {
            leaderboard.push({ name: playerName, score, level, date: Date.now() });
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 30);
            localStorage.setItem('msgaSnoodLB4', JSON.stringify(leaderboard));
            updateLeaderboard();
            return leaderboard[0].score === score;
        }

        function updateDisplay() {
            document.getElementById('score').textContent = score.toLocaleString();
            document.getElementById('level').textContent = level;
            document.getElementById('combo').textContent = 'x' + combo;
            document.getElementById('lives').textContent = lives;
            document.getElementById('shield').textContent = shieldTimer > 0 ? Math.ceil(shieldTimer) + 's' : '-';
            document.getElementById('dodged').textContent = dodgedCount;
            document.getElementById('pu-shield').className = 'powerup-item' + (shieldTimer > 0 ? ' active' : '');
            document.getElementById('pu-slow').className = 'powerup-item' + (slowTimer > 0 ? ' active' : '');
            document.getElementById('pu-multi').className = 'powerup-item' + (multiShot ? ' active' : '');
        }

        function updateLeaderboard() {
            const el = document.getElementById('leaderboard');
            if (leaderboard.length === 0) { el.innerHTML = '<div style="color:#666;font-size:11px;text-align:center">No scores</div>'; return; }
            el.innerHTML = leaderboard.slice(0, 5).map((e, i) => '<div class="lb-entry"><span>'+(i+1)+'. '+e.name+'</span><span>'+e.score.toLocaleString()+'</span></div>').join('');
        }

        function render() {
            ctx.save();
            if (screenShake > 0) ctx.translate((Math.random()-0.5)*screenShake, (Math.random()-0.5)*screenShake);

            const grad = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width);
            grad.addColorStop(0, '#151525'); grad.addColorStop(1, '#0a0a12');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = 'rgba(255,215,0,0.04)';
            for (let x = 0; x < canvas.width; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
            for (let y = 0; y < canvas.height; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }

            ctx.strokeStyle = 'rgba(255,50,50,0.5)';
            ctx.lineWidth = 2;
            ctx.setLineDash([12, 6]);
            ctx.beginPath(); ctx.moveTo(0, DANGER_LINE); ctx.lineTo(canvas.width, DANGER_LINE); ctx.stroke();
            ctx.setLineDash([]);
            ctx.lineWidth = 1;

            for (let r = 0; r < grid.length; r++) if (grid[r]) for (let c = 0; c < grid[r].length; c++) { const s = grid[r][c]; if (s) drawSnood(s.x, s.y, s.type, 1); }

            for (let p of particles) { ctx.globalAlpha = Math.min(1, p.life * 2.5); ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.size * Math.min(1, p.life * 2), 0, Math.PI * 2); ctx.fill(); }
            ctx.globalAlpha = 1;

            for (let ed of fallingEds) {
                ctx.save();
                ctx.translate(ed.x, ed.y);
                ctx.rotate(ed.rotation);
                ctx.shadowColor = '#ff3333'; ctx.shadowBlur = 12;
                ctx.fillStyle = ed.type.color;
                ctx.beginPath(); ctx.arc(0, 0, ed.type.size, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.font = ed.type.size + 'px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(ed.type.emoji, 0, 1);
                ctx.restore();
            }

            for (let p of fallingPowerups) {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation);
                ctx.shadowColor = p.type.color; ctx.shadowBlur = 15;
                ctx.fillStyle = p.type.color;
                ctx.beginPath(); ctx.arc(0, 0, 16, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                ctx.font = '18px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(p.type.emoji, 0, 1);
                ctx.restore();
            }

            if (shootingSnood) {
                ctx.globalAlpha = 0.3;
                drawSnood(shootingSnood.x - shootingSnood.vx * 0.4, shootingSnood.y - shootingSnood.vy * 0.4, shootingSnood.type, 0.6);
                ctx.globalAlpha = 1;
                drawSnood(shootingSnood.x, shootingSnood.y, shootingSnood.type, 1);
            }
            for (let s of extraShots) drawSnood(s.x, s.y, s.type, 0.85);

            if (!shootingSnood && currentSnood && !animating && !gameOver) {
                ctx.strokeStyle = 'rgba(255,215,0,0.4)';
                ctx.lineWidth = 2;
                ctx.setLineDash([6, 6]);
                ctx.beginPath();
                ctx.moveTo(launcherX, SHOOT_Y);
                let px = launcherX, py = SHOOT_Y, vx = Math.cos(aimAngle), vy = Math.sin(aimAngle);
                for (let i = 0; i < 160; i++) { px += vx * 2; py += vy * 2; if (px < SNOOD_RADIUS + 5 || px > canvas.width - SNOOD_RADIUS - 5) vx *= -1; if (py < 30) break; }
                ctx.lineTo(px, py);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.lineWidth = 1;
            }

            if (shieldTimer > 0) {
                ctx.strokeStyle = 'rgba(0,170,255,' + (0.4 + Math.sin(Date.now()/100)*0.2) + ')';
                ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(launcherX, SHOOT_Y, 38, 0, Math.PI * 2); ctx.stroke();
                ctx.lineWidth = 1;
            }

            ctx.save();
            ctx.translate(launcherX, SHOOT_Y + 20);
            if (invincible && Math.floor(Date.now()/80) % 2 === 0) ctx.globalAlpha = 0.4;
            ctx.fillStyle = '#222';
            ctx.fillRect(-28, 0, 56, 12);
            ctx.fillStyle = '#bf0a30';
            ctx.fillRect(-24, 3, 48, 6);
            ctx.save();
            ctx.rotate(aimAngle + Math.PI/2);
            const cg = ctx.createLinearGradient(-7, 0, 7, 0);
            cg.addColorStop(0, '#ffdd44'); cg.addColorStop(0.5, '#ffd700'); cg.addColorStop(1, '#cc9900');
            ctx.fillStyle = cg;
            ctx.fillRect(-7, -28, 14, 32);
            ctx.fillStyle = '#fff';
            ctx.fillRect(-5, -30, 10, 4);
            ctx.restore();
            ctx.restore();
            ctx.globalAlpha = 1;

            if (currentSnood && !shootingSnood) drawSnood(launcherX, SHOOT_Y, currentSnood.type, 1);

            if (nextSnood) {
                ctx.fillStyle = '#666'; ctx.font = '10px VT323'; ctx.textAlign = 'center';
                ctx.fillText('NEXT', 32, canvas.height - 55);
                drawSnood(32, canvas.height - 30, nextSnood.type, 0.6);
            }

            ctx.fillStyle = '#333';
            ctx.fillRect(canvas.width - 80, canvas.height - 20, 70, 10);
            ctx.fillStyle = dashCooldown > 0 ? '#005555' : '#00aaaa';
            ctx.fillRect(canvas.width - 78, canvas.height - 18, 66 * (1 - dashCooldown/0.6), 6);
            ctx.fillStyle = dashCooldown > 0 ? '#555' : '#0ff';
            ctx.font = '9px VT323'; ctx.textAlign = 'right';
            ctx.fillText('DASH', canvas.width - 12, canvas.height - 11);

            ctx.restore();
        }

        function drawSnood(x, y, type, scale) {
            const t = SNOOD_TYPES[type], r = SNOOD_RADIUS * scale;
            ctx.save();
            ctx.translate(x, y);
            ctx.shadowColor = t.color; ctx.shadowBlur = 10;
            const g = ctx.createRadialGradient(-r*0.3, -r*0.3, 0, 0, 0, r);
            g.addColorStop(0, lighten(t.color, 35)); g.addColorStop(0.7, t.color); g.addColorStop(1, darken(t.color, 25));
            ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0;
            ctx.strokeStyle = 'rgba(0,0,0,0.25)'; ctx.lineWidth = 1.5; ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath(); ctx.arc(-r*0.25, -r*0.25, r * 0.3, 0, Math.PI * 2); ctx.fill();
            ctx.font = (r * 1.05) + 'px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(t.emoji, 0, 1);
            ctx.restore();
        }

        function lighten(c, p) { const n = parseInt(c.replace('#',''),16), a = Math.round(2.55*p); return '#'+(0x1000000+Math.min(255,(n>>16)+a)*0x10000+Math.min(255,((n>>8)&0xFF)+a)*0x100+Math.min(255,(n&0xFF)+a)).toString(16).slice(1); }
        function darken(c, p) { const n = parseInt(c.replace('#',''),16), a = Math.round(2.55*p); return '#'+(0x1000000+Math.max(0,(n>>16)-a)*0x10000+Math.max(0,((n>>8)&0xFF)-a)*0x100+Math.max(0,(n&0xFF)-a)).toString(16).slice(1); }

        updateLeaderboard();
        const sn = localStorage.getItem('msgaSnoodName');
        if (sn) document.getElementById('playerNameInput').value = sn;
        document.getElementById('playerNameInput').focus();
    </script>
</body>
</html>
