<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Offer Builder | AblesAI</title>
  
  <link rel="icon" href="data:image/svg+xml,%3Csvg viewBox='0 0 70 70' xmlns='http://www.w3.org/2000/svg'%3E%3Cstyle%3E@keyframes orbit{from{transform:rotate(0deg)}to{transform:rotate(-360deg)}}@keyframes moon-colors{0%25,100%25{fill:%23a855f7}33%25{fill:%23ec4899}66%25{fill:%23eab308}}.orbit-path{animation:orbit 10s linear infinite;transform-origin:32px 32px}.moon-color{animation:moon-colors 6s ease-in-out infinite}%3C/style%3E%3Ccircle cx='32' cy='32' r='24' stroke='%2310b981' stroke-width='6' fill='none'/%3E%3Cline x1='8' y1='56' x2='56' y2='8' stroke='%2334d399' stroke-width='5' stroke-linecap='round'/%3E%3Ccircle cx='56' cy='8' r='4' fill='%2334d399'/%3E%3Ccircle cx='8' cy='56' r='3' fill='%2310b981'/%3E%3Cg class='orbit-path' style='transform:rotate(45deg);transform-origin:32px 32px'%3E%3Ccircle class='moon-color' cx='64' cy='32' r='2'/%3E%3C/g%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'],
            mono: ['monospace']
          },
          colors: {
            ables: {
              main: '#0a0a0a',
              card: '#111111',
              inner: '#1a1a1a',
              border: '#1f1f1f',
              muted: '#6b7280'
            },
            emerald: {
              450: '#34d399',
              550: '#10b981'
            },
            neutral: { 
              850: '#1a1a1a',
              925: '#0d0d0d'
            }
          }
        }
      }
    }
  </script>

  <style>
    /* ============================================
       ABLESAI DESIGN LANGUAGE - TRUE BLACK FOUNDATION
       ============================================ */
    :root {
      /* True Black Foundation */
      --bg-body: #0a0a0a;
      --bg-body-gradient: #0a0a0a;
      --bg-card: #111111;
      --bg-card-inner: #1a1a1a;
      --bg-input: #1a1a1a;
      --bg-toggle: #1a1a1a;
      --bg-option-card: #111111;
      --bg-stat-hover: rgba(234, 179, 8, 0.15);
      
      /* Borders */
      --border-primary: #1f1f1f;
      --border-secondary: #1a1a1a;
      
      /* Typography */
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #6b7280;
      
      /* UI Elements */
      --slider-track: #1f1f1f;
      --pattern-color: rgba(255,255,255,0.01);
      --chart-bg: #1a1a1a;
      --modal-overlay: rgba(0, 0, 0, 0.8);
      
      /* Premium Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.6), 0 2px 4px -2px rgb(0 0 0 / 0.5);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.7), 0 4px 6px -4px rgb(0 0 0 / 0.6);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.7), 0 8px 10px -6px rgb(0 0 0 / 0.6);
      
      /* Preview Header */
      --preview-header-bg: linear-gradient(135deg, #0a0a0a 0%, #111111 50%, #0a0a0a 100%);
      --preview-header-text: #ffffff;
      
      /* Gold/Yellow Primary Accent */
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --accent-glow: rgba(234, 179, 8, 0.15);
      --accent-text: #0a0a0a;
      --accent-rgb: 234, 179, 8;
      
      /* Tier Colors for ABLESCORE */
      --tier-a: #10b981;
      --tier-b: #22c55e;
      --tier-c: #eab308;
      --tier-d: #f97316;
      --tier-e: #ef4444;
    }

    /* Logo Animation */
    @keyframes orbit {
      from { transform: rotate(0deg); }
      to { transform: rotate(-360deg); }
    }
    @keyframes moon-colors {
      0%, 100% { fill: #a855f7; }
      33% { fill: #ec4899; }
      66% { fill: #eab308; }
    }
    .orbit-path {
      animation: orbit 10s linear infinite;
      transform-origin: 32px 32px;
    }
    .moon-color {
      animation: moon-colors 6s ease-in-out infinite;
    }

    /* Backward compatibility - map old theme classes to AblesAI */
    .theme-light, .theme-dark, .theme-black,
    .accent-mint, .accent-blue, .accent-purple,
    .accent-rainbow, .accent-orange, .accent-cyan,
    .accent-gold, .accent-slate, .accent-lime,
    .accent-teal, .accent-pink, .accent-indigo {
      /* All mapped to AblesAI gold accent - no visual change needed */
    }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body { 
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif; 
      background: var(--bg-body);
      color: var(--text-primary); 
      min-height: 100vh;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(circle at 1px 1px, var(--pattern-color) 1px, transparent 0);
      background-size: 24px 24px;
      pointer-events: none;
      z-index: -1;
    }

    /* ============================================
       LIGHT THEME
       ============================================ */
    body.light-theme {
      --bg-body: #f8fafc;
      --bg-body-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --bg-card: #ffffff;
      --bg-card-inner: #f1f5f9;
      --bg-input: #e2e8f0;
      --bg-toggle: #e2e8f0;
      --bg-option-card: #f8fafc;
      --bg-stat-hover: rgba(234, 179, 8, 0.15);
      --border-primary: #cbd5e1;
      --border-secondary: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --slider-track: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.05);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.05);
      --preview-header-bg: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
      --preview-header-text: #0f172a;
      --pattern-color: rgba(0,0,0,0.02);
      --chart-bg: #f1f5f9;
      --modal-overlay: rgba(0, 0, 0, 0.4);
    }

    body.light-theme .main-header {
      background: #ffffff;
      border-bottom-color: #e2e8f0;
    }

    body.light-theme .main-header h1 {
      color: #0f172a;
    }

    body.light-theme .settings-btn {
      color: #64748b;
    }

    body.light-theme .settings-btn:hover {
      color: var(--accent);
    }

    body.light-theme .settings-modal {
      background: #ffffff;
      border-color: #e2e8f0;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }

    body.light-theme .settings-header {
      border-bottom-color: #e2e8f0;
    }

    body.light-theme .settings-row {
      background: #f8fafc;
    }

    body.light-theme .toggle-switch {
      background: #cbd5e1;
    }

    body.light-theme .toggle-switch.active {
      background: var(--accent);
    }

    body.light-theme .card {
      background: #ffffff !important;
      border-color: #e2e8f0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    body.light-theme .preview-card {
      background: #ffffff;
      border-color: var(--accent);
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }

    .input-field {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
      outline: none;
    }

    .input-field:hover:not(:focus) {
      border-color: var(--text-muted);
    }

    .input-field::placeholder {
      color: var(--text-muted);
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
      pointer-events: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--accent-text);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.3), var(--shadow-md);
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.5), var(--shadow-lg), 0 8px 20px -4px rgba(var(--accent-rgb), 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      color: var(--text-secondary);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.2), var(--shadow-md);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      color: var(--accent);
      background: var(--accent-glow);
    }

    /* ============================================
       CARDS
       ============================================ */
    .card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-primary);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-section {
      border-left: 3px solid var(--accent);
    }

    /* ============================================
       TABS
       ============================================ */
    .calc-tab {
      position: relative;
      transition: all 0.2s;
      color: var(--text-muted);
    }

    .calc-tab:hover:not(.active) {
      color: var(--text-secondary);
    }

    .calc-tab.active {
      color: var(--accent);
      background: var(--bg-card);
      border-color: var(--border-primary);
      border-bottom-color: var(--bg-card);
    }

    .calc-tab.active::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: 3px 3px 0 0;
    }

    /* ============================================
       OFFER BUILDER PRODUCT TABS
       ============================================ */
    .offer-product-tabs {
      display: flex;
      gap: 6px;
      padding: 6px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      margin-bottom: 16px;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      flex-shrink: 0;
    }
    .offer-product-tabs::-webkit-scrollbar {
      display: none;
    }
    .offer-product-tab {
      flex-shrink: 0;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .offer-product-tab:hover:not(.active) {
      color: var(--text-secondary);
      background: var(--bg-toggle);
    }
    .offer-product-tab.active {
      color: var(--accent);
      background: var(--accent-glow);
      border-color: var(--accent);
    }
    @media (max-width: 768px) {
      .offer-product-tabs {
        margin-bottom: 16px;
        padding: 4px;
        gap: 4px;
      }
      .offer-product-tab {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    /* ============================================
       TOGGLES & SWITCHES
       ============================================ */
    .toggle-group {
      background: var(--bg-toggle);
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
    }

    .toggle-btn {
      color: var(--text-muted);
      font-weight: 600;
      transition: all 0.2s;
    }

    .toggle-btn:hover:not(.active) {
      color: var(--text-secondary);
    }

    .toggle-btn.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--accent-text);
      box-shadow: var(--shadow-md);
      border-radius: 8px;
    }

    /* Custom Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--slider-track);
      border-radius: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .switch-slider::before {
      content: '';
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .switch input:checked + .switch-slider {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    }

    .switch input:checked + .switch-slider::before {
      transform: translateX(20px);
    }

    .switch input:focus + .switch-slider {
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* ============================================
       SLIDERS
       ============================================ */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
      outline: none;
      cursor: pointer;
      overflow: visible;
      touch-action: none;
    }

    .slider::-webkit-slider-runnable-track {
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
      margin-top: -8px;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 4px 12px rgba(0,0,0,0.15);
    }

    .slider::-webkit-slider-thumb:active {
      cursor: grabbing;
      transform: scale(1.05);
    }

    .slider::-moz-range-thumb {
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .slider::-moz-range-track {
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
    }

    /* Dark variant for client slider */
    .slider-dark {
      background: rgba(255, 255, 255, 0.12);
      height: 10px;
    }

    .slider-dark::-webkit-slider-thumb {
      border: 0;
      background: linear-gradient(135deg, var(--accent-light), var(--accent));
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 0 0 4px rgba(255,255,255,0.15), 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.15s ease, background 1.5s ease, box-shadow 1.5s ease;
    }

    .slider-dark::-webkit-slider-thumb:hover {
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.6), 0 0 0 6px rgba(255,255,255,0.2), 0 6px 16px rgba(0,0,0,0.35);
    }

    /* ============================================
       CHARTS
       ============================================ */
    .circular-chart {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 100%;
    }

    .circle-bg {
      fill: none;
      stroke: var(--chart-bg);
      stroke-width: 3;
    }

    .circle {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
      stroke: url(#gradient);
      transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 2px 4px rgba(var(--accent-rgb), 0.3));
    }

    /* ============================================
       STICKY PREVIEW COLUMN
       ============================================ */
    #previewColumn {
      position: relative;
    }
    
    /* Desktop: Sticky behavior */
    @media (min-width: 1024px) {
      #previewColumn {
        position: -webkit-sticky;
        position: sticky;
        top: 70px;
        align-self: start;
        max-height: calc(100vh - 90px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) transparent;
      }
      
      #previewColumn::-webkit-scrollbar {
        width: 6px;
      }
      
      #previewColumn::-webkit-scrollbar-track {
        background: transparent;
      }
      
      #previewColumn::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
      }
    }
    
    .preview-sticky-wrapper {
      position: sticky;
      top: 16px;
      width: 100%;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
    }
    
    @media (max-width: 1024px) {
      .preview-sticky-wrapper {
        position: static;
        top: auto;
        width: 100%;
        max-height: none;
      }
    }
    
    /* Consistent preview column for all tools */
    .calc-preview-column {
      position: relative;
    }
    
    @media (min-width: 1024px) {
      .calc-preview-column {
        position: -webkit-sticky;
        position: sticky;
        top: 70px;
        align-self: start;
        max-height: calc(100vh - 90px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) transparent;
      }
      
      .calc-preview-column::-webkit-scrollbar {
        width: 6px;
      }
      
      .calc-preview-column::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .calc-preview-column::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
      }
    }
    
    /* Action Bar - Hidden (buttons are in header) */
    #stickyActionBar {
      display: none !important;
    }
    
    /* Sticky Header */
    #adminPanel {
      padding: 0;
      box-sizing: border-box;
    }
    #adminPanel > header {
      background: #000 !important;
    }
    
    /* Sticky Preview Dropdown */
    .preview-picker-sticky {
      position: relative;
    }
    
    .preview-picker-sticky .preview-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 8px;
      box-shadow: var(--shadow-xl);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 100;
    }
    
    .preview-picker-sticky .preview-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    /* Ensure nothing breaks sticky */
    .w-full,
    #adminPanel,
    #adminPanel .grid {
      overflow: visible !important;
    }

    /* ============================================
       PREVIEW CARD
       ============================================ */
    .preview-card {
      background: var(--bg-card);
      border-radius: 28px;
      border: 4px solid var(--accent);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.25),
        0 0 80px rgba(var(--accent-rgb), 0.1),
        0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .preview-card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 0 60px rgba(var(--accent-rgb), 0.35),
        0 0 100px rgba(var(--accent-rgb), 0.15),
        0 30px 60px -12px rgba(0, 0, 0, 0.3);
    }

    .preview-header {
      background: var(--preview-header-bg);
      position: relative;
      overflow: hidden;
    }

    .preview-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 30% 20%, rgba(var(--accent-rgb), 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(var(--accent-rgb), 0.05) 0%, transparent 40%);
      pointer-events: none;
    }

    .preview-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    .amount-display {
      font-size: clamp(2.5rem, 8vw, 3.5rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 20px rgba(255,255,255,0.1);
    }

    /* Business Name Styling */
    .business-name-display {
      font-size: 1.125rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #ffffff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Logo Styling */
    .preview-logo {
      max-height: 48px;
      max-width: 160px;
      object-fit: contain;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
    }

    .preview-logo-container {
      margin-bottom: 16px;
    }

    .company-name-display {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    .stat-cell {
      padding: 20px 16px;
      text-align: center;
      transition: all 0.2s;
      position: relative;
    }

    .stat-cell::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: transparent;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .stat-cell:hover::after {
      background: var(--bg-stat-hover);
    }

    .stat-label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .stat-value {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }

    /* ============================================
       INLINE EDITABLE VALUES
       ============================================ */
    .editable-value {
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      padding: 2px 6px;
      margin: -2px -6px;
      position: relative;
    }

    .editable-value:hover {
      background: var(--accent-glow);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .editable-value:focus {
      outline: none;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .editable-value::after {
      content: '✎';
      position: absolute;
      right: -18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      opacity: 0;
      color: var(--accent);
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .editable-value:hover::after {
      opacity: 0.7;
    }

    .editable-value:focus::after {
      opacity: 0;
    }

    .amount-display.editable-value::after {
      right: -24px;
      font-size: 14px;
    }

    /* ============================================
       THEME PICKER
       ============================================ */
    .theme-picker {
      position: relative;
    }

    .theme-picker-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 36px;
      padding: 0 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-picker-btn:hover {
      background: var(--bg-card);
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow-xl);
      z-index: 100;
      min-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .theme-section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .theme-mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .theme-mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border-primary);
      background: var(--bg-option-card);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .theme-mode-btn:hover {
      border-color: var(--accent);
    }

    .theme-mode-btn.active {
      border-color: var(--accent);
      background: var(--accent-glow);
      color: var(--accent);
    }

    /* Mode Toggle Buttons */
    .mode-toggle-btn {
      transition: all 0.2s;
      border-radius: 20px;
    }
    .mode-toggle-btn:hover {
      background: var(--accent-glow);
    }
    .mode-toggle-btn.active {
      background: var(--accent);
      color: var(--accent-text) !important;
    }

    /* Tier Preset Buttons */
    .tier-preset-btn {
      cursor: pointer;
    }
    .tier-preset-btn:hover {
      border-color: var(--accent) !important;
      background: var(--bg-option-card) !important;
    }
    .tier-preset-btn.active {
      border-color: var(--accent) !important;
      background: var(--accent-glow) !important;
    }

    /* Preview Dropdown */
    .preview-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 8px;
      box-shadow: var(--shadow-xl);
      z-index: 100;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .preview-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .preview-option {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
      color: var(--text-secondary);
    }
    
    .preview-option:hover {
      background: var(--bg-option-card);
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateX(4px);
    }
    
    .preview-option:hover .preview-option-title {
      color: var(--accent);
    }
    
    .preview-option:hover svg {
      color: var(--accent);
    }
    
    .preview-option svg {
      flex-shrink: 0;
      transition: color 0.15s ease;
    }
    
    .preview-option-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      transition: color 0.15s ease;
    }
    
    .preview-option-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .color-swatches {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid transparent;
      position: relative;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.active {
      border-color: var(--text-primary);
    }

    .color-swatch.active::after {
      content: '✓';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .color-swatch.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .color-swatch.locked:hover {
      transform: none;
    }

    .color-swatch.locked::before {
      content: '';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 14px 14px;
    }

    .swatch-mint { background: linear-gradient(135deg, #10b981, #059669); }
    .swatch-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .swatch-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .swatch-rainbow { 
      background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6, #f43f5e, #f97316, #eab308); 
      background-size: 300% 300%;
      animation: rainbowSwatch 6s ease infinite;
    }
    @keyframes rainbowSwatch {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .swatch-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
    .swatch-cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .swatch-gold { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .swatch-slate { background: linear-gradient(135deg, #525252, #404040); }
    .swatch-lime { background: linear-gradient(135deg, #166534, #14532d); }
    .swatch-teal { background: linear-gradient(135deg, #1e3a5f, #172554); }
    .swatch-pink { background: linear-gradient(135deg, #881337, #4c0519); }
    .swatch-indigo { background: linear-gradient(135deg, #64748b, #475569); }

    /* Logo Input in Theme Dropdown */
    .logo-input-container {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-secondary);
    }

    .logo-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .logo-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .logo-input::placeholder {
      color: var(--text-muted);
    }

    .logo-preview-small {
      margin-top: 10px;
      padding: 12px;
      background: var(--bg-option-card);
      border-radius: 8px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-preview-small img {
      max-height: 36px;
      max-width: 100%;
      object-fit: contain;
    }

    .logo-preview-placeholder {
      font-size: 11px;
      color: var(--text-muted);
    }

    .clear-logo-btn {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s;
    }

    .clear-logo-btn:hover {
      color: #ef4444;
    }

    /* Brand Section Locked State */
    .brand-section {
      position: relative;
      overflow: hidden;
    }

    .brand-section.locked .brand-content {
      filter: blur(1px);
      pointer-events: none;
      user-select: none;
      opacity: 0.7;
    }

    .brand-lock-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      gap: 6px;
    }

    .brand-section:not(.locked) .brand-lock-overlay {
      display: none;
    }

    .brand-lock-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .brand-lock-btn:hover {
      filter: brightness(1.1);
      transform: scale(1.02);
    }

    .brand-lock-text {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* ============================================
       HEADER & SETTINGS BUTTON
       ============================================ */
    .main-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 24px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-primary);
      position: relative;
      z-index: 100;
    }

    .main-header svg:first-of-type {
      width: 24px;
      height: 24px;
    }

    .main-header h1 {
      font-size: 16px;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--text-primary);
    }

    .settings-btn {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      padding: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-btn:hover {
      color: var(--accent);
    }

    .settings-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Settings Modal */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .settings-overlay.active {
      display: flex;
    }

    .settings-modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-xl);
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .settings-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .settings-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s ease;
    }

    .settings-close:hover {
      color: var(--text-primary);
    }

    .settings-close svg {
      width: 24px;
      height: 24px;
    }

    .settings-body {
      padding: 20px;
    }

    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-card-inner);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .settings-row:last-child {
      margin-bottom: 0;
    }

    .settings-row-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .settings-row-desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
      background: var(--bg-input);
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(22px);
    }

    /* Welcome/Login Screen */
    .welcome-screen {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 2000;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      opacity: 1;
      visibility: visible;
      transition: all 0.4s ease-out;
    }

    .welcome-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .hidden {
      display: none !important;
    }

    .welcome-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 2px solid var(--accent);
      box-shadow: 0 0 40px rgba(var(--accent-rgb), 0.4), 0 0 80px rgba(var(--accent-rgb), 0.2), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      text-align: center;
      position: relative;
      overflow: visible;
      transition: border-color 0.8s ease, box-shadow 0.8s ease;
    }
    
    .welcome-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      color: var(--accent);
      transition: color 0.8s ease, transform 0.2s ease;
      cursor: pointer;
      display: block;
      text-decoration: none;
    }
    
    .welcome-logo:hover {
      transform: scale(1.1);
    }

    .welcome-logo svg {
      width: 100%;
      height: 100%;
    }

    .welcome-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .welcome-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    .welcome-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .welcome-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .welcome-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .welcome-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .welcome-btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 20px;
      color: var(--accent-text);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 1.5s ease, box-shadow 1.5s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.4), 0 0 40px rgba(var(--accent-rgb), 0.2), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .welcome-btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .welcome-btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 30px rgba(var(--accent-rgb), 0.5), 0 0 60px rgba(var(--accent-rgb), 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .welcome-btn-primary:hover::before {
      opacity: 1;
    }
    
    .welcome-btn-primary:active {
      transform: translateY(-1px) scale(1.01);
    }
    
    .welcome-btn-primary svg {
      width: 18px;
      height: 18px;
    }
    
    .welcome-btn-primary .pro-badge {
      background: rgba(0,0,0,0.25);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.1em;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .welcome-btn-secondary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 20px;
      background: var(--bg-card-inner);
      border: 1px solid var(--accent);
      border-radius: 14px;
      color: var(--accent);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 1.5s ease, color 1.5s ease, box-shadow 1.5s ease;
      position: relative;
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.15);
    }

    .welcome-btn-secondary:hover {
      background: var(--accent-glow);
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.25);
    }
    
    .welcome-btn-secondary:active {
      transform: translateY(0);
    }
    
    .welcome-btn-secondary .lite-badge {
      background: rgba(var(--accent-rgb), 0.15);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent);
      border: 1px solid rgba(var(--accent-rgb), 0.3);
      transition: all 1.5s ease;
    }

    .welcome-error {
      font-size: 13px;
      color: #ef4444;
      text-align: center;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      display: none;
      font-weight: 500;
    }

    .welcome-error.show {
      display: block;
    }

    .welcome-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .welcome-divider::before,
    .welcome-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .welcome-features {
      margin-top: 24px;
      text-align: left;
    }

    .welcome-mode-toggle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .welcome-mode-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .welcome-toggle-wrapper {
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      transition: background 0.8s ease, border-color 0.8s ease;
    }
    
    .welcome-toggle-btn {
      color: var(--accent);
      transition: color 0.8s ease;
    }
    
    .welcome-toggle-divider {
      background: var(--accent);
      transition: background 0.8s ease;
    }
    
    .welcome-mode-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .welcome-mode-btn:hover {
      color: var(--text-primary);
    }
    
    .welcome-mode-btn.active {
      color: var(--accent);
      background: rgba(255,255,255,0.1);
    }

    .welcome-features-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .welcome-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
    }

    .welcome-feature svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .welcome-feature.locked svg {
      color: var(--text-muted);
    }

    .welcome-feature.locked {
      color: var(--text-muted);
    }

    /* Login Modal (for later logins from brand section) */
    .login-modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .login-modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .login-modal {
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-radius: 24px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.4),
        0 0 80px rgba(var(--accent-rgb), 0.2),
        0 25px 50px -12px rgba(0, 0, 0, 0.5);
      overflow: visible;
    }
    
    .login-modal-overlay.open .login-modal {
      transform: scale(1) translateY(0);
    }

    .login-modal-content {
      padding: 32px;
      text-align: center;
      overflow: hidden;
      border-radius: 22px;
    }

    .login-modal-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      color: var(--accent);
    }
    
    .login-modal-icon svg {
      width: 100%;
      height: 100%;
    }

    .login-modal-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .login-modal-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .login-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .login-error {
      font-size: 13px;
      color: #ef4444;
      text-align: center;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      display: none;
      font-weight: 500;
    }

    .login-error.show {
      display: block;
    }

    .login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 4px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(var(--accent-rgb), 0.3);
    }
    
    .login-btn svg {
      width: 18px;
      height: 18px;
    }

    .login-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .login-free-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 14px 16px;
      background: transparent;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-free-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .login-features {
      margin-top: 24px;
      text-align: left;
    }

    .login-features-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .login-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
    }

    .login-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .login-feature-locked {
      color: var(--text-muted);
    }

    .login-feature-locked svg {
      color: var(--text-muted);
    }

    .login-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--bg-input);
      color: var(--text-secondary);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .login-close-btn:hover {
      background: var(--accent-glow);
      color: var(--accent);
    }

    /* User Badge in Header */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.3);
      transition: all 0.2s, border-color 1.5s ease, background 1.5s ease, color 1.5s ease, box-shadow 1.5s ease;
    }
    
    .user-badge:hover {
      background: var(--accent);
      color: var(--accent-text);
      border-color: var(--accent);
      box-shadow: 0 0 25px rgba(var(--accent-rgb), 0.5);
    }

    .user-badge svg {
      width: 14px;
      height: 14px;
    }

    .logout-btn {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      border-color: #ef4444;
      color: #ef4444;
    }

    /* Lite Usage Badge */
    .lite-usage-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #f59e0b;
      transition: all 0.2s;
    }
    
    .lite-usage-badge .lite-count {
      font-weight: 800;
      font-size: 13px;
    }
    
    .lite-usage-badge .lite-label {
      font-weight: 500;
      opacity: 0.8;
    }
    
    .lite-usage-badge.low {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .lite-usage-badge.depleted {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.5);
      color: #ef4444;
      animation: pulse-warning 2s infinite;
    }
    
    @keyframes pulse-warning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(8px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .fade-enter {
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(100%); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 var(--accent-glow); }
      70% { box-shadow: 0 0 0 10px transparent; }
      100% { box-shadow: 0 0 0 0 transparent; }
    }

    .pulse-ring {
      animation: pulse-ring 2s infinite;
    }

    /* Toast */
    .toast {
      transform: translateY(120%);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .toast.show {
      transform: translateY(0);
    }

    /* ============================================
       SECTION LABELS
       ============================================ */
    .section-indicator {
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--accent), var(--accent-light));
      border-radius: 4px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    /* ============================================
       OPTION TOGGLE CARDS
       ============================================ */
    .option-card {
      background: var(--bg-option-card);
      border-radius: 14px;
      border: 1px solid var(--border-secondary);
      padding: 16px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .option-card:hover {
      border-color: rgba(var(--accent-rgb), 0.3);
    }

    .option-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* ============================================
       MODALS
       ============================================ */
    .modal-overlay {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: var(--modal-overlay);
    }

    .modal-content {
      animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .share-option:hover {
      border-color: var(--accent) !important;
      transform: translateY(-2px);
    }
    .share-option:hover > div:first-child {
      transform: scale(1.1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* ============================================
       TABLE STYLES
       ============================================ */
    .amort-table {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .amort-table th {
      position: sticky;
      top: 0;
      background: var(--bg-option-card);
      z-index: 10;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .amort-table tbody tr {
      transition: background 0.15s;
    }

    .amort-table tbody tr:hover {
      background: var(--bg-option-card);
    }

    .amort-table td {
      color: var(--text-secondary);
    }

    /* ============================================
       COLLAPSIBLE SECTIONS (All Screens)
       ============================================ */
    .mobile-collapsible .section-header {
      cursor: pointer;
      user-select: none;
    }
    
    .mobile-collapsible .section-header .collapse-icon {
      display: flex;
      transition: transform 0.3s ease;
    }
    
    .mobile-collapsible.collapsed .section-header .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .mobile-collapsible .section-content {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .mobile-collapsible.collapsed .section-content {
      max-height: 0 !important;
      opacity: 0;
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    .mobile-collapsible:not(.collapsed) .section-content {
      max-height: 2000px;
      opacity: 1;
    }
    
    /* Force expanded on desktop */
    @media (min-width: 769px) {
      .mobile-collapsible.collapsed .section-content {
        max-height: 2000px !important;
        opacity: 1 !important;
        padding-top: revert !important;
        margin-top: revert !important;
      }
      .mobile-collapsible .section-header .collapse-icon {
        display: none;
      }
    }

    /* ============================================
       RESPONSIVE ADJUSTMENTS
       ============================================ */
    @media (max-width: 768px) {
      .preview-card {
        border-width: 3px;
        border-radius: 24px;
      }

      .amount-display {
        font-size: 2.5rem;
      }

      .theme-dropdown {
        right: -50px;
        min-width: 260px;
      }

      .business-name-display {
        font-size: 1rem;
      }

      /* Mobile Header Styles - Compact for fixed bottom nav layout */
      .header-main {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 8px !important;
        padding: 8px 12px !important;
      }

      /* Logo and title on left */
      .header-brand {
        order: 0 !important;
        justify-content: flex-start !important;
        width: auto !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        flex-shrink: 0 !important;
      }

      .header-brand h1 {
        font-size: 14px !important;
      }

      .header-brand svg {
        width: 24px !important;
        height: 24px !important;
      }

      /* User badge - top right corner */
      #userBadge {
        order: 3 !important;
        position: relative !important;
        right: auto !important;
        top: auto !important;
      }

      /* Mode toggle compact */
      .header-mode-toggle {
        order: 1 !important;
        padding: 3px 2px !important;
        flex-shrink: 0 !important;
      }

      .header-mode-toggle button {
        padding: 0 6px !important;
        font-size: 10px !important;
      }

      /* Action buttons row */
      .header-actions {
        order: 2 !important;
        justify-content: flex-end !important;
        gap: 6px !important;
        width: auto !important;
        flex-shrink: 0 !important;
      }

      /* Make action buttons more compact */
      .header-actions button,
      .header-actions .theme-picker button,
      .header-actions .preview-picker button {
        height: 28px !important;
        padding: 0 8px !important;
        font-size: 10px !important;
      }

      /* Hide button text on small screens, show only icons */
      header .btn-text {
        display: none !important;
      }

      /* Keep dropdown arrow visible */
      header > .flex.items-center.gap-2 .preview-picker button svg:last-child {
        display: block;
      }

      /* Adjust dropdown positions for mobile */
      .theme-dropdown {
        right: 0 !important;
        left: auto !important;
        transform: none !important;
        min-width: 260px !important;
        max-width: calc(100vw - 24px) !important;
      }

      .preview-dropdown {
        right: 0 !important;
        left: auto !important;
        transform: none !important;
      }
    }

    /* Extra small screens */
    @media (max-width: 480px) {
      .header-main {
        padding: 6px 8px !important;
        gap: 6px !important;
      }
      
      .header-brand h1 {
        font-size: 12px !important;
      }
      
      .header-brand svg {
        width: 20px !important;
        height: 20px !important;
      }

      .header-mode-toggle {
        display: none !important; /* Hide on very small screens */
      }

      .header-actions {
        gap: 4px !important;
      }

      .header-actions button {
        padding: 0 6px !important;
        height: 26px !important;
      }
    }

    /* ============================================
       SCROLLBAR STYLES
       ============================================ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-option-card);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--slider-track);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================================
       BADGE STYLES
       ============================================ */
    .trust-badge {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-md), 0 0 0 1px rgba(var(--accent-rgb), 0.1);
      position: relative;
      overflow: hidden;
    }

    .trust-badge::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.08), transparent);
      pointer-events: none;
    }

    .trust-badge-icon {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(var(--accent-rgb), 0.4);
    }

    .trust-badge-icon svg {
      width: 12px;
      height: 12px;
      color: white;
    }

    .trust-badge-text {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-secondary);
    }

    .trust-badge-accent {
      color: var(--accent);
      font-weight: 800;
    }

    /* Light theme trust badge */
    .theme-light .trust-badge {
      background: white;
      border-color: rgba(var(--accent-rgb), 0.2);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(var(--accent-rgb), 0.1);
    }

    /* Dark theme trust badge */
    .theme-dark .trust-badge {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(var(--accent-rgb), 0.3);
    }

    /* Black theme trust badge */
    .theme-black .trust-badge {
      background: rgba(20, 20, 20, 0.95);
      border-color: rgba(var(--accent-rgb), 0.4);
    }

    .option-badge {
      background: rgba(var(--accent-rgb), 0.1);
      border: 1px solid rgba(var(--accent-rgb), 0.2);
      color: var(--accent);
    }

    /* Dark theme specific overrides */
    .theme-dark .preview-header .amount-display {
      background: linear-gradient(180deg, #ffffff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-dark .btn-secondary:hover {
      background: var(--accent-glow);
    }

    .theme-dark input,
    .theme-dark textarea,
    .theme-dark select {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    /* Gradient fix for dark mode inputs */
    .theme-dark .option-card input,
    .theme-dark .option-card textarea {
      background: var(--bg-card);
      border-color: var(--border-primary);
    }

    .theme-dark .stats-grid {
      background: var(--bg-card-inner);
    }

    .theme-dark .stat-cell {
      border-color: var(--border-primary) !important;
    }

    /* Black theme specific overrides */
    .theme-black .preview-header .amount-display {
      background: linear-gradient(180deg, #ffffff 0%, #a3a3a3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-black .btn-secondary:hover {
      background: var(--accent-glow);
    }

    .theme-black input,
    .theme-black textarea,
    .theme-black select {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .theme-black .option-card input,
    .theme-black .option-card textarea {
      background: var(--bg-card);
      border-color: var(--border-primary);
    }

    .theme-black .stats-grid {
      background: #0a0a0a;
    }

    .theme-black .stats-grid:nth-child(even) {
      background: #0f0f0f;
    }

    .theme-black .stat-cell {
      border-color: var(--border-primary) !important;
    }

    /* Dashboard Styles */
    .offer-count-badge {
      background: var(--accent);
      color: var(--accent-text);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
    }
    
    /* Lite usage badge - grey by default, orange when low */
    .lite-badge {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    
    .lite-badge.low {
      background: var(--accent);
      color: var(--accent-text);
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
    }
    
    /* ============================================
       OFFER PIPELINE MODAL
       ============================================ */
    .dashboard-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .dashboard-backdrop {
      position: absolute;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      z-index: 1;
    }
    
    .dashboard-content {
      position: relative;
      z-index: 2;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 24px;
      width: 100%;
      max-width: 1100px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.2),
        0 0 80px rgba(var(--accent-rgb), 0.1),
        0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    .dashboard-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--preview-header-bg);
      position: relative;
    }
    
    .dashboard-header .header-actions {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 2;
    }
    
    .dashboard-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(var(--accent-rgb), 0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .dashboard-title {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    
    .dashboard-title .section-indicator {
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--accent-light), var(--accent));
      border-radius: 2px;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.5);
    }
    
    .dashboard-title h2 {
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      letter-spacing: 0.02em;
    }
    
    .dashboard-body {
      overflow-y: auto;
      flex: 1;
      padding: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    
    .dashboard-body::-webkit-scrollbar { width: 6px; }
    .dashboard-body::-webkit-scrollbar-track { background: transparent; }
    .dashboard-body::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    .dashboard-body::-webkit-scrollbar-thumb:hover { background: var(--accent-light); }
    
    /* Pipeline Metrics */
    /* Pipeline Metrics - Summary Cards */
    .pipeline-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 14px;
      padding: 14px 10px;
      text-align: center;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border-secondary);
      transition: all 0.25s;
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .metric-card.active {
      border-color: currentColor;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
    }
    
    .metric-card.active::before {
      height: 4px;
    }
    
    .metric-card.total.active { border-color: var(--accent); box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.3); }
    .metric-card.shared.active { border-color: #8b5cf6; box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
    .metric-card.viewed.active { border-color: #06b6d4; box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); }
    .metric-card.accepted.active { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    .metric-card.declined.active { border-color: #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
    .metric-card.pending.active { border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
    
    .metric-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.1;
    }
    
    .metric-count {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .metric-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-top: 6px;
    }
    
    /* Metric card color variants */
    .metric-card.total::before { background: var(--accent); }
    .metric-card.total .metric-value { color: var(--accent); }
    
    .metric-card.shared::before { background: #8b5cf6; }
    .metric-card.shared .metric-value { color: #8b5cf6; }
    
    .metric-card.viewed::before { background: #06b6d4; }
    .metric-card.viewed .metric-value { color: #06b6d4; }
    
    .metric-card.accepted::before { background: #10b981; }
    .metric-card.accepted .metric-value { color: #10b981; }
    
    .metric-card.declined::before { background: #ef4444; }
    .metric-card.declined .metric-value { color: #ef4444; }
    
    .metric-card.pending::before { background: #f59e0b; }
    .metric-card.pending .metric-value { color: #f59e0b; }
    
    /* View Toggle & Toolbar */
    .pipeline-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .view-toggle {
      display: flex;
      background: var(--bg-toggle);
      border-radius: 10px;
      padding: 3px;
      border: 1px solid var(--border-secondary);
    }
    
    .view-toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .view-toggle-btn:hover {
      color: var(--text-primary);
    }
    
    .view-toggle-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(var(--accent-rgb), 0.4);
    }
    
    .view-toggle-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: 1px solid var(--border-secondary);
      background: var(--bg-option-card);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .toolbar-btn.active {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .toolbar-btn svg {
      width: 14px;
      height: 14px;
    }
    
    /* Kanban Board */
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      min-height: 400px;
    }
    
    @media (max-width: 900px) {
      .kanban-board {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .kanban-board {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .kanban-column {
        max-height: 300px;
      }
    }
    
    .kanban-column {
      display: flex;
      flex-direction: column;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 14px;
      min-height: 200px;
      max-height: 500px;
    }
    
    .kanban-column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-secondary);
      position: sticky;
      top: 0;
      background: var(--bg-option-card);
      border-radius: 14px 14px 0 0;
      z-index: 1;
    }
    
    .kanban-column-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .kanban-column-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .kanban-column-name {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    
    .kanban-column-count {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      background: var(--bg-toggle);
      border-radius: 10px;
      color: var(--text-muted);
    }
    
    .kanban-column-body {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .kanban-column-body::-webkit-scrollbar { width: 4px; }
    .kanban-column-body::-webkit-scrollbar-track { background: transparent; }
    .kanban-column-body::-webkit-scrollbar-thumb { background: var(--border-secondary); border-radius: 2px; }
    
    /* Kanban Card (compact) */
    .kanban-card {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .kanban-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .kanban-card.starred {
      border-color: #fbbf24;
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.2);
    }
    
    .kanban-card.stale {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }
    
    .kanban-card.archived {
      opacity: 0.5;
    }
    
    .kanban-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    
    .kanban-card-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.3;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .kanban-card-star {
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .kanban-card-star:hover {
      color: #fbbf24;
      transform: scale(1.1);
    }
    
    .kanban-card-star.active {
      color: #fbbf24;
      filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.5));
    }
    
    .kanban-card-star svg {
      width: 14px;
      height: 14px;
    }
    
    .kanban-card-amount {
      font-size: 15px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 6px;
    }
    
    .kanban-card-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .kanban-card-date {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .kanban-card-stale {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border-radius: 4px;
    }
    
    /* Tags System */
    .offer-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    
    .offer-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: default;
    }
    
    .offer-tag.hot-lead {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .offer-tag.renewal {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .offer-tag.referral {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .offer-tag.follow-up {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .offer-tag.vip {
      background: rgba(236, 72, 153, 0.15);
      color: #f472b6;
      border: 1px solid rgba(236, 72, 153, 0.3);
    }
    
    /* Tag Picker Dropdown */
    .tag-picker {
      position: relative;
      display: inline-block;
    }
    
    .tag-picker-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px dashed var(--border-secondary);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tag-picker-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      border-style: solid;
    }
    
    .tag-picker-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .tag-picker-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 6px;
      min-width: 120px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      z-index: 100;
      display: none;
    }
    
    .tag-picker-dropdown.show {
      display: block;
    }
    
    .tag-picker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .tag-picker-option:hover {
      background: var(--bg-option-card);
    }
    
    .tag-picker-option.selected {
      background: var(--accent-glow);
    }
    
    /* Star Button in List View */
    .offer-star-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .offer-star-btn:hover {
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
    }
    
    .offer-star-btn.active {
      color: #fbbf24;
    }
    
    .offer-star-btn.active svg {
      fill: #fbbf24;
    }
    
    /* Archive Button */
    .offer-action-btn.archive {
      color: #8b5cf6;
    }
    
    .offer-action-btn.archive:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: #8b5cf6;
    }
    
    /* Stale Indicator on List View */
    .stale-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border-radius: 6px;
      margin-left: 8px;
    }
    
    .stale-indicator svg {
      width: 12px;
      height: 12px;
    }
    
    /* Activity Timeline */
    .activity-timeline {
      padding: 12px 0;
      border-top: 1px solid var(--border-secondary);
      margin-top: 8px;
    }
    
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      position: relative;
    }
    
    .timeline-item:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 28px;
      bottom: -8px;
      width: 2px;
      background: var(--border-secondary);
    }
    
    .timeline-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--bg-toggle);
      border: 2px solid var(--border-secondary);
    }
    
    .timeline-dot svg {
      width: 12px;
      height: 12px;
    }
    
    .timeline-dot.created { border-color: var(--text-muted); color: var(--text-muted); }
    .timeline-dot.sent { border-color: #8b5cf6; color: #8b5cf6; }
    .timeline-dot.viewed { border-color: #06b6d4; color: #06b6d4; }
    .timeline-dot.accepted { border-color: #10b981; color: #10b981; background: rgba(16, 185, 129, 0.15); }
    .timeline-dot.declined { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.15); }
    
    .timeline-content {
      flex: 1;
    }
    
    .timeline-event {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .timeline-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    /* Volume Chart */
    .volume-chart-container {
      border-radius: 14px;
      padding: 16px 0;
      margin-bottom: 16px;
    }
    
    .volume-chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .volume-chart-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    
    .volume-chart-period {
      display: flex;
      gap: 4px;
    }
    
    .volume-chart-period button {
      padding: 4px 10px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .volume-chart-period button:hover {
      color: var(--text-primary);
    }
    
    .volume-chart-period button.active {
      background: var(--accent);
      color: #fff;
    }
    
    .volume-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 6px;
      height: 80px;
      padding-top: 20px;
    }
    
    .volume-bar-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .volume-bar {
      width: 100%;
      max-width: 40px;
      background: var(--accent);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
      position: relative;
    }
    
    .volume-bar:hover {
      filter: brightness(1.2);
    }
    
    .volume-bar-label {
      font-size: 9px;
      color: var(--text-muted);
      font-weight: 600;
    }
    
    .volume-bar-value {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .volume-bar-wrap:hover .volume-bar-value {
      color: var(--accent);
    }
    
    /* Enhanced Stats Row */
    .enhanced-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    @media (max-width: 700px) {
      .enhanced-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 500px) {
      .enhanced-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .enhanced-stat {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 10px 8px;
      text-align: center;
    }
    
    .enhanced-stat-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
    }
    
    .enhanced-stat-label {
      font-size: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* Funded status */
    .offer-status-badge.funded {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.5);
      box-shadow: 0 0 16px rgba(16, 185, 129, 0.3);
    }
    
    .metric-card.funded::before { background: linear-gradient(90deg, #10b981, #06b6d4); }
    .metric-card.funded .metric-value { color: #10b981; }
    
    /* Search Bar */
    .dashboard-search-wrap {
      position: relative;
      margin-bottom: 16px;
    }
    
    .dashboard-search-wrap input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border-radius: 12px;
      border: 1px solid var(--border-primary);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .dashboard-search-wrap input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow), 0 0 16px rgba(var(--accent-rgb), 0.15);
    }
    
    .dashboard-search-wrap input::placeholder {
      color: var(--text-muted);
    }
    
    .dashboard-search-wrap svg {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      width: 18px;
      height: 18px;
      transition: color 0.2s;
    }
    
    .dashboard-search-wrap input:focus + svg,
    .dashboard-search-wrap:focus-within svg {
      color: var(--accent);
    }
    
    /* Offer List */
    .offer-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* Offer Card */
    .offer-card {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      padding: 16px 18px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .offer-card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 28px rgba(var(--accent-rgb), 0.12), 0 8px 24px -8px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }
    
    .offer-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .offer-card-title {
      flex: 1;
      min-width: 0;
    }
    
    .offer-card-title h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .offer-card-title .iso-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      background: var(--accent-glow);
      color: var(--accent);
      border-radius: 20px;
      border: 1px solid rgba(var(--accent-rgb), 0.3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .offer-card-title .lender-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      background: rgba(99, 102, 241, 0.15);
      color: #818cf8;
      border-radius: 20px;
      border: 1px solid rgba(99, 102, 241, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .offer-card-title .sub-info {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    /* Status Badge */
    .offer-status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .offer-status-badge.accepted {
      background: rgba(52, 211, 153, 0.15);
      color: #34d399;
      border: 1px solid rgba(52, 211, 153, 0.4);
      box-shadow: 0 0 12px rgba(52, 211, 153, 0.25);
    }
    
    .offer-status-badge.declined {
      background: rgba(248, 113, 113, 0.15);
      color: #f87171;
      border: 1px solid rgba(248, 113, 113, 0.4);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.25);
    }
    
    .offer-status-badge.viewed {
      background: rgba(34, 211, 238, 0.15);
      color: #22d3ee;
      border: 1px solid rgba(34, 211, 238, 0.4);
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.25);
    }
    
    .offer-status-badge.sent {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.4);
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.25);
    }
    
    .offer-status-badge.locked {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.4);
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.25);
    }
    
    .offer-status-badge.draft {
      background: var(--bg-toggle);
      color: var(--text-muted);
      border: 1px solid var(--border-primary);
    }
    
    .offer-status-badge.client-shared {
      background: rgba(6, 182, 212, 0.15);
      color: #06b6d4;
      border: 1px solid rgba(6, 182, 212, 0.4);
      box-shadow: 0 0 12px rgba(6, 182, 212, 0.25);
    }
    
    .offer-status-badge.client-viewed {
      background: rgba(34, 211, 238, 0.15);
      color: #22d3ee;
      border: 1px solid rgba(34, 211, 238, 0.4);
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.25);
    }
    
    .offer-status-badge.iso-shared {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.4);
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.25);
    }
    
    .offer-status-badge.iso-viewed {
      background: rgba(99, 102, 241, 0.15);
      color: #6366f1;
      border: 1px solid rgba(99, 102, 241, 0.4);
      box-shadow: 0 0 12px rgba(99, 102, 241, 0.25);
    }
    
    /* Stats Row */
    .offer-stats {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .offer-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .offer-stat-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    
    .offer-stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .offer-stat-value.profit {
      color: var(--accent);
      text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.4);
    }
    
    .offer-stat-divider {
      width: 1px;
      height: 24px;
      background: var(--border-secondary);
    }
    
    /* Tracking Progress - Horizontal Pipeline */
    .offer-tracking {
      display: flex;
      align-items: flex-start;
      padding: 12px 14px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow-x: auto;
      gap: 0;
    }
    
    .tracking-stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
      min-width: 48px;
    }
    
    .tracking-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-toggle);
      border: 2px solid var(--border-secondary);
      opacity: 0.35;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      color: var(--text-muted);
    }
    
    .tracking-icon svg {
      width: 14px;
      height: 14px;
    }
    
    .tracking-label {
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: var(--text-muted);
      opacity: 0.4;
      transition: all 0.25s;
      white-space: nowrap;
      text-align: center;
      line-height: 1.2;
    }
    
    .tracking-icon.complete {
      opacity: 1;
      transform: scale(1.05);
    }
    
    .tracking-stage.complete .tracking-label {
      opacity: 1;
    }
    
    /* Stage Colors - Distinct progression palette */
    .tracking-icon.complete.locked { 
      background: rgba(251, 191, 36, 0.15); 
      border-color: #fbbf24;
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }
    .tracking-stage.complete.locked .tracking-label { color: #fbbf24; }
    
    .tracking-icon.complete.iso-share { 
      background: rgba(168, 85, 247, 0.15); 
      border-color: #a855f7;
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
      color: #a855f7;
    }
    .tracking-stage.complete.iso-share .tracking-label { color: #a855f7; }
    
    .tracking-icon.complete.iso-view { 
      background: rgba(99, 102, 241, 0.15); 
      border-color: #6366f1;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
      color: #6366f1;
    }
    .tracking-stage.complete.iso-view .tracking-label { color: #6366f1; }
    
    .tracking-icon.complete.client-share { 
      background: rgba(6, 182, 212, 0.15); 
      border-color: #06b6d4;
      box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
      color: #06b6d4;
    }
    .tracking-stage.complete.client-share .tracking-label { color: #06b6d4; }
    
    .tracking-icon.complete.client-view { 
      background: rgba(34, 211, 238, 0.15); 
      border-color: #22d3ee;
      box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
      color: #22d3ee;
    }
    .tracking-stage.complete.client-view .tracking-label { color: #22d3ee; }
    
    .tracking-icon.complete.rejected { 
      background: rgba(248, 113, 113, 0.15); 
      border-color: #f87171;
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.3);
      color: #f87171;
    }
    .tracking-stage.complete.rejected .tracking-label { color: #f87171; }
    
    .tracking-icon.complete.accepted { 
      background: rgba(52, 211, 153, 0.15); 
      border-color: #34d399;
      box-shadow: 0 0 10px rgba(52, 211, 153, 0.3);
      color: #34d399;
    }
    .tracking-stage.complete.accepted .tracking-label { color: #34d399; }
    
    .tracking-line {
      flex: 1;
      height: 2px;
      min-width: 12px;
      max-width: 28px;
      background: var(--border-secondary);
      border-radius: 2px;
    }
    
    /* Detailed Tracking View */
    .tracking-detailed {
      display: none;
      flex-direction: column;
      gap: 0;
      padding: 16px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      margin-top: 8px;
    }
    
    .tracking-detailed.show {
      display: flex;
    }
    
    .tracking-detail-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 0;
      position: relative;
    }
    
    .tracking-detail-row:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 17px;
      top: 42px;
      bottom: -10px;
      width: 2px;
      background: var(--border-secondary);
    }
    
    .tracking-detail-row.complete:not(:last-child)::after {
      background: linear-gradient(to bottom, currentColor 0%, var(--border-secondary) 100%);
    }
    
    .tracking-detail-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-toggle);
      border: 2px solid var(--border-secondary);
      flex-shrink: 0;
      opacity: 0.4;
      color: var(--text-muted);
      z-index: 1;
    }
    
    .tracking-detail-icon svg {
      width: 16px;
      height: 16px;
    }
    
    .tracking-detail-row.complete .tracking-detail-icon {
      opacity: 1;
    }
    
    .tracking-detail-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .tracking-detail-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      opacity: 0.5;
    }
    
    .tracking-detail-row.complete .tracking-detail-label {
      opacity: 1;
    }
    
    .tracking-detail-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .tracking-detail-status {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-toggle);
      color: var(--text-muted);
    }
    
    .tracking-detail-row.complete .tracking-detail-status {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }
    
    .tracking-detail-row.pending .tracking-detail-status {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }
    
    /* Detail row colors when complete */
    .tracking-detail-row.complete.locked .tracking-detail-icon {
      background: rgba(251, 191, 36, 0.15);
      border-color: #fbbf24;
      color: #fbbf24;
    }
    .tracking-detail-row.complete.locked { color: #fbbf24; }
    
    .tracking-detail-row.complete.iso-share .tracking-detail-icon {
      background: rgba(168, 85, 247, 0.15);
      border-color: #a855f7;
      color: #a855f7;
    }
    .tracking-detail-row.complete.iso-share { color: #a855f7; }
    
    .tracking-detail-row.complete.iso-view .tracking-detail-icon {
      background: rgba(99, 102, 241, 0.15);
      border-color: #6366f1;
      color: #6366f1;
    }
    .tracking-detail-row.complete.iso-view { color: #6366f1; }
    
    .tracking-detail-row.complete.client-share .tracking-detail-icon {
      background: rgba(6, 182, 212, 0.15);
      border-color: #06b6d4;
      color: #06b6d4;
    }
    .tracking-detail-row.complete.client-share { color: #06b6d4; }
    
    .tracking-detail-row.complete.client-view .tracking-detail-icon {
      background: rgba(34, 211, 238, 0.15);
      border-color: #22d3ee;
      color: #22d3ee;
    }
    .tracking-detail-row.complete.client-view { color: #22d3ee; }
    
    .tracking-detail-row.complete.rejected .tracking-detail-icon {
      background: rgba(248, 113, 113, 0.15);
      border-color: #f87171;
      color: #f87171;
    }
    .tracking-detail-row.complete.rejected { color: #f87171; }
    
    .tracking-detail-row.complete.accepted .tracking-detail-icon {
      background: rgba(52, 211, 153, 0.15);
      border-color: #34d399;
      color: #34d399;
    }
    .tracking-detail-row.complete.accepted { color: #34d399; }
    
    /* Toggle button for details */
    .tracking-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      margin-top: 8px;
      background: transparent;
      border: 1px solid var(--border-secondary);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tracking-toggle:hover {
      background: var(--bg-toggle);
      color: var(--text-primary);
    }
    
    .tracking-toggle svg {
      width: 12px;
      height: 12px;
      transition: transform 0.2s;
    }
    
    .tracking-toggle.expanded svg {
      transform: rotate(180deg);
    }
    
    .tracking-line.complete {
      height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      box-shadow: 0 0 8px rgba(var(--accent-rgb), 0.5);
    }
    
    /* Offer Actions */
    .offer-actions {
      display: flex;
      gap: 6px;
    }
    
    .offer-action-btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .offer-action-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .offer-action-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.2);
    }
    
    .offer-action-btn.delete:hover {
      border-color: #ef4444;
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.2);
    }
    
    /* Empty State */
    .dashboard-empty {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }
    
    .dashboard-empty svg {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      opacity: 0.3;
      color: var(--accent);
    }
    
    .dashboard-empty h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0 0 8px 0;
    }
    
    .dashboard-empty p {
      font-size: 13px;
      margin: 0;
    }
    
    .clear-all-btn {
      cursor: pointer;
      border: none;
      background: transparent;
    }
    
    .clear-all-btn:hover {
      color: #ef4444 !important;
      background: rgba(239, 68, 68, 0.1);
    }

    /* Rainbow mode: Allow ONLY color transitions, kill everything else */
    html.rainbow-mode *,
    html.rainbow-mode *::before,
    html.rainbow-mode *::after {
      transition: color 0.8s ease, background-color 0.8s ease, border-color 0.8s ease, box-shadow 0.8s ease, fill 0.8s ease, stroke 0.8s ease !important;
    }

    /* ============================================
       SIDEBAR NAVIGATION (ADDED)
       ============================================ */
    /* TOP NAVIGATION WITH DROPDOWNS */
    /* UNIFIED NAV BAR */
    .unified-nav {
      display: none; /* Moved to header - Calculators/Reports now in top bar */
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 6px;
      background: var(--bg-card-inner);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      margin: 0 auto 12px;
    }
    .nav-tab {
      position: relative;
      padding: 8px 14px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .nav-tab:hover {
      background: var(--bg-toggle);
      color: var(--text-secondary);
    }
    .nav-tab.active {
      background: var(--accent);
      color: #000;
    }
    .nav-divider-v {
      width: 1px;
      height: 20px;
      background: var(--border-secondary);
      margin: 0 4px;
    }
    .nav-dropdown {
      position: relative;
    }
    .nav-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-dropdown-btn:hover {
      background: var(--bg-toggle);
      color: var(--text-secondary);
    }
    .nav-dropdown-btn.active {
      background: var(--accent);
      color: #000;
    }
    .nav-dropdown-btn svg {
      width: 12px;
      height: 12px;
    }
    .nav-dropdown-btn .chevron {
      width: 10px;
      height: 10px;
      transition: transform 0.2s;
    }
    .nav-dropdown.open .nav-dropdown-btn .chevron {
      transform: rotate(180deg);
    }
    .nav-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      min-width: 180px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 6px;
      margin-top: 6px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 100;
    }
    .nav-dropdown.open .nav-dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%;
      text-align: left;
    }
    .nav-item:hover {
      background: var(--bg-toggle);
      color: var(--text-primary);
    }
    .nav-item.active {
      background: var(--accent-glow);
      color: var(--accent);
    }
    .nav-item svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .nav-item-label {
      flex: 1;
    }
    .nav-menu-divider {
      height: 1px;
      background: var(--border-secondary);
      margin: 4px 0;
    }
    
    /* Header Dropdown Menus (for Calculators/Reports in header) */
    .header-dropdown {
      position: relative;
    }
    .header-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 200px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 6px;
      margin-top: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s;
      z-index: 1000;
    }
    .header-dropdown.open .header-dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .header-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%;
      text-align: left;
    }
    .header-dropdown-item:hover {
      background: var(--bg-toggle);
      color: var(--text-primary);
    }
    .header-dropdown-item.active {
      background: var(--accent-glow);
      color: var(--accent);
    }
    .header-dropdown-item svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    /* App Layout */
    .app-layout {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      overflow-x: hidden;
    }
    
    /* Sidebar Card Container */
    .sidebar-card {
      position: fixed;
      top: 16px;
      left: 16px;
      bottom: 16px;
      width: 220px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 20px;
      z-index: 50;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    /* Sidebar Brand */
    .sidebar-brand-floating {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 14px 12px;
      border-bottom: 1px solid var(--border-primary);
      flex-shrink: 0;
    }
    .sidebar-brand-floating h1 {
      font-size: 16px;
      font-weight: 800;
      line-height: 1;
    }
    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px 10px;
      gap: 1px;
    }
    
    /* Hide Top Navigation */
    .top-nav {
      display: none !important;
    }
    .top-nav-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 16px;
      position: relative;
      gap: 24px;
    }
    .top-nav-left, .top-nav-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .top-nav-brand {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .top-nav-brand h1 {
      font-size: 16px;
      font-weight: 800;
    }
    .top-nav-brand svg {
      width: 36px;
      height: 36px;
    }
    .top-nav-settings {
      width: 36px;
      height: 36px;
      min-width: 36px;
      flex-shrink: 0;
      border-radius: 50%;
      border: 1px solid var(--border-primary);
      background: transparent;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
    }
    .top-nav-settings:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .top-nav-settings svg {
      width: 18px;
      height: 18px;
    }
    
    /* Mega Menu Navigation */
    .mega-menu-container {
      position: relative;
    }
    .nav-menu-btn {
      padding: 8px 12px 8px 14px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-menu-btn::after {
      content: '';
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 4px solid currentColor;
      opacity: 0.6;
      transition: transform 0.2s ease;
    }
    .nav-menu-btn:hover {
      color: var(--text-primary);
      background: var(--bg-toggle);
    }
    .nav-menu-btn:hover::after {
      opacity: 1;
    }
    .nav-menu-btn.active {
      color: var(--text-primary);
      background: var(--bg-toggle);
    }
    .nav-menu-btn.active::after {
      transform: rotate(180deg);
      opacity: 1;
    }
    
    /* Mega Menu Panel */
    .mega-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 150;
      display: none;
    }
    .mega-menu-overlay.open {
      display: block;
    }
    
    .mega-menu-panel {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      padding: 20px;
      min-width: 480px;
      max-width: 600px;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .mega-menu-panel.open {
      opacity: 1;
      visibility: visible;
    }
    
    .mega-menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
    }
    .mega-menu-grid.single-col {
      grid-template-columns: 1fr;
    }
    
    .mega-menu-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 14px;
      border: none;
      background: transparent;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
    }
    .mega-menu-item:hover {
      background: var(--bg-toggle);
    }
    .mega-menu-item.active {
      background: var(--accent-glow);
    }
    .mega-menu-item.active .mega-menu-icon {
      color: var(--accent);
    }
    .mega-menu-item.active .mega-menu-title {
      color: var(--accent);
    }
    
    .mega-menu-icon {
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .mega-menu-content {
      flex: 1;
      min-width: 0;
    }
    .mega-menu-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .mega-menu-desc {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    
    @media (max-width: 600px) {
      .mega-menu-panel {
        min-width: calc(100vw - 32px);
        max-width: calc(100vw - 32px);
        left: 16px;
        right: 16px;
        transform: none;
      }
      .mega-menu-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (min-width: 769px) {
      .top-nav-tabs {
        padding: 0 24px 14px;
        gap: 6px;
      }
      .nav-menu-btn {
        padding: 9px 14px 9px 16px;
        font-size: 14px;
      }
      .mega-menu-panel {
        min-width: 520px;
        padding: 24px;
      }
      .mega-menu-title {
        font-size: 14px;
      }
      .mega-menu-desc {
        font-size: 12px;
      }
    }
    
    /* Planet logo animation - elliptical orbit */
    @keyframes satelliteOrbit {
      0%   { transform: translate(26px, 0px); }
      12.5% { transform: translate(18.4px, 5.7px); }
      25%  { transform: translate(0px, 8px); }
      37.5% { transform: translate(-18.4px, 5.7px); }
      50%  { transform: translate(-26px, 0px); }
      62.5% { transform: translate(-18.4px, -5.7px); }
      75%  { transform: translate(0px, -8px); }
      87.5% { transform: translate(18.4px, -5.7px); }
      100% { transform: translate(26px, 0px); }
    }
    .satellite-spin {
      animation: satelliteOrbit 5s linear infinite;
    }
    
    /* Main Content */
    /* Page Layout - Sidebar + Main Content side by side */
    .main-content-wrapper {
      flex: 1;
      margin-left: 252px;
      padding: 16px 16px 16px 0;
      min-height: calc(100vh - 32px);
      margin-top: 0;
    }
    .main-content-area {
      width: 100%;
      padding: 0;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    @media (min-width: 769px) {
      .main-content-wrapper {
        padding-top: 16px;
      }
      .main-content-area {
        padding: 0;
      }
    }
    
    @media (max-width: 900px) {
      .main-content-wrapper {
        margin-left: 0 !important;
        padding-top: 16px;
      }
    }
    
    /* Hide mobile brand on all screen sizes - sidebar-card has brand now */
    .sidebar-mobile-brand {
      display: none;
    }
    
    body.sidebar-mobile-open {
      overflow: hidden;
    }
    
    body.mobile-mega-open {
      overflow: hidden;
    }
    
    /* Mobile Menu Toggle Button - hidden on desktop */
    .mobile-menu-toggle {
      display: none;
    }
    
    /* Mobile Sidebar Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .sidebar-overlay.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Mobile Mega Menu - hidden on desktop */
    .mobile-mega-menu {
      display: none;
    }
    
    
    /* Sidebar Toggle Button */
    /* Sidebar Section Title */
    .sidebar-section-title {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      padding: 8px 10px 4px 10px;
      margin-top: 2px;
    }
    .sidebar-section-title:first-child {
      margin-top: 0;
      padding-top: 0;
    }
    
    /* Sidebar Nav Button */
    .sidebar-nav-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
      width: 100%;
    }
    .sidebar-nav-btn:hover { 
      color: var(--text-primary); 
      background: var(--bg-toggle);
    }
    .sidebar-nav-btn.active { 
      color: var(--accent); 
      background: var(--accent-glow);
    }
    .sidebar-nav-btn svg { 
      width: 14px; 
      height: 14px;
      flex-shrink: 0;
      opacity: 0.7;
    }
    .sidebar-nav-btn:hover svg,
    .sidebar-nav-btn.active svg {
      opacity: 1;
    }
    .sidebar-nav-btn span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Sidebar Divider */
    .sidebar-nav-divider {
      height: 1px;
      background: var(--border-primary);
      margin: 4px 10px;
    }
    
    /* Sidebar Bottom Section */
    .sidebar-bottom {
      margin-top: auto;
      padding: 8px 0 0 0;
      border-top: 1px solid var(--border-primary);
    }
    
    
    
    /* Mobile Settings Sheet */
    .mobile-settings-sheet {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 100;
    }
    .mobile-settings-sheet.open {
      display: block;
    }
    .mobile-settings-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
    }
    .mobile-settings-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    .mobile-settings-sheet.open .mobile-settings-content {
      transform: translateY(0);
    }
    .mobile-settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-secondary);
    }
    .mobile-settings-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .mobile-settings-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-toggle);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .mobile-settings-section {
      margin-bottom: 20px;
    }
    .mobile-settings-section-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .mobile-settings-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .mobile-theme-btn {
      padding: 12px 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-toggle);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .mobile-theme-btn:hover,
    .mobile-theme-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }
    .mobile-accent-btn {
      width: 100%;
      height: 40px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .mobile-accent-btn.active {
      border-color: white;
      box-shadow: 0 0 0 2px var(--accent);
    }
    
    /* Hide old mobile nav */
    .mobile-nav {
      display: none !important;
    }
    
    .tool-section { 
      display: none; 
      width: 100%;
    }
    .tool-section.active { 
      display: block;
      width: 100%;
      animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Calculator Result Card - Phone Preview Style */
    .calc-result-preview {
      background: var(--bg-card);
      border-radius: 28px;
      border: 4px solid var(--accent);
      width: 100%;
      min-height: calc(100vh - 100px);
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.25),
        0 0 80px rgba(var(--accent-rgb), 0.1),
        0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .calc-result-preview:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 0 60px rgba(var(--accent-rgb), 0.35),
        0 0 100px rgba(var(--accent-rgb), 0.15),
        0 30px 60px -12px rgba(0, 0, 0, 0.3);
    }
    
    /* Calculator Card Share Button */
    .calc-card-share-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 10;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
    }
    .calc-card-share-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      transform: scale(1.1);
    }
    .calc-card-share-btn svg {
      width: 16px;
      height: 16px;
    }
    
    .calc-preview-header {
      background: var(--preview-header-bg);
      padding: 36px 32px;
      text-align: center;
      position: relative;
    }
    .calc-preview-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 30% 20%, rgba(var(--accent-rgb), 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(var(--accent-rgb), 0.05) 0%, transparent 40%);
      pointer-events: none;
    }
    .calc-preview-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .calc-preview-amount {
      font-size: clamp(2rem, 6vw, 2.75rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .calc-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      background: var(--bg-option-card);
    }
    .calc-stat-cell {
      padding: 24px 20px;
      text-align: center;
      border-bottom: 1px solid var(--border-secondary);
    }
    .calc-stat-cell:nth-child(odd) {
      border-right: 1px solid var(--border-secondary);
    }
    .calc-stat-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }
    .calc-stat-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
    }
    .calc-stat-value.accent {
      color: var(--accent);
    }
    .calc-payment-display {
      padding: 36px 32px;
      text-align: center;
      background: var(--bg-card);
    }
    .calc-payment-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .calc-payment-amount {
      font-size: 2.25rem;
      font-weight: 800;
      color: var(--text-primary);
    }
    .calc-donut-section {
      padding: 28px 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 24px;
      background: var(--bg-card);
      border-top: 1px solid var(--border-secondary);
    }
    .calc-preview-actions {
      display: none; /* Removed - using header Preview button instead */
      padding: 16px 20px;
      gap: 10px;
      background: var(--bg-option-card);
      border-top: 1px solid var(--border-secondary);
      border-radius: 0 0 20px 20px;
    }
    .calc-action-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-primary);
      background: var(--bg-card);
      color: var(--text-secondary);
    }
    .calc-action-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .calc-action-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .calc-action-btn.primary:hover {
      filter: brightness(1.1);
    }
    .calc-action-btn svg {
      width: 16px;
      height: 16px;
    }
    
    /* Document Info Button */
    .doc-info-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .doc-info-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .doc-item {
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 8px;
      transition: background 0.2s;
    }
    .doc-item:hover {
      background: var(--bg-tertiary);
    }
    
    /* Document Info Modal */
    .doc-info-modal {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .doc-info-modal.active {
      opacity: 1;
      visibility: visible;
    }
    .doc-info-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }
    .doc-info-content {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
      max-width: 400px;
      width: calc(100% - 32px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      transform: scale(0.95) translateY(10px);
      transition: transform 0.3s;
    }
    .doc-info-modal.active .doc-info-content {
      transform: scale(1) translateY(0);
    }
    .doc-info-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .doc-info-header h4 {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
      line-height: 1.3;
    }
    .doc-info-close {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      color: var(--text-muted);
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .doc-info-close:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .doc-info-content p {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    .doc-acceptable-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-top: 16px;
      margin-bottom: 8px;
    }
    .doc-acceptable-list {
      margin: 0;
      padding-left: 16px;
      list-style: disc;
    }
    .doc-acceptable-list li {
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .doc-acceptable-list li::marker {
      color: var(--accent);
    }
    
    /* Client mode - minimal UI for shared links */
    body.client-mode .sidebar { display: none !important; }
    body.client-mode .sidebar-nav { display: none !important; }
    body.client-mode .unified-nav { display: none !important; }
    body.client-mode .mode-toggle { display: none !important; }
    body.client-mode .header-actions { display: none !important; }
    body.client-mode .floating-preview { display: none !important; }
    body.client-mode .calc-preview-actions { display: none !important; }
    body.client-mode .app-layout { margin-left: 0 !important; padding-bottom: 0 !important; }
    body.client-mode .main-content { max-width: 900px; margin: 0 auto; }
    body.client-mode .header-brand { justify-content: center; }
    
    /* Toast notifications */
    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes slideDown {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }

    @media (max-width: 900px) {
      /* Hide sidebar card on mobile/tablet */
      .sidebar-card {
        display: none !important;
      }
      
      /* Floating menu button */
      .mobile-menu-toggle {
        display: flex !important;
        position: fixed !important;
        bottom: 24px !important;
        right: 24px !important;
        width: 56px !important;
        height: 56px !important;
        border-radius: 50% !important;
        background: var(--accent) !important;
        color: #000 !important;
        border: none !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4) !important;
        z-index: 1001 !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer !important;
        transition: transform 0.3s ease, box-shadow 0.2s ease !important;
      }
      
      .mobile-menu-toggle:hover {
        box-shadow: 0 6px 24px rgba(0,0,0,0.5) !important;
      }
      
      .mobile-menu-toggle svg {
        width: 24px !important;
        height: 24px !important;
        transition: transform 0.3s ease !important;
      }
      
      body.mobile-mega-open .mobile-menu-toggle {
        transform: rotate(45deg) !important;
      }
      
      /* Mobile Mega Menu */
      .mobile-mega-menu {
        display: none;
        position: fixed;
        bottom: 96px;
        right: 24px;
        width: calc(100vw - 48px);
        max-width: 400px;
        max-height: 70vh;
        background: var(--bg-card);
        border: 1px solid var(--border-primary);
        border-radius: 20px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.5);
        z-index: 1000;
        overflow: hidden;
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        transform-origin: bottom right;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }
      
      .mobile-mega-menu.open {
        display: block;
        transform: scale(1) translateY(0);
        opacity: 1;
      }
      
      .mobile-mega-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-primary);
        background: var(--bg-body);
      }
      
      .mobile-mega-header h2 {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
      }
      
      .mobile-mega-content {
        padding: 16px;
        overflow-y: auto;
        max-height: calc(70vh - 60px);
      }
      
      .mobile-mega-section {
        margin-bottom: 16px;
      }
      
      .mobile-mega-section:last-child {
        margin-bottom: 0;
      }
      
      .mobile-mega-section-title {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        padding: 0 4px 8px;
      }
      
      .mobile-mega-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      
      .mobile-mega-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 14px 8px;
        background: var(--bg-body);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        color: var(--text-secondary);
        font-size: 10px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      
      .mobile-mega-btn:hover {
        background: rgba(var(--accent-rgb), 0.1);
        border-color: var(--accent);
        color: var(--text-primary);
      }
      
      .mobile-mega-btn.active {
        background: rgba(var(--accent-rgb), 0.15);
        border-color: var(--accent);
        color: var(--accent);
      }
      
      .mobile-mega-btn svg {
        width: 20px;
        height: 20px;
        opacity: 0.7;
      }
      
      .mobile-mega-btn.active svg {
        opacity: 1;
      }
      
      /* Overlay */
      .sidebar-overlay.active {
        opacity: 1 !important;
        pointer-events: auto !important;
      }
      
      /* Fixed header at top */
      .header-main {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 100 !important;
        padding: 8px 12px !important;
        margin-bottom: 0 !important;
        border-bottom: 1px solid var(--border-primary);
      }
      
      .header-brand h1 {
        font-size: 14px !important;
      }
      
      /* App layout adjustments */
      .app-layout {
        flex-direction: column !important;
        padding-top: 52px !important;
        padding-bottom: 16px !important;
      }
      
      .main-content-area {
        padding: 12px !important;
        margin-left: 0 !important;
        margin-top: 0 !important;
      }
      
      /* Mobile calculator adjustments */
      .calc-result-preview {
        border-radius: 20px;
        border-width: 3px;
        min-height: auto;
      }
      .calc-preview-header {
        padding: 24px 16px;
      }
      .calc-preview-amount {
        font-size: 1.8rem;
      }
      .calc-stat-cell {
        padding: 12px 10px;
      }
      .calc-stat-value {
        font-size: 14px;
      }
      .calc-payment-display {
        padding: 20px 16px;
      }
      .calc-payment-amount {
        font-size: 1.5rem;
      }
      
      /* Tool sections full width */
      .tool-section {
        width: 100% !important;
      }
      
      /* Offer controls mobile */
      .offer-controls-grid {
        grid-template-columns: 1fr !important;
      }
      
      /* Stats grid mobile */
      .calc-stats-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
    
    @media (max-width: 480px) {
      .header-main {
        padding: 6px 8px !important;
      }
      
      .header-brand h1 {
        font-size: 12px !important;
      }
      
      .mobile-menu-toggle {
        bottom: 16px !important;
        right: 16px !important;
        width: 52px !important;
        height: 52px !important;
      }
      
      .mobile-mega-menu {
        bottom: 84px !important;
        right: 16px !important;
        width: calc(100vw - 32px) !important;
        max-height: 65vh !important;
      }
      
      .mobile-mega-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 6px !important;
      }
      
      .mobile-mega-btn {
        padding: 12px 6px !important;
        font-size: 9px !important;
      }
      
      .mobile-mega-btn svg {
        width: 18px !important;
        height: 18px !important;
      }
      
      .main-content-area {
        padding: 8px !important;
      }
      
      .app-layout {
        padding-top: 44px !important;
        padding-bottom: 12px !important;
      }
      
      .calc-preview-amount {
        font-size: 1.5rem;
      }
      
      .calc-payment-amount {
        font-size: 1.25rem;
      }
    }

    /* Loan Calculator Styles */
    .loan-product-tabs {
      display: none; /* Hidden - using sidebar now */
    }
    
    /* Select dropdown styling */
    .calc-select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    
    .calc-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    /* Chart container */
    .calc-chart-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px;
      margin-top: 16px;
      background: var(--bg-option-card);
      border-radius: 16px;
      border: 1px solid var(--border-secondary);
    }
    
    .calc-chart {
      width: 160px;
      height: 160px;
      position: relative;
    }
    
    .calc-chart-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .calc-chart-pct {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
    }
    
    .calc-chart-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    
    .calc-chart-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 16px;
    }
    
    .calc-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
    }
    
    .calc-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    /* ABLESCORE Grid */
    .perrepus-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .perrepus-item {
      background: var(--bg-option-card);
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .perrepus-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .perrepus-letter {
      width: 28px;
      height: 28px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 800;
      color: var(--accent);
    }
    
    .perrepus-name {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      flex: 1;
    }
    
    .perrepus-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* Grade display */
    .calc-grade-display {
      text-align: center;
      padding: 32px;
    }
    
    .calc-grade {
      font-size: 72px;
      font-weight: 900;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 8px;
    }
    
    .calc-grade-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    
    /* Recommendation box */
    .calc-recommendation {
      margin-top: 16px;
      padding: 16px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 12px;
    }
    
    .calc-recommendation p {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
      margin: 0;
      text-align: center;
    }
    
    @media (max-width: 1024px) {
      .calc-tool-section {
        grid-template-columns: 1fr;
        gap: 24px;
      }
      
      .calc-result-column {
        position: relative;
        top: 0;
      }
      
      .perrepus-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 900px) {
      .calc-card {
        padding: 20px;
        border-radius: 16px;
      }
      
      .calc-slider-value {
        font-size: 24px;
      }
      
      .calc-result-value {
        font-size: 20px;
      }
      
      .calc-grade {
        font-size: 56px;
      }
      
      .calc-chart {
        width: 140px;
        height: 140px;
      }
    }
    
    /* Legacy styles - keeping for compatibility */
    .loan-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border-primary);
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="main-header">
    <svg viewBox='0 0 70 70' xmlns='http://www.w3.org/2000/svg'>
      <circle cx='32' cy='32' r='24' stroke='#10b981' stroke-width='6' fill='none'/>
      <line x1='8' y1='56' x2='56' y2='8' stroke='#34d399' stroke-width='5' stroke-linecap='round'/>
      <circle cx='56' cy='8' r='4' fill='#34d399'/>
      <circle cx='8' cy='56' r='3' fill='#10b981'/>
      <g class='orbit-path' style='transform:rotate(45deg);transform-origin:32px 32px'>
        <circle class='moon-color' cx='64' cy='32' r='2'/>
      </g>
    </svg>
    <h1>Offer Builder</h1>
    <button class="settings-btn" onclick="openSettings()" title="Settings">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m-9-5h6m6 0h6m-2.636-6.364l-4.243 4.243m0 0l-4.242 4.242m12.728 0l-4.242-4.242m0 0l-4.243-4.243"></path>
      </svg>
    </button>
  </header>

  <!-- SVG GRADIENT DEFINITION -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" class="gradient-start" style="stop-color:var(--accent)"/>
        <stop offset="100%" class="gradient-end" style="stop-color:var(--accent-light)"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- WELCOME SCREEN -->
  <!-- DASHBOARD MODAL -->
  <div id="dashboardModal" class="dashboard-modal hidden">
    <div class="dashboard-backdrop" onclick="closeDashboard()"></div>
    <div class="dashboard-content">
      <div class="dashboard-header">
        <div class="dashboard-title">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
            <path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h2>Offer Pipeline</h2>
        </div>
        <div class="header-actions">
          <button type="button" id="clearAllBtn" class="offer-action-btn delete" style="padding: 6px 10px; font-size: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Clear
          </button>
          <button onclick="closeDashboard()" class="offer-action-btn" style="padding: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <div class="dashboard-body">
        <!-- Enhanced Stats Row -->
        <div id="enhancedStats" class="enhanced-stats">
          <!-- Populated by JS -->
        </div>
        
        <!-- Volume Chart -->
        <div id="volumeChartContainer" class="volume-chart-container">
          <div class="volume-chart-header">
            <span class="volume-chart-title">Offer Volume</span>
            <div class="volume-chart-period">
              <button onclick="setChartPeriod('week')" class="active">Week</button>
              <button onclick="setChartPeriod('month')">Month</button>
            </div>
          </div>
          <div id="volumeChart" class="volume-chart">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Toolbar -->
        <div class="pipeline-toolbar">
          <div class="view-toggle">
            <button onclick="setPipelineView('list')" class="view-toggle-btn active" id="listViewBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
              List
            </button>
            <button onclick="setPipelineView('kanban')" class="view-toggle-btn" id="kanbanViewBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
              </svg>
              Kanban
            </button>
          </div>
          <div class="toolbar-actions">
            <button onclick="toggleShowArchived()" class="toolbar-btn" id="showArchivedBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
              </svg>
              Archived
            </button>
            <button onclick="toggleShowStarred()" class="toolbar-btn" id="showStarredBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
              </svg>
              Starred
            </button>
          </div>
        </div>
        
        <div class="dashboard-search-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="dashboardSearch" placeholder="Search offers..." oninput="filterDashboardOffers()">
        </div>
        
        <!-- List View Container -->
        <div id="offersTableContainer" class="offer-list">
          <!-- Offers rendered by JS -->
        </div>
        
        <!-- Kanban View Container -->
        <div id="kanbanContainer" class="kanban-board hidden">
          <div class="kanban-column" data-stage="draft">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: var(--text-muted);"></div>
                <span class="kanban-column-name">Draft</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-draft">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-draft"></div>
          </div>
          <div class="kanban-column" data-stage="sent">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: #8b5cf6;"></div>
                <span class="kanban-column-name">Sent</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-sent">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-sent"></div>
          </div>
          <div class="kanban-column" data-stage="viewed">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: #06b6d4;"></div>
                <span class="kanban-column-name">Viewed</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-viewed">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-viewed"></div>
          </div>
          <div class="kanban-column" data-stage="accepted">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: #10b981;"></div>
                <span class="kanban-column-name">Accepted</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-accepted">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-accepted"></div>
          </div>
          <div class="kanban-column" data-stage="funded">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: linear-gradient(135deg, #10b981, #06b6d4);"></div>
                <span class="kanban-column-name">Funded</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-funded">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-funded"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- APP LAYOUT WITH SIDEBAR -->
  <div class="app-layout">
    
    <!-- Mobile Floating Button -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMega()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
      </svg>
    </button>
    
    <!-- Mobile Mega Menu -->
    <div class="mobile-mega-menu" id="mobileMegaMenu">
      <div class="mobile-mega-header">
        <h2>Navigation</h2>
      </div>
      <div class="mobile-mega-content">
        <div class="mobile-mega-section">
          <div class="mobile-mega-section-title">Scoring</div>
          <div class="mobile-mega-grid">
            <button class="mobile-mega-btn" onclick="selectMobileTool('prequal')" data-tool="prequal">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span>Pre-Qual</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('perrepus')" data-tool="perrepus">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
              <span>ABLESCORE</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('offer')" data-tool="offer">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
              <span>Offer Builder</span>
            </button>
          </div>
        </div>
        
        <div class="mobile-mega-section">
          <div class="mobile-mega-section-title">Calculators</div>
          <div class="mobile-mega-grid">
            <button class="mobile-mega-btn" onclick="selectMobileTool('mca')" data-tool="mca">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/></svg>
              <span>MCA</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('working')" data-tool="working">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/></svg>
              <span>Working Cap</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('term')" data-tool="term">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>
              <span>Term</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('loc')" data-tool="loc">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z"/></svg>
              <span>LOC</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('sba')" data-tool="sba">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z"/></svg>
              <span>SBA</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('equipment')" data-tool="equipment">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"/></svg>
              <span>Equipment</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('cre')" data-tool="cre">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z"/></svg>
              <span>CRE</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('factoring')" data-tool="factoring">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 14.25l6-6m4.5-3.493V21.75l-3.75-1.5-3.75 1.5-3.75-1.5-3.75 1.5V4.757c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0c1.1.128 1.907 1.077 1.907 2.185zM9.75 9h.008v.008H9.75V9zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 4.5h.008v.008h-.008V13.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
              <span>Factoring</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('apr')" data-tool="apr">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V13.5zm0 2.25h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V18zm2.498-6.75h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V13.5zm0 2.25h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V18zm2.504-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zm0 2.25h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V18zm2.498-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zM8.25 6h7.5v2.25h-7.5V6zM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0012 2.25z"/></svg>
              <span>APR Calc</span>
            </button>
          </div>
        </div>
        
        <div class="mobile-mega-section">
          <div class="mobile-mega-section-title">Tools</div>
          <div class="mobile-mega-grid">
            <button class="mobile-mega-btn" onclick="selectMobileTool('payoff')" data-tool="payoff">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span>Payoff</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('debtschedule')" data-tool="debtschedule">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5"/></svg>
              <span>Debt Schedule</span>
            </button>
            <button class="mobile-mega-btn" onclick="selectMobileTool('araging')" data-tool="araging">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span>AR Aging</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMega()"></div>
    
    <!-- SIDEBAR CARD (Brand + Nav combined) -->
    <div class="sidebar-card" id="sidebarCard">
    
    <!-- FLOATING BRAND/LOGO -->
    <div class="sidebar-brand-floating">
      <a href="index.html" title="Back to Home">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 28px; height: 28px; overflow: visible;">
          <defs>
            <radialGradient id="planetGrad" cx="35%" cy="35%" r="60%">
              <stop offset="0%" stop-color="#fcd34d"/>
              <stop offset="50%" stop-color="#eab308"/>
              <stop offset="100%" stop-color="#ca8a04"/>
            </radialGradient>
            <filter id="planetGlow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="2" result="glow"/>
              <feMerge>
                <feMergeNode in="glow"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
            <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#ffab40"/>
              <stop offset="50%" stop-color="#ff8c00"/>
              <stop offset="100%" stop-color="#ff6d00"/>
            </linearGradient>
            <filter id="moonGlow" x="-100%" y="-100%" width="300%" height="300%">
              <feGaussianBlur stdDeviation="1.5" result="glow"/>
              <feMerge>
                <feMergeNode in="glow"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          <style>
            .moon-base { transform-origin: 32px 32px; animation: orbit 3s linear infinite, moonColor 2s ease-in-out infinite; filter: url(#moonGlow); }
            .moon-back { animation: orbit 3s linear infinite, moonColor 2s ease-in-out infinite, moonBackOpacity 3s linear infinite; }
            .moon-front { animation: orbit 3s linear infinite, moonColor 2s ease-in-out infinite, moonFrontOpacity 3s linear infinite; }
            @keyframes orbit {
              0% { transform: rotate(-20deg) translate(26px, 0) scale(1); }
              12.5% { transform: rotate(-20deg) translate(18px, 5px) scale(0.85); }
              25% { transform: rotate(-20deg) translate(0, 7px) scale(0.7); }
              37.5% { transform: rotate(-20deg) translate(-18px, 5px) scale(0.55); }
              50% { transform: rotate(-20deg) translate(-26px, 0) scale(0.5); }
              62.5% { transform: rotate(-20deg) translate(-18px, -5px) scale(0.55); }
              75% { transform: rotate(-20deg) translate(0, -7px) scale(0.7); }
              87.5% { transform: rotate(-20deg) translate(18px, -5px) scale(0.85); }
              100% { transform: rotate(-20deg) translate(26px, 0) scale(1); }
            }
            @keyframes moonBackOpacity { 0%, 15% { opacity: 0; } 25% { opacity: 1; } 75% { opacity: 1; } 85%, 100% { opacity: 0; } }
            @keyframes moonFrontOpacity { 0%, 15% { opacity: 1; } 25% { opacity: 0; } 75% { opacity: 0; } 85%, 100% { opacity: 1; } }
            @keyframes moonColor { 0%, 100% { fill: #a855f7; } 25% { fill: #3b82f6; } 50% { fill: #ec4899; } 75% { fill: #10b981; } }
          </style>
          <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" opacity="0.6"/>
          <circle class="moon-base moon-back" cx="32" cy="32" r="4" fill="#a855f7"/>
          <circle cx="32" cy="32" r="14" fill="#eab308" opacity="0.2" filter="url(#planetGlow)"/>
          <circle cx="32" cy="32" r="12" fill="url(#planetGrad)" filter="url(#planetGlow)"/>
          <ellipse cx="28" cy="28" rx="4" ry="3" fill="#fef3c7" opacity="0.4"/>
          <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
          <circle class="moon-base moon-front" cx="32" cy="32" r="4" fill="#a855f7"/>
        </svg>
      </a>
      <h1><span style="color: #ffffff;">Ables</span><span style="color: #6b7280;">AI</span></h1>
    </div>
    
    <!-- SIDEBAR NAVIGATION -->
    <nav class="sidebar-nav" id="sidebarNav">
      <!-- Mobile Brand Header -->
      <div class="sidebar-mobile-brand">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 28px; height: 28px; overflow: visible;">
          <defs>
            <radialGradient id="planetGrad2" cx="35%" cy="35%" r="60%">
              <stop offset="0%" stop-color="#fcd34d"/>
              <stop offset="50%" stop-color="#eab308"/>
              <stop offset="100%" stop-color="#ca8a04"/>
            </radialGradient>
          </defs>
          <circle cx="32" cy="32" r="12" fill="url(#planetGrad2)"/>
        </svg>
        <h1><span style="color: #ffffff;">Ables</span><span style="color: #6b7280;">AI</span></h1>
      </div>
      
      <!-- Assessment Section -->
      <div class="sidebar-section-title">Assessment</div>
      <button class="sidebar-nav-btn" onclick="switchTool('prequal')" data-tool="prequal">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
        <span>Pre-Qualification</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('perrepus')" data-tool="perrepus">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        <span>ABLESCORE</span>
      </button>
      
      <div class="sidebar-nav-divider"></div>
      
      <!-- Calculators Section -->
      <div class="sidebar-section-title">Calculators</div>
      <button class="sidebar-nav-btn" onclick="switchTool('offer')" data-tool="offer">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span>Offer Builder</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('mca')" data-tool="mca">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
        <span>MCA Calculator</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('working')" data-tool="working">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        <span>Working Capital</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('term')" data-tool="term">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <span>Term Loan</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('loc')" data-tool="loc">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
        <span>Line of Credit</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('sba')" data-tool="sba">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
        <span>SBA 7(a)</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('equipment')" data-tool="equipment">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/></svg>
        <span>Equipment</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('cre')" data-tool="cre">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
        <span>Commercial Real Estate</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('factoring')" data-tool="factoring">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        <span>Invoice Factoring</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('payoff')" data-tool="payoff">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
        <span>Payoff Calculator</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('apr')" data-tool="apr">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
        <span>APR Calculator</span>
      </button>
      
      <div class="sidebar-nav-divider"></div>
      
      <!-- Reports Section -->
      <div class="sidebar-section-title">Reports</div>
      <button class="sidebar-nav-btn" onclick="switchTool('debtschedule')" data-tool="debtschedule">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        <span>Debt Schedule</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('araging')" data-tool="araging">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span>A/R Aging</span>
      </button>
      <button class="sidebar-nav-btn" onclick="switchTool('wip')" data-tool="wip">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        <span>WIP Report</span>
      </button>
      
      <!-- Bottom Section (Settings) -->
      <div class="sidebar-bottom">
        <button class="sidebar-nav-btn" onclick="toggleThemeDropdown()" id="sidebarSettingsBtn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <span>Settings</span>
        </button>
      </div>
    </nav>
    </div><!-- END sidebar-card -->
    
    <!-- Top Navigation -->
    <nav class="top-nav" id="topNav">
      <div class="top-nav-header" id="navTabs">
        <div class="top-nav-left">
          <button class="nav-menu-btn" data-menu="prequal" onclick="toggleMegaMenu('prequal')">Pre-Qual</button>
          <button class="nav-menu-btn active" data-menu="calculators" onclick="toggleMegaMenu('calculators')">Calculators</button>
        </div>
        <div class="top-nav-brand">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 32px; height: 32px; overflow: visible;">
            <defs>
              <radialGradient id="planetGrad2" cx="35%" cy="35%" r="60%">
                <stop offset="0%" stop-color="#fcd34d"/>
                <stop offset="50%" stop-color="#eab308"/>
                <stop offset="100%" stop-color="#ca8a04"/>
              </radialGradient>
              <filter id="planetGlow2" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="2" result="glow"/>
                <feMerge>
                  <feMergeNode in="glow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
              <linearGradient id="ringGrad2" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#ffab40"/>
                <stop offset="50%" stop-color="#ff8c00"/>
                <stop offset="100%" stop-color="#ff6d00"/>
              </linearGradient>
              <filter id="moonGlow2" x="-100%" y="-100%" width="300%" height="300%">
                <feGaussianBlur stdDeviation="1.5" result="glow"/>
                <feMerge>
                  <feMergeNode in="glow"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <style>
              .moon-base2 { transform-origin: 32px 32px; animation: orbit2 3s linear infinite, moonColor2 2s ease-in-out infinite; filter: url(#moonGlow2); }
              .moon-back2 { animation: orbit2 3s linear infinite, moonColor2 2s ease-in-out infinite, moonBackOpacity2 3s linear infinite; }
              .moon-front2 { animation: orbit2 3s linear infinite, moonColor2 2s ease-in-out infinite, moonFrontOpacity2 3s linear infinite; }
              @keyframes orbit2 {
                0% { transform: rotate(-20deg) translate(26px, 0) scale(1); }
                12.5% { transform: rotate(-20deg) translate(18px, 5px) scale(0.85); }
                25% { transform: rotate(-20deg) translate(0, 7px) scale(0.7); }
                37.5% { transform: rotate(-20deg) translate(-18px, 5px) scale(0.55); }
                50% { transform: rotate(-20deg) translate(-26px, 0) scale(0.5); }
                62.5% { transform: rotate(-20deg) translate(-18px, -5px) scale(0.55); }
                75% { transform: rotate(-20deg) translate(0, -7px) scale(0.7); }
                87.5% { transform: rotate(-20deg) translate(18px, -5px) scale(0.85); }
                100% { transform: rotate(-20deg) translate(26px, 0) scale(1); }
              }
              @keyframes moonBackOpacity2 { 0%, 15% { opacity: 0; } 25% { opacity: 1; } 75% { opacity: 1; } 85%, 100% { opacity: 0; } }
              @keyframes moonFrontOpacity2 { 0%, 15% { opacity: 1; } 25% { opacity: 0; } 75% { opacity: 0; } 85%, 100% { opacity: 1; } }
              @keyframes moonColor2 { 0%, 100% { fill: #a855f7; } 25% { fill: #3b82f6; } 50% { fill: #ec4899; } 75% { fill: #10b981; } }
            </style>
            <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad2)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" opacity="0.6"/>
            <circle class="moon-base2 moon-back2" cx="32" cy="32" r="4" fill="#a855f7"/>
            <circle cx="32" cy="32" r="14" fill="#eab308" opacity="0.2" filter="url(#planetGlow2)"/>
            <circle cx="32" cy="32" r="12" fill="url(#planetGrad2)" filter="url(#planetGlow2)"/>
            <ellipse cx="28" cy="28" rx="4" ry="3" fill="#fef3c7" opacity="0.4"/>
            <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad2)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
            <circle class="moon-base2 moon-front2" cx="32" cy="32" r="4" fill="#a855f7"/>
          </svg>
          <h1><span style="color: var(--text-primary);">Ables</span><span style="color: var(--text-muted);">AI</span></h1>
        </div>
        <div class="top-nav-right">
          <button class="nav-menu-btn" data-menu="reports" onclick="toggleMegaMenu('reports')">Reports</button>
          <button class="top-nav-settings" onclick="toggleThemeDropdown()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Mega Menu Panels (outside header for proper positioning) -->
      <div class="mega-menu-container" id="navTabs">
        <div class="mega-menu-overlay" id="megaMenuOverlay" onclick="closeMegaMenu()"></div>
        
        <div class="mega-menu-panel" id="menu-prequal">
          <div class="mega-menu-grid">
            <button class="mega-menu-item" data-tool="prequal" onclick="selectMegaTool('prequal')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">PreQual Tool</div>
                <div class="mega-menu-desc">Quick pre-qualification assessment</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="perrepus" onclick="selectMegaTool('perrepus')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">ABLESCORE</div>
                <div class="mega-menu-desc">Advanced scoring model v4.1</div>
              </div>
            </button>
          </div>
        </div>
        
        <div class="mega-menu-panel" id="menu-calculators">
          <div class="mega-menu-grid">
            <button class="mega-menu-item active" data-tool="offer" onclick="selectMegaTool('offer')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Offer Builder</div>
                <div class="mega-menu-desc">Create custom funding offers</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="mca" onclick="selectMegaTool('mca')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">MCA</div>
                <div class="mega-menu-desc">Merchant cash advance calculator</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="working" onclick="selectMegaTool('working')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Working Capital</div>
                <div class="mega-menu-desc">Short-term business financing</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="term" onclick="selectMegaTool('term')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Term Loan</div>
                <div class="mega-menu-desc">Fixed-term business loans</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="loc" onclick="selectMegaTool('loc')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Line of Credit</div>
                <div class="mega-menu-desc">Revolving credit facility</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="sba" onclick="selectMegaTool('sba')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">SBA</div>
                <div class="mega-menu-desc">SBA loan programs</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="equipment" onclick="selectMegaTool('equipment')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Equipment</div>
                <div class="mega-menu-desc">Equipment financing</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="cre" onclick="selectMegaTool('cre')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">CRE</div>
                <div class="mega-menu-desc">Commercial real estate</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="factoring" onclick="selectMegaTool('factoring')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Factoring</div>
                <div class="mega-menu-desc">Invoice factoring</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="payoff" onclick="selectMegaTool('payoff')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Payoff Calculator</div>
                <div class="mega-menu-desc">Calculate payoff amounts</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="apr" onclick="selectMegaTool('apr')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">APR Calculator</div>
                <div class="mega-menu-desc">Annual percentage rate</div>
              </div>
            </button>
          </div>
        </div>
        
        <div class="mega-menu-panel" id="menu-reports">
          <div class="mega-menu-grid">
            <button class="mega-menu-item" data-tool="debtschedule" onclick="selectMegaTool('debtschedule')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">Debt Schedule</div>
                <div class="mega-menu-desc">Payment schedule breakdown</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="araging" onclick="selectMegaTool('araging')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">A/R Aging</div>
                <div class="mega-menu-desc">Accounts receivable aging</div>
              </div>
            </button>
            <button class="mega-menu-item" data-tool="wip" onclick="selectMegaTool('wip')">
              <svg class="mega-menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
              </svg>
              <div class="mega-menu-content">
                <div class="mega-menu-title">WIP Report</div>
                <div class="mega-menu-desc">Work in progress tracking</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </nav>
    
    <!-- MAIN CONTENT WRAPPER -->
    <div class="main-content-wrapper">

      <!-- ========================================== -->
      <!-- ADMIN PANEL                                -->
      <!-- ========================================== -->
      <div id="adminPanel">
          
          <!-- HEADER (Hidden - no content needed) -->
          <!-- <header class="header-main flex items-center justify-end gap-3 mb-4 py-3 px-4 sticky top-0 z-30" style="background: var(--bg-card); border-bottom: 1px solid var(--border-primary);">
                <div id="userBadge" class="user-badge hidden" style="cursor: pointer;" onclick="handleLogout()" title="Click to logout">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="userBadgeName">User</span>
                </div>
                
          </header> -->


          <!-- ISO Preview Bar (shows in admin panel during ISO preview mode) -->
          <div id="isoPreviewBar" class="hidden p-4 fixed top-0 left-0 right-0 z-50 flex justify-between items-center shadow-xl" style="background: #0d3d2e; border-bottom: 1px solid #10b981;">
              <span class="font-bold text-sm uppercase tracking-wider flex items-center gap-2" style="color: #10b981;">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  ISO Preview Mode
              </span>
              <div class="flex items-center gap-3">
                  <span class="text-xs" style="color: var(--text-muted);">This is what your ISO partner sees</span>
                  <button onclick="exitISOPreview()" class="text-xs font-bold px-4 py-2 rounded-lg transition-all" style="background: #10b981; color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">Back to Editor</button>
              </div>
          </div>


          <!-- OFFER BUILDER TOOL SECTION -->
          <div id="offerBuilderSection" class="tool-section">

          <!-- PRODUCT TYPE TABS -->
          <div class="offer-product-tabs" id="offerProductTabs">
            <button class="offer-product-tab active" data-product="mca" onclick="switchOfferProduct('mca')">MCA</button>
            <button class="offer-product-tab" data-product="working" onclick="switchOfferProduct('working')">Working Capital</button>
            <button class="offer-product-tab" data-product="term" onclick="switchOfferProduct('term')">Term Loan</button>
            <button class="offer-product-tab" data-product="loc" onclick="switchOfferProduct('loc')">Line of Credit</button>
            <button class="offer-product-tab" data-product="sba" onclick="switchOfferProduct('sba')">SBA 7(a)</button>
            <button class="offer-product-tab" data-product="equipment" onclick="switchOfferProduct('equipment')">Equipment</button>
            <button class="offer-product-tab" data-product="cre" onclick="switchOfferProduct('cre')">CRE</button>
            <button class="offer-product-tab" data-product="factoring" onclick="switchOfferProduct('factoring')">Factoring</button>
          </div>

          <!-- ADMIN GRID -->
          <div class="flex flex-col lg:flex-row gap-8 w-full">
              
              <!-- LEFT: INPUTS -->
              <div class="flex-1 min-w-0 space-y-6 order-2 lg:order-1">
                
                <!-- Client Info Card -->
                <div class="card p-6 mobile-collapsible collapsed" id="clientInfoCard">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('clientInfoCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Client Information</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="section-content mt-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold mb-2 ml-1" style="color: var(--text-muted);">Business Name</label>
                                <input id="calcBusinessName" type="text" class="w-full p-3.5 border rounded-xl input-field text-sm font-medium" placeholder="e.g. Acme Corporation LLC" value="Acme Corporation LLC" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-2 ml-1" style="color: var(--text-muted);">Contact Name</label>
                                <input id="calcContactName" type="text" class="w-full p-3.5 border rounded-xl input-field text-sm font-medium" placeholder="First Last" value="First Last" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms Card -->
                <div class="card p-6 mobile-collapsible" id="structureOfferCard">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('structureOfferCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Structure Offer</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="section-content">
                    <!-- Tabs -->
                    <div class="flex gap-2 border-b mb-8 mt-4" style="border-color: var(--border-primary);">
                        <button id="tab-btn-0" class="calc-tab active px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(0)">Option A</button>
                        <button id="tab-btn-1" class="calc-tab hidden px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(1)">Option B</button>
                        <button id="tab-btn-2" class="calc-tab hidden px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(2)">Option C</button>
                        <div class="ml-auto flex items-center gap-2">
                            <button onclick="resetCalculator()" class="text-xs font-bold px-3 py-2 rounded-lg transition-colors" style="color: var(--text-muted);" onmouseover="this.style.background='var(--bg-option-card)'; this.style.color='var(--text-secondary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-muted)'" title="Reset Calculator">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Reset
                            </button>
                            <button id="add-tab-btn" class="text-xs font-bold px-3 py-2 rounded-lg transition-colors" style="color: var(--accent);" onmouseover="this.style.background='var(--accent-glow)'" onmouseout="this.style.background='transparent'" onclick="addCalcOption()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                                Add Option
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-8 fade-enter">
                        <!-- Funding Amount Slider -->
                        <div class="rounded-2xl p-6 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Funding Amount</label>
                                <button id="remove-option-btn" onclick="removeCalcOption()" class="text-xs hidden font-bold hover:underline flex items-center gap-1" style="color: #ef4444;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    Remove
                                </button>
                            </div>
                            <div class="flex items-baseline gap-1.5 mb-5">
                                <span class="font-semibold text-xl" style="color: var(--text-muted);">$</span>
                                <input id="calcAmount" type="text" class="w-full bg-transparent border-none p-0 text-4xl font-extrabold focus:ring-0 focus:outline-none" style="color: var(--text-primary);" value="50,000" />
                            </div>
                            <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="slider w-full" />
                            <div class="flex justify-between text-[10px] font-semibold mt-2 uppercase tracking-wider" style="color: var(--text-muted);">
                                <span>$5k</span>
                                <span>$1M</span>
                            </div>
                        </div>
                        
                        <!-- Factor & Term Sliders -->
                        <div id="factorTermGrid" class="grid grid-cols-1 gap-6">
                            <div id="factorRateCard" class="option-card">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Factor Rate</label>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="calcFactor" type="number" step="0.01" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">PTR</span>
                                </div>
                                <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="slider w-full" />
                            </div>
                            <div class="option-card">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Term Length</label>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="calcTerm" type="number" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="130" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">Pmts</span>
                                </div>
                                <input id="calcTermSlider" type="range" min="5" max="520" step="1" value="130" class="slider w-full" />
                            </div>
                            
                            <!-- Payment Frequency -->
                            <div class="option-card" id="frequencyCard">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Payment Frequency</label>
                                <div class="toggle-group inline-flex w-full">
                                    <button class="toggle-btn active flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="daily" onclick="setFrequency('daily')">Daily</button>
                                    <button class="toggle-btn flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="weekly" onclick="setFrequency('weekly')">Weekly</button>
                                    <button class="toggle-btn flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="monthly" onclick="setFrequency('monthly')">Monthly</button>
                                </div>
                            </div>
                            
                            <!-- Minimum Requirements -->
                            <div class="option-card" id="productRequirementsCard">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Minimum Requirements</label>
                                <div id="productRequirements" class="space-y-3">
                                    <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
                                        <span class="text-sm" style="color: var(--text-secondary);">Time in Business</span>
                                        <span class="text-sm font-bold" style="color: var(--accent);">4+ months</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
                                        <span class="text-sm" style="color: var(--text-secondary);">Credit Score</span>
                                        <span class="text-sm font-bold" style="color: var(--accent);">500+</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
                                        <span class="text-sm" style="color: var(--text-secondary);">Monthly Revenue</span>
                                        <span class="text-sm font-bold" style="color: var(--accent);">$10,000+</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
                                        <span class="text-sm" style="color: var(--text-secondary);">Bank Statements</span>
                                        <span class="text-sm font-bold" style="color: var(--accent);">3 months</span>
                                    </div>
                                    <div class="flex items-center justify-between py-2">
                                        <span class="text-sm" style="color: var(--text-secondary);">Industry</span>
                                        <span class="text-sm font-bold" style="color: var(--accent);">Most accepted</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lender Mode: Rate Settings -->
                        <div id="lenderRateSection" class="hidden">
                            <div class="option-card">
                                <div class="flex items-center justify-between mb-4">
                                    <label class="text-xs font-bold uppercase tracking-wide" style="color: var(--accent);">Lender Rate Settings</label>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" style="background: var(--accent); color: var(--accent-text);">Lender Mode</span>
                                </div>
                                
                                <!-- Tier Presets -->
                                <div class="mb-4">
                                    <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Rate Tier Presets</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setLenderTier(1)" id="tierBtn1" class="tier-preset-btn active p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--accent);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier A</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.15 / 1.25</span>
                                        </button>
                                        <button onclick="setLenderTier(2)" id="tierBtn2" class="tier-preset-btn p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier B</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.25 / 1.35</span>
                                        </button>
                                        <button onclick="setLenderTier(3)" id="tierBtn3" class="tier-preset-btn p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier C</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.35 / 1.45</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Buy Rate -->
                                    <div>
                                        <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Buy Rate (ISO)</label>
                                        <div class="flex items-center justify-between mb-2 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <input id="lenderBuyRate" type="number" step="0.01" min="1.05" max="1.60" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.15" />
                                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">BUY</span>
                                        </div>
                                        <input id="lenderBuyRateSlider" type="range" min="1.05" max="1.60" step="0.01" value="1.15" class="slider w-full" />
                                    </div>
                                    
                                    <!-- Max Sell Rate -->
                                    <div>
                                        <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Max Sell Rate (ISO Ceiling)</label>
                                        <div class="flex items-center justify-between mb-2 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <input id="lenderMaxSell" type="number" step="0.01" min="1.10" max="1.70" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">MAX</span>
                                        </div>
                                        <input id="lenderMaxSellSlider" type="range" min="1.10" max="1.70" step="0.01" value="1.25" class="slider w-full" />
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4 p-3 rounded-lg" style="background: var(--bg-card);">
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Max Upsell</p>
                                        <p id="lenderMaxSpread" class="text-lg font-bold" style="color: var(--accent);">0.24</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Max ISO Profit</p>
                                        <p id="lenderMaxProfit" class="text-lg font-bold" style="color: #10b981;">$0</p>
                                    </div>
                                </div>
                                
                                <button id="lockShareISOBtn" onclick="shareWithISO()" class="w-full py-3 px-4 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 transition-all" style="background: var(--accent); color: var(--accent-text);">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    <span id="lockShareISOText">Lock and Share with ISO</span>
                                </button>
                                
                                <!-- Unlock button (hidden by default) -->
                                <button id="unlockISOBtn" onclick="unlockTerms()" class="hidden w-full py-3 px-4 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 transition-all mt-2" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-secondary);">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                    </svg>
                                    Unlock All Options
                                </button>
                            </div>
                        </div>
                        
                        <!-- ISO Mode: Upsell Slider (when opened via shared link) -->
                        <div id="isoUpsellSection" class="hidden">
                            <div class="option-card">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-xs font-bold uppercase tracking-wide" style="color: #10b981;">Rate</label>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" style="background: #10b981; color: white;">ISO Mode</span>
                                </div>
                                <p class="text-xs mb-3" style="color: var(--text-muted);">Adjust your sell rate to set your profit margin</p>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="isoSellRate" type="number" step="0.01" min="1.05" max="1.70" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">SELL</span>
                                </div>
                                <input id="isoSellRateSlider" type="range" min="1.05" max="1.70" step="0.01" value="1.25" class="slider w-full" />
                                <div class="grid grid-cols-3 gap-2 mt-4 pt-4" style="border-top: 1px solid var(--border-secondary);">
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Buy Rate</p>
                                        <p id="isoBuyRateDisplay" class="text-sm font-bold" style="color: var(--text-primary);">1.15</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Upsell</p>
                                        <p id="isoSpreadDisplay" class="text-sm font-bold" style="color: #10b981;">0.10</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Your Profit</p>
                                        <p id="isoProfitDisplay" class="text-sm font-bold" style="color: #10b981;">$0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                </div> <!-- end structureOfferCard -->
                
                <!-- Offer Options Card (Collapsible on Mobile) -->
                <div id="offerOptionsCard" class="card p-6 mobile-collapsible collapsed">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('offerOptionsCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Offer Options</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="section-content mt-6">
                <!-- Options Grid - 2x3 -->
                <div class="grid grid-cols-2 gap-3">
                <!-- Origination Fee Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #ec4899, #db2777);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Origination Fee</span>
                        </div>
                        <label class="switch">
                            <input id="toggleFee" type="checkbox" onchange="toggleSection('Fee', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secFee" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <div class="flex items-center gap-3">
                            <input id="calcFee" type="number" step="0.5" min="0" max="15" class="w-16 border rounded-lg p-2 text-sm font-bold text-center outline-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" value="0" oninput="setVal('calcFeeSlider', this.value); updateSliderFill($('calcFeeSlider')); updatePreview()" />
                            <span class="text-sm font-bold" style="color: var(--text-muted);">%</span>
                            <input id="calcFeeSlider" type="range" min="0" max="15" step="0.5" value="0" class="slider h-1.5 flex-1" oninput="setVal('calcFee', this.value); updatePreview(); updateSliderFill(this);" />
                        </div>
                    </div>
                </div>
                
                <!-- Prepay Discount Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #14b8a6, #0d9488);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Prepay Discount</span>
                        </div>
                        <label class="switch">
                            <input id="togglePrepay" type="checkbox" onchange="toggleSection('Prepay', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secPrepay" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div class="flex items-center gap-2">
                                <input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-14 border rounded-lg p-2 text-sm font-bold text-center outline-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" value="0" oninput="setVal('calcPrepaySlider', this.value); updateSliderFill($('calcPrepaySlider')); updatePreview()" />
                                <span class="text-xs font-bold" style="color: var(--text-muted);">%</span>
                            </div>
                            <input id="calcPrepayDate" type="date" class="w-full border rounded-lg p-2 text-xs font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" onchange="updatePreview()" />
                        </div>
                        <input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="slider h-1.5 w-full" oninput="setVal('calcPrepay', this.value); updatePreview(); updateSliderFill(this);" />
                    </div>
                </div>
                
                <!-- Custom Term Label Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Custom Term Label</span>
                        </div>
                        <label class="switch">
                            <input id="toggleOverride" type="checkbox" onchange="toggleSection('Override', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secOverride" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcTermOverride" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. 6 Months" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Offer Expiration Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Offer Expiration</span>
                        </div>
                        <label class="switch">
                            <input id="toggleExpiry" type="checkbox" onchange="toggleSection('Expiry', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secExpiry" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcExpiryDate" type="date" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" onchange="updatePreview()" />
                    </div>
                </div>
                
                <!-- ISO Name Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">ISO Name</span>
                        </div>
                        <label class="switch">
                            <input id="toggleISO" type="checkbox" onchange="toggleSection('ISO', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secISO" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcISOName" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. ABC Funding" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Lender Name Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Lender Name</span>
                        </div>
                        <label class="switch">
                            <input id="toggleLender" type="checkbox" onchange="toggleSection('Lender', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secLender" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcLenderName" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. XYZ Capital" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Offer Notes Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Offer Notes</span>
                        </div>
                        <label class="switch">
                            <input id="toggleNotes" type="checkbox" onchange="toggleSection('Notes', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secNotes" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <textarea id="calcNotes" class="w-full border rounded-lg p-2 text-sm font-medium resize-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" rows="3" placeholder="One note per line..." oninput="updatePreview()"></textarea>
                    </div>
                </div>
                
                <!-- Closing Documents Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Closing Documents</span>
                        </div>
                        <label class="switch">
                            <input id="toggleDocs" type="checkbox" onchange="toggleSection('Docs', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secDocs" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <textarea id="calcDocs" class="w-full border rounded-lg p-2 text-sm font-medium resize-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" rows="3" oninput="updatePreview()">Voided Check
Government Issued ID</textarea>
                    </div>
                </div>
                </div> <!-- end 2x3 grid -->
                    </div> <!-- end section-content -->
                </div> <!-- end offerOptionsCard -->
              </div>

              <!-- RIGHT: PREVIEW -->
              <div id="previewColumn" class="calc-preview-column w-full lg:w-96 xl:w-[420px] flex-shrink-0 order-1 lg:order-2">
                  <div class="preview-sticky-wrapper">
                      <!-- Sticky Action Bar (Desktop Only) -->
                      <div id="stickyActionBar" class="flex flex-wrap items-center justify-center gap-2 mb-4 p-2 rounded-2xl" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <!-- Settings Button -->
                          <div class="theme-picker-sticky relative">
                              <button onclick="toggleThemeDropdownSticky()" class="h-8 px-2 rounded-full flex items-center justify-center gap-1.5 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                                  <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  </svg>
                                  Settings
                              </button>
                          </div>
                          
                          <!-- Offers Button -->
                          <button onclick="openDashboard()" class="h-8 px-2 rounded-full flex items-center justify-center gap-1.5 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                              Offers
                              <span id="stickyOfferCount" class="offer-count-badge hidden">0</span>
                          </button>
                          
                          <!-- Preview Button -->
                          <div class="preview-picker-sticky relative">
                              <button onclick="togglePreviewDropdownSticky()" class="h-8 px-2 rounded-full flex items-center justify-center gap-1.5 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                                  <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                  </svg>
                                  Preview
                                  <svg xmlns="http://www.w3.org/2000/svg" style="width: 10px; height: 10px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                  </svg>
                              </button>
                              <div id="previewDropdownSticky" class="preview-dropdown">
                                  <button onclick="handleClientPreview(); togglePreviewDropdownSticky();" class="preview-option">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                      </svg>
                                      <div>
                                          <div class="preview-option-title">Client Preview</div>
                                          <div class="preview-option-desc">See what your client sees</div>
                                      </div>
                                  </button>
                                  <button onclick="copyCurrentCalcLink(); togglePreviewDropdownSticky();" class="preview-option">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                                      </svg>
                                      <div>
                                          <div class="preview-option-title">Copy Client Link</div>
                                          <div class="preview-option-desc">Share calculator with preset values</div>
                                      </div>
                                  </button>
                                  <button id="isoPreviewOptionSticky" onclick="previewISOView(); togglePreviewDropdownSticky();" class="preview-option hidden">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                      </svg>
                                      <div>
                                          <div class="preview-option-title">ISO Preview</div>
                                          <div class="preview-option-desc">See what your ISO partner sees</div>
                                      </div>
                                  </button>
                              </div>
                          </div>
                          
                          <!-- Share Button -->
                          <button onclick="shareOffer()" class="share-btn h-8 px-3 rounded-full flex items-center justify-center gap-1.5 font-semibold" style="background: var(--accent); border: 1px solid var(--accent); color: #000; font-size: 11px;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                              </svg>
                              Share
                          </button>
                      </div>
                      
                      <!-- Preview Card -->
                      <div id="previewCard" class="preview-card">
                        
                        <!-- Header -->
                        <div class="preview-header p-8 pb-10 text-center">
                          <div class="relative z-10 pt-2">
                            <!-- Logo Container -->
                            <div id="previewLogoContainer" class="preview-logo-container hidden">
                                <img id="previewLogo" src="" alt="Company Logo" class="preview-logo mx-auto" referrerpolicy="no-referrer" />
                            </div>
                            <div id="previewCompanyName" class="company-name-display hidden"></div>
                            
                            <div id="previewLabelContainer" class="mb-5 hidden">
                                <span id="previewOptionLabel" class="option-badge inline-block text-[10px] font-bold uppercase tracking-widest px-4 py-1.5 rounded-full">Option A</span>
                            </div>
                            <div id="previewBusinessName" class="business-name-display mt-2 mb-4 hidden"></div>
                            
                            <span class="text-[11px] font-bold uppercase tracking-widest block mb-3" style="color: var(--text-muted);">You Get</span>
                            <span id="previewAmount" class="amount-display block editable-value" contenteditable="true" data-field="amount">$50,000</span>
                          </div>
                        </div>
                        
                        <!-- Chart Section -->
                        <div class="px-8 py-10 flex items-center justify-center gap-8" style="background: linear-gradient(to bottom, var(--bg-card), var(--bg-option-card));">
                           <div class="relative w-36 h-36 flex-shrink-0">
                              <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                              </svg>
                              <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-[10px] font-bold uppercase tracking-wide" style="color: var(--text-muted);">Payback</span>
                                <span id="previewPaybackChart" class="text-base font-bold block tracking-tight mt-0.5" style="color: var(--text-primary);">$62,500</span>
                              </div>
                           </div>
                           <div class="space-y-3 text-xs">
                               <div class="flex items-center gap-2.5">
                                 <span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
                                 <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
                               </div>
                               <div class="flex items-center gap-2.5">
                                 <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
                                 <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
                               </div>
                           </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="border-t" style="border-color: var(--border-secondary); background: var(--bg-option-card);">
                          <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                            <div class="stat-cell">
                              <span class="stat-label">Term Length</span>
                              <span id="previewTermLength" class="stat-value editable-value" contenteditable="true" data-field="termLength">6 months</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Payments</span>
                              <span id="previewTermPayments" class="stat-value editable-value" contenteditable="true" data-field="payments">130</span>
                            </div>
                          </div>
                          <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                            <div class="stat-cell">
                              <span class="stat-label">Factor Rate</span>
                              <span id="previewFactor" class="stat-value font-mono editable-value" contenteditable="true" data-field="factor">1.19x</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Total Cost</span>
                              <span id="previewCost" class="stat-value">$12,500</span>
                            </div>
                          </div>
                          
                          <div id="previewFeeRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(251, 191, 36, 0.1);">
                            <div class="stat-cell">
                              <span class="stat-label">Origination Fee</span>
                              <span id="previewFeeAmount" class="stat-value">$0</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Net Proceeds</span>
                              <span id="previewNet" class="stat-value">$50,000</span>
                            </div>
                          </div>
                          
                          <div id="previewPrepayRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(34, 197, 94, 0.1);">
                            <div class="stat-cell" style="grid-column: span 2;">
                              <span class="stat-label">Prepay Discount</span>
                              <span id="previewPrepay" class="stat-value" style="color: #22c55e;">10% off if paid early</span>
                            </div>
                          </div>

                          <!-- Payment Display - GRADIENT REMOVED -->
                          <div class="p-8 text-center" style="background: var(--bg-card);">
                            <div>
                                <span id="previewPaymentLabel" class="text-[10px] font-bold block uppercase tracking-widest mb-2" style="color: var(--text-muted);">Daily Payment</span>
                                <span id="previewPayment" class="text-3xl font-extrabold tracking-tight" style="color: var(--text-primary);">$480.77</span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="p-4 text-center border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                              <button onclick="openAmortSchedule()" class="text-xs font-bold flex items-center justify-center gap-1.5 mx-auto group transition-colors" style="color: var(--accent);">
                                  <span>View Payment Schedule</span>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                              </button>
                        </div>

                      </div>
                      
                      <!-- Admin Preview: Notes Section -->
                      <div id="previewNotesSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                              <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Offer Notes</h4>
                          </div>
                          <ul id="previewNotesList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                      
                      <!-- Admin Preview: Docs Section -->
                      <div id="previewDocsSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                              <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Closing Documents</h4>
                          </div>
                          <ul id="previewDocsList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                      
                      <!-- Admin Preview: Expiration Section (at bottom) -->
                      <div id="previewExpirySection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                              <div>
                                  <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Offer Expiration</h4>
                                  <p class="text-sm" style="color: var(--text-secondary);">Expires <span id="previewExpiryDate" class="font-bold" style="color: var(--accent);"></span></p>
                              </div>
                          </div>
                      </div>
                      
                      <div id="previewSourceSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                              <div class="flex-1">
                                  <h4 class="font-bold text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Source Info</h4>
                                  <div class="flex flex-wrap gap-2">
                                      <span id="previewISOTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(var(--accent-rgb), 0.3);"></span>
                                      <span id="previewLenderTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3);"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                      
                  </div>
              </div>
          </div>
      </div>
      </div><!-- END offerBuilderSection -->

      <!-- ========================================== -->
      <!-- CALCULATOR TOOL SECTIONS                  -->
      <!-- ========================================== -->
      <!-- PRE-QUALIFY SECTION -->
      <div id="prequalSection" class="tool-section active">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="prequalInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="prequalResultCard"></div>
          </div>
        </div>
      </div>

      <!-- MCA SECTION -->
      <div id="mcaSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="mcaInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="mcaResultCard"></div>
          </div>
        </div>
      </div>

      <!-- WORKING CAPITAL SECTION -->
      <div id="workingSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="workingInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="workingResultCard"></div>
          </div>
        </div>
      </div>

      <!-- TERM LOAN SECTION -->
      <div id="termSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="termInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="termResultCard"></div>
          </div>
        </div>
      </div>

      <!-- LINE OF CREDIT SECTION -->
      <div id="locSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="locInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="locResultCard"></div>
          </div>
        </div>
      </div>

      <!-- SBA SECTION -->
      <div id="sbaSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="sbaInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="sbaResultCard"></div>
          </div>
        </div>
      </div>

      <!-- EQUIPMENT SECTION -->
      <div id="equipmentSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="equipInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="equipResultCard"></div>
          </div>
        </div>
      </div>

      <!-- EARLY PAYOFF SECTION -->
      <div id="payoffSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="payoffInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="payoffResultCard"></div>
          </div>
        </div>
      </div>

      <!-- CRE (COMMERCIAL REAL ESTATE) SECTION -->
      <div id="creSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="creInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="creResultCard"></div>
          </div>
        </div>
      </div>

      <!-- FACTORING SECTION -->
      <div id="factoringSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="factoringInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="factoringResultCard"></div>
          </div>
        </div>
      </div>

      <!-- APR SECTION -->
      <div id="aprSection" class="tool-section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full items-stretch">
          <div class="space-y-6 order-2 lg:order-1 h-full">
            <div class="card p-6 h-full" id="aprInputCard"></div>
          </div>
          <div class="order-1 lg:order-2 h-full">
            <div class="calc-result-preview" id="aprResultCard"></div>
          </div>
        </div>
      </div>

      <!-- ABLESCORE GUIDE SECTION -->
      <div id="perrepusSection" class="tool-section">
        <div class="w-full space-y-6">
          <div class="card p-6" id="perrepusGuideCard"></div>
        </div>
      </div>

      <!-- DEBT SCHEDULE SECTION -->
      <div id="debtScheduleSection" class="tool-section">
        <div class="w-full space-y-6">
          <div class="card p-6" id="debtScheduleCard"></div>
        </div>
      </div>

      <!-- A/R AGING SECTION -->
      <div id="arAgingSection" class="tool-section">
        <div class="w-full space-y-6">
          <div class="card p-6" id="arAgingCard"></div>
        </div>
      </div>

      <!-- WIP REPORT SECTION -->
      <div id="wipSection" class="tool-section">
        <div class="w-full space-y-6">
          <div class="card p-6" id="wipCard"></div>
        </div>
      </div>

            </div><!-- END main-content-area -->
          </div><!-- END app-layout -->
      
      <!-- ========================================== -->
      <!-- CLIENT PANEL                               -->
      <!-- ========================================== -->
      <div id="clientPanel" class="hidden w-full max-w-4xl mx-auto mt-6">
          <div id="clientPreviewBar" class="hidden p-4 fixed top-0 left-0 right-0 z-50 flex justify-between items-center shadow-xl" style="background: #1e1e3f; border-bottom: 1px solid #6366f1;">
              <span class="font-bold text-sm uppercase tracking-wider flex items-center gap-2" style="color: #6366f1;">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                  Client Preview Mode
              </span>
              <div class="flex items-center gap-3">
                  <span class="text-xs" style="color: var(--text-muted);">This is what your client sees</span>
                  <button onclick="exitPreview()" class="text-xs font-bold px-4 py-2 rounded-lg transition-all" style="background: #6366f1; color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">Back to Editor</button>
              </div>
          </div>
          
          <div class="text-center mb-10">
              <!-- Trust Badge -->
              <div class="trust-badge inline-flex items-center gap-3 px-5 py-2.5 rounded-full mb-8">
                  <div class="trust-badge-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.749.749 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.352-.114-2.662-.334-3.908a.75.75 0 00-.722-.515 11.208 11.208 0 01-7.877-3.08zm3.134 7.09a.75.75 0 00-1.06-1.06L11 11.79l-1.09-1.09a.75.75 0 00-1.06 1.06l1.62 1.62a.75.75 0 001.06 0l4.12-4.12z" clip-rule="evenodd" />
                      </svg>
                  </div>
                  <span class="trust-badge-text"><span class="trust-badge-accent">Ables</span><span style="color: #6b7280;">AI</span> Verified</span>
              </div>
              
              <h1 id="clientGreeting" class="text-3xl font-extrabold mb-3" style="color: var(--text-primary);">Hello, Business Owner</h1>
              <p style="color: var(--text-muted);" class="max-w-lg mx-auto text-sm">Your business <span id="clientBusinessName" class="font-semibold" style="color: var(--text-primary);"></span> has been pre-approved for funding.</p>
          </div>

          <!-- Client Card -->
          <div class="max-w-md mx-auto relative">
              <div class="preview-card">
                  
                  <!-- Header -->
                  <div class="preview-header p-8 pb-10 text-center">
                    <div class="relative z-10 pt-2">
                      <!-- Logo Container -->
                      <div id="cPreviewLogoContainer" class="preview-logo-container hidden">
                          <img id="cPreviewLogo" src="" alt="Company Logo" class="preview-logo mx-auto" referrerpolicy="no-referrer" />
                      </div>
                      <div id="cPreviewCompanyName" class="company-name-display hidden"></div>
                      
                      <!-- Option Tabs -->
                      <div id="clientTabsContainer" class="flex justify-center gap-2 mb-6 hidden"></div>
                      <div id="cPreviewLabelContainer" class="mb-5 hidden">
                          <span id="cPreviewOptionLabel" class="option-badge inline-block text-[10px] font-bold uppercase tracking-widest px-4 py-1.5 rounded-full">Option A</span>
                      </div>

                      <span class="text-[11px] font-bold uppercase tracking-widest block mb-3" style="color: var(--text-muted);">You Get</span>
                      <span id="cPreviewAmount" class="amount-display block">$50,000</span>
                      
                      <!-- Amount Slider -->
                      <div class="mt-10 px-2 relative z-20">
                          <input id="clientAmountSlider" type="range" class="slider slider-dark w-full" />
                          <div class="flex justify-between text-[10px] font-bold mt-3 uppercase tracking-widest" style="color: var(--text-muted);">
                              <span>$5k</span>
                              <span id="clientMaxLabelSlider">Max</span>
                          </div>
                      </div>

                    </div>
                  </div>

                  <!-- Chart Section -->
                  <div class="px-8 py-10 flex items-center justify-center gap-8" style="background: linear-gradient(to bottom, var(--bg-card), var(--bg-option-card));">
                     <div class="relative w-36 h-36 flex-shrink-0">
                        <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                          <path id="cPreviewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                          <span class="text-[10px] font-bold uppercase tracking-wide" style="color: var(--text-muted);">Payback</span>
                          <span id="cPreviewPayback" class="text-base font-bold block tracking-tight mt-0.5" style="color: var(--text-primary);">$62,500</span>
                        </div>
                     </div>
                     <div class="space-y-3 text-xs">
                         <div class="flex items-center gap-2.5">
                           <span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
                           <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
                         </div>
                         <div class="flex items-center gap-2.5">
                           <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
                           <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
                         </div>
                     </div>
                  </div>

                  <!-- Stats Grid -->
                  <div class="border-t" style="border-color: var(--border-secondary); background: var(--bg-option-card);">
                      <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                        <div class="stat-cell">
                          <span class="stat-label">Term Length</span>
                          <span id="cPreviewTerm" class="stat-value">6 months</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Payments</span>
                          <span id="cPreviewCount" class="stat-value">130</span>
                        </div>
                      </div>
                      <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                        <div class="stat-cell">
                          <span class="stat-label">Factor Rate</span>
                          <span id="cPreviewFactor" class="stat-value font-mono">1.19x</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Total Cost</span>
                          <span id="cPreviewCost" class="stat-value">$12,500</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewFeeRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(251, 191, 36, 0.1);">
                        <div class="stat-cell">
                          <span class="stat-label">Origination Fee</span>
                          <span id="cPreviewFee" class="stat-value">$0</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Net Proceeds</span>
                          <span id="cPreviewNet" class="stat-value">$50,000</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewPrepayRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(34, 197, 94, 0.1);">
                        <div class="stat-cell" style="grid-column: span 2;">
                          <span class="stat-label">Prepay Discount</span>
                          <span id="cPreviewPrepay" class="stat-value" style="color: #22c55e;">10% off if paid early</span>
                        </div>
                      </div>

                      <!-- Payment Display - GRADIENT REMOVED -->
                      <div class="p-8 text-center" style="background: var(--bg-card);">
                          <div>
                              <span id="cPreviewPaymentLabel" class="text-[10px] font-bold block uppercase tracking-widest mb-2" style="color: var(--text-muted);">Daily Payment</span>
                              <span id="cPreviewPayment" class="text-3xl font-extrabold tracking-tight" style="color: var(--text-primary);">$480.77</span>
                          </div>
                      </div>
                  </div>

                  <!-- View Schedule Link -->
                  <div class="p-4 text-center border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                      <button onclick="openAmortSchedule()" class="text-xs font-bold flex items-center justify-center gap-1.5 mx-auto group transition-colors" style="color: var(--accent);">
                          <span>View Payment Schedule</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                      </button>
                  </div>

                  <!-- Accept Button -->
                  <div class="p-6 border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                      <button onclick="acceptOffer()" class="btn btn-primary w-full py-4 rounded-xl text-base font-bold flex items-center justify-center gap-2.5">
                          <span>Accept Offer & Proceed</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                      </button>
                      <p class="text-center text-[10px] mt-3 font-medium" style="color: var(--text-muted);">Clicking accept is non-binding.</p>
                      <button onclick="declineOffer()" class="w-full mt-3 py-2 text-xs font-medium rounded-lg border transition-all hover:border-red-500 hover:text-red-500" style="color: var(--text-muted); border-color: var(--border-secondary); background: transparent;">
                          Decline Offer
                      </button>
                  </div>

              </div>

              <!-- Terms & Documents - Separate Sections -->
              <div id="clientTermsContainer" class="mt-8 px-2 max-w-2xl mx-auto space-y-4 hidden">
                  
                  <!-- Notes & Documents - Side by Side -->
                  <div id="clientNotesDocsRow" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                      <!-- Notes Section -->
                      <div id="clientNotesSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                              <h4 class="font-bold text-sm" style="color: var(--text-primary);">Offer Notes</h4>
                          </div>
                          <ul id="clientNotesList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>

                      <!-- Documents Section -->
                      <div id="clientDocsSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                              <h4 class="font-bold text-sm" style="color: var(--text-primary);">Closing Documents</h4>
                          </div>
                          <ul id="clientDocsList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                  </div>
                  
                  <!-- Expiration Section - At bottom -->
                  <div id="clientExpirySection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                      <div class="flex items-center gap-3">
                          <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                          <p class="text-sm" style="color: var(--text-secondary);">This offer expires on <span id="clientExpiryDate" class="font-bold" style="color: var(--accent);">December 31, 2024</span></p>
                      </div>
                  </div>
                  
                  <!-- Source Info Section -->
                  <div id="clientSourceSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                      <div class="flex items-center gap-3">
                          <div class="section-indicator" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                          <div class="flex-1">
                              <h4 class="font-bold text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Source Info</h4>
                              <div class="flex flex-wrap gap-2">
                                  <span id="clientISOTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(var(--accent-rgb), 0.3);"></span>
                                  <span id="clientLenderTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3);"></span>
                              </div>
                          </div>
                      </div>
                  </div>

              </div>

          </div>
      </div>

  <!-- ========================================== -->
  <!-- MODALS                                     -->
  <!-- ========================================== -->
  
  <!-- Success Modal -->
  <div id="successModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-md shadow-2xl p-8 text-center relative overflow-hidden">
      <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(to bottom, var(--accent-glow), transparent);"></div>
      
      <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 relative z-10 shadow-lg" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
      </div>
      
      <h3 class="text-2xl font-extrabold mb-3 relative z-10" style="color: var(--text-primary);">Offer Accepted!</h3>
      <p class="mb-8 relative z-10 text-sm leading-relaxed" style="color: var(--text-secondary);">Great news! Your pre-approval has been registered. Please contact your funding representative immediately to finalize the documents and receive your funds.</p>
      
      <div class="relative z-10">
          <button onclick="addClass('successModal', 'hidden')" class="btn btn-primary w-full py-3.5 rounded-xl font-bold">
              Close
          </button>
      </div>
    </div>
  </div>

  <!-- Amortization Modal -->
  <div id="amortModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
      <div class="p-5 border-b flex justify-between items-center" style="background: var(--bg-option-card); border-color: var(--border-primary);">
          <h3 class="font-bold" style="color: var(--text-primary);">Payment Schedule</h3>
          <button onclick="addClass('amortModal', 'hidden')" class="p-1 rounded-lg transition-colors" style="color: var(--text-muted);" onmouseover="this.style.background='var(--bg-option-card)'" onmouseout="this.style.background='transparent'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
      </div>
      <div class="overflow-y-auto p-0 flex-1">
          <table class="w-full text-sm amort-table">
              <thead>
                  <tr>
                      <th class="px-6 py-4 text-left">#</th>
                      <th class="px-6 py-4 text-left">Date</th>
                      <th class="px-6 py-4 text-right">Payment</th>
                      <th class="px-6 py-4 text-right">Balance</th>
                  </tr>
              </thead>
              <tbody id="amortTableBody" class="divide-y" style="border-color: var(--border-secondary);"></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl w-full max-w-3xl overflow-hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);">
      <div class="flex items-center justify-between p-4 border-b" style="border-color: var(--border-primary);">
        <h3 class="text-lg font-bold" style="color: var(--text-primary);">Share Offer</h3>
        <button onclick="addClass('shareModal', 'hidden')" class="w-8 h-8 rounded-lg flex items-center justify-center transition-all" style="background: var(--bg-card-inner); color: var(--text-muted);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="flex flex-col lg:flex-row">
        <!-- Preview Section -->
        <div class="lg:w-1/2 p-4 flex items-center justify-center" style="background: var(--bg-body);">
          <div id="sharePreviewContainer" class="w-full max-w-xs rounded-xl overflow-hidden shadow-lg" style="border: 2px solid var(--accent); transform: scale(0.85); transform-origin: center;">
            <!-- Preview content will be injected here -->
          </div>
        </div>
        <!-- Share Options Section -->
        <div class="lg:w-1/2 p-6">
          <p class="text-sm mb-4" style="color: var(--text-muted);">Choose how to share this offer with your client:</p>
          <div class="grid grid-cols-1 gap-3">
              <button onclick="copyLink()" class="share-option group p-4 rounded-xl flex items-center gap-4 transition-all text-left" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
                  <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 transition-all" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-bold mb-0.5" style="color: var(--text-primary);">Copy Link</p>
                    <p class="text-xs" style="color: var(--text-muted);">Share via URL - opens interactive calculator</p>
                  </div>
              </button>
              <button onclick="copySMS()" class="share-option group p-4 rounded-xl flex items-center gap-4 transition-all text-left" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
                  <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 transition-all" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-bold mb-0.5" style="color: var(--text-primary);">Send SMS</p>
                    <p class="text-xs" style="color: var(--text-muted);">Text message with offer summary</p>
                  </div>
              </button>
              <button onclick="copyText()" class="share-option group p-4 rounded-xl flex items-center gap-4 transition-all text-left" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
                  <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 transition-all" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-bold mb-0.5" style="color: var(--text-primary);">Email Template</p>
                    <p class="text-xs" style="color: var(--text-muted);">HTML formatted email content</p>
                  </div>
              </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Preview Modal -->
  <div id="floatingPreviewModal" class="fixed inset-0 z-50 hidden" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
    <div class="absolute top-4 right-4 flex items-center gap-3 z-10">
      <button id="previewCopyLinkBtn" onclick="copyLinkFromPreview()" class="px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all" style="background: var(--accent); color: white;">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
        Copy Link
      </button>
      <button onclick="closeFloatingPreview()" class="w-10 h-10 rounded-full flex items-center justify-center transition-all" style="background: rgba(255,255,255,0.1); color: white;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="flex items-start justify-center h-full p-4 pt-16 overflow-y-auto">
      <!-- Preview Frame -->
      <div class="relative w-full max-w-2xl">
        <div class="rounded-2xl overflow-hidden" style="background: #121212; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);">
          <!-- Screen -->
          <div id="floatingPreviewContent" class="overflow-y-auto" style="max-height: 80vh;">
            <!-- Client view content will be injected here -->
          </div>
        </div>
        <!-- Label -->
        <div class="text-center mt-4">
          <span id="floatingPreviewLabel" class="text-xs font-semibold px-3 py-1 rounded-full" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);">Client Preview</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Upgrade Modal (shown when lite limit reached) -->
  <div id="upgradeModal" class="login-modal-overlay">
    <div class="login-modal rounded-2xl w-full max-w-md shadow-2xl p-8 text-center">
      <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <h3 class="text-2xl font-extrabold mb-3" style="color: var(--text-primary);">Monthly Limit Reached</h3>
      <p class="text-sm mb-6" style="color: var(--text-secondary);">You've used all <strong>25 free shares</strong> this month. Upgrade to Pro for unlimited shares and white-label branding.</p>
      
      <div class="rounded-xl p-4 mb-6" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-semibold" style="color: var(--text-muted);">LITE (Free)</span>
          <span class="text-sm font-bold" style="color: var(--text-muted);">Current</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold" style="color: var(--accent);">PRO</span>
          <span class="text-sm font-bold" style="color: var(--accent);">Unlimited + Branding</span>
        </div>
      </div>
      
      <button onclick="openLoginModal(); closeUpgradeModal();" class="btn btn-primary w-full py-4 rounded-xl font-bold mb-3">
        Sign In to Upgrade
      </button>
      <button onclick="closeUpgradeModal()" class="text-sm font-semibold transition-colors" style="color: var(--text-muted);">Maybe Later</button>
      
      <p class="text-xs mt-6" style="color: var(--text-muted);">Your limit resets on the 1st of each month.</p>
    </div>
  </div>

  <!-- Settings Panel (Theme Dropdown) -->
  <div id="themeDropdown" class="theme-dropdown">
    <!-- Settings Header -->
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border-secondary);">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px; overflow: visible;">
        <defs>
          <radialGradient id="planetGrad3" cx="35%" cy="35%" r="60%">
            <stop offset="0%" stop-color="#fcd34d"/>
            <stop offset="50%" stop-color="#eab308"/>
            <stop offset="100%" stop-color="#ca8a04"/>
          </radialGradient>
          <linearGradient id="ringGrad3" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#ffab40"/>
            <stop offset="50%" stop-color="#ff8c00"/>
            <stop offset="100%" stop-color="#ff6d00"/>
          </linearGradient>
        </defs>
        <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad3)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" opacity="0.6"/>
        <circle cx="32" cy="32" r="12" fill="url(#planetGrad3)"/>
        <ellipse cx="28" cy="28" rx="4" ry="3" fill="#fef3c7" opacity="0.4"/>
        <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad3)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
      </svg>
      <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-secondary);">Settings</span>
    </div>
    
    <!-- Branding Section -->
    <div class="theme-section-title">Brand</div>
    
    <!-- Company Name Input -->
    <div style="margin-bottom: 16px;">
      <label class="block text-xs font-medium mb-2" style="color: var(--text-secondary);">Company Name</label>
      <input type="text" id="companyNameInput" class="logo-input" placeholder="Your Company Name" oninput="updateCompanyName(this.value)" maxlength="50"/>
    </div>
    
    <!-- Logo URL Input -->
    <div>
      <label class="block text-xs font-medium mb-2" style="color: var(--text-secondary);">Company Logo</label>
      <div class="flex gap-2">
        <input type="text" id="logoUrlInput" class="logo-input flex-1" placeholder="https://example.com/logo.png" oninput="updateLogoPreview(this.value)"/>
        <button onclick="updateLogoPreview($('logoUrlInput').value)" class="px-3 py-2 rounded-lg text-xs font-semibold" style="background: var(--accent); color: white;">Load</button>
      </div>
      <div id="logoPreviewSmall" class="logo-preview-small">
        <span class="logo-preview-placeholder">Logo preview will appear here</span>
      </div>
      <div id="clearLogoBtn" class="clear-logo-btn hidden" onclick="clearLogo()">Remove Logo</div>
    </div>
    
    <!-- Accent Color Section -->
    <div class="theme-section-title" style="margin-top: 16px;">Accent Color</div>
    <div class="color-swatches">
      <div onclick="setAccentColor('mint')" class="color-swatch swatch-mint" data-accent="mint" title="Mint"></div>
      <div onclick="setAccentColor('blue')" class="color-swatch swatch-blue" data-accent="blue" title="Blue"></div>
      <div onclick="setAccentColor('purple')" class="color-swatch swatch-purple" data-accent="purple" title="Purple"></div>
      <div onclick="setAccentColor('rainbow')" class="color-swatch swatch-rainbow" data-accent="rainbow" title="Rainbow"></div>
      <div onclick="setAccentColor('orange')" class="color-swatch swatch-orange" data-accent="orange" title="Orange"></div>
      <div onclick="setAccentColor('cyan')" class="color-swatch swatch-cyan" data-accent="cyan" title="Cyan"></div>
      <div onclick="setAccentColor('gold')" class="color-swatch swatch-gold" data-accent="gold" title="Gold"></div>
      <div onclick="setAccentColor('slate')" class="color-swatch swatch-slate" data-accent="slate" title="Slate"></div>
      <div onclick="setAccentColor('lime')" class="color-swatch swatch-lime" data-accent="lime" title="Forest"></div>
      <div onclick="setAccentColor('teal')" class="color-swatch swatch-teal" data-accent="teal" title="Navy"></div>
      <div onclick="setAccentColor('pink')" class="color-swatch swatch-pink" data-accent="pink" title="Burgundy"></div>
      <div onclick="setAccentColor('indigo')" class="color-swatch swatch-indigo" data-accent="indigo" title="Steel"></div>
    </div>
    
    <!-- Reset Button -->
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
      <button onclick="resetBrandKit()" class="w-full text-xs font-semibold py-2 px-3 rounded-lg transition-all" style="color: var(--text-muted); background: var(--bg-option-card);" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Reset Theme
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast fixed bottom-6 right-6 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3" style="background: var(--bg-card);">
    <div class="p-1.5 rounded-full" style="background: rgba(var(--accent-rgb), 0.2);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" style="color: var(--accent);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
    </div>
    <span id="toastMessage" class="font-semibold text-sm">Success!</span>
  </div>

  <script>
    // ============================================
    // UTILITIES
    // ============================================
    const $ = (id) => document.getElementById(id);
    const $$ = (s) => document.querySelectorAll(s);
    const formatCurrency = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n);
    const parseNumber = (v) => parseFloat(v.toString().replace(/[\$,]/g, '')) || 0;
    const formatNumber = (n) => new Intl.NumberFormat('en-US').format(n);
    const getLetter = (i) => String.fromCharCode(65 + i);
    
    // Safe classList helpers - prevent null reference errors
    const addClass = (id, className) => { const el = $(id); if (el) el.classList.add(className); };
    const removeClass = (id, className) => { const el = $(id); if (el) el.classList.remove(className); };
    const toggleClass = (id, className, force) => { const el = $(id); if (el) el.classList.toggle(className, force); };
    const hasClass = (id, className) => { const el = $(id); return el ? el.classList.contains(className) : false; };
    
    // APR Calculation Functions
    function calculateMCAapr(amount, factor, termMonths, frequency, origFeePct = 0) {
      const payback = amount * factor;
      const origFee = amount * (origFeePct / 100);
      const netFunding = amount - origFee;
      const paymentsPerMonth = frequency === 'daily' ? 21 : (frequency === 'weekly' ? 4.33 : 1);
      const totalPayments = termMonths * paymentsPerMonth;
      const payment = payback / totalPayments;
      let rate = 0.1 / 12;
      for (let i = 0; i < 100; i++) {
        let pv = 0, dpv = 0;
        for (let t = 1; t <= totalPayments; t++) {
          pv += payment / Math.pow(1 + rate, t);
          dpv -= t * payment / Math.pow(1 + rate, t + 1);
        }
        const diff = pv - netFunding;
        if (Math.abs(diff) < 0.01) break;
        rate = rate - diff / dpv;
        if (rate < 0) rate = 0.001;
      }
      return Math.max(0, rate * paymentsPerMonth * 12 * 100);
    }
    
    function calculateLoanAPR(principal, annualRate, termMonths, origFeePct = 0) {
      const origFee = principal * (origFeePct / 100);
      const netFunding = principal - origFee;
      const monthlyRate = annualRate / 100 / 12;
      const payment = principal * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / (Math.pow(1 + monthlyRate, termMonths) - 1);
      let rate = monthlyRate;
      for (let i = 0; i < 100; i++) {
        let pv = 0, dpv = 0;
        for (let t = 1; t <= termMonths; t++) {
          pv += payment / Math.pow(1 + rate, t);
          dpv -= t * payment / Math.pow(1 + rate, t + 1);
        }
        const diff = pv - netFunding;
        if (Math.abs(diff) < 0.01) break;
        rate = rate - diff / dpv;
        if (rate < 0) rate = 0.001;
      }
      return Math.max(0, rate * 12 * 100);
    }
    
    // Calculate effective APR for Line of Credit (considering origination fee over 12-month period)
    function calculateLOCAPR(creditLimit, drawnAmount, annualRate, origFeePct = 0) {
      if (drawnAmount <= 0) return annualRate;
      const origFee = creditLimit * (origFeePct / 100);
      const effectiveRate = annualRate;
      // APR includes origination fee spread over assumed 12-month utilization period
      const feeImpact = (origFee / drawnAmount) * 100;
      return effectiveRate + feeImpact;
    }
    
    // Loan Requirements Data
    const documentInfo = {
      // Application Documents
      'Business bank statements (3-4 months)': {
        description: 'Complete statements from your primary business checking account showing deposits, withdrawals, and ending balances.',
        acceptable: ['PDF downloads from online banking', 'Scanned paper statements', 'All pages including blank pages', 'Must be consecutive months', 'No screenshots or partial statements']
      },
      'Business bank statements (4-6 months)': {
        description: 'Complete statements from your primary business checking account showing deposits, withdrawals, and ending balances.',
        acceptable: ['PDF downloads from online banking', 'Scanned paper statements', 'All pages required', 'Must be consecutive months']
      },
      'Business bank statements (6 months)': {
        description: 'Complete statements from your primary business checking account. All pages required.',
        acceptable: ['PDF downloads from online banking', 'Scanned paper statements', 'All pages including those with no transactions']
      },
      'Business bank statements (6-12 months)': {
        description: 'Complete statements from all business bank accounts. Longer history may be required for larger loan amounts.',
        acceptable: ['PDF downloads from online banking', 'Scanned paper statements', 'Statements from all business accounts']
      },
      'Business bank statements (3 months)': {
        description: 'Most recent 3 complete monthly statements from your primary business account.',
        acceptable: ['PDF downloads from online banking', 'Scanned paper statements', 'Must be most recent 3 months']
      },
      'Bank statements (6-12 months)': {
        description: 'Complete statements from all business bank accounts showing cash flow patterns.',
        acceptable: ['PDF downloads from online banking', 'Scanned paper statements', 'All business accounts required']
      },
      'Valid government ID': {
        description: 'Government-issued photo identification. Must be current and not expired. Required for all owners with 20%+ ownership.',
        acceptable: ['State-issued driver\'s license', 'State ID card', 'US Passport', 'US Passport Card', 'Military ID', 'Permanent Resident Card (Green Card)']
      },
      'Valid ID': {
        description: 'Government-issued photo identification. Must be current and not expired.',
        acceptable: ['Driver\'s license', 'State ID card', 'Passport', 'Military ID']
      },
      'Voided business check': {
        description: 'A check from your business account marked "VOID" across the front. Used to verify account and routing numbers for ACH.',
        acceptable: ['Physical check with VOID written across front', 'Counter check from bank with account info', 'Bank letter with routing and account numbers', 'Direct deposit form from bank']
      },
      'Business license or EIN letter': {
        description: 'Documentation proving legal business registration.',
        acceptable: ['State business license', 'City/county business license', 'IRS EIN confirmation letter (CP575)', 'IRS 147C letter', 'Certificate of Formation', 'Articles of Incorporation']
      },
      'Proof of ownership': {
        description: 'Documentation showing ownership percentages of the business.',
        acceptable: ['Articles of Incorporation', 'Operating Agreement (for LLCs)', 'Partnership Agreement', 'Stock certificates', 'Shareholder agreement', 'DBA/Fictitious name certificate (sole proprietors)']
      },
      'Proof of business ownership': {
        description: 'Documentation showing ownership percentages of the business.',
        acceptable: ['Articles of Incorporation', 'Operating Agreement', 'Partnership Agreement', 'DBA certificate', 'Shareholder agreement']
      },
      'Business tax returns (1-2 years)': {
        description: 'Complete business tax returns including all schedules.',
        acceptable: ['Form 1120 (C-Corp)', 'Form 1120S (S-Corp)', 'Form 1065 (Partnership)', 'Schedule C (Sole Proprietor)', 'All schedules and K-1s if applicable']
      },
      'Business tax returns (2-3 years)': {
        description: 'Complete business tax returns with all schedules and K-1s if applicable.',
        acceptable: ['Form 1120 (C-Corp)', 'Form 1120S (S-Corp)', 'Form 1065 (Partnership)', 'Schedule C (Sole Proprietor)', 'All schedules, K-1s, and amended returns']
      },
      'Business tax returns (3 years)': {
        description: 'Three years of complete business tax returns.',
        acceptable: ['Form 1120 (C-Corp)', 'Form 1120S (S-Corp)', 'Form 1065 (Partnership)', 'Schedule C (Sole Proprietor)', 'All schedules, K-1s, and amended returns']
      },
      'Personal tax returns (2 years)': {
        description: 'Personal tax returns for all owners with 20%+ ownership.',
        acceptable: ['Form 1040 with all schedules', 'W-2s', 'All pages and attachments', 'Signed or unsigned accepted']
      },
      'Personal tax returns (3 years)': {
        description: 'Three years of personal tax returns for all guarantors.',
        acceptable: ['Form 1040 with all schedules', 'W-2s', 'All pages and attachments', 'IRS transcripts also accepted']
      },
      'Financial statements (P&L, Balance Sheet)': {
        description: 'Year-to-date financial statements. Must be within 90 days.',
        acceptable: ['CPA-prepared statements', 'Internally generated statements', 'QuickBooks reports', 'Xero reports', 'Year-to-date P&L', 'Current Balance Sheet']
      },
      'Personal financial statement': {
        description: 'Statement showing personal assets, liabilities, and net worth for all guarantors.',
        acceptable: ['SBA Form 413', 'Lender-provided PFS form', 'Bank personal financial statement form']
      },
      'Use of funds statement': {
        description: 'Detailed explanation of how loan proceeds will be used.',
        acceptable: ['Written narrative of fund usage', 'Itemized budget breakdown', 'Quotes for equipment/inventory', 'Must match stated loan purpose']
      },
      'A/R aging (if applicable)': {
        description: 'Accounts receivable aging report if factoring or using receivables as collateral.',
        acceptable: ['QuickBooks A/R aging report', 'Accounting software export', 'Excel spreadsheet with customer detail']
      },
      'A/R aging report': {
        description: 'Current accounts receivable aging showing customer names, invoice amounts, and days outstanding.',
        acceptable: ['QuickBooks A/R aging summary', 'Accounting software export', 'Must show 30/60/90+ day buckets', 'Customer names required']
      },
      'Sample invoices': {
        description: 'Examples of typical invoices you issue to customers.',
        acceptable: ['PDF copies of recent invoices', 'Must show payment terms', 'Must include customer contact info', '3-5 sample invoices typically required']
      },
      'Customer list with contact info': {
        description: 'List of customers whose invoices will be factored.',
        acceptable: ['Excel spreadsheet', 'PDF list', 'Must include company name', 'Must include A/P contact', 'Phone and email required']
      },
      'Equipment quote or invoice': {
        description: 'Dealer quote or invoice for equipment being financed.',
        acceptable: ['Dealer invoice', 'Formal quote on dealer letterhead', 'Must include make/model/year', 'Serial number if used equipment', 'Delivery and installation costs']
      },
      'Equipment specifications': {
        description: 'Detailed specs including condition, age, and any required certifications.',
        acceptable: ['Manufacturer spec sheet', 'Dealer description', 'Photos of equipment', 'Condition report for used equipment']
      },
      'Property financials (rent roll, P&L)': {
        description: 'Current rent roll showing all tenants, lease terms, and rents. Trailing 12-month P&L for the property.',
        acceptable: ['Current rent roll', 'Copies of all leases', 'Trailing 12-month operating statement', 'Property tax bills', 'Insurance declarations']
      },
      'Purchase agreement or LOI': {
        description: 'Signed purchase agreement or Letter of Intent for property acquisition.',
        acceptable: ['Fully executed purchase agreement', 'Signed Letter of Intent', 'Must include purchase price', 'Must include contingencies and timeline']
      },
      'Environmental Phase I': {
        description: 'Phase I Environmental Site Assessment.',
        acceptable: ['Phase I ESA from qualified environmental professional', 'Must meet ASTM E1527 standards', 'Must be dated within 180 days', 'Phase II if recommended']
      },
      'Property appraisal': {
        description: 'MAI appraisal of the property.',
        acceptable: ['MAI appraisal', 'Must be ordered through lender', 'Yellow Book appraisal for SBA', 'Must be dated within 120 days']
      },
      'SBA Form 1919': {
        description: 'SBA Borrower Information Form.',
        acceptable: ['Completed SBA Form 1919', 'Required for all owners 20%+', 'Must be signed and dated']
      },
      'SBA Form 912': {
        description: 'Statement of Personal History.',
        acceptable: ['Completed SBA Form 912', 'Required for all owners, officers, directors', 'Required for key employees', 'Must disclose any criminal history']
      },
      'Business plan': {
        description: 'Comprehensive business plan including financial projections.',
        acceptable: ['Executive summary', 'Company description', 'Market analysis', '3-year financial projections', 'Management team bios']
      },
      'Debt schedule': {
        description: 'List of all current business debts.',
        acceptable: ['Excel spreadsheet', 'Must include creditor name', 'Current balance', 'Monthly payment', 'Interest rate', 'Maturity date']
      },
      // Closing Documents
      'Signed funding agreement': {
        description: 'The main contract outlining terms, rates, and repayment schedule.',
        acceptable: ['Wet signature', 'Electronic signature (DocuSign, etc.)', 'Must be signed by authorized signer', 'All pages initialed']
      },
      'Signed MCA agreement': {
        description: 'Merchant Cash Advance purchase agreement.',
        acceptable: ['Wet signature', 'Electronic signature', 'Must be signed by all owners 20%+']
      },
      'ACH authorization form': {
        description: 'Authorizes automatic debits from your business bank account for payments.',
        acceptable: ['Signed ACH authorization', 'Voided check attached', 'Must match bank statement account']
      },
      'Personal guarantee': {
        description: 'Personal guarantee from owners with 20%+ ownership.',
        acceptable: ['Signed personal guarantee', 'Spouse signature if in community property state', 'Notarization if required']
      },
      'Personal guarantee (if required)': {
        description: 'May be required based on business financials.',
        acceptable: ['Signed personal guarantee', 'May be limited or unlimited', 'Spousal consent if required']
      },
      'UCC-1 financing statement acknowledgment': {
        description: 'Acknowledgment of UCC-1 filing. Public notice of lender\'s security interest.',
        acceptable: ['Signed acknowledgment form', 'Understanding that lien will be filed', 'May require specific collateral description']
      },
      'UCC-1 filing acknowledgment': {
        description: 'Acknowledgment that a UCC-1 lien will be filed on business assets.',
        acceptable: ['Signed acknowledgment', 'Lists collateral covered']
      },
      'UCC-1 financing statement': {
        description: 'Public filing establishing lender\'s security interest in collateral.',
        acceptable: ['Completed UCC-1 form', 'Accurate debtor information', 'Collateral description']
      },
      'UCC-1 filing': {
        description: 'Uniform Commercial Code filing securing the lender\'s interest in receivables.',
        acceptable: ['Standard UCC-1 form', 'Filed with Secretary of State']
      },
      'UCC-1 filing (if secured)': {
        description: 'Required if line is secured by business assets or receivables.',
        acceptable: ['Standard UCC-1 form', 'Only required for secured facilities']
      },
      'Certificate of good standing': {
        description: 'From Secretary of State showing business is in good standing.',
        acceptable: ['Certificate from Secretary of State', 'Must be dated within 30-60 days', 'Also called Certificate of Existence', 'Certificate of Status']
      },
      'Signed loan agreement': {
        description: 'Master loan agreement outlining all terms and conditions.',
        acceptable: ['Wet signature', 'Electronic signature', 'All pages initialed', 'Corporate resolution attached']
      },
      'Signed promissory note': {
        description: 'Legal promise to repay the loan according to specified terms.',
        acceptable: ['Signed by authorized signer(s)', 'Corporate seal if required', 'Notarization if required']
      },
      'Security agreement': {
        description: 'Agreement pledging specific assets as collateral for the loan.',
        acceptable: ['Signed security agreement', 'Detailed collateral description', 'May require equipment schedule']
      },
      'Corporate resolution': {
        description: 'Board resolution authorizing the loan and designating authorized signers.',
        acceptable: ['Signed board resolution', 'Secretary certification', 'Lists authorized signers', 'Specifies loan amount']
      },
      'Insurance certificates': {
        description: 'Proof of business insurance with lender named as additional insured or loss payee.',
        acceptable: ['Certificate of Insurance (COI)', 'Lender named as additional insured', 'Loss payee endorsement', 'Must show coverage amounts']
      },
      'Line of credit agreement': {
        description: 'Master agreement for revolving credit facility.',
        acceptable: ['Signed credit agreement', 'Draw request procedures', 'Borrowing base certificate if ABL']
      },
      'Draw request procedures': {
        description: 'Instructions for requesting advances on the credit line.',
        acceptable: ['Signed acknowledgment of procedures', 'Draw request form template', 'Funding timeline']
      },
      'SBA authorization': {
        description: 'SBA loan authorization document with approved terms and conditions.',
        acceptable: ['SBA Authorization letter', 'Lists all conditions', 'Must be signed by borrower']
      },
      'Loan agreement': {
        description: 'Comprehensive loan agreement including all terms, covenants, and conditions.',
        acceptable: ['Signed loan agreement', 'All exhibits attached', 'Corporate authorization']
      },
      'Life insurance assignment': {
        description: 'Assignment of life insurance policy to lender as additional collateral.',
        acceptable: ['Collateral assignment form', 'Policy must cover loan amount', 'Lender named as beneficiary']
      },
      'Hazard insurance': {
        description: 'Property insurance with lender named as mortgagee/loss payee.',
        acceptable: ['Property insurance policy', 'Lender named as mortgagee', 'Coverage must meet lender requirements']
      },
      'Equipment loan agreement': {
        description: 'Financing agreement specific to equipment being purchased.',
        acceptable: ['Signed equipment finance agreement', 'Equipment schedule attached', 'Serial numbers listed']
      },
      'Equipment insurance': {
        description: 'Insurance covering the financed equipment with lender as loss payee.',
        acceptable: ['Equipment floater policy', 'Lender named as loss payee', 'Coverage equals equipment value']
      },
      'Deed of trust/mortgage': {
        description: 'Security instrument recorded against the property.',
        acceptable: ['Deed of Trust', 'Mortgage', 'Must be notarized', 'Recorded with county']
      },
      'Title insurance': {
        description: 'Lender\'s title insurance policy protecting against title defects.',
        acceptable: ['ALTA lender\'s policy', 'Coverage equals loan amount', 'All standard exceptions removed']
      },
      'Property insurance': {
        description: 'Property/casualty insurance with lender named as mortgagee.',
        acceptable: ['Property insurance policy', 'Lender named as mortgagee', 'Replacement cost coverage']
      },
      'Environmental indemnity': {
        description: 'Agreement protecting lender from environmental liability.',
        acceptable: ['Signed environmental indemnity agreement', 'Covers cleanup costs', 'Covers legal fees']
      },
      'Assignment of leases': {
        description: 'Assignment of rental income to lender as additional security.',
        acceptable: ['Signed assignment of leases and rents', 'Recorded with county', 'Tenant notification letters']
      },
      'ALTA survey': {
        description: 'Current ALTA/NSPS land title survey of the property.',
        acceptable: ['ALTA/NSPS survey', 'Certified to lender and title company', 'Must be dated within 90 days', 'Table A items as required']
      },
      'Factoring agreement': {
        description: 'Master agreement for ongoing invoice factoring arrangement.',
        acceptable: ['Signed factoring agreement', 'Schedule of fees', 'Recourse terms']
      },
      'Notice of assignment': {
        description: 'Notice sent to your customers informing them of invoice assignment.',
        acceptable: ['Letter on company letterhead', 'Directs payment to factor', 'Customer acknowledgment preferred']
      },
      'Promissory note': {
        description: 'Legal document evidencing the debt and repayment terms.',
        acceptable: ['Signed promissory note', 'States principal amount', 'States interest rate', 'States payment terms']
      }
    };
    
    const loanRequirements = {
      prequal: {
        criteria: [
          { label: 'Time in Business', value: '4+ months' },
          { label: 'Monthly Revenue', value: '$7,500+' },
          { label: 'Credit Score', value: '500+ (flexible)' },
          { label: 'Daily Balance', value: '$2,000+ avg' }
        ],
        applicationDocs: ['Business bank statements (3-4 months)', 'Valid government ID', 'Voided business check', 'Business license or EIN letter', 'Proof of ownership'],
        closingDocs: ['Signed funding agreement', 'ACH authorization form', 'Personal guarantee', 'UCC-1 financing statement acknowledgment', 'Certificate of good standing']
      },
      mca: {
        criteria: [
          { label: 'Time in Business', value: '4+ months' },
          { label: 'Monthly Revenue', value: '$10,000+' },
          { label: 'Credit Score', value: '500+ (flexible)' },
          { label: 'Daily Balance', value: '$2,000+ avg' }
        ],
        applicationDocs: ['Business bank statements (3-4 months)', 'Valid ID', 'Voided business check', 'Business license or EIN letter'],
        closingDocs: ['Signed MCA agreement', 'ACH authorization form', 'Personal guarantee (if required)', 'UCC-1 filing acknowledgment']
      },
      working: {
        criteria: [
          { label: 'Time in Business', value: '6+ months' },
          { label: 'Monthly Revenue', value: '$15,000+' },
          { label: 'Credit Score', value: '550+' },
          { label: 'No Open Bankruptcies', value: 'Required' }
        ],
        applicationDocs: ['Business bank statements (4-6 months)', 'Business tax returns (1-2 years)', 'Valid government ID', 'Proof of business ownership'],
        closingDocs: ['Signed loan agreement', 'Personal guarantee', 'ACH authorization', 'Certificate of good standing']
      },
      term: {
        criteria: [
          { label: 'Time in Business', value: '2+ years' },
          { label: 'Annual Revenue', value: '$100,000+' },
          { label: 'Credit Score', value: '650+' },
          { label: 'Profitability', value: 'Positive cash flow' }
        ],
        applicationDocs: ['Business tax returns (2-3 years)', 'Personal tax returns (2 years)', 'Bank statements (6-12 months)', 'Financial statements (P&L, Balance Sheet)', 'Use of funds statement'],
        closingDocs: ['Signed promissory note', 'Security agreement', 'Personal guarantee', 'Corporate resolution', 'Insurance certificates']
      },
      loc: {
        criteria: [
          { label: 'Time in Business', value: '1+ year' },
          { label: 'Annual Revenue', value: '$50,000+' },
          { label: 'Credit Score', value: '600+' },
          { label: 'Positive Cash Flow', value: 'Required' }
        ],
        applicationDocs: ['Business bank statements (6 months)', 'Business tax returns (1-2 years)', 'Personal financial statement', 'A/R aging (if applicable)'],
        closingDocs: ['Line of credit agreement', 'Draw request procedures', 'Personal guarantee', 'UCC-1 filing (if secured)']
      },
      sba: {
        criteria: [
          { label: 'Time in Business', value: '2+ years' },
          { label: 'Credit Score', value: '680+' },
          { label: 'No Defaults', value: 'On government loans' },
          { label: 'US Based', value: 'For-profit business' }
        ],
        applicationDocs: ['SBA Form 1919', 'SBA Form 912', 'Business tax returns (3 years)', 'Personal tax returns (3 years)', 'Financial statements', 'Business plan', 'Debt schedule'],
        closingDocs: ['SBA authorization', 'Promissory note', 'Loan agreement', 'Security agreement', 'Personal guarantee', 'Life insurance assignment', 'Hazard insurance']
      },
      equipment: {
        criteria: [
          { label: 'Time in Business', value: '1+ year' },
          { label: 'Credit Score', value: '600+' },
          { label: 'Equipment Type', value: 'New or used (< 10 yrs)' },
          { label: 'Down Payment', value: '0-20% typical' }
        ],
        applicationDocs: ['Equipment quote or invoice', 'Business bank statements (3 months)', 'Business tax returns (1-2 years)', 'Equipment specifications'],
        closingDocs: ['Equipment loan agreement', 'Security agreement', 'UCC-1 financing statement', 'Equipment insurance', 'Personal guarantee']
      },
      cre: {
        criteria: [
          { label: 'Time in Business', value: '2+ years' },
          { label: 'Credit Score', value: '680+' },
          { label: 'DSCR', value: '1.25x minimum' },
          { label: 'LTV', value: '75-80% max' }
        ],
        applicationDocs: ['Property financials (rent roll, P&L)', 'Purchase agreement or LOI', 'Environmental Phase I', 'Property appraisal', 'Tax returns (3 years)', 'Personal financial statement'],
        closingDocs: ['Promissory note', 'Deed of trust/mortgage', 'Title insurance', 'Property insurance', 'Environmental indemnity', 'Assignment of leases', 'ALTA survey']
      },
      factoring: {
        criteria: [
          { label: 'Invoice Type', value: 'B2B invoices only' },
          { label: 'Customer Credit', value: 'Creditworthy clients' },
          { label: 'Invoice Age', value: 'Under 90 days' },
          { label: 'Minimum Volume', value: '$10,000/month' }
        ],
        applicationDocs: ['A/R aging report', 'Sample invoices', 'Customer list with contact info', 'Business bank statements (3 months)'],
        closingDocs: ['Factoring agreement', 'Notice of assignment', 'UCC-1 filing', 'Personal guarantee']
      }
    };
    
    function renderInputRequirements(type) {
      const req = loanRequirements[type];
      if (!req) return '';
      
      return `
        <div class="rounded-2xl p-5 mt-4 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
          <label class="text-xs font-bold uppercase tracking-wide block mb-4" style="color: var(--text-muted);">Minimum Requirements</label>
          <div class="space-y-3">
            ${req.criteria.map(c => `
              <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
                <span class="text-sm" style="color: var(--text-secondary);">${c.label}</span>
                <span class="text-sm font-bold" style="color: var(--accent);">${c.value}</span>
              </div>
            `).join('')}
          </div>
        </div>`;
    }
    
    function renderRequirementsSection(type) {
      const req = loanRequirements[type];
      if (!req) return '';
      
      const renderDocItem = (doc) => {
        const hasInfo = documentInfo[doc] ? true : false;
        const infoBtn = hasInfo ? `
          <button onclick="showDocInfo(this)" data-doc="${doc.replace(/"/g, '&quot;')}" class="doc-info-btn" title="More info">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke-width="2"/>
              <path stroke-linecap="round" stroke-width="2" d="M12 16v-4M12 8h.01"/>
            </svg>
          </button>` : '';
        return `
          <div class="flex items-center gap-2 py-2 doc-item">
            <svg class="w-4 h-4 flex-shrink-0" style="color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span class="text-xs flex-1" style="color: var(--text-secondary);">${doc}</span>
            ${infoBtn}
          </div>`;
      };
      
      return `
        <div class="calc-requirements-section mt-6 p-6">
          <div class="flex items-center gap-3 mb-4">
            <div class="section-indicator"></div>
            <h3 class="section-title">Requirements</h3>
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            ${req.criteria.map(c => `
              <div class="p-4 rounded-xl" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
                <div class="text-[10px] font-bold uppercase tracking-wide mb-1" style="color: var(--text-muted);">${c.label}</div>
                <div class="text-sm font-semibold" style="color: var(--accent);">${c.value}</div>
              </div>
            `).join('')}
          </div>
          <div class="space-y-2">
            <button onclick="toggleDocsSection('${type}-app-docs')" class="w-full flex items-center justify-between p-4 rounded-xl transition-all" style="background: var(--bg-toggle); border: 1px solid var(--border-secondary);">
              <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-secondary);">Application Documents</span>
              <svg class="w-4 h-4 transition-transform" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="${type}-app-docs" class="hidden pl-3 pr-2 pb-3">
              ${req.applicationDocs.map(d => renderDocItem(d)).join('')}
            </div>
            <button onclick="toggleDocsSection('${type}-close-docs')" class="w-full flex items-center justify-between p-4 rounded-xl transition-all" style="background: var(--bg-toggle); border: 1px solid var(--border-secondary);">
              <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-secondary);">Closing Documents</span>
              <svg class="w-4 h-4 transition-transform" style="color: var(--text-muted);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="${type}-close-docs" class="hidden pl-3 pr-2 pb-3">
              ${req.closingDocs.map(d => renderDocItem(d)).join('')}
            </div>
          </div>
        </div>`;
    }
    
    function showDocInfo(btn) {
      const docName = btn.getAttribute('data-doc');
      const docData = documentInfo[docName];
      if (!docData) return;
      
      // Parse acceptable items from the description
      const acceptable = docData.acceptable || [];
      const description = docData.description || docData;
      
      // Create or update tooltip modal
      let modal = document.getElementById('docInfoModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'docInfoModal';
        modal.className = 'doc-info-modal';
        modal.innerHTML = `
          <div class="doc-info-backdrop" onclick="closeDocInfo()"></div>
          <div class="doc-info-content">
            <div class="doc-info-header">
              <h4 id="docInfoTitle"></h4>
              <button onclick="closeDocInfo()" class="doc-info-close">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
            <p id="docInfoDesc"></p>
            <div id="docInfoAcceptable"></div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      
      document.getElementById('docInfoTitle').textContent = docName;
      document.getElementById('docInfoDesc').textContent = description;
      
      const acceptableDiv = document.getElementById('docInfoAcceptable');
      if (acceptable.length > 0) {
        acceptableDiv.innerHTML = `
          <div class="doc-acceptable-title">Acceptable Documents:</div>
          <ul class="doc-acceptable-list">
            ${acceptable.map(item => `<li>${item}</li>`).join('')}
          </ul>
        `;
      } else {
        acceptableDiv.innerHTML = '';
      }
      
      modal.classList.add('active');
    }
    
    function closeDocInfo() {
      const modal = document.getElementById('docInfoModal');
      if (modal) modal.classList.remove('active');
    }
    
    function toggleDocsSection(id) {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('hidden');
    }
    
    // Animate number spin up
    function animateNumber(element, targetValue, duration = 1500, formatter = formatCurrency) {
        const startValue = 0;
        const startTime = performance.now();
        const isInteger = Number.isInteger(targetValue);
        
        function easeOutExpo(t) {
            return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
        }
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easedProgress = easeOutExpo(progress);
            let currentValue = startValue + (targetValue - startValue) * easedProgress;
            
            // Only round for integer targets (amounts, counts), preserve decimals for factors
            if (isInteger) currentValue = Math.round(currentValue);
            
            element.textContent = formatter(currentValue);
            
            if (progress < 1) {
                requestAnimationFrame(update);
            }
        }
        
        requestAnimationFrame(update);
    }

    // ============================================
    // ABLESCORE v4.1 CREDIT ENGINE
    // ============================================
    class PerrepusAI_v4_1 {
      constructor(data) {
        // INPUT SANITIZATION & NORMALIZATION
        this.app = {
          monthlyRevenue: this.parseMoney(data.monthlyRevenue),
          avgDailyBalance: this.parseMoney(data.avgDailyBalance),
          creditScore: Number(data.creditScore) || 0,
          monthsInBusiness: Number(data.monthsInBusiness) || 0,
          depositCount: Number(data.depositCount) || 0,
          nsfCount: Number(data.nsfCount) || 0,     
          negativeDays: Number(data.negativeDays) || 0,
          industry: data.industry || 'General',      
          isRestricted: data.isRestricted || false    
        };

        // GLOBAL CONFIGURATION
        this.CONFIG = {
          LIMITS: { 
            MIN_REVENUE: 7500,
            MIN_FICO: 500,
            MAX_RISK_EVENTS: 10,
            MIN_LOAN: 10000,
            MAX_LOAN: 1000000 
          },

          FEES: { 
            ORIGINATION: 0.03,
            ADMIN: 995.00,
            WIRE: 50.00
          },

          WEIGHTS: {
            CREDIT: 30,
            BEHAVIOR: 30,
            REVENUE: 20,
            STABILITY: 10,
            BUFFER: 10
          },

          TIERS: {
            A: { id: 'A', minScore: 80, range: [1.10, 1.19], term: 12, holdback: 0.12, ltv: 1.25, balMult: 6.0, label: "Prime (Tier A)", risk: null },
            B: { id: 'B', minScore: 65, range: [1.20, 1.29], term: 10, holdback: 0.15, ltv: 1.00, balMult: 4.0, label: "Standard (Tier B)", risk: null },
            C: { id: 'C', minScore: 50, range: [1.30, 1.39], term: 9,  holdback: 0.20, ltv: 0.85, balMult: 3.0, label: "Mid-Prime (Tier C)", risk: null },
            D: { id: 'D', minScore: 35, range: [1.40, 1.54], term: 6,  holdback: 0.25, ltv: 0.70, balMult: 2.5, label: "⚠ Elevated Risk (Tier D)", risk: "elevated" },
            E: { id: 'E', minScore: 0,  range: [1.55, 1.69], term: 4,  holdback: 0.30, ltv: 0.60, balMult: 1.5, label: "⚠ High Risk (Tier E)", risk: "high" }
          }
        };
      }

      parseMoney(val) {
        if (typeof val === 'number') return val;
        return parseFloat(String(val).replace(/[^0-9.-]+/g, "")) || 0;
      }

      round(num) { 
        return Math.round((num + Number.EPSILON) * 100) / 100; 
      }

      toUSD(num, showCents = true) { 
        return new Intl.NumberFormat('en-US', { 
          style: 'currency', 
          currency: 'USD', 
          minimumFractionDigits: showCents ? 2 : 0,
          maximumFractionDigits: showCents ? 2 : 0 
        }).format(num); 
      }

      calculateScore() {
        const a = this.app;
        const w = this.CONFIG.WEIGHTS;
        let score = 0;
        let reasons = [];

        // CREDIT (30 Pts)
        let creditPts = 0;
        if (a.creditScore < 500) reasons.push("FICO below 500");
        else creditPts = Math.min(30, ((a.creditScore - 500) / 300) * w.CREDIT);
        score += creditPts;

        // BEHAVIOR (30 Pts)
        const events = a.nsfCount + a.negativeDays;
        let behavePts = 0;
        if (events > 10) reasons.push("Excessive Risk Events (>10)");
        else behavePts = Math.max(0, w.BEHAVIOR - (events * 3));
        score += behavePts;

        // REVENUE (20 Pts)
        let revPts = 0;
        if (a.monthlyRevenue < 7500) reasons.push("Revenue below $7.5k");
        else revPts = Math.min(20, ((a.monthlyRevenue - 7500) / 92500) * w.REVENUE);
        score += revPts;

        // STABILITY (10 Pts)
        if (a.monthsInBusiness >= 36) score += 10;
        else if (a.monthsInBusiness >= 24) score += 7;
        else if (a.monthsInBusiness >= 12) score += 4;
        else score += 1;

        // BUFFER (10 Pts)
        const buffer = a.avgDailyBalance / a.monthlyRevenue;
        if (buffer >= 0.10) score += 10;
        else if (buffer >= 0.05) score += 5;
        
        // RESTRICTED INDUSTRY PENALTY
        if (a.isRestricted) {
            score -= 15;
            reasons.push("Restricted Industry Penalty");
        }

        return { 
          total: Math.floor(score), 
          reasons, 
          riskEvents: events 
        };
      }

      getStips(tierId) {
        const base = ["Driver's License", "Voided Check", "3 Months Bank Statements"];
        
        if (tierId === 'C') {
            return [...base, "Proof of Ownership", "Landlord Contact"];
        }
        if (tierId === 'D' || tierId === 'E') {
            return [...base, "Proof of Ownership", "Landlord Contact", "Decision Logic (Bank Login)", "Tax Return (Page 1)"];
        }
        return base;
      }

      process() {
        const C = this.CONFIG;
        
        // KNOCKOUTS
        if (this.app.monthlyRevenue < C.LIMITS.MIN_REVENUE) return { status: "DECLINED", reason: "Revenue Below Minimum" };
        if (this.app.creditScore < C.LIMITS.MIN_FICO) return { status: "DECLINED", reason: "FICO Below 500" };
        
        const { total, reasons, riskEvents } = this.calculateScore();
        if (riskEvents > C.LIMITS.MAX_RISK_EVENTS) return { status: "DECLINED", reason: "Excessive Risk Events (>10)" };

        // TIER ASSIGNMENT
        const T = C.TIERS;
        let Tier;
        if (total >= T.A.minScore) Tier = T.A;
        else if (total >= T.B.minScore) Tier = T.B;
        else if (total >= T.C.minScore) Tier = T.C;
        else if (total >= T.D.minScore) Tier = T.D;
        else Tier = T.E;

        // SAFETY VALVES
        if (this.app.creditScore < 600 && (Tier.id === 'A' || Tier.id === 'B')) {
            Tier = T.C;
            reasons.push("Safety Valve: FICO < 600");
        }
        if (this.app.creditScore < 550 && Tier.id !== 'E') {
            Tier = T.D;
            reasons.push("Safety Valve: FICO < 550");
        }
        if (this.app.creditScore < 520) {
            Tier = T.E;
            reasons.push("Safety Valve: FICO < 520");
        }

        // RATE INTERPOLATION
        const tierSpan = 15;
        const scoreInTier = Math.max(0, total - Tier.minScore);
        const ratio = Math.min(1, scoreInTier / tierSpan);
        const spread = Tier.range[1] - Tier.range[0];
        const factorRate = Number((Tier.range[1] - (spread * ratio)).toFixed(4));

        // TRIPLE-CONSTRAINT SIZING
        const capRevenue = this.app.monthlyRevenue * Tier.ltv;

        let capBalance = this.app.avgDailyBalance * Tier.balMult;
        
        // CASH FLOW OVERRIDE
        if (Tier.id === 'D' || Tier.id === 'E') {
          const flowFloor = this.app.monthlyRevenue * 0.25;
          if (capBalance < flowFloor) capBalance = flowFloor;
        }

        const dailyRev = this.app.monthlyRevenue / 21;
        const maxDailyPmt = dailyRev * Tier.holdback;
        const termDays = Tier.term * 21;
        const maxPayback = maxDailyPmt * termDays;
        const capCapacity = maxPayback / factorRate;

        // FINALIZE FUNDING
        let rawAmount = Math.min(capRevenue, capBalance, capCapacity);
        rawAmount = Math.min(rawAmount, C.LIMITS.MAX_LOAN);
        let approvedAmount = Math.floor(rawAmount / 500) * 500;

        if (approvedAmount < C.LIMITS.MIN_LOAN) {
          return { 
            status: "DECLINED", 
            reason: `Qualified Amount (${this.toUSD(approvedAmount, false)}) < $10k Minimum`, 
            score: total, 
            tier: Tier.id 
          };
        }

        // FINANCIALS
        const totalPayback = this.round(approvedAmount * factorRate);
        const dailyPmt = this.round(totalPayback / termDays);
        const weeklyPmt = this.round(dailyPmt * 5);
        
        const origination = this.round(approvedAmount * C.FEES.ORIGINATION);
        const netWire = this.round(approvedAmount - origination - C.FEES.ADMIN - C.FEES.WIRE);
        const actualHoldback = ((dailyPmt / dailyRev) * 100).toFixed(2);

        return {
          status: "APPROVED",
          score: { 
              value: total, 
              tier: Tier.label,
              tierId: Tier.id,
              breakdown: reasons.length ? reasons : ["Strong Profile"]
          },
          offer: {
            funding_amount: approvedAmount,
            factor_rate: factorRate,
            payback_amount: totalPayback,
            term: Tier.term,
            term_label: `${Tier.term} Months`,
            payment_count: termDays
          },
          schedule: {
            frequency: "Daily (M-F)",
            daily_payment: dailyPmt,
            weekly_payment: weeklyPmt,
            holdback: actualHoldback,
            holdback_limit: Tier.holdback * 100
          },
          closing: {
            gross_amount: approvedAmount,
            fees: {
              origination: origination,
              admin: C.FEES.ADMIN,
              wire: C.FEES.WIRE
            },
            net_wire: netWire,
            required_stips: this.getStips(Tier.id)
          }
        };
      }
    }

    // ============================================
    // THEME MANAGEMENT
    // ============================================
    let currentTheme = 'black';
    let currentAccent = 'rainbow';
    let currentLogoUrl = '';
    let currentCompanyName = '';
    let currentClientMode = 'iso';
    let lenderBuyRate = 1.15;
    let lenderMaxSellRate = 1.25;

    // Mobile collapsible sections
    function toggleMobileSection(cardId) {
        // Only toggle on mobile
        if (window.innerWidth > 768) return;
        
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.toggle('collapsed');
        }
    }
    
    // Initialize mobile sections on load
    function initMobileSections() {
        if (window.innerWidth <= 768) {
            // Keep Structure Offer expanded by default on mobile
            const structureCard = document.getElementById('structureOfferCard');
            if (structureCard) {
                structureCard.classList.remove('collapsed');
            }
        }
    }
    
    // Re-check on resize
    window.addEventListener('resize', function() {
        const collapsibles = document.querySelectorAll('.mobile-collapsible');
        if (window.innerWidth > 768) {
            // Remove collapsed class on desktop
            collapsibles.forEach(el => el.classList.remove('collapsed'));
        }
    });

    // ============================================
    // LENDER LOCK SYSTEM (Per-Option)
    // ============================================
    
    function lockTerms() {
        // Save current option state first (captures current rates for this option)
        saveState(activeCalcTab);
        
        // Lock ALL options with their INDIVIDUAL stored rates
        const lockedSummary = [];
        calcOptions.forEach((opt, i) => {
            // Use this option's stored rates, or fall back to defaults
            const optBuyRate = opt.buyRate || 1.15;
            const optMaxSell = opt.maxSell || 1.25;
            
            console.log('Locking option', i, '- buyRate:', optBuyRate, 'maxSell:', optMaxSell);
            
            opt.locked = true;
            opt.lockedAmount = opt.amount;
            opt.lockedTerm = opt.term;
            opt.lockedFrequency = opt.frequency;
            opt.lockedBuyRate = optBuyRate;
            opt.lockedMaxSell = optMaxSell;
            lockedSummary.push(`${getLetter(i)}: $${formatNumber(opt.amount)} @${optMaxSell.toFixed(2)}`);
        });
        
        console.log('All options after locking:', JSON.stringify(calcOptions.map(o => ({locked: o.locked, lb: o.lockedBuyRate, lm: o.lockedMaxSell}))));
        
        // Track lender lock event
        window.lenderLocked = true;
        updateModeStatusIcons();
        
        // Update tracking for existing offer if link exists
        const currentLink = getLink();
        updateOfferTrackingByLink(currentLink, 'lenderLock');
        
        updateLockButtonState();
        updateHeaderLockIndicator();
        updateTabsUI();
        updateLockToggleUI();
        
        showToast(`Locked: ${lockedSummary.join(', ')}`);
    }
    
    function unlockTerms() {
        // Unlock ALL options
        calcOptions.forEach((opt) => {
            opt.locked = false;
            opt.lockedAmount = null;
            opt.lockedTerm = null;
            opt.lockedFrequency = null;
            opt.lockedBuyRate = null;
            opt.lockedMaxSell = null;
        });
        
        // Reset sliders to full range
        const amountSlider = $('calcAmountSlider');
        const termSlider = $('calcTermSlider');
        const buyRateSlider = $('lenderBuyRateSlider');
        const maxSellSlider = $('lenderMaxSellSlider');
        if (amountSlider) { amountSlider.max = 1000000; updateSliderFill(amountSlider); }
        if (termSlider) { termSlider.max = 520; updateSliderFill(termSlider); }
        if (buyRateSlider) updateSliderFill(buyRateSlider);
        if (maxSellSlider) updateSliderFill(maxSellSlider);
        
        // Unlock all frequency buttons
        const dailyBtn = document.querySelector('.toggle-btn[data-freq="daily"]');
        const weeklyBtn = document.querySelector('.toggle-btn[data-freq="weekly"]');
        const monthlyBtn = document.querySelector('.toggle-btn[data-freq="monthly"]');
        [dailyBtn, weeklyBtn, monthlyBtn].forEach(btn => {
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
        
        updateLockButtonState();
        updateHeaderLockIndicator();
        updateTabsUI();
        updateLockToggleUI();
        showToast(`All options unlocked`);
    }
    
    function toggleTermsLock() {
        const opt = calcOptions[activeCalcTab];
        if (opt && opt.locked) unlockTerms();
        else lockTerms();
    }
    
    function updateLockButtonState() {
        const lockBtn = $('lockTermsBtn');
        if (!lockBtn) return;
        
        const opt = calcOptions[activeCalcTab];
        const isLocked = opt && opt.locked;
        
        if (isLocked) {
            let freqLabel = opt.lockedFrequency === 'weekly' ? 'Wk' : opt.lockedFrequency === 'monthly' ? 'Mo' : 'D';
            lockBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span>LOCKED: $${formatNumber(opt.lockedAmount)} / ${opt.lockedTerm}d / ${freqLabel}</span>
            `;
            lockBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            lockBtn.style.border = '2px solid #10b981';
            lockBtn.style.boxShadow = '0 0 25px rgba(16, 185, 129, 0.4)';
            lockBtn.onclick = unlockTerms;
        } else {
            lockBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                </svg>
                <span>Lock Option ${getLetter(activeCalcTab)} for ISO</span>
            `;
            lockBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            lockBtn.style.border = '2px solid #f59e0b';
            lockBtn.style.boxShadow = '0 0 20px rgba(245, 158, 7, 0.3)';
            lockBtn.onclick = lockTerms;
        }
    }
    
    function updateHeaderLockIndicator() {
        // Just update the mode status icons (gold lock on Lender button)
        updateModeStatusIcons();
    }
    
    function updateLockToggleUI() {
        const lockShareBtn = $('lockShareISOBtn');
        const lockShareText = $('lockShareISOText');
        const unlockBtn = $('unlockISOBtn');
        const buyRateSlider = $('lenderBuyRateSlider');
        const buyRateInput = $('lenderBuyRate');
        const maxSellSlider = $('lenderMaxSellSlider');
        const maxSellInput = $('lenderMaxSell');
        
        // Check if any option is locked
        const isLocked = calcOptions.some(o => o && o.locked);
        const lockedCount = calcOptions.filter(o => o && o.locked).length;
        
        if (isLocked) {
            // Update lock/share button to show locked state
            if (lockShareBtn) {
                lockShareBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                lockShareBtn.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)';
            }
            if (lockShareText) {
                lockShareText.textContent = `✓ Locked (${lockedCount} Option${lockedCount > 1 ? 's' : ''}) - Share Again`;
            }
            
            // Show unlock button
            if (unlockBtn) {
                unlockBtn.classList.remove('hidden');
            }
            
            // Disable rate inputs (locked rates)
            [buyRateSlider, buyRateInput, maxSellSlider, maxSellInput].forEach(el => {
                if (el) {
                    el.disabled = true;
                    el.style.opacity = '0.5';
                    el.style.cursor = 'not-allowed';
                }
            });
            
            // Disable tier buttons
            document.querySelectorAll('.tier-preset-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        } else {
            // Reset button to default state
            if (lockShareBtn) {
                lockShareBtn.style.background = 'var(--accent)';
                lockShareBtn.style.boxShadow = 'none';
            }
            if (lockShareText) {
                lockShareText.textContent = 'Lock and Share with ISO';
            }
            
            // Hide unlock button
            if (unlockBtn) {
                unlockBtn.classList.add('hidden');
            }
            
            // Enable rate inputs
            [buyRateSlider, buyRateInput, maxSellSlider, maxSellInput].forEach(el => {
                if (el) {
                    el.disabled = false;
                    el.style.opacity = '1';
                    el.style.cursor = '';
                }
            });
            
            // Enable tier buttons
            document.querySelectorAll('.tier-preset-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        }
    }
    
    // Track sharing/viewing states (use window scope for persistence)
    window.isoLinkShared = window.isoLinkShared || false;
    window.isoViewed = window.isoViewed || false;
    window.clientLinkShared = window.clientLinkShared || false;
    window.clientEmailShared = window.clientEmailShared || false;
    window.clientViewed = window.clientViewed || false;
    window.clientAccepted = window.clientAccepted || false;
    
    function updateModeStatusIcons() {
        const lenderIcon = $('lenderStatusIcon');
        const isoIcon = $('isoStatusIcon');
        const clientIcon = $('clientStatusIcon');
        
        // Lender: Gold lock when any option is locked
        const isLocked = calcOptions.some(o => o && o.locked);
        if (lenderIcon) {
            if (isLocked) {
                lenderIcon.classList.remove('hidden');
                lenderIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #f59e0b;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>`;
            } else {
                lenderIcon.classList.add('hidden');
            }
        }
        
        // ISO: Priority order - Viewed (green eye) > Shared (blue share)
        if (isoIcon) {
            if (window.isoViewed) {
                isoIcon.classList.remove('hidden');
                isoIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>`;
            } else if (window.isoLinkShared) {
                isoIcon.classList.remove('hidden');
                isoIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>`;
            } else {
                isoIcon.classList.add('hidden');
            }
        }
        
        // Client: Priority order - Accepted (green check) > Viewed (green eye) > Shared (blue share)
        if (clientIcon) {
            if (window.clientAccepted) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>`;
            } else if (window.clientViewed) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>`;
            } else if (window.clientEmailShared) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>`;
            } else if (window.clientLinkShared) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>`;
            } else {
                clientIcon.classList.add('hidden');
            }
        }
    }
    
    function applyFrequencyLock() {
        const opt = calcOptions[activeCalcTab];
        const dailyBtn = document.querySelector('.toggle-btn[data-freq="daily"]');
        const weeklyBtn = document.querySelector('.toggle-btn[data-freq="weekly"]');
        const monthlyBtn = document.querySelector('.toggle-btn[data-freq="monthly"]');
        
        if (!opt || !opt.locked || currentClientMode === 'lender') {
            [dailyBtn, weeklyBtn, monthlyBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            return;
        }
        
        const lockedFreq = opt.lockedFrequency;
        
        if (lockedFreq === 'daily') {
            if (dailyBtn) { dailyBtn.disabled = false; dailyBtn.style.opacity = '1'; dailyBtn.style.cursor = 'pointer'; }
            if (weeklyBtn) { weeklyBtn.disabled = true; weeklyBtn.style.opacity = '0.4'; weeklyBtn.style.cursor = 'not-allowed'; weeklyBtn.classList.remove('active'); }
            if (monthlyBtn) { monthlyBtn.disabled = true; monthlyBtn.style.opacity = '0.4'; monthlyBtn.style.cursor = 'not-allowed'; monthlyBtn.classList.remove('active'); }
            if (dailyBtn && !dailyBtn.classList.contains('active')) setFrequency('daily');
        } else if (lockedFreq === 'weekly') {
            if (dailyBtn) { dailyBtn.disabled = false; dailyBtn.style.opacity = '1'; dailyBtn.style.cursor = 'pointer'; }
            if (weeklyBtn) { weeklyBtn.disabled = false; weeklyBtn.style.opacity = '1'; weeklyBtn.style.cursor = 'pointer'; }
            if (monthlyBtn) { monthlyBtn.disabled = true; monthlyBtn.style.opacity = '0.4'; monthlyBtn.style.cursor = 'not-allowed'; monthlyBtn.classList.remove('active'); }
            if (monthlyBtn && monthlyBtn.classList.contains('active')) setFrequency('weekly');
        }
        // If monthly, all are allowed (no restrictions)
    }
    
    function applyRateLock() {
        // Only applies in ISO mode
        if (currentClientMode !== 'iso') return;
        
        const opt = calcOptions[activeCalcTab];
        const sellSlider = $('isoSellRateSlider');
        const sellInput = $('isoSellRate');
        
        console.log('applyRateLock called, tab:', activeCalcTab, 'opt:', opt);
        
        if (!sellSlider || !sellInput) return;
        
        // Check if option is locked and has rate constraints
        if (opt && opt.locked && opt.lockedMaxSell && opt.lockedBuyRate) {
            const maxSell = opt.lockedMaxSell;
            const buyRate = opt.lockedBuyRate;
            
            console.log('Applying rate lock - buy:', buyRate, 'max:', maxSell);
            
            // Apply constraints to slider - set to MAX (slider appears capped/maxed)
            sellSlider.min = buyRate;
            sellSlider.max = maxSell;
            sellSlider.value = maxSell; // Set to max so slider is at right edge
            sellInput.value = maxSell.toFixed(2);
            sellInput.max = maxSell;
            sellInput.min = buyRate;
            updateSliderFill(sellSlider);
            
            // Update buy rate display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
            
            // Update factor rate as well
            if ($('calcFactor')) $('calcFactor').value = maxSell.toFixed(2);
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSell;
                updateSliderFill($('calcFactorSlider'));
            }
        } else if (!window.isoShareMode) {
            // Unlocked option in direct ISO mode - full range
            sellSlider.min = 1.05;
            sellSlider.max = 1.70;
            sellInput.min = 1.05;
            sellInput.max = 1.70;
            updateSliderFill(sellSlider);
        }
        
        updateIsoUpsell();
    }
    
    function applyTermLock() {
        // Only applies in ISO/client mode
        if (currentClientMode === 'lender') return;
        
        const opt = calcOptions[activeCalcTab];
        const amountSlider = $('calcAmountSlider');
        const amountInput = $('calcAmount');
        const termSlider = $('calcTermSlider');
        const termInput = $('calcTerm');
        
        console.log('applyTermLock - opt:', opt);
        
        if (opt && opt.locked) {
            // Apply amount cap - set max AND value to locked amount (slider appears maxed)
            if (opt.lockedAmount && amountSlider && amountInput) {
                amountSlider.max = opt.lockedAmount;
                amountSlider.value = opt.lockedAmount; // Set to max (slider at right edge)
                amountInput.value = formatNumber(opt.lockedAmount);
                updateSliderFill(amountSlider);
                console.log('Amount capped at:', opt.lockedAmount);
            }
            
            // Apply term cap - set max AND value to locked term (slider appears maxed)
            if (opt.lockedTerm && termSlider && termInput) {
                termSlider.max = opt.lockedTerm;
                termSlider.value = opt.lockedTerm; // Set to max (slider at right edge)
                termInput.value = opt.lockedTerm;
                updateSliderFill(termSlider);
                console.log('Term capped at:', opt.lockedTerm);
            }
        } else if (!window.isoShareMode && currentClientMode !== 'lender') {
            // Unlocked - restore full range
            if (amountSlider) { amountSlider.max = 1000000; updateSliderFill(amountSlider); }
            if (termSlider) { termSlider.max = 520; updateSliderFill(termSlider); }
        }
        
        updatePreview();
    }

    function toggleThemeDropdown() {
        // On mobile, use the settings sheet
        if (window.innerWidth <= 768) {
            openMobileSettings();
            return;
        }
        
        const dropdown = $('themeDropdown');
        if (!dropdown) return;
        dropdown.classList.toggle('open');
        
        // Close preview dropdown if open
        $('previewDropdown')?.classList.remove('open');
        $('previewDropdownSticky')?.classList.remove('open');
        
        // Sync tier preset inputs when opening
        if (dropdown.classList.contains('open')) {
            syncTierPresetInputs();
        }
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closeThemeDropdownOnClickOutside);
            }, 10);
        }
    }
    
    function toggleThemeDropdownSticky() {
        // Use the main theme dropdown - just scroll to make it visible
        toggleThemeDropdown();
    }
    
    function syncTierPresetInputs() {
        // Sync Tier A
        if ($('tierABuy')) $('tierABuy').value = LENDER_TIERS[1].buyRate.toFixed(2);
        if ($('tierAMax')) $('tierAMax').value = LENDER_TIERS[1].maxSell.toFixed(2);
        // Sync Tier B
        if ($('tierBBuy')) $('tierBBuy').value = LENDER_TIERS[2].buyRate.toFixed(2);
        if ($('tierBMax')) $('tierBMax').value = LENDER_TIERS[2].maxSell.toFixed(2);
        // Sync Tier C
        if ($('tierCBuy')) $('tierCBuy').value = LENDER_TIERS[3].buyRate.toFixed(2);
        if ($('tierCMax')) $('tierCMax').value = LENDER_TIERS[3].maxSell.toFixed(2);
    }

    function closeThemeDropdownOnClickOutside(e) {
        const dropdown = $('themeDropdown');
        if (!dropdown) return;
        const picker = document.querySelector('.theme-picker');
        const pickerSticky = document.querySelector('.theme-picker-sticky');
        if (!picker?.contains(e.target) && !pickerSticky?.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closeThemeDropdownOnClickOutside);
        }
    }
    
    function togglePreviewDropdown() {
        const dropdown = $('previewDropdown');
        if (!dropdown) return;
        dropdown.classList.toggle('open');
        
        // Close theme dropdown if open
        $('themeDropdown')?.classList.remove('open');
        $('previewDropdownSticky')?.classList.remove('open');
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closePreviewDropdownOnClickOutside);
            }, 10);
        }
    }
    
    function togglePreviewDropdownSticky() {
        const dropdown = $('previewDropdownSticky');
        if (!dropdown) return;
        dropdown.classList.toggle('open');
        
        // Close other dropdowns
        $('themeDropdown')?.classList.remove('open');
        $('previewDropdown')?.classList.remove('open');
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closePreviewDropdownStickyOnClickOutside);
            }, 10);
        }
    }
    
    function closePreviewDropdownStickyOnClickOutside(e) {
        const dropdown = $('previewDropdownSticky');
        if (!dropdown) return;
        const picker = document.querySelector('.preview-picker-sticky');
        if (!picker?.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closePreviewDropdownStickyOnClickOutside);
        }
    }

    function closePreviewDropdownOnClickOutside(e) {
        const dropdown = $('previewDropdown');
        if (!dropdown) return;
        const picker = document.querySelector('.preview-picker');
        if (!picker?.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closePreviewDropdownOnClickOutside);
        }
    }

    function setThemeMode(mode) {
        currentTheme = mode;
        const html = document.documentElement;
        html.classList.remove('theme-light', 'theme-dark', 'theme-black');
        html.classList.add(`theme-${mode}`);
        
        // Update mode buttons
        $$('.theme-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        saveThemePreference();
        updateSliders();
    }

    // Accents available to lite (non-logged-in) users
    const liteAccents = ['rainbow', 'indigo'];
    
    function setAccentColor(accent) {
        // If not logged in, restrict to lite accents only
        if (!currentUser && !liteAccents.includes(accent)) {
            showUpgradeModal();
            return;
        }
        
        currentAccent = accent;
        const html = document.documentElement;
        
        // Clear any existing rainbow interval
        if (window.rainbowInterval) {
            clearInterval(window.rainbowInterval);
            window.rainbowInterval = null;
        }
        
        // Remove all accent classes
        html.classList.remove('accent-mint', 'accent-blue', 'accent-purple', 'accent-rainbow', 'accent-orange', 'accent-cyan', 'accent-gold', 'accent-slate', 'accent-lime', 'accent-teal', 'accent-pink', 'accent-indigo', 'rainbow-mode');
        
        if (accent === 'rainbow') {
            // Rainbow mode - cycle through colors
            html.classList.add('rainbow-mode');
            const rainbowColors = ['mint', 'blue', 'purple', 'orange', 'cyan', 'gold', 'slate', 'lime', 'teal', 'pink', 'indigo'];
            let colorIndex = 0;
            
            const applyColor = () => {
                html.classList.remove('accent-mint', 'accent-blue', 'accent-purple', 'accent-orange', 'accent-cyan', 'accent-gold', 'accent-slate', 'accent-lime', 'accent-teal', 'accent-pink', 'accent-indigo');
                html.classList.add(`accent-${rainbowColors[colorIndex]}`);
                colorIndex = (colorIndex + 1) % rainbowColors.length;
            };
            
            applyColor();
            window.rainbowInterval = setInterval(applyColor, 4000);
        } else {
            html.classList.add(`accent-${accent}`);
        }
        
        // Update swatches
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('active', swatch.dataset.accent === accent);
        });
        
        saveThemePreference();
        updateSliders();
    }
    
    function updateAccentSwatchLocks() {
        $$('.color-swatch').forEach(swatch => {
            const accent = swatch.dataset.accent;
            if (!currentUser && !liteAccents.includes(accent)) {
                swatch.classList.add('locked');
            } else {
                swatch.classList.remove('locked');
            }
        });
    }

    // Welcome screen mode toggle
    function setClientModeWelcome(mode) {
        // Update welcome toggle buttons
        const isoBtn = $('welcomeIsoModeBtn');
        const lenderBtn = $('welcomeLenderModeBtn');
        if (isoBtn) isoBtn.classList.toggle('active', mode === 'iso');
        if (lenderBtn) lenderBtn.classList.toggle('active', mode === 'lender');
        
        // Store for use after login
        window.pendingClientMode = mode;
    }

    function setClientMode(mode) {
        currentClientMode = mode;
        
        // Save to localStorage for persistence
        localStorage.setItem('trustbureau_client_mode', mode);
        
        // Update mode toggle buttons
        const isoBtn = $('isoModeBtn');
        const lenderBtn = $('lenderModeBtn');
        if (isoBtn) isoBtn.classList.toggle('active', mode === 'iso');
        if (lenderBtn) lenderBtn.classList.toggle('active', mode === 'lender');
        
        // Also sync welcome screen toggle
        const welcomeIsoBtn = $('welcomeIsoModeBtn');
        const welcomeLenderBtn = $('welcomeLenderModeBtn');
        if (welcomeIsoBtn) welcomeIsoBtn.classList.toggle('active', mode === 'iso');
        if (welcomeLenderBtn) welcomeLenderBtn.classList.toggle('active', mode === 'lender');
        
        // Hide factor rate card in both modes (controlled by lender rates)
        const factorRateCard = $('factorRateCard');
        if (factorRateCard) factorRateCard.classList.add('hidden');
        
        // Show/hide ISO preview option in dropdown (only visible in lender mode)
        const isoPreviewOption = $('isoPreviewOption');
        const isoPreviewOptionSticky = $('isoPreviewOptionSticky');
        if (isoPreviewOption) {
            isoPreviewOption.classList.toggle('hidden', mode !== 'lender');
        }
        if (isoPreviewOptionSticky) {
            isoPreviewOptionSticky.classList.toggle('hidden', mode !== 'lender');
        }
        
        // Show/hide sections based on mode
        const lenderRateSection = $('lenderRateSection');
        const isoUpsellSection = $('isoUpsellSection');
        const lenderSettings = $('lenderRateSettings');
        
        if (mode === 'lender') {
            if (lenderRateSection) lenderRateSection.classList.remove('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
            if (lenderSettings) lenderSettings.classList.remove('hidden');
            updateLenderDisplay();
            updateHeaderLockIndicator();
            updateLockButtonState();
            updateLockToggleUI();
        } else {
            // ISO mode - apply locks if current option is locked
            const opt = calcOptions[activeCalcTab];
            if (opt && opt.locked) {
                applyFrequencyLock();
                const amountSlider = $('calcAmountSlider');
                const termSlider = $('calcTermSlider');
                if (amountSlider) {
                    amountSlider.max = opt.lockedAmount;
                    if (parseFloat(amountSlider.value) > opt.lockedAmount) {
                        amountSlider.value = opt.lockedAmount;
                        if ($('calcAmount')) $('calcAmount').value = formatNumber(opt.lockedAmount);
                    }
                    updateSliderFill(amountSlider);
                }
                if (termSlider) {
                    termSlider.max = opt.lockedTerm;
                    if (parseInt(termSlider.value) > opt.lockedTerm) {
                        termSlider.value = opt.lockedTerm;
                        if ($('calcTerm')) $('calcTerm').value = opt.lockedTerm;
                    }
                    updateSliderFill(termSlider);
                }
            }
            
            // ISO mode - set factor rate to max sell rate
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            
            // Check if current option is locked - use per-option rates
            const optForRates = calcOptions[activeCalcTab];
            const isOptionLocked = optForRates && optForRates.locked && optForRates.lockedBuyRate && optForRates.lockedMaxSell;
            
            // Check if this is a shared link (restricted range) or direct ISO login (full range)
            if (window.isoShareMode || isOptionLocked) {
                // Use per-option locked rates if available, otherwise fall back to global
                let maxSell, buyRate;
                if (isOptionLocked) {
                    maxSell = optForRates.lockedMaxSell;
                    buyRate = optForRates.lockedBuyRate;
                } else {
                    maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
                    buyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
                }
                
                if (sellSlider) {
                    sellSlider.min = buyRate;
                    sellSlider.max = maxSell;
                    sellSlider.value = maxSell;
                    updateSliderFill(sellSlider);
                }
                if (sellInput) {
                    sellInput.value = maxSell.toFixed(2);
                    sellInput.min = buyRate;
                    sellInput.max = maxSell;
                }
                
                // Update buy rate display
                if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
                
                if ($('calcFactor')) $('calcFactor').value = maxSell;
                if ($('calcFactorSlider')) $('calcFactorSlider').value = maxSell;
            } else {
                // Direct ISO login: give full range 1.05-1.70
                const defaultRate = 1.25;
                
                if (sellSlider) {
                    sellSlider.min = 1.05;
                    sellSlider.max = 1.70;
                    sellSlider.value = defaultRate;
                    updateSliderFill(sellSlider);
                }
                if (sellInput) {
                    sellInput.value = defaultRate.toFixed(2);
                }
                
                // Update global vars for ISO calculations
                lenderBuyRate = 1.05;
                lenderMaxSellRate = 1.70;
                
                if ($('calcFactor')) $('calcFactor').value = defaultRate;
                if ($('calcFactorSlider')) $('calcFactorSlider').value = defaultRate;
            }
            
            updateSliderFill($('calcFactorSlider'));
            
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            if (lenderSettings) lenderSettings.classList.add('hidden');
            // Show ISO upsell section in ISO mode
            if (isoUpsellSection) isoUpsellSection.classList.remove('hidden');
            
            // Update ISO upsell display
            updateIsoUpsell();
        }
        
        updatePreview();
    }
    
    // Tier presets for lender mode (mutable for customization)
    let LENDER_TIERS = {
        1: { buyRate: 1.15, maxSell: 1.25 },
        2: { buyRate: 1.25, maxSell: 1.35 },
        3: { buyRate: 1.35, maxSell: 1.45 }
    };
    
    // Map tier letters to numbers
    const TIER_MAP = { 'A': 1, 'B': 2, 'C': 3 };
    
    function updateTierPreset(tierLetter) {
        const tierNum = TIER_MAP[tierLetter];
        const buyInput = $('tier' + tierLetter + 'Buy');
        const maxInput = $('tier' + tierLetter + 'Max');
        
        if (!buyInput || !maxInput) return;
        
        let buyRate = parseFloat(buyInput.value) || 1.15;
        let maxSell = parseFloat(maxInput.value) || 1.25;
        
        // Enforce minimum spread
        if (maxSell <= buyRate + 0.04) {
            maxSell = buyRate + 0.05;
            maxInput.value = maxSell.toFixed(2);
        }
        
        // Update the tier preset
        LENDER_TIERS[tierNum] = { buyRate, maxSell };
        
        // Update the tier button display
        const tierBtn = $('tierBtn' + tierNum);
        if (tierBtn) {
            const rateDisplay = tierBtn.querySelector('span:last-child');
            if (rateDisplay) {
                rateDisplay.textContent = buyRate.toFixed(2) + ' / ' + maxSell.toFixed(2);
            }
        }
        
        // If this tier is currently active, update the rates
        if (tierBtn && tierBtn.classList.contains('active')) {
            setLenderTier(tierNum);
        }
    }
    
    function clearTierSelection() {
        for (let i = 1; i <= 3; i++) {
            const btn = $('tierBtn' + i);
            if (btn) {
                btn.classList.remove('active');
                btn.style.borderColor = 'var(--border-primary)';
            }
        }
    }
    
    function setLenderTier(tier) {
        const preset = LENDER_TIERS[tier];
        if (!preset) return;
        
        // Update tier button states
        for (let i = 1; i <= 3; i++) {
            const btn = $('tierBtn' + i);
            if (btn) {
                btn.classList.toggle('active', i === tier);
                btn.style.borderColor = i === tier ? 'var(--accent)' : 'var(--border-primary)';
            }
        }
        
        // Update buy rate
        if ($('lenderBuyRate')) $('lenderBuyRate').value = preset.buyRate;
        if ($('lenderBuyRateSlider')) $('lenderBuyRateSlider').value = preset.buyRate;
        if ($('buyRateInput')) $('buyRateInput').value = preset.buyRate;
        if ($('buyRateSlider')) $('buyRateSlider').value = preset.buyRate;
        
        // Update max sell rate
        if ($('lenderMaxSell')) $('lenderMaxSell').value = preset.maxSell;
        if ($('lenderMaxSellSlider')) $('lenderMaxSellSlider').value = preset.maxSell;
        if ($('maxSellRateInput')) $('maxSellRateInput').value = preset.maxSell;
        if ($('maxSellRateSlider')) $('maxSellRateSlider').value = preset.maxSell;
        
        // Update display and recalculate
        updateLenderDisplay();
        updatePreview();
    }
    
    function updateLenderDisplay() {
        const buyRate = parseFloat($('lenderBuyRate')?.value) || 1.15;
        const maxSell = parseFloat($('lenderMaxSell')?.value) || 1.25;
        const fundingAmount = parseFloat($('calcAmount').value.replace(/[,$]/g, '')) || 0;
        
        // Update global vars
        lenderBuyRate = buyRate;
        lenderMaxSellRate = maxSell;
        
        // Save rates to current option (for per-option locking)
        if (calcOptions[activeCalcTab]) {
            calcOptions[activeCalcTab].buyRate = buyRate;
            calcOptions[activeCalcTab].maxSell = maxSell;
        }
        
        // Calculate max spread and profit
        const maxSpread = maxSell - buyRate;
        const maxProfit = fundingAmount * maxSpread;
        
        if ($('lenderMaxSpread')) $('lenderMaxSpread').textContent = maxSpread.toFixed(2);
        if ($('lenderMaxProfit')) $('lenderMaxProfit').textContent = '$' + maxProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // Sync factor rate with buy rate in lender mode
        if ($('calcFactor')) $('calcFactor').value = buyRate;
        if ($('calcFactorSlider')) {
            $('calcFactorSlider').value = buyRate;
            updateSliderFill($('calcFactorSlider'));
        }
    }
    
    function shareWithISO() {
        // Lock current option first
        lockTerms();
        
        // Save current state
        saveState(activeCalcTab);
        
        const buyRate = parseFloat($('lenderBuyRate')?.value) || 1.15;
        const maxSell = parseFloat($('lenderMaxSell')?.value) || 1.25;
        
        // Build URL with parameters
        const baseUrl = window.location.origin + window.location.pathname;
        const params = new URLSearchParams();
        params.set('iso', '1');
        params.set('buy', buyRate.toFixed(2));
        params.set('max', maxSell.toFixed(2));
        
        // Include option data with locks
        const optData = calcOptions.map(op => ({
            a: op.amount, f: op.factor, t: op.term, q: op.frequency,
            lk: op.locked ? 1 : 0,
            la: op.lockedAmount,
            lt: op.lockedTerm,
            lq: op.lockedFrequency,
            lb: op.lockedBuyRate,
            lm: op.lockedMaxSell
        }));
        const optJson = JSON.stringify(optData);
        const optEnc = LZString.compressToEncodedURIComponent(optJson);
        params.set('opts', optEnc);
        
        const shareUrl = baseUrl + '?' + params.toString();
        
        // Mark as shared and update UI
        window.isoLinkShared = true;
        updateModeStatusIcons();
        
        // Save to dashboard (ISO rate share)
        const isoName = getVal('calcISOName') || '';
        saveISOShareToDashboard(shareUrl, buyRate, maxSell, isoName);
        
        // Copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ISO link copied with locked options!');
        }).catch(() => {
            // Fallback
            prompt('Copy this ISO link:', shareUrl);
        });
    }
    
    // Save ISO rate share to dashboard (for lenders)
    function saveISOShareToDashboard(link, buyRate, maxSell, isoName = '') {
        const offers = getStoredOffers();
        const now = new Date().toISOString();
        
        const offer = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            businessName: 'ISO Rate Share',
            contactName: '',
            isoName: isoName,
            amount: 0,
            factor: maxSell,
            buyRate: buyRate,
            term: 0,
            frequency: 'daily',
            payment: 0,
            totalPayback: 0,
            optionCount: 0,
            link: link,
            createdAt: now,
            mode: 'lender',
            isISOShare: true,
            tracking: {
                lenderLocked: now,
                isoShared: now,
                isoViewed: null,
                clientShared: null,
                clientShareMethod: null,
                clientViewed: null,
                clientDeclined: null,
                clientAccepted: null
            }
        };
        
        offers.unshift(offer);
        
        if (offers.length > 100) {
            offers.splice(100);
        }
        
        saveStoredOffers(offers);
        updateOfferCount();
    }
    
    function checkISOShareMode() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.get('iso') === '1') {
            window.isoShareMode = true;
            window.isoLinkShared = true;
            window.lenderLocked = true; // Lender has locked rates when sharing to ISO
            
            // Track ISO view event
            window.isoViewed = true;
            updateOfferTrackingByLink(window.location.href, 'isoView');
            
            const buyRate = parseFloat(params.get('buy')) || 1.15;
            const maxSell = parseFloat(params.get('max')) || 1.25;
            
            lenderBuyRate = buyRate;
            lenderMaxSellRate = maxSell;
            
            // Parse option data with locks if present
            const optsEnc = params.get('opts');
            if (optsEnc) {
                try {
                    const optsJson = LZString.decompressFromEncodedURIComponent(optsEnc);
                    const opts = JSON.parse(optsJson);
                    
                    console.log('Parsed opts from URL:', opts);
                    
                    // Ensure we have enough options
                    while (calcOptions.length < opts.length) {
                        calcOptions.push(initDefaultOption());
                    }
                    
                    // Apply option data and locks to calcOptions
                    opts.forEach((opt, i) => {
                        // Restore all option values
                        calcOptions[i].amount = parseFloat(opt.a) || calcOptions[i].amount;
                        calcOptions[i].factor = parseFloat(opt.f) || calcOptions[i].factor;
                        calcOptions[i].term = parseInt(opt.t) || calcOptions[i].term;
                        calcOptions[i].frequency = opt.q || calcOptions[i].frequency;
                        
                        // Restore lock values
                        calcOptions[i].locked = opt.lk === 1;
                        calcOptions[i].lockedAmount = opt.la ? parseFloat(opt.la) : null;
                        calcOptions[i].lockedTerm = opt.lt ? parseInt(opt.lt) : null;
                        calcOptions[i].lockedFrequency = opt.lq || null;
                        calcOptions[i].lockedBuyRate = opt.lb ? parseFloat(opt.lb) : null;
                        calcOptions[i].lockedMaxSell = opt.lm ? parseFloat(opt.lm) : null;
                        
                        console.log('Restored option', i, '- locked:', calcOptions[i].locked, 'lockedBuyRate:', calcOptions[i].lockedBuyRate, 'lockedMaxSell:', calcOptions[i].lockedMaxSell);
                    });
                    
                    // Update tabs UI to show lock icons
                    updateTabsUI();
                } catch(e) {
                    console.error('Error parsing ISO option data:', e);
                }
            }
            
            // Set up ISO upsell slider - use per-option values if locked
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            const activeOpt = calcOptions[activeCalcTab];
            
            // Use per-option locked rates if available, otherwise global
            const effectiveBuy = (activeOpt && activeOpt.locked && activeOpt.lockedBuyRate) ? activeOpt.lockedBuyRate : buyRate;
            const effectiveMax = (activeOpt && activeOpt.locked && activeOpt.lockedMaxSell) ? activeOpt.lockedMaxSell : maxSell;
            
            if (sellSlider && sellInput) {
                sellSlider.min = effectiveBuy;
                sellSlider.max = effectiveMax;
                sellSlider.value = effectiveMax;
                sellInput.value = effectiveMax.toFixed(2);
                updateSliderFill(sellSlider);
            }
            
            // Update display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = effectiveBuy.toFixed(2);
            
            // Show ISO section, hide lender section
            const isoUpsellSection = $('isoUpsellSection');
            const lenderRateSection = $('lenderRateSection');
            
            if (isoUpsellSection) isoUpsellSection.classList.remove('hidden');
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            
            // Set factor rate to max sell rate (ISO's default sell rate)
            if ($('calcFactor')) {
                $('calcFactor').value = effectiveMax;
                $('calcFactor').disabled = true;
            }
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = effectiveMax;
                $('calcFactorSlider').disabled = true;
            }
            
            // Force to Option A on ISO load
            activeCalcTab = 0;
            updateTabsUI();
            
            // Force ISO client mode in menu
            setClientMode('iso');
            
            // Load Option A state and apply all locks
            loadState(0);
            applyFrequencyLock();
            applyRateLock();
            applyTermLock();
            
            // Update ISO profit display
            updateIsoUpsell();
            updatePreview();
            
            showToast('ISO Mode: Adjust your sell rate below');
        }
    }
    
    function updateLenderRates() {
        clearTierSelection();
        // Get values from theme menu inputs
        let buyFromMenu = parseFloat($('buyRateInput')?.value) || 1.15;
        let maxFromMenu = parseFloat($('maxSellRateInput')?.value) || 1.25;
        
        // Enforce minimum spread of 0.05 between buy and max sell
        if (maxFromMenu <= buyFromMenu + 0.04) {
            // Determine which one was just changed by comparing to current slider values
            const currentBuy = parseFloat($('lenderBuyRate')?.value) || 1.15;
            const currentMax = parseFloat($('lenderMaxSell')?.value) || 1.25;
            
            // If buy rate changed more, adjust max sell up
            if (Math.abs(buyFromMenu - currentBuy) > Math.abs(maxFromMenu - currentMax)) {
                maxFromMenu = Math.min(buyFromMenu + 0.05, 1.70);
                if ($('maxSellRateInput')) $('maxSellRateInput').value = maxFromMenu.toFixed(2);
            } else {
                // Max sell changed more, adjust buy rate down
                buyFromMenu = Math.max(maxFromMenu - 0.05, 1.05);
                if ($('buyRateInput')) $('buyRateInput').value = buyFromMenu.toFixed(2);
            }
        }
        
        // Sync to calculator area sliders
        if ($('lenderBuyRate')) {
            $('lenderBuyRate').value = buyFromMenu;
            if ($('lenderBuyRateSlider')) {
                $('lenderBuyRateSlider').value = buyFromMenu;
                updateSliderFill($('lenderBuyRateSlider'));
            }
        }
        if ($('lenderMaxSell')) {
            $('lenderMaxSell').value = maxFromMenu;
            if ($('lenderMaxSellSlider')) {
                $('lenderMaxSellSlider').value = maxFromMenu;
                updateSliderFill($('lenderMaxSellSlider'));
            }
        }
        
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxFromMenu;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxFromMenu;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        
        updateLenderDisplay();
    }
    
    function updateIsoUpsell() {
        const sellRate = parseFloat($('isoSellRate')?.value) || lenderBuyRate;
        const fundingAmount = parseFloat($('calcAmount').value.replace(/[,$]/g, '')) || 0;
        
        // If lender lock is enabled, use the locked buy rate; otherwise ISO buys at 1.00 (cost)
        const lenderLockEnabled = $('lenderLockToggle')?.checked || window.lenderLocked;
        const effectiveBuyRate = lenderLockEnabled ? (parseFloat($('lenderBuyRate')?.value) || lenderBuyRate || 1.15) : 1.00;
        
        const spread = sellRate - effectiveBuyRate;
        const isoProfit = fundingAmount * spread;
        
        if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = effectiveBuyRate.toFixed(2);
        if ($('isoSpreadDisplay')) $('isoSpreadDisplay').textContent = spread.toFixed(2);
        if ($('isoProfitDisplay')) $('isoProfitDisplay').textContent = '$' + isoProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // When in ISO mode, the sell rate becomes the client's factor rate
        if (currentClientMode === 'iso' || window.isoShareMode || window.isoPreviewMode) {
            if ($('calcFactor')) $('calcFactor').value = sellRate;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = sellRate;
                updateSliderFill($('calcFactorSlider'));
            }
            
            // Update preview without triggering another updateIsoUpsell
            window._skipIsoUpdate = true;
            updatePreview();
            window._skipIsoUpdate = false;
        }
    }

    function updateLogoPreview(url) {
        currentLogoUrl = url ? url.trim() : '';
        const previewSmall = $('logoPreviewSmall');
        const clearBtn = $('clearLogoBtn');
        const previewContainer = $('previewLogoContainer');
        const previewLogo = $('previewLogo');
        
        if (currentLogoUrl) {
            // Save to localStorage for persistence across sessions
            localStorage.setItem('trustbureau_logo_url', currentLogoUrl);
            
            // Display directly in small preview
            if (previewSmall) previewSmall.innerHTML = `<img src="${currentLogoUrl}" alt="Logo Preview" onload="this.style.opacity=1" onerror="this.parentElement.innerHTML='<span class=\\'logo-preview-placeholder\\'>Unable to load</span>'" style="opacity:0; transition: opacity 0.2s;" />`;
            if (clearBtn) clearBtn.classList.remove('hidden');
            
            // Show in main preview card
            if (previewLogo) {
                previewLogo.src = currentLogoUrl;
                previewLogo.onload = function() {
                    if (previewContainer) previewContainer.classList.remove('hidden');
                };
                previewLogo.onerror = function() {
                    if (previewContainer) previewContainer.classList.add('hidden');
                };
            }
            
            saveThemePreference();
        } else {
            localStorage.removeItem('trustbureau_logo_url');
            if (previewSmall) previewSmall.innerHTML = '<span class="logo-preview-placeholder">Logo preview will appear here</span>';
            if (clearBtn) clearBtn.classList.add('hidden');
            if (previewContainer) previewContainer.classList.add('hidden');
        }
    }

    function clearLogo() {
        const logoInput = $('logoUrlInput');
        if (logoInput) logoInput.value = '';
        localStorage.removeItem('trustbureau_logo_url');
        updateLogoPreview('');
    }

    function updateCompanyName(name) {
        currentCompanyName = name.trim();
        const previewName = $('previewCompanyName');
        const cPreviewName = $('cPreviewCompanyName');
        
        if (currentCompanyName) {
            // Save to localStorage for persistence across sessions
            localStorage.setItem('trustbureau_company_name', currentCompanyName);
            if (previewName) {
                previewName.textContent = currentCompanyName;
                previewName.classList.remove('hidden');
            }
            if (cPreviewName) {
                cPreviewName.textContent = currentCompanyName;
                cPreviewName.classList.remove('hidden');
            }
        } else {
            localStorage.removeItem('trustbureau_company_name');
            if (previewName) previewName.classList.add('hidden');
            if (cPreviewName) cPreviewName.classList.add('hidden');
        }
        
        saveThemePreference();
    }

    function saveThemePreference() {
        localStorage.setItem('fundingCalcTheme', JSON.stringify({
            mode: currentTheme,
            accent: currentAccent,
            logoUrl: currentLogoUrl,
            companyName: currentCompanyName
        }));
    }

    // Load saved brand data (logo URL and company name) from localStorage
    function loadSavedBrandData() {
        const savedLogoUrl = localStorage.getItem('trustbureau_logo_url');
        const savedCompanyName = localStorage.getItem('trustbureau_company_name');
        
        if (savedLogoUrl) {
            $('logoUrlInput').value = savedLogoUrl;
            updateLogoPreview(savedLogoUrl);
        }
        
        if (savedCompanyName) {
            $('companyNameInput').value = savedCompanyName;
            updateCompanyName(savedCompanyName);
        }
        
        // Update preview if any brand data was loaded
        if (savedLogoUrl || savedCompanyName) {
            updatePreview();
        }
    }

    // Save current theme settings as favorite (for logged-in users)
    function saveFavoriteTheme() {
        if (!currentUser) return;
        
        const favoriteTheme = {
            mode: currentTheme,
            accent: currentAccent,
            logoUrl: currentLogoUrl,
            companyName: currentCompanyName
        };
        localStorage.setItem('trustbureau_favorite_theme_' + currentUser, JSON.stringify(favoriteTheme));
        
        // Show confirmation
        const btn = $('saveFavoriteBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg> Saved!';
        btn.style.background = 'var(--accent)';
        btn.style.color = 'white';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = 'var(--bg-option-card)';
            btn.style.color = 'var(--accent)';
        }, 1500);
    }

    // Load favorite theme (for logged-in users)
    function loadFavoriteTheme() {
        if (!currentUser) return;
        
        const saved = localStorage.getItem('trustbureau_favorite_theme_' + currentUser);
        if (saved) {
            try {
                const fav = JSON.parse(saved);
                if (fav.mode) setThemeMode(fav.mode);
                if (fav.accent) setAccentColor(fav.accent);
                if (fav.logoUrl) {
                    $('logoUrlInput').value = fav.logoUrl;
                    updateLogoPreview(fav.logoUrl);
                }
                if (fav.companyName) {
                    $('companyNameInput').value = fav.companyName;
                    updateCompanyName(fav.companyName);
                }
                updatePreview();
            } catch (e) {
                console.error('Failed to load favorite theme', e);
            }
        }
    }

    // Update Save Favorite button visibility based on login state
    function updateSaveFavoriteButton() {
        const btn = $('saveFavoriteBtn');
        if (btn) {
            if (currentUser) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }
    }

    function loadThemePreference() {
        const saved = localStorage.getItem('fundingCalcTheme');
        if (saved) {
            try {
                const pref = JSON.parse(saved);
                if (pref.mode) setThemeMode(pref.mode);
                if (pref.accent) {
                    // For lite users, check if saved accent is available
                    if (!currentUser && !liteAccents.includes(pref.accent)) {
                        setAccentColor('indigo'); // Fall back to indigo for lite users
                    } else {
                        setAccentColor(pref.accent);
                    }
                }
                if (pref.logoUrl) {
                    $('logoUrlInput').value = pref.logoUrl;
                    updateLogoPreview(pref.logoUrl);
                }
                if (pref.companyName) {
                    $('companyNameInput').value = pref.companyName;
                    updateCompanyName(pref.companyName);
                }
            } catch (e) {
                console.error('Failed to load theme preference', e);
            }
        } else {
            // Default to black theme with indigo accent for lite users
            setThemeMode('black');
            if (!currentUser) {
                setAccentColor('indigo');
            }
        }
        
        // Set initial active states
        $$('.theme-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === currentTheme);
        });
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('active', swatch.dataset.accent === currentAccent);
        });
    }

    function resetBrandKit() {
        // Reset to defaults
        setThemeMode('black');
        // Lite users default to indigo (steel), logged-in users get rainbow
        setAccentColor(currentUser ? 'rainbow' : 'indigo');
        setClientMode('iso');
        
        // Clear brand fields
        currentLogoUrl = '';
        currentCompanyName = '';
        const logoInput = $('logoUrlInput');
        const companyInput = $('companyNameInput');
        if (logoInput) logoInput.value = '';
        if (companyInput) companyInput.value = '';
        
        // Reset logo preview
        const previewSmall = $('logoPreviewSmall');
        if (previewSmall) previewSmall.innerHTML = '<span class="logo-preview-placeholder">Logo preview will appear here</span>';
        addClass('clearLogoBtn', 'hidden');
        addClass('previewLogoContainer', 'hidden');
        
        // Reset company name in preview
        const companyNameEl = $('previewCompanyName');
        if (companyNameEl) {
            companyNameEl.textContent = '';
            companyNameEl.classList.add('hidden');
        }
        
        // Clear localStorage
        localStorage.removeItem('fundingCalcTheme');
        
        // Update swatch locks
        updateAccentSwatchLocks();
        
        showToast('Theme Reset');
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    const VALID_USERS = {
        'sutton': 'nouns'
    };
    
    // ============================================
    // LITE VERSION USAGE TRACKING
    // ============================================
    const LITE_MONTHLY_LIMIT = 25;
    
    function getLiteUsage() {
        try {
            const data = JSON.parse(localStorage.getItem('trustbureau_lite_usage') || '{}');
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            // Reset if new month
            if (data.month !== currentMonth) {
                return { month: currentMonth, count: 0 };
            }
            return data;
        } catch (e) {
            return { month: new Date().toISOString().slice(0, 7), count: 0 };
        }
    }
    
    function saveLiteUsage(data) {
        localStorage.setItem('trustbureau_lite_usage', JSON.stringify(data));
    }
    
    function incrementLiteUsage() {
        const usage = getLiteUsage();
        usage.count++;
        saveLiteUsage(usage);
        updateLiteUsageUI();
        return usage.count;
    }
    
    function canUseLiteShare() {
        if (currentUser) return true; // Logged in users have unlimited
        const usage = getLiteUsage();
        return usage.count < LITE_MONTHLY_LIMIT;
    }
    
    function getRemainingLiteShares() {
        if (currentUser) return Infinity;
        const usage = getLiteUsage();
        return Math.max(0, LITE_MONTHLY_LIMIT - usage.count);
    }
    
    function updateLiteUsageUI() {
        const badge = $('liteUsageBadge');
        const stickyBadge = $('stickyLiteUsageBadge');
        const remaining = getRemainingLiteShares();
        
        if (currentUser) {
            // Hide for logged in users
            if (badge) badge.classList.add('hidden');
            if (stickyBadge) stickyBadge.classList.add('hidden');
            return;
        }
        
        [badge, stickyBadge].forEach(b => {
            if (b) {
                b.classList.remove('hidden');
                b.textContent = remaining;
                
                // Change color when low (5 or less)
                if (remaining <= 5) {
                    b.classList.add('low');
                } else {
                    b.classList.remove('low');
                }
            }
        });
    }
    
    function showUpgradeModal() {
        addClass('upgradeModal', 'open');
    }
    
    function closeUpgradeModal() {
        removeClass('upgradeModal', 'open');
    }
    
    let currentUser = null;

    function handleWelcomeLogin() {
        // Login screen removed - no-op
    }

    function continueAsFree() {
        // Login screen removed - no-op
    }

    function hideWelcomeScreen() {
        // Login screen removed - no-op
    }

    function showWelcomeScreen() {
        // Login screen removed - no-op
    }

    function openLoginModal() {
        // Login screen removed - no-op
    }

    function closeLoginModal() {
        // Login screen removed - no-op
    }

    function togglePasswordVisibility() {
        // Login screen removed - no-op
    }

    function handleLogin() {
        // Login screen removed - no-op
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('fundingCalcUser');
        updateAuthUI();
        showToast('Logged out successfully');
    }

    function updateAuthUI() {
        const brandSection = $('brandSection');
        const userBadge = $('userBadge');
        const userBadgeName = $('userBadgeName');
        
        if (currentUser) {
            // Logged in - unlock brand section
            if (brandSection) brandSection.classList.remove('locked');
            if (userBadge) userBadge.classList.remove('hidden');
            if (userBadgeName) userBadgeName.textContent = currentUser;
        } else {
            // Logged out - lock brand section
            if (brandSection) brandSection.classList.add('locked');
            if (userBadge) userBadge.classList.add('hidden');
        }
        
        // Update Save Favorite button visibility
        updateSaveFavoriteButton();
        
        // Update lite usage display
        updateLiteUsageUI();
        
        // Update accent swatch locks
        updateAccentSwatchLocks();
    }

    function loadAuthState() {
        const savedUser = localStorage.getItem('fundingCalcUser');
        const savedMode = localStorage.getItem('trustbureau_client_mode');
        
        // Load saved user directly (no welcome screen)
        if (savedUser) {
            currentUser = savedUser;
            loadFavoriteTheme();
        }
        
        // Apply saved mode
        if (savedMode) {
            setClientMode(savedMode);
        }
        
        updateAuthUI();
    }

    // ============================================
    // STATE
    // ============================================
    let calcOptions = [];
    let activeCalcTab = 0;
    let clientData = null;
    let clientActiveIdx = 0;
    let clientSelectedAmount = 0;

    // ============================================
    // CORE CALCULATION
    // ============================================
    function calculate(a, f, t, fr, fe) { 
        const tp = a * f; 
        const tc = tp - a; 
        const p = tp / t; 
        const fa = a * (fe / 100); 
        const net = a - fa; 
        return { amount: a, factor: f, term: t, frequency: fr, fee: fe, feeAmount: fa, net: net, totalPayback: tp, totalCost: tc, payment: p }; 
    }
    
    // Shared term display calculation for consistency across Link, SMS, Email
    function getTermDisplay(term, frequency, termOverride) {
        if (termOverride && termOverride.trim()) {
            return termOverride.trim();
        }
        let months;
        if (frequency === 'daily') {
            months = Math.round((term / 21) * 2) / 2; // 21 business days, round to .5
        } else if (frequency === 'weekly') {
            months = Math.round((term / 4.33) * 2) / 2; // 4.33 weeks per month, round to .5
        } else {
            months = term; // monthly = term is already months
        }
        // Format: "6 months" or "6.5 months"
        const label = months === 1 ? 'month' : 'months';
        return months + ' ' + label;
    }

    // ============================================
    // ADMIN LOGIC
    // ============================================
    function initDefaultOption() { 
        return { amount: 50000, factor: 1.19, term: 130, frequency: 'daily', fee: 0, prepay: 0, termOverride: '', notes: '', docs: false, docsText: "Voided Check\nGovernment Issued ID", locked: false, lockedAmount: null, lockedTerm: null, lockedFrequency: null, lockedBuyRate: null, lockedMaxSell: null, buyRate: 1.15, maxSell: 1.25 }; 
    }

    function addCalcOption() { 
        if (calcOptions.length >= 3) return; 
        const p = calcOptions[calcOptions.length - 1] || initDefaultOption(); 
        calcOptions.push({ ...p }); 
        updateTabsUI(); 
        switchCalcTab(calcOptions.length - 1); 
    }

    function removeCalcOption() { 
        if (calcOptions.length <= 1) return; 
        calcOptions.splice(activeCalcTab, 1); 
        if (activeCalcTab >= calcOptions.length) activeCalcTab = calcOptions.length - 1; 
        updateTabsUI(); 
        switchCalcTab(activeCalcTab); 
    }

    function switchCalcTab(i) { 
        console.log('switchCalcTab called, switching to:', i, 'current mode:', currentClientMode);
        
        // In ISO mode, DON'T save state - each option should reset to locked values
        if (currentClientMode !== 'iso') {
            saveState(activeCalcTab);
        }
        
        activeCalcTab = i; 
        updateTabsUI(); 
        loadState(activeCalcTab); // This now handles ISO mode with locked values
        updateSliders();
        updateLockButtonState();
        
        // Apply frequency lock (works for both modes)
        applyFrequencyLock();
        
        // In lender mode, apply other locks
        if (currentClientMode !== 'iso') {
            applyRateLock();
            applyTermLock();
        }
        
        // Update displays
        updateIsoUpsell();
        updatePreview();
    }
    
    // ============================================
    // OFFER PRODUCT TYPE SWITCHING
    // ============================================
    let currentOfferProduct = 'mca';
    
    const offerProductConfig = {
      mca: {
        name: 'MCA',
        rateLabel: 'Factor Rate',
        rateUnit: 'Factor',
        rateMin: 1.05, rateMax: 1.70, rateStep: 0.01, rateDefault: 1.35,
        termLabel: 'Term Length',
        termUnit: 'Pmts',
        termMin: 20, termMax: 520, termStep: 1, termDefault: 130,
        showFrequency: true,
        showFactorRate: true,
        showInterestRate: false,
        requirements: {
          tib: '4+ months',
          credit: '500+',
          revenue: '$10,000+',
          docs: '3 months bank statements',
          industry: 'Most accepted'
        }
      },
      working: {
        name: 'Working Capital',
        rateLabel: 'Interest Rate',
        rateUnit: 'APR %',
        rateMin: 8, rateMax: 35, rateStep: 0.5, rateDefault: 15,
        termLabel: 'Term Length',
        termUnit: 'Months',
        termMin: 3, termMax: 60, termStep: 1, termDefault: 24,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '6+ months',
          credit: '550+',
          revenue: '$15,000+',
          docs: '3 months bank statements',
          industry: 'Most accepted'
        }
      },
      term: {
        name: 'Term Loan',
        rateLabel: 'Interest Rate',
        rateUnit: 'APR %',
        rateMin: 5, rateMax: 25, rateStep: 0.25, rateDefault: 8,
        termLabel: 'Loan Term',
        termUnit: 'Months',
        termMin: 12, termMax: 120, termStep: 1, termDefault: 60,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '2+ years',
          credit: '650+',
          revenue: '$25,000+',
          docs: '2 years tax returns',
          industry: 'Established businesses'
        }
      },
      loc: {
        name: 'Line of Credit',
        rateLabel: 'Interest Rate',
        rateUnit: 'APR %',
        rateMin: 7, rateMax: 25, rateStep: 0.5, rateDefault: 12,
        termLabel: 'Draw Period',
        termUnit: 'Months',
        termMin: 6, termMax: 60, termStep: 6, termDefault: 12,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '1+ year',
          credit: '600+',
          revenue: '$20,000+',
          docs: '6 months bank statements',
          industry: 'Most accepted'
        }
      },
      sba: {
        name: 'SBA 7(a)',
        rateLabel: 'Interest Rate',
        rateUnit: 'APR %',
        rateMin: 7.5, rateMax: 14, rateStep: 0.25, rateDefault: 10.5,
        termLabel: 'Loan Term',
        termUnit: 'Months',
        termMin: 60, termMax: 300, termStep: 12, termDefault: 120,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '2+ years',
          credit: '680+',
          revenue: '$100,000+',
          docs: '3 years tax returns + financials',
          industry: 'SBA eligible'
        }
      },
      equipment: {
        name: 'Equipment Financing',
        rateLabel: 'Interest Rate',
        rateUnit: 'APR %',
        rateMin: 4, rateMax: 20, rateStep: 0.5, rateDefault: 7,
        termLabel: 'Loan Term',
        termUnit: 'Months',
        termMin: 12, termMax: 84, termStep: 6, termDefault: 60,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '1+ year',
          credit: '600+',
          revenue: '$15,000+',
          docs: 'Equipment quote + bank statements',
          industry: 'Equipment collateral required'
        }
      },
      cre: {
        name: 'Commercial Real Estate',
        rateLabel: 'Interest Rate',
        rateUnit: 'APR %',
        rateMin: 5, rateMax: 12, rateStep: 0.25, rateDefault: 7.5,
        termLabel: 'Loan Term',
        termUnit: 'Years',
        termMin: 5, termMax: 30, termStep: 1, termDefault: 20,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '2+ years',
          credit: '680+',
          revenue: 'Property cash flow',
          docs: 'Tax returns + rent roll + appraisal',
          industry: 'CRE collateral required'
        }
      },
      factoring: {
        name: 'Invoice Factoring',
        rateLabel: 'Factoring Fee',
        rateUnit: '% per 30 days',
        rateMin: 1, rateMax: 5, rateStep: 0.25, rateDefault: 3,
        termLabel: 'Advance Rate',
        termUnit: '%',
        termMin: 70, termMax: 95, termStep: 1, termDefault: 85,
        showFrequency: false,
        showFactorRate: false,
        showInterestRate: true,
        requirements: {
          tib: '6+ months',
          credit: '500+',
          revenue: 'B2B invoices',
          docs: 'A/R aging + invoices',
          industry: 'B2B businesses'
        }
      }
    };
    
    function switchOfferProduct(product) {
      currentOfferProduct = product;
      const config = offerProductConfig[product];
      
      // Update tab active states
      document.querySelectorAll('.offer-product-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.product === product);
      });
      
      // Get elements
      const factorRateCard = document.getElementById('factorRateCard');
      const calcFactor = document.getElementById('calcFactor');
      const calcFactorSlider = document.getElementById('calcFactorSlider');
      const calcTerm = document.getElementById('calcTerm');
      const calcTermSlider = document.getElementById('calcTermSlider');
      const freqCard = document.getElementById('frequencyCard');
      
      // Show/hide factor rate card
      if (factorRateCard) {
        if (config.showFactorRate) {
          factorRateCard.classList.remove('hidden');
          factorRateCard.querySelector('label').textContent = config.rateLabel;
          factorRateCard.querySelector('span[style*="uppercase"]').textContent = config.rateUnit;
        } else if (config.showInterestRate) {
          factorRateCard.classList.remove('hidden');
          factorRateCard.querySelector('label').textContent = config.rateLabel;
          factorRateCard.querySelector('span[style*="uppercase"]').textContent = config.rateUnit;
        }
      }
      
      // Update rate slider range
      if (calcFactorSlider) {
        calcFactorSlider.min = config.rateMin;
        calcFactorSlider.max = config.rateMax;
        calcFactorSlider.step = config.rateStep;
        calcFactorSlider.value = config.rateDefault;
      }
      if (calcFactor) {
        calcFactor.value = config.rateDefault;
        calcFactor.step = config.rateStep;
      }
      
      // Update term label and range
      const termCard = calcTerm?.closest('.option-card');
      if (termCard) {
        const termLabel = termCard.querySelector('label');
        const termUnit = termCard.querySelector('span[style*="uppercase"]');
        if (termLabel) termLabel.textContent = config.termLabel;
        if (termUnit) termUnit.textContent = config.termUnit;
      }
      if (calcTermSlider) {
        calcTermSlider.min = config.termMin;
        calcTermSlider.max = config.termMax;
        calcTermSlider.step = config.termStep;
        calcTermSlider.value = config.termDefault;
      }
      if (calcTerm) {
        calcTerm.value = config.termDefault;
      }
      
      // Show/hide frequency selector (MCA only)
      if (freqCard) {
        freqCard.style.display = config.showFrequency ? 'block' : 'none';
      }
      
      // Update requirements
      const reqContainer = document.getElementById('productRequirements');
      if (reqContainer && config.requirements) {
        reqContainer.innerHTML = `
          <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
            <span class="text-sm" style="color: var(--text-secondary);">Time in Business</span>
            <span class="text-sm font-bold" style="color: var(--accent);">${config.requirements.tib}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
            <span class="text-sm" style="color: var(--text-secondary);">Credit Score</span>
            <span class="text-sm font-bold" style="color: var(--accent);">${config.requirements.credit}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
            <span class="text-sm" style="color: var(--text-secondary);">Monthly Revenue</span>
            <span class="text-sm font-bold" style="color: var(--accent);">${config.requirements.revenue}</span>
          </div>
          <div class="flex items-center justify-between py-2 border-b" style="border-color: var(--border-secondary);">
            <span class="text-sm" style="color: var(--text-secondary);">Documentation</span>
            <span class="text-sm font-bold" style="color: var(--accent);">${config.requirements.docs}</span>
          </div>
          <div class="flex items-center justify-between py-2">
            <span class="text-sm" style="color: var(--text-secondary);">Industry</span>
            <span class="text-sm font-bold" style="color: var(--accent);">${config.requirements.industry}</span>
          </div>
        `;
      }
      
      // Update preview
      updateOfferPreview();
    }
    
    function updateOfferPreview() {
      const config = offerProductConfig[currentOfferProduct];
      const amount = parseNumber(document.getElementById('calcAmount')?.value || '50000');
      const rate = parseFloat(document.getElementById('calcFactor')?.value || config.rateDefault);
      const term = parseFloat(document.getElementById('calcTerm')?.value || config.termDefault);
      const freq = document.querySelector('.toggle-btn.active')?.dataset?.freq || 'daily';
      
      let payback, payment, costOfCapital;
      
      if (currentOfferProduct === 'mca') {
        // MCA: Factor rate calculation
        payback = amount * rate;
        costOfCapital = payback - amount;
        const freqDivisor = freq === 'daily' ? 1 : freq === 'weekly' ? 5 : 22;
        payment = payback / term;
      } else if (currentOfferProduct === 'factoring') {
        // Factoring: Advance calculation
        const advanceRate = term / 100; // term slider is advance rate %
        const advanceAmount = amount * advanceRate;
        const fee = amount * (rate / 100);
        payback = amount;
        costOfCapital = fee;
        payment = fee;
      } else {
        // Interest-based products
        const monthlyRate = rate / 100 / 12;
        const termMonths = currentOfferProduct === 'cre' ? term * 12 : term;
        if (monthlyRate > 0) {
          payment = amount * (monthlyRate * Math.pow(1 + monthlyRate, termMonths)) / (Math.pow(1 + monthlyRate, termMonths) - 1);
        } else {
          payment = amount / termMonths;
        }
        payback = payment * termMonths;
        costOfCapital = payback - amount;
      }
      
      // Update preview elements
      const previewPayback = document.getElementById('previewPaybackChart');
      if (previewPayback) previewPayback.textContent = formatCurrency(payback);
      
      // Update chart
      const principalPercent = (amount / payback) * 100;
      const circle = document.getElementById('previewCircle');
      if (circle) {
        circle.setAttribute('stroke-dasharray', `${principalPercent}, ${100 - principalPercent}`);
      }
      
      // Update term display
      const termDisplay = document.getElementById('previewTermLength');
      if (termDisplay) {
        if (currentOfferProduct === 'mca') {
          const freqLabel = freq === 'daily' ? 'days' : freq === 'weekly' ? 'weeks' : 'months';
          termDisplay.textContent = `${term} ${freqLabel}`;
        } else if (currentOfferProduct === 'cre') {
          termDisplay.textContent = `${term} years`;
        } else if (currentOfferProduct === 'factoring') {
          termDisplay.textContent = `${term}% advance`;
        } else {
          termDisplay.textContent = `${term} months`;
        }
      }
      
      // Update payment display
      const paymentDisplay = document.getElementById('previewPayment');
      if (paymentDisplay) {
        if (currentOfferProduct === 'factoring') {
          paymentDisplay.textContent = formatCurrency(costOfCapital) + ' fee';
        } else {
          paymentDisplay.textContent = formatCurrency(payment);
        }
      }
      
      // Update cost display
      const costDisplay = document.getElementById('previewCost');
      if (costDisplay) costDisplay.textContent = formatCurrency(costOfCapital);
      
      // Also call original updatePreview if it exists
      if (typeof updatePreview === 'function') {
        updatePreview();
      }
    }
    
    function updateTabsUI() { 
        for(let i=0; i<3; i++) { 
            const b = $(`tab-btn-${i}`); 
            if (i < calcOptions.length) { 
                b.classList.remove('hidden'); 
                b.classList.toggle('active', i === activeCalcTab);
                const isLocked = calcOptions[i] && calcOptions[i].locked;
                b.innerHTML = `Option ${getLetter(i)}${isLocked ? ' <span style="color: #10b981;">🔒</span>' : ''}`;
            } else { 
                b.classList.add('hidden'); 
            } 
        } 
        toggleClass('add-tab-btn', 'hidden', calcOptions.length >= 3); 
        toggleClass('remove-option-btn', 'hidden', calcOptions.length <= 1); 
    }

    function getVal(id, num=false) { 
        const el = $(id); 
        if (!el) return num ? 0 : ''; 
        if (num) return parseNumber(el.value); 
        return el.value.trim(); 
    }

    function setVal(id, v) { 
        if($(id)) $(id).value = v; 
    }

    function saveState(i) { 
        if (!calcOptions[i]) return; 
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        // Preserve ALL lock state including rate locks
        const prevLocked = calcOptions[i].locked;
        const prevLockedAmount = calcOptions[i].lockedAmount;
        const prevLockedTerm = calcOptions[i].lockedTerm;
        const prevLockedFrequency = calcOptions[i].lockedFrequency;
        const prevLockedBuyRate = calcOptions[i].lockedBuyRate;
        const prevLockedMaxSell = calcOptions[i].lockedMaxSell;
        
        // Capture current rates for this option (for per-option rate locking)
        const currentBuyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
        const currentMaxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
        
        calcOptions[i] = { 
            amount: getVal('calcAmount', true), 
            factor: getVal('calcFactor', true), 
            term: getVal('calcTerm', true), 
            frequency: fr, 
            fee: $('toggleFee')?.checked ? getVal('calcFee', true) : 0, 
            prepay: $('togglePrepay')?.checked ? getVal('calcPrepay', true) : 0,
            prepayDate: getVal('calcPrepayDate'),
            termOverride: $('toggleOverride')?.checked ? getVal('calcTermOverride') : '', 
            notes: $('toggleNotes')?.checked ? getVal('calcNotes') : '',
            expiry: $('toggleExpiry')?.checked,
            expiryDate: getVal('calcExpiryDate'),
            docs: $('toggleDocs')?.checked,
            docsText: getVal('calcDocs'),
            locked: prevLocked,
            lockedAmount: prevLockedAmount,
            lockedTerm: prevLockedTerm,
            lockedFrequency: prevLockedFrequency,
            lockedBuyRate: prevLockedBuyRate,
            lockedMaxSell: prevLockedMaxSell,
            // Store current rates for this option (used when locking)
            buyRate: currentBuyRate,
            maxSell: currentMaxSell
        }; 
    }

    function loadState(i) { 
        const o = calcOptions[i]; 
        if (!o) return; 
        
        // In ISO mode with locked option, set sliders to locked values (not stored values)
        if (currentClientMode === 'iso' && o.locked) {
            console.log('loadState ISO mode - loading locked values for option', i, o);
            
            // Amount - set to locked max
            if (o.lockedAmount) {
                const amountSlider = $('calcAmountSlider');
                if (amountSlider) {
                    amountSlider.min = 5000;
                    amountSlider.max = o.lockedAmount;
                    amountSlider.value = o.lockedAmount;
                    updateSliderFill(amountSlider);
                }
                setVal('calcAmount', formatNumber(o.lockedAmount));
            }
            
            // Term - set to locked max
            if (o.lockedTerm) {
                const termSlider = $('calcTermSlider');
                if (termSlider) {
                    termSlider.min = 5;
                    termSlider.max = o.lockedTerm;
                    termSlider.value = o.lockedTerm;
                    updateSliderFill(termSlider);
                }
                setVal('calcTerm', o.lockedTerm);
            }
            
            // Factor/sell rate - set to locked max
            if (o.lockedMaxSell) {
                const factorSlider = $('calcFactorSlider');
                if (factorSlider) {
                    factorSlider.min = o.lockedBuyRate || 1.0;
                    factorSlider.max = o.lockedMaxSell;
                    factorSlider.value = o.lockedMaxSell;
                    updateSliderFill(factorSlider);
                }
                setVal('calcFactor', o.lockedMaxSell.toFixed(2));
                
                // ISO sell rate slider
                const sellSlider = $('isoSellRateSlider');
                const sellInput = $('isoSellRate');
                if (sellSlider && sellInput) {
                    sellSlider.min = o.lockedBuyRate || 1.0;
                    sellSlider.max = o.lockedMaxSell;
                    sellSlider.value = o.lockedMaxSell;
                    sellInput.value = o.lockedMaxSell.toFixed(2);
                    sellInput.min = o.lockedBuyRate || 1.0;
                    sellInput.max = o.lockedMaxSell;
                    updateSliderFill(sellSlider);
                }
                
                // Update buy rate display
                if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = (o.lockedBuyRate || 1.0).toFixed(2);
            }
            
            // Frequency
            if (o.frequency) setFrequency(o.frequency);
            
            // Fee/prepay/notes/etc
            const hf = o.fee > 0; 
            const toggleFeeEl = $('toggleFee'); if (toggleFeeEl) toggleFeeEl.checked = hf;
            toggleSection('Fee', hf); if(hf) { setVal('calcFee', o.fee); setVal('calcFeeSlider', o.fee); }
            
            const hp = o.prepay > 0; 
            const togglePrepayEl = $('togglePrepay'); if (togglePrepayEl) togglePrepayEl.checked = hp;
            toggleSection('Prepay', hp); if(hp) { setVal('calcPrepay', o.prepay); setVal('calcPrepaySlider', o.prepay); } if(o.prepayDate) setVal('calcPrepayDate', o.prepayDate);
            
            const ho = !!o.termOverride; 
            const toggleOverrideEl = $('toggleOverride'); if (toggleOverrideEl) toggleOverrideEl.checked = ho;
            toggleSection('Override', ho); if(ho) setVal('calcTermOverride', o.termOverride);
            
            const hn = !!o.notes; 
            const toggleNotesEl = $('toggleNotes'); if (toggleNotesEl) toggleNotesEl.checked = hn;
            toggleSection('Notes', hn); if(hn) setVal('calcNotes', o.notes);
            
            const he = !!o.expiry; 
            const toggleExpiryEl = $('toggleExpiry'); if (toggleExpiryEl) toggleExpiryEl.checked = he;
            toggleSection('Expiry', he); if(o.expiryDate) setVal('calcExpiryDate', o.expiryDate);
            
            const hd = !!o.docs; 
            const toggleDocsEl = $('toggleDocs'); if (toggleDocsEl) toggleDocsEl.checked = hd;
            toggleSection('Docs', hd); setVal('calcDocs', o.docsText || "Voided Check\nGovernment Issued ID");
            
            return; // Done for ISO mode
        }
        
        // Normal mode (lender) - load stored values
        setVal('calcAmount', formatNumber(o.amount)); setVal('calcAmountSlider', o.amount); 
        setVal('calcFactor', o.factor); setVal('calcFactorSlider', o.factor); 
        setVal('calcTerm', o.term); setVal('calcTermSlider', o.term); 
        
        const hf2 = o.fee > 0; 
        const toggleFeeEl2 = $('toggleFee'); if (toggleFeeEl2) toggleFeeEl2.checked = hf2;
        toggleSection('Fee', hf2); if(hf2) { setVal('calcFee', o.fee); setVal('calcFeeSlider', o.fee); }
        
        const hp2 = o.prepay > 0; 
        const togglePrepayEl2 = $('togglePrepay'); if (togglePrepayEl2) togglePrepayEl2.checked = hp2;
        toggleSection('Prepay', hp2); if(hp2) { setVal('calcPrepay', o.prepay); setVal('calcPrepaySlider', o.prepay); } if(o.prepayDate) setVal('calcPrepayDate', o.prepayDate);
        
        const ho2 = !!o.termOverride; 
        const toggleOverrideEl2 = $('toggleOverride'); if (toggleOverrideEl2) toggleOverrideEl2.checked = ho2;
        toggleSection('Override', ho2); if(ho2) setVal('calcTermOverride', o.termOverride);
        
        const hn2 = !!o.notes; 
        const toggleNotesEl2 = $('toggleNotes'); if (toggleNotesEl2) toggleNotesEl2.checked = hn2;
        toggleSection('Notes', hn2); if(hn2) setVal('calcNotes', o.notes);
        
        const he2 = !!o.expiry; 
        const toggleExpiryEl2 = $('toggleExpiry'); if (toggleExpiryEl2) toggleExpiryEl2.checked = he2;
        toggleSection('Expiry', he2); if(o.expiryDate) setVal('calcExpiryDate', o.expiryDate);
        
        const hd2 = !!o.docs;
        const toggleDocsEl2 = $('toggleDocs'); if (toggleDocsEl2) toggleDocsEl2.checked = hd2;
        toggleSection('Docs', hd2);
        setVal('calcDocs', o.docsText || "Voided Check\nGovernment Issued ID");
        
        setFrequency(o.frequency);
        
        // Restore per-option rates to lender inputs (in lender mode)
        if (currentClientMode === 'lender' && o.buyRate && o.maxSell) {
            if ($('lenderBuyRate')) $('lenderBuyRate').value = o.buyRate;
            if ($('lenderMaxSell')) $('lenderMaxSell').value = o.maxSell;
            if ($('buyRateInput')) $('buyRateInput').value = o.buyRate.toFixed(2);
            if ($('maxSellRateInput')) $('maxSellRateInput').value = o.maxSell.toFixed(2);
            if ($('lenderBuyRateSlider')) { $('lenderBuyRateSlider').value = o.buyRate; updateSliderFill($('lenderBuyRateSlider')); }
            if ($('lenderMaxSellSlider')) { $('lenderMaxSellSlider').value = o.maxSell; updateSliderFill($('lenderMaxSellSlider')); }
            updateLenderDisplay();
        }
    }

    function updatePreview(animate = false) {
        const a = getVal('calcAmount', true); 
        const f = getVal('calcFactor', true) || 1.15; 
        const t = getVal('calcTerm', true) || 130;
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        const fe = $('toggleFee').checked ? (getVal('calcFee', true) || 0) : 0;
        const c = calculate(a, f, t, fr, fe);
        
        // Update ISO profit if in lender mode or ISO share/preview mode
        if ((currentClientMode === 'lender' || window.isoShareMode || window.isoPreviewMode) && !window._skipIsoUpdate) {
            updateIsoUpsell();
        }
        
        const bn = getVal('calcBusinessName');
        const previewBN = $('previewBusinessName');
        if(bn) { 
            if (previewBN) previewBN.textContent = bn; 
            removeClass('previewBusinessName', 'hidden'); 
        } else { 
            addClass('previewBusinessName', 'hidden'); 
        }
        
        if (calcOptions.length > 1) {
            removeClass('previewLabelContainer', 'hidden');
            const optLabel = $('previewOptionLabel');
            if (optLabel) optLabel.textContent = `Option ${getLetter(activeCalcTab)}`;
        } else {
            addClass('previewLabelContainer', 'hidden');
        }

        // Animate all numeric values
        animateNumber($('previewAmount'), c.amount, 1200);
        animateNumber($('previewPaybackChart'), c.totalPayback, 1200);
        
        const to = $('toggleOverride')?.checked ? getVal('calcTermOverride') : '';
        const termLengthEl = $('previewTermLength');
        if (termLengthEl) termLengthEl.textContent = getTermDisplay(t, fr, to); 
        animateNumber($('previewTermPayments'), c.term, 1200, (n) => Math.round(n).toString());
        animateNumber($('previewFactor'), c.factor, 1200, (n) => n.toFixed(2) + 'x');
        animateNumber($('previewCost'), c.totalCost, 1200);
        
        const pLabel = fr === 'weekly' ? 'Weekly Payment' : fr === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        const paymentLabelEl = $('previewPaymentLabel');
        if (paymentLabelEl) paymentLabelEl.textContent = pLabel;
        animateNumber($('previewPayment'), c.payment, 1200);
        
        if (fe > 0) { 
            removeClass('previewFeeRow', 'hidden'); 
            animateNumber($('previewFeeAmount'), c.feeAmount, 1200); 
            animateNumber($('previewNet'), c.net, 1200); 
        } else { 
            addClass('previewFeeRow', 'hidden'); 
        }
        
        // Prepay discount
        const togglePrepayEl = $('togglePrepay');
        const prepayVal = togglePrepayEl?.checked ? getVal('calcPrepay', true) : 0;
        if (prepayVal > 0) {
            removeClass('previewPrepayRow', 'hidden');
            const prepayDate = getVal('calcPrepayDate');
            const previewPrepayEl = $('previewPrepay');
            if (previewPrepayEl) {
                if (prepayDate) {
                    previewPrepayEl.textContent = prepayVal + '% off if paid by ' + new Date(prepayDate).toLocaleDateString();
                } else {
                    previewPrepayEl.textContent = prepayVal + '% off if paid early';
                }
            }
        } else {
            addClass('previewPrepayRow', 'hidden');
        }
        
        // Notes, Expiry, Docs - Separate Sections
        const hasExpiry = $('toggleExpiry')?.checked;
        const hasNotes = $('toggleNotes')?.checked;
        const hasDocs = $('toggleDocs')?.checked;
        
        // Expiry Section
        if (hasExpiry) {
            removeClass('previewExpirySection', 'hidden');
            const expDate = getVal('calcExpiryDate');
            const previewExpiryEl = $('previewExpiryDate');
            if (previewExpiryEl) previewExpiryEl.textContent = expDate ? new Date(expDate).toLocaleDateString() : 'Not set';
        } else {
            addClass('previewExpirySection', 'hidden');
        }
        
        // Notes Section
        if (hasNotes) {
            const notesList = $('previewNotesList');
            if (notesList) notesList.innerHTML = '';
            const notesText = getVal('calcNotes').trim();
            const items = notesText ? notesText.split('\n') : [];
            let hasItems = false;
            items.forEach(item => {
                if (!item.trim()) return;
                hasItems = true;
                const li = document.createElement('li');
                li.className = "flex items-center gap-2";
                li.innerHTML = `
                    <div class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(59, 130, 246, 0.2);">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" style="color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <span style="color: var(--text-secondary);">${item.trim()}</span>
                `;
                if (notesList) notesList.appendChild(li);
            });
            if (hasItems) {
                removeClass('previewNotesSection', 'hidden');
            } else {
                addClass('previewNotesSection', 'hidden');
            }
        } else {
            addClass('previewNotesSection', 'hidden');
        }
        
        // Docs Section
        if (hasDocs) {
            removeClass('previewDocsSection', 'hidden');
            const docsList = $('previewDocsList');
            if (docsList) {
                docsList.innerHTML = '';
                const items = getVal('calcDocs').split('\n');
                items.forEach(item => {
                    if (!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <div class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-glow);">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        </div>
                        <span>${item.trim()}</span>
                    `;
                    docsList.appendChild(li);
                });
            }
        } else {
            addClass('previewDocsSection', 'hidden');
        }
        
        // Source Info Section (ISO/Lender)
        const hasISO = $('toggleISO')?.checked;
        const hasLender = $('toggleLender')?.checked;
        const isoName = getVal('calcISOName');
        const lenderName = getVal('calcLenderName');
        if ((hasISO && isoName) || (hasLender && lenderName)) {
            removeClass('previewSourceSection', 'hidden');
            const isoTag = $('previewISOTag');
            const lenderTag = $('previewLenderTag');
            if (hasISO && isoName) {
                if (isoTag) {
                    isoTag.textContent = isoName;
                    isoTag.classList.remove('hidden');
                }
            } else {
                if (isoTag) isoTag.classList.add('hidden');
            }
            if (hasLender && lenderName) {
                if (lenderTag) {
                    lenderTag.textContent = lenderName;
                    lenderTag.classList.remove('hidden');
                }
            } else {
                if (lenderTag) lenderTag.classList.add('hidden');
            }
        } else {
            addClass('previewSourceSection', 'hidden');
        }
        
        const pp = c.totalPayback > 0 ? (c.amount / c.totalPayback) * 100 : 0; 
        $('previewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // ============================================
    // INLINE EDITING ON PREVIEW CARD
    // ============================================
    function initInlineEditing() {
        const editableFields = document.querySelectorAll('.editable-value[data-field]');
        
        editableFields.forEach(el => {
            // Prevent newlines
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    el.blur();
                }
                if (e.key === 'Escape') {
                    el.blur();
                    updatePreview(); // Reset to form values
                }
            });
            
            // Handle blur - sync back to form
            el.addEventListener('blur', () => {
                const field = el.dataset.field;
                const rawValue = el.textContent.trim();
                
                syncInlineEdit(field, rawValue);
            });
            
            // Select all on focus for easy replacement
            el.addEventListener('focus', () => {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            });
        });
    }
    
    function syncInlineEdit(field, rawValue) {
        let numVal;
        
        switch(field) {
            case 'amount':
                // Parse currency: remove $, commas
                numVal = parseFloat(rawValue.replace(/[$,]/g, '')) || 0;
                if (numVal > 0) {
                    $('calcAmount').value = numVal;
                    $('calcAmountSlider').value = Math.min(numVal, 500000);
                }
                break;
                
            case 'termLength':
                // Could be "6 months" or just "6" - extract number
                numVal = parseInt(rawValue.replace(/[^\d]/g, '')) || 6;
                // Check for term override (if it has text like "months")
                if (rawValue.toLowerCase().includes('month') || rawValue.toLowerCase().includes('week')) {
                    const toggleTermEl = $('toggleTermOverride'); if (toggleTermEl) toggleTermEl.checked = true;
                    removeClass('termOverrideContainer', 'hidden');
                    const calcTermOverrideEl = $('calcTermOverride'); if (calcTermOverrideEl) calcTermOverrideEl.value = rawValue;
                } else {
                    // Just a number - use as term
                    const calcTermEl = $('calcTerm'); if (calcTermEl) calcTermEl.value = numVal;
                    const calcTermSliderEl = $('calcTermSlider'); if (calcTermSliderEl) calcTermSliderEl.value = Math.min(numVal, 365);
                }
                break;
                
            case 'payments':
                numVal = parseInt(rawValue.replace(/[^\d]/g, '')) || 130;
                $('calcTerm').value = numVal;
                $('calcTermSlider').value = Math.min(numVal, 365);
                break;
                
            case 'factor':
                // Parse factor: "1.19x" or "1.19"
                numVal = parseFloat(rawValue.replace(/[x×]/gi, '')) || 1.19;
                if (numVal > 0 && numVal < 3) {
                    $('calcFactor').value = numVal;
                    $('calcFactorSlider').value = numVal;
                }
                break;
        }
        
        // Recalculate and update preview
        updatePreview();
    }
    
    // Initialize inline editing on load
    setTimeout(initInlineEditing, 100);

    // ============================================
    // UNIFIED PREVIEW HANDLERS
    // ============================================
    
    // Smart client preview - routes based on current tool
    function handleClientPreview() {
      console.log('handleClientPreview called, currentTool:', currentTool);
      
      // Offer Builder uses original preview logic
      if (currentTool === 'offer') {
        previewClientView();
        return;
      }
      
      // Calculators open in new window
      if (['prequal', 'mca', 'working', 'term', 'loc', 'sba', 'equipment', 'payoff', 'cre', 'factoring', 'apr'].includes(currentTool)) {
        openCalcPreview(currentTool);
        return;
      }
      
      // Reports use floating preview
      if (['debtschedule', 'araging', 'wip'].includes(currentTool)) {
        openFloatingPreview();
        return;
      }
      
      // Fallback
      openFloatingPreview();
    }
    
    // Copy link for current calculator/tool
    function copyCurrentCalcLink() {
      console.log('copyCurrentCalcLink called, currentTool:', currentTool);
      
      // Use existing copyCalcLink for calculators
      if (['prequal', 'mca', 'working', 'term', 'loc', 'sba', 'equipment', 'payoff'].includes(currentTool)) {
        // Create a temporary button element to pass to copyCalcLink
        const tempBtn = document.createElement('button');
        tempBtn.innerHTML = '<span class="btn-text">Copy Client Link</span>';
        document.body.appendChild(tempBtn);
        copyCalcLink(currentTool, tempBtn);
        
        // Show toast notification
        showToast('Link copied to clipboard!', 'success');
        
        setTimeout(() => tempBtn.remove(), 100);
        return;
      }
      
      // Offer Builder uses share function
      if (currentTool === 'offer') {
        shareOffer();
        return;
      }
      
      // Fallback - show message
      showToast('Copy link not available for this tool', 'info');
    }
    
    // Toast notification helper
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        z-index: 9999;
        animation: slideUp 0.3s ease;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
        color: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }

    // ============================================
    // CLIENT VIEW
    // ============================================
    function getCurrentData() {
        saveState(activeCalcTab);
        return {
            b: getVal('calcBusinessName'), c: getVal('calcContactName'),
            iso: $('toggleISO')?.checked ? getVal('calcISOName') : null,
            ln: $('toggleLender')?.checked ? getVal('calcLenderName') : null,
            ex: $('toggleExpiry')?.checked ? getVal('calcExpiryDate') : null,
            logo: currentLogoUrl,
            companyName: currentCompanyName,
            o: calcOptions.map(op => ({ a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, pd: op.prepayDate, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText }))
        };
    }

    function previewClientView() {
        console.log('previewClientView called');
        try {
            // Track client view
            window.clientViewed = true;
            updateModeStatusIcons();
            
            // Update tracking for existing offer if link exists
            const currentLink = getLink();
            updateOfferTrackingByLink(currentLink, 'clientView');
            
            // Hide ISO preview bar if visible
            const isoBar = $('isoPreviewBar');
            if (isoBar) isoBar.classList.add('hidden');
            
            // Clear ISO preview flags
            window.isoShareMode = false;
            window.isoPreviewMode = false;
            
            // Update mode toggle to show Client as active
            const clientBtn = $('clientModeBtn');
            const isoBtn = $('isoModeBtn');
            const lenderBtn = $('lenderModeBtn');
            if (clientBtn) clientBtn.classList.add('active');
            if (isoBtn) isoBtn.classList.remove('active');
            if (lenderBtn) lenderBtn.classList.remove('active');
            
            // Ensure factor rate is set to max sell rate for client preview
            const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
            if ($('calcFactor')) $('calcFactor').value = maxSell;
            if ($('calcFactorSlider')) $('calcFactorSlider').value = maxSell;
            
            const data = getCurrentData();
            console.log('data:', data);
            initClientView(data);
            removeClass('clientPreviewBar', 'hidden');
            document.body.style.paddingTop = '72px';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('previewClientView completed');
        } catch(e) {
            console.error('previewClientView error:', e);
        }
    }
    
    function openFloatingPreview() {
        console.log('openFloatingPreview called, currentTool:', currentTool);
        const container = $('floatingPreviewContent');
        const copyBtn = $('previewCopyLinkBtn');
        const label = $('floatingPreviewLabel');
        
        // Tool name mapping for display
        const toolNames = {
          'offer': 'Offer Builder',
          'prequal': 'Pre-Qualify',
          'mca': 'MCA Calculator',
          'working': 'Working Capital',
          'term': 'Term Loan',
          'loc': 'Line of Credit',
          'sba': 'SBA 7(a)',
          'equipment': 'Equipment Finance',
          'payoff': 'Early Payoff',
          'cre': 'Commercial Real Estate',
          'factoring': 'Invoice Factoring',
          'apr': 'APR Calculator',
          'debtschedule': 'Debt Schedule',
          'araging': 'A/R Aging',
          'wip': 'WIP Report'
        };
        
        // Reports and Offer Builder support sharing
        const shareable = ['offer', 'debtschedule', 'araging', 'wip'];
        const isShareable = shareable.includes(currentTool);
        
        // Show/hide copy link button
        if (copyBtn) {
          copyBtn.style.display = isShareable ? 'flex' : 'none';
        }
        
        // Update label
        if (label) {
          label.textContent = `${toolNames[currentTool] || 'Client'} Preview`;
        }
        
        // Handle Offer Builder (original logic)
        if (currentTool === 'offer') {
          console.log('Routing to openOfferPreview');
          openOfferPreview();
          return;
        }
        
        // Handle Reports
        if (['debtschedule', 'araging', 'wip'].includes(currentTool)) {
          console.log('Routing to openReportPreview:', currentTool);
          openReportPreview(currentTool);
          return;
        }
        
        // Handle Calculators
        console.log('Routing to openCalculatorPreview:', currentTool);
        openCalculatorPreview(currentTool);
    }
    
    function openOfferPreview() {
        // Get current data
        const data = getCurrentData();
        const container = $('floatingPreviewContent');
        
        // Store current scroll position
        const scrollPos = window.scrollY;
        
        // Store current panel states
        const adminWasHidden = hasClass('adminPanel', 'hidden');
        const clientWasHidden = hasClass('clientPanel', 'hidden');
        
        // Temporarily show client panel to render it properly
        removeClass('clientPanel', 'hidden');
        addClass('adminPanel', 'hidden');
        
        // Initialize client view (this populates the clientPanel)
        clientData = data;
        clientActiveIdx = 0;
        
        $('clientGreeting').textContent = `Hello, ${data.c || 'Business Owner'}`;
        $('clientBusinessName').textContent = data.b || 'your business';
        if(data.ex) {
            removeClass('clientExpirySection', 'hidden');
            $('clientExpiryDate').textContent = new Date(data.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        } else {
            addClass('clientExpirySection', 'hidden');
        }
        
        // Handle Source Info (ISO/Lender)
        if (data.iso || data.ln) {
            removeClass('clientSourceSection', 'hidden');
            const isoTag = $('clientISOTag');
            const lenderTag = $('clientLenderTag');
            if (data.iso) {
                if (isoTag) {
                    isoTag.textContent = data.iso;
                    isoTag.classList.remove('hidden');
                }
            } else {
                if (isoTag) isoTag.classList.add('hidden');
            }
            if (data.ln) {
                if (lenderTag) {
                    lenderTag.textContent = data.ln;
                    lenderTag.classList.remove('hidden');
                }
            } else {
                if (lenderTag) lenderTag.classList.add('hidden');
            }
        } else {
            addClass('clientSourceSection', 'hidden');
        }
        
        // Handle logo
        const cLogoContainer = $('cPreviewLogoContainer');
        const cLogo = $('cPreviewLogo');
        if (data.logo) {
            if (cLogo) cLogo.src = data.logo;
            if (cLogoContainer) cLogoContainer.classList.remove('hidden');
        } else {
            if (cLogoContainer) cLogoContainer.classList.add('hidden');
        }
        
        // Handle company name
        const cCompanyName = $('cPreviewCompanyName');
        if (data.companyName) {
            if (cCompanyName) {
                cCompanyName.textContent = data.companyName;
                cCompanyName.classList.remove('hidden');
            }
        } else {
            if (cCompanyName) cCompanyName.classList.add('hidden');
        }
        
        // Render tabs
        const tabsContainer = $('clientTabsContainer');
        if (!tabsContainer) return;
        tabsContainer.innerHTML = '';
        if(data.o && data.o.length > 1) {
            tabsContainer.classList.remove('hidden');
            data.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `py-1.5 px-5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border`;
                if (idx === 0) {
                    btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--accent)';
                    btn.style.boxShadow = 'var(--shadow-md)';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.color = 'var(--text-muted)';
                    btn.style.borderColor = 'rgba(255,255,255,0.2)';
                }
                btn.textContent = `Option ${getLetter(idx)}`;
                tabsContainer.appendChild(btn);
            });
        } else {
            tabsContainer.classList.add('hidden');
        }
        
        // Setup first option display
        if (typeof setupClientOption === 'function') {
            setupClientOption(0);
        }
        
        // Clone the client panel content into the floating preview
        const clientPanel = $('clientPanel');
        if (container && clientPanel) {
            container.innerHTML = clientPanel.innerHTML;
            
            // Animate all numeric values in the cloned modal
            if (clientData && clientData.o && clientData.o[0]) {
                const opt = clientData.o[0];
                const calc = calculate(opt.a, opt.f, opt.t, opt.q, opt.fe);
                
                const clonedAmount = container.querySelector('#cPreviewAmount');
                const clonedPayback = container.querySelector('#cPreviewPayback');
                const clonedCount = container.querySelector('#cPreviewCount');
                const clonedFactor = container.querySelector('#cPreviewFactor');
                const clonedCost = container.querySelector('#cPreviewCost');
                const clonedPayment = container.querySelector('#cPreviewPayment');
                const clonedFee = container.querySelector('#cPreviewFee');
                const clonedNet = container.querySelector('#cPreviewNet');
                
                if (clonedAmount) animateNumber(clonedAmount, calc.amount, 1200);
                if (clonedPayback) animateNumber(clonedPayback, calc.totalPayback, 1200);
                if (clonedCount) animateNumber(clonedCount, calc.term, 1200, (n) => Math.round(n).toString());
                if (clonedFactor) animateNumber(clonedFactor, calc.factor, 1200, (n) => n.toFixed(2) + 'x');
                if (clonedCost) animateNumber(clonedCost, calc.totalCost, 1200);
                if (clonedPayment) animateNumber(clonedPayment, calc.payment, 1200);
                if (clonedFee && calc.fee > 0) animateNumber(clonedFee, calc.feeAmount, 1200);
                if (clonedNet && calc.fee > 0) animateNumber(clonedNet, calc.net, 1200);
            }
        }
        
        // Restore panel states - show admin, hide client
        removeClass('adminPanel', 'hidden');
        addClass('clientPanel', 'hidden');
        
        // Show modal
        removeClass('floatingPreviewModal', 'hidden');
        
        
        // Restore scroll position
        window.scrollTo(0, scrollPos);
    }
    
    function openCalculatorPreview(tool) {
        console.log('openCalculatorPreview called with tool:', tool);
        const container = $('floatingPreviewContent');
        const s = loanState;
        
        if (!container) {
          console.error('floatingPreviewContent not found');
          return;
        }
        if (!s) {
          console.error('loanState not defined');
          return;
        }
        
        // Tool display names
        const toolNames = {
          'prequal': 'Pre-Qualify Assessment',
          'mca': 'MCA Calculator',
          'working': 'Working Capital Loan',
          'term': 'Term Loan',
          'loc': 'Line of Credit',
          'sba': 'SBA 7(a) Loan',
          'equipment': 'Equipment Finance',
          'payoff': 'Early Payoff Calculator',
          'cre': 'Commercial Real Estate',
          'factoring': 'Invoice Factoring',
          'apr': 'APR Calculator'
        };
        
        // Get the result card content based on tool
        let resultHTML = '';
        
        switch(tool) {
          case 'prequal':
            resultHTML = getPreQualPreviewHTML();
            break;
          case 'mca':
            resultHTML = getMCAPreviewHTML();
            break;
          case 'working':
            resultHTML = getWorkingCapitalPreviewHTML();
            break;
          case 'term':
            resultHTML = getTermLoanPreviewHTML();
            break;
          case 'loc':
            resultHTML = getLOCPreviewHTML();
            break;
          case 'sba':
            resultHTML = getSBAPreviewHTML();
            break;
          case 'equipment':
            resultHTML = getEquipmentPreviewHTML();
            break;
          case 'payoff':
            resultHTML = getPayoffPreviewHTML();
            break;
          case 'cre':
            resultHTML = getCREPreviewHTML();
            break;
          case 'factoring':
            resultHTML = getFactoringPreviewHTML();
            break;
          case 'apr':
            resultHTML = getAPRPreviewHTML();
            break;
        }
        
        // Build the preview with header
        container.innerHTML = `
          <div class="p-6" style="background: var(--bg-card);">
            <!-- Header -->
            <div class="text-center mb-6 pb-6" style="border-bottom: 1px solid var(--border-primary);">
              <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full mb-4" style="background: linear-gradient(135deg, var(--accent-light), var(--accent)); color: white;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                <span class="text-xs font-bold uppercase tracking-wider">${toolNames[tool] || 'Calculator'}</span>
              </div>
              <p class="text-sm" style="color: var(--text-muted);">Results based on current inputs</p>
            </div>
            
            <!-- Results -->
            <div class="card p-6">
              ${resultHTML}
            </div>
            
            <!-- Footer -->
            <div class="text-center mt-6 pt-4" style="border-top: 1px solid var(--border-primary);">
              <p class="text-xs" style="color: var(--text-muted);">
                Generated by AblesAI • ${new Date().toLocaleDateString()}
              </p>
            </div>
          </div>
        `;
        
        // Show modal
        removeClass('floatingPreviewModal', 'hidden');
        
    }
    
    function openReportPreview(tool) {
        const container = $('floatingPreviewContent');
        
        // Map tool to report type
        const typeMap = {
          'debtschedule': 'debtSchedule',
          'araging': 'arAging',
          'wip': 'wip'
        };
        const type = typeMap[tool];
        const data = reportState[type];
        
        // Generate report HTML
        const reportHTML = generateReportHTML(type, data);
        
        // Build the preview
        container.innerHTML = `
          <div style="background: white; color: #1a1a1a;">
            ${reportHTML}
          </div>
        `;
        
        // Show modal
        removeClass('floatingPreviewModal', 'hidden');
        
    }
    
    // Calculator Preview HTML Generators
    function getMCAPreviewHTML() {
      const s = loanState;
      const payback = s.mcaAmount * s.mcaFactor;
      const cost = payback - s.mcaAmount;
      const totalPayments = s.mcaTerm * (s.mcaFreq === 'daily' ? 21 : (s.mcaFreq === 'weekly' ? 4.33 : 1));
      const payment = payback / totalPayments;
      const principalPct = Math.round((s.mcaAmount / payback) * 100);
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Funding Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.mcaAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Payback</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(payback)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term Length</span>
            <span class="calc-stat-value">${s.mcaTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Payments</span>
            <span class="calc-stat-value">${Math.round(totalPayments)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Rate</span>
            <span class="calc-stat-value font-mono">${s.mcaFactor.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(cost)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">${s.mcaFreq.charAt(0).toUpperCase()+s.mcaFreq.slice(1)} Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getWorkingCapitalPreviewHTML() {
      const s = loanState;
      const monthlyRate = s.wcRate / 100 / 12;
      const payment = s.wcAmount * (monthlyRate * Math.pow(1+monthlyRate, s.wcTerm)) / (Math.pow(1+monthlyRate, s.wcTerm) - 1);
      const totalPayback = payment * s.wcTerm;
      const totalInterest = totalPayback - s.wcAmount;
      const principalPct = Math.round((s.wcAmount / totalPayback) * 100);
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.wcAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPayback)}</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value">${s.wcRate}% APR</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.wcTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(totalInterest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Monthly Payment</span>
            <span class="calc-stat-value">${formatCurrency(payment)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getTermLoanPreviewHTML() {
      const s = loanState;
      const monthlyRate = s.termRate / 100 / 12;
      const payment = s.termAmount * (monthlyRate * Math.pow(1+monthlyRate, s.termTerm)) / (Math.pow(1+monthlyRate, s.termTerm) - 1);
      const totalPayback = payment * s.termTerm;
      const totalInterest = totalPayback - s.termAmount;
      const principalPct = Math.round((s.termAmount / totalPayback) * 100);
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.termAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPayback)}</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value">${s.termRate}% APR</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.termTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(totalInterest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Monthly Payment</span>
            <span class="calc-stat-value">${formatCurrency(payment)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getLOCPreviewHTML() {
      const s = loanState;
      const monthlyInterest = s.locDrawn * (s.locRate / 100 / 12);
      const available = s.locLimit - s.locDrawn;
      const utilization = Math.round((s.locDrawn / s.locLimit) * 100);
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Credit Limit</div>
          <div class="calc-preview-amount">${formatCurrency(s.locLimit)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${utilization} ${100-utilization}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Used</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${utilization}%</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Amount Drawn</span>
            <span class="calc-stat-value">${formatCurrency(s.locDrawn)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Available</span>
            <span class="calc-stat-value">${formatCurrency(available)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value">${s.locRate}% APR</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Monthly Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(monthlyInterest)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Interest Only</div>
          <div class="calc-payment-amount">${formatCurrency(monthlyInterest)}</div>
        </div>`;
    }
    
    function getSBAPreviewHTML() {
      const s = loanState;
      const monthlyRate = s.sbaRate / 100 / 12;
      const payment = s.sbaAmount * (monthlyRate * Math.pow(1+monthlyRate, s.sbaTerm)) / (Math.pow(1+monthlyRate, s.sbaTerm) - 1);
      const totalPayback = payment * s.sbaTerm;
      const totalInterest = totalPayback - s.sbaAmount;
      const principalPct = Math.round((s.sbaAmount / totalPayback) * 100);
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">SBA Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.sbaAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPayback)}</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value">${s.sbaRate}% APR</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${Math.round(s.sbaTerm/12)} years</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(totalInterest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Monthly Payment</span>
            <span class="calc-stat-value">${formatCurrency(payment)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getEquipmentPreviewHTML() {
      const s = loanState;
      const downPayment = s.equipCost * (s.equipDown / 100);
      const financed = s.equipCost - downPayment;
      const monthlyRate = s.equipRate / 100 / 12;
      const payment = financed * (monthlyRate * Math.pow(1+monthlyRate, s.equipTerm)) / (Math.pow(1+monthlyRate, s.equipTerm) - 1);
      const totalPayback = payment * s.equipTerm + downPayment;
      const totalInterest = totalPayback - s.equipCost;
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Equipment Cost</div>
          <div class="calc-preview-amount">${formatCurrency(s.equipCost)}</div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Down Payment</span>
            <span class="calc-stat-value">${formatCurrency(downPayment)} (${s.equipDown}%)</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Amount Financed</span>
            <span class="calc-stat-value">${formatCurrency(financed)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value">${s.equipRate}% APR</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.equipTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(totalInterest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value">${formatCurrency(totalPayback)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getPayoffPreviewHTML() {
      const s = loanState;
      const totalOwed = s.payoffBalance * s.payoffFactor;
      const savings = totalOwed * (s.payoffDiscount / 100);
      const payoffAmount = totalOwed - savings;
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Current Balance</div>
          <div class="calc-preview-amount">${formatCurrency(s.payoffBalance)}</div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Rate</span>
            <span class="calc-stat-value font-mono">${s.payoffFactor.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Owed</span>
            <span class="calc-stat-value">${formatCurrency(totalOwed)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Months Remaining</span>
            <span class="calc-stat-value">${s.payoffRemaining}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Discount</span>
            <span class="calc-stat-value">${s.payoffDiscount}%</span>
          </div>
        </div>
        <div class="calc-payment-display" style="background: linear-gradient(135deg, #10b981, #059669);">
          <div class="calc-payment-label">Payoff Amount</div>
          <div class="calc-payment-amount">${formatCurrency(payoffAmount)}</div>
        </div>
        <div class="text-center mt-4">
          <span class="text-sm font-bold" style="color: #10b981;">You Save ${formatCurrency(savings)}</span>
        </div>`;
    }
    
    function getCREPreviewHTML() {
      const s = loanState;
      const monthlyRate = s.creRate / 100 / 12;
      const payment = s.creAmount * (monthlyRate * Math.pow(1+monthlyRate, s.creTerm)) / (Math.pow(1+monthlyRate, s.creTerm) - 1);
      const totalPayback = payment * s.creTerm;
      const totalInterest = totalPayback - s.creAmount;
      const dscr = (s.creNOI / 12) / payment;
      const propertyValue = s.creAmount / (s.creLTV / 100);
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.creAmount)}</div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Property Value</span>
            <span class="calc-stat-value">${formatCurrency(propertyValue)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">LTV</span>
            <span class="calc-stat-value">${s.creLTV}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value">${s.creRate}% APR</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${Math.round(s.creTerm/12)} years</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Annual NOI</span>
            <span class="calc-stat-value">${formatCurrency(s.creNOI)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">DSCR</span>
            <span class="calc-stat-value ${dscr >= 1.25 ? 'text-green-400' : dscr >= 1.0 ? 'text-yellow-400' : 'text-red-400'}">${dscr.toFixed(2)}x</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getFactoringPreviewHTML() {
      const s = loanState;
      const advance = s.factInvoiceAmount * (s.factAdvanceRate / 100);
      const fee = s.factInvoiceAmount * (s.factFee / 100);
      const reserve = s.factInvoiceAmount - advance;
      const netAfterFee = reserve - fee;
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Invoice Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.factInvoiceAmount)}</div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Advance Rate</span>
            <span class="calc-stat-value">${s.factAdvanceRate}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Advance Amount</span>
            <span class="calc-stat-value">${formatCurrency(advance)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Fee</span>
            <span class="calc-stat-value">${s.factFee}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Fee Amount</span>
            <span class="calc-stat-value accent">${formatCurrency(fee)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Reserve Held</span>
            <span class="calc-stat-value">${formatCurrency(reserve)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Reserve After Fee</span>
            <span class="calc-stat-value">${formatCurrency(netAfterFee)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">You Receive Today</div>
          <div class="calc-payment-amount">${formatCurrency(advance)}</div>
        </div>`;
    }
    
    function getAPRPreviewHTML() {
      const s = loanState;
      const payback = s.aprAmount * s.aprFactor;
      const cost = payback - s.aprAmount;
      const totalPayments = s.aprTerm * (s.aprFreq === 'daily' ? 21 : (s.aprFreq === 'weekly' ? 4.33 : 1));
      const payment = payback / totalPayments;
      const origFeeAmt = s.aprAmount * (s.aprOrigFee / 100);
      const netFunding = s.aprAmount - origFeeAmt;
      
      // Simple APR calculation
      const termYears = s.aprTerm / 12;
      const apr = ((cost + origFeeAmt) / s.aprAmount / termYears) * 100;
      
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Funding Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.aprAmount)}</div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Rate</span>
            <span class="calc-stat-value font-mono">${s.aprFactor.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.aprTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Payback</span>
            <span class="calc-stat-value">${formatCurrency(payback)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Cost of Capital</span>
            <span class="calc-stat-value accent">${formatCurrency(cost)}</span>
          </div>
          ${s.aprOrigFee > 0 ? `
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Orig Fee (${s.aprOrigFee}%)</span>
            <span class="calc-stat-value">${formatCurrency(origFeeAmt)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Net Funding</span>
            <span class="calc-stat-value">${formatCurrency(netFunding)}</span>
          </div>
          ` : ''}
        </div>
        <div class="calc-payment-display" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
          <div class="calc-payment-label">Estimated APR</div>
          <div class="calc-payment-amount">${apr.toFixed(1)}%</div>
        </div>
        <div class="calc-payment-display mt-3">
          <div class="calc-payment-label">${s.aprFreq.charAt(0).toUpperCase()+s.aprFreq.slice(1)} Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getPreQualPreviewHTML() {
      const s = loanState;
      const criteria = s.prequalCriteria || {
        monthlyRevenue: 50000, avgDailyBalance: 8000, creditScore: 650,
        monthsInBusiness: 24, nsfCount: 2, negativeDays: 1, isRestricted: false
      };
      
      // Run ABLESCORE v4.1 Engine
      const engine = new PerrepusAI_v4_1(criteria);
      const result_data = engine.process();
      const isApproved = result_data.status === "APPROVED";
      
      if (!isApproved) {
        return `
          <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-24 h-24 rounded-full mb-4" style="background: #ef444420; border: 3px solid #ef4444;">
              <svg class="w-12 h-12" style="color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </div>
            <div class="text-xl font-bold" style="color: #ef4444;">DECLINED</div>
            <div class="text-xs mt-2" style="color: var(--text-muted);">${result_data.reason}</div>
          </div>`;
      }
      
      const score = result_data.score.value;
      const tier = result_data.score.tierId;
      const tierColors = { 'A': '#10b981', 'B': '#22c55e', 'C': '#eab308', 'D': '#f97316', 'E': '#ef4444' };
      const gradeColor = tierColors[tier] || '#6366f1';
      const o = result_data.offer;
      const c = result_data.closing;
      
      // Risk indicators for D/E tiers
      const isHighRisk = tier === 'D' || tier === 'E';
      const riskLabel = tier === 'E' ? '⚠ HIGH RISK' : tier === 'D' ? '⚠ ELEVATED RISK' : '';
      const riskMsg = tier === 'E' ? 'Very Aggressive' : tier === 'D' ? 'Aggressive' : '';
      const riskBadge = isHighRisk ? `
        <div class="flex flex-col items-center gap-1 mt-2 px-3 py-2 rounded" style="background: ${gradeColor}20; border: 1px solid ${gradeColor}40;">
          <div class="flex items-center gap-1">
            <svg class="w-3 h-3" style="color: ${gradeColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span class="text-[10px] font-bold uppercase" style="color: ${gradeColor};">${riskLabel}</span>
          </div>
          <span class="text-[9px]" style="color: ${gradeColor};">${riskMsg} Underwriting</span>
        </div>` : '';
      
      return `
        <div class="text-center mb-6">
          <div class="inline-flex items-center justify-center w-24 h-24 rounded-full mb-4" style="background: ${gradeColor}20; border: 3px solid ${gradeColor};">
            <span class="text-3xl font-bold" style="color: ${gradeColor};">TIER ${tier}</span>
          </div>
          <div class="text-2xl font-bold" style="color: var(--text-primary);">${score}/100</div>
          <div class="text-xs uppercase tracking-wider mt-1" style="color: var(--text-muted);">${result_data.score.tier}</div>
          ${riskBadge}
        </div>
        <div class="space-y-2">
          <div class="flex items-center justify-between py-2" style="border-bottom: 1px solid var(--border-secondary);">
            <span class="text-xs font-medium" style="color: var(--text-secondary);">Approved Amount</span>
            <span class="text-sm font-bold" style="color: var(--accent);">${formatCurrency(o.funding_amount)}</span>
          </div>
          <div class="flex items-center justify-between py-2" style="border-bottom: 1px solid var(--border-secondary);">
            <span class="text-xs font-medium" style="color: var(--text-secondary);">Factor Rate</span>
            <span class="text-sm font-bold" style="color: ${isHighRisk ? gradeColor : 'var(--text-primary)'};">${o.factor_rate.toFixed(2)}x</span>
          </div>
          <div class="flex items-center justify-between py-2" style="border-bottom: 1px solid var(--border-secondary);">
            <span class="text-xs font-medium" style="color: var(--text-secondary);">Term</span>
            <span class="text-sm font-bold" style="color: var(--text-primary);">${(o.term_label || o.term + ' Months')}</span>
          </div>
          <div class="flex items-center justify-between py-2" style="border-bottom: 1px solid var(--border-secondary);">
            <span class="text-xs font-medium" style="color: var(--text-secondary);">Daily Payment</span>
            <span class="text-sm font-bold" style="color: var(--text-primary);">${formatCurrency(result_data.schedule.daily_payment)}</span>
          </div>
          <div class="flex items-center justify-between py-2" style="border-bottom: 1px solid var(--border-secondary);">
            <span class="text-xs font-medium" style="color: var(--text-secondary);">Net Wire</span>
            <span class="text-sm font-bold" style="color: #10b981;">${formatCurrency(c.net_wire)}</span>
          </div>
        </div>`;
    }
    
    function closeFloatingPreview() {
        addClass('floatingPreviewModal', 'hidden');
        
    }
    
    function copyLinkFromPreview() {
        let link = '';
        
        if (currentTool === 'offer') {
            // Use existing offer link generator
            link = getLink();
        } else if (['debtschedule', 'araging', 'wip'].includes(currentTool)) {
            // Generate report link
            const typeMap = { 'debtschedule': 'debtSchedule', 'araging': 'arAging', 'wip': 'wip' };
            const type = currentTool;
            const data = reportState[typeMap[type]];
            const reportId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            const encoded = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            link = window.location.origin + window.location.pathname + '?report=' + type + '&rid=' + reportId + '&rd=' + encoded;
            
            // Save to tracking dashboard
            saveReportToDashboard(type, data, link);
        }
        
        if (link) {
            navigator.clipboard.writeText(link).then(() => {
                showToast('Link copied!');
            }).catch(() => {
                prompt('Copy this link:', link);
            });
        }
    }
    
    function previewISOView() {
        console.log('=== previewISOView START ===');
        try {
            // Track ISO view
            window.isoViewed = true;
            updateModeStatusIcons();
            
            // Update tracking for existing offer if link exists
            const currentLink = getLink();
            updateOfferTrackingByLink(currentLink, 'isoView');
            
            // Get current lender rates (use defaults if in ISO mode)
            const buyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
            const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
            console.log('Rates - Buy:', buyRate, 'MaxSell:', maxSell);
            
            // Temporarily enable ISO preview mode flags
            window.isoShareMode = true;
            window.isoPreviewMode = true;
            lenderBuyRate = buyRate;
            lenderMaxSellRate = maxSell;
            
            // Expand Structure Your Offer card if collapsed (for mobile)
            const structureCard = $('structureOfferCard');
            if (structureCard && structureCard.classList.contains('collapsed')) {
                structureCard.classList.remove('collapsed');
            }
            
            // Set up ISO upsell slider with correct bounds
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            console.log('Slider elements - sellSlider:', !!sellSlider, 'sellInput:', !!sellInput);
            
            if (sellSlider && sellInput) {
                // Set bounds first
                sellSlider.min = buyRate;
                sellSlider.max = maxSell;
                sellSlider.step = 0.01;
                
                // Default to max sell rate (full margin for ISO)
                sellSlider.value = maxSell;
                sellInput.value = maxSell.toFixed(2);
                
                updateSliderFill(sellSlider);
                console.log('Slider configured');
            }
            
            // Update buy rate display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
            
            // Show ISO section, hide lender section
            const isoUpsellSection = $('isoUpsellSection');
            const lenderRateSection = $('lenderRateSection');
            console.log('Sections - isoUpsell:', !!isoUpsellSection, 'lenderRate:', !!lenderRateSection);
            
            if (isoUpsellSection) {
                isoUpsellSection.classList.remove('hidden');
                console.log('isoUpsellSection shown');
            }
            if (lenderRateSection) {
                lenderRateSection.classList.add('hidden');
                console.log('lenderRateSection hidden');
            }
            
            // Set factor rate to max sell rate (ISO's default sell rate)
            const calcFactor = $('calcFactor');
            const calcFactorSlider = $('calcFactorSlider');
            if (calcFactor) calcFactor.value = maxSell.toFixed(2);
            if (calcFactorSlider) {
                calcFactorSlider.value = maxSell;
                updateSliderFill(calcFactorSlider);
            }
            
            // Update ISO profit display and recalculate with animation
            updateIsoUpsell();
            updatePreview(true);
            
            // Show ISO preview bar
            const previewBar = $('isoPreviewBar');
            console.log('isoPreviewBar element:', !!previewBar);
            if (previewBar) {
                previewBar.classList.remove('hidden');
                document.body.style.paddingTop = '72px';
                console.log('isoPreviewBar shown');
            }
            
            showToast('ISO Preview: Showing what your ISO partner sees');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('=== previewISOView END ===');
        } catch(e) {
            console.error('previewISOView error:', e);
            showToast('Error entering ISO preview mode');
        }
    }
    
    function exitISOPreview() {
        window.isoShareMode = false;
        window.isoPreviewMode = false;
        
        const isoUpsellSection = $('isoUpsellSection');
        const lenderRateSection = $('lenderRateSection');
        const isoPreviewBar = $('isoPreviewBar');
        
        // Restore based on current client mode
        if (currentClientMode === 'lender') {
            if (lenderRateSection) lenderRateSection.classList.remove('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
            // Restore lender display (resets factor rate to buy rate)
            updateLenderDisplay();
        } else {
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
        }
        
        // Hide preview bar
        if (isoPreviewBar) isoPreviewBar.classList.add('hidden');
        document.body.style.paddingTop = '0';
        
        updatePreview();
        showToast('Returned to editor mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exitPreview() {
        addClass('clientPanel', 'hidden');
        removeClass('adminPanel', 'hidden');
        addClass('clientPreviewBar', 'hidden');
        document.body.style.paddingTop = '0';
        
        
        // Reset mode toggle buttons
        const clientBtn = $('clientModeBtn');
        const isoBtn = $('isoModeBtn');
        const lenderBtn = $('lenderModeBtn');
        if (clientBtn) clientBtn.classList.remove('active');
        if (currentClientMode === 'iso') {
            if (isoBtn) isoBtn.classList.add('active');
        } else {
            if (lenderBtn) lenderBtn.classList.add('active');
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function acceptOffer() {
        // Track acceptance
        window.clientAccepted = true;
        updateModeStatusIcons();
        
        // Update tracking in dashboard
        const currentUrl = window.location.href;
        updateOfferTrackingByLink(currentUrl, 'clientAccept');
        
        // Get accent color for confetti
        const style = getComputedStyle(document.documentElement);
        const accent = style.getPropertyValue('--accent').trim();
        const accentLight = style.getPropertyValue('--accent-light').trim();
        const accentDark = style.getPropertyValue('--accent-dark').trim();
        
        confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 },
            colors: [accent, accentLight, accentDark]
        });
        removeClass('successModal', 'hidden');
    }

    function declineOffer() {
        if (confirm('Are you sure you want to decline this offer?')) {
            // Track decline
            window.clientDeclined = true;
            updateModeStatusIcons();
            
            // Update tracking in dashboard
            const currentUrl = window.location.href;
            updateOfferTrackingByLink(currentUrl, 'clientDecline');
            
            showToast('Offer declined. Thank you for your consideration.');
        }
    }

    function initClientView(data) {
        console.log('initClientView called with:', data);
        addClass('adminPanel', 'hidden');
        removeClass('clientPanel', 'hidden');
        
        console.log('panels toggled');
        
        clientData = data;
        clientActiveIdx = 0;
        
        $('clientGreeting').textContent = `Hello, ${data.c || 'Business Owner'}`;
        $('clientBusinessName').textContent = data.b || 'your business';
        if(data.ex) {
            removeClass('clientExpirySection', 'hidden');
            $('clientExpiryDate').textContent = new Date(data.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }
        
        // Handle Source Info (ISO/Lender)
        if (data.iso || data.ln) {
            removeClass('clientSourceSection', 'hidden');
            const isoTag = $('clientISOTag');
            const lenderTag = $('clientLenderTag');
            if (data.iso) {
                if (isoTag) {
                    isoTag.textContent = data.iso;
                    isoTag.classList.remove('hidden');
                }
            } else {
                if (isoTag) isoTag.classList.add('hidden');
            }
            if (data.ln) {
                if (lenderTag) {
                    lenderTag.textContent = data.ln;
                    lenderTag.classList.remove('hidden');
                }
            } else {
                if (lenderTag) lenderTag.classList.add('hidden');
            }
        } else {
            addClass('clientSourceSection', 'hidden');
        }

        // Handle logo in client view
        const cLogoContainer = $('cPreviewLogoContainer');
        const cLogo = $('cPreviewLogo');
        if (data.logo) {
            if (cLogo) {
                cLogo.referrerPolicy = 'no-referrer';
                cLogo.src = data.logo;
                cLogo.onerror = function() {
                    if (cLogoContainer) cLogoContainer.classList.add('hidden');
                };
                cLogo.onload = function() {
                    if (cLogoContainer) cLogoContainer.classList.remove('hidden');
                };
            }
        } else {
            if (cLogoContainer) cLogoContainer.classList.add('hidden');
        }

        // Handle company name in client view
        const cCompanyName = $('cPreviewCompanyName');
        if (data.companyName) {
            if (cCompanyName) {
                cCompanyName.textContent = data.companyName;
                cCompanyName.classList.remove('hidden');
            }
        } else {
            if (cCompanyName) cCompanyName.classList.add('hidden');
        }

        // Apply theme from share link
        if (data.theme) {
            setThemeMode(data.theme);
        }
        if (data.accent) {
            setAccentColor(data.accent);
        }

        const tabsContainer = $('clientTabsContainer');
        if (!tabsContainer) return;
        tabsContainer.innerHTML = '';
        if(data.o.length > 1) {
             tabsContainer.classList.remove('hidden');
             data.o.forEach((opt, idx) => {
                 const btn = document.createElement('button');
                 btn.className = `py-1.5 px-5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border`;
                 if (idx === 0) {
                     btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
                     btn.style.color = 'white';
                     btn.style.borderColor = 'var(--accent)';
                     btn.style.boxShadow = 'var(--shadow-md)';
                 } else {
                     btn.style.background = 'rgba(255,255,255,0.1)';
                     btn.style.color = 'var(--text-muted)';
                     btn.style.borderColor = 'rgba(255,255,255,0.2)';
                 }
                 btn.textContent = `Option ${getLetter(idx)}`;
                 btn.onclick = () => switchClientTab(idx, btn);
                 tabsContainer.appendChild(btn);
             });
        } else {
             tabsContainer.classList.add('hidden');
        }
        
        setupClientOption(0);
    }

    function switchClientTab(idx, btn) {
        clientActiveIdx = idx;
        const tabsEl = $('clientTabsContainer');
        if (!tabsEl) return;
        const btns = tabsEl.children;
        Array.from(btns).forEach(b => {
            b.style.background = 'rgba(255,255,255,0.1)';
            b.style.color = 'var(--text-muted)';
            b.style.borderColor = 'rgba(255,255,255,0.2)';
            b.style.boxShadow = 'none';
        });
        btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--accent)';
        btn.style.boxShadow = 'var(--shadow-md)';
        setupClientOption(idx);
    }

    function setupClientOption(idx) {
        console.log('setupClientOption called with idx:', idx);
        const opt = clientData.o[idx];
        console.log('opt:', opt);
        const maxAmt = opt.a;
        console.log('maxAmt:', maxAmt);
        
        clientSelectedAmount = maxAmt; 
        
        $('clientMaxLabelSlider').textContent = `Max ${formatCurrency(maxAmt)}`;
        
        const slider = $('clientAmountSlider');
        slider.min = 5000;
        slider.max = maxAmt;
        slider.step = 1; 
        slider.value = maxAmt;
        updateSliderFill(slider);
        
        const hasNotes = !!opt.n;
        const hasExpiry = !!clientData.ex; 
        const hasDocs = !!opt.d; 
        
        const termsContainer = $('clientTermsContainer');
        const expirySection = $('clientExpirySection');
        const notesSection = $('clientNotesSection');
        const docsSection = $('clientDocsSection');
        const notesDocsRow = $('clientNotesDocsRow');
        
        if (hasNotes || hasExpiry || hasDocs) {
            termsContainer.classList.remove('hidden');
            
            // Expiration Section
            if (hasExpiry) {
                expirySection.classList.remove('hidden');
                $('clientExpiryDate').textContent = new Date(clientData.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); 
            } else {
                expirySection.classList.add('hidden');
            }
            
            // Notes & Docs Row
            if (hasNotes || hasDocs) {
                notesDocsRow.classList.remove('hidden');
            } else {
                notesDocsRow.classList.add('hidden');
            }
            
            // Notes Section
            if (hasNotes) {
                notesSection.classList.remove('hidden');
                const notesList = $('clientNotesList');
                notesList.innerHTML = '';
                const items = opt.n.split('\n');
                items.forEach(item => {
                    if (!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    notesList.appendChild(li);
                });
            } else {
                notesSection.classList.add('hidden');
            }

            // Documents Section
            if (hasDocs) {
                docsSection.classList.remove('hidden');
                const docsList = $('clientDocsList');
                docsList.innerHTML = '';
                const items = (opt.dt || "Voided Check\nGovernment Issued ID").split('\n');
                
                items.forEach(item => {
                    if(!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="color: #8b5cf6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    docsList.appendChild(li);
                });

            } else {
                docsSection.classList.add('hidden');
            }

        } else {
            termsContainer.classList.add('hidden');
        }

        updateClientPreview(true);
    }

    function updateClientPreview(animate = false) {
        const opt = clientData.o[clientActiveIdx];
        const amt = clientSelectedAmount;
        
        const calc = calculate(amt, opt.f, opt.t, opt.q, opt.fe);
        
        if (clientData.o.length > 1) {
             addClass('cPreviewLabelContainer', 'hidden');
        } else {
             addClass('cPreviewLabelContainer', 'hidden');
        }

        // Animate all numeric values
        animateNumber($('cPreviewAmount'), calc.amount, 1200);
        animateNumber($('cPreviewPayback'), calc.totalPayback, 1200);
        
        $('cPreviewTerm').textContent = getTermDisplay(opt.t, opt.q, opt.to);
        animateNumber($('cPreviewCount'), calc.term, 1200, (n) => Math.round(n).toString());
        animateNumber($('cPreviewFactor'), calc.factor, 1200, (n) => n.toFixed(2) + 'x');
        animateNumber($('cPreviewCost'), calc.totalCost, 1200);
        
        if(calc.fee > 0) {
            removeClass('cPreviewFeeRow', 'hidden');
            animateNumber($('cPreviewFee'), calc.feeAmount, 1200);
            animateNumber($('cPreviewNet'), calc.net, 1200);
        } else {
            addClass('cPreviewFeeRow', 'hidden');
        }
        
        // Prepay discount
        if (opt.pp && opt.pp > 0) {
            removeClass('cPreviewPrepayRow', 'hidden');
            if (opt.pd) {
                $('cPreviewPrepay').textContent = opt.pp + '% off if paid by ' + new Date(opt.pd).toLocaleDateString();
            } else {
                $('cPreviewPrepay').textContent = opt.pp + '% off if paid early';
            }
        } else {
            addClass('cPreviewPrepayRow', 'hidden');
        }
        
        const pLabel = opt.q === 'weekly' ? 'Weekly Payment' : opt.q === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('cPreviewPaymentLabel').textContent = pLabel;
        animateNumber($('cPreviewPayment'), calc.payment, 1200);
        
        const pp = calc.totalPayback > 0 ? (calc.amount / calc.totalPayback) * 100 : 0; 
        $('cPreviewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function updateSliderFill(s) { 
        if (!s) return; 
        const m = parseFloat(s.min), mx = parseFloat(s.max), v = parseFloat(s.value);
        const p = ((v - m) / (mx - m)) * 100; 
        const isDark = s.classList.contains('slider-dark');
        const trackColor = isDark ? 'rgba(255,255,255,0.12)' : 'var(--slider-track)';
        s.style.background = `linear-gradient(to right, var(--accent) 0%, var(--accent-light) ${p}%, ${trackColor} ${p}%, ${trackColor} 100%)`; 
    }
    
    function updateSliders() { 
        $$('.slider').forEach(s => updateSliderFill(s)); 
    }

    function toggleSection(id, show) { 
        const el = $('sec'+id); 
        if(show) { 
            el.classList.remove('hidden'); 
            el.classList.add('fade-enter'); 
            updatePreview();
        } else { 
            el.classList.add('hidden'); 
            updatePreview(); 
        } 
    }

    function setFrequency(f) { 
        $$('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.freq === f)); 
        updatePreview(); 
    }

    function resetCalculator() { 
        calcOptions = [initDefaultOption()]; 
        activeCalcTab = 0; 
        setVal('calcBusinessName',''); setVal('calcContactName',''); 
        setVal('calcISOName',''); setVal('calcLenderName','');
        ['toggleFee','togglePrepay','toggleOverride','toggleExpiry','toggleNotes','toggleDocs','toggleISO','toggleLender'].forEach(id => { 
            const el = $(id); if(el) { el.checked = false; toggleSection(id.replace('toggle',''), false); }
        });
        updateTabsUI(); loadState(0); updatePreview(); updateSliders(); 
        showToast('Calculator Reset');
    }
    
    function shareOffer() { 
        saveState(activeCalcTab);
        
        // Populate the preview with current calculator result
        const previewContainer = document.getElementById('sharePreviewContainer');
        if (previewContainer) {
            // Find the current active result card
            const toolMap = {
                'offer': 'previewCard',
                'prequal': 'prequalResultCard',
                'ablescore': 'prequalResultCard',
                'mca': 'mcaResultCard',
                'working': 'workingResultCard',
                'term': 'termResultCard',
                'loc': 'locResultCard',
                'sba': 'sbaResultCard',
                'equipment': 'equipResultCard',
                'payoff': 'payoffResultCard',
                'cre': 'creResultCard',
                'factoring': 'factoringResultCard',
                'apr': 'aprResultCard'
            };
            const cardId = toolMap[currentTool] || 'previewCard';
            const sourceCard = document.getElementById(cardId);
            if (sourceCard) {
                previewContainer.innerHTML = sourceCard.innerHTML;
                // Remove the share button from the preview clone
                const clonedBtn = previewContainer.querySelector('.calc-card-share-btn');
                if (clonedBtn) clonedBtn.remove();
            }
        }
        
        removeClass('shareModal', 'hidden'); 
    }

    function getLink() {
        saveState(activeCalcTab);
        const d = { 
            b: getVal('calcBusinessName'), c: getVal('calcContactName'), 
            iso: $('toggleISO')?.checked ? getVal('calcISOName') : null, 
            ln: $('toggleLender')?.checked ? getVal('calcLenderName') : null,
            ex: $('toggleExpiry')?.checked ? getVal('calcExpiryDate') : null,
            logo: currentLogoUrl,
            companyName: currentCompanyName,
            theme: currentTheme,
            accent: currentAccent,
            o: calcOptions.map(op => ({ 
                a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, pd: op.prepayDate, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText,
                lk: op.locked ? 1 : 0,
                la: op.lockedAmount,
                lt: op.lockedTerm,
                lq: op.lockedFrequency,
                lb: op.lockedBuyRate,
                lm: op.lockedMaxSell
            }))
        };
        const json = JSON.stringify(d);
        const enc = LZString.compressToEncodedURIComponent(json);
        return `${window.location.origin}${window.location.pathname}?d=${enc}`;
    }
    
    function copyLink() { 
        // Check lite usage limit
        if (!canUseLiteShare()) {
            showUpgradeModal();
            return;
        }
        
        const l = getLink(); 
        saveOfferToDashboard(l, 'clientShareLink'); // Save offer to dashboard with tracking
        
        // Mark as shared and update UI
        window.clientLinkShared = true;
        updateModeStatusIcons();
        
        // Increment usage for lite users
        if (!currentUser) {
            incrementLiteUsage();
        }
        
        if (navigator.clipboard) { navigator.clipboard.writeText(l).then(() => showToast('Link copied!')).catch(() => prompt("Copy Link:", l)); } else { prompt("Copy Link:", l); }
        addClass('shareModal', 'hidden');
    }
    
    function copySMS() {
        // Check lite usage limit
        if (!canUseLiteShare()) {
            showUpgradeModal();
            return;
        }
        
        // Build minimal link for SMS (shorter URL)
        const smsLink = getSMSLink();
        saveOfferToDashboard(smsLink, 'smsShare');
        
        // Mark as shared and update UI
        window.clientLinkShared = true;
        updateModeStatusIcons();
        
        // Increment usage for lite users
        if (!currentUser) {
            incrementLiteUsage();
        }
        
        // Build compact SMS message
        const opt = calcOptions[0];
        const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
        
        // Format amount (50K or $50,000)
        const amt = opt.amount >= 1000 ? '$' + Math.round(opt.amount / 1000) + 'K' : '$' + opt.amount;
        
        // Get business or contact name
        const businessName = getVal('calcBusinessName') || '';
        const contactName = getVal('calcContactName') || '';
        const name = businessName || contactName || 'Your Business';
        
        // Build message: [Amount] Approval for [Name] - View or Accept: [URL]
        const sms = `${amt} Approval for ${name} - View or Accept: ${smsLink}`;
        
        if (navigator.clipboard) { 
            navigator.clipboard.writeText(sms).then(() => showToast('SMS copied!')).catch(() => prompt("Copy SMS:", sms)); 
        } else { 
            prompt("Copy SMS:", sms); 
        }
        addClass('shareModal', 'hidden');
    }
    
    function getSMSLink() {
        // Generate minimal link for SMS (excludes non-essential data)
        saveState(activeCalcTab);
        const d = { 
            b: getVal('calcBusinessName'), 
            c: getVal('calcContactName'),
            theme: currentTheme,
            accent: currentAccent,
            o: calcOptions.map(op => ({ 
                a: op.amount, f: op.factor, t: op.term, q: op.frequency, to: op.termOverride
            }))
        };
        const json = JSON.stringify(d);
        const enc = LZString.compressToEncodedURIComponent(json);
        return `${window.location.origin}${window.location.pathname}?d=${enc}`;
    }
    
    // ============================================
    // OFFER DASHBOARD FUNCTIONS
    // ============================================
    
    function getStoredOffers() {
        try {
            const offers = JSON.parse(localStorage.getItem('trustbureau_offers') || '[]');
            // Filter out any corrupted/incomplete offers
            return offers.filter(o => o && o.id && o.factor !== undefined);
        } catch (e) {
            return [];
        }
    }
    
    function saveStoredOffers(offers) {
        localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
    }
    
    function saveOfferToDashboard(link, trackingEvent = 'created') {
        const offers = getStoredOffers();
        const businessName = getVal('calcBusinessName') || 'Unnamed Business';
        const contactName = getVal('calcContactName') || '';
        const isoName = getVal('calcISOName') || '';
        const lenderName = getVal('calcLenderName') || '';
        
        // Check if offer with this link already exists
        const existingOffer = offers.find(o => o.link === link);
        if (existingOffer) {
            // Update business name and ISO/Lender name if changed
            if (businessName && businessName !== 'Unnamed Business') {
                existingOffer.businessName = businessName;
            }
            if (isoName) existingOffer.isoName = isoName;
            if (lenderName) existingOffer.lenderName = lenderName;
            if (contactName) existingOffer.contactName = contactName;
            // Update tracking on existing offer
            updateOfferTracking(existingOffer.id, trackingEvent);
            return existingOffer.id;
        }
        
        // Get first option details for summary
        const opt = calcOptions[0];
        if (!opt || !opt.factor) {
            console.warn('No valid option to save');
            return null;
        }
        const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
        
        const offer = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            businessName: businessName,
            contactName: contactName,
            isoName: isoName,
            lenderName: lenderName,
            amount: opt.amount || 0,
            factor: opt.factor || 1.0,
            term: opt.term || 0,
            frequency: opt.frequency || 'daily',
            payment: cal.payment || 0,
            totalPayback: cal.totalPayback || 0,
            optionCount: calcOptions.length,
            link: link,
            createdAt: new Date().toISOString(),
            mode: currentClientMode || 'iso',
            // Tracking fields
            tracking: {
                lenderLocked: null,
                isoShared: null,
                isoViewed: null,
                clientShared: null,
                clientShareMethod: null, // 'link' or 'email'
                clientViewed: null,
                clientDeclined: null,
                clientAccepted: null
            }
        };
        
        // Set initial tracking based on event
        if (trackingEvent === 'lenderLock') {
            offer.tracking.lenderLocked = new Date().toISOString();
        } else if (trackingEvent === 'isoShare') {
            offer.tracking.isoShared = new Date().toISOString();
        } else if (trackingEvent === 'clientShareLink') {
            offer.tracking.clientShared = new Date().toISOString();
            offer.tracking.clientShareMethod = 'link';
        } else if (trackingEvent === 'clientShareEmail') {
            offer.tracking.clientShared = new Date().toISOString();
            offer.tracking.clientShareMethod = 'email';
        }
        
        offers.unshift(offer); // Add to beginning
        
        // Keep max 100 offers
        if (offers.length > 100) {
            offers.splice(100);
        }
        
        saveStoredOffers(offers);
        updateOfferCount();
        return offer.id;
    }
    
    function updateOfferTracking(offerId, event) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (!offer) return;
        
        // Initialize tracking if missing
        if (!offer.tracking) {
            offer.tracking = {
                lenderLocked: null,
                isoShared: null,
                isoViewed: null,
                clientShared: null,
                clientShareMethod: null,
                clientViewed: null,
                clientDeclined: null,
                clientAccepted: null
            };
        }
        
        const now = new Date().toISOString();
        
        switch(event) {
            case 'lenderLock':
                offer.tracking.lenderLocked = now;
                break;
            case 'isoShare':
                offer.tracking.isoShared = now;
                break;
            case 'isoView':
                offer.tracking.isoViewed = now;
                break;
            case 'clientShareLink':
                offer.tracking.clientShared = now;
                offer.tracking.clientShareMethod = 'link';
                break;
            case 'clientShareEmail':
                offer.tracking.clientShared = now;
                offer.tracking.clientShareMethod = 'email';
                break;
            case 'clientView':
                offer.tracking.clientViewed = now;
                break;
            case 'clientDecline':
                offer.tracking.clientDeclined = now;
                break;
            case 'clientAccept':
                offer.tracking.clientAccepted = now;
                break;
        }
        
        saveStoredOffers(offers);
        renderOffersDashboard();
    }
    
    function updateOfferTrackingByLink(link, event) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.link === link);
        if (offer) {
            updateOfferTracking(offer.id, event);
        }
    }
    
    function getOfferStatus(offer) {
        if (!offer.tracking) return { label: 'Pending', class: 'pending' };
        
        const t = offer.tracking;
        if (t.clientAccepted) return { label: 'Accepted', class: 'accepted' };
        if (t.clientDeclined) return { label: 'Declined', class: 'declined' };
        if (t.clientViewed) return { label: 'Client Viewed', class: 'client-viewed' };
        if (t.clientShared) return { label: 'With Client', class: 'client-shared' };
        if (t.isoViewed) return { label: 'ISO Viewed', class: 'iso-viewed' };
        if (t.isoShared) return { label: 'With ISO', class: 'iso-shared' };
        if (t.lenderLocked) return { label: 'Locked', class: 'locked' };
        return { label: 'Draft', class: 'draft' };
    }
    
    function updateOfferCount() {
        const offers = getStoredOffers();
        const countEl = $('offerCount');
        const stickyCountEl = $('stickyOfferCount');
        if (offers.length > 0) {
            if (countEl) {
                countEl.textContent = offers.length;
                countEl.classList.remove('hidden');
            }
            if (stickyCountEl) {
                stickyCountEl.textContent = offers.length;
                stickyCountEl.classList.remove('hidden');
            }
        } else {
            if (countEl) countEl.classList.add('hidden');
            if (stickyCountEl) stickyCountEl.classList.add('hidden');
        }
    }
    
    function loadOfferCount() {
        updateOfferCount();
    }
    
    // Pipeline view state
    window.pipelineView = 'list';
    window.showArchived = false;
    window.showStarredOnly = false;
    window.chartPeriod = 'week';
    window.currentMetricFilter = 'all';
    
    const STALE_DAYS = 3; // Days before an offer is considered stale
    const AVAILABLE_TAGS = [
        { id: 'hot-lead', label: 'Hot Lead', color: '#f87171' },
        { id: 'renewal', label: 'Renewal', color: '#34d399' },
        { id: 'referral', label: 'Referral', color: '#a78bfa' },
        { id: 'follow-up', label: 'Follow Up', color: '#fbbf24' },
        { id: 'vip', label: 'VIP', color: '#f472b6' }
    ];
    
    function openDashboard() {
        renderOffersDashboard();
        removeClass('dashboardModal', 'hidden');
        
        // Re-attach Clear All button handler each time modal opens
        setTimeout(() => {
            const clearBtn = $('clearAllBtn');
            if (clearBtn) {
                clearBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.opacity = '0.5';
                    clearAllOffers();
                    this.style.opacity = '1';
                };
            }
        }, 100);
    }
    
    function closeDashboard() {
        addClass('dashboardModal', 'hidden');
    }
    
    function renderOffersDashboard(searchFilter = '') {
        const allOffers = getStoredOffers();
        
        // Filter archived unless showing
        let offers = window.showArchived 
            ? allOffers 
            : allOffers.filter(o => !o.archived);
        
        // Render enhanced stats
        renderEnhancedStats(offers);
        
        // Render volume chart
        renderVolumeChart(allOffers);
        
        // Filter by search
        let filtered = searchFilter 
            ? offers.filter(o => (o.businessName || '').toLowerCase().includes(searchFilter.toLowerCase()) ||
                                 (o.isoName || '').toLowerCase().includes(searchFilter.toLowerCase()) ||
                                 (o.lenderName || '').toLowerCase().includes(searchFilter.toLowerCase()) ||
                                 (o.contactName || '').toLowerCase().includes(searchFilter.toLowerCase()))
            : offers;
        
        // Filter starred only
        if (window.showStarredOnly) {
            filtered = filtered.filter(o => o.starred);
        }
        
        // Sort: starred first, then by date
        filtered.sort((a, b) => {
            if (a.starred && !b.starred) return -1;
            if (!a.starred && b.starred) return 1;
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        
        // Render based on view
        if (window.pipelineView === 'kanban') {
            addClass('offersTableContainer', 'hidden');
            removeClass('kanbanContainer', 'hidden');
            renderKanbanBoard(filtered);
        } else {
            removeClass('offersTableContainer', 'hidden');
            addClass('kanbanContainer', 'hidden');
            renderListView(filtered, offers.length, searchFilter);
        }
        
        // Update toolbar button states
        toggleClass('showArchivedBtn', 'active', window.showArchived);
        toggleClass('showStarredBtn', 'active', window.showStarredOnly);
    }
    
    function renderEnhancedStats(offers) {
        const container = $('enhancedStats');
        if (!container) return;
        
        const total = offers.length;
        if (total === 0) {
            container.innerHTML = `
                <div class="enhanced-stat"><div class="enhanced-stat-value">0</div><div class="enhanced-stat-label">ISO</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Re-share Rate</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Client Share Rate</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Client View Rate</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Acceptance Rate</div></div>
            `;
            return;
        }
        
        // Calculate stats from tracking
        let isoShares = 0, reShares = 0, clientShares = 0, clientViews = 0, clientAccepts = 0;
        
        offers.forEach(o => {
            const t = o.tracking || {};
            if (t.isoShared) isoShares++;
            if (t.reshareCount && t.reshareCount > 0) reShares++;
            if (t.clientShared) clientShares++;
            if (t.clientViewed) clientViews++;
            if (t.clientAccepted) clientAccepts++;
        });
        
        // Calculate rates
        const reShareRate = total > 0 ? Math.round((reShares / total) * 100) : 0;
        const clientShareRate = total > 0 ? Math.round((clientShares / total) * 100) : 0;
        const clientViewRate = clientShares > 0 ? Math.round((clientViews / clientShares) * 100) : 0;
        const acceptanceRate = clientViews > 0 ? Math.round((clientAccepts / clientViews) * 100) : 0;
        
        container.innerHTML = `
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${isoShares}</div>
                <div class="enhanced-stat-label">ISO</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${reShareRate}%</div>
                <div class="enhanced-stat-label">Re-share Rate</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${clientShareRate}%</div>
                <div class="enhanced-stat-label">Client Share Rate</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${clientViewRate}%</div>
                <div class="enhanced-stat-label">Client View Rate</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${acceptanceRate}%</div>
                <div class="enhanced-stat-label">Acceptance Rate</div>
            </div>
        `;
    }
    
    function renderVolumeChart(offers) {
        const container = $('volumeChart');
        if (!container) return;
        
        const now = new Date();
        const isWeek = window.chartPeriod === 'week';
        const periods = isWeek ? 7 : 4;
        const data = [];
        
        for (let i = periods - 1; i >= 0; i--) {
            let start, end, label;
            if (isWeek) {
                start = new Date(now);
                start.setDate(now.getDate() - i);
                start.setHours(0, 0, 0, 0);
                end = new Date(start);
                end.setHours(23, 59, 59, 999);
                label = start.toLocaleDateString('en-US', { weekday: 'short' }).charAt(0);
            } else {
                start = new Date(now);
                start.setDate(now.getDate() - (i * 7) - 6);
                start.setHours(0, 0, 0, 0);
                end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                label = 'W' + (periods - i);
            }
            
            const count = offers.filter(o => {
                const created = new Date(o.createdAt || 0);
                return created >= start && created <= end;
            }).length;
            
            data.push({ label, count });
        }
        
        const maxCount = Math.max(...data.map(d => d.count), 1);
        
        container.innerHTML = data.map(d => `
            <div class="volume-bar-wrap">
                <div class="volume-bar" style="height: ${Math.max((d.count / maxCount) * 60, 4)}px;">
                    <span class="volume-bar-value">${d.count}</span>
                </div>
                <span class="volume-bar-label">${d.label}</span>
            </div>
        `).join('');
        
        // Update period buttons
        document.querySelectorAll('.volume-chart-period button').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase() === window.chartPeriod);
        });
    }
    
    function setChartPeriod(period) {
        window.chartPeriod = period;
        renderVolumeChart(getStoredOffers());
    }
    
    function setPipelineView(view) {
        window.pipelineView = view;
        toggleClass('listViewBtn', 'active', view === 'list');
        toggleClass('kanbanViewBtn', 'active', view === 'kanban');
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function toggleShowArchived() {
        window.showArchived = !window.showArchived;
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function toggleShowStarred() {
        window.showStarredOnly = !window.showStarredOnly;
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function getOfferStage(offer) {
        const t = offer.tracking || {};
        if (offer.funded || t.funded) return 'funded';
        if (t.clientAccepted) return 'accepted';
        if (t.clientViewed || t.isoViewed) return 'viewed';
        if (t.clientShared || t.isoShared) return 'sent';
        return 'draft';
    }
    
    function isOfferStale(offer) {
        const t = offer.tracking || {};
        const sentTime = t.clientSharedAt || t.isoSharedAt;
        if (!sentTime) return false;
        if (t.clientViewed || t.isoViewed) return false;
        
        const daysSinceSent = (Date.now() - new Date(sentTime)) / (1000 * 60 * 60 * 24);
        return daysSinceSent >= STALE_DAYS;
    }
    
    function renderKanbanBoard(offers) {
        const stages = ['draft', 'sent', 'viewed', 'accepted', 'funded'];
        const grouped = { draft: [], sent: [], viewed: [], accepted: [], funded: [] };
        
        offers.forEach(offer => {
            const stage = getOfferStage(offer);
            if (grouped[stage]) grouped[stage].push(offer);
        });
        
        stages.forEach(stage => {
            const container = $(`kanban-${stage}`);
            const countEl = $(`kanban-count-${stage}`);
            if (!container) return;
            
            countEl.textContent = grouped[stage].length;
            
            if (grouped[stage].length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:11px;">No offers</div>`;
                return;
            }
            
            container.innerHTML = grouped[stage].map(offer => renderKanbanCard(offer)).join('');
        });
    }
    
    function renderKanbanCard(offer) {
        const isStale = isOfferStale(offer);
        const date = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
        const amount = offer.amount ? '$' + offer.amount.toLocaleString() : '';
        const tags = offer.tags || [];
        
        return `
            <div class="kanban-card ${offer.starred ? 'starred' : ''} ${isStale ? 'stale' : ''} ${offer.archived ? 'archived' : ''}" onclick="openOfferLink('${offer.id}')">
                <div class="kanban-card-header">
                    <span class="kanban-card-title">${escapeHtml(offer.businessName || 'Unnamed')}</span>
                    <span class="kanban-card-star ${offer.starred ? 'active' : ''}" onclick="event.stopPropagation(); toggleStar('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${offer.starred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </span>
                </div>
                ${amount ? `<div class="kanban-card-amount">${amount}</div>` : ''}
                <div class="kanban-card-meta">
                    <span class="kanban-card-date">${date}</span>
                    ${isStale ? '<span class="kanban-card-stale">⚠ Stale</span>' : ''}
                </div>
                ${tags.length > 0 ? `
                    <div class="offer-tags">
                        ${tags.map(tag => `<span class="offer-tag ${tag}">${AVAILABLE_TAGS.find(t => t.id === tag)?.label || tag}</span>`).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function renderListView(filtered, totalCount, searchFilter) {
        const container = $('offersTableContainer');
        
        if (totalCount === 0) {
            container.innerHTML = `
                <div class="dashboard-empty">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3>No offers yet</h3>
                    <p>Share an offer to start tracking it here</p>
                </div>
            `;
            return;
        }
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="dashboard-empty">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <h3>No matches</h3>
                    <p>${searchFilter ? `No offers found for "${escapeHtml(searchFilter)}"` : 'No matching offers'}</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(offer => renderOfferCard(offer)).join('');
        
        // Animate all numeric values in the rendered cards
        container.querySelectorAll('.animate-amount').forEach(el => {
            const amount = parseFloat(el.dataset.amount) || 0;
            if (amount > 0) animateNumber(el, amount, 1200);
        });
        container.querySelectorAll('.animate-factor').forEach(el => {
            const factor = parseFloat(el.dataset.factor) || 0;
            if (factor > 0) animateNumber(el, factor, 1200, (n) => n.toFixed(2) + 'x');
        });
        container.querySelectorAll('.animate-profit').forEach(el => {
            const profit = parseFloat(el.dataset.profit) || 0;
            if (profit > 0) animateNumber(el, profit, 1200, (n) => '+$' + Math.round(n).toLocaleString());
        });
    }
    
    function toggleStar(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            offer.starred = !offer.starred;
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function archiveOffer(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            offer.archived = !offer.archived;
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function markAsFunded(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            offer.funded = !offer.funded;
            if (!offer.tracking) offer.tracking = {};
            offer.tracking.funded = offer.funded;
            offer.tracking.fundedAt = offer.funded ? new Date().toISOString() : null;
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function toggleOfferTag(offerId, tagId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            if (!offer.tags) offer.tags = [];
            const idx = offer.tags.indexOf(tagId);
            if (idx >= 0) {
                offer.tags.splice(idx, 1);
            } else {
                offer.tags.push(tagId);
            }
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function showTagPicker(offerId, event) {
        event.stopPropagation();
        // Close any open pickers
        document.querySelectorAll('.tag-picker-dropdown.show').forEach(el => el.classList.remove('show'));
        const dropdown = document.getElementById(`tag-picker-${offerId}`);
        if (dropdown) dropdown.classList.toggle('show');
    }
    
    // Close tag picker when clicking outside
    document.addEventListener('click', () => {
        document.querySelectorAll('.tag-picker-dropdown.show').forEach(el => el.classList.remove('show'));
    });
    
    function calculatePipelineMetrics(offers) {
        const metrics = {
            total: offers.length,
            locked: 0,
            isoShared: 0,
            isoViewed: 0,
            clientShared: 0,
            clientViewed: 0,
            accepted: 0,
            declined: 0,
            pending: 0
        };
        
        offers.forEach(offer => {
            const t = offer.tracking || {};
            if (t.lenderLocked) metrics.locked++;
            if (t.isoShared) metrics.isoShared++;
            if (t.isoViewed) metrics.isoViewed++;
            if (t.clientShared) metrics.clientShared++;
            if (t.clientViewed) metrics.clientViewed++;
            if (t.clientAccepted) metrics.accepted++;
            else if (t.clientDeclined) metrics.declined++;
            else if (t.clientShared || t.isoShared) metrics.pending++;
        });
        
        return metrics;
    }
    
    function renderPipelineMetrics(container, metrics, total) {
        if (!container) return;
        
        // Calculate rates
        const totalShared = metrics.isoShared + metrics.clientShared - (metrics.clientShared > 0 && metrics.isoShared > 0 ? Math.min(metrics.isoShared, metrics.clientShared) : 0);
        const totalViewed = metrics.isoViewed + metrics.clientViewed;
        const shareRate = total > 0 ? Math.round(((metrics.isoShared || metrics.clientShared ? 1 : 0) * metrics.isoShared + (metrics.clientShared ? 1 : 0) * metrics.clientShared) / total / (metrics.isoShared && metrics.clientShared ? 2 : 1) * 100) : 0;
        
        // Simpler: just count unique offers that have been shared to anyone
        let sharedOffers = 0;
        let viewedOffers = 0;
        const offers = getStoredOffers();
        offers.forEach(o => {
            const t = o.tracking || {};
            if (t.isoShared || t.clientShared) sharedOffers++;
            if (t.isoViewed || t.clientViewed) viewedOffers++;
        });
        
        const viewRate = sharedOffers > 0 ? Math.round((viewedOffers / sharedOffers) * 100) : 0;
        const acceptRate = viewedOffers > 0 ? Math.round((metrics.accepted / viewedOffers) * 100) : 0;
        const declineRate = viewedOffers > 0 ? Math.round((metrics.declined / viewedOffers) * 100) : 0;
        
        container.innerHTML = `
            <div class="metric-card total" onclick="filterOffersByMetric('all')" title="Show all offers">
                <div class="metric-value">${total}</div>
                <div class="metric-label">Total Offers</div>
            </div>
            <div class="metric-card shared" onclick="filterOffersByMetric('shared')" title="Show shared offers">
                <div class="metric-value">${sharedOffers}</div>
                <div class="metric-count">${total > 0 ? Math.round((sharedOffers / total) * 100) : 0}% of total</div>
                <div class="metric-label">Shared</div>
            </div>
            <div class="metric-card viewed" onclick="filterOffersByMetric('viewed')" title="Show viewed offers">
                <div class="metric-value">${viewRate}%</div>
                <div class="metric-count">${viewedOffers} of ${sharedOffers}</div>
                <div class="metric-label">View Rate</div>
            </div>
            <div class="metric-card accepted" onclick="filterOffersByMetric('accepted')" title="Show accepted offers">
                <div class="metric-value">${acceptRate}%</div>
                <div class="metric-count">${metrics.accepted} won</div>
                <div class="metric-label">Accept Rate</div>
            </div>
            <div class="metric-card declined" onclick="filterOffersByMetric('declined')" title="Show declined offers">
                <div class="metric-value">${declineRate}%</div>
                <div class="metric-count">${metrics.declined} lost</div>
                <div class="metric-label">Decline Rate</div>
            </div>
            <div class="metric-card pending" onclick="filterOffersByMetric('pending')" title="Show pending offers">
                <div class="metric-value">${metrics.pending}</div>
                <div class="metric-count">awaiting</div>
                <div class="metric-label">In Progress</div>
            </div>
        `;
        
        // Apply active state to current filter
        if (window.currentMetricFilter) {
            const activeCard = container.querySelector(`.metric-card.${window.currentMetricFilter === 'all' ? 'total' : window.currentMetricFilter}`);
            if (activeCard) activeCard.classList.add('active');
        }
    }
    
    // Filter offers by metric card click
    window.currentMetricFilter = 'all';
    
    function filterOffersByMetric(filterType) {
        window.currentMetricFilter = filterType;
        
        // Update active states
        const cards = document.querySelectorAll('.metric-card');
        cards.forEach(card => card.classList.remove('active'));
        
        const activeClass = filterType === 'all' ? 'total' : filterType;
        const activeCard = document.querySelector(`.metric-card.${activeClass}`);
        if (activeCard) activeCard.classList.add('active');
        
        // Re-render with filter
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function applyMetricFilter(offers) {
        const filter = window.currentMetricFilter;
        if (!filter || filter === 'all') return offers;
        
        return offers.filter(o => {
            const t = o.tracking || {};
            switch (filter) {
                case 'shared':
                    return t.isoShared || t.clientShared;
                case 'viewed':
                    return t.isoViewed || t.clientViewed;
                case 'accepted':
                    return !!t.clientAccepted;
                case 'declined':
                    return !!t.clientDeclined;
                case 'pending':
                    return (t.isoShared || t.clientShared) && !t.clientAccepted && !t.clientDeclined;
                default:
                    return true;
            }
        });
    }
    
    function renderOfferCard(offer) {
        const t = offer.tracking || {};
        const isISO = offer.isISOShare;
        const isStale = isOfferStale(offer);
        const tags = offer.tags || [];
        
        // Determine current status (furthest stage reached)
        let statusClass = 'draft';
        let statusLabel = 'Draft';
        if (offer.funded || t.funded) { statusClass = 'funded'; statusLabel = 'Funded'; }
        else if (t.clientAccepted) { statusClass = 'accepted'; statusLabel = 'Accepted'; }
        else if (t.clientDeclined) { statusClass = 'declined'; statusLabel = 'Declined'; }
        else if (t.clientViewed) { statusClass = 'viewed'; statusLabel = 'Client Viewed'; }
        else if (t.clientShared) { statusClass = 'sent'; statusLabel = 'With Client'; }
        else if (t.isoViewed) { statusClass = 'viewed'; statusLabel = 'ISO Viewed'; }
        else if (t.isoShared) { statusClass = 'sent'; statusLabel = 'With ISO'; }
        else if (t.lenderLocked) { statusClass = 'locked'; statusLabel = 'Locked'; }
        
        // Date display with time
        const date = offer.createdAt ? new Date(offer.createdAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';
        
        // Star button HTML
        const starBtn = `
            <button class="offer-star-btn ${offer.starred ? 'active' : ''}" onclick="event.stopPropagation(); toggleStar('${offer.id}')" title="${offer.starred ? 'Unstar' : 'Star'} this offer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${offer.starred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
            </button>
        `;
        
        // Stale indicator
        const staleHtml = isStale ? `
            <span class="stale-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                ${STALE_DAYS}+ days
            </span>
        ` : '';
        
        // Tags HTML
        const tagsHtml = `
            <div class="offer-tags" style="margin-top: 8px;">
                ${tags.map(tag => `<span class="offer-tag ${tag}">${AVAILABLE_TAGS.find(t => t.id === tag)?.label || tag}</span>`).join('')}
                <div class="tag-picker">
                    <button class="tag-picker-btn" onclick="showTagPicker('${offer.id}', event)" title="Add tag">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <div class="tag-picker-dropdown" id="tag-picker-${offer.id}">
                        ${AVAILABLE_TAGS.map(tag => `
                            <div class="tag-picker-option ${tags.includes(tag.id) ? 'selected' : ''}" onclick="event.stopPropagation(); toggleOfferTag('${offer.id}', '${tag.id}')">
                                <span class="offer-tag ${tag.id}" style="margin:0;">${tag.label}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        if (isISO) {
            // ISO Rate Share card
            return `
                <div class="offer-card ${offer.archived ? 'archived' : ''}" data-offer-id="${offer.id}" style="${offer.archived ? 'opacity:0.5;' : ''}">
                    <div class="offer-card-header">
                        <div style="display:flex;align-items:flex-start;gap:8px;">
                            ${starBtn}
                            <div class="offer-card-title">
                                <h3>
                                    <span style="color: var(--accent);">⚡ ISO Rate Share</span>
                                    ${offer.isoName ? `<span class="iso-tag">${escapeHtml(offer.isoName)}</span>` : ''}
                                    ${staleHtml}
                                </h3>
                                <div class="sub-info">${(offer.buyRate || 0).toFixed(2)}x → ${(offer.factor || 0).toFixed(2)}x • ${date}</div>
                            </div>
                        </div>
                        <span class="offer-status-badge ${statusClass}">${statusLabel}</span>
                    </div>
                    
                    ${tagsHtml}
                    
                    <div class="offer-tracking">
                        ${renderTrackingProgress(offer, true)}
                    </div>
                    
                    <div class="offer-actions">
                        <button class="offer-action-btn" onclick="copyOfferLink('${offer.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            Copy
                        </button>
                        <button class="offer-action-btn" onclick="openOfferLink('${offer.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            Open
                        </button>
                        <button class="offer-action-btn archive" onclick="archiveOffer('${offer.id}')" title="${offer.archived ? 'Unarchive' : 'Archive'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        </button>
                        <button class="offer-action-btn delete" onclick="deleteOffer('${offer.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Regular offer card
        const freqLabel = offer.frequency === 'daily' ? 'D' : offer.frequency === 'weekly' ? 'W' : 'M';
        const amountStr = offer.amount ? '$' + offer.amount.toLocaleString() : '$0';
        const factorStr = offer.factor ? offer.factor.toFixed(2) + 'x' : '-';
        const termStr = offer.term ? offer.term + freqLabel : '-';
        
        // Calculate profit
        let profitHtml = '';
        let profitAmount = 0;
        if (offer.amount && offer.factor) {
            const buyRate = offer.buyRate || 1.00;
            profitAmount = offer.amount * (offer.factor - buyRate);
            if (profitAmount > 0) {
                profitHtml = `
                    <div class="offer-stat-divider"></div>
                    <div class="offer-stat">
                        <span class="offer-stat-label">Profit</span>
                        <span class="offer-stat-value profit animate-profit" data-profit="${Math.round(profitAmount)}">+$${Math.round(profitAmount).toLocaleString()}</span>
                    </div>
                `;
            }
        }
        
        return `
            <div class="offer-card ${offer.archived ? 'archived' : ''}" data-offer-id="${offer.id}" style="${offer.archived ? 'opacity:0.5;' : ''}">
                <div class="offer-card-header">
                    <div style="display:flex;align-items:flex-start;gap:8px;">
                        ${starBtn}
                        <div class="offer-card-title">
                            <h3>
                                ${escapeHtml(offer.businessName || 'Unnamed')}
                                ${offer.isoName ? `<span class="iso-tag">${escapeHtml(offer.isoName)}</span>` : ''}
                                ${offer.lenderName ? `<span class="lender-tag">${escapeHtml(offer.lenderName)}</span>` : ''}
                                ${staleHtml}
                            </h3>
                            <div class="sub-info">${offer.contactName ? escapeHtml(offer.contactName) + ' • ' : ''}${date}</div>
                        </div>
                    </div>
                    <span class="offer-status-badge ${statusClass}">${statusLabel}</span>
                </div>
                
                ${tagsHtml}
                
                <div class="offer-stats">
                    <div class="offer-stat">
                        <span class="offer-stat-label">Amount</span>
                        <span class="offer-stat-value animate-amount" data-amount="${offer.amount || 0}">${amountStr}</span>
                    </div>
                    <div class="offer-stat-divider"></div>
                    <div class="offer-stat">
                        <span class="offer-stat-label">Factor</span>
                        <span class="offer-stat-value animate-factor" data-factor="${offer.factor || 0}">${factorStr}</span>
                    </div>
                    <div class="offer-stat-divider"></div>
                    <div class="offer-stat">
                        <span class="offer-stat-label">Term</span>
                        <span class="offer-stat-value">${termStr}</span>
                    </div>
                    ${profitHtml}
                </div>
                
                <div class="offer-tracking">
                    ${renderTrackingProgress(offer, false)}
                </div>
                
                <button id="tracking-toggle-${offer.id}" class="tracking-toggle" onclick="toggleTrackingDetails('${offer.id}')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    View Timeline
                </button>
                
                <div id="tracking-detail-${offer.id}" class="tracking-detailed">
                    ${renderDetailedTracking(offer)}
                </div>
                
                <div class="offer-actions">
                    <button class="offer-action-btn" onclick="copyOfferLink('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        Copy
                    </button>
                    <button class="offer-action-btn" onclick="openOfferLink('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                        Open
                    </button>
                    ${statusClass === 'accepted' ? `
                        <button class="offer-action-btn ${offer.funded ? 'active' : ''}" onclick="markAsFunded('${offer.id}')" title="${offer.funded ? 'Unmark as funded' : 'Mark as funded'}" style="${offer.funded ? 'background: rgba(16, 185, 129, 0.15); border-color: #10b981; color: #10b981;' : ''}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            ${offer.funded ? 'Funded' : 'Fund'}
                        </button>
                    ` : ''}
                    <button class="offer-action-btn archive" onclick="archiveOffer('${offer.id}')" title="${offer.archived ? 'Unarchive' : 'Archive'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    </button>
                    <button class="offer-action-btn delete" onclick="deleteOffer('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            </div>
        `;
    }
    
    function renderTrackingProgress(offer, isISOShare) {
        const t = offer.tracking || {};
        
        // Stage order: Locked → ISO Share → ISO View → Client Share → Client View → Reject/Accept
        // For ISO shares, show all stages
        // For regular offers (direct to client), skip ISO stages
        const svgIcon = (path, sw = 2) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round">${path}</svg>`;
        const allStages = [
            { key: 'lenderLocked', icon: svgIcon('<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>'), label: 'Locked', cls: 'locked' },
            { key: 'isoShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'ISO', cls: 'iso-share' },
            { key: 'isoViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'View', cls: 'iso-view' },
            { key: 'clientShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'Client', cls: 'client-share' },
            { key: 'clientViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'View', cls: 'client-view' },
            { key: 'clientDeclined', icon: svgIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>', 2.5), label: 'Reject', cls: 'rejected', final: true },
            { key: 'clientAccepted', icon: svgIcon('<polyline points="20 6 9 17 4 12"/>', 2.5), label: 'Accept', cls: 'accepted', final: true }
        ];
        
        // Always show all stages from lender lock forward
        let stages = allStages;
        
        // Filter out declined if accepted, and vice versa
        const hasAccepted = t.clientAccepted;
        const hasDeclined = t.clientDeclined;
        stages = stages.filter(s => {
            if (s.key === 'clientDeclined' && hasAccepted) return false;
            if (s.key === 'clientAccepted' && hasDeclined) return false;
            return true;
        });
        
        let html = '';
        
        // If client was shared with, ISO must have viewed it, and it must have been locked
        const inferredComplete = (key) => {
            if (t[key]) return true;
            // If client shared, all prior stages must be complete
            if (t.clientShared && ['lenderLocked', 'isoShared', 'isoViewed'].includes(key)) return true;
            // If ISO viewed, it must have been locked and shared
            if (t.isoViewed && ['lenderLocked', 'isoShared'].includes(key)) return true;
            // If ISO shared, it must have been locked
            if (t.isoShared && key === 'lenderLocked') return true;
            return false;
        };
        
        stages.forEach((stage, i) => {
            const isComplete = inferredComplete(stage.key);
            const nextComplete = stages[i+1] && inferredComplete(stages[i+1].key);
            const timestamp = t[stage.key] ? new Date(t[stage.key]).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';
            
            html += `
                <div class="tracking-stage ${isComplete ? 'complete ' + stage.cls : ''}" title="${timestamp || 'Pending'}">
                    <span class="tracking-icon ${isComplete ? 'complete ' + stage.cls : ''}">${stage.icon}</span>
                    <span class="tracking-label">${stage.label}</span>
                </div>
            `;
            
            // Add connecting line between stages (except after the last one)
            if (i < stages.length - 1) {
                html += `<div class="tracking-line ${isComplete && nextComplete ? 'complete' : ''}"></div>`;
            }
        });
        
        return html;
    }
    
    function renderDetailedTracking(offer) {
        const t = offer.tracking || {};
        const isISOShare = !!t.isoShared || !!t.lenderLocked;
        
        const svgIcon = (path, sw = 2) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round">${path}</svg>`;
        
        const allStages = [
            { key: 'lenderLocked', icon: svgIcon('<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>'), label: 'Lender Locked', description: 'Offer locked by lender', cls: 'locked' },
            { key: 'isoShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'Shared with ISO', description: 'Offer sent to ISO partner', cls: 'iso-share' },
            { key: 'isoViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'Viewed by ISO', description: 'ISO partner opened the offer', cls: 'iso-view' },
            { key: 'clientShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'Shared with Client', description: 'Offer forwarded to merchant', cls: 'client-share' },
            { key: 'clientViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'Viewed by Client', description: 'Merchant opened the offer', cls: 'client-view' },
            { key: 'clientDeclined', icon: svgIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>', 2.5), label: 'Rejected', description: 'Merchant declined the offer', cls: 'rejected', final: true },
            { key: 'clientAccepted', icon: svgIcon('<polyline points="20 6 9 17 4 12"/>', 2.5), label: 'Accepted', description: 'Merchant accepted the offer', cls: 'accepted', final: true }
        ];
        
        // Always show all stages from lender lock forward
        let stages = allStages;
        
        // Filter out the opposite final state
        const hasAccepted = t.clientAccepted;
        const hasDeclined = t.clientDeclined;
        stages = stages.filter(s => {
            if (s.key === 'clientDeclined' && hasAccepted) return false;
            if (s.key === 'clientAccepted' && hasDeclined) return false;
            return true;
        });
        
        let html = '';
        
        // If client was shared with, ISO must have viewed it, and it must have been locked
        const inferredComplete = (key) => {
            if (t[key]) return true;
            // If client shared, all prior stages must be complete
            if (t.clientShared && ['lenderLocked', 'isoShared', 'isoViewed'].includes(key)) return true;
            // If ISO viewed, it must have been locked and shared
            if (t.isoViewed && ['lenderLocked', 'isoShared'].includes(key)) return true;
            // If ISO shared, it must have been locked
            if (t.isoShared && key === 'lenderLocked') return true;
            return false;
        };
        
        stages.forEach((stage, i) => {
            const isComplete = inferredComplete(stage.key);
            const timestamp = t[stage.key] ? new Date(t[stage.key]).toLocaleString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true
            }) : '';
            
            const statusText = isComplete ? 'Complete' : 'Pending';
            const statusClass = isComplete ? '' : 'pending';
            
            html += `
                <div class="tracking-detail-row ${isComplete ? 'complete ' + stage.cls : statusClass}">
                    <div class="tracking-detail-icon">${stage.icon}</div>
                    <div class="tracking-detail-content">
                        <span class="tracking-detail-label">${stage.label}</span>
                        <span class="tracking-detail-time">${isComplete ? (timestamp || 'Inferred') : stage.description}</span>
                    </div>
                    <span class="tracking-detail-status">${statusText}</span>
                </div>
            `;
        });
        
        return html;
    }
    
    function toggleTrackingDetails(offerId) {
        const detailEl = document.getElementById('tracking-detail-' + offerId);
        const toggleBtn = document.getElementById('tracking-toggle-' + offerId);
        if (detailEl && toggleBtn) {
            detailEl.classList.toggle('show');
            toggleBtn.classList.toggle('expanded');
            toggleBtn.innerHTML = detailEl.classList.contains('show') 
                ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg> Hide Details`
                : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg> View Details`;
        }
    }
    
    function renderOfferRow(offer) {
        // Deprecated - now using renderOfferCard
        return renderOfferCard(offer);
    }
    
    function renderTrackingStages(offer, isISOShare) {
        // Deprecated - now using renderTrackingProgress
        return renderTrackingProgress(offer, isISOShare);
    }
    
    function filterDashboardOffers() {
        const search = $('dashboardSearch')?.value || '';
        renderOffersDashboard(search);
    }
    
    function renderTrackingColumn(offer) {
        // Legacy function - redirect to new format
        return renderTrackingStages(offer, offer.isISOShare);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function copyOfferLink(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer && offer.link) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(offer.link).then(() => showToast('Link copied!')).catch(() => prompt("Copy Link:", offer.link));
            } else {
                prompt("Copy Link:", offer.link);
            }
        }
    }
    
    function openOfferLink(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer && offer.link) {
            window.open(offer.link, '_blank');
        }
    }
    
    function deleteOffer(offerId) {
        if (!confirm('Delete this offer?')) return;
        
        let offers = getStoredOffers();
        offers = offers.filter(o => o.id !== offerId);
        saveStoredOffers(offers);
        updateOfferCount();
        renderOffersDashboard();
        showToast('Offer deleted');
    }
    
    function clearAllOffers() {
        console.log('clearAllOffers called');
        try {
            const offers = getStoredOffers();
            console.log('Offers found:', offers.length);
            if (offers.length === 0) {
                showToast('No offers to clear');
                return;
            }
            
            // Clear directly without confirm dialog
            localStorage.removeItem('trustbureau_offers');
            updateOfferCount();
            renderOffersDashboard();
            showToast('All offers cleared');
            console.log('Done');
        } catch (e) {
            console.error('Error in clearAllOffers:', e);
            alert('Error: ' + e.message);
        }
    }
    
    function copyText() {
        const l = getLink();
        const businessName = getVal('calcBusinessName') || 'Business Funding';
        const contactName = getVal('calcContactName') || '';
        const fontMain = "font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;";
        
        let cardsHtml = '';
        
        calcOptions.forEach((opt, i) => {
            const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
            const freqLabel = opt.frequency.charAt(0).toUpperCase() + opt.frequency.slice(1);
            
            // Calculate term length display using shared helper
            const termLengthDisplay = getTermDisplay(opt.term, opt.frequency, opt.termOverride);
            
            // Calculate principal percentage for visual
            const principalPct = Math.round((opt.amount / cal.totalPayback) * 100);
            
            const optionLabelHtml = calcOptions.length > 1 
                ? `<div style="display: inline-block; background-color: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; padding: 6px 16px; margin-bottom: 16px;">
                       <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #10b981; margin: 0;">Option ${getLetter(i)}</p>
                   </div>`
                : '';

            const logoHtml = currentLogoUrl 
                ? `<div style="margin-bottom: 20px;"><img src="${currentLogoUrl}" alt="Logo" style="max-height: 48px; max-width: 160px;" /></div>`
                : '';

            const companyNameHtml = currentCompanyName
                ? `<p style="${fontMain} font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin: 0 0 16px 0;">${currentCompanyName}</p>`
                : '';
            
            // Notes section (conditional)
            let notesHtml = '';
            if (opt.notes && opt.notes.trim()) {
                const noteLines = opt.notes.split('\n').filter(n => n.trim()).map(n => 
                    `<li style="${fontMain} font-size: 13px; color: #475569; margin-bottom: 6px;">${n.trim()}</li>`
                ).join('');
                notesHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-top: 1px solid #e2e8f0;">
                    <tr>
                        <td style="padding: 20px;">
                            <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 10px;">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; font-weight: bold; color: #0f172a;">Offer Notes</td>
                                </tr>
                            </table>
                            <ul style="margin: 0; padding-left: 20px;">${noteLines}</ul>
                        </td>
                    </tr>
                </table>`;
            }
            
            // Documents section (conditional)
            let docsHtml = '';
            if (opt.docs && opt.docs.length > 0) {
                const docsText = opt.docsText || 'The following documents are required to complete your funding';
                const docItems = opt.docs.map(d => 
                    `<li style="${fontMain} font-size: 13px; color: #475569; margin-bottom: 6px;">${d}</li>`
                ).join('');
                docsHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-top: 1px solid #e2e8f0;">
                    <tr>
                        <td style="padding: 20px;">
                            <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 10px;">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; font-weight: bold; color: #0f172a;">Closing Documents</td>
                                </tr>
                            </table>
                            <p style="${fontMain} font-size: 12px; color: #64748b; margin: 0 0 10px 0;">${docsText}</p>
                            <ul style="margin: 0; padding-left: 20px;">${docItems}</ul>
                        </td>
                    </tr>
                </table>`;
            }
            
            // Fee row (conditional)
            const feeRowHtml = opt.fee > 0 
                ? `<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: rgba(251, 191, 36, 0.1);">
                    <tr>
                        <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Origination Fee</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.feeAmount)}</p>
                        </td>
                        <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Net Proceeds</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.net)}</p>
                        </td>
                    </tr>
                </table>`
                : '';
            
            // Prepay row (conditional)
            const prepayRowHtml = opt.prepay > 0 
                ? `<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: rgba(34, 197, 94, 0.1);">
                    <tr>
                        <td align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Prepay Discount</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #22c55e; margin: 0;">${opt.prepay}% off if paid early</p>
                        </td>
                    </tr>
                </table>`
                : '';

            cardsHtml += `
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tr>
                    <td align="center">
                        <div style="max-width: 420px; margin: 0 auto 40px auto; background-color: #ffffff; border-radius: 24px; overflow: hidden; border: 4px solid #10b981; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                            
                            <!-- Header -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 40px 20px 32px 20px;">
                                        ${logoHtml}
                                        ${companyNameHtml}
                                        ${optionLabelHtml}
                                        <p style="${fontMain} font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; margin: 0 0 8px 0;">You Get</p>
                                        <h1 style="${fontMain} font-size: 52px; font-weight: 800; line-height: 1; letter-spacing: -2px; color: #ffffff; margin: 0;">${formatCurrency(opt.amount)}</h1>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Chart/Breakdown Section -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background: linear-gradient(to bottom, #ffffff, #f8fafc);">
                                <tr>
                                    <td align="center" style="padding: 28px 20px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin: 0 0 6px 0;">Total Payback</p>
                                        <p style="${fontMain} font-size: 26px; font-weight: bold; color: #0f172a; margin: 0 0 16px 0;">${formatCurrency(cal.totalPayback)}</p>
                                        <table border="0" cellspacing="0" cellpadding="0" style="margin: 0 auto;">
                                            <tr>
                                                <td style="padding-right: 20px;">
                                                    <table border="0" cellspacing="0" cellpadding="0">
                                                        <tr>
                                                            <td style="width: 12px; height: 12px; background: linear-gradient(135deg, #34d399, #10b981); border-radius: 50%;"></td>
                                                            <td style="padding-left: 8px; ${fontMain} font-size: 12px; color: #64748b;">Principal</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <table border="0" cellspacing="0" cellpadding="0">
                                                        <tr>
                                                            <td style="width: 12px; height: 12px; background: #e2e8f0; border-radius: 50%;"></td>
                                                            <td style="padding-left: 8px; ${fontMain} font-size: 12px; color: #64748b;">Cost of Capital</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <!-- Stats Grid Row 1: Term & Payments -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; border-top: 1px solid #f1f5f9;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Term Length</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${termLengthDisplay}</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Payments</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${cal.term}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Stats Grid Row 2: Factor & Cost -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Factor Rate</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${parseFloat(opt.factor).toFixed(2)}x</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Total Cost</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.totalCost)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Fee Row (conditional) -->
                            ${feeRowHtml}
                            
                            <!-- Prepay Row (conditional) -->
                            ${prepayRowHtml}

                            <!-- Payment Section -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background-color: #ffffff; padding: 28px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 6px 0; letter-spacing: 1px;">${freqLabel} Payment</p>
                                        <p style="${fontMain} font-size: 32px; font-weight: 800; color: #0f172a; margin: 0; letter-spacing: -1px;">${formatCurrency(cal.payment)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Notes Section (conditional) -->
                            ${notesHtml}
                            
                            <!-- Documents Section (conditional) -->
                            ${docsHtml}
                            
                        </div>
                        
                        <!-- URL Below Card -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin: 16px auto 0 auto;">
                            <tr>
                                <td align="center">
                                    <p style="${fontMain} font-size: 12px; color: #64748b; margin: 0;">
                                        <span style="font-weight: 600;">View Offer:</span> ${l}
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>`;
        });
        
        // Build expiration section HTML
        const expiryDate = $('toggleExpiry').checked ? getVal('calcExpiryDate') : null;
        let expiryHtml = '';
        if (expiryDate) {
            const formattedExpiry = new Date(expiryDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            expiryHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="max-width: 420px; margin: 20px auto 0 auto;">
                    <tr>
                        <td style="padding: 16px; background-color: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <table border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; color: #475569;">This offer expires on <span style="font-weight: bold; color: #10b981;">${formattedExpiry}</span></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>`;
        }
        
        // Build greeting
        const greetingName = contactName || 'Business Owner';
        
        const html = `
            <!DOCTYPE html>
            <html>
            <body style="margin: 0; padding: 0; background-color: #f8fafc;">
            <center>
            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
                <tr>
                    <td align="center" style="padding: 40px 20px;">
                        
                        <!-- Trust Badge -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 24px;">
                            <tr>
                                <td align="center">
                                    <div style="display: inline-block; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 50px; padding: 10px 20px;">
                                        <table border="0" cellspacing="0" cellpadding="0">
                                            <tr>
                                                <td style="width: 20px; height: 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; text-align: center; vertical-align: middle;">
                                                    <span style="color: white; font-size: 12px; line-height: 20px;">✓</span>
                                                </td>
                                                <td style="padding-left: 10px; ${fontMain} font-size: 12px; font-weight: 600; color: #475569;">
                                                    <span style="color: #10b981; font-weight: 700;">Ables</span><span style="color: #6b7280; font-weight: 700;">AI</span> Verified
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                        <!-- Greeting -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 30px;">
                            <tr>
                                <td align="center">
                                    <h2 style="margin: 0 0 8px 0; color: #0f172a; font-size: 26px; font-weight: 800;">Hello, ${greetingName}</h2>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Your business <span style="font-weight: 600; color: #0f172a;">${businessName}</span> has been pre-approved for funding.</p>
                                </td>
                            </tr>
                        </table>

                        ${cardsHtml}
                        
                        ${expiryHtml}

                    </td>
                </tr>
            </table>
            </center>
            </body>
            </html>
        `;
        
        const div = document.createElement('div'); 
        div.innerHTML = html; 
        div.style.position='fixed'; div.style.opacity='0'; div.contentEditable='true'; 
        document.body.appendChild(div);
        
        const range = document.createRange(); 
        range.selectNodeContents(div); 
        const sel = window.getSelection(); 
        sel.removeAllRanges(); 
        sel.addRange(range);
        
        try { 
            document.execCommand('copy'); 
            saveOfferToDashboard(l, 'clientShareEmail'); // Save offer with email tracking
            window.clientEmailShared = true;
            updateModeStatusIcons();
            showToast('Email template copied!'); 
        } catch(e) { 
            copyLink(); 
        }
        document.body.removeChild(div); 
        addClass('shareModal', 'hidden');
    }

    function openAmortSchedule() { 
        let a, f, t, fr;
        
        if(hasClass('adminPanel', 'hidden')) {
            const opt = clientData.o[clientActiveIdx];
            a = clientSelectedAmount;
            f = opt.f;
            t = opt.t;
            fr = opt.q;
        } else {
            a = getVal('calcAmount', true);
            f = getVal('calcFactor', true);
            t = getVal('calcTerm', true);
            const freqBtn = document.querySelector('.toggle-btn.active');
            fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        }
        
        const c = calculate(a, f, t, fr, 0);
        let b = c.totalPayback, d = new Date(), html = '';
        
        for(let i=1; i<=t; i++) {
            if(i > 300 && i < t) continue;
            if(i === 300 && t > 300) { html += `<tr><td colspan="4" class="text-center py-4 italic text-xs" style="color: var(--text-muted); background: var(--bg-option-card);">... (${t - 300} remaining payments) ...</td></tr>`; continue; }
            if(fr==='weekly') d.setDate(d.getDate()+7); else if(fr==='monthly') d.setMonth(d.getMonth()+1); else { d.setDate(d.getDate()+1); if(d.getDay()===0) d.setDate(d.getDate()+1); if(d.getDay()===6) d.setDate(d.getDate()+2); }
            b -= c.payment; if(b<0) b=0;
            html += `<tr><td class="px-6 py-3 font-medium">${i}</td><td class="px-6 py-3">${d.toLocaleDateString()}</td><td class="px-6 py-3 text-right font-mono">${formatCurrency(c.payment)}</td><td class="px-6 py-3 text-right font-mono font-bold" style="color: var(--text-primary);">${formatCurrency(b)}</td></tr>`;
        }
        $('amortTableBody').innerHTML = html; 
        removeClass('amortModal', 'hidden'); 
    }

    function showToast(m) { 
        const t=$('toast'); 
        $('toastMessage').textContent=m; 
        t.classList.add('show'); 
        setTimeout(()=>t.classList.remove('show'), 3000); 
    }
    
    // Alias for showToast (used in report functions)
    function showNotification(message, type = 'info') {
        showToast(message);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    ['calcAmount','calcFactor','calcTerm','calcFee','calcPrepay'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const v = parseFloat(this.value.replace(/,/g,''))||0; 
            const slider = $(id+'Slider'); if(slider) { slider.value = v; updateSliderFill(slider); }
            updatePreview(); 
        });
    });
    
    ['calcAmountSlider','calcFactorSlider','calcTermSlider','calcFeeSlider','calcPrepaySlider'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const k = id.replace('Slider',''); setVal(k, k==='calcAmount'?formatNumber(this.value):this.value); 
            updatePreview(); updateSliderFill(this);
            // Mark ISO/Client as having used the calculator
            if (currentClientMode === 'iso') {
                window.isoViewed = true;
                updateModeStatusIcons();
            } else if (currentClientMode === 'client') {
                window.clientViewed = true;
                updateModeStatusIcons();
            }
        });
    });
    
    // ISO Sell Rate slider
    $('isoSellRateSlider')?.addEventListener('input', function() {
        if ($('isoSellRate')) $('isoSellRate').value = parseFloat(this.value).toFixed(2);
        updateSliderFill(this);
        updateIsoUpsell();
        // Mark ISO as having used the calculator
        if (currentClientMode === 'iso') {
            window.isoViewed = true;
            updateModeStatusIcons();
        }
    });
    
    $('isoSellRate')?.addEventListener('input', function() {
        const slider = $('isoSellRateSlider');
        const minVal = parseFloat(slider?.min) || 1.05;
        const maxVal = parseFloat(slider?.max) || 1.70;
        
        let val = parseFloat(this.value) || minVal;
        val = Math.max(minVal, Math.min(maxVal, val));
        this.value = val.toFixed(2);
        
        if (slider) {
            slider.value = val;
            updateSliderFill(slider);
        }
        updateIsoUpsell();
        // Mark ISO as having used the calculator
        if (currentClientMode === 'iso') {
            window.isoViewed = true;
            updateModeStatusIcons();
        }
    });
    
    // Lender Buy Rate slider
    $('lenderBuyRateSlider')?.addEventListener('input', function() {
        clearTierSelection();
        const buyVal = parseFloat(this.value);
        const maxSellEl = $('lenderMaxSell');
        const maxSellSlider = $('lenderMaxSellSlider');
        let maxSellVal = parseFloat(maxSellEl?.value) || 1.25;
        
        // If buy rate >= max sell, push max sell up (maintain 0.05 min spread)
        if (buyVal >= maxSellVal - 0.04) {
            maxSellVal = Math.min(buyVal + 0.05, 1.70);
            if (maxSellEl) maxSellEl.value = maxSellVal.toFixed(2);
            if (maxSellSlider) {
                maxSellSlider.value = maxSellVal;
                updateSliderFill(maxSellSlider);
            }
            if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2);
        }
        
        if ($('lenderBuyRate')) $('lenderBuyRate').value = buyVal.toFixed(2);
        if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2); // Sync to theme menu
        updateSliderFill(this);
        updateLenderDisplay();
    });
    
    $('lenderBuyRate')?.addEventListener('input', function() {
        clearTierSelection();
        // Clamp value to slider bounds
        let buyVal = parseFloat(this.value) || 1.15;
        buyVal = Math.max(1.05, Math.min(1.60, buyVal));
        this.value = buyVal.toFixed(2);
        
        const maxSellEl = $('lenderMaxSell');
        const maxSellSlider = $('lenderMaxSellSlider');
        let maxSellVal = parseFloat(maxSellEl?.value) || 1.25;
        
        // If buy rate >= max sell, push max sell up (maintain 0.05 min spread)
        if (buyVal >= maxSellVal - 0.04) {
            maxSellVal = Math.min(buyVal + 0.05, 1.70);
            if (maxSellEl) maxSellEl.value = maxSellVal.toFixed(2);
            if (maxSellSlider) {
                maxSellSlider.value = maxSellVal;
                updateSliderFill(maxSellSlider);
            }
            if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2);
        }
        
        if ($('lenderBuyRateSlider')) {
            $('lenderBuyRateSlider').value = buyVal;
            updateSliderFill($('lenderBuyRateSlider'));
        }
        if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2); // Sync to theme menu
        updateLenderDisplay();
    });
    
    // Lender Max Sell slider
    $('lenderMaxSellSlider')?.addEventListener('input', function() {
        clearTierSelection();
        const maxSellVal = parseFloat(this.value);
        const buyRateEl = $('lenderBuyRate');
        const buyRateSlider = $('lenderBuyRateSlider');
        let buyVal = parseFloat(buyRateEl?.value) || 1.15;
        
        // If max sell <= buy rate, push buy rate down (maintain 0.05 min spread)
        if (maxSellVal <= buyVal + 0.04) {
            buyVal = Math.max(maxSellVal - 0.05, 1.05);
            if (buyRateEl) buyRateEl.value = buyVal.toFixed(2);
            if (buyRateSlider) {
                buyRateSlider.value = buyVal;
                updateSliderFill(buyRateSlider);
            }
            if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2);
        }
        
        if ($('lenderMaxSell')) $('lenderMaxSell').value = maxSellVal.toFixed(2);
        if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2); // Sync to theme menu
        updateSliderFill(this);
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxSellVal.toFixed(2);
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSellVal;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        updateLenderDisplay();
    });
    
    $('lenderMaxSell')?.addEventListener('input', function() {
        clearTierSelection();
        // Clamp value to slider bounds
        let maxSellVal = parseFloat(this.value) || 1.25;
        maxSellVal = Math.max(1.10, Math.min(1.70, maxSellVal));
        this.value = maxSellVal.toFixed(2);
        
        const buyRateEl = $('lenderBuyRate');
        const buyRateSlider = $('lenderBuyRateSlider');
        let buyVal = parseFloat(buyRateEl?.value) || 1.15;
        
        // If max sell <= buy rate, push buy rate down (maintain 0.05 min spread)
        if (maxSellVal <= buyVal + 0.04) {
            buyVal = Math.max(maxSellVal - 0.05, 1.05);
            if (buyRateEl) buyRateEl.value = buyVal.toFixed(2);
            if (buyRateSlider) {
                buyRateSlider.value = buyVal;
                updateSliderFill(buyRateSlider);
            }
            if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2);
        }
        
        if ($('lenderMaxSellSlider')) {
            $('lenderMaxSellSlider').value = maxSellVal;
            updateSliderFill($('lenderMaxSellSlider'));
        }
        if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2); // Sync to theme menu
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxSellVal;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSellVal;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        updateLenderDisplay();
    });
    
    $('clientAmountSlider').addEventListener('input', function() {
        clientSelectedAmount = parseInt(this.value);
        updateSliderFill(this);
        updateClientPreview();
    });

    ['calcTermOverride','calcBusinessName'].forEach(id => $(id).addEventListener('input', updatePreview));

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('load', () => {
        // Check for client share link FIRST - bypass login entirely
        const params = new URLSearchParams(window.location.search);
        const d = params.get('d');
        let isClientShareLink = false;
        let clientShareData = null;
        
        if (d) {
            try {
                // Try LZString decompression first (new format)
                let json = LZString.decompressFromEncodedURIComponent(d);
                
                // Fall back to old base64 format for backwards compatibility
                if (!json) {
                    json = decodeURIComponent(atob(d).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1)));
                }
                
                const data = JSON.parse(json);
                if(data.o && data.o.length) {
                    isClientShareLink = true;
                    clientShareData = data;
                    
                    // Track client view event
                    window.clientViewed = true;
                    updateOfferTrackingByLink(window.location.href, 'clientView');
                }
            } catch(e) { console.error("Error parsing shared data", e); }
        }
        
        // Check for shared report link
        const reportType = params.get('report');
        const reportId = params.get('rid');
        const reportData = params.get('rd') || params.get('data'); // Support both new (rd) and old (data) params
        let isSharedReport = false;
        
        if (reportType && reportData) {
            try {
                let json = LZString.decompressFromEncodedURIComponent(reportData);
                if (!json) {
                    // Fall back to base64 for old format
                    json = atob(reportData);
                }
                const data = JSON.parse(json);
                
                isSharedReport = true;
                reportViewMode = 'recipient';
                currentReportId = reportId;
                
                // Load data into report state
                if (reportType === 'debtschedule') {
                    reportState.debtSchedule = data;
                } else if (reportType === 'araging') {
                    reportState.arAging = data;
                } else if (reportType === 'wip') {
                    reportState.wip = data;
                }
                
                // Track view if we have a report ID
                if (reportId) {
                    updateReportTrackingById(reportId, 'viewed', 'recipient');
                }
                
                // Auto-switch to the report tool after load
                setTimeout(() => {
                    switchTool(reportType);
                    showNotification('Report opened - fill in and download when complete', 'info');
                }, 100);
                
            } catch(e) { console.error("Error parsing shared report", e); }
        }
        
        resetBrandKit();
        loadSavedBrandData(); // Restore saved logo and company name from localStorage
        
        // Only load auth state if NOT a client share link
        if (!isClientShareLink) {
            loadAuthState();
        }
        
        resetCalculator();
        initMobileSections();
        
        // Only check ISO share mode if NOT a client share link
        if (!isClientShareLink) {
            checkISOShareMode();
        }
        
        loadOfferCount(); // Load offer count on startup
        
        // Attach Clear All button handler
        const clearBtn = $('clearAllBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Clear All clicked via addEventListener');
                clearAllOffers();
            });
        }
        
        // Close upgrade modal on overlay click
        const upgradeModal = $('upgradeModal');
        if (upgradeModal) {
          upgradeModal.addEventListener('click', (e) => {
              if (e.target === upgradeModal) {
                  closeUpgradeModal();
              }
          });
        }
        
        // Initialize lite usage UI
        updateLiteUsageUI();
        
        // Initialize client view if this is a client share link
        if (isClientShareLink && clientShareData) {
            initClientView(clientShareData);
        }
        
        // Initialize loan calculator
        initLoanCalculator();
    });

    // ============================================
    // MOBILE SIDEBAR TOGGLE
    // ============================================
    function toggleMobileMega() {
      const menu = document.getElementById('mobileMegaMenu');
      const overlay = document.getElementById('sidebarOverlay');
      if (!menu || !overlay) return;
      
      const isOpen = menu.classList.contains('open');
      
      if (isOpen) {
        menu.classList.remove('open');
        overlay.classList.remove('active');
        document.body.classList.remove('mobile-mega-open');
      } else {
        menu.classList.add('open');
        overlay.classList.add('active');
        document.body.classList.add('mobile-mega-open');
        updateMobileMegaActive();
      }
    }
    
    function selectMobileTool(tool) {
      switchTool(tool);
      toggleMobileMega();
    }
    
    function updateMobileMegaActive() {
      document.querySelectorAll('.mobile-mega-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === currentTool);
      });
    }

    // ============================================
    // TOOL SWITCHING (SIDEBAR)
    // ============================================
    let currentTool = 'prequal';
    
    function switchTool(tool) {
      console.log('switchTool called with:', tool);
      currentTool = tool;
      console.log('currentTool set to:', currentTool);
      
      // Update sidebar buttons
      document.querySelectorAll('.sidebar-nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });
      
      // Update top nav buttons
      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });
      
      // Update dropdown button active states based on which tool is active
      updateNavDropdownStates(tool);
      
      // Hide all tool sections
      document.querySelectorAll('.tool-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show appropriate section
      const sectionMap = {
        'offer': 'offerBuilderSection',
        'prequal': 'prequalSection',
        'mca': 'mcaSection',
        'working': 'workingSection',
        'term': 'termSection',
        'loc': 'locSection',
        'sba': 'sbaSection',
        'equipment': 'equipmentSection',
        'payoff': 'payoffSection',
        'cre': 'creSection',
        'factoring': 'factoringSection',
        'apr': 'aprSection',
        'perrepus': 'perrepusSection',
        'debtschedule': 'debtScheduleSection',
        'araging': 'arAgingSection',
        'wip': 'wipSection'
      };
      
      const sectionId = sectionMap[tool];
      if (sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.add('active');
        }
        
        // Render calculator content if not offer builder
        if (tool !== 'offer') {
          renderCalculatorContent(tool);
        }
      }
      
      // Close mobile mega menu if open
      const megaMenu = document.getElementById('mobileMegaMenu');
      const overlay = document.getElementById('sidebarOverlay');
      if (megaMenu && megaMenu.classList.contains('open')) {
        megaMenu.classList.remove('open');
        overlay?.classList.remove('active');
        document.body.classList.remove('mobile-mega-open');
      }
    }
    
    // Mega Menu Navigation
    let openMenu = null;
    
    function toggleMegaMenu(menu) {
      const panel = document.getElementById('menu-' + menu);
      const overlay = document.getElementById('megaMenuOverlay');
      const btn = document.querySelector(`.nav-menu-btn[data-menu="${menu}"]`);
      
      if (!panel) return;
      
      const wasOpen = panel.classList.contains('open');
      
      // Close all menus first
      closeMegaMenu();
      
      // If this menu wasn't open, open it
      if (!wasOpen) {
        panel.classList.add('open');
        overlay.classList.add('open');
        btn.classList.add('active');
        openMenu = menu;
      }
    }
    
    function closeMegaMenu() {
      document.querySelectorAll('.mega-menu-panel').forEach(p => p.classList.remove('open'));
      document.getElementById('megaMenuOverlay')?.classList.remove('open');
      document.querySelectorAll('.nav-menu-btn').forEach(b => b.classList.remove('active'));
      openMenu = null;
    }
    
    function selectMegaTool(tool) {
      // Update active state in all mega menus
      document.querySelectorAll('.mega-menu-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tool === tool);
      });
      
      closeMegaMenu();
      switchTool(tool);
    }
    
    function updateNavDropdownStates(tool) {
      // Update active state in mega menu items
      document.querySelectorAll('.mega-menu-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tool === tool);
      });
    }
    
    // Close mega menu on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && openMenu) {
        closeMegaMenu();
      }
    });
    
    // Header dropdown functions (for Calculators/Reports in header bar)
    function toggleHeaderDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId);
      if (!dropdown) return;
      const parent = dropdown.parentElement;
      const wasOpen = parent.classList.contains('open');
      
      // Close all header dropdowns first
      closeHeaderDropdowns();
      
      // Toggle the clicked one
      if (!wasOpen) {
        parent.classList.add('open');
      }
    }
    
    function closeHeaderDropdowns() {
      document.querySelectorAll('.header-dropdown').forEach(d => d.classList.remove('open'));
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.header-dropdown')) {
        closeHeaderDropdowns();
      }
    });
    
    function renderCalculatorContent(tool) {
      switch(tool) {
        case 'prequal': 
          renderPreQualify(document.getElementById('prequalInputCard'), document.getElementById('prequalResultCard')); 
          break;
        case 'mca': 
          renderMCA(document.getElementById('mcaInputCard'), document.getElementById('mcaResultCard')); 
          break;
        case 'working': 
          renderWorkingCapital(document.getElementById('workingInputCard'), document.getElementById('workingResultCard')); 
          break;
        case 'term': 
          renderTermLoan(document.getElementById('termInputCard'), document.getElementById('termResultCard')); 
          break;
        case 'loc': 
          renderLOC(document.getElementById('locInputCard'), document.getElementById('locResultCard')); 
          break;
        case 'sba': 
          renderSBA(document.getElementById('sbaInputCard'), document.getElementById('sbaResultCard')); 
          break;
        case 'equipment': 
          renderEquipment(document.getElementById('equipInputCard'), document.getElementById('equipResultCard')); 
          break;
        case 'payoff': 
          renderEarlyPayoff(document.getElementById('payoffInputCard'), document.getElementById('payoffResultCard')); 
          break;
        case 'cre': 
          renderCRE(document.getElementById('creInputCard'), document.getElementById('creResultCard')); 
          break;
        case 'factoring': 
          renderFactoring(document.getElementById('factoringInputCard'), document.getElementById('factoringResultCard')); 
          break;
        case 'apr': 
          renderAPR(document.getElementById('aprInputCard'), document.getElementById('aprResultCard')); 
          break;
        case 'perrepus':
          renderPerrepusGuide(document.getElementById('perrepusGuideCard'));
          break;
        case 'debtschedule': 
          renderDebtSchedule(document.getElementById('debtScheduleCard')); 
          break;
        case 'araging': 
          renderARaging(document.getElementById('arAgingCard')); 
          break;
        case 'wip': 
          renderWIP(document.getElementById('wipCard')); 
          break;
      }
    }

    // ============================================
    // LOAN CALCULATOR
    // ============================================
    const loanProducts = [
      { id: 'prequal', name: 'Pre-Qualify', icon: 'clipboard-check' },
      { id: 'mca', name: 'MCA', icon: 'dollar-sign' },
      { id: 'working', name: 'Working Capital', icon: 'briefcase' },
      { id: 'term', name: 'Term Loan', icon: 'calendar' },
      { id: 'loc', name: 'LOC', icon: 'credit-card' },
      { id: 'sba', name: 'SBA 7(a)', icon: 'building' },
      { id: 'equipment', name: 'Equipment', icon: 'truck' },
      { id: 'earlyPayoff', name: 'Early Payoff', icon: 'trending-down' }
    ];
    
    let activeLoanProduct = 'prequal';
    let loanState = {
      // MCA
      mcaAmount: 50000, mcaFactor: 1.35, mcaTerm: 12, mcaFreq: 'daily', mcaOrigFee: 0,
      // Working Capital
      wcAmount: 75000, wcRate: 15, wcTerm: 24, wcOrigFee: 0,
      // Term Loan
      termAmount: 100000, termRate: 8, termTerm: 60, termOrigFee: 2,
      // LOC
      locLimit: 100000, locDrawn: 50000, locRate: 12, locOrigFee: 0,
      // SBA
      sbaAmount: 350000, sbaRate: 10.5, sbaTerm: 120, sbaOrigFee: 2,
      // Equipment
      equipCost: 80000, equipDown: 10, equipRate: 7, equipTerm: 60, equipOrigFee: 0,
      // Early Payoff
      payoffBalance: 45000, payoffFactor: 1.40, payoffRemaining: 8, payoffDiscount: 15,
      // Pre-Qualify
      prequalCriteria: { monthlyRevenue: 50000, avgDailyBalance: 8000, creditScore: 650, monthsInBusiness: 24, nsfCount: 2, negativeDays: 1, isRestricted: false },
      // CRE (Commercial Real Estate)
      creAmount: 500000, creRate: 7.5, creTerm: 240, creLTV: 75, creNOI: 60000, creOrigFee: 1,
      // Factoring
      factInvoiceAmount: 100000, factAdvanceRate: 85, factFee: 3, factDays: 30,
      // APR
      aprAmount: 50000, aprFactor: 1.35, aprTerm: 12, aprFreq: 'daily', aprOrigFee: 0
    };
    
    // ============================================
    // REPORTS STATE
    // ============================================
    let reportState = {
      // Debt Schedule
      debtSchedule: {
        businessName: '',
        preparedDate: new Date().toISOString().split('T')[0],
        debts: [
          { id: 1, creditor: '', type: 'Term Loan', originalAmount: 0, currentBalance: 0, interestRate: 0, monthlyPayment: 0, maturityDate: '', collateral: '' }
        ]
      },
      // A/R Aging
      arAging: {
        businessName: '',
        asOfDate: new Date().toISOString().split('T')[0],
        receivables: [
          { id: 1, customer: '', invoiceNo: '', invoiceDate: '', amount: 0, current: 0, days30: 0, days60: 0, days90: 0, over90: 0 }
        ]
      },
      // WIP Report
      wip: {
        businessName: '',
        asOfDate: new Date().toISOString().split('T')[0],
        projects: [
          { id: 1, projectName: '', customer: '', contractAmount: 0, billedToDate: 0, costsToDate: 0, estTotalCosts: 0, percentComplete: 0 }
        ]
      }
    };
    
    // Report viewing mode (owner vs recipient)
    let reportViewMode = 'owner';
    let currentReportId = null;
    
    // ============================================
    // REPORTS TRACKING - Same pattern as offers
    // ============================================
    function getStoredReports() {
      try { return JSON.parse(localStorage.getItem('tb_shared_reports') || '[]'); } 
      catch (e) { return []; }
    }
    
    function saveStoredReports(reports) {
      localStorage.setItem('tb_shared_reports', JSON.stringify(reports));
    }
    
    function saveReportToTracking(type, link) {
      const reports = getStoredReports();
      const data = type === 'debtschedule' ? reportState.debtSchedule : 
                   type === 'araging' ? reportState.arAging : reportState.wip;
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      
      // Generate ID from link
      const params = new URLSearchParams(link.split('?')[1] || '');
      const reportId = params.get('rid') || Date.now().toString(36);
      
      // Check if exists
      const existing = reports.find(r => r.id === reportId);
      if (existing) return existing.id;
      
      const report = {
        id: reportId,
        type: type,
        typeName: reportNames[type],
        businessName: data.businessName || 'Unnamed',
        link: link,
        createdAt: new Date().toISOString(),
        // Tracking - matches offer pattern
        shared: new Date().toISOString(),
        viewed: null,
        edited: null,
        downloaded: null
      };
      
      reports.unshift(report);
      if (reports.length > 50) reports.splice(50);
      saveStoredReports(reports);
      return report.id;
    }
    
    function updateReportTracking(reportId, event) {
      const reports = getStoredReports();
      const report = reports.find(r => r.id === reportId);
      if (!report) return;
      
      const now = new Date().toISOString();
      if (event === 'viewed' && !report.viewed) report.viewed = now;
      if (event === 'edited' && !report.edited) report.edited = now;
      if (event === 'downloaded') report.downloaded = now;
      
      saveStoredReports(reports);
    }
    
    // Save report to tracking dashboard when shared
    function saveReportToDashboard(type, data, shareUrl) {
      const reports = getStoredReports();
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      
      // Extract report ID from URL
      const params = new URLSearchParams(shareUrl.split('?')[1] || '');
      const reportId = params.get('rid') || Date.now().toString(36);
      
      // Check if exists
      const existing = reports.find(r => r.id === reportId);
      if (existing) return existing.id;
      
      const report = {
        id: reportId,
        type: type,
        typeName: reportNames[type],
        businessName: data.businessName || 'Unnamed Business',
        link: shareUrl,
        createdAt: new Date().toISOString(),
        // Tracking fields
        shared: new Date().toISOString(),
        viewed: null,
        edited: null,
        downloaded: null,
        // Tracking stats
        tracking: {
          viewCount: 0,
          editCount: 0,
          downloadCount: 0,
          lastViewed: null,
          lastEdited: null,
          lastDownloaded: null
        },
        // Audit log
        auditLog: [{
          action: 'shared',
          by: 'owner',
          timestamp: new Date().toISOString()
        }]
      };
      
      reports.unshift(report);
      if (reports.length > 50) reports.splice(50);
      saveStoredReports(reports);
      return report.id;
    }
    
    // Update tracking by report ID (used when recipient opens link)
    function updateReportTrackingById(reportId, action, by = 'recipient') {
      const reports = getStoredReports();
      const report = reports.find(r => r.id === reportId);
      if (!report) return;
      
      const now = new Date().toISOString();
      
      // Initialize tracking if missing
      if (!report.tracking) {
        report.tracking = { viewCount: 0, editCount: 0, downloadCount: 0, lastViewed: null, lastEdited: null, lastDownloaded: null };
      }
      
      // Initialize audit log if missing
      if (!report.auditLog) report.auditLog = [];
      
      // Update based on action
      switch(action) {
        case 'viewed':
          if (!report.viewed) report.viewed = now; // First view timestamp
          report.tracking.viewCount = (report.tracking.viewCount || 0) + 1;
          report.tracking.lastViewed = now;
          break;
        case 'edited':
          if (!report.edited) report.edited = now; // First edit timestamp
          report.tracking.editCount = (report.tracking.editCount || 0) + 1;
          report.tracking.lastEdited = now;
          break;
        case 'downloaded':
          if (!report.downloaded) report.downloaded = now; // First download timestamp
          report.tracking.downloadCount = (report.tracking.downloadCount || 0) + 1;
          report.tracking.lastDownloaded = now;
          break;
        case 'submitted':
          report.completed = now;
          report.tracking.completedAt = now;
          break;
      }
      
      // Add to audit log
      report.auditLog.push({
        action: action,
        by: by,
        timestamp: now
      });
      
      // Keep audit log to reasonable size (last 100 entries)
      if (report.auditLog.length > 100) {
        report.auditLog = report.auditLog.slice(-100);
      }
      
      saveStoredReports(reports);
    }
    
    function getReportStatus(report) {
      if (report.completed) return { label: 'Completed', color: '#8b5cf6' };
      if (report.edited) return { label: 'Filled In', color: '#10b981' };
      if (report.viewed) return { label: 'Opened', color: '#f59e0b' };
      return { label: 'Sent', color: '#6b7280' };
    }
    
    const loanIcons = {
      'clipboard-check': '<path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>',
      'dollar-sign': '<path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
      'briefcase': '<path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>',
      'calendar': '<path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>',
      'credit-card': '<path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>',
      'building': '<path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>',
      'truck': '<path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"/>',
      'trending-down': '<path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>'
    };
    
    function initLoanCalculator() {
      // Check for URL params first
      const urlConfig = loadCalcFromURL();
      
      if (urlConfig && urlConfig.calcType) {
        // Switch to the calculator from URL
        currentTool = urlConfig.calcType;
        
        // If client mode, apply minimal UI
        if (urlConfig.isClientMode) {
          document.body.classList.add('client-mode');
          // Hide sidebar and header controls
          const sidebar = document.querySelector('.sidebar');
          const header = document.querySelector('.app-header');
          if (sidebar) sidebar.style.display = 'none';
          if (header) {
            const controls = header.querySelectorAll('.mode-toggle, .header-actions');
            controls.forEach(c => c.style.display = 'none');
          }
          // Apply custom branding color if provided
          if (state.theme?.primary) {
            document.documentElement.style.setProperty('--accent', state.theme.primary);
          }
        }
        
        // Update sidebar active state
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
          btn.classList.toggle('active', btn.getAttribute('onclick')?.includes(urlConfig.calcType));
        });
        
        // Show correct tool section
        document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
        const sectionMap = {
          'prequal': 'prequalSection',
          'mca': 'mcaSection',
          'working': 'workingSection', 
          'term': 'termSection',
          'loc': 'locSection',
          'sba': 'sbaSection',
          'equipment': 'equipmentSection',
          'payoff': 'payoffSection'
        };
        const sectionId = sectionMap[urlConfig.calcType] || 'prequalSection';
        const section = document.getElementById(sectionId);
        if (section) section.classList.add('active');
        
        renderCalculatorContent(urlConfig.calcType);
      } else {
        // Default to prequal
        renderCalculatorContent('prequal');
      }
    }
    
    function renderLoanProductTabs() {
      // Deprecated - using sidebar navigation now
    }
    
    function setLoanProduct(id) {
      // Deprecated - using sidebar navigation now
    }
    
    function renderLoanContent() {
      // Deprecated - using renderCalculatorContent now
      renderCalculatorContent(currentTool);
    }
    
    function loanSlider(label, id, min, max, step, value, format, unit = '') {
      return `
        <div class="rounded-2xl p-5 border" style="background: var(--bg-option-card); border-color: var(--border-secondary); margin-bottom: 16px;">
          <label class="text-xs font-bold uppercase tracking-wide block mb-2" style="color: var(--text-muted);">${label}</label>
          <div class="flex items-baseline gap-1.5 mb-4">
            <span class="text-3xl font-extrabold" style="color: var(--text-primary);" id="${id}Display">${format(value)}</span>
            ${unit ? `<span class="text-sm font-semibold" style="color: var(--text-muted);">${unit}</span>` : ''}
          </div>
          <input type="range" class="slider w-full" id="${id}" min="${min}" max="${max}" step="${step}" value="${value}" oninput="updateLoanSlider('${id}')">
          <div class="flex justify-between text-[10px] font-semibold mt-2 uppercase tracking-wider" style="color: var(--text-muted);">
            <span>${format(min)}</span>
            <span>${format(max)}</span>
          </div>
        </div>`;
    }
    
    function updateLoanSlider(id) {
      const val = parseFloat(document.getElementById(id).value);
      const s = loanState;
      const el = document.getElementById(id+'Display');
      switch(id) {
        case 'mcaAmount': s.mcaAmount = val; el.textContent = formatCurrency(val); break;
        case 'mcaFactor': s.mcaFactor = val; el.textContent = val.toFixed(2)+'x'; break;
        case 'mcaTerm': s.mcaTerm = val; el.textContent = val+' mo'; break;
        case 'wcAmount': s.wcAmount = val; el.textContent = formatCurrency(val); break;
        case 'wcRate': s.wcRate = val; el.textContent = val.toFixed(1)+'%'; break;
        case 'wcTerm': s.wcTerm = val; el.textContent = val+' mo'; break;
        case 'termAmount': s.termAmount = val; el.textContent = formatCurrency(val); break;
        case 'termRate': s.termRate = val; el.textContent = val.toFixed(2)+'%'; break;
        case 'termTerm': s.termTerm = val; el.textContent = val+' mo'; break;
        case 'locLimit': s.locLimit = val; el.textContent = formatCurrency(val); break;
        case 'locDrawn': s.locDrawn = Math.min(val, s.locLimit); el.textContent = formatCurrency(s.locDrawn); break;
        case 'locRate': s.locRate = val; el.textContent = val.toFixed(1)+'%'; break;
        case 'sbaAmount': s.sbaAmount = val; el.textContent = formatCurrency(val); break;
        case 'sbaRate': s.sbaRate = val; el.textContent = val.toFixed(2)+'%'; break;
        case 'sbaTerm': s.sbaTerm = val; el.textContent = val+' mo'; break;
        case 'equipCost': s.equipCost = val; el.textContent = formatCurrency(val); break;
        case 'equipDown': s.equipDown = val; el.textContent = val+'%'; break;
        case 'equipRate': s.equipRate = val; el.textContent = val.toFixed(2)+'%'; break;
        case 'equipTerm': s.equipTerm = val; el.textContent = val+' mo'; break;
        case 'payoffBalance': s.payoffBalance = val; el.textContent = formatCurrency(val); break;
        case 'payoffFactor': s.payoffFactor = val; el.textContent = val.toFixed(2)+'x'; break;
        case 'payoffRemaining': s.payoffRemaining = val; el.textContent = val+' mo'; break;
        case 'payoffDiscount': s.payoffDiscount = val; el.textContent = val+'%'; break;
        // CRE
        case 'creAmount': s.creAmount = val; el.textContent = formatCurrency(val); break;
        case 'creLTV': s.creLTV = val; el.textContent = val+'%'; break;
        case 'creRate': s.creRate = val; el.textContent = val.toFixed(2)+'%'; break;
        case 'creTerm': s.creTerm = val; el.textContent = val+' mo'; break;
        case 'creNOI': s.creNOI = val; el.textContent = formatCurrency(val); break;
        // Factoring
        case 'factInvoiceAmount': s.factInvoiceAmount = val; el.textContent = formatCurrency(val); break;
        case 'factAdvanceRate': s.factAdvanceRate = val; el.textContent = val+'%'; break;
        case 'factFee': s.factFee = val; el.textContent = val.toFixed(2)+'%'; break;
        case 'factDays': s.factDays = val; el.textContent = val+' days'; break;
        // APR
        case 'aprAmount': s.aprAmount = val; el.textContent = formatCurrency(val); break;
        case 'aprFactor': s.aprFactor = val; el.textContent = val.toFixed(2)+'x'; break;
        case 'aprTerm': s.aprTerm = val; el.textContent = val+' mo'; break;
        case 'aprOrigFee': s.aprOrigFee = val; el.textContent = val.toFixed(1)+'%'; break;
      }
      // Update just the result card, not the input sliders
      updateCalculatorResult(currentTool);
    }
    
    function setMcaFrequency(freq) {
      loanState.mcaFreq = freq;
      // Update toggle button active states
      const toggle = document.getElementById('mcaFreqToggle');
      if (toggle) {
        toggle.querySelectorAll('.toggle-btn').forEach((btn, i) => {
          const btnFreq = ['daily', 'weekly', 'monthly'][i];
          btn.classList.toggle('active', btnFreq === freq);
        });
      }
      // Update result
      updateCalculatorResult('mca');
    }
    
    function updateCalculatorResult(tool) {
      const s = loanState;
      let resultCard;
      
      switch(tool) {
        case 'mca':
          resultCard = document.getElementById('mcaResultCard');
          if (!resultCard) return;
          const mcaPayback = s.mcaAmount * s.mcaFactor;
          const mcaCost = mcaPayback - s.mcaAmount;
          const mcaTotalPayments = s.mcaTerm * (s.mcaFreq === 'daily' ? 21 : (s.mcaFreq === 'weekly' ? 4.33 : 1));
          const mcaPayment = mcaPayback / mcaTotalPayments;
          const mcaPrincipalPct = Math.round((s.mcaAmount / mcaPayback) * 100);
          resultCard.innerHTML = getMCAResultHTML(s, mcaPayback, mcaCost, mcaTotalPayments, mcaPayment, mcaPrincipalPct);
          break;
          
        case 'working':
          resultCard = document.getElementById('workingResultCard');
          if (!resultCard) return;
          const wcMonthlyRate = s.wcRate / 100 / 12;
          let wcPayment, wcTotalPaid, wcInterest;
          if (wcMonthlyRate === 0) {
            wcPayment = s.wcAmount / s.wcTerm;
            wcTotalPaid = s.wcAmount;
            wcInterest = 0;
          } else {
            wcPayment = s.wcAmount * (wcMonthlyRate * Math.pow(1+wcMonthlyRate, s.wcTerm)) / (Math.pow(1+wcMonthlyRate, s.wcTerm) - 1);
            wcTotalPaid = wcPayment * s.wcTerm;
            wcInterest = wcTotalPaid - s.wcAmount;
          }
          const wcPrincipalPct = Math.round((s.wcAmount / (wcTotalPaid || 1)) * 100);
          resultCard.innerHTML = getWorkingCapitalResultHTML(s, wcPayment || 0, wcTotalPaid || 0, wcInterest || 0, wcPrincipalPct || 0);
          break;
          
        case 'term':
          resultCard = document.getElementById('termResultCard');
          if (!resultCard) return;
          const termMonthlyRate = s.termRate / 100 / 12;
          const termPayment = s.termAmount * (termMonthlyRate * Math.pow(1+termMonthlyRate, s.termTerm)) / (Math.pow(1+termMonthlyRate, s.termTerm) - 1);
          const termTotalPaid = termPayment * s.termTerm;
          const termInterest = termTotalPaid - s.termAmount;
          const termPrincipalPct = Math.round((s.termAmount / termTotalPaid) * 100);
          resultCard.innerHTML = getTermLoanResultHTML(s, termPayment, termTotalPaid, termInterest, termPrincipalPct);
          break;
          
        case 'loc':
          resultCard = document.getElementById('locResultCard');
          if (!resultCard) return;
          const locMonthlyInterest = s.locDrawn * (s.locRate / 100 / 12);
          const locUtilization = Math.round((s.locDrawn / s.locLimit) * 100);
          const locAvailable = s.locLimit - s.locDrawn;
          resultCard.innerHTML = getLOCResultHTML(s, locMonthlyInterest, locUtilization, locAvailable);
          break;
          
        case 'sba':
          resultCard = document.getElementById('sbaResultCard');
          if (!resultCard) return;
          const sbaMonthlyRate = s.sbaRate / 100 / 12;
          const sbaPayment = s.sbaAmount * (sbaMonthlyRate * Math.pow(1+sbaMonthlyRate, s.sbaTerm)) / (Math.pow(1+sbaMonthlyRate, s.sbaTerm) - 1);
          const sbaTotalPaid = sbaPayment * s.sbaTerm;
          const sbaInterest = sbaTotalPaid - s.sbaAmount;
          const sbaPrincipalPct = Math.round((s.sbaAmount / sbaTotalPaid) * 100);
          resultCard.innerHTML = getSBAResultHTML(s, sbaPayment, sbaTotalPaid, sbaInterest, sbaPrincipalPct);
          break;
          
        case 'equipment':
          resultCard = document.getElementById('equipResultCard');
          if (!resultCard) return;
          const equipDownAmt = s.equipCost * (s.equipDown / 100);
          const equipFinanced = s.equipCost - equipDownAmt;
          const equipMonthlyRate = s.equipRate / 100 / 12;
          const equipPayment = equipFinanced * (equipMonthlyRate * Math.pow(1+equipMonthlyRate, s.equipTerm)) / (Math.pow(1+equipMonthlyRate, s.equipTerm) - 1);
          const equipTotalPaid = equipPayment * s.equipTerm;
          const equipInterest = equipTotalPaid - equipFinanced;
          const equipPrincipalPct = Math.round((equipFinanced / equipTotalPaid) * 100);
          resultCard.innerHTML = getEquipmentResultHTML(s, equipDownAmt, equipFinanced, equipPayment, equipTotalPaid, equipInterest, equipPrincipalPct);
          break;
          
        case 'payoff':
          resultCard = document.getElementById('payoffResultCard');
          if (!resultCard) return;
          const payoffOriginal = s.payoffBalance / s.payoffFactor;
          const payoffRemPymt = s.payoffRemaining * 21;
          const payoffDailyPmt = s.payoffBalance / payoffRemPymt;
          const payoffSavings = s.payoffBalance * (s.payoffDiscount / 100);
          const payoffSettlement = s.payoffBalance - payoffSavings;
          resultCard.innerHTML = getPayoffResultHTML(s, payoffOriginal, payoffDailyPmt, payoffSavings, payoffSettlement);
          break;
          
        // For CRE, Factoring, APR - use full re-render
        case 'cre':
        case 'factoring':
        case 'apr':
          renderCalculatorContent(tool);
          break;
      }
    }
    
    function getMCAResultHTML(s, payback, cost, totalPayments, payment, principalPct) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">You Get</div>
          <div class="calc-preview-amount">${formatCurrency(s.mcaAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Payback</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(payback)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term Length</span>
            <span class="calc-stat-value">${s.mcaTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Payments</span>
            <span class="calc-stat-value">${Math.round(totalPayments)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Rate</span>
            <span class="calc-stat-value font-mono">${s.mcaFactor.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(cost)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">${s.mcaFreq.charAt(0).toUpperCase()+s.mcaFreq.slice(1)} Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getWorkingCapitalResultHTML(s, payment, totalPaid, interest, principalPct) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.wcAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.wcTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">APR</span>
            <span class="calc-stat-value font-mono">${s.wcRate.toFixed(1)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(interest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value">${formatCurrency(totalPaid)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getTermLoanResultHTML(s, payment, totalPaid, interest, principalPct) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(s.termAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.termTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.termRate.toFixed(2)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(interest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value">${formatCurrency(totalPaid)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getLOCResultHTML(s, monthlyInterest, utilization, available) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Credit Line</div>
          <div class="calc-preview-amount">${formatCurrency(s.locLimit)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${utilization} ${100-utilization}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Drawn</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(s.locDrawn)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Utilized</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Available</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Utilization</span>
            <span class="calc-stat-value">${utilization}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.locRate.toFixed(1)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Available</span>
            <span class="calc-stat-value">${formatCurrency(available)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Monthly Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(monthlyInterest)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Interest Only Payment</div>
          <div class="calc-payment-amount">${formatCurrency(monthlyInterest)}</div>
        </div>`;
    }
    
    function getSBAResultHTML(s, payment, totalPaid, interest, principalPct) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">SBA 7(a) Loan</div>
          <div class="calc-preview-amount">${formatCurrency(s.sbaAmount)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.sbaTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.sbaRate.toFixed(2)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(interest)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value">${formatCurrency(totalPaid)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getEquipmentResultHTML(s, downAmt, financed, payment, totalPaid, interest, principalPct) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Equipment Cost</div>
          <div class="calc-preview-amount">${formatCurrency(s.equipCost)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Financed</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(financed)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Down Payment</span>
            <span class="calc-stat-value">${formatCurrency(downAmt)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.equipTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.equipRate.toFixed(2)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(interest)}</span>
          </div>
        </div>
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>`;
    }
    
    function getPayoffResultHTML(s, original, dailyPmt, savings, settlement) {
      return `
        <div class="calc-preview-header">
          <div class="calc-preview-label">Current Balance</div>
          <div class="calc-preview-amount">${formatCurrency(s.payoffBalance)}</div>
        </div>
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="#10b981" stroke-width="3" stroke-dasharray="${s.payoffDiscount} ${100-s.payoffDiscount}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Settlement</span>
              <span class="text-base font-bold" style="color:#10b981;">${formatCurrency(settlement)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: #10b981;"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Savings</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Settlement</span>
            </div>
          </div>
        </div>
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Original Funding</span>
            <span class="calc-stat-value">${formatCurrency(original)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Rate</span>
            <span class="calc-stat-value font-mono">${s.payoffFactor.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Remaining Term</span>
            <span class="calc-stat-value">${s.payoffRemaining} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Daily Payment</span>
            <span class="calc-stat-value">${formatCurrency(dailyPmt)}</span>
          </div>
        </div>
        <div class="calc-payment-display" style="background: #10b98115;">
          <div class="calc-payment-label" style="color: #10b981;">You Save</div>
          <div class="calc-payment-amount" style="color: #10b981;">${formatCurrency(savings)}</div>
        </div>`;
    }
    
    // Calculator preview action buttons helper
    function calcPreviewActions(calcType) {
      return `
        <div class="calc-preview-actions">
          <button class="calc-action-btn primary" onclick="copyCalcLink('${calcType}', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
            <span class="btn-text">Copy Client Link</span>
          </button>
          <button class="calc-action-btn" onclick="openCalcPreview('${calcType}')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            <span class="btn-text">Preview</span>
          </button>
        </div>`;
    }
    
    // Copy calculator link to clipboard
    function copyCalcLink(calcType, btn) {
      const s = loanState;
      const params = new URLSearchParams();
      params.set('calc', calcType);
      params.set('mode', 'client');
      
      // Add calculator-specific params
      switch(calcType) {
        case 'mca':
          params.set('amount', s.mcaAmount);
          params.set('factor', s.mcaFactor);
          params.set('term', s.mcaTerm);
          params.set('freq', s.mcaFreq);
          break;
        case 'working':
          params.set('amount', s.wcAmount);
          params.set('rate', s.wcRate);
          params.set('term', s.wcTerm);
          break;
        case 'term':
          params.set('amount', s.termAmount);
          params.set('rate', s.termRate);
          params.set('term', s.termTerm);
          break;
        case 'loc':
          params.set('limit', s.locLimit);
          params.set('drawn', s.locDrawn);
          params.set('rate', s.locRate);
          break;
        case 'sba':
          params.set('amount', s.sbaAmount);
          params.set('rate', s.sbaRate);
          params.set('term', s.sbaTerm);
          break;
        case 'equipment':
          params.set('cost', s.equipCost);
          params.set('down', s.equipDown);
          params.set('rate', s.equipRate);
          params.set('term', s.equipTerm);
          break;
        case 'payoff':
          params.set('balance', s.payoffBalance);
          params.set('factor', s.payoffFactor);
          params.set('remaining', s.payoffRemaining);
          params.set('discount', s.payoffDiscount);
          break;
        case 'prequal':
          const c = s.prequalCriteria || {};
          params.set('rev', c.monthlyRevenue || 50000);
          params.set('adb', c.avgDailyBalance || 8000);
          params.set('fico', c.creditScore || 650);
          params.set('tib', c.monthsInBusiness || 24);
          params.set('nsf', c.nsfCount || 2);
          params.set('neg', c.negativeDays || 1);
          if (c.isRestricted) params.set('restricted', '1');
          break;
      }
      
      // Add branding params
      if (state.companyName) params.set('company', state.companyName);
      if (state.theme?.primary) params.set('color', state.theme.primary.replace('#', ''));
      if (state.logoUrl) params.set('logo', encodeURIComponent(state.logoUrl));
      
      const baseUrl = window.location.origin + window.location.pathname;
      const fullUrl = baseUrl + '?' + params.toString();
      
      navigator.clipboard.writeText(fullUrl).then(() => {
        const textSpan = btn.querySelector('.btn-text');
        const originalText = textSpan.textContent;
        textSpan.textContent = 'Copied!';
        btn.style.background = '#10b981';
        btn.style.borderColor = '#10b981';
        setTimeout(() => {
          textSpan.textContent = originalText;
          btn.style.background = '';
          btn.style.borderColor = '';
        }, 2000);
      });
    }
    
    // Parse URL params on load to set calculator state
    function loadCalcFromURL() {
      const params = new URLSearchParams(window.location.search);
      const calcType = params.get('calc');
      const isClientMode = params.get('mode') === 'client';
      
      if (!calcType) return false;
      
      const s = loanState;
      
      switch(calcType) {
        case 'mca':
          if (params.has('amount')) s.mcaAmount = parseFloat(params.get('amount'));
          if (params.has('factor')) s.mcaFactor = parseFloat(params.get('factor'));
          if (params.has('term')) s.mcaTerm = parseInt(params.get('term'));
          if (params.has('freq')) s.mcaFreq = params.get('freq');
          break;
        case 'working':
          if (params.has('amount')) s.wcAmount = parseFloat(params.get('amount'));
          if (params.has('rate')) s.wcRate = parseFloat(params.get('rate'));
          if (params.has('term')) s.wcTerm = parseInt(params.get('term'));
          break;
        case 'term':
          if (params.has('amount')) s.termAmount = parseFloat(params.get('amount'));
          if (params.has('rate')) s.termRate = parseFloat(params.get('rate'));
          if (params.has('term')) s.termTerm = parseInt(params.get('term'));
          break;
        case 'loc':
          if (params.has('limit')) s.locLimit = parseFloat(params.get('limit'));
          if (params.has('drawn')) s.locDrawn = parseFloat(params.get('drawn'));
          if (params.has('rate')) s.locRate = parseFloat(params.get('rate'));
          break;
        case 'sba':
          if (params.has('amount')) s.sbaAmount = parseFloat(params.get('amount'));
          if (params.has('rate')) s.sbaRate = parseFloat(params.get('rate'));
          if (params.has('term')) s.sbaTerm = parseInt(params.get('term'));
          break;
        case 'equipment':
          if (params.has('cost')) s.equipCost = parseFloat(params.get('cost'));
          if (params.has('down')) s.equipDown = parseFloat(params.get('down'));
          if (params.has('rate')) s.equipRate = parseFloat(params.get('rate'));
          if (params.has('term')) s.equipTerm = parseInt(params.get('term'));
          break;
        case 'payoff':
          if (params.has('balance')) s.payoffBalance = parseFloat(params.get('balance'));
          if (params.has('factor')) s.payoffFactor = parseFloat(params.get('factor'));
          if (params.has('remaining')) s.payoffRemaining = parseInt(params.get('remaining'));
          if (params.has('discount')) s.payoffDiscount = parseFloat(params.get('discount'));
          break;
        case 'prequal':
          s.prequalCriteria = s.prequalCriteria || {};
          if (params.has('rev')) s.prequalCriteria.monthlyRevenue = parseFloat(params.get('rev'));
          if (params.has('adb')) s.prequalCriteria.avgDailyBalance = parseFloat(params.get('adb'));
          if (params.has('fico')) s.prequalCriteria.creditScore = parseInt(params.get('fico'));
          if (params.has('tib')) s.prequalCriteria.monthsInBusiness = parseInt(params.get('tib'));
          if (params.has('nsf')) s.prequalCriteria.nsfCount = parseInt(params.get('nsf'));
          if (params.has('neg')) s.prequalCriteria.negativeDays = parseInt(params.get('neg'));
          if (params.has('restricted')) s.prequalCriteria.isRestricted = params.get('restricted') === '1';
          break;
      }
      
      // Load branding
      if (params.has('company')) state.companyName = params.get('company');
      if (params.has('color')) {
        state.theme = state.theme || {};
        state.theme.primary = '#' + params.get('color');
      }
      if (params.has('logo')) state.logoUrl = decodeURIComponent(params.get('logo'));
      
      // Return the calc type to switch to
      return { calcType, isClientMode };
    }
    
    // Open calculator preview in new window
    function openCalcPreview(calcType) {
      const previewHTML = generateCalcPreviewHTML(calcType);
      const previewWindow = window.open('', '_blank', 'width=500,height=700');
      previewWindow.document.write(previewHTML);
      previewWindow.document.close();
    }
    
    // Generate preview HTML for each calculator type
    function generateCalcPreviewHTML(calcType) {
      const s = loanState;
      const theme = state.theme || {};
      const primaryColor = theme.primary || '#6366f1';
      const companyName = state.companyName || 'Trust Capital Funding';
      const logoUrl = state.logoUrl || '';
      
      const baseStyles = `
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); min-height: 100vh; padding: 24px; }
          .card { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-width: 420px; margin: 0 auto; overflow: hidden; }
          .header { background: ${primaryColor}; color: white; padding: 28px 24px; text-align: center; }
          .logo { max-height: 40px; margin-bottom: 12px; }
          .header h1 { font-size: 14px; font-weight: 600; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.1em; }
          .header .amount { font-size: 42px; font-weight: 800; }
          .content { padding: 24px; }
          .stat-row { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #f1f5f9; }
          .stat-row:last-child { border-bottom: none; }
          .stat-label { color: #64748b; font-size: 13px; font-weight: 500; }
          .stat-value { color: #1e293b; font-size: 14px; font-weight: 700; }
          .highlight { background: linear-gradient(135deg, ${primaryColor}15, ${primaryColor}08); border-radius: 12px; padding: 20px; margin-top: 16px; text-align: center; }
          .highlight-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px; }
          .highlight-value { font-size: 32px; font-weight: 800; color: ${primaryColor}; }
          .footer { text-align: center; padding: 20px; background: #f8fafc; font-size: 11px; color: #94a3b8; }
        </style>
      `;
      
      let content = '';
      
      switch(calcType) {
        case 'mca': {
          const payback = s.mcaAmount * s.mcaFactor;
          const cost = payback - s.mcaAmount;
          const totalPayments = s.mcaTerm * (s.mcaFreq === 'daily' ? 21 : (s.mcaFreq === 'weekly' ? 4.33 : 1));
          const payment = payback / totalPayments;
          content = `
            <div class="header">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>MCA Funding Offer</h1>
              <div class="amount">${formatCurrency(s.mcaAmount)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Factor Rate</span><span class="stat-value">${s.mcaFactor.toFixed(2)}x</span></div>
              <div class="stat-row"><span class="stat-label">Term Length</span><span class="stat-value">${s.mcaTerm} months</span></div>
              <div class="stat-row"><span class="stat-label">Payment Frequency</span><span class="stat-value">${s.mcaFreq.charAt(0).toUpperCase()+s.mcaFreq.slice(1)}</span></div>
              <div class="stat-row"><span class="stat-label">Total Payments</span><span class="stat-value">${Math.round(totalPayments)}</span></div>
              <div class="stat-row"><span class="stat-label">Total Payback</span><span class="stat-value">${formatCurrency(payback)}</span></div>
              <div class="stat-row"><span class="stat-label">Cost of Capital</span><span class="stat-value">${formatCurrency(cost)}</span></div>
              <div class="highlight">
                <div class="highlight-label">${s.mcaFreq} Payment</div>
                <div class="highlight-value">${formatCurrency(payment)}</div>
              </div>
            </div>`;
          break;
        }
        case 'working': {
          const monthlyRate = s.wcRate / 100 / 12;
          const payment = s.wcAmount * (monthlyRate * Math.pow(1+monthlyRate, s.wcTerm)) / (Math.pow(1+monthlyRate, s.wcTerm) - 1);
          const totalPaid = payment * s.wcTerm;
          const interest = totalPaid - s.wcAmount;
          content = `
            <div class="header">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>Working Capital Loan</h1>
              <div class="amount">${formatCurrency(s.wcAmount)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Interest Rate</span><span class="stat-value">${s.wcRate.toFixed(1)}% APR</span></div>
              <div class="stat-row"><span class="stat-label">Term Length</span><span class="stat-value">${s.wcTerm} months</span></div>
              <div class="stat-row"><span class="stat-label">Total Interest</span><span class="stat-value">${formatCurrency(interest)}</span></div>
              <div class="stat-row"><span class="stat-label">Total Repayment</span><span class="stat-value">${formatCurrency(totalPaid)}</span></div>
              <div class="highlight">
                <div class="highlight-label">Monthly Payment</div>
                <div class="highlight-value">${formatCurrency(payment)}</div>
              </div>
            </div>`;
          break;
        }
        case 'term': {
          const monthlyRate = s.termRate / 100 / 12;
          const payment = s.termAmount * (monthlyRate * Math.pow(1+monthlyRate, s.termTerm)) / (Math.pow(1+monthlyRate, s.termTerm) - 1);
          const totalPaid = payment * s.termTerm;
          const interest = totalPaid - s.termAmount;
          content = `
            <div class="header">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>Term Loan</h1>
              <div class="amount">${formatCurrency(s.termAmount)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Interest Rate</span><span class="stat-value">${s.termRate.toFixed(2)}% APR</span></div>
              <div class="stat-row"><span class="stat-label">Term Length</span><span class="stat-value">${s.termTerm} months</span></div>
              <div class="stat-row"><span class="stat-label">Total Interest</span><span class="stat-value">${formatCurrency(interest)}</span></div>
              <div class="stat-row"><span class="stat-label">Total Repayment</span><span class="stat-value">${formatCurrency(totalPaid)}</span></div>
              <div class="highlight">
                <div class="highlight-label">Monthly Payment</div>
                <div class="highlight-value">${formatCurrency(payment)}</div>
              </div>
            </div>`;
          break;
        }
        case 'loc': {
          const monthlyInterest = s.locDrawn * (s.locRate / 100 / 12);
          const utilization = Math.round((s.locDrawn / s.locLimit) * 100);
          const available = s.locLimit - s.locDrawn;
          content = `
            <div class="header">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>Line of Credit</h1>
              <div class="amount">${formatCurrency(s.locLimit)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Credit Limit</span><span class="stat-value">${formatCurrency(s.locLimit)}</span></div>
              <div class="stat-row"><span class="stat-label">Current Draw</span><span class="stat-value">${formatCurrency(s.locDrawn)}</span></div>
              <div class="stat-row"><span class="stat-label">Available Credit</span><span class="stat-value">${formatCurrency(available)}</span></div>
              <div class="stat-row"><span class="stat-label">Interest Rate</span><span class="stat-value">${s.locRate.toFixed(1)}% APR</span></div>
              <div class="stat-row"><span class="stat-label">Utilization</span><span class="stat-value">${utilization}%</span></div>
              <div class="highlight">
                <div class="highlight-label">Monthly Interest</div>
                <div class="highlight-value">${formatCurrency(monthlyInterest)}</div>
              </div>
            </div>`;
          break;
        }
        case 'sba': {
          const monthlyRate = s.sbaRate / 100 / 12;
          const payment = s.sbaAmount * (monthlyRate * Math.pow(1+monthlyRate, s.sbaTerm)) / (Math.pow(1+monthlyRate, s.sbaTerm) - 1);
          const totalPaid = payment * s.sbaTerm;
          const interest = totalPaid - s.sbaAmount;
          content = `
            <div class="header">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>SBA Loan</h1>
              <div class="amount">${formatCurrency(s.sbaAmount)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Interest Rate</span><span class="stat-value">${s.sbaRate.toFixed(2)}% APR</span></div>
              <div class="stat-row"><span class="stat-label">Term Length</span><span class="stat-value">${s.sbaTerm} months (${Math.round(s.sbaTerm/12)} years)</span></div>
              <div class="stat-row"><span class="stat-label">Total Interest</span><span class="stat-value">${formatCurrency(interest)}</span></div>
              <div class="stat-row"><span class="stat-label">Total Repayment</span><span class="stat-value">${formatCurrency(totalPaid)}</span></div>
              <div class="highlight">
                <div class="highlight-label">Monthly Payment</div>
                <div class="highlight-value">${formatCurrency(payment)}</div>
              </div>
            </div>`;
          break;
        }
        case 'equipment': {
          const financed = s.equipCost * (1 - s.equipDown/100);
          const downAmt = s.equipCost * (s.equipDown/100);
          const monthlyRate = s.equipRate / 100 / 12;
          const payment = financed * (monthlyRate * Math.pow(1+monthlyRate, s.equipTerm)) / (Math.pow(1+monthlyRate, s.equipTerm) - 1);
          const totalPaid = payment * s.equipTerm + downAmt;
          content = `
            <div class="header">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>Equipment Financing</h1>
              <div class="amount">${formatCurrency(s.equipCost)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Equipment Cost</span><span class="stat-value">${formatCurrency(s.equipCost)}</span></div>
              <div class="stat-row"><span class="stat-label">Down Payment</span><span class="stat-value">${formatCurrency(downAmt)} (${s.equipDown}%)</span></div>
              <div class="stat-row"><span class="stat-label">Financed Amount</span><span class="stat-value">${formatCurrency(financed)}</span></div>
              <div class="stat-row"><span class="stat-label">Interest Rate</span><span class="stat-value">${s.equipRate.toFixed(2)}% APR</span></div>
              <div class="stat-row"><span class="stat-label">Term Length</span><span class="stat-value">${s.equipTerm} months</span></div>
              <div class="highlight">
                <div class="highlight-label">Monthly Payment</div>
                <div class="highlight-value">${formatCurrency(payment)}</div>
              </div>
            </div>`;
          break;
        }
        case 'payoff': {
          const originalPayback = s.payoffBalance * s.payoffFactor;
          const remainingPayback = originalPayback * (s.payoffRemaining / (s.payoffRemaining + 6));
          const discountedPayoff = remainingPayback * (1 - s.payoffDiscount/100);
          const savings = remainingPayback - discountedPayoff;
          content = `
            <div class="header" style="background: linear-gradient(135deg, #10b981, #059669);">
              ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
              <h1>Early Payoff Analysis</h1>
              <div class="amount">${formatCurrency(discountedPayoff)}</div>
            </div>
            <div class="content">
              <div class="stat-row"><span class="stat-label">Current Balance</span><span class="stat-value">${formatCurrency(s.payoffBalance)}</span></div>
              <div class="stat-row"><span class="stat-label">Original Factor</span><span class="stat-value">${s.payoffFactor.toFixed(2)}x</span></div>
              <div class="stat-row"><span class="stat-label">Remaining Term</span><span class="stat-value">${s.payoffRemaining} months</span></div>
              <div class="stat-row"><span class="stat-label">Remaining Payback</span><span class="stat-value">${formatCurrency(remainingPayback)}</span></div>
              <div class="stat-row"><span class="stat-label">Discount Applied</span><span class="stat-value">${s.payoffDiscount}%</span></div>
              <div class="highlight" style="background: linear-gradient(135deg, #10b98115, #05966908);">
                <div class="highlight-label">You Save</div>
                <div class="highlight-value" style="color: #10b981;">${formatCurrency(savings)}</div>
              </div>
            </div>`;
          break;
        }
        case 'prequal': {
          const criteria = s.prequalCriteria || {
            monthlyRevenue: 50000, avgDailyBalance: 8000, creditScore: 650,
            monthsInBusiness: 24, nsfCount: 2, negativeDays: 1, isRestricted: false
          };
          
          // Run ABLESCORE v4.1 Engine
          const engine = new PerrepusAI_v4_1(criteria);
          const result_data = engine.process();
          const isApproved = result_data.status === "APPROVED";
          
          if (!isApproved) {
            content = `
              <div class="header" style="background: linear-gradient(135deg, #ef4444, #ef4444dd);">
                ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
                <h1>Pre-Qualification Analysis</h1>
                <div class="amount">DECLINED</div>
              </div>
              <div class="content">
                <div class="stat-row"><span class="stat-label">Decision</span><span class="stat-value" style="color:#ef4444;">Not Approved</span></div>
                <div class="stat-row"><span class="stat-label">Reason</span><span class="stat-value">${result_data.reason}</span></div>
                ${result_data.score ? `<div class="stat-row"><span class="stat-label">Score</span><span class="stat-value">${result_data.score}/100</span></div>` : ''}
              </div>`;
          } else {
            const o = result_data.offer;
            const c = result_data.closing;
            const tier = result_data.score.tierId;
            const tierColors = { 'A': '#10b981', 'B': '#22c55e', 'C': '#eab308', 'D': '#f97316', 'E': '#ef4444' };
            const gradeColor = tierColors[tier] || '#6366f1';
            const isHighRisk = tier === 'D' || tier === 'E';
            const riskLabel = tier === 'E' ? '⚠ HIGH RISK' : tier === 'D' ? '⚠ ELEVATED RISK' : '';
            
            content = `
              <div class="header" style="background: linear-gradient(135deg, ${gradeColor}, ${gradeColor}dd);">
                ${logoUrl ? `<img src="${logoUrl}" class="logo" alt="${companyName}">` : ''}
                <h1>Pre-Qualification Approval</h1>
                <div class="amount">TIER ${tier}</div>
                ${isHighRisk ? `<div style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 4px; margin-top: 8px; font-size: 11px; font-weight: 600;">${riskLabel} - Aggressive Underwriting</div>` : ''}
              </div>
              <div class="content">
                <div class="stat-row"><span class="stat-label">Score</span><span class="stat-value">${result_data.score.value}/100</span></div>
                <div class="stat-row"><span class="stat-label">Risk Tier</span><span class="stat-value">${result_data.score.tier}</span></div>
                <div class="stat-row"><span class="stat-label">Approved Amount</span><span class="stat-value" style="color:${gradeColor};">${formatCurrency(o.funding_amount)}</span></div>
                <div class="stat-row"><span class="stat-label">Factor Rate</span><span class="stat-value" style="${isHighRisk ? 'color:' + gradeColor + ';font-weight:700;' : ''}">${o.factor_rate.toFixed(2)}x</span></div>
                <div class="stat-row"><span class="stat-label">Term</span><span class="stat-value">${(o.term_label || o.term + ' Months')}</span></div>
                <div class="stat-row"><span class="stat-label">Daily Payment</span><span class="stat-value">${formatCurrency(result_data.schedule.daily_payment)}</span></div>
                <div class="stat-row"><span class="stat-label">Total Payback</span><span class="stat-value">${formatCurrency(o.payback_amount)}</span></div>
                <div class="stat-row"><span class="stat-label">Net Wire</span><span class="stat-value" style="color:#10b981;">${formatCurrency(c.net_wire)}</span></div>
                <div class="highlight" style="background: linear-gradient(135deg, ${gradeColor}15, ${gradeColor}08);">
                  <div class="highlight-label">Decision</div>
                  <div class="highlight-value" style="color: ${gradeColor}; font-size: 18px;">${isHighRisk ? '⚠' : '✓'} APPROVED${isHighRisk ? ' - ' + riskLabel.replace('⚠ ', '') : ''}</div>
                </div>
              </div>`;
          }
          break;
        }
        default:
          content = `<div class="header"><h1>Calculator Preview</h1></div><div class="content"><p>Preview not available for this calculator.</p></div>`;
      }
      
      return `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${companyName} - Calculator</title>${baseStyles}</head><body><div class="card">${content}<div class="footer">${companyName} • ${new Date().toLocaleDateString()}</div></div></body></html>`;
    }
    
    function renderMCA(input, result) {
      const s = loanState;
      const origFee = s.mcaAmount * (s.mcaOrigFee / 100);
      const netFunding = s.mcaAmount - origFee;
      const payback = s.mcaAmount * s.mcaFactor;
      const cost = payback - s.mcaAmount;
      const totalCost = cost + origFee;
      const totalPayments = s.mcaTerm * (s.mcaFreq === 'daily' ? 21 : (s.mcaFreq === 'weekly' ? 4.33 : 1));
      const payment = payback / totalPayments;
      const principalPct = Math.round((s.mcaAmount / payback) * 100);
      const apr = calculateMCAapr(s.mcaAmount, s.mcaFactor, s.mcaTerm, s.mcaFreq, s.mcaOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">MCA Terms</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Funding Amount', 'mcaAmount', 5000, 500000, 5000, s.mcaAmount, formatCurrency)}
          ${loanSlider('Factor Rate', 'mcaFactor', 1.10, 1.60, 0.01, s.mcaFactor, v=>v.toFixed(2)+'x')}
          ${loanSlider('Term Length', 'mcaTerm', 3, 24, 1, s.mcaTerm, v=>v+' mo')}
          ${loanSlider('Origination Fee', 'mcaOrigFee', 0, 10, 0.5, s.mcaOrigFee, v=>v.toFixed(1)+'%')}
          <div class="rounded-2xl p-5 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <label class="text-xs font-bold uppercase tracking-wide block mb-3" style="color: var(--text-muted);">Payment Frequency</label>
            <div class="toggle-group inline-flex w-full" id="mcaFreqToggle">
              <button class="toggle-btn ${s.mcaFreq==='daily'?'active':''} flex-1 py-3 rounded-lg text-sm font-semibold transition-all" onclick="setMcaFrequency('daily')">Daily</button>
              <button class="toggle-btn ${s.mcaFreq==='weekly'?'active':''} flex-1 py-3 rounded-lg text-sm font-semibold transition-all" onclick="setMcaFrequency('weekly')">Weekly</button>
              <button class="toggle-btn ${s.mcaFreq==='monthly'?'active':''} flex-1 py-3 rounded-lg text-sm font-semibold transition-all" onclick="setMcaFrequency('monthly')">Monthly</button>
            </div>
          </div>
          ${renderInputRequirements('mca')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <!-- Header with amount -->
        <div class="calc-preview-header">
          <div class="calc-preview-label">You Get</div>
          <div class="calc-preview-amount">${formatCurrency(netFunding)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">After ${formatCurrency(origFee)} origination fee</div>` : ''}
        </div>
        
        <!-- Donut Chart Section -->
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Payback</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(payback)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
            </div>
          </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term Length</span>
            <span class="calc-stat-value">${s.mcaTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Payments</span>
            <span class="calc-stat-value">${Math.round(totalPayments)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factor Rate</span>
            <span class="calc-stat-value font-mono">${s.mcaFactor.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        
        <!-- APR Display -->
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Estimated APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${apr.toFixed(1)}%</span>
          </div>
        </div>
        
        <!-- Payment Display -->
        <div class="calc-payment-display">
          <div class="calc-payment-label">${s.mcaFreq.charAt(0).toUpperCase()+s.mcaFreq.slice(1)} Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>
        
        ${renderRequirementsSection('mca')}
        `;
    }
    
    function renderWorkingCapital(input, result) {
      const s = loanState;
      const origFee = s.wcAmount * (s.wcOrigFee / 100);
      const netFunding = s.wcAmount - origFee;
      const monthlyRate = s.wcRate / 100 / 12;
      const payment = s.wcAmount * (monthlyRate * Math.pow(1+monthlyRate, s.wcTerm)) / (Math.pow(1+monthlyRate, s.wcTerm) - 1);
      const totalPaid = payment * s.wcTerm;
      const interest = totalPaid - s.wcAmount;
      const totalCost = interest + origFee;
      const principalPct = Math.round((s.wcAmount / totalPaid) * 100);
      const apr = calculateLoanAPR(s.wcAmount, s.wcRate, s.wcTerm, s.wcOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Working Capital Terms</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Loan Amount', 'wcAmount', 10000, 500000, 5000, s.wcAmount, formatCurrency)}
          ${loanSlider('Interest Rate', 'wcRate', 5, 30, 0.5, s.wcRate, v=>v.toFixed(1)+'%')}
          ${loanSlider('Term', 'wcTerm', 6, 60, 6, s.wcTerm, v=>v+' mo')}
          ${loanSlider('Origination Fee', 'wcOrigFee', 0, 10, 0.5, s.wcOrigFee, v=>v.toFixed(1)+'%')}
          ${renderInputRequirements('working')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">You Get</div>
          <div class="calc-preview-amount">${formatCurrency(netFunding)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">After ${formatCurrency(origFee)} origination fee</div>` : ''}
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term Length</span>
            <span class="calc-stat-value">${s.wcTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Payments</span>
            <span class="calc-stat-value">${s.wcTerm}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.wcRate.toFixed(1)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">True APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${apr.toFixed(2)}%</span>
          </div>
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>
        
        ${renderRequirementsSection('working')}
        `;
    }
    
    function renderTermLoan(input, result) {
      const s = loanState;
      const origFee = s.termAmount * (s.termOrigFee / 100);
      const netFunding = s.termAmount - origFee;
      const monthlyRate = s.termRate / 100 / 12;
      const payment = s.termAmount * (monthlyRate * Math.pow(1+monthlyRate, s.termTerm)) / (Math.pow(1+monthlyRate, s.termTerm) - 1);
      const totalPaid = payment * s.termTerm;
      const interest = totalPaid - s.termAmount;
      const totalCost = interest + origFee;
      const principalPct = Math.round((s.termAmount / totalPaid) * 100);
      const apr = calculateLoanAPR(s.termAmount, s.termRate, s.termTerm, s.termOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Term Loan Details</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Loan Amount', 'termAmount', 25000, 1000000, 25000, s.termAmount, formatCurrency)}
          ${loanSlider('Interest Rate', 'termRate', 4, 20, 0.25, s.termRate, v=>v.toFixed(2)+'%')}
          ${loanSlider('Term', 'termTerm', 12, 120, 12, s.termTerm, v=>v+' mo')}
          ${loanSlider('Origination Fee', 'termOrigFee', 0, 5, 0.25, s.termOrigFee, v=>v.toFixed(2)+'%')}
          ${renderInputRequirements('term')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">You Get</div>
          <div class="calc-preview-amount">${formatCurrency(netFunding)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">After ${formatCurrency(origFee)} origination fee</div>` : ''}
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term Length</span>
            <span class="calc-stat-value">${s.termTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Payments</span>
            <span class="calc-stat-value">${s.termTerm}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.termRate.toFixed(2)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">True APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${apr.toFixed(2)}%</span>
          </div>
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>
        
        ${renderRequirementsSection('term')}
        `;
    }
    
    function renderLOC(input, result) {
      const s = loanState;
      const origFee = s.locLimit * (s.locOrigFee / 100);
      const monthlyInterest = s.locDrawn * (s.locRate / 100 / 12);
      const available = s.locLimit - s.locDrawn;
      const utilization = (s.locDrawn / s.locLimit * 100);
      const utilizationPct = Math.round(utilization);
      const effectiveAPR = calculateLOCAPR(s.locLimit, s.locDrawn, s.locRate, s.locOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Line of Credit Terms</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Credit Limit', 'locLimit', 10000, 500000, 10000, s.locLimit, formatCurrency)}
          ${loanSlider('Amount Drawn', 'locDrawn', 0, s.locLimit, 1000, Math.min(s.locDrawn, s.locLimit), formatCurrency)}
          ${loanSlider('Interest Rate', 'locRate', 5, 25, 0.5, s.locRate, v=>v.toFixed(1)+'%')}
          ${loanSlider('Origination Fee', 'locOrigFee', 0, 5, 0.25, s.locOrigFee, v=>v.toFixed(2)+'%')}
          ${renderInputRequirements('loc')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">Credit Limit</div>
          <div class="calc-preview-amount">${formatCurrency(s.locLimit)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">Origination fee: ${formatCurrency(origFee)}</div>` : ''}
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${utilizationPct} ${100-utilizationPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Used</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(s.locDrawn)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Used</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Available</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Available</span>
            <span class="calc-stat-value">${formatCurrency(available)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Utilization</span>
            <span class="calc-stat-value">${utilization.toFixed(1)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.locRate.toFixed(1)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Annual Interest</span>
            <span class="calc-stat-value accent">${formatCurrency(monthlyInterest * 12)}</span>
          </div>
        </div>
        
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Effective APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${effectiveAPR.toFixed(2)}%</span>
          </div>
          ${s.locOrigFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">Includes origination fee impact</div>` : ''}
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Interest</div>
          <div class="calc-payment-amount">${formatCurrency(monthlyInterest)}</div>
        </div>
        
        ${renderRequirementsSection('loc')}
        `;
    }
    
    function renderSBA(input, result) {
      const s = loanState;
      const origFee = s.sbaAmount * (s.sbaOrigFee / 100);
      const netFunding = s.sbaAmount - origFee;
      const monthlyRate = s.sbaRate / 100 / 12;
      const payment = s.sbaAmount * (monthlyRate * Math.pow(1+monthlyRate, s.sbaTerm)) / (Math.pow(1+monthlyRate, s.sbaTerm) - 1);
      const totalPaid = payment * s.sbaTerm;
      const interest = totalPaid - s.sbaAmount;
      const totalCost = interest + origFee;
      const principalPct = Math.round((s.sbaAmount / totalPaid) * 100);
      const years = Math.floor(s.sbaTerm / 12);
      const months = s.sbaTerm % 12;
      const termDisplay = months > 0 ? `${years}y ${months}m` : `${years} years`;
      const apr = calculateLoanAPR(s.sbaAmount, s.sbaRate, s.sbaTerm, s.sbaOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">SBA 7(a) Loan Terms</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Loan Amount', 'sbaAmount', 50000, 5000000, 50000, s.sbaAmount, formatCurrency)}
          ${loanSlider('Interest Rate', 'sbaRate', 5, 15, 0.25, s.sbaRate, v=>v.toFixed(2)+'%')}
          ${loanSlider('Term', 'sbaTerm', 60, 300, 12, s.sbaTerm, v=>v+' mo')}
          ${loanSlider('SBA Guarantee Fee', 'sbaOrigFee', 0, 3.75, 0.25, s.sbaOrigFee, v=>v.toFixed(2)+'%')}
          ${renderInputRequirements('sba')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">You Get</div>
          <div class="calc-preview-amount">${formatCurrency(netFunding)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">After ${formatCurrency(origFee)} SBA fee</div>` : ''}
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term Length</span>
            <span class="calc-stat-value">${termDisplay}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Payments</span>
            <span class="calc-stat-value">${s.sbaTerm}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.sbaRate.toFixed(2)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">True APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${apr.toFixed(2)}%</span>
          </div>
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>
        
        ${renderRequirementsSection('sba')}
        `;
    }
    
    function renderEquipment(input, result) {
      const s = loanState;
      const financed = s.equipCost * (1 - s.equipDown/100);
      const origFee = financed * (s.equipOrigFee / 100);
      const netFunding = financed - origFee;
      const monthlyRate = s.equipRate / 100 / 12;
      const payment = financed * (monthlyRate * Math.pow(1+monthlyRate, s.equipTerm)) / (Math.pow(1+monthlyRate, s.equipTerm) - 1);
      const totalPaid = payment * s.equipTerm;
      const interest = totalPaid - financed;
      const totalCost = interest + origFee;
      const downPayment = s.equipCost * (s.equipDown/100);
      const principalPct = Math.round((financed / totalPaid) * 100);
      const apr = calculateLoanAPR(financed, s.equipRate, s.equipTerm, s.equipOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Equipment Financing Terms</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Equipment Cost', 'equipCost', 10000, 500000, 5000, s.equipCost, formatCurrency)}
          ${loanSlider('Down Payment', 'equipDown', 0, 50, 5, s.equipDown, v=>v+'%')}
          ${loanSlider('Interest Rate', 'equipRate', 3, 15, 0.25, s.equipRate, v=>v.toFixed(2)+'%')}
          ${loanSlider('Term', 'equipTerm', 12, 84, 12, s.equipTerm, v=>v+' mo')}
          ${loanSlider('Doc/Origination Fee', 'equipOrigFee', 0, 5, 0.25, s.equipOrigFee, v=>v.toFixed(2)+'%')}
          ${renderInputRequirements('equipment')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">Amount Financed</div>
          <div class="calc-preview-amount">${formatCurrency(netFunding)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">After ${formatCurrency(origFee)} doc fee</div>` : ''}
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPaid)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Down Payment</span>
            <span class="calc-stat-value">${formatCurrency(downPayment)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${s.equipTerm} months</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Interest Rate</span>
            <span class="calc-stat-value font-mono">${s.equipRate.toFixed(2)}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">True APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${apr.toFixed(2)}%</span>
          </div>
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount">${formatCurrency(payment)}</div>
        </div>
        
        ${renderRequirementsSection('equipment')}
        `;
    }
    
    function renderEarlyPayoff(input, result) {
      const s = loanState;
      const originalPayback = s.payoffBalance * s.payoffFactor;
      const remainingPayback = originalPayback * (s.payoffRemaining / 12);
      const discountAmount = remainingPayback * (s.payoffDiscount / 100);
      const payoffAmount = remainingPayback - discountAmount;
      const savings = remainingPayback - payoffAmount;
      const savingsPct = Math.round((savings / remainingPayback) * 100) || 0;
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Early Payoff Terms</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Original Balance', 'payoffBalance', 5000, 200000, 5000, s.payoffBalance, formatCurrency)}
          ${loanSlider('Original Factor', 'payoffFactor', 1.10, 1.60, 0.01, s.payoffFactor, v=>v.toFixed(2)+'x')}
          ${loanSlider('Months Remaining', 'payoffRemaining', 1, 24, 1, s.payoffRemaining, v=>v+' mo')}
          ${loanSlider('Discount Offered', 'payoffDiscount', 0, 50, 1, s.payoffDiscount, v=>v+'%')}
        </div>`;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <!-- Header with amount -->
        <div class="calc-preview-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
          <div class="calc-preview-label">You Save</div>
          <div class="calc-preview-amount">${formatCurrency(savings)}</div>
        </div>
        
        <!-- Donut Chart Section -->
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="#10b981" stroke-width="3" stroke-dasharray="${100-savingsPct} ${savingsPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Balance</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(remainingPayback)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Payoff Amount</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: #10b981;"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Savings</span>
            </div>
          </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Remaining Balance</span>
            <span class="calc-stat-value">${formatCurrency(remainingPayback)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Months Left</span>
            <span class="calc-stat-value">${s.payoffRemaining}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Discount</span>
            <span class="calc-stat-value font-mono">${s.payoffDiscount}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Savings</span>
            <span class="calc-stat-value" style="color:#10b981;">${formatCurrency(savings)}</span>
          </div>
        </div>
        
        <!-- Payment Display -->
        <div class="calc-payment-display">
          <div class="calc-payment-label">Payoff Amount</div>
          <div class="calc-payment-amount" style="color: var(--accent);">${formatCurrency(payoffAmount)}</div>
        </div>
        `;
    }
    
    // CRE (COMMERCIAL REAL ESTATE) CALCULATOR
    function renderCRE(input, result) {
      const s = loanState;
      const loanAmount = s.creAmount * (s.creLTV / 100);
      const origFee = loanAmount * (s.creOrigFee / 100);
      const netFunding = loanAmount - origFee;
      const monthlyRate = (s.creRate / 100) / 12;
      const numPayments = s.creTerm;
      const monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
      const totalPayments = monthlyPayment * numPayments;
      const totalInterest = totalPayments - loanAmount;
      const totalCost = totalInterest + origFee;
      const principalPct = Math.round((loanAmount / totalPayments) * 100);
      const annualDebtService = monthlyPayment * 12;
      const dscr = s.creNOI / annualDebtService;
      const apr = calculateLoanAPR(loanAmount, s.creRate, s.creTerm, s.creOrigFee);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Commercial Real Estate</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Property Value', 'creAmount', 100000, 5000000, 50000, s.creAmount, formatCurrency)}
          ${loanSlider('LTV Ratio', 'creLTV', 50, 90, 5, s.creLTV, v=>v+'%')}
          ${loanSlider('Interest Rate', 'creRate', 4, 15, 0.25, s.creRate, v=>v.toFixed(2)+'%')}
          ${loanSlider('Term (Months)', 'creTerm', 60, 360, 12, s.creTerm, v=>v+' mo')}
          ${loanSlider('Annual NOI', 'creNOI', 10000, 500000, 5000, s.creNOI, formatCurrency)}
          ${loanSlider('Origination Fee', 'creOrigFee', 0, 3, 0.25, s.creOrigFee, v=>v.toFixed(2)+'%')}
          ${renderInputRequirements('cre')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">Loan Amount</div>
          <div class="calc-preview-amount">${formatCurrency(netFunding)}</div>
          ${origFee > 0 ? `<div class="text-xs mt-1" style="color: var(--text-muted);">After ${formatCurrency(origFee)} origination fee</div>` : ''}
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-secondary)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-primary)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Total</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(totalPayments)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-primary);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-secondary);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Interest</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Property Value</span>
            <span class="calc-stat-value">${formatCurrency(s.creAmount)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">LTV</span>
            <span class="calc-stat-value font-mono">${s.creLTV}%</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">DSCR</span>
            <span class="calc-stat-value" style="color:${dscr >= 1.25 ? '#10b981' : dscr >= 1.0 ? '#f59e0b' : '#ef4444'};">${dscr.toFixed(2)}x</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value accent">${formatCurrency(totalCost)}</span>
          </div>
        </div>
        
        <div class="p-4 rounded-xl mb-4" style="background: var(--bg-option-card); border: 1px solid var(--border-secondary);">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">True APR</span>
            <span class="text-xl font-bold" style="color: var(--accent);">${apr.toFixed(2)}%</span>
          </div>
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Monthly Payment</div>
          <div class="calc-payment-amount" style="color: var(--accent);">${formatCurrency(monthlyPayment)}</div>
        </div>
        
        ${renderRequirementsSection('cre')}`;
    }
    
    // INVOICE FACTORING CALCULATOR
    function renderFactoring(input, result) {
      const s = loanState;
      const advanceAmount = s.factInvoiceAmount * (s.factAdvanceRate / 100);
      const reserveAmount = s.factInvoiceAmount - advanceAmount;
      const factoringFee = s.factInvoiceAmount * (s.factFee / 100);
      const reserveRelease = reserveAmount - factoringFee;
      const totalReceived = advanceAmount + reserveRelease;
      const effectiveCost = s.factInvoiceAmount - totalReceived;
      const advancePct = s.factAdvanceRate;
      const annualizedRate = ((s.factFee / 100) / s.factDays) * 365 * 100;
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">Invoice Factoring</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Invoice Amount', 'factInvoiceAmount', 5000, 500000, 5000, s.factInvoiceAmount, formatCurrency)}
          ${loanSlider('Advance Rate', 'factAdvanceRate', 70, 95, 1, s.factAdvanceRate, v=>v+'%')}
          ${loanSlider('Factoring Fee', 'factFee', 1, 10, 0.25, s.factFee, v=>v.toFixed(2)+'%')}
          ${loanSlider('Days to Payment', 'factDays', 15, 90, 5, s.factDays, v=>v+' days')}
          ${renderInputRequirements('factoring')}
        </div>
        `;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <div class="calc-preview-header">
          <div class="calc-preview-label">Immediate Advance</div>
          <div class="calc-preview-amount">${formatCurrency(advanceAmount)}</div>
        </div>
        
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-secondary)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-primary)" stroke-width="3" stroke-dasharray="${advancePct} ${100-advancePct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Invoice</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(s.factInvoiceAmount)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-primary);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Advance</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-secondary);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Reserve</span>
            </div>
          </div>
        </div>
        
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Reserve Held</span>
            <span class="calc-stat-value">${formatCurrency(reserveAmount)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Factoring Fee</span>
            <span class="calc-stat-value">${formatCurrency(factoringFee)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Reserve Release</span>
            <span class="calc-stat-value">${formatCurrency(reserveRelease)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Ann. Rate</span>
            <span class="calc-stat-value font-mono">${annualizedRate.toFixed(1)}%</span>
          </div>
        </div>
        
        <div class="calc-payment-display">
          <div class="calc-payment-label">Total You Receive</div>
          <div class="calc-payment-amount" style="color: var(--accent);">${formatCurrency(totalReceived)}</div>
        </div>
        
        ${renderRequirementsSection('factoring')}`;
    }
    
    // APR CALCULATOR
    function renderAPR(input, result) {
      const s = loanState;
      const payback = s.aprAmount * s.aprFactor;
      const cost = payback - s.aprAmount;
      const origFees = s.aprAmount * (s.aprOrigFee / 100);
      const totalCost = cost + origFees;
      const netFunding = s.aprAmount - origFees;
      
      // Calculate payments based on frequency
      let paymentsPerYear, paymentAmount, totalPayments;
      if (s.aprFreq === 'daily') {
        paymentsPerYear = 252; // business days
        totalPayments = s.aprTerm * 21; // ~21 business days per month
        paymentAmount = payback / totalPayments;
      } else if (s.aprFreq === 'weekly') {
        paymentsPerYear = 52;
        totalPayments = s.aprTerm * 4.33;
        paymentAmount = payback / totalPayments;
      } else {
        paymentsPerYear = 12;
        totalPayments = s.aprTerm;
        paymentAmount = payback / s.aprTerm;
      }
      
      // APR calculation using simple approximation
      const termYears = s.aprTerm / 12;
      const apr = ((totalCost / netFunding) / termYears) * 100;
      const principalPct = Math.round((s.aprAmount / payback) * 100);
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">APR Calculator</h3>
        </div>
        <div class="space-y-0">
          ${loanSlider('Funding Amount', 'aprAmount', 5000, 500000, 5000, s.aprAmount, formatCurrency)}
          ${loanSlider('Factor Rate', 'aprFactor', 1.10, 1.60, 0.01, s.aprFactor, v=>v.toFixed(2)+'x')}
          ${loanSlider('Term (Months)', 'aprTerm', 3, 24, 1, s.aprTerm, v=>v+' mo')}
          ${loanSlider('Origination Fee', 'aprOrigFee', 0, 10, 0.5, s.aprOrigFee, v=>v.toFixed(1)+'%')}
        </div>
        <div class="mt-4 p-3 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
          <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">Payment Frequency</label>
          <div class="flex gap-1 p-1 rounded-lg" style="background: var(--bg-card);">
            <button class="toggle-btn ${s.aprFreq==='daily'?'active':''} flex-1 py-3 rounded-lg text-sm font-semibold transition-all" onclick="loanState.aprFreq='daily';renderCalculatorContent(currentTool);">Daily</button>
            <button class="toggle-btn ${s.aprFreq==='weekly'?'active':''} flex-1 py-3 rounded-lg text-sm font-semibold transition-all" onclick="loanState.aprFreq='weekly';renderCalculatorContent(currentTool);">Weekly</button>
            <button class="toggle-btn ${s.aprFreq==='monthly'?'active':''} flex-1 py-3 rounded-lg text-sm font-semibold transition-all" onclick="loanState.aprFreq='monthly';renderCalculatorContent(currentTool);">Monthly</button>
          </div>
        </div>`;
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <!-- Header with APR -->
        <div class="calc-preview-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
          <div class="calc-preview-label">Estimated APR</div>
          <div class="calc-preview-amount">${apr.toFixed(1)}%</div>
        </div>
        
        <!-- Donut Chart Section -->
        <div class="calc-donut-section">
          <div style="position:relative;width:120px;height:120px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-secondary)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-primary)" stroke-width="3" stroke-dasharray="${principalPct} ${100-principalPct}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">Payback</span>
              <span class="text-base font-bold" style="color:var(--text-primary);">${formatCurrency(payback)}</span>
            </div>
          </div>
          <div class="space-y-3 text-xs">
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-primary);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
            </div>
            <div class="flex items-center gap-2.5">
              <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-secondary);"></span>
              <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
            </div>
          </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Net Funding</span>
            <span class="calc-stat-value">${formatCurrency(netFunding)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Cost</span>
            <span class="calc-stat-value">${formatCurrency(totalCost)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Orig. Fees</span>
            <span class="calc-stat-value">${formatCurrency(origFees)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label"># Payments</span>
            <span class="calc-stat-value font-mono">${Math.round(totalPayments)}</span>
          </div>
        </div>
        
        <!-- Payment Display -->
        <div class="calc-payment-display">
          <div class="calc-payment-label">${s.aprFreq.charAt(0).toUpperCase() + s.aprFreq.slice(1)} Payment</div>
          <div class="calc-payment-amount" style="color: var(--accent);">${formatCurrency(paymentAmount)}</div>
        </div>`;
    }
    
    // ============================================
    // ABLESCORE GUIDE
    // ============================================
    function renderPerrepusGuide(container) {
      container.innerHTML = `
        <div class="flex items-center gap-3 mb-8">
          <div class="section-indicator"></div>
          <div>
            <h2 class="text-2xl font-black" style="color: var(--text-primary);">ABLESCORE v4.1</h2>
            <p class="text-sm" style="color: var(--text-muted);">Predictive Engine for Revenue-Based Underwriting Scoring</p>
          </div>
        </div>
        
        <!-- Hero Overview -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- What is ABLESCORE -->
          <div class="rounded-2xl p-6 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: var(--accent-glow);">
                <svg class="w-5 h-5" style="color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
              </div>
              <h3 class="text-lg font-bold" style="color: var(--text-primary);">What is ABLESCORE?</h3>
            </div>
            <p class="text-sm leading-relaxed mb-4" style="color: var(--text-secondary);">
              ABLESCORE is a proprietary credit scoring algorithm designed specifically for Merchant Cash Advance (MCA) underwriting. Unlike traditional FICO scores that focus on consumer credit history, ABLESCORE evaluates a business's ability to repay based on actual cash flow performance.
            </p>
            <p class="text-sm leading-relaxed" style="color: var(--text-secondary);">
              The model analyzes 5 key dimensions of business health, producing a score from 0-100 that determines both approval status and pricing tier.
            </p>
          </div>
          
          <!-- Score Range Visual -->
          <div class="rounded-2xl p-6 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <h3 class="text-lg font-bold mb-4" style="color: var(--text-primary);">Score Range & Tiers</h3>
            <div class="space-y-2">
              <div class="flex items-center gap-3">
                <div class="w-16 h-10 rounded-lg flex items-center justify-center text-white font-black text-xl" style="background: #10b981;">A</div>
                <div class="flex-1">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold" style="color: var(--text-primary);">Prime</span>
                    <span class="text-xs font-mono" style="color: var(--text-muted);">80-100 pts</span>
                  </div>
                  <div class="text-xs" style="color: var(--text-muted);">Factor: 1.10-1.19x | Term: 12 mo</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-16 h-10 rounded-lg flex items-center justify-center text-white font-black text-xl" style="background: #22c55e;">B</div>
                <div class="flex-1">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold" style="color: var(--text-primary);">Standard</span>
                    <span class="text-xs font-mono" style="color: var(--text-muted);">65-79 pts</span>
                  </div>
                  <div class="text-xs" style="color: var(--text-muted);">Factor: 1.20-1.29x | Term: 10 mo</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-16 h-10 rounded-lg flex items-center justify-center text-white font-black text-xl" style="background: #eab308;">C</div>
                <div class="flex-1">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold" style="color: var(--text-primary);">Mid-Prime</span>
                    <span class="text-xs font-mono" style="color: var(--text-muted);">50-64 pts</span>
                  </div>
                  <div class="text-xs" style="color: var(--text-muted);">Factor: 1.30-1.39x | Term: 9 mo</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-16 h-10 rounded-lg flex items-center justify-center text-white font-black text-xl" style="background: #f97316;">D</div>
                <div class="flex-1">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold" style="color: var(--text-primary);">Elevated Risk</span>
                    <span class="text-xs font-mono" style="color: var(--text-muted);">35-49 pts</span>
                  </div>
                  <div class="text-xs" style="color: var(--text-muted);">Factor: 1.40-1.54x | Term: 6 mo</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-16 h-10 rounded-lg flex items-center justify-center text-white font-black text-xl" style="background: #ef4444;">E</div>
                <div class="flex-1">
                  <div class="flex justify-between items-center">
                    <span class="text-sm font-semibold" style="color: var(--text-primary);">High Risk</span>
                    <span class="text-xs font-mono" style="color: var(--text-muted);">0-34 pts</span>
                  </div>
                  <div class="text-xs" style="color: var(--text-muted);">Factor: 1.55-1.69x | Term: 4 mo</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Weight Distribution Chart -->
        <div class="rounded-2xl p-6 border mb-8" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
          <h3 class="text-lg font-bold mb-6" style="color: var(--text-primary);">Score Weight Distribution</h3>
          <div class="flex flex-col lg:flex-row items-center gap-8">
            <!-- Donut Chart -->
            <div class="relative w-64 h-64 flex-shrink-0">
              <svg viewBox="0 0 100 100" class="w-full h-full transform -rotate-90">
                <!-- Credit 30% - starts at 0 -->
                <circle cx="50" cy="50" r="40" fill="none" stroke="#3b82f6" stroke-width="16" 
                  stroke-dasharray="75.4 251.3" stroke-dashoffset="0"/>
                <!-- Behavior 30% - starts at 30% -->
                <circle cx="50" cy="50" r="40" fill="none" stroke="#8b5cf6" stroke-width="16" 
                  stroke-dasharray="75.4 251.3" stroke-dashoffset="-75.4"/>
                <!-- Revenue 20% - starts at 60% -->
                <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="16" 
                  stroke-dasharray="50.3 251.3" stroke-dashoffset="-150.8"/>
                <!-- Stability 10% - starts at 80% -->
                <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="16" 
                  stroke-dasharray="25.1 251.3" stroke-dashoffset="-201.1"/>
                <!-- Buffer 10% - starts at 90% -->
                <circle cx="50" cy="50" r="40" fill="none" stroke="#ec4899" stroke-width="16" 
                  stroke-dasharray="25.1 251.3" stroke-dashoffset="-226.2"/>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                  <div class="text-3xl font-black" style="color: var(--text-primary);">100</div>
                  <div class="text-xs font-semibold" style="color: var(--text-muted);">MAX POINTS</div>
                </div>
              </div>
            </div>
            
            <!-- Legend -->
            <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="w-4 h-4 rounded" style="background: #3b82f6;"></div>
                <div>
                  <div class="text-sm font-bold" style="color: var(--text-primary);">Credit Score</div>
                  <div class="text-xs" style="color: var(--text-muted);">30 points (30%)</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="w-4 h-4 rounded" style="background: #8b5cf6;"></div>
                <div>
                  <div class="text-sm font-bold" style="color: var(--text-primary);">Behavior</div>
                  <div class="text-xs" style="color: var(--text-muted);">30 points (30%)</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="w-4 h-4 rounded" style="background: #10b981;"></div>
                <div>
                  <div class="text-sm font-bold" style="color: var(--text-primary);">Revenue</div>
                  <div class="text-xs" style="color: var(--text-muted);">20 points (20%)</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="w-4 h-4 rounded" style="background: #f59e0b;"></div>
                <div>
                  <div class="text-sm font-bold" style="color: var(--text-primary);">Stability</div>
                  <div class="text-xs" style="color: var(--text-muted);">10 points (10%)</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-tertiary);">
                <div class="w-4 h-4 rounded" style="background: #ec4899;"></div>
                <div>
                  <div class="text-sm font-bold" style="color: var(--text-primary);">Buffer</div>
                  <div class="text-xs" style="color: var(--text-muted);">10 points (10%)</div>
                </div>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: #ef444420; border: 1px solid #ef444440;">
                <div class="w-4 h-4 rounded" style="background: #ef4444;"></div>
                <div>
                  <div class="text-sm font-bold" style="color: #ef4444;">Restricted Penalty</div>
                  <div class="text-xs" style="color: var(--text-muted);">-15 points</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Detailed Component Breakdown -->
        <div class="space-y-6 mb-8">
          <h3 class="text-lg font-bold" style="color: var(--text-primary);">Scoring Components Explained</h3>
          
          <!-- Credit Score Component -->
          <div class="rounded-2xl border overflow-hidden" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <div class="p-4 flex items-center gap-4" style="background: #3b82f615; border-bottom: 1px solid var(--border-secondary);">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #3b82f6;">
                <span class="text-white font-black text-lg">30</span>
              </div>
              <div class="flex-1">
                <h4 class="font-bold" style="color: var(--text-primary);">Credit Score (FICO)</h4>
                <p class="text-xs" style="color: var(--text-muted);">Personal credit quality indicator</p>
              </div>
              <div class="text-right">
                <div class="text-xs font-semibold" style="color: #3b82f6;">KNOCKOUT: &lt;500</div>
              </div>
            </div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
                  <div class="p-3 rounded-lg font-mono text-sm" style="background: var(--bg-tertiary); color: var(--text-primary);">
                    ((FICO - 500) / 300) x 30
                  </div>
                </div>
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Example</div>
                  <div class="p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                    FICO 680 = ((680-500)/300) x 30 = <strong style="color: var(--accent);">18 pts</strong>
                  </div>
                </div>
              </div>
              <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Score Curve</div>
              <div class="h-8 rounded-lg overflow-hidden flex" style="background: var(--bg-tertiary);">
                <div class="h-full flex items-center justify-center text-[10px] font-bold text-white" style="width: 16.7%; background: #ef4444;">500</div>
                <div class="h-full flex items-center justify-center text-[10px] font-bold text-white" style="width: 16.7%; background: #f97316;">550</div>
                <div class="h-full flex items-center justify-center text-[10px] font-bold text-white" style="width: 16.7%; background: #eab308;">600</div>
                <div class="h-full flex items-center justify-center text-[10px] font-bold text-white" style="width: 16.7%; background: #84cc16;">650</div>
                <div class="h-full flex items-center justify-center text-[10px] font-bold text-white" style="width: 16.7%; background: #22c55e;">700</div>
                <div class="h-full flex items-center justify-center text-[10px] font-bold text-white" style="width: 16.5%; background: #10b981;">800</div>
              </div>
              <div class="flex justify-between mt-1 text-[10px]" style="color: var(--text-muted);">
                <span>0 pts</span>
                <span>5 pts</span>
                <span>10 pts</span>
                <span>15 pts</span>
                <span>20 pts</span>
                <span>30 pts</span>
              </div>
            </div>
          </div>
          
          <!-- Behavior Component -->
          <div class="rounded-2xl border overflow-hidden" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <div class="p-4 flex items-center gap-4" style="background: #8b5cf615; border-bottom: 1px solid var(--border-secondary);">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #8b5cf6;">
                <span class="text-white font-black text-lg">30</span>
              </div>
              <div class="flex-1">
                <h4 class="font-bold" style="color: var(--text-primary);">Behavior (Risk Events)</h4>
                <p class="text-xs" style="color: var(--text-muted);">NSF/Overdrafts + Negative Balance Days</p>
              </div>
              <div class="text-right">
                <div class="text-xs font-semibold" style="color: #8b5cf6;">KNOCKOUT: &gt;10 events</div>
              </div>
            </div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
                  <div class="p-3 rounded-lg font-mono text-sm" style="background: var(--bg-tertiary); color: var(--text-primary);">
                    30 - (events x 3)
                  </div>
                </div>
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Events = NSF + Neg Days</div>
                  <div class="p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                    2 NSF + 1 neg day = 3 events = <strong style="color: var(--accent);">21 pts</strong>
                  </div>
                </div>
              </div>
              <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Points by Event Count</div>
              <div class="grid grid-cols-11 gap-1">
                ${[0,1,2,3,4,5,6,7,8,9,10].map(e => {
                  const pts = Math.max(0, 30 - (e * 3));
                  const color = pts >= 24 ? '#10b981' : pts >= 15 ? '#eab308' : pts >= 6 ? '#f97316' : '#ef4444';
                  return `<div class="text-center p-2 rounded" style="background: ${color}20;">
                    <div class="text-[10px] font-bold" style="color: ${color};">${e}</div>
                    <div class="text-xs font-black" style="color: var(--text-primary);">${pts}</div>
                  </div>`;
                }).join('')}
              </div>
              <div class="flex justify-between mt-1 text-[10px]" style="color: var(--text-muted);">
                <span>Events</span>
                <span>Points</span>
              </div>
            </div>
          </div>
          
          <!-- Revenue Component -->
          <div class="rounded-2xl border overflow-hidden" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <div class="p-4 flex items-center gap-4" style="background: #10b98115; border-bottom: 1px solid var(--border-secondary);">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #10b981;">
                <span class="text-white font-black text-lg">20</span>
              </div>
              <div class="flex-1">
                <h4 class="font-bold" style="color: var(--text-primary);">Revenue (Monthly Deposits)</h4>
                <p class="text-xs" style="color: var(--text-muted);">Business cash flow capacity</p>
              </div>
              <div class="text-right">
                <div class="text-xs font-semibold" style="color: #10b981;">KNOCKOUT: &lt;$7,500</div>
              </div>
            </div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
                  <div class="p-3 rounded-lg font-mono text-sm" style="background: var(--bg-tertiary); color: var(--text-primary);">
                    ((Rev - 7500) / 92500) x 20
                  </div>
                </div>
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Example</div>
                  <div class="p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                    $50K/mo = ((50000-7500)/92500) x 20 = <strong style="color: var(--accent);">9.2 pts</strong>
                  </div>
                </div>
              </div>
              <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Revenue Tiers</div>
              <div class="space-y-2">
                <div class="flex items-center gap-2">
                  <span class="text-xs w-20" style="color: var(--text-muted);">$7.5K</span>
                  <div class="flex-1 h-4 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                    <div class="h-full rounded-full" style="width: 0%; background: #10b981;"></div>
                  </div>
                  <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">0 pts</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs w-20" style="color: var(--text-muted);">$25K</span>
                  <div class="flex-1 h-4 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                    <div class="h-full rounded-full" style="width: 19%; background: #10b981;"></div>
                  </div>
                  <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">3.8 pts</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs w-20" style="color: var(--text-muted);">$50K</span>
                  <div class="flex-1 h-4 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                    <div class="h-full rounded-full" style="width: 46%; background: #10b981;"></div>
                  </div>
                  <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">9.2 pts</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs w-20" style="color: var(--text-muted);">$100K+</span>
                  <div class="flex-1 h-4 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                    <div class="h-full rounded-full" style="width: 100%; background: #10b981;"></div>
                  </div>
                  <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">20 pts</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Stability Component -->
          <div class="rounded-2xl border overflow-hidden" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <div class="p-4 flex items-center gap-4" style="background: #f59e0b15; border-bottom: 1px solid var(--border-secondary);">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #f59e0b;">
                <span class="text-white font-black text-lg">10</span>
              </div>
              <div class="flex-1">
                <h4 class="font-bold" style="color: var(--text-primary);">Stability (Time in Business)</h4>
                <p class="text-xs" style="color: var(--text-muted);">Business maturity and track record</p>
              </div>
            </div>
            <div class="p-4">
              <div class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Fixed Tier System</div>
              <div class="grid grid-cols-4 gap-3">
                <div class="text-center p-4 rounded-xl" style="background: #10b98120; border: 2px solid #10b981;">
                  <div class="text-2xl font-black" style="color: #10b981;">10</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">36+ mo</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">3+ years</div>
                </div>
                <div class="text-center p-4 rounded-xl" style="background: #22c55e20; border: 2px solid #22c55e;">
                  <div class="text-2xl font-black" style="color: #22c55e;">7</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">24-35 mo</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">2-3 years</div>
                </div>
                <div class="text-center p-4 rounded-xl" style="background: #eab30820; border: 2px solid #eab308;">
                  <div class="text-2xl font-black" style="color: #eab308;">4</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">12-23 mo</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">1-2 years</div>
                </div>
                <div class="text-center p-4 rounded-xl" style="background: #ef444420; border: 2px solid #ef4444;">
                  <div class="text-2xl font-black" style="color: #ef4444;">1</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">&lt;12 mo</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">Startup</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Buffer Component -->
          <div class="rounded-2xl border overflow-hidden" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <div class="p-4 flex items-center gap-4" style="background: #ec489915; border-bottom: 1px solid var(--border-secondary);">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: #ec4899;">
                <span class="text-white font-black text-lg">10</span>
              </div>
              <div class="flex-1">
                <h4 class="font-bold" style="color: var(--text-primary);">Buffer (ADB / Revenue Ratio)</h4>
                <p class="text-xs" style="color: var(--text-muted);">Cash reserves relative to volume</p>
              </div>
            </div>
            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
                  <div class="p-3 rounded-lg font-mono text-sm" style="background: var(--bg-tertiary); color: var(--text-primary);">
                    Avg Daily Balance / Monthly Revenue
                  </div>
                </div>
                <div>
                  <div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Example</div>
                  <div class="p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                    $8K ADB / $50K Rev = 16% = <strong style="color: var(--accent);">10 pts</strong>
                  </div>
                </div>
              </div>
              <div class="text-xs font-semibold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Buffer Thresholds</div>
              <div class="grid grid-cols-3 gap-3">
                <div class="text-center p-4 rounded-xl" style="background: #10b98120; border: 2px solid #10b981;">
                  <div class="text-2xl font-black" style="color: #10b981;">10</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">10%+</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">Strong reserves</div>
                </div>
                <div class="text-center p-4 rounded-xl" style="background: #eab30820; border: 2px solid #eab308;">
                  <div class="text-2xl font-black" style="color: #eab308;">5</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">5-9.9%</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">Adequate</div>
                </div>
                <div class="text-center p-4 rounded-xl" style="background: #ef444420; border: 2px solid #ef4444;">
                  <div class="text-2xl font-black" style="color: #ef4444;">0</div>
                  <div class="text-xs font-bold mt-1" style="color: var(--text-primary);">&lt;5%</div>
                  <div class="text-[10px]" style="color: var(--text-muted);">Thin margin</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Safety Valves & Knockouts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Knockouts -->
          <div class="rounded-2xl p-6 border" style="background: #ef444410; border-color: #ef444440;">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: #ef4444;">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                </svg>
              </div>
              <h3 class="text-lg font-bold" style="color: #ef4444;">Automatic Declines</h3>
            </div>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">
              These criteria result in immediate decline regardless of other factors:
            </p>
            <div class="space-y-2">
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #ef4444;"></div>
                <span class="text-sm" style="color: var(--text-primary);">FICO score below 500</span>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #ef4444;"></div>
                <span class="text-sm" style="color: var(--text-primary);">Monthly revenue below $7,500</span>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #ef4444;"></div>
                <span class="text-sm" style="color: var(--text-primary);">More than 10 risk events (NSF + neg days)</span>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #ef4444;"></div>
                <span class="text-sm" style="color: var(--text-primary);">Qualified amount below $10,000 minimum</span>
              </div>
            </div>
          </div>
          
          <!-- Safety Valves -->
          <div class="rounded-2xl p-6 border" style="background: #f59e0b10; border-color: #f59e0b40;">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: #f59e0b;">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
              </div>
              <h3 class="text-lg font-bold" style="color: #f59e0b;">Safety Valves</h3>
            </div>
            <p class="text-sm mb-4" style="color: var(--text-secondary);">
              Credit score triggers that force tier downgrades even if score qualifies higher:
            </p>
            <div class="space-y-2">
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #f59e0b;"></div>
                <span class="text-sm" style="color: var(--text-primary);">FICO &lt; 600 = Maximum Tier C</span>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #f59e0b;"></div>
                <span class="text-sm" style="color: var(--text-primary);">FICO &lt; 550 = Maximum Tier D</span>
              </div>
              <div class="flex items-center gap-3 p-3 rounded-lg" style="background: var(--bg-card);">
                <div class="w-2 h-2 rounded-full" style="background: #f59e0b;"></div>
                <span class="text-sm" style="color: var(--text-primary);">FICO &lt; 520 = Forced to Tier E</span>
              </div>
            </div>
            <p class="text-xs mt-4" style="color: var(--text-muted);">
              These valves prevent high-risk credit profiles from qualifying for premium pricing regardless of strong business metrics.
            </p>
          </div>
        </div>
        
        <!-- Triple Constraint Sizing -->
        <div class="rounded-2xl p-6 border mb-8" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: var(--accent-glow);">
              <svg class="w-5 h-5" style="color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-bold" style="color: var(--text-primary);">Triple-Constraint Sizing</h3>
              <p class="text-xs" style="color: var(--text-muted);">How approved amounts are calculated</p>
            </div>
          </div>
          
          <p class="text-sm mb-6" style="color: var(--text-secondary);">
            The final funding amount is the <strong>minimum</strong> of three independent caps. This ensures the merchant can comfortably service the advance without cash flow strain.
          </p>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="p-4 rounded-xl text-center" style="background: var(--bg-tertiary);">
              <div class="text-3xl font-black mb-2" style="color: var(--accent);">LTV</div>
              <div class="text-sm font-semibold mb-1" style="color: var(--text-primary);">Revenue Cap</div>
              <div class="text-xs" style="color: var(--text-muted);">Monthly Revenue x LTV Multiple</div>
              <div class="text-xs font-mono mt-2 p-2 rounded" style="background: var(--bg-card); color: var(--text-secondary);">
                Tier A: 1.25x | Tier E: 0.60x
              </div>
            </div>
            <div class="p-4 rounded-xl text-center" style="background: var(--bg-tertiary);">
              <div class="text-3xl font-black mb-2" style="color: var(--accent);">ADB</div>
              <div class="text-sm font-semibold mb-1" style="color: var(--text-primary);">Balance Cap</div>
              <div class="text-xs" style="color: var(--text-muted);">Avg Daily Balance x Multiplier</div>
              <div class="text-xs font-mono mt-2 p-2 rounded" style="background: var(--bg-card); color: var(--text-secondary);">
                Tier A: 6.0x | Tier E: 1.5x
              </div>
            </div>
            <div class="p-4 rounded-xl text-center" style="background: var(--bg-tertiary);">
              <div class="text-3xl font-black mb-2" style="color: var(--accent);">DCF</div>
              <div class="text-sm font-semibold mb-1" style="color: var(--text-primary);">Capacity Cap</div>
              <div class="text-xs" style="color: var(--text-muted);">Max Payback / Factor Rate</div>
              <div class="text-xs font-mono mt-2 p-2 rounded" style="background: var(--bg-card); color: var(--text-secondary);">
                Based on holdback limits
              </div>
            </div>
          </div>
          
          <div class="p-4 rounded-xl" style="background: var(--accent-glow);">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4" style="color: var(--accent);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="text-xs font-bold uppercase tracking-wider" style="color: var(--accent);">Example Calculation</span>
            </div>
            <p class="text-sm" style="color: var(--text-secondary);">
              For a Tier B merchant with $50K monthly revenue and $8K ADB:<br>
              <strong>Revenue Cap:</strong> $50K x 1.00 = $50,000<br>
              <strong>Balance Cap:</strong> $8K x 4.0 = $32,000<br>
              <strong>Capacity Cap:</strong> Based on 15% holdback over 10 months = ~$38,000<br>
              <strong style="color: var(--accent);">Approved Amount: $32,000</strong> (lowest of the three)
            </p>
          </div>
        </div>
        
        <!-- Footer CTA -->
        <div class="rounded-2xl p-6 text-center" style="background: linear-gradient(135deg, var(--accent-glow) 0%, transparent 100%); border: 1px solid rgba(var(--accent-rgb), 0.3);">
          <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">Ready to Test the Model?</h3>
          <p class="text-sm mb-4" style="color: var(--text-secondary);">
            Use the Pre-Qualify calculator to see ABLESCORE scoring in action with live inputs.
          </p>
          <button onclick="switchTool('prequal')" class="px-6 py-3 rounded-xl font-bold text-white transition-all hover:scale-105" style="background: var(--accent);">
            Open Pre-Qualify Calculator
          </button>
        </div>
      `;
    }
    
    // ============================================
    // DEBT SCHEDULE REPORT
    // ============================================
    function renderDebtSchedule(container) {
      const s = reportState.debtSchedule;
      const totalOriginal = s.debts.reduce((sum, d) => sum + (parseFloat(d.originalAmount) || 0), 0);
      const totalBalance = s.debts.reduce((sum, d) => sum + (parseFloat(d.currentBalance) || 0), 0);
      const totalMonthly = s.debts.reduce((sum, d) => sum + (parseFloat(d.monthlyPayment) || 0), 0);
      
      const isRecipient = reportViewMode === 'recipient';
      const modeIndicator = isRecipient ? `
        <div class="mb-4 p-3 rounded-lg flex items-center gap-3" style="background: #3b82f620; border: 1px solid #3b82f640;">
          <svg class="w-5 h-5" fill="none" stroke="#3b82f6" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          <span class="text-sm font-semibold" style="color: #3b82f6;">Shared with you — Fill in and download when complete</span>
        </div>
      ` : '';
      
      container.innerHTML = `
        ${modeIndicator}
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="section-indicator"></div>
            <h3 class="section-title">Business Debt Schedule</h3>
          </div>
          <div class="flex gap-2">
            <button onclick="addDebtRow()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--accent); color: white;">
              + Add Debt
            </button>
            <button onclick="downloadReport('debtschedule')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Download
              </span>
            </button>
            ${!isRecipient ? `
            <button onclick="shareReport('debtschedule')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                Share
              </span>
            </button>
            <button onclick="openReportsDashboard()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Tracking
              </span>
            </button>
            ` : `
            <button onclick="submitReport('debtschedule')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Submit Report
              </span>
            </button>
            `}
          </div>
        </div>
        
        <!-- Header Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">Business Name</label>
            <input type="text" value="${s.businessName}" onchange="reportState.debtSchedule.businessName=this.value;trackReportEdit('debtschedule')" placeholder="Enter business name" class="w-full p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">Prepared Date</label>
            <input type="date" value="${s.preparedDate}" onchange="reportState.debtSchedule.preparedDate=this.value;trackReportEdit('debtschedule')" class="w-full p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
        </div>
        
        <!-- Table -->
        <div class="overflow-x-auto rounded-lg" style="border: 1px solid var(--border-primary);">
          <table class="w-full text-sm">
            <thead>
              <tr style="background: var(--bg-tertiary);">
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Creditor</th>
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Type</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Original Amount</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Current Balance</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Rate %</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Monthly Pmt</th>
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Maturity</th>
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Collateral</th>
                <th class="p-3 w-10"></th>
              </tr>
            </thead>
            <tbody>
              ${s.debts.map((d, i) => `
                <tr style="border-top: 1px solid var(--border-primary);">
                  <td class="p-2"><input type="text" value="${d.creditor}" onchange="updateDebtRow(${i},'creditor',this.value)" placeholder="Creditor name" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2">
                    <select onchange="updateDebtRow(${i},'type',this.value)" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);">
                      <option ${d.type==='Term Loan'?'selected':''}>Term Loan</option>
                      <option ${d.type==='Line of Credit'?'selected':''}>Line of Credit</option>
                      <option ${d.type==='MCA'?'selected':''}>MCA</option>
                      <option ${d.type==='SBA Loan'?'selected':''}>SBA Loan</option>
                      <option ${d.type==='Equipment'?'selected':''}>Equipment</option>
                      <option ${d.type==='Real Estate'?'selected':''}>Real Estate</option>
                      <option ${d.type==='Credit Card'?'selected':''}>Credit Card</option>
                      <option ${d.type==='Other'?'selected':''}>Other</option>
                    </select>
                  </td>
                  <td class="p-2"><input type="number" value="${d.originalAmount||''}" onchange="updateDebtRow(${i},'originalAmount',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${d.currentBalance||''}" onchange="updateDebtRow(${i},'currentBalance',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" step="0.01" value="${d.interestRate||''}" onchange="updateDebtRow(${i},'interestRate',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${d.monthlyPayment||''}" onchange="updateDebtRow(${i},'monthlyPayment',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="date" value="${d.maturityDate}" onchange="updateDebtRow(${i},'maturityDate',this.value)" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="text" value="${d.collateral}" onchange="updateDebtRow(${i},'collateral',this.value)" placeholder="Collateral" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2">
                    <button onclick="removeDebtRow(${i})" class="p-1.5 rounded hover:bg-red-500/20 transition-colors" style="color: #ef4444;">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="background: var(--bg-tertiary); border-top: 2px solid var(--border-primary);">
                <td colspan="2" class="p-3 font-bold" style="color: var(--text-primary);">TOTALS</td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totalOriginal)}</td>
                <td class="p-3 text-right font-bold" style="color: var(--accent);">${formatCurrency(totalBalance)}</td>
                <td class="p-3"></td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totalMonthly)}</td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total Debts</div>
            <div class="text-2xl font-bold" style="color: var(--text-primary);">${s.debts.length}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total Balance</div>
            <div class="text-2xl font-bold" style="color: var(--accent);">${formatCurrency(totalBalance)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Monthly Payments</div>
            <div class="text-2xl font-bold" style="color: var(--text-primary);">${formatCurrency(totalMonthly)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Annual Debt Service</div>
            <div class="text-2xl font-bold" style="color: var(--text-primary);">${formatCurrency(totalMonthly * 12)}</div>
          </div>
        </div>`;
    }
    
    function addDebtRow() {
      const newId = Math.max(...reportState.debtSchedule.debts.map(d=>d.id), 0) + 1;
      reportState.debtSchedule.debts.push({ id: newId, creditor: '', type: 'Term Loan', originalAmount: 0, currentBalance: 0, interestRate: 0, monthlyPayment: 0, maturityDate: '', collateral: '' });
      renderDebtSchedule(document.getElementById('debtScheduleCard'));
    }
    
    function updateDebtRow(index, field, value) {
      reportState.debtSchedule.debts[index][field] = value;
      renderDebtSchedule(document.getElementById('debtScheduleCard'));
    }
    
    function removeDebtRow(index) {
      if (reportState.debtSchedule.debts.length > 1) {
        reportState.debtSchedule.debts.splice(index, 1);
        renderDebtSchedule(document.getElementById('debtScheduleCard'));
      }
    }
    
    // ============================================
    // A/R AGING REPORT
    // ============================================
    function renderARaging(container) {
      const s = reportState.arAging;
      const totals = s.receivables.reduce((acc, r) => ({
        amount: acc.amount + (parseFloat(r.amount) || 0),
        current: acc.current + (parseFloat(r.current) || 0),
        days30: acc.days30 + (parseFloat(r.days30) || 0),
        days60: acc.days60 + (parseFloat(r.days60) || 0),
        days90: acc.days90 + (parseFloat(r.days90) || 0),
        over90: acc.over90 + (parseFloat(r.over90) || 0)
      }), { amount: 0, current: 0, days30: 0, days60: 0, days90: 0, over90: 0 });
      
      const pastDue = totals.days30 + totals.days60 + totals.days90 + totals.over90;
      const pastDuePct = totals.amount > 0 ? Math.round((pastDue / totals.amount) * 100) : 0;
      
      const isRecipient = reportViewMode === 'recipient';
      const modeIndicator = isRecipient ? `
        <div class="mb-4 p-3 rounded-lg flex items-center gap-3" style="background: #3b82f620; border: 1px solid #3b82f640;">
          <svg class="w-5 h-5" fill="none" stroke="#3b82f6" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          <span class="text-sm font-semibold" style="color: #3b82f6;">Shared with you — Fill in and download when complete</span>
        </div>
      ` : '';
      
      container.innerHTML = `
        ${modeIndicator}
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="section-indicator"></div>
            <h3 class="section-title">Accounts Receivable Aging Summary</h3>
          </div>
          <div class="flex gap-2">
            <button onclick="addARRow()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--accent); color: white;">
              + Add Invoice
            </button>
            <button onclick="downloadReport('araging')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Download
              </span>
            </button>
            ${!isRecipient ? `
            <button onclick="shareReport('araging')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                Share
              </span>
            </button>
            <button onclick="openReportsDashboard()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Tracking
              </span>
            </button>
            ` : `
            <button onclick="submitReport('araging')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Submit Report
              </span>
            </button>
            `}
          </div>
        </div>
        
        <!-- Header Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">Business Name</label>
            <input type="text" value="${s.businessName}" onchange="reportState.arAging.businessName=this.value;trackReportEdit('araging')" placeholder="Enter business name" class="w-full p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">As Of Date</label>
            <input type="date" value="${s.asOfDate}" onchange="reportState.arAging.asOfDate=this.value;trackReportEdit('araging')" class="w-full p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
        </div>
        
        <!-- Table -->
        <div class="overflow-x-auto rounded-lg" style="border: 1px solid var(--border-primary);">
          <table class="w-full text-sm">
            <thead>
              <tr style="background: var(--bg-tertiary);">
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Customer</th>
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Invoice #</th>
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Date</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Total</th>
                <th class="p-3 text-right font-semibold" style="color: #10b981;">Current</th>
                <th class="p-3 text-right font-semibold" style="color: #f59e0b;">1-30</th>
                <th class="p-3 text-right font-semibold" style="color: #f97316;">31-60</th>
                <th class="p-3 text-right font-semibold" style="color: #ef4444;">61-90</th>
                <th class="p-3 text-right font-semibold" style="color: #dc2626;">90+</th>
                <th class="p-3 w-10"></th>
              </tr>
            </thead>
            <tbody>
              ${s.receivables.map((r, i) => `
                <tr style="border-top: 1px solid var(--border-primary);">
                  <td class="p-2"><input type="text" value="${r.customer}" onchange="updateARRow(${i},'customer',this.value)" placeholder="Customer" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="text" value="${r.invoiceNo}" onchange="updateARRow(${i},'invoiceNo',this.value)" placeholder="INV-001" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="date" value="${r.invoiceDate}" onchange="updateARRow(${i},'invoiceDate',this.value)" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${r.amount||''}" onchange="updateARRow(${i},'amount',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${r.current||''}" onchange="updateARRow(${i},'current',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: #10b981;"></td>
                  <td class="p-2"><input type="number" value="${r.days30||''}" onchange="updateARRow(${i},'days30',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: #f59e0b;"></td>
                  <td class="p-2"><input type="number" value="${r.days60||''}" onchange="updateARRow(${i},'days60',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: #f97316;"></td>
                  <td class="p-2"><input type="number" value="${r.days90||''}" onchange="updateARRow(${i},'days90',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: #ef4444;"></td>
                  <td class="p-2"><input type="number" value="${r.over90||''}" onchange="updateARRow(${i},'over90',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: #dc2626;"></td>
                  <td class="p-2">
                    <button onclick="removeARRow(${i})" class="p-1.5 rounded hover:bg-red-500/20 transition-colors" style="color: #ef4444;">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="background: var(--bg-tertiary); border-top: 2px solid var(--border-primary);">
                <td colspan="3" class="p-3 font-bold" style="color: var(--text-primary);">TOTALS</td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totals.amount)}</td>
                <td class="p-3 text-right font-bold" style="color: #10b981;">${formatCurrency(totals.current)}</td>
                <td class="p-3 text-right font-bold" style="color: #f59e0b;">${formatCurrency(totals.days30)}</td>
                <td class="p-3 text-right font-bold" style="color: #f97316;">${formatCurrency(totals.days60)}</td>
                <td class="p-3 text-right font-bold" style="color: #ef4444;">${formatCurrency(totals.days90)}</td>
                <td class="p-3 text-right font-bold" style="color: #dc2626;">${formatCurrency(totals.over90)}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total A/R</div>
            <div class="text-2xl font-bold" style="color: var(--accent);">${formatCurrency(totals.amount)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Current</div>
            <div class="text-2xl font-bold" style="color: #10b981;">${formatCurrency(totals.current)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Past Due</div>
            <div class="text-2xl font-bold" style="color: #ef4444;">${formatCurrency(pastDue)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Past Due %</div>
            <div class="text-2xl font-bold" style="color: ${pastDuePct > 30 ? '#ef4444' : pastDuePct > 15 ? '#f59e0b' : '#10b981'};">${pastDuePct}%</div>
          </div>
        </div>`;
    }
    
    function addARRow() {
      const newId = Math.max(...reportState.arAging.receivables.map(r=>r.id), 0) + 1;
      reportState.arAging.receivables.push({ id: newId, customer: '', invoiceNo: '', invoiceDate: '', amount: 0, current: 0, days30: 0, days60: 0, days90: 0, over90: 0 });
      renderARaging(document.getElementById('arAgingCard'));
    }
    
    function updateARRow(index, field, value) {
      reportState.arAging.receivables[index][field] = value;
      renderARaging(document.getElementById('arAgingCard'));
    }
    
    function removeARRow(index) {
      if (reportState.arAging.receivables.length > 1) {
        reportState.arAging.receivables.splice(index, 1);
        renderARaging(document.getElementById('arAgingCard'));
      }
    }
    
    // ============================================
    // WIP (WORK IN PROGRESS) REPORT
    // ============================================
    function renderWIP(container) {
      const s = reportState.wip;
      const totals = s.projects.reduce((acc, p) => ({
        contractAmount: acc.contractAmount + (parseFloat(p.contractAmount) || 0),
        billedToDate: acc.billedToDate + (parseFloat(p.billedToDate) || 0),
        costsToDate: acc.costsToDate + (parseFloat(p.costsToDate) || 0),
        estTotalCosts: acc.estTotalCosts + (parseFloat(p.estTotalCosts) || 0)
      }), { contractAmount: 0, billedToDate: 0, costsToDate: 0, estTotalCosts: 0 });
      
      const unbilled = totals.contractAmount - totals.billedToDate;
      const grossProfit = totals.contractAmount - totals.estTotalCosts;
      const marginPct = totals.contractAmount > 0 ? Math.round((grossProfit / totals.contractAmount) * 100) : 0;
      
      const isRecipient = reportViewMode === 'recipient';
      const modeIndicator = isRecipient ? `
        <div class="mb-4 p-3 rounded-lg flex items-center gap-3" style="background: #3b82f620; border: 1px solid #3b82f640;">
          <svg class="w-5 h-5" fill="none" stroke="#3b82f6" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          <span class="text-sm font-semibold" style="color: #3b82f6;">Shared with you — Fill in and download when complete</span>
        </div>
      ` : '';
      
      container.innerHTML = `
        ${modeIndicator}
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="section-indicator"></div>
            <h3 class="section-title">Work in Progress (WIP) Report</h3>
          </div>
          <div class="flex gap-2">
            <button onclick="addWIPRow()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--accent); color: white;">
              + Add Project
            </button>
            <button onclick="downloadReport('wip')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                Download
              </span>
            </button>
            ${!isRecipient ? `
            <button onclick="shareReport('wip')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                Share
              </span>
            </button>
            <button onclick="openReportsDashboard()" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Tracking
              </span>
            </button>
            ` : `
            <button onclick="submitReport('wip')" class="px-4 py-2 rounded-lg text-sm font-semibold transition-all" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
              <span class="flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Submit Report
              </span>
            </button>
            `}
          </div>
        </div>
        
        <!-- Header Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">Business Name</label>
            <input type="text" value="${s.businessName}" onchange="reportState.wip.businessName=this.value;trackReportEdit('wip')" placeholder="Enter business name" class="w-full p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wider block mb-2" style="color: var(--text-muted);">As Of Date</label>
            <input type="date" value="${s.asOfDate}" onchange="reportState.wip.asOfDate=this.value;trackReportEdit('wip')" class="w-full p-3 rounded-lg text-sm" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
        </div>
        
        <!-- Table -->
        <div class="overflow-x-auto rounded-lg" style="border: 1px solid var(--border-primary);">
          <table class="w-full text-sm">
            <thead>
              <tr style="background: var(--bg-tertiary);">
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Project Name</th>
                <th class="p-3 text-left font-semibold" style="color: var(--text-muted);">Customer</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Contract Amt</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Billed to Date</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Costs to Date</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Est. Total Costs</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">% Complete</th>
                <th class="p-3 text-right font-semibold" style="color: var(--text-muted);">Over/Under</th>
                <th class="p-3 w-10"></th>
              </tr>
            </thead>
            <tbody>
              ${s.projects.map((p, i) => {
                const estTotalCosts = parseFloat(p.estTotalCosts) || 0;
                const costsToDate = parseFloat(p.costsToDate) || 0;
                const contractAmount = parseFloat(p.contractAmount) || 0;
                const billedToDate = parseFloat(p.billedToDate) || 0;
                const percentComplete = parseFloat(p.percentComplete) || 0;
                const earnedRevenue = contractAmount * (percentComplete / 100);
                const overUnder = billedToDate - earnedRevenue;
                return `
                <tr style="border-top: 1px solid var(--border-primary);">
                  <td class="p-2"><input type="text" value="${p.projectName}" onchange="updateWIPRow(${i},'projectName',this.value)" placeholder="Project name" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="text" value="${p.customer}" onchange="updateWIPRow(${i},'customer',this.value)" placeholder="Customer" class="w-full p-2 rounded text-sm" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${p.contractAmount||''}" onchange="updateWIPRow(${i},'contractAmount',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${p.billedToDate||''}" onchange="updateWIPRow(${i},'billedToDate',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${p.costsToDate||''}" onchange="updateWIPRow(${i},'costsToDate',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" value="${p.estTotalCosts||''}" onchange="updateWIPRow(${i},'estTotalCosts',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2"><input type="number" min="0" max="100" value="${p.percentComplete||''}" onchange="updateWIPRow(${i},'percentComplete',this.value)" placeholder="0" class="w-full p-2 rounded text-sm text-right" style="background: var(--bg-card); border: 1px solid var(--border-secondary); color: var(--text-primary);"></td>
                  <td class="p-2 text-right font-semibold" style="color: ${overUnder >= 0 ? '#10b981' : '#ef4444'};">${formatCurrency(overUnder)}</td>
                  <td class="p-2">
                    <button onclick="removeWIPRow(${i})" class="p-1.5 rounded hover:bg-red-500/20 transition-colors" style="color: #ef4444;">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                  </td>
                </tr>
              `}).join('')}
            </tbody>
            <tfoot>
              <tr style="background: var(--bg-tertiary); border-top: 2px solid var(--border-primary);">
                <td colspan="2" class="p-3 font-bold" style="color: var(--text-primary);">TOTALS</td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totals.contractAmount)}</td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totals.billedToDate)}</td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totals.costsToDate)}</td>
                <td class="p-3 text-right font-bold" style="color: var(--text-primary);">${formatCurrency(totals.estTotalCosts)}</td>
                <td colspan="3"></td>
              </tr>
            </tfoot>
          </table>
        </div>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Total Contracts</div>
            <div class="text-2xl font-bold" style="color: var(--accent);">${formatCurrency(totals.contractAmount)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Unbilled</div>
            <div class="text-2xl font-bold" style="color: #f59e0b;">${formatCurrency(unbilled)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Est. Gross Profit</div>
            <div class="text-2xl font-bold" style="color: #10b981;">${formatCurrency(grossProfit)}</div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-tertiary); border: 1px solid var(--border-primary);">
            <div class="text-xs font-semibold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Gross Margin</div>
            <div class="text-2xl font-bold" style="color: ${marginPct > 20 ? '#10b981' : marginPct > 10 ? '#f59e0b' : '#ef4444'};">${marginPct}%</div>
          </div>
        </div>`;
    }
    
    function addWIPRow() {
      const newId = Math.max(...reportState.wip.projects.map(p=>p.id), 0) + 1;
      reportState.wip.projects.push({ id: newId, projectName: '', customer: '', contractAmount: 0, billedToDate: 0, costsToDate: 0, estTotalCosts: 0, percentComplete: 0 });
      renderWIP(document.getElementById('wipCard'));
    }
    
    function updateWIPRow(index, field, value) {
      reportState.wip.projects[index][field] = value;
      renderWIP(document.getElementById('wipCard'));
    }
    
    function removeWIPRow(index) {
      if (reportState.wip.projects.length > 1) {
        reportState.wip.projects.splice(index, 1);
        renderWIP(document.getElementById('wipCard'));
      }
    }
    
    // Share Report Function
    function shareReport(type) {
      const data = type === 'debtschedule' ? reportState.debtSchedule : 
                   type === 'araging' ? reportState.arAging : reportState.wip;
      
      // Generate unique report ID
      const reportId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      
      // Compress data with LZString
      const encoded = LZString.compressToEncodedURIComponent(JSON.stringify(data));
      const shareUrl = window.location.origin + window.location.pathname + '?report=' + type + '&rid=' + reportId + '&rd=' + encoded;
      
      // Save to tracking dashboard
      saveReportToDashboard(type, data, shareUrl);
      
      // Show share modal
      showReportShareModal(type, shareUrl, reportId);
    }
    
    function showReportShareModal(type, url, reportId) {
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      const modal = document.createElement('div');
      modal.id = 'reportShareModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
      modal.style.cssText = 'background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);';
      modal.innerHTML = `
        <div class="w-full max-w-md rounded-2xl p-6" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold" style="color: var(--text-primary);">Share ${reportNames[type]}</h3>
            <button onclick="this.closest('#reportShareModal').remove()" class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--bg-tertiary); color: var(--text-muted);">✕</button>
          </div>
          <div class="mb-4 p-3 rounded-lg" style="background: var(--bg-tertiary);">
            <div class="text-xs font-semibold mb-2" style="color: var(--text-muted);">Share Link</div>
            <input type="text" readonly value="${url}" id="reportShareUrl" class="w-full p-2 rounded-lg text-xs" style="background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary);">
          </div>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <button onclick="copyReportLink()" class="p-3 rounded-xl font-semibold text-sm" style="background: var(--accent); color: white;">
              <div class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                Copy Link
              </div>
            </button>
            <button onclick="emailReportLink('${type}')" class="p-3 rounded-xl font-semibold text-sm" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary);">
              <div class="flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Email
              </div>
            </button>
          </div>
          <div class="text-xs text-center" style="color: var(--text-muted);">
            Recipients can view, fill in, and download. You'll see when they open it.
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    }
    
    function copyReportLink() {
      const url = document.getElementById('reportShareUrl').value;
      navigator.clipboard.writeText(url).then(() => {
        showNotification('Link copied! Track opens in the dashboard.', 'success');
        document.getElementById('reportShareModal')?.remove();
      }).catch(() => prompt('Copy this link:', url));
    }
    
    function emailReportLink(type) {
      const url = document.getElementById('reportShareUrl').value;
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      const subject = encodeURIComponent(`Please complete: ${reportNames[type]}`);
      const body = encodeURIComponent(`Hi,\n\nPlease review and fill in the attached ${reportNames[type]}:\n\n${url}\n\nYou can edit directly in your browser and download when complete.\n\nThank you!`);
      window.open(`mailto:?subject=${subject}&body=${body}`);
      document.getElementById('reportShareModal')?.remove();
    }
    
    function downloadReport(type) {
      // Track download
      if (currentReportId) {
        updateReportTrackingById(currentReportId, 'downloaded', reportViewMode);
      }
      
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      const data = type === 'debtschedule' ? reportState.debtSchedule : 
                   type === 'araging' ? reportState.arAging : reportState.wip;
      
      // Generate printable HTML
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${reportNames[type]} - ${data.businessName || 'Report'}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1f2937; }
            h1 { font-size: 24px; margin-bottom: 8px; }
            .meta { color: #6b7280; font-size: 14px; margin-bottom: 24px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
            th, td { border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; font-size: 13px; }
            th { background: #f9fafb; font-weight: 600; }
            .total-row { background: #f3f4f6; font-weight: 600; }
            .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 24px; }
            .summary-card { background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center; }
            .summary-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
            .summary-value { font-size: 20px; font-weight: 700; color: #111827; margin-top: 4px; }
            @media print { body { padding: 20px; } }
          </style>
        </head>
        <body>
          <h1>${reportNames[type]}</h1>
          <div class="meta">${data.businessName || 'Business Name'} • ${data.preparedDate || data.asOfDate || new Date().toLocaleDateString()}</div>
          ${generateReportHTML(type, data)}
          <script>window.print();<\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }
    
    function generateReportHTML(type, data) {
      if (type === 'debtschedule') {
        const totals = data.debts.reduce((acc, d) => ({
          original: acc.original + (parseFloat(d.originalAmount) || 0),
          current: acc.current + (parseFloat(d.currentBalance) || 0),
          monthly: acc.monthly + (parseFloat(d.monthlyPayment) || 0)
        }), { original: 0, current: 0, monthly: 0 });
        
        return `
          <table>
            <thead>
              <tr><th>Creditor</th><th>Type</th><th>Original</th><th>Balance</th><th>Rate</th><th>Payment</th><th>Maturity</th><th>Collateral</th></tr>
            </thead>
            <tbody>
              ${data.debts.map(d => `
                <tr>
                  <td>${d.creditor || '-'}</td>
                  <td>${d.type || '-'}</td>
                  <td>$${(parseFloat(d.originalAmount) || 0).toLocaleString()}</td>
                  <td>$${(parseFloat(d.currentBalance) || 0).toLocaleString()}</td>
                  <td>${d.interestRate || 0}%</td>
                  <td>$${(parseFloat(d.monthlyPayment) || 0).toLocaleString()}</td>
                  <td>${d.maturityDate || '-'}</td>
                  <td>${d.collateral || '-'}</td>
                </tr>
              `).join('')}
              <tr class="total-row">
                <td colspan="2">TOTALS</td>
                <td>$${totals.original.toLocaleString()}</td>
                <td>$${totals.current.toLocaleString()}</td>
                <td></td>
                <td>$${totals.monthly.toLocaleString()}</td>
                <td colspan="2"></td>
              </tr>
            </tbody>
          </table>
          <div class="summary">
            <div class="summary-card"><div class="summary-label">Total Debts</div><div class="summary-value">${data.debts.length}</div></div>
            <div class="summary-card"><div class="summary-label">Total Balance</div><div class="summary-value">$${totals.current.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Monthly Payments</div><div class="summary-value">$${totals.monthly.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Annual Debt Service</div><div class="summary-value">$${(totals.monthly * 12).toLocaleString()}</div></div>
          </div>
        `;
      } else if (type === 'araging') {
        const totals = data.receivables.reduce((acc, r) => ({
          total: acc.total + (parseFloat(r.amount) || 0),
          current: acc.current + (parseFloat(r.current) || 0),
          days30: acc.days30 + (parseFloat(r.days30) || 0),
          days60: acc.days60 + (parseFloat(r.days60) || 0),
          days90: acc.days90 + (parseFloat(r.days90) || 0),
          over90: acc.over90 + (parseFloat(r.over90) || 0)
        }), { total: 0, current: 0, days30: 0, days60: 0, days90: 0, over90: 0 });
        const pastDue = totals.days30 + totals.days60 + totals.days90 + totals.over90;
        const pastDuePct = totals.total > 0 ? Math.round((pastDue / totals.total) * 100) : 0;
        
        return `
          <table>
            <thead>
              <tr><th>Customer</th><th>Invoice #</th><th>Date</th><th>Total</th><th>Current</th><th>1-30</th><th>31-60</th><th>61-90</th><th>90+</th></tr>
            </thead>
            <tbody>
              ${data.receivables.map(r => `
                <tr>
                  <td>${r.customer || '-'}</td>
                  <td>${r.invoiceNo || '-'}</td>
                  <td>${r.invoiceDate || '-'}</td>
                  <td>$${(parseFloat(r.amount) || 0).toLocaleString()}</td>
                  <td>$${(parseFloat(r.current) || 0).toLocaleString()}</td>
                  <td>$${(parseFloat(r.days30) || 0).toLocaleString()}</td>
                  <td>$${(parseFloat(r.days60) || 0).toLocaleString()}</td>
                  <td>$${(parseFloat(r.days90) || 0).toLocaleString()}</td>
                  <td>$${(parseFloat(r.over90) || 0).toLocaleString()}</td>
                </tr>
              `).join('')}
              <tr class="total-row">
                <td colspan="3">TOTALS</td>
                <td>$${totals.total.toLocaleString()}</td>
                <td>$${totals.current.toLocaleString()}</td>
                <td>$${totals.days30.toLocaleString()}</td>
                <td>$${totals.days60.toLocaleString()}</td>
                <td>$${totals.days90.toLocaleString()}</td>
                <td>$${totals.over90.toLocaleString()}</td>
              </tr>
            </tbody>
          </table>
          <div class="summary">
            <div class="summary-card"><div class="summary-label">Total A/R</div><div class="summary-value">$${totals.total.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Current</div><div class="summary-value">$${totals.current.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Past Due</div><div class="summary-value">$${pastDue.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Past Due %</div><div class="summary-value">${pastDuePct}%</div></div>
          </div>
        `;
      } else {
        const totals = data.projects.reduce((acc, p) => ({
          contract: acc.contract + (parseFloat(p.contractAmount) || 0),
          billed: acc.billed + (parseFloat(p.billedToDate) || 0),
          costs: acc.costs + (parseFloat(p.costsToDate) || 0),
          estCosts: acc.estCosts + (parseFloat(p.estTotalCosts) || 0)
        }), { contract: 0, billed: 0, costs: 0, estCosts: 0 });
        const unbilled = totals.contract - totals.billed;
        const grossProfit = totals.contract - totals.estCosts;
        const margin = totals.contract > 0 ? Math.round((grossProfit / totals.contract) * 100) : 0;
        
        return `
          <table>
            <thead>
              <tr><th>Project</th><th>Customer</th><th>Contract</th><th>Billed</th><th>Costs</th><th>Est. Costs</th><th>% Complete</th><th>Over/Under</th></tr>
            </thead>
            <tbody>
              ${data.projects.map(p => {
                const earned = (parseFloat(p.contractAmount) || 0) * ((parseFloat(p.percentComplete) || 0) / 100);
                const overUnder = (parseFloat(p.billedToDate) || 0) - earned;
                return `
                  <tr>
                    <td>${p.projectName || '-'}</td>
                    <td>${p.customer || '-'}</td>
                    <td>$${(parseFloat(p.contractAmount) || 0).toLocaleString()}</td>
                    <td>$${(parseFloat(p.billedToDate) || 0).toLocaleString()}</td>
                    <td>$${(parseFloat(p.costsToDate) || 0).toLocaleString()}</td>
                    <td>$${(parseFloat(p.estTotalCosts) || 0).toLocaleString()}</td>
                    <td>${p.percentComplete || 0}%</td>
                    <td style="color: ${overUnder >= 0 ? '#10b981' : '#ef4444'}">$${Math.abs(overUnder).toLocaleString()}</td>
                  </tr>
                `;
              }).join('')}
              <tr class="total-row">
                <td colspan="2">TOTALS</td>
                <td>$${totals.contract.toLocaleString()}</td>
                <td>$${totals.billed.toLocaleString()}</td>
                <td>$${totals.costs.toLocaleString()}</td>
                <td>$${totals.estCosts.toLocaleString()}</td>
                <td colspan="2"></td>
              </tr>
            </tbody>
          </table>
          <div class="summary">
            <div class="summary-card"><div class="summary-label">Total Contracts</div><div class="summary-value">$${totals.contract.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Unbilled</div><div class="summary-value">$${unbilled.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Est. Gross Profit</div><div class="summary-value">$${grossProfit.toLocaleString()}</div></div>
            <div class="summary-card"><div class="summary-label">Gross Margin</div><div class="summary-value">${margin}%</div></div>
          </div>
        `;
      }
    }
    
    // Track when recipient edits a report (debounced)
    let reportEditTimeout = null;
    function trackReportEdit(type) {
      if (reportViewMode !== 'recipient' || !currentReportId) return;
      
      // Debounce edit tracking to avoid excessive calls
      clearTimeout(reportEditTimeout);
      reportEditTimeout = setTimeout(() => {
        updateReportTrackingById(currentReportId, 'edited', 'recipient');
      }, 2000);
    }
    
    // Submit completed report (client action)
    function submitReport(type) {
      if (!currentReportId) {
        showNotification('Unable to submit report', 'error');
        return;
      }
      
      const data = type === 'debtschedule' ? reportState.debtSchedule : 
                   type === 'araging' ? reportState.arAging : reportState.wip;
      
      // Store completed data in localStorage for rep to access
      const completedReports = JSON.parse(localStorage.getItem('tb_completed_reports') || '{}');
      completedReports[currentReportId] = {
        type: type,
        data: JSON.parse(JSON.stringify(data)), // Deep clone
        submittedAt: new Date().toISOString()
      };
      localStorage.setItem('tb_completed_reports', JSON.stringify(completedReports));
      
      // Update tracking
      updateReportTrackingById(currentReportId, 'submitted', 'recipient');
      
      // Show success feedback
      showSubmitConfirmation(type);
    }
    
    function showSubmitConfirmation(type) {
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
      modal.style.cssText = 'background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);';
      modal.innerHTML = `
        <div class="w-full max-w-md rounded-2xl p-8 text-center" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">Report Submitted!</h3>
          <p class="text-sm mb-6" style="color: var(--text-muted);">Your ${reportNames[type]} has been submitted successfully. The sender has been notified.</p>
          <button onclick="this.closest('.fixed').remove()" class="px-6 py-3 rounded-lg font-semibold" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">Done</button>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    }
    
    // Get completed report data by ID (for rep to view/download)
    function getCompletedReportData(reportId) {
      const completedReports = JSON.parse(localStorage.getItem('tb_completed_reports') || '{}');
      return completedReports[reportId] || null;
    }
    
    // View completed report (loads into report tool)
    function viewCompletedReport(reportId) {
      const completed = getCompletedReportData(reportId);
      if (!completed) {
        showNotification('Completed report data not found', 'error');
        return;
      }
      
      // Load the data into report state
      if (completed.type === 'debtschedule') {
        reportState.debtSchedule = completed.data;
      } else if (completed.type === 'araging') {
        reportState.arAging = completed.data;
      } else if (completed.type === 'wip') {
        reportState.wip = completed.data;
      }
      
      // Close dashboard modal
      document.getElementById('reportsDashboardModal')?.remove();
      
      // Switch to the report tool
      currentReportId = reportId;
      reportViewMode = 'owner';
      switchTool(completed.type);
      showNotification('Loaded completed report', 'success');
    }
    
    // Download completed report as PDF (opens print dialog)
    function downloadCompletedReportPDF(reportId) {
      const completed = getCompletedReportData(reportId);
      if (!completed) {
        showNotification('Completed report data not found', 'error');
        return;
      }
      
      const reportNames = { debtschedule: 'Debt Schedule', araging: 'A/R Aging', wip: 'WIP Report' };
      const data = completed.data;
      
      // Generate printable HTML (same as downloadReport)
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${reportNames[completed.type]} - ${data.businessName || 'Report'}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1f2937; }
            h1 { font-size: 24px; margin-bottom: 8px; }
            .meta { color: #6b7280; font-size: 14px; margin-bottom: 24px; }
            .submitted-badge { display: inline-block; background: #8b5cf620; color: #8b5cf6; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 12px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
            th, td { border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; font-size: 13px; }
            th { background: #f9fafb; font-weight: 600; }
            .total-row { background: #f3f4f6; font-weight: 600; }
            .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 24px; }
            .summary-card { background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center; }
            .summary-label { font-size: 11px; color: #6b7280; text-transform: uppercase; }
            .summary-value { font-size: 20px; font-weight: 700; color: #111827; margin-top: 4px; }
            @media print { body { padding: 20px; } }
          </style>
        </head>
        <body>
          <h1>${reportNames[completed.type]}<span class="submitted-badge">✓ Submitted</span></h1>
          <div class="meta">${data.businessName || 'Business Name'} • ${data.preparedDate || data.asOfDate || new Date().toLocaleDateString()} • Submitted ${new Date(completed.submittedAt).toLocaleString()}</div>
          ${generateReportHTML(completed.type, data)}
          <script>window.print();<\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
    }
    
    function openReportsDashboard() {
      const reports = getStoredReports();
      const modal = document.createElement('div');
      modal.id = 'reportsDashboardModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
      modal.style.cssText = 'background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);';
      
      const reportRows = reports.map(r => {
        const status = getReportStatus(r);
        const viewCount = r.tracking?.viewCount || 0;
        const editCount = r.tracking?.editCount || 0;
        const hasInteracted = r.edited || editCount > 0;
        const isCompleted = !!r.completed;
        return `
          <tr style="border-bottom: 1px solid var(--border-secondary);">
            <td class="p-3">
              <div class="font-semibold text-sm" style="color: var(--text-primary);">${r.businessName}</div>
              <div class="text-xs" style="color: var(--text-muted);">${r.typeName}</div>
            </td>
            <td class="p-3">
              <span class="px-2 py-1 rounded-full text-xs font-semibold" style="background: ${status.color}20; color: ${status.color};">${status.label}</span>
              ${isCompleted ? '<div class="text-xs mt-1" style="color: var(--text-muted);">' + new Date(r.completed).toLocaleString() + '</div>' : ''}
            </td>
            <td class="p-3 text-xs" style="color: var(--text-muted);">${new Date(r.createdAt).toLocaleDateString()}</td>
            <td class="p-3">
              <div class="flex items-center gap-2">
                <span class="flex items-center gap-1 text-xs ${viewCount > 0 ? '' : 'opacity-50'}" style="color: ${viewCount > 0 ? '#f59e0b' : 'var(--text-muted)'};">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                  ${viewCount}
                </span>
                <span class="flex items-center gap-1 text-xs ${hasInteracted ? '' : 'opacity-50'}" style="color: ${hasInteracted ? '#10b981' : 'var(--text-muted)'};">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                  ${hasInteracted ? '✓' : '-'}
                </span>
              </div>
            </td>
            <td class="p-3">
              <div class="flex items-center gap-1 flex-wrap">
                ${isCompleted ? `
                <button onclick="viewCompletedReport('${r.id}')" class="text-xs px-2 py-1 rounded flex items-center gap-1" style="background: #8b5cf620; color: #8b5cf6;" title="View completed report">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                  View
                </button>
                <button onclick="downloadCompletedReportPDF('${r.id}')" class="text-xs px-2 py-1 rounded flex items-center gap-1" style="background: #8b5cf620; color: #8b5cf6;" title="Download PDF">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                  PDF
                </button>
                ` : ''}
                <button onclick="copyReportLinkById('${r.id}')" class="text-xs px-2 py-1 rounded" style="background: var(--bg-tertiary); color: var(--text-secondary);" title="Copy link">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                </button>
                <button onclick="viewReportAuditLog('${r.id}')" class="text-xs px-2 py-1 rounded" style="background: var(--bg-tertiary); color: var(--accent);">Activity</button>
              </div>
            </td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="5" class="p-6 text-center" style="color: var(--text-muted);">No shared reports yet</td></tr>';
      
      modal.innerHTML = `
        <div class="w-full max-w-3xl rounded-2xl overflow-hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary); max-height: 80vh;">
          <div class="flex items-center justify-between p-4" style="border-bottom: 1px solid var(--border-secondary);">
            <h3 class="text-lg font-bold" style="color: var(--text-primary);">Shared Reports</h3>
            <button onclick="this.closest('#reportsDashboardModal').remove()" class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--bg-tertiary); color: var(--text-muted);">✕</button>
          </div>
          <div class="overflow-auto" style="max-height: calc(80vh - 60px);">
            <table class="w-full">
              <thead>
                <tr style="background: var(--bg-tertiary);">
                  <th class="p-3 text-left text-xs font-semibold" style="color: var(--text-muted);">Report</th>
                  <th class="p-3 text-left text-xs font-semibold" style="color: var(--text-muted);">Status</th>
                  <th class="p-3 text-left text-xs font-semibold" style="color: var(--text-muted);">Shared</th>
                  <th class="p-3 text-left text-xs font-semibold" style="color: var(--text-muted);">Tracking</th>
                  <th class="p-3 text-left text-xs font-semibold" style="color: var(--text-muted);">Actions</th>
                </tr>
              </thead>
              <tbody>${reportRows}</tbody>
            </table>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    }
    
    function viewReportAuditLog(reportId) {
      const reports = getStoredReports();
      const report = reports.find(r => r.id === reportId);
      if (!report) return;
      
      document.getElementById('reportsDashboardModal')?.remove();
      
      const modal = document.createElement('div');
      modal.id = 'auditLogModal';
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
      modal.style.cssText = 'background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);';
      
      const logRows = (report.auditLog || []).map(log => `
        <div class="flex items-center gap-3 p-3" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold" style="background: ${log.action === 'viewed' ? '#f59e0b' : log.action === 'edited' ? '#10b981' : log.action === 'downloaded' ? '#8b5cf6' : '#3b82f6'}20; color: ${log.action === 'viewed' ? '#f59e0b' : log.action === 'edited' ? '#10b981' : log.action === 'downloaded' ? '#8b5cf6' : '#3b82f6'};">
            ${log.action === 'viewed' ? '👁' : log.action === 'edited' ? '✏️' : log.action === 'downloaded' ? '⬇️' : log.action === 'shared' ? '🔗' : '📄'}
          </div>
          <div class="flex-1">
            <div class="text-sm font-semibold capitalize" style="color: var(--text-primary);">${log.action}</div>
            <div class="text-xs" style="color: var(--text-muted);">by ${log.by}</div>
          </div>
          <div class="text-xs" style="color: var(--text-muted);">${new Date(log.timestamp).toLocaleString()}</div>
        </div>
      `).join('') || '<div class="p-6 text-center" style="color: var(--text-muted);">No activity yet</div>';
      
      modal.innerHTML = `
        <div class="w-full max-w-md rounded-2xl overflow-hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary); max-height: 80vh;">
          <div class="flex items-center justify-between p-4" style="border-bottom: 1px solid var(--border-secondary);">
            <div>
              <h3 class="text-lg font-bold" style="color: var(--text-primary);">Audit Log</h3>
              <div class="text-xs" style="color: var(--text-muted);">${report.businessName} - ${report.typeName}</div>
            </div>
            <button onclick="this.closest('#auditLogModal').remove()" class="w-8 h-8 rounded-full flex items-center justify-center" style="background: var(--bg-tertiary); color: var(--text-muted);">✕</button>
          </div>
          <div class="overflow-auto" style="max-height: calc(80vh - 80px);">
            ${logRows}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    }
    
    function copyReportLinkById(reportId) {
      const reports = getStoredReports();
      const report = reports.find(r => r.id === reportId);
      if (!report || !report.link) {
        showNotification('Link not found', 'error');
        return;
      }
      navigator.clipboard.writeText(report.link).then(() => {
        showNotification('Link copied!', 'success');
      }).catch(() => prompt('Copy this link:', report.link));
    }
    
    function renderPreQualify(input, result) {
      const s = loanState;
      
      // Initialize criteria with new v4.1 fields
      const criteria = s.prequalCriteria || {
        monthlyRevenue: 50000,
        avgDailyBalance: 8000,
        creditScore: 650,
        monthsInBusiness: 24,
        nsfCount: 2,
        negativeDays: 1,
        isRestricted: false
      };
      
      // Save criteria to state
      loanState.prequalCriteria = criteria;
      
      // Run ABLESCORE v4.1 Engine
      const engine = new PerrepusAI_v4_1(criteria);
      const result_data = engine.process();
      
      const isApproved = result_data.status === "APPROVED";
      const score = isApproved ? result_data.score.value : (result_data.score || 0);
      const tier = isApproved ? result_data.score.tierId : (result_data.tier || 'E');
      const tierLabel = isApproved ? result_data.score.tier : 'Declined';
      
      const tierColors = {
        'A': '#10b981',
        'B': '#22c55e', 
        'C': '#eab308',
        'D': '#f97316',
        'E': '#ef4444'
      };
      const gradeColor = tierColors[tier] || '#ef4444';
      
      // Calculate individual score components for display
      const creditPts = criteria.creditScore < 500 ? 0 : Math.min(30, ((criteria.creditScore - 500) / 300) * 30);
      const events = criteria.nsfCount + criteria.negativeDays;
      const behavePts = events > 10 ? 0 : Math.max(0, 30 - (events * 3));
      const revPts = criteria.monthlyRevenue < 7500 ? 0 : Math.min(20, ((criteria.monthlyRevenue - 7500) / 92500) * 20);
      const stabPts = criteria.monthsInBusiness >= 36 ? 10 : criteria.monthsInBusiness >= 24 ? 7 : criteria.monthsInBusiness >= 12 ? 4 : 1;
      const buffer = criteria.avgDailyBalance / criteria.monthlyRevenue;
      const bufferPts = buffer >= 0.10 ? 10 : buffer >= 0.05 ? 5 : 0;
      const restrictedPenalty = criteria.isRestricted ? -15 : 0;
      
      input.innerHTML = `
        <div class="flex items-center gap-3 mb-6">
          <div class="section-indicator"></div>
          <h3 class="section-title">ABLESCORE v4.1 Credit Engine</h3>
        </div>
        
        <!-- Live Score Breakdown Panel -->
        <div id="prequalScorePanel" class="mb-6 rounded-2xl border overflow-hidden" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
          <div class="p-6" style="background: linear-gradient(135deg, ${gradeColor}15 0%, ${gradeColor}05 100%); border-bottom: 1px solid var(--border-secondary);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-bold uppercase tracking-wider" style="color: var(--text-muted);">ABLESCORE</div>
                <div class="text-3xl font-black" style="color: ${gradeColor};">${score}<span class="text-lg font-semibold" style="color: var(--text-muted);">/100</span></div>
              </div>
              <div class="text-center">
                <div class="text-4xl font-black" style="color: ${gradeColor};">${tier}</div>
                <div class="text-xs font-bold uppercase" style="color: var(--text-muted);">${tierLabel}</div>
              </div>
            </div>
          </div>
          
          <div class="p-4 space-y-3">
            <div class="text-xs font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Score Breakdown</div>
            
            <!-- Credit Score -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: ${creditPts >= 25 ? '#10b981' : creditPts >= 15 ? '#eab308' : '#ef4444'};"></div>
                <span class="text-xs font-semibold" style="color: var(--text-secondary);">Credit Score</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                  <div class="h-full rounded-full" style="width: ${(creditPts/30)*100}%; background: ${creditPts >= 25 ? '#10b981' : creditPts >= 15 ? '#eab308' : '#ef4444'};"></div>
                </div>
                <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">${creditPts.toFixed(0)}/30</span>
              </div>
            </div>
            
            <!-- Behavior -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: ${behavePts >= 25 ? '#10b981' : behavePts >= 15 ? '#eab308' : '#ef4444'};"></div>
                <span class="text-xs font-semibold" style="color: var(--text-secondary);">Behavior (${events} events)</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                  <div class="h-full rounded-full" style="width: ${(behavePts/30)*100}%; background: ${behavePts >= 25 ? '#10b981' : behavePts >= 15 ? '#eab308' : '#ef4444'};"></div>
                </div>
                <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">${behavePts.toFixed(0)}/30</span>
              </div>
            </div>
            
            <!-- Revenue -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: ${revPts >= 15 ? '#10b981' : revPts >= 8 ? '#eab308' : '#ef4444'};"></div>
                <span class="text-xs font-semibold" style="color: var(--text-secondary);">Revenue</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                  <div class="h-full rounded-full" style="width: ${(revPts/20)*100}%; background: ${revPts >= 15 ? '#10b981' : revPts >= 8 ? '#eab308' : '#ef4444'};"></div>
                </div>
                <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">${revPts.toFixed(0)}/20</span>
              </div>
            </div>
            
            <!-- Stability -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: ${stabPts >= 7 ? '#10b981' : stabPts >= 4 ? '#eab308' : '#ef4444'};"></div>
                <span class="text-xs font-semibold" style="color: var(--text-secondary);">Stability</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                  <div class="h-full rounded-full" style="width: ${(stabPts/10)*100}%; background: ${stabPts >= 7 ? '#10b981' : stabPts >= 4 ? '#eab308' : '#ef4444'};"></div>
                </div>
                <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">${stabPts}/10</span>
              </div>
            </div>
            
            <!-- Buffer -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: ${bufferPts >= 10 ? '#10b981' : bufferPts >= 5 ? '#eab308' : '#ef4444'};"></div>
                <span class="text-xs font-semibold" style="color: var(--text-secondary);">Buffer (${(buffer*100).toFixed(0)}%)</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-24 h-2 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
                  <div class="h-full rounded-full" style="width: ${(bufferPts/10)*100}%; background: ${bufferPts >= 10 ? '#10b981' : bufferPts >= 5 ? '#eab308' : '#ef4444'};"></div>
                </div>
                <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">${bufferPts}/10</span>
              </div>
            </div>
            
            ${criteria.isRestricted ? `
            <!-- Restricted Penalty -->
            <div class="flex items-center justify-between pt-2 mt-2" style="border-top: 1px solid var(--border-secondary);">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: #ef4444;"></div>
                <span class="text-xs font-semibold" style="color: #ef4444;">Restricted Industry</span>
              </div>
              <span class="text-xs font-bold" style="color: #ef4444;">-15</span>
            </div>
            ` : ''}
          </div>
          
          <!-- Tier Scale -->
          <div class="px-4 pb-4">
            <div class="flex rounded-lg overflow-hidden text-center text-[10px] font-bold">
              <div class="flex-1 py-1" style="background: #10b981; color: white;">A 80+</div>
              <div class="flex-1 py-1" style="background: #22c55e; color: white;">B 65+</div>
              <div class="flex-1 py-1" style="background: #eab308; color: white;">C 50+</div>
              <div class="flex-1 py-1" style="background: #f97316; color: white;">D 35+</div>
              <div class="flex-1 py-1" style="background: #ef4444; color: white;">E &lt;35</div>
            </div>
            <div class="relative mt-1" style="height: 4px;">
              <div class="absolute top-0 w-2 h-2 rounded-full border-2" style="left: ${Math.min(100, Math.max(0, score))}%; transform: translateX(-50%); background: white; border-color: ${gradeColor};"></div>
            </div>
          </div>
        </div>
        
        <div class="space-y-0">
          ${prequalSlider('Monthly Revenue', 'monthlyRevenue', 5000, 500000, 5000, criteria.monthlyRevenue, formatCurrency)}
          ${prequalSlider('Average Daily Balance', 'avgDailyBalance', 500, 100000, 500, criteria.avgDailyBalance, formatCurrency)}
          ${prequalSlider('Credit Score (FICO)', 'creditScore', 450, 850, 5, criteria.creditScore, v=>v)}
          ${prequalSlider('Time in Business (Months)', 'monthsInBusiness', 3, 120, 3, criteria.monthsInBusiness, v=>v+' mo')}
          ${prequalSlider('NSF/Overdrafts (Monthly)', 'nsfCount', 0, 15, 1, criteria.nsfCount, v=>v)}
          ${prequalSlider('Negative Balance Days', 'negativeDays', 0, 15, 1, criteria.negativeDays, v=>v+' days')}
          <div class="rounded-2xl p-5 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
            <label class="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" ${criteria.isRestricted ? 'checked' : ''} 
                onchange="loanState.prequalCriteria.isRestricted=this.checked;updatePrequalScoreAndResult();"
                class="w-4 h-4 rounded" style="accent-color: var(--accent);">
              <span class="text-xs font-semibold" style="color: var(--text-secondary);">Restricted Industry (Cannabis, Firearms, Adult, etc.)</span>
            </label>
          </div>
        </div>
        `;
      
      if (!isApproved) {
        // DECLINED state
        result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
          <div class="calc-preview-header" style="background: linear-gradient(135deg, #ef444422 0%, #ef444411 100%); border-bottom: 3px solid #ef4444;">
            <div class="calc-preview-label">Decision</div>
            <div class="calc-preview-amount" style="color: #ef4444; font-size: 2rem;">DECLINED</div>
          </div>
          
          <div class="p-6 text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background: #ef444420; border: 3px solid #ef4444;">
              <svg class="w-10 h-10" style="color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </div>
            <div class="text-lg font-bold mb-2" style="color: var(--text-primary);">Application Not Approved</div>
            <div class="text-sm" style="color: var(--text-muted);">${result_data.reason}</div>
            ${result_data.score ? `<div class="mt-4 text-xs" style="color: var(--text-muted);">Score: ${result_data.score}/100</div>` : ''}
          </div>
          
          <div class="calc-payment-display" style="background: #ef444415;">
            <div class="calc-payment-label" style="color: #ef4444;">Recommendation</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">
              Consider reapplying after addressing the above issue
            </div>
          </div>
          
          ${renderRequirementsSection('prequal')}`;
        return;
      }
      
      // APPROVED state
      const o = result_data.offer;
      const c = result_data.closing;
      const sched = result_data.schedule;
      
      // Risk indicator for aggressive tiers
      const isHighRisk = tier === 'D' || tier === 'E';
      const riskLabel = tier === 'E' ? '⚠ HIGH RISK' : tier === 'D' ? '⚠ ELEVATED RISK' : '';
      const riskDescription = tier === 'E' 
        ? 'VERY AGGRESSIVE underwriting. High default probability. Proceed with extreme caution.' 
        : tier === 'D' 
        ? 'AGGRESSIVE underwriting. Elevated default risk. Enhanced monitoring required.' 
        : '';
      
      const riskBanner = isHighRisk ? `
        <div class="flex items-start gap-3 p-3" style="background: ${gradeColor}15; border-bottom: 2px solid ${gradeColor};">
          <svg class="w-5 h-5 flex-shrink-0 mt-0.5" style="color: ${gradeColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>
            <div class="text-xs font-bold uppercase tracking-wider" style="color: ${gradeColor};">${tier === 'E' ? 'HIGH RISK' : 'ELEVATED RISK'} APPROVAL</div>
            <div class="text-[10px] mt-1" style="color: ${gradeColor};">${riskDescription}</div>
          </div>
        </div>` : '';
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <!-- Header with Tier -->
        <div class="calc-preview-header" style="background: linear-gradient(135deg, ${gradeColor}22 0%, ${gradeColor}11 100%); border-bottom: 3px solid ${gradeColor};">
          <div class="calc-preview-label">${tierLabel}</div>
          <div class="calc-preview-amount" style="color: ${gradeColor}; font-size: 3.5rem;">TIER ${tier}</div>
        </div>
        
        ${riskBanner}
        
        <!-- Score Section -->
        <div class="calc-donut-section">
          <div style="position:relative;width:100px;height:100px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="${gradeColor}" stroke-width="3" stroke-dasharray="${score} ${100-score}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-xl font-bold" style="color:${gradeColor};">${score}</span>
              <span class="text-[9px] font-bold uppercase" style="color:var(--text-muted);">Score</span>
            </div>
          </div>
          <div class="space-y-1 text-xs">
            ${(result_data.score.breakdown || ["Strong Profile"]).map(r => `
              <div class="flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full" style="background: ${r.includes('Safety') || r.includes('Penalty') ? '#f59e0b' : '#10b981'};"></span>
                <span style="color: var(--text-muted);">${r}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Offer Details -->
        <div class="p-6" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Approved Offer</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary);">
              <div class="text-xl font-bold" style="color: var(--accent);">${formatCurrency(o.funding_amount)}</div>
              <div class="text-[10px] font-semibold uppercase" style="color: var(--text-muted);">Funding</div>
            </div>
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary); ${isHighRisk ? 'border: 1px solid ' + gradeColor + '50;' : ''}">
              <div class="text-xl font-bold" style="color: ${isHighRisk ? gradeColor : 'var(--text-primary)'};">${o.factor_rate.toFixed(2)}x</div>
              <div class="text-[10px] font-semibold uppercase" style="color: var(--text-muted);">Factor Rate</div>
            </div>
          </div>
        </div>
        
        <!-- Payment Schedule -->
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Daily Payment</span>
            <span class="calc-stat-value">${formatCurrency(sched.daily_payment)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${(o.term_label || o.term + ' Months')}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Payback</span>
            <span class="calc-stat-value">${formatCurrency(o.payback_amount)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Holdback</span>
            <span class="calc-stat-value" style="${isHighRisk ? 'color: ' + gradeColor + ';' : ''}">${sched.holdback}%</span>
          </div>
        </div>
        
        <!-- Closing Costs -->
        <div class="p-6" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Closing Breakdown</div>
          <div class="space-y-2 text-xs">
            <div class="flex justify-between" style="color: var(--text-secondary);">
              <span>Gross Funding</span>
              <span class="font-semibold">${formatCurrency(c.gross_amount)}</span>
            </div>
            <div class="flex justify-between" style="color: var(--text-muted);">
              <span>Origination Fee (3%)</span>
              <span>-${formatCurrency(c.fees.origination)}</span>
            </div>
            <div class="flex justify-between" style="color: var(--text-muted);">
              <span>Admin Fee</span>
              <span>-${formatCurrency(c.fees.admin)}</span>
            </div>
            <div class="flex justify-between" style="color: var(--text-muted);">
              <span>Wire Fee</span>
              <span>-${formatCurrency(c.fees.wire)}</span>
            </div>
            <div class="flex justify-between pt-2 mt-2" style="border-top: 1px solid var(--border-secondary); color: var(--accent);">
              <span class="font-bold">Net Wire Amount</span>
              <span class="font-bold">${formatCurrency(c.net_wire)}</span>
            </div>
          </div>
        </div>
        
        <!-- Required Stips -->
        <div class="p-6" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Required Documentation</div>
          <div class="space-y-2">
            ${(c.required_stips || []).map(stip => `
              <div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
                <svg class="w-3 h-3" style="color: ${gradeColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
                </svg>
                <span>${stip}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Status -->
        <div class="calc-payment-display" style="background: ${gradeColor}15;">
          <div class="calc-payment-label" style="color: ${gradeColor};">Decision</div>
          <div style="font-size: 16px; font-weight: 700; color: ${gradeColor};">
            ${isHighRisk ? riskLabel : '✓'} APPROVED
          </div>
        </div>
        
        ${renderRequirementsSection('prequal')}`;
    }
    
    function prequalSlider(label, key, min, max, step, value, format) {
      const displayId = 'prequal_' + key;
      return `
        <div class="rounded-2xl p-5 border" style="background: var(--bg-option-card); border-color: var(--border-secondary); margin-bottom: 16px;">
          <label class="text-xs font-bold uppercase tracking-wide block mb-2" style="color: var(--text-muted);">${label}</label>
          <div class="flex items-baseline gap-1.5 mb-4">
            <span class="text-3xl font-extrabold" style="color: var(--text-primary);" id="${displayId}Display">${format(value)}</span>
          </div>
          <input type="range" class="slider w-full" id="${displayId}" min="${min}" max="${max}" step="${step}" value="${value}" 
            oninput="handlePrequalSlider('${key}', this.value)">
          <div class="flex justify-between text-[10px] font-semibold mt-2 uppercase tracking-wider" style="color: var(--text-muted);">
            <span>${format(min)}</span>
            <span>${format(max)}</span>
          </div>
        </div>`;
    }
    
    function handlePrequalSlider(key, value) {
      const val = parseFloat(value);
      const display = document.getElementById('prequal_' + key + 'Display');
      
      // Ensure prequalCriteria exists
      if (!loanState.prequalCriteria) {
        loanState.prequalCriteria = {
          monthlyRevenue: 50000,
          avgDailyBalance: 8000,
          creditScore: 650,
          monthsInBusiness: 24,
          nsfCount: 2,
          negativeDays: 1,
          isRestricted: false
        };
      }
      
      // Update state
      loanState.prequalCriteria[key] = val;
      
      // Update display text
      if (display) {
        if (key === 'monthlyRevenue' || key === 'avgDailyBalance') {
          display.textContent = formatCurrency(val);
        } else if (key === 'monthsInBusiness') {
          display.textContent = val + ' mo';
        } else if (key === 'negativeDays') {
          display.textContent = val + ' days';
        } else {
          display.textContent = val;
        }
      }
      
      // Update score panel and result card
      updatePrequalScoreAndResult();
    }
    
    function updatePrequalScoreAndResult() {
      try {
        const criteria = loanState.prequalCriteria;
        if (!criteria) {
          console.warn('prequalCriteria not initialized');
          return;
        }
        const engine = new PerrepusAI_v4_1(criteria);
        const result_data = engine.process();
      
      const isApproved = result_data.status === "APPROVED";
      const score = isApproved ? result_data.score.value : (result_data.score || 0);
      const tier = isApproved ? result_data.score.tierId : (result_data.tier || 'E');
      const tierLabel = isApproved ? result_data.score.tier : 'Declined';
      
      const tierColors = { 'A': '#10b981', 'B': '#22c55e', 'C': '#eab308', 'D': '#f97316', 'E': '#ef4444' };
      const gradeColor = tierColors[tier] || '#ef4444';
      
      // Update score breakdown panel
      const scorePanel = document.getElementById('prequalScorePanel');
      if (scorePanel) {
        const creditPts = criteria.creditScore < 500 ? 0 : Math.min(30, ((criteria.creditScore - 500) / 300) * 30);
        const events = criteria.nsfCount + criteria.negativeDays;
        const behavePts = events > 10 ? 0 : Math.max(0, 30 - (events * 3));
        const revPts = criteria.monthlyRevenue < 7500 ? 0 : Math.min(20, ((criteria.monthlyRevenue - 7500) / 92500) * 20);
        const stabPts = criteria.monthsInBusiness >= 36 ? 10 : criteria.monthsInBusiness >= 24 ? 7 : criteria.monthsInBusiness >= 12 ? 4 : 1;
        const buffer = criteria.avgDailyBalance / criteria.monthlyRevenue;
        const bufferPts = buffer >= 0.10 ? 10 : buffer >= 0.05 ? 5 : 0;
        
        scorePanel.innerHTML = `
          <div class="p-6" style="background: linear-gradient(135deg, ${gradeColor}15 0%, ${gradeColor}05 100%); border-bottom: 1px solid var(--border-secondary);">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs font-bold uppercase tracking-wider" style="color: var(--text-muted);">ABLESCORE</div>
                <div class="text-3xl font-black" style="color: ${gradeColor};">${score}<span class="text-lg font-semibold" style="color: var(--text-muted);">/100</span></div>
              </div>
              <div class="text-center">
                <div class="text-4xl font-black" style="color: ${gradeColor};">${tier}</div>
                <div class="text-xs font-bold uppercase" style="color: var(--text-muted);">${tierLabel}</div>
              </div>
            </div>
          </div>
          <div class="p-4 space-y-3">
            <div class="text-xs font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Score Breakdown</div>
            ${renderScoreRow('Credit Score', creditPts, 30)}
            ${renderScoreRow('Behavior (' + events + ' events)', behavePts, 30)}
            ${renderScoreRow('Revenue', revPts, 20)}
            ${renderScoreRow('Stability', stabPts, 10)}
            ${renderScoreRow('Buffer (' + (buffer*100).toFixed(0) + '%)', bufferPts, 10)}
            ${criteria.isRestricted ? `
            <div class="flex items-center justify-between pt-2 mt-2" style="border-top: 1px solid var(--border-secondary);">
              <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" style="background: #ef4444;"></div>
                <span class="text-xs font-semibold" style="color: #ef4444;">Restricted Industry</span>
              </div>
              <span class="text-xs font-bold" style="color: #ef4444;">-15</span>
            </div>` : ''}
          </div>
          <div class="px-4 pb-4">
            <div class="flex rounded-lg overflow-hidden text-center text-[10px] font-bold">
              <div class="flex-1 py-1" style="background: #10b981; color: white;">A 80+</div>
              <div class="flex-1 py-1" style="background: #22c55e; color: white;">B 65+</div>
              <div class="flex-1 py-1" style="background: #eab308; color: white;">C 50+</div>
              <div class="flex-1 py-1" style="background: #f97316; color: white;">D 35+</div>
              <div class="flex-1 py-1" style="background: #ef4444; color: white;">E &lt;35</div>
            </div>
            <div class="relative mt-1" style="height: 4px;">
              <div class="absolute top-0 w-2 h-2 rounded-full border-2" style="left: ${Math.min(100, Math.max(0, score))}%; transform: translateX(-50%); background: white; border-color: ${gradeColor};"></div>
            </div>
          </div>`;
      }
      
      // Update result card
      const result = document.getElementById('prequalResultCard');
      if (!result) return;
      
      if (!isApproved) {
        result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
          <div class="calc-preview-header" style="background: linear-gradient(135deg, #ef444422 0%, #ef444411 100%); border-bottom: 3px solid #ef4444;">
            <div class="calc-preview-label">Decision</div>
            <div class="calc-preview-amount" style="color: #ef4444; font-size: 2rem;">DECLINED</div>
          </div>
          <div class="p-6 text-center">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full mb-4" style="background: #ef444420; border: 3px solid #ef4444;">
              <svg class="w-10 h-10" style="color: #ef4444;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </div>
            <div class="text-lg font-bold mb-2" style="color: var(--text-primary);">Application Not Approved</div>
            <div class="text-sm" style="color: var(--text-muted);">${result_data.reason}</div>
          </div>`;
        return;
      }
      
      const o = result_data.offer;
      const c = result_data.closing;
      const sched = result_data.schedule;
      const isHighRisk = tier === 'D' || tier === 'E';
      const riskDescription = tier === 'E' 
        ? 'VERY AGGRESSIVE underwriting. High default probability. Proceed with extreme caution.' 
        : tier === 'D' 
        ? 'AGGRESSIVE underwriting. Elevated default risk. Enhanced monitoring required.' 
        : '';
      
      const riskBanner = isHighRisk ? `
        <div class="flex items-start gap-3 p-3" style="background: ${gradeColor}15; border-bottom: 2px solid ${gradeColor};">
          <svg class="w-5 h-5 flex-shrink-0 mt-0.5" style="color: ${gradeColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>
            <div class="text-xs font-bold uppercase tracking-wider" style="color: ${gradeColor};">${tier === 'E' ? 'HIGH RISK' : 'ELEVATED RISK'} APPROVAL</div>
            <div class="text-[10px] mt-1" style="color: ${gradeColor};">${riskDescription}</div>
          </div>
        </div>` : '';
      
      result.innerHTML = `
        <button class="calc-card-share-btn" onclick="shareOffer()" title="Share">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
        <!-- Header with Tier -->
        <div class="calc-preview-header" style="background: linear-gradient(135deg, ${gradeColor}22 0%, ${gradeColor}11 100%); border-bottom: 3px solid ${gradeColor};">
          <div class="calc-preview-label">${tierLabel}</div>
          <div class="calc-preview-amount" style="color: ${gradeColor}; font-size: 3.5rem;">TIER ${tier}</div>
        </div>
        
        ${riskBanner}
        
        <!-- Score Section -->
        <div class="calc-donut-section">
          <div style="position:relative;width:100px;height:100px;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="${gradeColor}" stroke-width="3" stroke-dasharray="${score} ${100-score}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span class="text-xl font-bold" style="color:${gradeColor};">${score}</span>
              <span class="text-[9px] font-bold uppercase" style="color:var(--text-muted);">Score</span>
            </div>
          </div>
          <div class="space-y-1 text-xs">
            ${(result_data.score.breakdown || ["Strong Profile"]).map(r => `
              <div class="flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full" style="background: ${r.includes('Safety') || r.includes('Penalty') ? '#f59e0b' : '#10b981'};"></span>
                <span style="color: var(--text-muted);">${r}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Offer Details -->
        <div class="p-6" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Approved Offer</div>
          <div class="grid grid-cols-2 gap-3">
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary);">
              <div class="text-xl font-bold" style="color: var(--accent);">${formatCurrency(o.funding_amount)}</div>
              <div class="text-[10px] font-semibold uppercase" style="color: var(--text-muted);">Funding</div>
            </div>
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-tertiary); ${isHighRisk ? 'border: 1px solid ' + gradeColor + '50;' : ''}">
              <div class="text-xl font-bold" style="color: ${isHighRisk ? gradeColor : 'var(--text-primary)'};">${o.factor_rate.toFixed(2)}x</div>
              <div class="text-[10px] font-semibold uppercase" style="color: var(--text-muted);">Factor Rate</div>
            </div>
          </div>
        </div>
        
        <!-- Payment Schedule -->
        <div class="calc-stats-grid">
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Daily Payment</span>
            <span class="calc-stat-value">${formatCurrency(sched.daily_payment)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Term</span>
            <span class="calc-stat-value">${(o.term_label || o.term + ' Months')}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Total Payback</span>
            <span class="calc-stat-value">${formatCurrency(o.payback_amount)}</span>
          </div>
          <div class="calc-stat-cell">
            <span class="calc-stat-label">Holdback</span>
            <span class="calc-stat-value" style="${isHighRisk ? 'color: ' + gradeColor + ';' : ''}">${sched.holdback}%</span>
          </div>
        </div>
        
        <!-- Closing Costs -->
        <div class="p-6" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Closing Breakdown</div>
          <div class="space-y-2 text-xs">
            <div class="flex justify-between" style="color: var(--text-secondary);">
              <span>Gross Funding</span>
              <span class="font-semibold">${formatCurrency(c.gross_amount)}</span>
            </div>
            <div class="flex justify-between" style="color: var(--text-muted);">
              <span>Origination Fee (3%)</span>
              <span>-${formatCurrency(c.fees.origination)}</span>
            </div>
            <div class="flex justify-between" style="color: var(--text-muted);">
              <span>Admin Fee</span>
              <span>-${formatCurrency(c.fees.admin)}</span>
            </div>
            <div class="flex justify-between" style="color: var(--text-muted);">
              <span>Wire Fee</span>
              <span>-${formatCurrency(c.fees.wire)}</span>
            </div>
            <div class="flex justify-between pt-2 mt-2" style="border-top: 1px solid var(--border-secondary); color: var(--accent);">
              <span class="font-bold">Net Wire Amount</span>
              <span class="font-bold">${formatCurrency(c.net_wire)}</span>
            </div>
          </div>
        </div>
        
        <!-- Required Stips -->
        <div class="p-6" style="border-bottom: 1px solid var(--border-secondary);">
          <div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Required Documentation</div>
          <div class="space-y-2">
            ${(c.required_stips || []).map(stip => `
              <div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
                <svg class="w-3 h-3" style="color: ${gradeColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/>
                </svg>
                <span>${stip}</span>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- Status -->
        <div class="calc-payment-display" style="background: ${gradeColor}15;">
          <div class="calc-payment-label" style="color: ${gradeColor};">Decision</div>
          <div style="font-size: 16px; font-weight: 700; color: ${gradeColor};">
            PRE-APPROVED
          </div>
        </div>`;
      } catch (err) {
        console.error('updatePrequalScoreAndResult error:', err);
      }
    }
    
    function renderScoreRow(label, pts, max) {
      const pct = (pts/max)*100;
      const color = pct >= 75 ? '#10b981' : pct >= 40 ? '#eab308' : '#ef4444';
      return `<div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full" style="background: ${color};"></div>
          <span class="text-xs font-semibold" style="color: var(--text-secondary);">${label}</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-24 h-2 rounded-full overflow-hidden" style="background: var(--bg-tertiary);">
            <div class="h-full rounded-full" style="width: ${pct}%; background: ${color};"></div>
          </div>
          <span class="text-xs font-bold w-12 text-right" style="color: var(--text-primary);">${pts.toFixed(0)}/${max}</span>
        </div>
      </div>`;
    }
    
    
    function renderDonut(val1, val2, label1, label2) {
      const total = val1 + val2;
      const pct1 = Math.round((val1 / total) * 100);
      const pct2 = 100 - pct1;
      return `
        <div class="option-card mt-4" style="padding: 24px;">
          <div style="position:relative;width:140px;height:140px;margin:0 auto;">
            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);width:100%;height:100%;">
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--chart-bg)" stroke-width="3"/>
              <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="${pct1} ${pct2}" stroke-linecap="round"/>
            </svg>
            <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;">
              <span style="font-size:28px;font-weight:800;color:var(--accent);">${pct1}%</span>
              <span class="text-[10px] font-bold uppercase tracking-wide" style="color:var(--text-muted);">${label1}</span>
            </div>
          </div>
          <div class="flex justify-center gap-6 mt-4">
            <div class="flex items-center gap-2">
              <div style="width:10px;height:10px;border-radius:50%;background:var(--accent);"></div>
              <span class="text-xs font-semibold" style="color:var(--text-muted);">${label1}</span>
            </div>
            <div class="flex items-center gap-2">
              <div style="width:10px;height:10px;border-radius:50%;background:var(--chart-bg);"></div>
              <span class="text-xs font-semibold" style="color:var(--text-muted);">${label2}</span>
            </div>
          </div>
        </div>`;
    }
  </script>

  <!-- Mobile Settings Sheet -->
  <div class="mobile-settings-sheet" id="mobileSettingsSheet">
    <div class="mobile-settings-overlay" onclick="closeMobileSettings()"></div>
    <div class="mobile-settings-content">
      <div class="mobile-settings-header">
        <h3>Settings</h3>
        <button class="mobile-settings-close" onclick="closeMobileSettings()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="mobile-settings-section">
        <div class="mobile-settings-section-title">Theme</div>
        <div class="mobile-settings-grid">
          <button class="mobile-theme-btn" onclick="setThemeModeMobile('light')">Light</button>
          <button class="mobile-theme-btn" onclick="setThemeModeMobile('dark')">Dark</button>
          <button class="mobile-theme-btn active" onclick="setThemeModeMobile('black')">Black</button>
        </div>
      </div>
      
      <div class="mobile-settings-section">
        <div class="mobile-settings-section-title">Accent Color</div>
        <div class="mobile-settings-grid" style="grid-template-columns: repeat(5, 1fr);">
          <button class="mobile-accent-btn" style="background: #f59e0b;" onclick="setAccentColorMobile('amber')"></button>
          <button class="mobile-accent-btn" style="background: #6366f1;" onclick="setAccentColorMobile('indigo')"></button>
          <button class="mobile-accent-btn" style="background: #10b981;" onclick="setAccentColorMobile('emerald')"></button>
          <button class="mobile-accent-btn" style="background: #3b82f6;" onclick="setAccentColorMobile('blue')"></button>
          <button class="mobile-accent-btn" style="background: #ec4899;" onclick="setAccentColorMobile('pink')"></button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Mobile Navigation Functions
    function switchToolMobile(tool) {
      switchTool(tool);
      // Update active tab
      document.querySelectorAll('.mobile-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tool === tool);
      });
      // Scroll active tab into view
      const activeTab = document.querySelector(`.mobile-tab[data-tool="${tool}"]`);
      if (activeTab) {
        activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      }
    }
    
    function openMobileSettings() {
      const sheet = document.getElementById('mobileSettingsSheet');
      if (sheet) {
        sheet.classList.add('open');
        updateMobileSettingsState();
      }
    }
    
    function closeMobileSettings() {
      const sheet = document.getElementById('mobileSettingsSheet');
      if (sheet) {
        sheet.classList.remove('open');
      }
    }
    
    function updateMobileSettingsState() {
      // Update theme buttons
      document.querySelectorAll('.mobile-theme-btn').forEach(btn => {
        btn.classList.remove('active');
        const onclick = btn.getAttribute('onclick') || '';
        if (onclick.includes(currentTheme)) btn.classList.add('active');
      });
      
      // Update accent buttons
      document.querySelectorAll('.mobile-accent-btn').forEach(btn => {
        btn.classList.remove('active');
        const onclick = btn.getAttribute('onclick') || '';
        if (onclick.includes(currentAccent)) btn.classList.add('active');
      });
    }
    
    function setThemeModeMobile(theme) {
      setThemeMode(theme);
      updateMobileSettingsState();
    }
    
    function setAccentColorMobile(accent) {
      setAccentColor(accent);
      updateMobileSettingsState();
    }
    
    // Add swipe gesture support for tool switching
    let touchStartX = 0;
    let touchEndX = 0;
    const toolOrder = ['prequal', 'offer', 'mca', 'working', 'term', 'loc', 'sba', 'equipment', 'cre', 'factoring', 'payoff', 'apr', 'perrepus', 'debtschedule', 'araging', 'wip'];
    
    document.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });
    
    document.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    }, { passive: true });
    
    function handleSwipe() {
      const swipeThreshold = 80;
      const diff = touchStartX - touchEndX;
      
      // Only handle swipes on mobile
      if (window.innerWidth > 768) return;
      
      // Ignore small swipes
      if (Math.abs(diff) < swipeThreshold) return;
      
      const currentIndex = toolOrder.indexOf(currentTool);
      if (currentIndex === -1) return;
      
      if (diff > 0 && currentIndex < toolOrder.length - 1) {
        // Swipe left - next tool
        switchToolMobile(toolOrder[currentIndex + 1]);
      } else if (diff < 0 && currentIndex > 0) {
        // Swipe right - previous tool
        switchToolMobile(toolOrder[currentIndex - 1]);
      }
    }
    
    // Sync mobile tabs with sidebar selection
    const origSwitchToolForMobile = switchTool;
    switchTool = function(tool) {
      origSwitchToolForMobile(tool);
      document.querySelectorAll('.mobile-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tool === tool);
      });
      // Scroll active tab into view on mobile
      if (window.innerWidth <= 768) {
        const activeTab = document.querySelector(`.mobile-tab[data-tool="${tool}"]`);
        if (activeTab) {
          activeTab.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
    };

    // ============================================
    // SETTINGS MODAL FUNCTIONS
    // ============================================
    function openSettings() {
      document.getElementById('settingsOverlay').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settingsOverlay').classList.remove('active');
    }

    function toggleTheme() {
      const toggle = document.getElementById('themeToggle');
      const isLight = document.body.classList.toggle('light-theme');
      toggle.classList.toggle('active', isLight);
      localStorage.setItem('ab_theme', isLight ? 'light' : 'dark');
    }

    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('ab_theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        document.getElementById('themeToggle')?.classList.add('active');
      }
    });
  </script>

  <!-- Settings Modal -->
  <div class="settings-overlay" id="settingsOverlay" onclick="if(event.target === this) closeSettings()">
    <div class="settings-modal">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="settings-close" onclick="closeSettings()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="settings-body">
        <!-- Appearance Section -->
        <div class="settings-section">
          <div class="settings-section-title">Appearance</div>
          <div class="settings-row">
            <div>
              <div class="settings-row-label">Light Theme</div>
              <div class="settings-row-desc">Switch to light mode for better visibility</div>
            </div>
            <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
          </div>
        </div>

        <!-- Info Section -->
        <div class="settings-section">
          <div class="settings-section-title">About</div>
          <div class="settings-row">
            <div>
              <div class="settings-row-label">Offer Builder</div>
              <div class="settings-row-desc">Create, customize, and share funding offers with clients</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
