<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GREATDANE | Intelligent Underwriting</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-tertiary: #1a1a1a;
      --bg-card: #111111;
      --text-primary: #f5f5f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --tier-a: #22c55e;
      --tier-b: #84cc16;
      --tier-c: #eab308;
      --tier-d: #f97316;
      --tier-e: #ef4444;
      --accent-blue: #3b82f6;
      --accent-purple: #a855f7;
      --border-primary: #27272a;
      --border-secondary: #1f1f22;
      --glow-gold: rgba(234, 179, 8, 0.15);
    }
    
    /* LIGHT MODE */
    body.light-mode {
      --bg-primary: #f8f8f8;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f0f0f0;
      --bg-card: #ffffff;
      --text-primary: #18181b;
      --text-secondary: #52525b;
      --text-muted: #71717a;
      --border-primary: #e4e4e7;
      --border-secondary: #d4d4d8;
      --glow-gold: rgba(234, 179, 8, 0.25);
    }
    body.light-mode .bg-grid {
      background-image: linear-gradient(rgba(234, 179, 8, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.05) 1px, transparent 1px);
    }
    body.light-mode .bg-gradient {
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(234, 179, 8, 0.12), transparent);
    }
    body.light-mode .main-header {
      background: rgba(255, 255, 255, 0.95);
    }
    body.light-mode .login-overlay {
      background: rgba(255, 255, 255, 0.98);
    }
    body.light-mode .loading-overlay {
      background: rgba(255, 255, 255, 0.98);
    }
    body.light-mode .search-input-wrap {
      background: #ffffff;
      border-color: #d4d4d8;
    }
    body.light-mode .search-input-wrap input::placeholder {
      color: #71717a;
    }
    
    /* DARK MODE SEARCH INPUT (explicit for visibility) */
    body:not(.light-mode) .search-input-wrap {
      background: #252525 !important;
      border-color: #555 !important;
    }
    body:not(.light-mode) .search-input-wrap svg {
      color: #999 !important;
    }
    body:not(.light-mode) .search-input-wrap input {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
    }
    body:not(.light-mode) .search-input-wrap input::placeholder {
      color: #999 !important;
      opacity: 1 !important;
      -webkit-text-fill-color: #999 !important;
    }
    
    /* Additional explicit styling for header search */
    #entitySearchInput {
      background: transparent !important;
      border: none !important;
      font-size: 0.85rem;
      width: 100%;
      height: 100%;
    }
    body.light-mode #entitySearchInput {
      color: #18181b !important;
      -webkit-text-fill-color: #18181b !important;
    }
    body.light-mode #entitySearchInput::placeholder {
      color: #71717a !important;
      -webkit-text-fill-color: #71717a !important;
      opacity: 1 !important;
    }
    body:not(.light-mode) #entitySearchInput {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
    }
    body:not(.light-mode) #entitySearchInput::placeholder {
      color: #aaaaaa !important;
      -webkit-text-fill-color: #aaaaaa !important;
      opacity: 1 !important;
    }
    
    /* BLACK/OLED MODE */
    body.black-mode {
      --bg-primary: #000000;
      --bg-secondary: #0a0a0a;
      --bg-tertiary: #141414;
      --bg-card: #0a0a0a;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --border-primary: #1f1f1f;
      --border-secondary: #2a2a2a;
      --glow-gold: rgba(234, 179, 8, 0.3);
    }
    body.black-mode .bg-grid {
      background-image: linear-gradient(rgba(234, 179, 8, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.03) 1px, transparent 1px);
    }
    body.black-mode .bg-gradient {
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(234, 179, 8, 0.08), transparent);
    }
    body.black-mode .main-header {
      background: rgba(0, 0, 0, 0.95);
    }
    body.black-mode .login-overlay {
      background: rgba(0, 0, 0, 0.98);
    }
    body.black-mode .card {
      background: #0a0a0a;
      border-color: #1f1f1f;
    }
    body.black-mode .modal {
      background: #0a0a0a;
      border-color: #1f1f1f;
    }
    
    /* THEME TOGGLE */
    .theme-toggle {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .theme-toggle svg { width: 18px; height: 18px; }
    .theme-toggle .sun-icon { display: none; }
    .theme-toggle .moon-icon { display: block; }
    body.light-mode .theme-toggle .sun-icon { display: block; }
    body.light-mode .theme-toggle .moon-icon { display: none; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    body {
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(234, 179, 8, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.02) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }
    .bg-gradient {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 600px;
      background: radial-gradient(ellipse 80% 50% at 50% 0%, var(--glow-gold), transparent);
      pointer-events: none;
      z-index: 0;
    }

    /* HEADER */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      padding: 0 24px;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-secondary);
      z-index: 100;
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo img,
    .header-logo > svg {
      width: 36px;
      height: 36px;
      border-radius: 10px;
    }
    .header-logo h1 {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: -0.5px;
    }
    .header-logo h1 span { color: var(--text-muted); }
    .header-center {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border-radius: 20px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .header-user svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
    }
    .header-user span {
      font-weight: 500;
      color: var(--text-primary);
    }
    .search-input-wrap {
      display: flex;
      align-items: center;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 50px;
      padding: 4px 4px 4px 14px;
      gap: 8px;
      transition: all 0.2s;
      min-height: 40px;
    }
    .search-input-wrap:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow-gold);
    }
    .search-input-wrap svg:first-child { width: 14px; height: 14px; color: var(--text-muted); flex-shrink: 0; }
    .search-input-wrap input {
      flex: 1;
      min-width: 150px;
      background: transparent !important;
      border: none !important;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .search-input-wrap input:focus { outline: none !important; }
    .search-input-wrap input::placeholder { color: var(--text-muted); opacity: 1; }
    .search-input-wrap input:-webkit-autofill,
    .search-input-wrap input:-webkit-autofill:hover,
    .search-input-wrap input:-webkit-autofill:focus {
      -webkit-text-fill-color: var(--text-primary);
      -webkit-box-shadow: 0 0 0px 1000px transparent inset;
      transition: background-color 5000s ease-in-out 0s;
    }
    .search-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 2px solid var(--accent);
      border-radius: 50%;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .search-btn:hover {
      background: var(--accent);
      color: #000;
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
    }
    .search-btn svg { width: 14px; height: 14px; }
    .btn-primary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background: rgba(234, 179, 8, 0.1);
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(234, 179, 8, 0.2);
    }
    .btn-primary svg { width: 16px; height: 16px; }
    .btn-secondary {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn-secondary svg { width: 14px; height: 14px; }
    
    /* Re-Scrub Button */
    .rescrub-btn {
      padding: 6px 12px;
      font-size: 0.75rem;
      gap: 4px;
    }
    .rescrub-btn:hover {
      background: rgba(234, 179, 8, 0.1);
    }
    .rescrub-btn.loading {
      pointer-events: none;
      opacity: 0.7;
    }
    .rescrub-btn.loading svg {
      animation: spin 1s linear infinite;
    }
    
    .btn-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .btn-icon svg { width: 18px; height: 18px; }

    /* INTEL TABS */
    .intel-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .intel-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      position: relative;
    }
    .intel-tab:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
    }
    .intel-tab.active {
      background: var(--bg-secondary);
      color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .intel-tab svg { width: 14px; height: 14px; }
    .intel-tab .tab-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .intel-tab.active .tab-badge {
      background: rgba(234, 179, 8, 0.2);
      color: var(--accent);
    }
    .intel-tab.has-data .tab-badge {
      background: rgba(34, 197, 94, 0.2);
      color: var(--tier-a);
    }
    .intel-tab.has-caution .tab-badge {
      background: rgba(249, 115, 22, 0.2);
      color: var(--tier-d);
    }
    .intel-tab.has-warning .tab-badge {
      background: rgba(239, 68, 68, 0.2);
      color: var(--tier-e);
    }
    /* Loading state for tabs */
    .intel-tab.loading {
      color: var(--accent);
    }
    .intel-tab.loading::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: tabLoading 1.5s ease-in-out infinite;
    }
    .intel-tab.loading .tab-badge {
      background: rgba(234, 179, 8, 0.3);
      color: var(--accent);
      animation: pulse 1s ease-in-out infinite;
    }
    @keyframes tabLoading {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .intel-panel {
      display: none;
    }
    .intel-panel.active {
      display: block;
    }

    /* LAYOUT */
    .app-container {
      display: flex;
      padding-top: 64px;
      min-height: 100vh;
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-secondary);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
      position: sticky;
      top: 64px;
      transition: width 0.3s ease, min-width 0.3s ease;
      position: relative;
    }
    .sidebar.collapsed {
      width: 0;
      min-width: 0;
      overflow: hidden;
      border-right: none;
    }
    .sidebar-collapse-btn {
      position: absolute;
      top: 50%;
      right: -12px;
      transform: translateY(-50%);
      width: 24px;
      height: 48px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }
    .sidebar-collapse-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }
    .sidebar-collapse-btn svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s;
    }
    .sidebar.collapsed .sidebar-collapse-btn {
      right: -24px;
    }
    .sidebar.collapsed .sidebar-collapse-btn svg {
      transform: rotate(180deg);
    }
    @media (max-width: 900px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 64px;
        z-index: 90;
        width: 260px;
        box-shadow: 4px 0 20px rgba(0,0,0,0.3);
      }
      .sidebar.collapsed {
        width: 0;
        box-shadow: none;
      }
      .sidebar-collapse-btn {
        display: none;
      }
      .sidebar-mobile-toggle {
        display: flex !important;
      }
    }
    .sidebar-mobile-toggle {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
    }
    .sidebar-mobile-toggle svg {
      width: 24px;
      height: 24px;
      color: #000;
    }
    .sidebar-header {
      padding: 24px 16px 16px 16px;
      border-bottom: 1px solid var(--border-secondary);
    }
    .sidebar-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .sidebar-title h2 {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    .sidebar-title button {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.2s;
    }
    .sidebar-title button:hover {
      background: var(--glow-gold);
      border-color: var(--accent);
    }
    .sidebar-title button svg { width: 14px; height: 14px; }
    .sidebar-search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
    }
    .sidebar-search svg { width: 14px; height: 14px; color: var(--text-muted); flex-shrink: 0; }
    .sidebar-search input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.8rem;
      font-family: inherit;
    }
    .sidebar-search input:focus { outline: none; }
    .sidebar-search input::placeholder { color: var(--text-muted); }
    .deal-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px;
    }
    .deal-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      margin-bottom: 4px;
    }
    .deal-item:hover {
      background: var(--bg-tertiary);
      border-left-color: var(--accent);
    }
    .deal-item.active {
      background: var(--bg-tertiary);
      border-left-color: var(--accent);
    }
    .deal-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .deal-item-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
    }
    .deal-item-score {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
    }
    .deal-item-progress {
      height: 4px;
      background: var(--border-primary);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .deal-item-progress-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }
    .deal-item-owner {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .sidebar-footer strong { color: var(--accent); }
    .empty-state {
      text-align: center;
      padding: 30px 16px;
      color: var(--text-muted);
    }
    .empty-state svg { width: 36px; height: 36px; margin-bottom: 10px; opacity: 0.4; }
    .empty-state p { font-size: 0.8rem; }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      min-width: 0;
      padding: 24px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* DASHBOARD */
    .dashboard-view { max-width: 1200px; margin: 0 auto; }
    
    /* DETAIL VIEW - FULL WIDTH */
    .detail-view {
      display: none;
    }
    .detail-view.active { display: block; }
    .dashboard-view .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    .dashboard-view .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 24px 20px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 100px;
    }
    .dashboard-view .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      opacity: 0;
      transition: opacity 0.3s;
    }
    .dashboard-view .metric-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 12px 32px rgba(234, 179, 8, 0.12);
    }
    .dashboard-view .metric-card:hover::before { opacity: 1; }
    .dashboard-view .metric-label {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 8px;
      white-space: nowrap;
    }
    .dashboard-view .metric-value { 
      font-size: 1.5rem; 
      font-weight: 700; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dashboard-view .metric-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; }
    /* 6-column metrics grid specific */
    .dashboard-view .metrics-grid[style*="repeat(6"] .metric-value {
      font-size: 1.25rem;
    }
    .dashboard-view .metrics-grid[style*="repeat(6"] .metric-card {
      padding: 18px 14px;
      min-height: 90px;
    }
    @media (max-width: 1400px) {
      .dashboard-view .metrics-grid[style*="repeat(6"] {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      .dashboard-view .metrics-grid[style*="repeat(6"] .metric-value {
        font-size: 1.4rem;
      }
    }
    @media (max-width: 900px) {
      .dashboard-view .metrics-grid[style*="repeat(6"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 24px;
      position: relative;
    }
    .chart-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      border-radius: 16px 16px 0 0;
    }
    .chart-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-title svg { width: 16px; height: 16px; }
    .chart-container { height: 240px; }

    /* AI Suggestion Buttons */
    .ai-suggestion-btn {
      padding: 8px 14px;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      border-radius: 20px;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ai-suggestion-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      transform: translateY(-2px);
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-family: inherit;
      cursor: pointer;
      transition: color 0.2s;
      margin-bottom: 24px;
    }
    .back-btn:hover { color: var(--text-primary); }
    .back-btn svg { width: 16px; height: 16px; }
    
    /* Main Layout with Right Sidebar */
    .detail-with-sidebar {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
      align-items: start;
    }
    @media (max-width: 1400px) {
      .detail-with-sidebar { grid-template-columns: 1fr 340px; }
    }
    @media (max-width: 1200px) {
      .detail-with-sidebar { grid-template-columns: 1fr 320px; }
    }
    @media (max-width: 900px) {
      .detail-with-sidebar { 
        grid-template-columns: 1fr;
      }
      .right-panels { 
        order: -1; 
        width: 100% !important; 
        position: relative;
        top: 0;
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        padding-bottom: 20px;
      }
      .collapsible-panel {
        width: 100% !important;
        overflow: visible !important;
      }
      .collapsible-panel .panel-body {
        width: 100% !important;
        display: block !important;
        overflow: visible !important;
      }
      .collapsible-panel.collapsed .panel-body {
        display: none !important;
      }
      .mini-dropzone {
        width: 100%;
      }
    }
    
    /* Right Panels Stack */
    .right-panels {
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: 84px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      overflow-x: hidden;
      padding-bottom: 80px;
      width: 100%;
    }
    .right-panels::-webkit-scrollbar {
      width: 8px;
    }
    .right-panels::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 4px;
    }
    .right-panels::-webkit-scrollbar-thumb {
      background: var(--border-primary);
      border-radius: 4px;
      border: 2px solid var(--bg-secondary);
    }
    .right-panels::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    /* Collapsible Panel */
    .collapsible-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      overflow: visible;
      width: 100%;
      box-sizing: border-box;
    }
    .collapsible-panel.collapsed .panel-body {
      display: none;
    }
    .collapsible-panel .panel-body {
      display: block;
      padding: 20px;
      padding-top: 12px;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s;
    }
    .panel-header:hover {
      background: var(--bg-secondary);
    }
    .collapsible-panel:not(.collapsed) .panel-header {
      border-bottom-color: var(--border-secondary);
    }
    .panel-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
    }
    .panel-title svg {
      width: 18px;
      height: 18px;
    }
    .panel-toggle {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .panel-toggle:hover {
      background: var(--accent);
      color: #000;
    }
    .panel-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }
    .collapsible-panel.collapsed .panel-toggle svg {
      transform: rotate(-90deg);
    }
    
    /* Sidebar Action Buttons */
    .sidebar-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 12px;
      font-size: 0.8rem;
      text-align: center;
      min-height: 80px;
    }
    .sidebar-action-btn svg {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
    }
    .sidebar-action-btn span {
      line-height: 1.2;
    }
    .sidebar-action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }
    
    /* Metrics Grid - Compact for sidebar */
    .right-panels .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .right-panels .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .right-panels .metric-card:hover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.15);
    }
    .right-panels .metric-card.highlight {
      background: linear-gradient(135deg, var(--accent) 0%, #e6a800 100%);
      border-color: var(--accent);
    }
    .right-panels .metric-card.highlight .metric-value,
    .right-panels .metric-card.highlight .metric-label {
      color: #000;
    }
    .right-panels .metric-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .right-panels .metric-value.positive { color: var(--tier-a); }
    .right-panels .metric-value.warning { color: var(--accent); }
    .right-panels .metric-value.negative { color: var(--tier-d); }
    .right-panels .metric-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-top: 6px;
    }
    .right-panels .metric-change {
      font-size: 0.7rem;
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }
    .right-panels .metric-change.up { color: var(--tier-a); }
    .right-panels .metric-change.down { color: var(--tier-e); }
    
    /* AI Chat Panel */
    .ai-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 260px;
    }
    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      margin-bottom: 12px;
      max-height: 200px;
      min-height: 140px;
    }
    .ai-message {
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .ai-message.user {
      background: var(--accent);
      color: #000;
      margin-left: 20%;
      border-bottom-right-radius: 4px;
    }
    .ai-message.assistant {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      margin-right: 20%;
      border-bottom-left-radius: 4px;
    }
    .ai-message.system {
      background: transparent;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-align: center;
      padding: 12px;
    }
    .ai-chat-input-row {
      display: flex;
      gap: 8px;
    }
    .ai-chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 20px;
      border: 1px solid var(--border-primary);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    .ai-chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .ai-chat-send {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, background 0.2s;
      flex-shrink: 0;
    }
    .ai-chat-send:hover {
      transform: scale(1.05);
      background: #d4a00a;
    }
    .ai-chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .ai-chat-send svg {
      width: 16px;
      height: 16px;
      color: #000;
    }
    
    /* Mini dropzone */
    .mini-dropzone {
      border: 2px dashed var(--border-primary);
      border-radius: 12px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-secondary);
    }
    .mini-dropzone:hover {
      border-color: var(--accent);
      background: rgba(234,179,8,0.05);
    }
    .mini-dropzone.dragover {
      border-color: var(--accent);
      background: rgba(234,179,8,0.1);
    }
    .mini-dropzone svg {
      width: 36px;
      height: 36px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .mini-dropzone h4 {
      font-size: 0.95rem;
      margin: 0 0 6px 0;
      color: var(--text-primary);
    }
    .mini-dropzone p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.4;
    }
    
    .detail-grid {
      display: flex;
      gap: 20px;
      width: 100%;
    }
    .detail-sidebar {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s ease;
      position: relative;
    }
    .detail-sidebar.collapsed {
      width: 48px;
      min-width: 48px;
      max-width: 48px;
      overflow: hidden;
    }
    .detail-sidebar.collapsed .card {
      opacity: 0;
      pointer-events: none;
    }
    .detail-sidebar.collapsed .sidebar-toggle {
      transform: rotate(180deg);
    }
    .sidebar-toggle {
      position: absolute;
      top: 8px;
      right: -12px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .sidebar-toggle:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .sidebar-toggle svg {
      width: 14px;
      height: 14px;
    }
    .detail-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .detail-main > * {
      width: 100% !important;
      box-sizing: border-box;
    }
    .detail-main .card,
    .detail-main .dropzone,
    .detail-main .info-cards-row,
    .detail-main .table-wrapper {
      width: 100% !important;
    }
    @media (max-width: 1100px) {
      .detail-sidebar { width: 240px; min-width: 240px; max-width: 240px; }
      .detail-sidebar.collapsed { width: 48px; min-width: 48px; max-width: 48px; }
    }
    @media (max-width: 900px) {
      .detail-grid { 
        flex-direction: column;
      }
      .detail-sidebar { 
        order: 1; 
        width: 100% !important; 
        min-width: 100% !important;
        max-width: 100% !important;
      }
      .detail-sidebar.collapsed {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
      }
      .sidebar-toggle { display: none; }
      .detail-main { order: 0; }
    }
    .info-cards-row {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }
    .info-cards-row > .card {
      width: 100% !important;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      box-sizing: border-box;
    }
    .card-accent::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      border-radius: 16px 16px 0 0;
    }
    .card-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title svg { width: 14px; height: 14px; }

    /* SCORE CARD */
    .score-card {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .score-ring {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: conic-gradient(var(--score-color, var(--tier-c)) calc(var(--pct, 0) * 1%), var(--border-primary) 0);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.3s ease, background 0.5s ease;
    }
    .score-ring-inner {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .score-number { 
      font-size: 1.5rem; 
      font-weight: 800;
      transition: transform 0.3s ease;
    }
    .score-number.updating {
      animation: metricPulse 0.5s ease-out;
    }
    .score-info .score-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .score-info .score-tier { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }
    .score-info .score-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }
    
    /* Score Breakdown */
    .score-breakdown {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-secondary);
    }
    .score-breakdown-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 12px;
    }
    .score-component {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    .score-component:last-child { border-bottom: none; }
    .score-comp-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    .score-comp-value {
      font-size: 0.85rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    .score-component.score-total {
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--accent);
      border-bottom: none;
    }
    .score-component.score-total .score-comp-label {
      color: var(--text-primary);
      font-weight: 600;
    }
    .score-component.score-total .score-comp-value {
      color: var(--accent);
      font-size: 1rem;
    }
    .text-negative { color: var(--tier-e); }
    .text-positive { color: var(--tier-a); }
    .text-accent { color: var(--accent); }

    /* FORMS */
    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: block;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .form-input {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.2s;
    }
    .form-input:hover { border-color: var(--border-primary); }
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow-gold);
    }
    .form-input::placeholder { color: var(--text-muted); }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* DATA TABLE */
    .table-wrapper { overflow-x: auto; width: 100%; max-width: 100%; -webkit-overflow-scrolling: touch; }
    .table-wrapper .data-table { min-width: 700px; }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    .data-table th {
      padding: 12px 16px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      text-align: center;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-primary);
    }
    .data-table th:first-child { text-align: left; border-radius: 8px 0 0 0; }
    .data-table th:last-child { border-radius: 0 8px 0 0; }
    .data-table td {
      padding: 12px 16px;
      font-size: 0.85rem;
      text-align: center;
      border-bottom: 1px solid var(--border-secondary);
      color: var(--text-secondary);
      min-width: 90px;
      white-space: nowrap;
    }
    .data-table td:first-child {
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      min-width: 100px;
    }
    .data-table tr:hover td { background: var(--bg-secondary); }
    .table-input {
      width: 100%;
      min-width: 80px;
      padding: 6px;
      background: transparent;
      border: none;
      border-bottom: 1px solid transparent;
      color: inherit;
      font-size: inherit;
      font-weight: 500;
      font-family: inherit;
      text-align: center;
      font-feature-settings: "tnum";
      transition: border-color 0.2s, background 0.3s, transform 0.2s;
      white-space: nowrap;
    }
    .table-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }
    .table-positive { color: var(--tier-a); }
    .table-negative { color: var(--tier-e); }
    .table-warning { color: var(--tier-d); }
    .table-muted { color: var(--text-muted); opacity: 0.8; }

    /* OFFER CALCULATOR */
    .offer-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .offer-tab {
      padding: 10px 20px;
      background: transparent;
      border: 2px solid var(--border-primary);
      border-radius: 50px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .offer-tab:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }
    .offer-tab.active {
      background: transparent;
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent), 0 0 12px rgba(234, 179, 8, 0.2);
    }
    .offer-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .offer-stat {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 16px;
    }
    .offer-stat-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .offer-stat-value { font-size: 1.25rem; font-weight: 700; }
    .slider-group { margin-bottom: 16px; }
    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .slider-label { font-size: 0.75rem; color: var(--text-muted); }
    .slider-value { font-size: 0.85rem; font-weight: 700; color: var(--accent); }
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: var(--border-primary);
      border-radius: 3px;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(234, 179, 8, 0.4);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.5);
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s;
      padding: 24px;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.25s;
    }
    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      background: var(--bg-tertiary);
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; }
    .modal-subtitle { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .modal-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-close:hover {
      border-color: var(--tier-e);
      color: var(--tier-e);
      background: rgba(239, 68, 68, 0.1);
    }
    .modal-close svg { width: 18px; height: 18px; }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
    }

    /* LOGIN OVERLAY */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .login-overlay.hidden { display: none; }
    .hidden { display: none !important; }
    .login-card { 
      width: 100%; 
      max-width: 420px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    .login-header { text-align: center; margin-bottom: 32px; position: relative; }
    .login-logo { position: relative; margin-bottom: 20px; display: inline-block; }
    .login-logo img,
    .login-logo > svg {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      position: relative;
    }
    .login-logo::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(234, 179, 8, 0.3) 0%, transparent 70%);
      filter: blur(20px);
    }
    .login-brand { font-size: 1.75rem; font-weight: 800; letter-spacing: -1px; }
    .login-brand span { color: var(--text-muted); }
    .login-tagline { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .login-error {
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: var(--tier-e);
      font-size: 0.8rem;
      text-align: center;
      display: none;
    }
    .login-error.active { display: block; }
    .login-footer { text-align: center; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border-primary); }
    .login-footer p {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .login-footer .engine { color: var(--accent); margin-top: 8px; }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      z-index: 1500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .loading-content { width: 100%; max-width: 600px; }
    .loading-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-primary);
      margin-bottom: 32px;
    }
    .loading-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .loading-brand img,
    .loading-brand > svg { width: 40px; height: 40px; border-radius: 10px; }
    .loading-brand h2 { font-size: 1.1rem; font-weight: 800; }
    .loading-brand h2 span { color: var(--text-muted); }
    .loading-brand p { font-size: 0.75rem; color: var(--text-muted); }
    .loading-timer { text-align: right; }
    .loading-timer .time {
      font-size: 2rem;
      font-weight: 700;
      font-family: monospace;
      color: var(--accent);
    }
    .loading-timer .label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    .loading-phase { margin-bottom: 32px; }
    .loading-phase h3 { font-size: 1rem; font-weight: 700; margin-bottom: 8px; }
    .loading-phase p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
    .loading-progress {
      height: 4px;
      background: var(--border-primary);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--tier-a));
      border-radius: 2px;
      transition: width 0.3s;
    }
    .loading-footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      font-family: monospace;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    /* FLOATING PROGRESS BAR (non-blocking) */
    .floating-progress {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 360px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1200;
      transform: translateY(150%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .floating-progress.active {
      transform: translateY(0);
      opacity: 1;
    }
    .floating-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .floating-progress-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .floating-progress-title svg {
      width: 18px;
      height: 18px;
      color: var(--accent);
    }
    .floating-progress-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .floating-progress-close:hover {
      color: var(--text-primary);
    }
    .floating-progress-status {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .floating-progress-bar-wrap {
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .floating-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--tier-a));
      border-radius: 3px;
      transition: width 0.5s ease;
      width: 0%;
    }
    .floating-progress-footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .processing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }

    /* UTILITIES */
    .text-positive { color: var(--tier-a); }
    .text-warning { color: var(--tier-d); }
    .text-negative { color: var(--tier-e); }
    .text-accent { color: var(--accent); }
    .text-blue { color: var(--accent-blue); }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }
    .shake { animation: shake 0.4s; }
    
    @keyframes slideInToast {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutToast {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* DROPZONE */
    .dropzone {
      border: 2px dashed var(--border-primary);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-secondary);
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    .dropzone:hover, .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .dropzone.dragover {
      transform: scale(1.01);
      box-shadow: 0 0 0 4px var(--glow-gold);
    }
    .dropzone svg { width: 48px; height: 48px; color: var(--text-muted); margin-bottom: 12px; }
    .dropzone:hover svg { color: var(--accent); }
    .dropzone h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
    .dropzone p { font-size: 0.8rem; color: var(--text-muted); }
    .dropzone .hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 12px; opacity: 0.7; }
    .dropzone-mini {
      border: 2px dashed var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-tertiary);
    }
    .dropzone-mini:hover {
      border-color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .dropzone-mini svg { width: 24px; height: 24px; color: var(--text-muted); margin-bottom: 8px; }
    .dropzone-mini:hover svg { color: var(--accent); }
    .dropzone-mini p { font-size: 0.75rem; color: var(--text-muted); }
  
    /* PROFILE COMPLETENESS + LINEAGE */
    .completion-bar {
      height: 8px;
      background: var(--border-primary);
      border-radius: 999px;
      overflow: hidden;
      margin: 10px 0 12px;
    }
    .completion-bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--tier-e), var(--tier-c), var(--tier-a));
      transition: width 0.25s ease;
    }
    
    /* Scrub Status Indicators */
    .scrub-status-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: var(--bg-secondary);
      border-radius: 6px;
      font-size: 0.7rem;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .scrub-status-item .scrub-icon {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border-primary);
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .scrub-status-item[data-status="pending"] .scrub-icon {
      background: var(--border-primary);
    }
    .scrub-status-item[data-status="loading"] {
      background: rgba(234, 179, 8, 0.1);
      color: var(--accent);
    }
    .scrub-status-item[data-status="loading"] .scrub-icon {
      background: transparent;
      border: 2px solid var(--border-primary);
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    .scrub-status-item[data-status="complete"] .scrub-icon {
      background: var(--tier-a);
    }
    .scrub-status-item[data-status="complete"] {
      color: var(--tier-a);
    }
    .scrub-status-item[data-status="warning"] .scrub-icon {
      background: var(--tier-d);
    }
    .scrub-status-item[data-status="warning"] {
      color: var(--tier-d);
    }
    .scrub-status-item[data-status="error"] .scrub-icon {
      background: var(--tier-e);
    }
    .scrub-status-item[data-status="error"] {
      color: var(--tier-e);
    }
    
    /* WORKFLOW PROGRESS BAR */
    .workflow-progress {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-primary);
      padding: 8px 20px;
      z-index: 99;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: grid;
      grid-template-columns: 60px 1fr 80px;
      align-items: center;
      gap: 16px;
    }
    .workflow-left, .workflow-right {
      flex-shrink: 0;
    }
    .workflow-stages {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
    }
    .workflow-stage {
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.3s;
    }
    .workflow-stage .stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .workflow-stage .stage-name {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .workflow-stage .stage-pct {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--text-muted);
      font-feature-settings: "tnum";
    }
    .workflow-stage .stage-bar {
      height: 4px;
      background: var(--bg-tertiary);
      border-radius: 2px;
      overflow: hidden;
    }
    .workflow-stage .stage-fill {
      height: 100%;
      width: 0%;
      background: var(--border-primary);
      border-radius: 2px;
      transition: width 0.3s ease, background 0.3s;
    }
    /* Pending state */
    .workflow-stage[data-status="pending"] .stage-fill {
      width: 0%;
      background: var(--border-primary);
    }
    /* Loading state - animated progress */
    .workflow-stage[data-status="loading"] .stage-name {
      color: var(--accent);
    }
    .workflow-stage[data-status="loading"] .stage-pct {
      color: var(--accent);
    }
    .workflow-stage[data-status="loading"] .stage-fill {
      background: linear-gradient(90deg, var(--accent), #f59e0b);
      animation: progressPulse 1.5s ease-in-out infinite;
    }
    /* Complete state */
    .workflow-stage[data-status="complete"] .stage-name {
      color: var(--tier-a);
    }
    .workflow-stage[data-status="complete"] .stage-pct {
      color: var(--tier-a);
    }
    .workflow-stage[data-status="complete"] .stage-fill {
      width: 100% !important;
      background: var(--tier-a);
      animation: none;
    }
    /* Warning state */
    .workflow-stage[data-status="warning"] .stage-name {
      color: var(--tier-d);
    }
    .workflow-stage[data-status="warning"] .stage-pct {
      color: var(--tier-d);
    }
    .workflow-stage[data-status="warning"] .stage-fill {
      width: 100% !important;
      background: var(--tier-d);
    }
    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    /* Total progress display */
    .workflow-total {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .workflow-total #workflowTotalPct {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--accent);
      font-feature-settings: "tnum";
      line-height: 1;
    }
    .workflow-total-label {
      font-size: 0.6rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    @keyframes fieldPopulate {
      0% { 
        background: rgba(34, 197, 94, 0.5) !important; 
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.7), 0 0 25px rgba(34, 197, 94, 0.5); 
        transform: scale(1.02);
      }
      30% { 
        background: rgba(34, 197, 94, 0.35) !important; 
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5), 0 0 15px rgba(34, 197, 94, 0.3); 
        transform: scale(1.01);
      }
      100% { 
        background: transparent !important; 
        box-shadow: none; 
        transform: scale(1);
      }
    }
    
    @keyframes cellPopulate {
      0% { 
        background: rgba(34, 197, 94, 0.4) !important; 
        color: var(--tier-a) !important;
      }
      50% { 
        background: rgba(34, 197, 94, 0.2) !important; 
      }
      100% { 
        background: transparent !important; 
        color: inherit !important;
      }
    }
    
    @keyframes valueFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .field-populated {
      animation: fieldPopulate 1.5s ease-out forwards !important;
    }
    
    .cell-populated {
      animation: cellPopulate 1.5s ease-out forwards !important;
    }
    
    .value-updating {
      animation: valueFlash 0.3s ease-in-out 2 !important;
    }
    
    /* Completion success flash */
    @keyframes successFlash {
      0% { 
        opacity: 0; 
        transform: translateY(-20px);
      }
      15% { 
        opacity: 1; 
        transform: translateY(0);
      }
      85% { 
        opacity: 1; 
        transform: translateY(0);
      }
      100% { 
        opacity: 0; 
        transform: translateY(-20px);
      }
    }
    
    .completion-flash {
      position: fixed;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, var(--tier-a), #10b981);
      color: white;
      padding: 12px 28px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
      z-index: 1000;
      animation: successFlash 3s ease-in-out forwards;
    }
    .completion-flash svg {
      width: 20px;
      height: 20px;
    }
    
    /* Table row animation */
    @keyframes rowSlideIn {
      0% { 
        opacity: 0; 
        transform: translateX(-20px);
        background: rgba(234, 179, 8, 0.15);
      }
      50% {
        background: rgba(234, 179, 8, 0.1);
      }
      100% { 
        opacity: 1; 
        transform: translateX(0);
        background: transparent;
      }
    }
    
    .table-row-animate {
      animation: rowSlideIn 0.6s ease-out forwards;
    }
    
    /* Metric value pulse on update */
    .metric-value.updating {
      animation: metricPulse 0.5s ease-out;
    }
    
    @keyframes metricPulse {
      0% { transform: scale(1.1); color: var(--tier-a); }
      100% { transform: scale(1); }
    }
    
    .checklist { display: flex; flex-direction: column; gap: 8px; }
    .check-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .check-item strong { color: var(--text-primary); font-weight: 600; }
    .check-item .tag {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-primary);
      color: var(--text-muted);
      white-space: nowrap;
    }
    .mini-btn-row { display: flex; gap: 10px; margin-top: 14px; }
    .source-links a { color: var(--accent); text-decoration: none; word-break: break-word; display: inline-block; margin-top: 6px; font-size: 0.8rem; }
    .source-links a:hover { text-decoration: underline; }

    /* KPI GRID */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    .kpi-stat {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 14px;
      min-width: 0;
    }
    .kpi-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .kpi-value { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }


    /* DEAL LIST BADGES */
    .deal-item-submeta {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .deal-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-primary);
      background: rgba(255,255,255,0.03);
    }

    /* GRADIENT LOGO */
    .header-logo img,
    .header-logo > svg,
    .login-logo img,
    .login-logo > svg,
    .loading-brand img,
    .loading-brand > svg {
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(234, 179, 8, 0.15);
    }

    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      .main-header {
        padding: 0 12px;
        height: 56px;
      }
      .header-logo h1 {
        font-size: 1rem;
      }
      .header-actions {
        gap: 8px;
      }
      .search-input-wrap {
        display: none;
      }
      .btn-primary {
        padding: 8px 12px;
        font-size: 0.75rem;
      }
      .btn-primary svg {
        width: 14px;
        height: 14px;
      }
      .btn-icon {
        width: 36px;
        height: 36px;
      }
      .theme-toggle {
        width: 36px;
        height: 36px;
      }
      .app-container {
        flex-direction: column;
        padding-top: 56px;
      }
      .sidebar {
        width: 100%;
        min-width: 100%;
        height: auto;
        max-height: 300px;
        position: relative;
        top: 0;
        border-right: none;
        border-bottom: 1px solid var(--border-secondary);
        overflow-y: auto;
      }
      .sidebar.collapsed {
        display: none;
      }
      .sidebar-header {
        padding: 12px;
      }
      .deal-list {
        max-height: 180px;
        overflow-y: auto;
      }
      .sidebar-footer {
        padding: 10px 12px;
      }
      .main-content {
        padding: 12px;
      }
      .dashboard-view .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        grid-auto-rows: 1fr;
        gap: 12px;
      }
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .dashboard-view .metric-card {
        padding: 14px;
      }
      .dashboard-view .metric-value {
        font-size: 1.25rem;
      }
      .card {
        padding: 16px;
      }
      .dropzone {
        padding: 24px 16px;
      }
      .dropzone h3 {
        font-size: 0.9rem;
      }
      .offer-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .data-table {
        min-width: 500px;
      }
      .form-row {
        grid-template-columns: 1fr;
        gap: 0;
      }
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .dashboard-view .metrics-grid {
        grid-template-columns: 1fr;
      }
      .sidebar {
        max-height: 250px;
        overflow-y: auto;
      }
      .deal-list {
        max-height: 150px;
        overflow-y: auto;
      }
      .offer-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .offer-stat {
        padding: 12px;
      }
    }

  
    /* SHARE MODE (Approval Send / Share) */
    .gd-share-overlay {
      position: fixed;
      inset: 0;
      z-index: 3000;
      overflow-y: auto;
      padding: 24px;
      background: rgba(0,0,0,0.88);
    }
    .gd-share-shell {
      width: 100%;
      max-width: 980px;
      margin: 0 auto;
    }
    .gd-share-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }
    .gd-share-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .gd-share-logo {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255,255,255,0.95);
      padding: 6px;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .gd-share-company {
      font-weight: 900;
      letter-spacing: 0.02em;
      font-size: 1.05rem;
      color: white;
    }
    .gd-share-mode {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.72);
      font-weight: 600;
    }
    .gd-share-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    }
    .gd-share-card-header {
      padding: 22px 22px 16px;
      background: linear-gradient(135deg, rgba(234,179,8,0.16), rgba(0,0,0,0));
      border-bottom: 1px solid var(--border-secondary);
    }
    .gd-share-greeting {
      font-size: 1.4rem;
      font-weight: 900;
      margin-bottom: 6px;
      color: var(--text-primary);
    }
    .gd-share-message {
      color: var(--text-muted);
      font-weight: 500;
      line-height: 1.4;
    }
    .gd-share-expiry {
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      border: 1px solid var(--border-secondary);
      background: var(--bg-secondary);
      color: var(--text-muted);
    }
    .gd-share-tabs {
      padding: 14px 22px 0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .gd-share-tab {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-secondary);
      background: var(--bg-secondary);
      color: var(--text-muted);
      font-size: 0.72rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.15s;
    }
    .gd-share-tab:hover { border-color: var(--border-primary); }
    .gd-share-tab.active {
      border-color: var(--accent);
      color: var(--text-primary);
      box-shadow: 0 0 0 3px var(--glow-gold);
    }
    .gd-share-grid {
      padding: 18px 22px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    @media (min-width: 860px) {
      .gd-share-grid { grid-template-columns: repeat(3, 1fr); }
    }
    .gd-share-stat {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 14px;
      padding: 14px;
    }
    .gd-share-stat-label {
      font-size: 0.65rem;
      font-weight: 800;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }
    .gd-share-stat-value {
      font-size: 1.05rem;
      font-weight: 900;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .gd-share-actions {
      padding: 0 22px 18px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .gd-share-contact {
      padding: 0 22px 18px;
      color: var(--text-muted);
      font-size: 0.85rem;
      line-height: 1.35;
    }
    .gd-share-disclaimer {
      padding: 14px 22px 22px;
      border-top: 1px solid var(--border-secondary);
      color: var(--text-muted);
      font-size: 0.78rem;
      line-height: 1.45;
    }
    .gd-share-footer {
      text-align: center;
      margin-top: 14px;
      color: rgba(255,255,255,0.55);
      font-size: 0.75rem;
    }
    .gd-share-iso-panel {
      margin: 0 22px 18px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--border-secondary);
      background: var(--bg-secondary);
    }
    .gd-iso-title {
      font-weight: 900;
      letter-spacing: 0.02em;
      margin-bottom: 10px;
      color: var(--text-primary);
    }
    .gd-iso-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .gd-iso-metric {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 10px;
    }
    .gd-iso-metric-label {
      font-size: 0.65rem;
      font-weight: 800;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }
    .gd-iso-metric-value {
      font-size: 0.95rem;
      font-weight: 900;
      color: var(--text-primary);
    }
    .gd-iso-range { width: 100%; }
    .gd-inline-help {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--text-muted);
      line-height: 1.35;
    }
    .gd-share-link-card {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border-secondary);
      background: var(--bg-secondary);
      margin-top: 12px;
    }
    .gd-share-link-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .gd-share-history-item {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .gd-share-history-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .gd-share-history-meta .t1 { font-weight: 800; font-size: 0.8rem; color: var(--text-primary); }
    .gd-share-history-meta .t2 { font-size: 0.74rem; color: var(--text-muted); }

    /* ========== DEAL STATUS PIPELINE ========== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .status-badge.status-new { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    .status-badge.status-review { background: rgba(168, 85, 247, 0.15); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3); }
    .status-badge.status-docs { background: rgba(234, 179, 8, 0.15); color: #eab308; border: 1px solid rgba(234, 179, 8, 0.3); }
    .status-badge.status-approved { background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
    .status-badge.status-funded { background: rgba(34, 197, 94, 0.25); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.5); }
    .status-badge.status-declined { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .status-badge.status-renewal { background: rgba(6, 182, 212, 0.15); color: #06b6d4; border: 1px solid rgba(6, 182, 212, 0.3); }
    
    .status-dropdown {
      position: relative;
      display: inline-block;
    }
    .status-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 50;
      min-width: 160px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 6px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      display: none;
    }
    .status-dropdown-menu.active { display: block; }
    .status-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.15s;
    }
    .status-dropdown-item:hover { background: var(--bg-tertiary); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    
    /* ========== BATCH SELECTION ========== */
    .batch-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border-primary);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .batch-checkbox:hover { border-color: var(--accent); }
    .batch-checkbox.checked {
      background: var(--accent);
      border-color: var(--accent);
    }
    .batch-checkbox.checked svg { display: block; }
    .batch-checkbox svg { display: none; width: 12px; height: 12px; color: #000; }
    
    .batch-toolbar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: 16px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 10px 40px rgba(234, 179, 8, 0.2);
      z-index: 100;
      animation: slideUp 0.2s ease;
    }
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .batch-toolbar.hidden { display: none; }
    .batch-count { font-weight: 700; color: var(--accent); }
    
    /* ========== DOCUMENT CHECKLIST ========== */
    .doc-checklist { display: flex; flex-direction: column; gap: 8px; }
    .doc-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      transition: all 0.2s;
    }
    .doc-item:hover { border-color: var(--border-primary); }
    .doc-item.complete { border-color: var(--tier-a); background: rgba(34, 197, 94, 0.05); }
    .doc-item.expired { border-color: var(--tier-e); background: rgba(239, 68, 68, 0.05); }
    .doc-status {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .doc-status.pending { background: var(--border-primary); color: var(--text-muted); }
    .doc-status.complete { background: var(--tier-a); color: #fff; }
    .doc-status.expired { background: var(--tier-e); color: #fff; }
    .doc-status svg { width: 14px; height: 14px; }
    .doc-info { flex: 1; min-width: 0; }
    .doc-name { font-weight: 600; font-size: 0.85rem; }
    .doc-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .doc-actions { display: flex; gap: 6px; }
    
    /* ========== STACKING DETECTION ========== */
    .stacking-alert {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.25);
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .stacking-alert-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--tier-e);
      flex-shrink: 0;
    }
    .stacking-alert-header svg { width: 18px; height: 18px; }
    .stacking-alert-details {
      font-size: 0.75rem;
      color: var(--text-secondary);
      flex: 1;
    }
    .stacking-alert-badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
    }
    .stacking-alert-badge.high { background: var(--tier-e); color: white; }
    .stacking-alert-badge.medium { background: var(--tier-d); color: white; }
    .stacking-alert-badge.low { background: var(--tier-c); color: white; }
    .stacking-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(239, 68, 68, 0.1);
      font-size: 0.8rem;
    }
    .stacking-item:last-child { border-bottom: none; }
    
    /* ========== ANALYTICS DASHBOARD ========== */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 1200px) { .analytics-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .analytics-grid { grid-template-columns: 1fr; } }
    
    .analytics-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
    }
    .analytics-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .analytics-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    .analytics-value {
      font-size: 1.75rem;
      font-weight: 800;
      margin-top: 4px;
    }
    .analytics-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .analytics-change.up { color: var(--tier-a); }
    .analytics-change.down { color: var(--tier-e); }
    
    .chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .chart-title { font-weight: 700; font-size: 1rem; }
    .chart-filters { display: flex; gap: 8px; }
    .chart-filter {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-secondary);
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }
    .chart-filter:hover, .chart-filter.active {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* ========== TEAM/USER MANAGEMENT ========== */
    .team-member {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .team-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #000;
      flex-shrink: 0;
    }
    .team-info { flex: 1; }
    .team-name { font-weight: 600; font-size: 0.9rem; }
    .team-role { font-size: 0.75rem; color: var(--text-muted); }
    .role-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .role-badge.admin { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .role-badge.manager { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .role-badge.underwriter { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .role-badge.iso { background: rgba(234, 179, 8, 0.15); color: #eab308; }
    
    /* ========== RENEWAL MANAGEMENT ========== */
    .renewal-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .renewal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .renewal-progress {
      height: 8px;
      background: var(--border-primary);
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }
    .renewal-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tier-a), var(--accent));
      transition: width 0.3s;
    }
    .renewal-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .renewal-stat { text-align: center; }
    .renewal-stat-value { font-size: 1.1rem; font-weight: 700; }
    .renewal-stat-label { font-size: 0.7rem; color: var(--text-muted); }
    .rtr-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
    }
    .rtr-badge.ready { background: var(--tier-a); color: #fff; }
    .rtr-badge.soon { background: var(--accent); color: #000; }
    .rtr-badge.not-ready { background: var(--border-primary); color: var(--text-muted); }
    
    /* ========== CREDIT PULL ========== */
    .credit-pull-card {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 20px;
    }
    .credit-score-display {
      text-align: center;
      padding: 20px;
    }
    .credit-score-value {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--tier-a), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .credit-score-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
    .credit-factors { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px; }
    .credit-factor {
      padding: 12px;
      background: var(--bg-card);
      border-radius: 8px;
    }
    .credit-factor-label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; }
    .credit-factor-value { font-weight: 600; }
    
    /* ========== KEYBOARD SHORTCUTS MODAL ========== */
    .shortcuts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    .shortcut-key {
      min-width: 32px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .shortcut-desc { font-size: 0.85rem; color: var(--text-secondary); }

</style>
</head>
<body class="light-mode">
  <div class="bg-grid"></div>
  <div class="bg-gradient"></div>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="GREATDANE" style="width: 80px; height: 80px; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);">
        </div>
        <h1 class="login-brand">GREAT<span>DANE</span></h1>
        <p class="login-tagline">Intelligent Underwriting Platform</p>
      </div>
      <div class="login-form">
        <div class="login-error" id="loginError">Invalid credentials. Password must end with !#</div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="loginUser" placeholder="admin@greatdane.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="loginPass" placeholder="Enter password">
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label class="form-label">Login As</label>
          <select class="form-input" id="loginRole">
            <option value="underwriter">Underwriter</option>
            <option value="manager">Manager</option>
            <option value="iso">ISO Partner</option>
          </select>
        </div>
        <button class="btn-primary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="handleLogin()">Sign In</button>
      </div>
      <div class="login-footer">
        <p>Secure System Access Only</p>
        <p class="engine">Powered by ABLESCORE Engine v4.2</p>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-header">
        <div class="loading-brand">
          <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="GREATDANE" style="width: 40px; height: 40px; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);">
          <div>
            <h2>GREAT<span>DANE</span></h2>
            <p>Analyzing Documents</p>
          </div>
        </div>
        <div class="loading-timer">
          <div class="time" id="loadingTimer">00:45</div>
          <div class="label">Time Remaining</div>
        </div>
      </div>
      <div class="loading-phase">
        <h3 id="loadingTitle">Initializing Analysis</h3>
        <p id="loadingDesc">Please wait while we process your documents...</p>
      </div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loadingBar" style="width: 0%;"></div>
      </div>
      <div class="loading-footer">
        <span>ENGINE: DANESCORE v4.2</span>
        <span id="loadingPercent">0% COMPLETE</span>
      </div>
    </div>
  </div>

  <!-- FLOATING PROGRESS BAR (deprecated - using sidebar now) -->
  <div class="floating-progress" id="floatingProgress" style="display: none !important;">
    <div class="floating-progress-header">
      <div class="floating-progress-title">
        <span class="processing-dot"></span>
        <span id="floatingProgressTitle">Processing...</span>
      </div>
      <button class="floating-progress-close" onclick="hideFloatingProgress()" title="Minimize">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="floating-progress-status" id="floatingProgressStatus">Analyzing documents in the background...</div>
    <div class="floating-progress-bar-wrap">
      <div class="floating-progress-bar" id="floatingProgressBar"></div>
    </div>
    <div class="floating-progress-footer">
      <span id="floatingProgressPhase">Starting...</span>
      <span id="floatingProgressPercent">0%</span>
    </div>
  </div>

  <!-- HEADER -->
  <header class="main-header">
    <div class="header-logo">
      <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="GREATDANE" style="width: 36px; height: 36px; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);">
      <h1>GREAT<span>DANE</span></h1>
    </div>
    <div class="header-center">
      <div class="search-input-wrap" style="width: 320px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #888;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="entitySearchInput" placeholder="Search business name..." autocomplete="off" style="color: inherit;">
        <button class="search-btn" onclick="createDealAndSearch()" title="Create Deal & Search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
      <button class="btn-primary" onclick="document.getElementById('headerFileUpload').click()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
        Quick Scrub
      </button>
      <input type="file" id="headerFileUpload" style="display: none;" accept=".pdf,image/*" multiple onchange="handleHeaderQuickScrub(event)">
    </div>
    <div class="header-actions">
      <button class="btn-icon" onclick="openAnalyticsModal()" title="Analytics (A)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      </button>
      <button class="btn-icon" onclick="openRenewalsModal()" title="Renewals (R)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-9-9"/><path d="M21 3v9h-9"/></svg>
      </button>
      <button class="btn-icon" onclick="openTeamModal()" title="Team (T)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      </button>
      <button class="btn-icon" id="isoPortalBtn" onclick="showISOPortal()" title="ISO Portal" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      </button>
      <div class="header-user">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span id="headerUsername">User</span>
        <span id="headerRole" style="font-size: 0.65rem; color: var(--accent); margin-left: 4px;"></span>
      </div>
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <button class="btn-icon" onclick="openShortcutsModal()" title="Keyboard Shortcuts (?)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"/></svg>
      </button>
      <button class="btn-icon" onclick="openSettingsModal()" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
  </header>

  <!-- WORKFLOW PROGRESS BAR -->
  <div id="workflowProgress" class="workflow-progress" style="display: none;">
    <div class="workflow-left">
      <button onclick="showDashboard()" style="background: none; border: none; color: var(--text-muted); font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Back
      </button>
    </div>
    <div class="workflow-stages">
      <div class="workflow-stage" id="wfExtraction" data-status="pending" data-progress="0">
        <div class="stage-header">
          <span class="stage-name">Extraction</span>
          <span class="stage-pct">0%</span>
        </div>
        <div class="stage-bar"><div class="stage-fill"></div></div>
      </div>
      <div class="workflow-stage" id="wfEntity" data-status="pending" data-progress="0">
        <div class="stage-header">
          <span class="stage-name">Entity</span>
          <span class="stage-pct">0%</span>
        </div>
        <div class="stage-bar"><div class="stage-fill"></div></div>
      </div>
      <div class="workflow-stage" id="wfResearch" data-status="pending" data-progress="0">
        <div class="stage-header">
          <span class="stage-name">Research</span>
          <span class="stage-pct">0%</span>
        </div>
        <div class="stage-bar"><div class="stage-fill"></div></div>
      </div>
      <div class="workflow-stage" id="wfBackground" data-status="pending" data-progress="0">
        <div class="stage-header">
          <span class="stage-name">Background</span>
          <span class="stage-pct">0%</span>
        </div>
        <div class="stage-bar"><div class="stage-fill"></div></div>
      </div>
      <div class="workflow-stage" id="wfFootprint" data-status="pending" data-progress="0">
        <div class="stage-header">
          <span class="stage-name">Footprint</span>
          <span class="stage-pct">0%</span>
        </div>
        <div class="stage-bar"><div class="stage-fill"></div></div>
      </div>
      <div class="workflow-stage" id="wfDebt" data-status="pending" data-progress="0">
        <div class="stage-header">
          <span class="stage-name">Debt</span>
          <span class="stage-pct">0%</span>
        </div>
        <div class="stage-bar"><div class="stage-fill"></div></div>
      </div>
    </div>
    <div class="workflow-right">
      <div class="workflow-total">
        <span id="workflowTotalPct">0%</span>
        <span class="workflow-total-label">Complete</span>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="dealsSidebar">
      <button class="sidebar-collapse-btn" onclick="toggleSidebar()" title="Collapse Sidebar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <div class="sidebar-header">
        <div class="sidebar-title">
          <h2>Deal Pipeline</h2>
          <button onclick="addNewDeal()" title="Add New Deal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <div class="sidebar-search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="dealSearch" placeholder="Search deals..." oninput="filterDeals(this.value)">
        </div>
      </div>
      <div class="deal-list" id="dealList">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <p>No deals yet. Upload bank statements to get started.</p>
        </div>
      </div>
      <div class="sidebar-footer">
        <span>Total in Pipeline</span>
        <strong id="pipelineTotal">0</strong>
      </div>
    </aside>
    
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-mobile-toggle" onclick="toggleSidebar()" title="Toggle Deal Pipeline">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    </button>

    <!-- MAIN -->
    <main class="main-content">
      <!-- DASHBOARD -->
      <div class="dashboard-view" id="dashboardView">
        
        <!-- AI Command Center -->
        <div class="ai-command-center" style="margin-bottom: 24px; display: grid; grid-template-columns: 1fr 280px; gap: 16px;">
          <div style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-a), var(--accent));"></div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <svg viewBox="0 0 100 100" style="width: 36px; height: 36px;">
                <defs>
                  <linearGradient id="aiPlanetGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#eab308"/>
                    <stop offset="100%" style="stop-color:#ca8a04"/>
                  </linearGradient>
                </defs>
                <ellipse cx="50" cy="50" rx="40" ry="10" fill="none" stroke="rgba(234,179,8,0.5)" stroke-width="2" transform="rotate(-15 50 50)"/>
                <circle cx="50" cy="50" r="22" fill="url(#aiPlanetGrad)"/>
              </svg>
              <div>
                <div style="font-size: 1rem; font-weight: 700; color: var(--text-primary);">AblesAI Command Center</div>
                <div style="font-size: 0.75rem; color: var(--text-muted);">Ask anything about your deals, metrics, or generate custom charts</div>
              </div>
            </div>
            <div style="display: flex; gap: 10px;">
              <div style="flex: 1; position: relative;">
                <input type="text" id="aiCommandInput" class="form-input" placeholder="e.g., 'Show me a chart of deals by score tier' or 'What's my average revenue?'" style="width: 100%; padding: 14px 20px; font-size: 0.95rem; border-radius: 12px; border-color: var(--accent); background: var(--bg-primary);" onkeydown="if(event.key==='Enter') runAICommand()">
              </div>
              <button class="btn-primary" id="aiCommandBtn" onclick="runAICommand()" style="padding: 14px 24px; border-radius: 12px; font-size: 0.9rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Ask AI
              </button>
            </div>
            <div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">
              <button class="ai-suggestion-btn" onclick="runAICommandWith('Show deals by score tier as a pie chart')">Score Distribution</button>
              <button class="ai-suggestion-btn" onclick="runAICommandWith('What is my total revenue and how does it break down?')">Revenue Breakdown</button>
              <button class="ai-suggestion-btn" onclick="runAICommandWith('Show me a bar chart of monthly deal volume')">Deal Trends</button>
              <button class="ai-suggestion-btn" onclick="runAICommandWith('Which deals are highest risk and why?')">Risk Analysis</button>
              <button class="ai-suggestion-btn" onclick="runAICommandWith('Summarize my portfolio health')">Portfolio Health</button>
            </div>
          </div>
          
          <!-- Quick Scrub Drop Zone -->
          <div id="dashboardQuickScrubZone" 
               style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 2px dashed var(--accent); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; cursor: pointer; transition: all 0.3s; min-height: 100%;"
               onclick="document.getElementById('dashboardQuickScrubInput').click()"
               ondragover="event.preventDefault(); this.style.borderColor='var(--tier-a)'; this.style.background='rgba(234,179,8,0.1)';"
               ondragleave="this.style.borderColor='var(--accent)'; this.style.background='linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%)';"
               ondrop="handleDashboardQuickScrubDrop(event)">
            <input type="file" id="dashboardQuickScrubInput" multiple accept=".pdf,.png,.jpg,.jpeg,.gif,.bmp,.tiff" style="display: none;" onchange="handleDashboardQuickScrubFiles(this.files)">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <path d="M12 18v-6"/>
              <path d="M9 15l3-3 3 3"/>
            </svg>
            <div style="font-weight: 600; color: var(--accent); font-size: 0.95rem; margin-bottom: 4px;">Quick Scrub</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); text-align: center;">Drop bank statements, applications, or credit reports here</div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">PDF, PNG, JPG supported</div>
          </div>
        </div>
          
        <!-- AI Response Area -->
        <div id="aiResponseArea" style="display: none; margin-bottom: 24px; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" style="width: 18px; height: 18px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; font-size: 0.9rem;">AI Response</div>
                <div id="aiResponseQuery" style="font-size: 0.75rem; color: var(--text-muted);"></div>
              </div>
            </div>
            <button onclick="closeAIResponse()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div id="aiResponseLoading" style="display: none; text-align: center; padding: 40px;">
            <div style="width: 48px; height: 48px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
            <p style="color: var(--text-muted);">Analyzing your data...</p>
          </div>
          <div id="aiResponseContent" style="display: none;">
            <div id="aiResponseText" style="font-size: 0.95rem; line-height: 1.7; color: var(--text-secondary); margin-bottom: 20px;"></div>
            <div id="aiResponseChart" style="display: none; height: 300px; margin-bottom: 20px;">
              <canvas id="aiGeneratedChart"></canvas>
            </div>
            <div id="aiResponseInsights" style="display: none;"></div>
          </div>
        </div>
        
        <div class="metrics-grid">
          <div class="metric-card" onclick="openMetricModal('revenue')">
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value text-positive" id="dashRevenue">$0</div>
            <div class="metric-hint">Click for breakdown</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('score')">
            <div class="metric-label">Avg ABLESCORE</div>
            <div class="metric-value text-accent" id="dashScore">0</div>
            <div class="metric-hint">Click for distribution</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('approval')">
            <div class="metric-label">Approval Rate</div>
            <div class="metric-value text-blue" id="dashApproval">0%</div>
            <div class="metric-hint">Click for trends</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('risk')">
            <div class="metric-label">High Risk Deals</div>
            <div class="metric-value text-negative" id="dashRisk">0</div>
            <div class="metric-hint">Click for details</div>
          </div>
        </div>

        <div class="metrics-grid" style="grid-template-columns: repeat(6, 1fr); margin-bottom: 24px;">
          <div class="metric-card" onclick="openMetricModal('deals')">
            <div class="metric-label">Total Deals</div>
            <div class="metric-value" id="dashDeals">0</div>
            <div class="metric-hint">Pipeline count</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('avg_monthly_revenue')">
            <div class="metric-label">Avg Monthly Rev</div>
            <div class="metric-value text-positive" id="dashAvgMonthlyRev">$0</div>
            <div class="metric-hint">Per deal</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('fico')">
            <div class="metric-label">Avg FICO</div>
            <div class="metric-value" id="dashAvgFico" style="color: var(--tier-b);">0</div>
            <div class="metric-hint">Owner credit</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('deposits')">
            <div class="metric-label">Total Deposits</div>
            <div class="metric-value text-positive" id="dashTotalDeposits">$0</div>
            <div class="metric-hint">All deals</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('nsf')">
            <div class="metric-label">Total NSFs</div>
            <div class="metric-value" id="dashTotalNsf" style="color: var(--tier-d);">0</div>
            <div class="metric-hint">Red flags</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('completion')">
            <div class="metric-label">Avg Completion</div>
            <div class="metric-value text-accent" id="dashCompletion">0%</div>
            <div class="metric-hint">Data quality</div>
          </div>
        </div>
        
        <!-- Analytics Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
          <div class="chart-card" style="padding: 20px;">
            <div class="chart-title" style="margin-bottom: 12px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
              Score Tiers
            </div>
            <div id="tierBreakdown" style="display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 50px; font-size: 0.75rem; font-weight: 600; color: var(--tier-a);">Tier A</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="tierABar" style="height: 100%; background: var(--tier-a); width: 0%;"></div></div>
                <span id="tierACount" style="width: 30px; text-align: right; font-size: 0.8rem; font-weight: 600;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 50px; font-size: 0.75rem; font-weight: 600; color: var(--tier-b);">Tier B</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="tierBBar" style="height: 100%; background: var(--tier-b); width: 0%;"></div></div>
                <span id="tierBCount" style="width: 30px; text-align: right; font-size: 0.8rem; font-weight: 600;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 50px; font-size: 0.75rem; font-weight: 600; color: var(--tier-c);">Tier C</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="tierCBar" style="height: 100%; background: var(--tier-c); width: 0%;"></div></div>
                <span id="tierCCount" style="width: 30px; text-align: right; font-size: 0.8rem; font-weight: 600;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 50px; font-size: 0.75rem; font-weight: 600; color: var(--tier-d);">Tier D</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="tierDBar" style="height: 100%; background: var(--tier-d); width: 0%;"></div></div>
                <span id="tierDCount" style="width: 30px; text-align: right; font-size: 0.8rem; font-weight: 600;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 50px; font-size: 0.75rem; font-weight: 600; color: var(--tier-e);">Tier E</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="tierEBar" style="height: 100%; background: var(--tier-e); width: 0%;"></div></div>
                <span id="tierECount" style="width: 30px; text-align: right; font-size: 0.8rem; font-weight: 600;">0</span>
              </div>
            </div>
          </div>
          
          <div class="chart-card" style="padding: 20px;">
            <div class="chart-title" style="margin-bottom: 12px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
              FICO Distribution
            </div>
            <div id="ficoBreakdown" style="display: flex; flex-direction: column; gap: 8px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 60px; font-size: 0.75rem; color: var(--text-muted);">750+</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="fico750Bar" style="height: 100%; background: var(--tier-a); width: 0%;"></div></div>
                <span id="fico750Count" style="width: 30px; text-align: right; font-size: 0.8rem;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 60px; font-size: 0.75rem; color: var(--text-muted);">700-749</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="fico700Bar" style="height: 100%; background: var(--tier-b); width: 0%;"></div></div>
                <span id="fico700Count" style="width: 30px; text-align: right; font-size: 0.8rem;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 60px; font-size: 0.75rem; color: var(--text-muted);">650-699</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="fico650Bar" style="height: 100%; background: var(--tier-c); width: 0%;"></div></div>
                <span id="fico650Count" style="width: 30px; text-align: right; font-size: 0.8rem;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 60px; font-size: 0.75rem; color: var(--text-muted);">600-649</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="fico600Bar" style="height: 100%; background: var(--tier-d); width: 0%;"></div></div>
                <span id="fico600Count" style="width: 30px; text-align: right; font-size: 0.8rem;">0</span>
              </div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="width: 60px; font-size: 0.75rem; color: var(--text-muted);">&lt;600</span>
                <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;"><div id="fico599Bar" style="height: 100%; background: var(--tier-e); width: 0%;"></div></div>
                <span id="fico599Count" style="width: 30px; text-align: right; font-size: 0.8rem;">0</span>
              </div>
            </div>
          </div>
          
          <div class="chart-card" style="padding: 20px;">
            <div class="chart-title" style="margin-bottom: 12px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              Top Industries
            </div>
            <div id="industryBreakdown" style="display: flex; flex-direction: column; gap: 8px;">
              <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No industry data yet</div>
            </div>
          </div>
        </div>
        
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
              Score Distribution
            </div>
            <div class="chart-container"><canvas id="scoreChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
              Deal Activity
            </div>
            <div class="chart-container"><canvas id="volumeChart"></canvas></div>
          </div>
        </div>

        <div class="charts-grid" style="margin-top: 24px;">
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 14l3-3 4 4 6-6"/></svg>
              Revenue Trend
            </div>
            <div class="chart-container"><canvas id="revenueTrendChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
              Data Completeness
            </div>
            <div class="chart-container"><canvas id="completionChart"></canvas></div>
          </div>
        </div>
        
        <!-- Additional Analytics Row -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 24px;">
          <!-- Portfolio Health Score -->
          <div class="chart-card" style="padding: 20px;">
            <div class="chart-title" style="margin-bottom: 16px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
              Portfolio Health
            </div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
              <div style="position: relative; width: 100px; height: 100px;">
                <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                  <circle cx="18" cy="18" r="15.9" fill="none" stroke="var(--bg-tertiary)" stroke-width="3"/>
                  <circle id="portfolioHealthRing" cx="18" cy="18" r="15.9" fill="none" stroke="var(--tier-c)" stroke-width="3" stroke-dasharray="0 100" stroke-linecap="round"/>
                </svg>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                  <div id="portfolioHealthScore" style="font-size: 1.5rem; font-weight: 700;">--</div>
                  <div style="font-size: 0.6rem; color: var(--text-muted);">HEALTH</div>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--tier-a);"></div>
                  <span style="font-size: 0.75rem; color: var(--text-muted);">Strong: <span id="healthStrong">0</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--tier-c);"></div>
                  <span style="font-size: 0.75rem; color: var(--text-muted);">Moderate: <span id="healthModerate">0</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--tier-e);"></div>
                  <span style="font-size: 0.75rem; color: var(--text-muted);">At Risk: <span id="healthAtRisk">0</span></span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Risk Heatmap -->
          <div class="chart-card" style="padding: 20px;">
            <div class="chart-title" style="margin-bottom: 16px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              Risk Matrix
            </div>
            <div id="riskMatrix" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;">
              <!-- Will be populated by JS -->
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 0.65rem; color: var(--text-muted);">
              <span>Low Score</span>
              <span></span>
              <span>High Score</span>
            </div>
          </div>
          
          <!-- Recent Activity -->
          <div class="chart-card" style="padding: 20px;">
            <div class="chart-title" style="margin-bottom: 12px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              Recent Activity
            </div>
            <div id="recentActivity" style="display: flex; flex-direction: column; gap: 10px; max-height: 180px; overflow-y: auto;">
              <div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No recent activity</div>
            </div>
          </div>
        </div>
        
        <!-- Performance Metrics Row -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 24px;">
          <div class="chart-card" style="padding: 16px; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--tier-a);" id="dealsThisMonth">0</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Deals This Month</div>
            <div style="font-size: 0.8rem; color: var(--tier-b); margin-top: 4px;" id="dealsMonthTrend">--</div>
          </div>
          <div class="chart-card" style="padding: 16px; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="avgProcessTime">--</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Avg Process Time</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">days to decision</div>
          </div>
          <div class="chart-card" style="padding: 16px; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700;" id="conversionRate">0%</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Conversion Rate</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">approved / total</div>
          </div>
          <div class="chart-card" style="padding: 16px; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: var(--tier-b);" id="avgDealSize">$0</div>
            <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Avg Deal Size</div>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">monthly revenue</div>
          </div>
        </div>
      </div>

      <!-- DETAIL -->
      <div class="detail-view" id="detailView">
        <!-- Stacking Alert Container -->
        <div id="stackingAlertContainer"></div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <button class="back-btn" onclick="showDashboard()" style="margin-bottom: 0;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
            Back to Dashboard
          </button>
          <!-- Ables AI Branding -->
          <div style="display: flex; align-items: center; gap: 10px;">
            <svg viewBox="0 0 100 100" style="width: 32px; height: 32px;">
              <defs>
                <linearGradient id="planetGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#eab308"/>
                  <stop offset="100%" style="stop-color:#ca8a04"/>
                </linearGradient>
                <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#eab308;stop-opacity:0.3"/>
                  <stop offset="50%" style="stop-color:#eab308;stop-opacity:0.8"/>
                  <stop offset="100%" style="stop-color:#eab308;stop-opacity:0.3"/>
                </linearGradient>
              </defs>
              <ellipse cx="50" cy="50" rx="45" ry="12" fill="none" stroke="url(#ringGradient)" stroke-width="3" transform="rotate(-20 50 50)"/>
              <circle cx="50" cy="50" r="25" fill="url(#planetGradient)"/>
              <ellipse cx="50" cy="50" rx="45" ry="12" fill="none" stroke="url(#ringGradient)" stroke-width="3" transform="rotate(-20 50 50)" clip-path="url(#frontRing)"/>
              <path d="M35 42 Q50 38 65 42" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
              <circle cx="40" cy="55" r="4" fill="rgba(0,0,0,0.2)"/>
            </svg>
            <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;">Powered by ABLESAI</span>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-secondary" onclick="document.getElementById('rescrubUploadMain').click()" style="padding: 8px 14px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Re-Scrub
            </button>
            <input type="file" id="rescrubUploadMain" style="display: none;" accept=".pdf,image/*" multiple onchange="handleReScrub(event)">
            <button class="btn-secondary" onclick="fullReScrub()" style="padding: 8px 14px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
              Full Re-Scrub
            </button>
          </div>
        </div>
        
        <!-- Main Layout with Right Sidebar -->
        <div class="detail-with-sidebar">
          <!-- Main Content -->
          <div class="detail-main">
            <!-- INTEL CENTER - Main Navigation -->
            <div class="card" id="intelCenter">
              <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
                  Business Intelligence Center
                </div>
              </div>
              
              <!-- Custom Query Search -->
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <input type="text" id="customResearchQuery" class="form-input" placeholder="Ask any question about this business..." style="flex: 1; font-size: 0.85rem; border-color: var(--accent);" onkeydown="if(event.key==='Enter') runCustomQuery()">
                <button class="btn-secondary" id="customQueryBtn" style="padding: 8px 16px; white-space: nowrap; border-color: var(--accent); color: var(--accent);" onclick="runCustomQuery()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  Search
                </button>
              </div>
              
              <!-- Inline Query Results -->
              <div id="inlineQueryResults" style="display: none; margin-top: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-primary);">
                <div id="inlineQueryLoading" style="display: none; text-align: center; padding: 20px;">
                  <div style="width: 32px; height: 32px; border: 3px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px;"></div>
                  <p style="font-size: 0.85rem; color: var(--text-muted);">Researching...</p>
                </div>
                <div id="inlineQueryContent" style="display: none;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div id="inlineQueryQuestion" style="font-weight: 600; font-size: 0.85rem; color: var(--accent); flex: 1;"></div>
                    <button onclick="closeInlineQuery()" style="background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                  </div>
                  <div id="inlineQueryAnswer" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;"></div>
                  <div id="inlineQueryFindings" style="margin-top: 12px;"></div>
                  <div id="inlineQuerySources" style="margin-top: 12px; font-size: 0.75rem; color: var(--text-muted);"></div>
                </div>
              </div>
              
              <!-- Intel Tabs - BUSINESS first -->
              <div class="intel-tabs" style="margin-top: 16px;">
                <button class="intel-tab active" onclick="switchIntelTab('business')" id="tabBusiness">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                  BUSINESS
                  <span class="tab-badge has-data" id="badgeBusiness">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('research')" id="tabResearch">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  RESEARCH
                  <span class="tab-badge" id="badgeResearch">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('clear')" id="tabClear">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  BACKGROUND
                  <span class="tab-badge" id="badgeClear">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('footprint')" id="tabFootprint">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                  FOOTPRINT
                  <span class="tab-badge" id="badgeFootprint">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('debt')" id="tabDebt">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                  DEBT
                  <span class="tab-badge" id="badgeDebt">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('credit')" id="tabCredit">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  CREDIT
                  <span class="tab-badge" id="badgeCredit">--</span>
                </button>
              </div>
              
              <!-- ==================== BUSINESS PANEL ==================== -->
              <div class="intel-panel active" id="panelBusiness">
                <!-- Business Info - Full Width -->
                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                      Business Info
                    </div>
                    <button class="btn-secondary rescrub-btn" onclick="rescrubSection('business')" title="Re-verify business information">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                      Re-Scrub
                    </button>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Legal Name</label>
                      <input type="text" class="form-input" id="editLegalName" placeholder="Business Name" oninput="updateDealField('businessName', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">DBA</label>
                      <input type="text" class="form-input" id="editDba" placeholder="Doing Business As" oninput="updateDealField('dba', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Industry</label>
                      <input type="text" class="form-input" id="editIndustry" placeholder="Industry" oninput="updateDealField('industry', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Time in Business</label>
                      <input type="text" class="form-input" id="editTib" placeholder="e.g., 5 years" oninput="updateDealField('tib', this.value)">
                    </div>
                    <div class="form-group" style="grid-column: span 2; margin-bottom: 0;">
                      <label class="form-label">Address</label>
                      <input type="text" class="form-input" id="editAddress" placeholder="Business Address" oninput="updateDealField('address', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Incorp. State</label>
                      <input type="text" class="form-input" id="editStateCode" placeholder="e.g., DE" maxlength="2" oninput="updateDealField('stateCode', this.value.toUpperCase())">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Entity Type</label>
                      <input type="text" class="form-input" id="editEntityType" placeholder="LLC / Corp / LP" oninput="updateDealField('entityType', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Formation Date</label>
                      <input type="date" class="form-input" id="editFormationDate" oninput="updateFormationDate(this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Status</label>
                      <input type="text" class="form-input" id="editEntityStatus" placeholder="Active / Inactive" oninput="updateDealField('entityStatus', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Website</label>
                      <input type="text" class="form-input" id="editWebsite" placeholder="https://..." oninput="updateDealField('website', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Phone</label>
                      <input type="text" class="form-input" id="editPhone" placeholder="(###) ###-####" oninput="updateDealField('phone', this.value)">
                    </div>
                  </div>
                </div>
                
                <!-- Owner Info - Full Width -->
                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                      Owner Info
                    </div>
                    <button class="btn-secondary rescrub-btn" onclick="rescrubSection('owner')" title="Re-verify owner information">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                      Re-Scrub
                    </button>
                  </div>
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="grid-column: span 2; margin-bottom: 0;">
                      <label class="form-label">Owner Name</label>
                      <input type="text" class="form-input" id="editOwnerName" placeholder="Owner Name" oninput="updateDealField('ownerName', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">FICO Score</label>
                      <div style="display: flex; gap: 8px;">
                        <input type="number" class="form-input" id="editFico" placeholder="FICO" oninput="updateDealField('fico', this.value); recalculateScore();" style="flex: 1;">
                        <button class="btn-secondary" style="padding: 8px 12px; white-space: nowrap;" onclick="openCreditPullModal()" title="Pull Credit">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 12a9 9 0 11-9-9"/><path d="M21 3v9h-9"/></svg>
                        </button>
                      </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Ownership %</label>
                      <input type="number" class="form-input" id="editOwnership" placeholder="%" oninput="updateDealField('ownership', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Owner Email</label>
                      <input type="text" class="form-input" id="editOwnerEmail" placeholder="name@email.com" oninput="updateDealField('ownerEmail', this.value)">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                      <label class="form-label">Owner Phone</label>
                      <input type="text" class="form-input" id="editOwnerPhone" placeholder="(###) ###-####" oninput="updateDealField('ownerPhone', this.value)">
                    </div>
                  </div>
                  <!-- Action Buttons -->
                  <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="btn-secondary" style="flex: 1; padding: 10px; font-size: 0.8rem;" onclick="openDocsModal()">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                      Documents
                    </button>
                    <button class="btn-primary" style="flex: 1; padding: 10px; font-size: 0.8rem;" onclick="openCreditPullModal()">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      Pull Credit
                    </button>
                  </div>
                </div>
                
                <!-- Entity Verification - Full Width -->
                <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                      Entity Verification
                    </div>
                    <button class="btn-secondary rescrub-btn" onclick="rescrubSection('entity')" title="Re-verify entity with Secretary of State">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                      Re-Scrub
                    </button>
                  </div>
                  <div id="entityVerifySummary2" style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                    Enter business name to verify entity.
                  </div>
                  <div class="source-links" id="entityVerifySources2" style="margin-top: 10px;"></div>
                  <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="btn-secondary" style="flex: 1; padding: 8px; font-size: 0.8rem;" onclick="openEntityForCurrentDeal()">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                      View Full Report
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- ==================== RESEARCH PANEL ==================== -->
              <div class="intel-panel" id="panelResearch">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary rescrub-btn" onclick="rescrubSection('research')" title="Re-run deep research analysis">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Re-Scrub Research
                  </button>
                </div>
                
                <!-- Streaming Text Container -->
                <div id="researchStreamContainer" style="display: none; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), var(--bg-secondary)); border: 1px solid var(--accent); border-radius: 12px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 10px; height: 10px; background: var(--accent); border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
                    <span style="font-size: 0.8rem; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Live Research Feed</span>
                  </div>
                  <div id="researchStreamText" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', 'Monaco', monospace; white-space: pre-wrap; word-break: break-word; max-height: 200px; overflow-y: auto; line-height: 1.5;"></div>
                </div>
                
                <!-- Risk Rating Banner -->
                <div id="researchRiskBanner" style="border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; background: var(--bg-secondary);">
                  <div id="researchRiskBadge" style="width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary);">
                    <span id="researchRiskLetter" style="font-size: 1.5rem; font-weight: 800; color: var(--text-muted);">?</span>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em;">Risk Rating</div>
                    <div id="researchRiskLabel" style="font-size: 1.25rem; font-weight: 700;">Click "Run Research" to analyze</div>
                    <div id="researchConfidence" style="font-size: 0.8rem; color: var(--text-secondary);">Confidence: 0%</div>
                  </div>
                </div>
                <!-- Company Overview -->
                <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Company Overview
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.85rem;">
                    <div><span style="color: var(--text-muted);">Legal Name:</span> <span id="researchLegalName">N/A</span></div>
                    <div><span style="color: var(--text-muted);">DBA:</span> <span id="researchDba">N/A</span></div>
                    <div><span style="color: var(--text-muted);">Entity Type:</span> <span id="researchEntityType">N/A</span></div>
                    <div><span style="color: var(--text-muted);">State:</span> <span id="researchState">N/A</span></div>
                    <div><span style="color: var(--text-muted);">Formation:</span> <span id="researchFormation">N/A</span></div>
                    <div><span style="color: var(--text-muted);">Status:</span> <span id="researchStatus">N/A</span></div>
                  </div>
                </div>
                <!-- Operations & Financials Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                      Operations
                    </div>
                    <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
                      <div><span style="color: var(--text-muted);">Industry:</span> <span id="researchIndustry">N/A</span></div>
                      <div><span style="color: var(--text-muted);">NAICS:</span> <span id="researchNaics">N/A</span></div>
                      <div id="researchDescription" style="color: var(--text-secondary); margin-top: 4px;"></div>
                    </div>
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                      Financials
                    </div>
                    <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
                      <div><span style="color: var(--text-muted);">Revenue Est:</span> <span id="researchRevenue">N/A</span></div>
                      <div><span style="color: var(--text-muted);">Employees:</span> <span id="researchEmployees">N/A</span></div>
                      <div><span style="color: var(--text-muted);">Years in Business:</span> <span id="researchYears">N/A</span></div>
                      <div><span style="color: var(--text-muted);">Trend:</span> <span id="researchTrend">N/A</span></div>
                    </div>
                  </div>
                </div>
                <!-- Red Flags Section -->
                <div id="researchRedFlagsSection" style="display: none; margin-top: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px;">
                  <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Red Flags (<span id="researchRedFlagCount">0</span>)
                  </div>
                  <ul id="researchRedFlagsList" style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);"></ul>
                </div>
                <!-- Compliance & Legal Row -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Compliance & Legal
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 0.85rem;">
                    <div>
                      <div style="color: var(--text-muted); margin-bottom: 4px;">Lawsuits</div>
                      <div id="researchLawsuits" style="font-weight: 600;">0 Found</div>
                    </div>
                    <div>
                      <div style="color: var(--text-muted); margin-bottom: 4px;">Liens</div>
                      <div id="researchLiens" style="font-weight: 600;">0 Found</div>
                    </div>
                    <div>
                      <div style="color: var(--text-muted); margin-bottom: 4px;">UCC Filings</div>
                      <div id="researchUcc" style="font-weight: 600;">0 Found</div>
                    </div>
                  </div>
                </div>
                <!-- Reputation Row -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    Reputation
                  </div>
                  <div style="display: flex; gap: 32px; font-size: 0.85rem;">
                    <div>
                      <div style="color: var(--text-muted);">BBB Rating:</div>
                      <div id="researchBbb" style="font-weight: 600; font-size: 1.1rem;">N/A</div>
                    </div>
                    <div>
                      <div style="color: var(--text-muted);">Reviews:</div>
                      <div id="researchReviews" style="font-weight: 600;">N/A</div>
                    </div>
                  </div>
                </div>
                <!-- Summary -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px;">Summary</div>
                  <p id="researchSummary" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">No research data yet. Click "Run Research" to analyze this business.</p>
                </div>
                <!-- Sources -->
                <div id="researchSourcesSection" style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted);">
                  <div style="font-weight: 600; margin-bottom: 8px;">Sources (<span id="researchSourceCount">0</span>)</div>
                  <div id="researchSourcesList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
                <!-- Custom Query Result -->
                <div id="customQuerySection" style="display: none; margin-top: 24px; border-top: 1px solid var(--border-primary); padding-top: 24px;">
                  <div style="font-weight: 700; font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: var(--accent);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Custom Research
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div id="customQueryQuestion" style="font-weight: 600; margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem;"></div>
                    <div id="customQueryAnswer" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;"></div>
                    <div id="customQuerySources" style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted);"></div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== BACKGROUND PANEL ==================== -->
              <div class="intel-panel" id="panelClear">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary rescrub-btn" onclick="rescrubSection('background')" title="Re-run background check">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Re-Scrub Background
                  </button>
                </div>
                
                <!-- Streaming Container -->
                <div id="backgroundStreamContainer" style="display: none; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), var(--bg-secondary)); border: 1px solid var(--tier-a); border-radius: 12px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 10px; height: 10px; background: var(--tier-a); border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
                    <span style="font-size: 0.8rem; color: var(--tier-a); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Live Background Feed</span>
                  </div>
                  <div id="backgroundStreamText" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', 'Monaco', monospace; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; line-height: 1.5;"></div>
                </div>
                
                <div id="clearReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Background Check Data</p>
                    <p style="font-size: 0.85rem;">Click "Run Background Check" to search UCC filings, liens, judgments, and court records.</p>
                  </div>
                </div>
                <div id="clearReportSection" style="display: none;">
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>UCC Filings</span><span id="clearUccCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearUccList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Liens</span><span id="clearLiensCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearLiensList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Judgments</span><span id="clearJudgmentsCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearJudgmentsList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Court Records</span><span id="clearCourtCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearCourtList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Bankruptcies</span><span id="clearBankruptcyCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearBankruptcyList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Owner/Principal Background</div>
                    <div id="clearOwnerBackground" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== FOOTPRINT PANEL ==================== -->
              <div class="intel-panel" id="panelFootprint">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary rescrub-btn" onclick="rescrubSection('footprint')" title="Re-run digital footprint scan">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Re-Scrub Footprint
                  </button>
                </div>
                
                <!-- Streaming Container -->
                <div id="footprintStreamContainer" style="display: none; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), var(--bg-secondary)); border: 1px solid #06b6d4; border-radius: 12px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 10px; height: 10px; background: #06b6d4; border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
                    <span style="font-size: 0.8rem; color: #06b6d4; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Live Footprint Feed</span>
                  </div>
                  <div id="footprintStreamText" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', 'Monaco', monospace; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; line-height: 1.5;"></div>
                </div>
                
                <div id="footprintReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Digital Footprint Data</p>
                    <p style="font-size: 0.85rem;">Click "Re-Scrub Footprint" to search web presence, social media, and reviews.</p>
                  </div>
                </div>
                <div id="footprintReportSection" style="display: none;">
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Web Presence</div><div id="footprintWeb" style="font-size: 0.85rem;"></div></div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Social Media</div><div id="footprintSocial" style="font-size: 0.85rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;"></div></div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Reviews Summary</div><div id="footprintReviews" style="font-size: 0.85rem;"></div></div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">News & Mentions</div><div id="footprintNews" style="font-size: 0.85rem;"></div></div>
                </div>
              </div>
              
              <!-- ==================== DEBT PANEL ==================== -->
              <div class="intel-panel" id="panelDebt">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary rescrub-btn" onclick="rescrubSection('debt')" title="Re-run debt analysis">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Re-Scrub Debt
                  </button>
                </div>
                
                <!-- Streaming Container -->
                <div id="debtStreamContainer" style="display: none; margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), var(--bg-secondary)); border: 1px solid var(--tier-e); border-radius: 12px;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                    <div style="width: 10px; height: 10px; background: var(--tier-e); border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
                    <span style="font-size: 0.8rem; color: var(--tier-e); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Live Debt Analysis Feed</span>
                  </div>
                  <div id="debtStreamText" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', 'Monaco', monospace; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; line-height: 1.5;"></div>
                </div>
                
                <div id="debtReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Debt Analysis Data</p>
                    <p style="font-size: 0.85rem;">Click "Run Debt Analysis" to analyze bank statements for debt obligations.</p>
                  </div>
                </div>
                <div id="debtReportSection" style="display: none;">
                  <!-- Debt Summary Cards -->
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-secondary) 100%); border-radius: 12px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.2);">
                      <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em;">Total Est. Debt</div>
                      <div id="debtTotal" style="font-size: 1.4rem; font-weight: 800; color: var(--tier-e);">$0</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, rgba(249, 115, 22, 0.1) 0%, var(--bg-secondary) 100%); border-radius: 12px; text-align: center; border: 1px solid rgba(249, 115, 22, 0.2);">
                      <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em;">Monthly Payments</div>
                      <div id="debtMonthly" style="font-size: 1.4rem; font-weight: 800; color: var(--tier-d);">$0</div>
                    </div>
                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; text-align: center; border: 1px solid var(--border-secondary);">
                      <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em;">Active Positions</div>
                      <div id="debtPositions" style="font-size: 1.4rem; font-weight: 800;">0</div>
                    </div>
                  </div>
                  
                  <!-- Debt Obligations Table -->
                  <div style="margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                      Identified Debt Obligations
                    </div>
                    <div class="table-wrapper" style="border-radius: 10px; overflow: hidden; border: 1px solid var(--border-secondary);">
                      <table class="data-table" style="font-size: 0.8rem; margin: 0;">
                        <thead><tr><th>Type</th><th>Creditor</th><th>Est. Balance</th><th>Payment</th><th>Filed Date</th><th>Status</th></tr></thead>
                        <tbody id="debtTableBody"><tr><td colspan="6" style="text-align: center; padding: 24px; color: var(--text-muted);">No debt obligations identified</td></tr></tbody>
                      </table>
                    </div>
                  </div>
                  
                  <!-- Large Transactions Table -->
                  <div>
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      Large Transactions Identified
                    </div>
                    <div class="table-wrapper" style="border-radius: 10px; overflow: hidden; border: 1px solid var(--border-secondary);">
                      <table class="data-table" style="font-size: 0.8rem; margin: 0;">
                        <thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Analysis</th></tr></thead>
                        <tbody id="largeTransactionsBody"><tr><td colspan="5" style="text-align: center; padding: 24px; color: var(--text-muted);">No large transactions identified</td></tr></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== CREDIT PANEL ==================== -->
              <div class="intel-panel" id="panelCredit">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary rescrub-btn" onclick="document.getElementById('creditReportUpload').click()" title="Upload or re-analyze credit report">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Re-Scrub Credit
                  </button>
                  <input type="file" id="creditReportUpload" style="display: none;" accept=".pdf,image/*" onchange="handleCreditReportUpload(event)">
                </div>
                <div id="creditReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Credit Report Data</p>
                    <p style="font-size: 0.85rem; margin-bottom: 16px;">Upload a credit report PDF to populate this section.</p>
                    <button class="btn-primary" onclick="document.getElementById('creditReportUpload').click()" style="padding: 10px 24px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                      Upload Credit Report
                    </button>
                  </div>
                </div>
                <div id="creditReportSection" style="display: none;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <span id="creditReportBureau" style="font-size: 0.75rem; font-weight: 500; background: var(--bg-tertiary); padding: 4px 12px; border-radius: 20px;"></span>
                    <button class="btn-secondary" onclick="document.getElementById('creditReportUpload2').click()" style="padding: 6px 12px; font-size: 0.75rem;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                      Re-Upload
                    </button>
                    <input type="file" id="creditReportUpload2" style="display: none;" accept=".pdf,image/*" onchange="handleCreditReportUpload(event)">
                  </div>
                  <div style="margin-bottom: 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                    <div id="creditScoreFico" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">FICO</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreVantage" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Vantage</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreExperian" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Experian</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreEquifax" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Equifax</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreTransunion" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">TransUnion</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Account Summary</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; font-size: 0.85rem;">
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Total Accounts</div><div id="creditTotalAccounts" style="font-weight: 600; font-size: 1.1rem;">0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Open</div><div id="creditOpenAccounts" style="font-weight: 600; font-size: 1.1rem; color: var(--tier-a);">0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Delinquent</div><div id="creditDelinquentAccounts" style="font-weight: 600; font-size: 1.1rem;">0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Derogatory</div><div id="creditDerogatoryAccounts" style="font-weight: 600; font-size: 1.1rem;">0</div></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; font-size: 0.85rem; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Total Balance</div><div id="creditTotalBalance" style="font-weight: 600; font-size: 1.1rem;">$0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Credit Limit</div><div id="creditTotalLimit" style="font-weight: 600; font-size: 1.1rem;">$0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Utilization</div><div id="creditUtilization" style="font-weight: 600; font-size: 1.1rem;">0%</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Monthly Payment</div><div id="creditMonthlyPayment" style="font-weight: 600; font-size: 1.1rem;">$0</div></div>
                    </div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Payment History</div>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; font-size: 0.85rem;">
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">On-Time</div><div id="creditOnTime" style="font-weight: 700; font-size: 1.25rem; color: var(--tier-a);">0%</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">30 Days</div><div id="creditLate30" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">60 Days</div><div id="creditLate60" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">90+ Days</div><div id="creditLate90" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Collections</div><div id="creditCollections" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Charge-Offs</div><div id="creditChargeOffs" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                    </div>
                  </div>
                  <div id="creditPublicRecordsSection" style="display: none; margin-bottom: 16px; padding: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      Public Records
                    </div>
                    <div id="creditPublicRecordsList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Credit Inquiries (24 months)</span><span id="creditInquiryCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="creditInquiriesList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Tradelines</span><span id="creditTradelineCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div class="table-wrapper"><table class="data-table" style="font-size: 0.75rem;"><thead><tr><th>Creditor</th><th>Type</th><th>Opened</th><th>Limit</th><th>Balance</th><th>Payment</th><th>Status</th></tr></thead><tbody id="creditTradelinesBody"><tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No tradelines available</td></tr></tbody></table></div>
                  </div>
                  <div id="creditCollectionsSection" style="display: none; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; color: var(--tier-e);"><span>Collection Accounts</span><span id="creditCollectionsCount" style="background: rgba(239, 68, 68, 0.2); color: var(--tier-e); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div class="table-wrapper"><table class="data-table" style="font-size: 0.75rem;"><thead><tr><th>Creditor</th><th>Original Creditor</th><th>Balance</th><th>Date Opened</th><th>Status</th></tr></thead><tbody id="creditCollectionsBody"><tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">No collections</td></tr></tbody></table></div>
                  </div>
                  <div id="creditEmploymentSection" style="display: none; padding: 16px; background: var(--bg-secondary); border-radius: 12px; margin-top: 16px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                      Employment Information
                    </div>
                    <div id="creditEmploymentInfo" style="font-size: 0.85rem;"></div>
                  </div>
                  <div id="creditWarningsSection" style="display: none; padding: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; margin-top: 16px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      Warning Messages
                    </div>
                    <div id="creditWarningsList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div id="creditScoreReasonSection" style="display: none; padding: 16px; background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; margin-top: 16px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--accent); display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                      Score Information
                    </div>
                    <div id="creditScoreReasonText" style="font-size: 0.85rem;"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-title" style="justify-content: space-between;">
                <span style="display: flex; align-items: center; gap: 8px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                  Monthly Financials
                </span>
                <div style="display: flex; gap: 8px;">
                  <button class="btn-secondary" onclick="openBankAnalysisModal()" title="View Bank Statement Analysis">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    View Analysis
                  </button>
                  <button class="btn-secondary" onclick="document.getElementById('rescrubUpload').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Add Documents
                  </button>
                </div>
                <input type="file" id="rescrubUpload" style="display: none;" accept=".pdf,image/*" multiple onchange="handleReScrub(event)">
              </div>
              <div id="financialTablesContainer">
                <div class="table-wrapper">
                  <table class="data-table" style="min-width: 900px;">
                    <thead>
                      <tr>
                        <th style="min-width: 90px;">Month</th>
                        <th style="min-width: 110px;">Revenue</th>
                        <th style="min-width: 100px;">Avg Daily Bal</th>
                        <th style="min-width: 80px;">Dep Count</th>
                        <th style="min-width: 100px;">End Balance</th>
                        <th style="min-width: 100px;">Debt Svc</th>
                        <th style="min-width: 60px;">NSF</th>
                      </tr>
                    </thead>
                    <tbody id="financialTableBody">
                      <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No financial data. Upload bank statements to begin.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 15l4-4 3 3 6-6"/></svg>
                Cash Flow Insights
              </div>
              
              <!-- Main Deposits vs Withdrawals Chart -->
              <div class="chart-container" style="height: 220px;"><canvas id="dealCashflowChart"></canvas></div>
              
              <!-- Additional Charts Row -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px;">
                <!-- Net Cash Flow Chart -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                  <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px;">Net Cash Flow</div>
                  <div class="chart-container" style="height: 120px;"><canvas id="netCashflowChart"></canvas></div>
                </div>
                <!-- Debt Service Chart -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                  <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px;">Debt Service Ratio</div>
                  <div class="chart-container" style="height: 120px;"><canvas id="debtServiceChart"></canvas></div>
                </div>
              </div>
              
              <div class="kpi-grid" id="dealKpis"></div>
            </div>
            
            <!-- Business Metrics Section -->
            <div class="card">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                Business Metrics
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <!-- Revenue Trend Chart -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                  <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px;">Revenue Trend</div>
                  <div class="chart-container" style="height: 150px;"><canvas id="revenueChart"></canvas></div>
                </div>
                <!-- Balance Trend Chart -->
                <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
                  <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 12px;">Balance Trend</div>
                  <div class="chart-container" style="height: 150px;"><canvas id="balanceChart"></canvas></div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px;">
                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Avg Daily Bal</div>
                  <div id="metricAvgDailyBal2" style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">--</div>
                </div>
                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Dep Count/Mo</div>
                  <div id="metricDepCount" style="font-size: 1.25rem; font-weight: 700;">--</div>
                </div>
                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Revenue Stability</div>
                  <div id="metricStability" style="font-size: 1.25rem; font-weight: 700;">--</div>
                </div>
                <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Growth Rate</div>
                  <div id="metricGrowth" style="font-size: 1.25rem; font-weight: 700;">--</div>
                </div>
              </div>
            </div>
            
            <div class="card card-accent">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>
                Offer Calculator
              </div>
              <div class="offer-tabs">
                <button class="offer-tab active" data-offer="conservative" onclick="setOfferTab('conservative')">Conservative</button>
                <button class="offer-tab" data-offer="moderate" onclick="setOfferTab('moderate')">Moderate</button>
                <button class="offer-tab" data-offer="aggressive" onclick="setOfferTab('aggressive')">Aggressive</button>
              </div>
              <div class="offer-grid">
                <div class="offer-stat">
                  <div class="offer-stat-label">Funding Amount</div>
                  <div class="offer-stat-value text-positive" id="offerAmount">$0</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label">Factor Rate</div>
                  <div class="offer-stat-value text-accent" id="offerFactor">1.00</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label">Payback Amount</div>
                  <div class="offer-stat-value" id="offerPayback">$0</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label">Term (Days)</div>
                  <div class="offer-stat-value" id="offerTerm">0</div>
                </div>
              </div>
              
              <!-- Payment Frequency Toggle -->
              <div style="margin: 16px 0;">
                <div class="slider-label" style="margin-bottom: 8px;">Payment Frequency</div>
                <div class="offer-tabs" style="width: fit-content;">
                  <button class="offer-tab active" id="freqDaily" onclick="setPaymentFrequency('daily')">Daily</button>
                  <button class="offer-tab" id="freqWeekly" onclick="setPaymentFrequency('weekly')">Weekly</button>
                </div>
              </div>
              
              <div class="offer-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="offer-stat">
                  <div class="offer-stat-label" id="paymentLabel">Daily Payment</div>
                  <div class="offer-stat-value text-accent" id="offerPayment">$0</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label" id="paymentsCountLabel"># of Payments</div>
                  <div class="offer-stat-value" id="offerPaymentsCount">0</div>
                </div>
              </div>
              
              <div class="slider-group">
                <div class="slider-header">
                  <span class="slider-label">Position Multiplier</span>
                  <span class="slider-value" id="positionVal">1.0x</span>
                </div>
                <input type="range" id="positionSlider" min="0.5" max="2" step="0.1" value="1" oninput="updateOffer()">
              </div>
              <div class="slider-group">
                <div class="slider-header">
                  <span class="slider-label">Holdback %</span>
                  <span class="slider-value" id="holdbackVal">15%</span>
                </div>
                <input type="range" id="holdbackSlider" min="10" max="25" step="1" value="15" oninput="updateOffer()">
              </div>
              
              <!-- ISO Preview Section -->
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-primary);">
                <div class="card-title" style="margin-bottom: 12px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  ISO Commission Calculator
                </div>
                
                <!-- Buy/Sell Rate Sliders -->
                <div class="form-group" style="margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <label class="form-label" style="margin: 0;">Buy Rate (Lender)</label>
                    <span class="form-label" style="margin: 0; color: var(--accent); font-weight: 700;" id="buyRateDisplay">1.25</span>
                  </div>
                  <input type="range" class="slider-input" id="isoBuyRate" min="1.10" max="1.50" step="0.01" value="1.25" oninput="updateBuySellRates()">
                  <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted);">
                    <span>1.10</span><span>1.30</span><span>1.50</span>
                  </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <label class="form-label" style="margin: 0;">Sell Rate (ISO)</label>
                    <span class="form-label" style="margin: 0; color: var(--tier-a); font-weight: 700;" id="sellRateDisplay">1.35</span>
                  </div>
                  <input type="range" class="slider-input" id="isoSellRate" min="1.15" max="1.60" step="0.01" value="1.35" oninput="updateBuySellRates()">
                  <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--text-muted);">
                    <span>1.15</span><span>1.35</span><span>1.60</span>
                  </div>
                </div>
                
                <!-- Spread Display -->
                <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Spread (ISO Margin)</span>
                    <span style="font-size: 1.1rem; font-weight: 800; color: var(--accent);" id="rateSpreadDisplay">10 pts</span>
                  </div>
                </div>
                
                <div class="form-row" style="gap: 12px;">
                  <div class="form-group" style="flex: 1;">
                    <label class="form-label">Add'l Points</label>
                    <input type="number" class="form-input" id="isoPoints" value="0" min="0" max="500" step="25" oninput="updateBuySellRates()">
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <label class="form-label">Commission %</label>
                    <input type="number" class="form-input" id="isoCommission" value="0" min="0" max="20" step="0.5" oninput="updateBuySellRates()">
                  </div>
                </div>
                
                <div class="offer-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 12px; gap: 8px;">
                  <div class="offer-stat">
                    <div class="offer-stat-label">Spread Profit</div>
                    <div class="offer-stat-value text-positive" id="isoSpreadProfit">$0</div>
                  </div>
                  <div class="offer-stat">
                    <div class="offer-stat-label">Points + Comm</div>
                    <div class="offer-stat-value" id="isoPointsCommAmt">$0</div>
                  </div>
                </div>
                <div class="offer-grid" style="grid-template-columns: 1fr; margin-top: 8px;">
                  <div class="offer-stat" style="background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.05)); border: 1px solid rgba(234, 179, 8, 0.3);">
                    <div class="offer-stat-label">Total ISO Compensation</div>
                    <div class="offer-stat-value text-accent" style="font-size: 1.3rem;" id="isoTotalComp">$0</div>
                  </div>
                </div>
              </div>
              
              <!-- Generate Offer Button -->
              <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                
                <button class="btn-primary" style="flex: 1; min-width: 120px; justify-content: center;" onclick="openApprovalShareModal()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                  </svg>
                  Share
                </button>
<button class="btn-secondary" style="flex: 1; min-width: 120px; justify-content: center;" onclick="copyOfferToClipboard()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  Copy
                </button>
                <button class="btn-secondary" style="flex: 1; min-width: 120px; justify-content: center;" onclick="generateOfferPDF()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  PDF
                </button>
                <button class="btn-secondary" style="flex: 1; min-width: 120px; justify-content: center;" onclick="shareToToolbox()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                  ISO Calc
                </button>
              </div>
            </div>
          </div>
          
          <!-- RIGHT PANELS - Sidebar -->
          <div class="right-panels">
            <!-- ABLESCORE & METRICS PANEL -->
            <div class="collapsible-panel" id="panelScore">
              <div class="panel-header" onclick="togglePanel('panelScore')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                  ABLESCORE
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <!-- Score Ring -->
                <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 16px; padding: 4px 0;">
                  <div class="score-ring" id="scoreRing" style="--pct: 0; --score-color: var(--tier-c); flex-shrink: 0; width: 70px; height: 70px;">
                    <div class="score-ring-inner"><span class="score-number" id="mainScore" style="font-size: 1.4rem;">0</span></div>
                  </div>
                  <div>
                    <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">ABLESCORE v4.2</div>
                    <div style="font-size: 1.1rem; font-weight: 700;" id="scoreTier">Analyzing...</div>
                  </div>
                </div>
                
                <!-- Metrics Grid - Now Clickable -->
                <div class="metrics-grid">
                  <div class="metric-card highlight" onclick="openBankMetricDetail('fico')" style="cursor: pointer;">
                    <div class="metric-value" id="metricFico">--</div>
                    <div class="metric-label">FICO</div>
                  </div>
                  <div class="metric-card" onclick="openBankMetricDetail('revenue')" style="cursor: pointer;">
                    <div class="metric-value" id="metricAvgRev">--</div>
                    <div class="metric-label">Avg Rev</div>
                  </div>
                  <div class="metric-card" onclick="openBankMetricDetail('deposits')" style="cursor: pointer;">
                    <div class="metric-value" id="metricDeposits">--</div>
                    <div class="metric-label">Deposits</div>
                  </div>
                  <div class="metric-card" onclick="openBankMetricDetail('balance')" style="cursor: pointer;">
                    <div class="metric-value" id="metricAvgBal">--</div>
                    <div class="metric-label">Avg Bal</div>
                  </div>
                  <div class="metric-card" onclick="openBankMetricDetail('nsf')" style="cursor: pointer;">
                    <div class="metric-value" id="metricNsf">0</div>
                    <div class="metric-label">NSFs</div>
                  </div>
                  <div class="metric-card" onclick="openBankMetricDetail('negdays')" style="cursor: pointer;">
                    <div class="metric-value" id="metricNegDays">0</div>
                    <div class="metric-label">Neg Days</div>
                  </div>
                </div>
                
                <!-- Monthly Breakdown Mini Chart -->
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="openBankMetricDetail('monthly')">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Monthly Trend</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                  </div>
                  <div id="miniMonthlyChart" style="display: flex; align-items: flex-end; gap: 3px; height: 40px;">
                    <!-- Mini bar chart will be populated by JS -->
                  </div>
                </div>
                
                <!-- Profile Completeness -->
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-secondary);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <span style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Profile</span>
                    <span style="font-size: 0.9rem; font-weight: 700;" id="profileCompletionPct">0%</span>
                  </div>
                  <div class="completion-bar"><div id="profileCompletionBar"></div></div>
                </div>
                
                <!-- Unified Progress Tracker -->
                <div id="progressTracker" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-secondary);">
                  <!-- Document Extraction Progress (shows when active) -->
                  <div id="extractionProgress" style="display: none; margin-bottom: 14px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 10px; height: 10px; border: 2px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span style="font-size: 0.75rem; font-weight: 600; color: var(--accent);" id="extractionTitle">Extracting...</span>
                      </div>
                      <span style="font-size: 0.75rem; font-weight: 700;" id="extractionPercent">0%</span>
                    </div>
                    <div style="background: var(--bg-tertiary); border-radius: 4px; height: 6px; overflow: hidden;">
                      <div id="extractionBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), #f59e0b); transition: width 0.3s;"></div>
                    </div>
                    <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;" id="extractionPhase">Preparing...</div>
                  </div>
                  
                  <!-- Search Status Grid -->
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.05em; display: flex; justify-content: space-between; align-items: center;">
                    <span>Intel Status</span>
                    <span id="searchSummary" style="font-size: 0.65rem; color: var(--accent); font-weight: 600;"></span>
                  </div>
                  <div id="scrubStatusGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                    <div class="scrub-status-item" id="scrubExtraction" data-status="pending">
                      <span class="scrub-icon"></span>
                      <span class="scrub-label">Extraction</span>
                    </div>
                    <div class="scrub-status-item" id="scrubEntity" data-status="pending">
                      <span class="scrub-icon"></span>
                      <span class="scrub-label">Entity</span>
                    </div>
                    <div class="scrub-status-item" id="scrubResearch" data-status="pending">
                      <span class="scrub-icon"></span>
                      <span class="scrub-label">Research</span>
                    </div>
                    <div class="scrub-status-item" id="scrubBackground" data-status="pending">
                      <span class="scrub-icon"></span>
                      <span class="scrub-label">Background</span>
                    </div>
                    <div class="scrub-status-item" id="scrubFootprint" data-status="pending">
                      <span class="scrub-icon"></span>
                      <span class="scrub-label">Footprint</span>
                    </div>
                    <div class="scrub-status-item" id="scrubDebt" data-status="pending">
                      <span class="scrub-icon"></span>
                      <span class="scrub-label">Debt</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- QUICK SCRUB PANEL -->
            <div class="collapsible-panel" id="panelQuickScrub">
              <div class="panel-header" onclick="togglePanel('panelQuickScrub')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  Quick Scrub
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <div class="mini-dropzone" id="miniQuickScrubZone" onclick="document.getElementById('quickScrubInput').click()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                  <h4>Drop Documents</h4>
                  <p>Bank statements, credit reports, applications, IDs</p>
                </div>
                <input type="file" id="quickScrubInput" style="display: none;" accept=".pdf,image/*" multiple onchange="handleQuickScrub(event)">
                
                <div style="margin-top: 16px; padding: 14px; background: var(--bg-secondary); border-radius: 10px;">
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.05em;">Summary</div>
                  <div id="bankSummaryBody" style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                    No statements yet.
                  </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 14px;">
                  <button class="btn-secondary" style="flex: 1; justify-content: center; padding: 12px 10px; font-size: 0.8rem;" onclick="refreshEntityVerification()">Refresh</button>
                  <button class="btn-secondary" style="flex: 1; justify-content: center; padding: 12px 10px; font-size: 0.8rem; border-color: var(--accent); color: var(--accent);" onclick="runDeepResearch()">Deep Research</button>
                </div>
              </div>
            </div>
            
            <!-- HUBBLE AI CHAT PANEL -->
            <div class="collapsible-panel" id="panelHubble">
              <div class="panel-header" onclick="togglePanel('panelHubble')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                  Hubble AI
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <div class="ai-chat-container">
                  <div class="ai-chat-messages" id="hubbleMessages">
                    <div class="ai-message system">Ask me anything about this deal. I can analyze financials, research the business, assess risk, and more.</div>
                  </div>
                  <div class="ai-chat-input-row">
                    <input type="text" class="ai-chat-input" id="hubbleInput" placeholder="Ask about this business..." onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendHubbleMessage(); }">
                    <button class="ai-chat-send" onclick="sendHubbleMessage()" id="hubbleSendBtn">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                  </div>
                </div>
                <div style="margin-top: 14px; display: flex; flex-wrap: wrap; gap: 8px;">
                  <button class="btn-secondary" style="padding: 10px 14px; font-size: 0.75rem;" onclick="quickHubble('Analyze cash flow')">Cash Flow</button>
                  <button class="btn-secondary" style="padding: 10px 14px; font-size: 0.75rem;" onclick="quickHubble('Risk factors')">Risk</button>
                  <button class="btn-secondary" style="padding: 10px 14px; font-size: 0.75rem;" onclick="quickHubble('Funding recommendation')">Funding</button>
                  <button class="btn-secondary" style="padding: 10px 14px; font-size: 0.75rem;" onclick="quickHubble('Summarize deal')">Summary</button>
                </div>
              </div>
            </div>
            
            <!-- QUICK ACTIONS PANEL -->
            <div class="collapsible-panel" id="panelQuickActions">
              <div class="panel-header" onclick="togglePanel('panelQuickActions')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                  Quick Actions
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <button class="btn-secondary sidebar-action-btn" onclick="openCreditPullModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span>Pull Credit</span>
                  </button>
                  <button class="btn-secondary sidebar-action-btn" onclick="runStackingAnalysis()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="4" rx="1"/><rect x="2" y="9" width="20" height="4" rx="1"/><rect x="2" y="15" width="20" height="4" rx="1"/></svg>
                    <span>Check Stacking</span>
                  </button>
                  <button class="btn-secondary sidebar-action-btn" onclick="openDocChecklistModal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    <span>Doc Checklist</span>
                  </button>
                  <button class="btn-secondary sidebar-action-btn" onclick="exportCurrentDealPDF()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <span>Export PDF</span>
                  </button>
                  <button class="btn-secondary sidebar-action-btn" onclick="generateShareLink()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    <span>Share Deal</span>
                  </button>
                  <button class="btn-primary sidebar-action-btn" onclick="openShareProfileModal()" style="background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%); border: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    <span>Share Profile</span>
                  </button>
                  <button class="btn-secondary sidebar-action-btn" onclick="duplicateDeal()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    <span>Duplicate</span>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- DEAL NOTES PANEL -->
            <div class="collapsible-panel" id="panelDealNotes">
              <div class="panel-header" onclick="togglePanel('panelDealNotes')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                  Deal Notes
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <textarea id="sidebarDealNotes" placeholder="Add notes about this deal..." style="width: 100%; height: 120px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 10px; padding: 14px; font-size: 0.85rem; color: var(--text-primary); resize: vertical; font-family: inherit; line-height: 1.6;" onchange="saveSidebarDealNotes()"></textarea>
                <div style="margin-top: 10px; font-size: 0.75rem; color: var(--text-muted);" id="sidebarNotesStatus">Notes auto-save</div>
              </div>
            </div>
            
            <!-- STACKING STATUS PANEL -->
            <div class="collapsible-panel" id="panelStackingStatus">
              <div class="panel-header" onclick="togglePanel('panelStackingStatus')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                  Stacking Status
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <div id="sidebarStackingStatus">
                  <div style="text-align: center; padding: 20px 16px; color: var(--text-muted); font-size: 0.8rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 28px; height: 28px; margin-bottom: 10px; opacity: 0.5;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <div style="margin-bottom: 12px;">No stacking analysis yet</div>
                    <button class="btn-secondary" style="padding: 10px 16px; font-size: 0.75rem;" onclick="runStackingAnalysis()">Run Analysis</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- DOCUMENT STATUS PANEL -->
            <div class="collapsible-panel" id="panelDocStatus">
              <div class="panel-header" onclick="togglePanel('panelDocStatus')">
                <div class="panel-title">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                  Document Status
                </div>
                <button class="panel-toggle">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
              </div>
              <div class="panel-body">
                <div id="sidebarDocStatus" style="display: flex; flex-direction: column; gap: 8px;">
                  <div class="sidebar-doc-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/></svg>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Bank Statements</span>
                  </div>
                  <div class="sidebar-doc-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/></svg>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Application</span>
                  </div>
                  <div class="sidebar-doc-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/></svg>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Driver's License</span>
                  </div>
                  <div class="sidebar-doc-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/></svg>
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">Voided Check</span>
                  </div>
                </div>
                <button class="btn-secondary" style="width: 100%; margin-top: 12px; padding: 10px; font-size: 0.75rem; justify-content: center;" onclick="openDocChecklistModal()">View Full Checklist</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- METRIC MODAL -->
  <div class="modal-overlay" id="metricModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="metricModalTitle">Metric Analysis</div>
          <div class="modal-subtitle" id="metricModalSubtitle">Detailed breakdown</div>
        </div>
        <button class="modal-close" onclick="closeMetricModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="height: 250px; margin-bottom: 24px;"><canvas id="metricModalChart"></canvas></div>
        <div class="card-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          Key Insights
        </div>
        <div id="metricInsights" style="display: flex; flex-direction: column; gap: 8px;"></div>
      </div>
    </div>
  </div>

  <!-- BANK DATA DETAIL MODAL -->
  <div class="modal-overlay" id="bankDataModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="bankDataModalTitle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
            Bank Data Analysis
          </div>
          <div class="modal-subtitle" id="bankDataModalSubtitle">Monthly breakdown from bank statements</div>
        </div>
        <button class="modal-close" onclick="closeBankDataModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Total Revenue</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: var(--tier-a);" id="bankModalTotalRev">$0</div>
          </div>
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Avg Monthly</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);" id="bankModalAvgRev">$0</div>
          </div>
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Total Deposits</div>
            <div style="font-size: 1.25rem; font-weight: 700; color: var(--tier-b);" id="bankModalTotalDep">$0</div>
          </div>
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Avg Balance</div>
            <div style="font-size: 1.25rem; font-weight: 700;" id="bankModalAvgBal">$0</div>
          </div>
        </div>
        
        <!-- Chart -->
        <div style="height: 220px; margin-bottom: 24px;"><canvas id="bankDataChart"></canvas></div>
        
        <!-- Monthly Table -->
        <div class="card-title" style="margin-bottom: 12px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Monthly Breakdown
        </div>
        <div style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border-primary); border-radius: 10px;">
          <table class="data-table" style="margin: 0;">
            <thead>
              <tr>
                <th>Month</th>
                <th>Revenue</th>
                <th>Deposits</th>
                <th>Avg Balance</th>
                <th>End Balance</th>
                <th>NSFs</th>
                <th>Neg Days</th>
              </tr>
            </thead>
            <tbody id="bankDataTableBody">
              <tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No bank data available</td></tr>
            </tbody>
          </table>
        </div>
        
        <!-- Risk Indicators -->
        <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
          <div class="card-title" style="margin-bottom: 12px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            Risk Indicators
          </div>
          <div id="bankRiskIndicators" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700;" id="bankModalNsf">0</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">Total NSFs</div>
            </div>
            <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700;" id="bankModalNegDays">0</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">Negative Days</div>
            </div>
            <div style="padding: 12px; background: var(--bg-primary); border-radius: 8px; text-align: center;">
              <div style="font-size: 1.5rem; font-weight: 700;" id="bankModalLowestBal">$0</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">Lowest Balance</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENTITY SEARCH MODAL -->
  <div class="modal-overlay" id="entityModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Entity Report
          </div>
          <div class="modal-subtitle" id="entityModalSubtitle">Business verification results</div>
        </div>
        <button class="modal-close" onclick="closeEntityModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="entityModalBody">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <p>Search for a business entity to see verification results.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- BANK STATEMENT ANALYSIS MODAL -->
  <div class="modal-overlay" id="bankAnalysisModal">
    <div class="modal" style="max-width: 1100px; width: 95%; max-height: 90vh;">
      <div class="modal-header" style="background: #1a1a1a; border-bottom: none; padding: 20px 24px;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 10px; height: 10px; background: var(--text-primary); border-radius: 50%;"></div>
          <span style="font-weight: 600; font-size: 1rem;">AblesAI</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
          <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted);">Bank Statement Analysis</span>
          <button class="modal-close" onclick="closeBankAnalysisModal()">&times;</button>
        </div>
      </div>
      <div class="modal-body" style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 80px); background: #fafafa; color: #1a1a1a;">
        
        <!-- Summary Metrics Section -->
        <div style="margin-bottom: 32px;">
          <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 16px; font-weight: 600;">Summary Metrics</div>
          <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 1px solid #e5e5e5;">
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Metric</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Value</th>
                </tr>
              </thead>
              <tbody id="bankAnalysisSummary">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Monthly Detail Section -->
        <div style="margin-bottom: 32px;">
          <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 16px; font-weight: 600;">Monthly Detail</div>
          <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
              <thead>
                <tr style="border-bottom: 1px solid #e5e5e5;">
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Month</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Revenue</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Avg Daily Bal</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Dep Count</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">End Balance</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">NSF</th>
                </tr>
              </thead>
              <tbody id="bankAnalysisMonthly">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Detected Debt Obligations Section -->
        <div>
          <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: #666; margin-bottom: 16px; font-weight: 600;">Detected Debt Obligations</div>
          <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 700px;">
              <thead>
                <tr style="border-bottom: 1px solid #e5e5e5;">
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Lender</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Type</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Est. Balance</th>
                  <th style="text-align: left; padding: 12px 16px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; font-weight: 500;">Monthly Payment</th>
                </tr>
              </thead>
              <tbody id="bankAnalysisDebt">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal" style="max-width: 900px; width: 95%;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            Settings
          </div>
          <div class="modal-subtitle">Application &amp; Underwriting Configuration</div>
        </div>
        <button class="modal-close" onclick="closeSettingsModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      
      <!-- Settings Tabs -->
      <div style="display: flex; border-bottom: 1px solid var(--border-secondary); margin: 0 -20px; padding: 0 20px; flex-wrap: wrap;">
        <button class="settings-tab active" id="settingsTabGeneral" onclick="switchSettingsTab('general')" style="padding: 14px 20px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.9rem;">
          General
        </button>
        <button class="settings-tab" id="settingsTabUnderwriting" onclick="switchSettingsTab('underwriting')" style="padding: 14px 20px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.9rem;">
          Underwriting
        </button>
        <button class="settings-tab" id="settingsTabIntegrations" onclick="switchSettingsTab('integrations')" style="padding: 14px 20px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.9rem;">
          Integrations
        </button>
        <button class="settings-tab" id="settingsTabData" onclick="switchSettingsTab('data')" style="padding: 14px 20px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.9rem;">
          Data
        </button>
      </div>
      <style>
        .settings-tab.active { color: var(--accent) !important; border-bottom-color: var(--accent) !important; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; }
        .slider-group { margin-bottom: 20px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .slider-label { font-size: 0.85rem; color: var(--text-primary); }
        .slider-value { font-size: 0.85rem; color: var(--accent); font-weight: 600; min-width: 40px; text-align: right; }
        .slider-input { width: 100%; height: 8px; border-radius: 4px; background: var(--bg-tertiary); appearance: none; cursor: pointer; }
        .slider-input::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; }
        .slider-input::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none; }
        .slider-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }
        .settings-section { margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid var(--border-secondary); }
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; }
        .settings-section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); margin-bottom: 16px; font-weight: 600; }
        .api-key-card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px; }
        .api-key-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .api-key-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .api-key-icon svg { width: 20px; height: 20px; color: #000; }
        .api-key-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .api-key-subtitle { font-size: 0.8rem; color: var(--text-muted); }
        .api-key-input-wrap { position: relative; }
        .api-key-status { display: flex; align-items: center; gap: 8px; margin-top: 12px; font-size: 0.8rem; }
        .api-key-status.valid { color: var(--tier-a); }
        .api-key-status.invalid { color: var(--tier-e); }
      </style>
      
      <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 24px;">
        <!-- General Panel -->
        <div class="settings-panel active" id="settingsPanelGeneral">
          <!-- API Key Card -->
          <div class="api-key-card">
            <div class="api-key-header">
              <div class="api-key-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
              </div>
              <div>
                <div class="api-key-title">AI Processing API Key</div>
                <div class="api-key-subtitle">Required for document analysis, credit reports, and AI features</div>
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label class="form-label" style="font-size: 0.85rem; margin-bottom: 8px;">Gemini API Key</label>
              <div class="api-key-input-wrap">
                <input type="password" class="form-input" id="settingsApiKey" placeholder="Paste your API key here..." style="font-size: 0.95rem; padding: 14px 16px;">
              </div>
              <div class="api-key-status" id="apiKeyStatus">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                <span>Get a free API key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--accent); font-weight: 500;">Google AI Studio </a></span>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label" style="font-size: 0.9rem;">Default AI Model</label>
            <select class="form-input" id="settingsModel" style="font-size: 0.95rem; padding: 14px 16px;">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fast)</option>
              <option value="gemini-3-pro-preview">Gemini 3 Pro (Accurate)</option>
            </select>
            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">Flash is faster, Pro is more accurate for complex documents</div>
          </div>
          
          <!-- Appearance Settings -->
          <div class="settings-section" style="margin-top: 24px;">
            <div class="settings-section-title">Appearance</div>
            
            <div class="form-group">
              <label class="form-label" style="font-size: 0.9rem;">Theme</label>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="theme-option" data-theme="dark" onclick="setTheme('dark')" style="padding: 12px 20px; border-radius: 10px; border: 2px solid var(--border-primary); background: #09090b; color: #fafafa; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                  Dark
                </button>
                <button class="theme-option" data-theme="light" onclick="setTheme('light')" style="padding: 12px 20px; border-radius: 10px; border: 2px solid #e4e4e7; background: #fafafa; color: #09090b; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                  Light
                </button>
                <button class="theme-option" data-theme="black" onclick="setTheme('black')" style="padding: 12px 20px; border-radius: 10px; border: 2px solid #18181b; background: #000000; color: #fafafa; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                  Black (OLED)
                </button>
              </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
              <label class="form-label" style="font-size: 0.9rem;">Accent Color</label>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="accent-option" data-accent="gold" onclick="setAccentColor('gold')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #eab308, #ca8a04); cursor: pointer; transition: all 0.2s;" title="Gold (Default)"></button>
                <button class="accent-option" data-accent="blue" onclick="setAccentColor('blue')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #3b82f6, #2563eb); cursor: pointer; transition: all 0.2s;" title="Blue"></button>
                <button class="accent-option" data-accent="green" onclick="setAccentColor('green')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #22c55e, #16a34a); cursor: pointer; transition: all 0.2s;" title="Green"></button>
                <button class="accent-option" data-accent="purple" onclick="setAccentColor('purple')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #a855f7, #9333ea); cursor: pointer; transition: all 0.2s;" title="Purple"></button>
                <button class="accent-option" data-accent="red" onclick="setAccentColor('red')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #ef4444, #dc2626); cursor: pointer; transition: all 0.2s;" title="Red"></button>
                <button class="accent-option" data-accent="cyan" onclick="setAccentColor('cyan')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #06b6d4, #0891b2); cursor: pointer; transition: all 0.2s;" title="Cyan"></button>
                <button class="accent-option" data-accent="orange" onclick="setAccentColor('orange')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #f97316, #ea580c); cursor: pointer; transition: all 0.2s;" title="Orange"></button>
                <button class="accent-option" data-accent="pink" onclick="setAccentColor('pink')" style="width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; background: linear-gradient(135deg, #ec4899, #db2777); cursor: pointer; transition: all 0.2s;" title="Pink"></button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Underwriting Model Panel -->
        <div class="settings-panel" id="settingsPanelUnderwriting">
          <div class="settings-section">
            <div class="settings-section-title">FICO Score Settings</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">FICO Weight (% of total score)</span>
                <span class="slider-value" id="uw_ficoWeight_val">50</span>
              </div>
              <input type="range" class="slider-input" id="uw_ficoWeight" min="0" max="100" value="50" oninput="updateUnderwritingSetting('ficoWeight', this.value)">
              <div class="slider-hint">How much FICO contributes to the final ABLESCORE</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">FICO Floor</span>
                <span class="slider-value" id="uw_ficoFloor_val">500</span>
              </div>
              <input type="range" class="slider-input" id="uw_ficoFloor" min="300" max="600" value="500" oninput="updateUnderwritingSetting('ficoFloor', this.value)">
              <div class="slider-hint">Minimum FICO considered (below = 0 points)</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">FICO Ceiling</span>
                <span class="slider-value" id="uw_ficoCeiling_val">800</span>
              </div>
              <input type="range" class="slider-input" id="uw_ficoCeiling" min="700" max="850" value="800" oninput="updateUnderwritingSetting('ficoCeiling', this.value)">
              <div class="slider-hint">Maximum FICO considered (above = max points)</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Revenue Consistency</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Revenue Weight (% of total score)</span>
                <span class="slider-value" id="uw_revenueWeight_val">20</span>
              </div>
              <input type="range" class="slider-input" id="uw_revenueWeight" min="0" max="50" value="20" oninput="updateUnderwritingSetting('revenueWeight', this.value)">
              <div class="slider-hint">Bonus for consistent monthly revenue</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Consistency Threshold (%)</span>
                <span class="slider-value" id="uw_revenueThreshold_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_revenueThreshold" min="5" max="30" value="10" oninput="updateUnderwritingSetting('revenueThreshold', this.value)">
              <div class="slider-hint">Max variance % for full consistency bonus</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Penalty Settings</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">NSF Penalty Max</span>
                <span class="slider-value" id="uw_nsfPenaltyMax_val">15</span>
              </div>
              <input type="range" class="slider-input" id="uw_nsfPenaltyMax" min="5" max="30" value="15" oninput="updateUnderwritingSetting('nsfPenaltyMax', this.value)">
              <div class="slider-hint">Maximum penalty for NSF/overdraft fees</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">NSF Threshold (count)</span>
                <span class="slider-value" id="uw_nsfThreshold_val">3</span>
              </div>
              <input type="range" class="slider-input" id="uw_nsfThreshold" min="1" max="10" value="3" oninput="updateUnderwritingSetting('nsfThreshold', this.value)">
              <div class="slider-hint">NSFs above this trigger max penalty</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Negative Day Penalty Max</span>
                <span class="slider-value" id="uw_negativeDayPenaltyMax_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_negativeDayPenaltyMax" min="5" max="25" value="10" oninput="updateUnderwritingSetting('negativeDayPenaltyMax', this.value)">
              <div class="slider-hint">Maximum penalty for negative balance days</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Negative Day Threshold</span>
                <span class="slider-value" id="uw_negativeDayThreshold_val">5</span>
              </div>
              <input type="range" class="slider-input" id="uw_negativeDayThreshold" min="1" max="15" value="5" oninput="updateUnderwritingSetting('negativeDayThreshold', this.value)">
              <div class="slider-hint">Days above this trigger max penalty</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Time in Business Bonuses</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">6+ Months Bonus</span>
                <span class="slider-value" id="uw_tib6moBonus_val">5</span>
              </div>
              <input type="range" class="slider-input" id="uw_tib6moBonus" min="0" max="15" value="5" oninput="updateUnderwritingSetting('tib6moBonus', this.value)">
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">12+ Months Bonus</span>
                <span class="slider-value" id="uw_tib12moBonus_val">8</span>
              </div>
              <input type="range" class="slider-input" id="uw_tib12moBonus" min="0" max="20" value="8" oninput="updateUnderwritingSetting('tib12moBonus', this.value)">
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">24+ Months Bonus</span>
                <span class="slider-value" id="uw_tib24moBonus_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_tib24moBonus" min="0" max="25" value="10" oninput="updateUnderwritingSetting('tib24moBonus', this.value)">
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Collectability Settings</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Collectability Weight (% of offer calc)</span>
                <span class="slider-value" id="uw_collectWeight_val">15</span>
              </div>
              <input type="range" class="slider-input" id="uw_collectWeight" min="0" max="30" value="15" oninput="updateUnderwritingSetting('collectWeight', this.value)">
              <div class="slider-hint">How much collectability affects offer amount</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Min Avg Daily Balance ($)</span>
                <span class="slider-value" id="uw_minAvgDailyBal_val">500</span>
              </div>
              <input type="range" class="slider-input" id="uw_minAvgDailyBal" min="0" max="5000" step="100" value="500" oninput="updateUnderwritingSetting('minAvgDailyBal', this.value)">
              <div class="slider-hint">Minimum average daily balance requirement</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Deposit Frequency Weight</span>
                <span class="slider-value" id="uw_depositFreqWeight_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_depositFreqWeight" min="0" max="25" value="10" oninput="updateUnderwritingSetting('depositFreqWeight', this.value)">
              <div class="slider-hint">Bonus for consistent deposit patterns</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Low Balance Penalty</span>
                <span class="slider-value" id="uw_lowBalPenalty_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_lowBalPenalty" min="0" max="20" value="10" oninput="updateUnderwritingSetting('lowBalPenalty', this.value)">
              <div class="slider-hint">Penalty for frequently low balances</div>
            </div>
          </div>
          
          <button class="btn-secondary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="resetUnderwritingDefaults()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Reset to Defaults
          </button>
        </div>
        
        <!-- Integrations Panel -->
        <div class="settings-panel" id="settingsPanelIntegrations">
          <div class="settings-section">
            <div class="settings-section-title">Zapier Webhooks</div>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Connect to Zapier to automate workflows. Get webhook URLs from your Zapier Zaps.</p>
            
            <div class="form-group">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-a)" stroke-width="2" style="width: 14px; height: 14px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  New Deal Created
                </span>
              </label>
              <input type="text" class="form-input" id="webhookNewDeal" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when a new deal is added to the pipeline</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  Bank Statement Processed
                </span>
              </label>
              <input type="text" class="form-input" id="webhookBankProcessed" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered after Quick Scrub completes analysis</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-b)" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  Score Calculated
                </span>
              </label>
              <input type="text" class="form-input" id="webhookScoreCalc" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when ABLESCORE is calculated/updated</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-c)" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
                  Deep Research Complete
                </span>
              </label>
              <input type="text" class="form-input" id="webhookResearch" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when deep business research finishes</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-d)" stroke-width="2" style="width: 14px; height: 14px;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  Credit Report Analyzed
                </span>
              </label>
              <input type="text" class="form-input" id="webhookCredit" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when credit report data is extracted</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" style="width: 14px; height: 14px;"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                  Status Changed
                </span>
              </label>
              <input type="text" class="form-input" id="webhookStatus" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when deal status changes (approved, declined, etc.)</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Webhook Settings</div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                <input type="checkbox" id="webhooksEnabled" onchange="saveWebhookSettings()" style="width: 16px; height: 16px; accent-color: var(--accent);">
                Enable Webhooks
              </label>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                <input type="checkbox" id="webhookIncludeMonths" onchange="saveWebhookSettings()" style="width: 16px; height: 16px; accent-color: var(--accent);">
                Include Monthly Financial Data
              </label>
            </div>
            <div class="slider-hint" style="margin-top: 8px;">When enabled, webhooks will include detailed month-by-month data</div>
          </div>
          
          <button class="btn-secondary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="testWebhook()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Test Webhooks
          </button>
        </div>
        
        <!-- Data Panel -->
        <div class="settings-panel" id="settingsPanelData">
          <div class="form-label" style="margin-bottom: 12px;">Data Management</div>
          <div style="display: flex; gap: 12px;">
            <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="exportDeals()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export
            </button>
            <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="document.getElementById('importDealsInput').click()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Import
            </button>
            <input type="file" id="importDealsInput" style="display: none;" accept=".json" onchange="importDeals(event)">
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-secondary" style="width: 100%; justify-content: center; color: var(--tier-e); border-color: var(--tier-e);" onclick="clearAllData()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              Clear All Data
            </button>
          </div>
        </div>
      </div>
      
      <!-- Settings Footer with Save Button -->
      <div style="display: flex; justify-content: flex-end; gap: 12px; padding: 20px 24px; border-top: 1px solid var(--border-secondary); background: var(--bg-secondary);">
        <button class="btn-secondary" onclick="closeSettingsModal()" style="padding: 12px 24px; font-size: 0.9rem;">Cancel</button>
        <button class="btn-primary" onclick="saveSettings()" style="padding: 12px 32px; font-size: 0.9rem;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save Settings
        </button>
      </div>
    </div>
  </div>

  <!-- DEEP RESEARCH MODAL -->
  <div class="modal-overlay" id="deepResearchModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
            Deep Business Research
          </div>
          <div class="modal-subtitle" id="deepResearchSubtitle">Comprehensive background analysis</div>
        </div>
        <button class="modal-close" onclick="closeDeepResearchModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="deepResearchBody">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <p>Run deep research on a business to get comprehensive background analysis.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- APPROVAL SEND / SHARE -->
  <div class="modal-overlay" id="approvalShareModal">
    <div class="modal" style="max-width: 860px; width: 92%;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"></path>
              <polyline points="16 6 12 2 8 6"></polyline>
              <line x1="12" y1="2" x2="12" y2="15"></line>
            </svg>
            Approval Send &amp; Share
          </div>
          <div class="modal-subtitle">Generate ISO + Merchant links (branded) from your current offer calculator</div>
        </div>
        <button class="modal-close" onclick="closeApprovalShareModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <div class="modal-body">
        <div style="padding: 14px 16px; border-radius: 14px; border: 1px solid var(--border-secondary); background: var(--bg-secondary); color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">
          <strong style="color: var(--text-primary);">Pro tip:</strong> Send the ISO link to partners. They get a sellrate slider (buy  max) and can generate a merchant link + SMS/email from inside the link.
        </div>

        <div style="margin-top: 18px;">
          <div style="font-weight: 800; margin-bottom: 10px;">Recipient</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Business Name</label>
              <input class="form-input" id="shareBusinessName" placeholder="Business name">
            </div>
            <div class="form-group">
              <label class="form-label">Contact Name</label>
              <input class="form-input" id="shareContactName" placeholder="Contact">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Merchant Email</label>
              <input class="form-input" id="shareContactEmail" placeholder="merchant@email.com">
            </div>
            <div class="form-group">
              <label class="form-label">Merchant Phone</label>
              <input class="form-input" id="shareContactPhone" placeholder="(555) 5555555">
            </div>
          </div>
        </div>

        <div style="margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border-secondary);">
          <div style="font-weight: 800; margin-bottom: 10px;">Branding (optional)</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Company Name</label>
              <input class="form-input" id="shareBrandName" placeholder="Shown on the approval page">
            </div>
            <div class="form-group">
              <label class="form-label">Logo URL</label>
              <input class="form-input" id="shareBrandLogo" placeholder="https://...">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Accent Color</label>
              <input class="form-input" id="shareBrandAccent" type="color" style="padding: 6px 10px; height: 44px;">
              <div class="gd-inline-help">Used for buttons/badges on the share page.</div>
            </div>
            <div class="form-group">
              <label class="form-label">Expiry Date (optional)</label>
              <input class="form-input" id="shareExpiry" type="date">
              <div class="gd-inline-help">Displayed to the recipient (does not autoinvalidate).</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border-secondary);">
          <div style="font-weight: 800; margin-bottom: 10px;">Your Contact (shown on share page)</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Your Name</label>
              <input class="form-input" id="shareSenderName" placeholder="Name">
            </div>
            <div class="form-group">
              <label class="form-label">Your Email</label>
              <input class="form-input" id="shareSenderEmail" placeholder="you@company.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Your Phone</label>
              <input class="form-input" id="shareSenderPhone" placeholder="(555) 5555555">
            </div>
            <div class="form-group">
              <label class="form-label">ISO Partner Name (optional)</label>
              <input class="form-input" id="shareISOName" placeholder="ISO / Broker name">
            </div>
          </div>
        </div>

        <div style="margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border-secondary);">
          <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
            <div style="font-weight: 800;">Include Options</div>
            <div style="display:flex; gap: 14px; align-items:center; font-size: 0.82rem; color: var(--text-muted); flex-wrap: wrap;">
              <label style="display:flex; gap: 6px; align-items:center;"><input type="checkbox" id="shareOptConservative" checked> Conservative</label>
              <label style="display:flex; gap: 6px; align-items:center;"><input type="checkbox" id="shareOptModerate" checked> Moderate</label>
              <label style="display:flex; gap: 6px; align-items:center;"><input type="checkbox" id="shareOptAggressive" checked> Aggressive</label>
            </div>
          </div>

          <div class="form-row" style="margin-top: 12px;">
            <div class="form-group">
              <label class="form-label">ISO max sell factor delta</label>
              <input class="form-input" id="shareMaxSellDelta" type="number" step="0.01" value="0.07">
              <div class="gd-inline-help">ISO link shows a sellrate slider from buy  buy + delta.</div>
            </div>
            <div class="form-group">
              <label class="form-label">Merchant View</label>
              <select class="form-input" id="shareShowFactor">
                <option value="yes">Show factor rate</option>
                <option value="no">Hide factor rate</option>
              </select>
              <div class="gd-inline-help">You can hide the factor and show only totals &amp; payments.</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border-secondary);">
          <div style="font-weight: 800;">Share Links</div>

          <div class="gd-share-link-card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px;">
              <div style="font-weight: 800; color: var(--text-primary);">Merchant Link</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">Client view</div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
              <textarea class="form-input" id="shareClientLink" rows="2" readonly></textarea>
            </div>
            <div class="gd-share-link-actions">
              <button class="btn-primary" onclick="gdCopyShareLink('client')">Copy Link</button>
              <button class="btn-secondary" onclick="gdPreviewShare('client')">Open</button>
              <button class="btn-secondary" onclick="gdCopyShareSMS()">Copy SMS</button>
              <button class="btn-secondary" onclick="gdOpenShareEmail()">Email Draft</button>
            </div>
          </div>

          <div class="gd-share-link-card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px;">
              <div style="font-weight: 800; color: var(--text-primary);">ISO Partner Link</div>
              <div style="font-size: 0.8rem; color: var(--text-muted);">ISO calculator</div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
              <textarea class="form-input" id="shareIsoLink" rows="2" readonly></textarea>
            </div>
            <div class="gd-share-link-actions">
              <button class="btn-primary" onclick="gdCopyShareLink('iso')">Copy ISO Link</button>
              <button class="btn-secondary" onclick="gdPreviewShare('iso')">Open</button>
            </div>
          </div>

          <div id="shareHistoryWrap" style="margin-top: 16px;">
            <div style="font-weight: 800; margin-bottom: 10px;">Recent Links (this deal)</div>
            <div id="shareHistoryList" style="display:flex; flex-direction:column; gap: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SHARE MODE VIEW (Client / ISO) -->
  <div id="gdShareOverlay" class="gd-share-overlay hidden">
    <div class="gd-share-shell">
      <div class="gd-share-top">
        <div class="gd-share-brand">
          <img id="gdShareLogo" class="gd-share-logo hidden" alt="Logo" referrerpolicy="no-referrer">
          <div>
            <div id="gdShareCompanyName" class="gd-share-company">Approval</div>
            <div id="gdShareModeLabel" class="gd-share-mode">Funding Approval</div>
          </div>
        </div>
        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-secondary" onclick="gdSharePrint()">Print</button>
          <button class="btn-secondary" id="gdShareBackBtn" onclick="gdShareBackToEditor()">Back to Editor</button>
        </div>
      </div>

      <div class="gd-share-card">
        <div class="gd-share-card-header">
          <div class="gd-share-greeting" id="gdShareGreeting">Hello</div>
          <div class="gd-share-message">
            Your business <span id="gdShareBusiness" style="font-weight: 800; color: var(--text-primary);"></span> has been <span style="font-weight: 800; color: var(--accent);">preapproved</span> for funding.
          </div>
          <div id="gdShareExpiryWrap" class="gd-share-expiry hidden">
            Expires <span id="gdShareExpiry"></span>
          </div>
        </div>

        <div id="gdShareTabs" class="gd-share-tabs"></div>

        <div class="gd-share-grid">
          <div class="gd-share-stat">
            <div class="gd-share-stat-label">Funding Amount</div>
            <div class="gd-share-stat-value" id="gdShareAmount">$0</div>
          </div>
          <div class="gd-share-stat">
            <div class="gd-share-stat-label">Total Payback</div>
            <div class="gd-share-stat-value" id="gdSharePayback">$0</div>
          </div>
          <div class="gd-share-stat" id="gdShareFactorWrap">
            <div class="gd-share-stat-label">Factor Rate</div>
            <div class="gd-share-stat-value" id="gdShareFactor">1.00x</div>
          </div>
          <div class="gd-share-stat">
            <div class="gd-share-stat-label">Term</div>
            <div class="gd-share-stat-value" id="gdShareTerm">0 days</div>
          </div>
          <div class="gd-share-stat">
            <div class="gd-share-stat-label" id="gdSharePaymentLabel">Daily Payment</div>
            <div class="gd-share-stat-value" id="gdSharePayment">$0</div>
          </div>
          <div class="gd-share-stat">
            <div class="gd-share-stat-label" id="gdShareCountLabel"># of Payments</div>
            <div class="gd-share-stat-value" id="gdShareCount">0</div>
          </div>
        </div>

        <div id="gdIsoPanel" class="gd-share-iso-panel hidden">
          <div class="gd-iso-title">ISO Offer Calculator</div>

          <div class="form-group">
            <label class="form-label">Sell Factor</label>
            <input class="gd-iso-range" id="gdIsoFactorSlider" type="range" min="1.20" max="1.30" step="0.01">
            <div style="display:flex; justify-content:space-between; gap: 10px; margin-top: 8px; font-size: 0.82rem; color: var(--text-muted); flex-wrap: wrap;">
              <span>Buy: <strong id="gdIsoBuyFactor" style="color: var(--text-primary);"></strong></span>
              <span>Max: <strong id="gdIsoMaxFactor" style="color: var(--text-primary);"></strong></span>
              <span>Selected: <strong id="gdIsoSellFactor" style="color: var(--accent);"></strong></span>
            </div>
          </div>

          <div class="gd-iso-metrics">
            <div class="gd-iso-metric">
              <div class="gd-iso-metric-label">Spread $</div>
              <div class="gd-iso-metric-value" id="gdIsoSpread">$0</div>
            </div>
            <div class="gd-iso-metric">
              <div class="gd-iso-metric-label">Spread / Funding</div>
              <div class="gd-iso-metric-value" id="gdIsoSpreadPct">0%</div>
            </div>
            <div class="gd-iso-metric">
              <div class="gd-iso-metric-label">Commission Est.</div>
              <div class="gd-iso-metric-value" id="gdIsoComm">$0</div>
            </div>
          </div>

          <div style="margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border-secondary);">
            <div style="font-weight: 800; margin-bottom: 8px; color: var(--text-primary);">Merchant Branding</div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Company Name</label>
                <input class="form-input" id="gdIsoBrandName" placeholder="Shown to merchant">
              </div>
              <div class="form-group">
                <label class="form-label">Logo URL</label>
                <input class="form-input" id="gdIsoBrandLogo" placeholder="https://...">
              </div>
            </div>

            <div class="gd-share-link-actions">
              <button class="btn-primary" onclick="gdIsoCopyMerchantLink()">Copy Merchant Link</button>
              <button class="btn-secondary" onclick="gdIsoCopySMS()">Copy SMS</button>
              <button class="btn-secondary" onclick="gdIsoOpenEmail()">Email Draft</button>
            </div>

            <div class="form-group" style="margin-top: 10px;">
              <label class="form-label">Merchant Link</label>
              <textarea class="form-input" id="gdIsoMerchantLink" rows="2" readonly></textarea>
            </div>
          </div>
        </div>

        <div id="gdClientActions" class="gd-share-actions">
          <button class="btn-primary" onclick="gdClientRespond('accept')">Accept</button>
          <button class="btn-secondary" onclick="gdClientRespond('decline')">Decline</button>
        </div>

        <div class="gd-share-contact" id="gdShareContactInfo"></div>

        <div class="gd-share-disclaimer">
          This preapproval is provided for informational purposes and is not a commitment to fund. Terms may change based on verification, final underwriting, and program requirements.
        </div>
      </div>

      <div class="gd-share-footer">Powered by GREATDANE</div>
    </div>

    <!-- Client Accept/Decline Modal (no backend; generates an email) -->
    <div class="modal-overlay" id="gdClientActionModal">
      <div class="modal" style="max-width: 560px; width: 92%;">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="gdClientActionTitle">Respond</div>
            <div class="modal-subtitle" id="gdClientActionSubtitle">Send a response to the sender</div>
          </div>
          <button class="modal-close" onclick="gdCloseClientActionModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Your Name</label>
              <input class="form-input" id="gdClientRespName" placeholder="Name">
            </div>
            <div class="form-group">
              <label class="form-label">Your Email</label>
              <input class="form-input" id="gdClientRespEmail" placeholder="email@business.com">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Message (optional)</label>
            <textarea class="form-input" id="gdClientRespMsg" rows="3" placeholder="Add a note..."></textarea>
          </div>
          <div style="display:flex; gap: 12px; flex-wrap: wrap; margin-top: 10px;">
            <button class="btn-primary" onclick="gdSendClientResponse()">Send</button>
            <button class="btn-secondary" onclick="gdCopyClientResponse()">Copy Response</button>
          </div>
          <div class="gd-inline-help" style="margin-top: 10px;">This tool is linkonly (no server). Send opens your email client with a prefilled message.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Share Profile Modal -->
  <div class="modal-overlay" id="shareProfileModal">
    <div class="modal" style="max-width: 600px; width: 95%;">
      <div class="modal-header">
        <div>
          <div class="modal-title">Share Business Profile</div>
          <div class="modal-subtitle">Generate a shareable link to this deal's full profile</div>
        </div>
        <button class="modal-close" onclick="closeShareProfileModal()"></button>
      </div>
      <div class="modal-body" style="max-height: 65vh; overflow-y: auto;">
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <svg viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="2" style="width: 24px; height: 24px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            </div>
            <div>
              <div id="shareProfileBusinessName" style="font-size: 1.1rem; font-weight: 700;"></div>
              <div id="shareProfileOwnerName" style="font-size: 0.85rem; color: var(--text-muted);"></div>
            </div>
          </div>
          
          <div style="font-weight: 600; margin-bottom: 12px;">What's included in the shared profile:</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85rem;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="shareIncludeBusiness" checked style="accent-color: var(--accent);">
              Business Information
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="shareIncludeOwner" checked style="accent-color: var(--accent);">
              Owner Information
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="shareIncludeFinancials" checked style="accent-color: var(--accent);">
              Monthly Financials
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="shareIncludeScore" checked style="accent-color: var(--accent);">
              ABLESCORE Rating
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="shareIncludeResearch" style="accent-color: var(--accent);">
              Deep Research
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="shareIncludeCredit" style="accent-color: var(--accent);">
              Credit Summary
            </label>
          </div>
        </div>
        
        <div id="shareProfileLinkSection" style="display: none;">
          <div style="font-weight: 600; margin-bottom: 8px;">Shareable Link</div>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="shareProfileLinkInput" class="form-input" readonly style="flex: 1; font-size: 0.8rem;">
            <button class="btn-primary" onclick="copyShareProfileLink()" style="white-space: nowrap;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              Copy
            </button>
          </div>
          <div style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; font-size: 0.8rem; color: var(--tier-a);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; display: inline; vertical-align: middle; margin-right: 6px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Link generated! Anyone with this link can view the profile.
          </div>
        </div>
        
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.75rem; color: var(--text-muted);">
          <strong>Note:</strong> Shared profiles are read-only and contain a snapshot of the current deal data. The link encodes the data directly - no server storage required.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeShareProfileModal()">Cancel</button>
        <button class="btn-primary" onclick="generateShareProfileLink()" id="generateShareProfileBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
          Generate Link
        </button>
      </div>
    </div>
  </div>

  <!-- Shared Profile View (displays when URL has share data) -->
  <div id="sharedProfileView" class="gd-share-overlay hidden">
    <div class="gd-share-shell" style="max-width: 900px;">
      <div class="gd-share-top">
        <div class="gd-share-brand">
          <svg viewBox="0 0 100 100" style="width: 40px; height: 40px;">
            <defs><linearGradient id="spGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#eab308"/><stop offset="100%" style="stop-color:#ca8a04"/></linearGradient></defs>
            <ellipse cx="50" cy="50" rx="40" ry="10" fill="none" stroke="rgba(234,179,8,0.5)" stroke-width="2" transform="rotate(-15 50 50)"/>
            <circle cx="50" cy="50" r="22" fill="url(#spGrad)"/>
          </svg>
          <div>
            <div class="gd-share-company" id="spBusinessName">Business Profile</div>
            <div class="gd-share-mode">Shared via GREATDANE</div>
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button class="btn-secondary" onclick="printSharedProfile()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Print
          </button>
        </div>
      </div>
      
      <div id="spContent" style="padding: 24px;">
        <!-- Score Banner -->
        <div id="spScoreBanner" style="display: flex; align-items: center; gap: 20px; background: var(--bg-secondary); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
          <div id="spScoreCircle" style="width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; background: var(--bg-tertiary);"></div>
          <div>
            <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em;">ABLESCORE</div>
            <div id="spScoreLabel" style="font-size: 1.25rem; font-weight: 700;"></div>
          </div>
          <div style="margin-left: auto; text-align: right;">
            <div id="spFico" style="font-size: 1.5rem; font-weight: 700; color: var(--accent);"></div>
            <div style="font-size: 0.75rem; color: var(--text-muted);">Owner FICO</div>
          </div>
        </div>
        
        <!-- Business & Owner Info Grid -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
          <div id="spBusinessInfo" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px;"></div>
          <div id="spOwnerInfo" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px;"></div>
        </div>
        
        <!-- Financials -->
        <div id="spFinancials" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px;"></div>
        
        <!-- Research Summary -->
        <div id="spResearch" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none;"></div>
        
        <!-- Credit Summary -->
        <div id="spCredit" style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; display: none;"></div>
      </div>
      
      <div class="gd-share-footer">
        Shared via GREATDANE  Generated <span id="spTimestamp"></span>
      </div>
    </div>
  </div>

<script>
let allDeals = [];
let currentDeal = null;
let currentOfferTab = 'conservative';
let scoreChart = null;
let volumeChart = null;
let revenueTrendChart = null;
let completionChart = null;
let dealCashflowChart = null;
let metricChart = null;
const TIER_COLORS = { a: '#22c55e', b: '#84cc16', c: '#eab308', d: '#f97316', e: '#ef4444' };

document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  loadDealsFromStorage();
  updateDashboard();
  initSidebarState();
  // Check if already logged in
  if (sessionStorage.getItem('greatdane_logged_in') === 'true') {
    document.getElementById('loginOverlay').classList.add('hidden');
  }
  document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') handleLogin(); });
  document.getElementById('entitySearchInput').addEventListener('keydown', e => { if (e.key === 'Enter') createDealAndSearch(); });
  
  // Setup dropzone drag-drop for both regular and mini dropzone
  const setupDropzone = (elementId) => {
    const dropzone = document.getElementById(elementId);
    if (dropzone) {
      ['dragenter', 'dragover'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('dragover'); });
      });
      ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
      });
      dropzone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length) handleQuickScrub({ target: { files } });
      });
    }
  };
  
  setupDropzone('quickScrubZone');
  setupDropzone('miniQuickScrubZone');
  
  // Setup dashboard Quick Scrub zone with special handling
  const dashboardZone = document.getElementById('dashboardQuickScrubZone');
  if (dashboardZone) {
    ['dragenter', 'dragover'].forEach(evt => {
      dashboardZone.addEventListener(evt, e => { 
        e.preventDefault(); 
        e.stopPropagation();
        dashboardZone.style.borderColor = 'var(--tier-a)';
        dashboardZone.style.background = 'rgba(234,179,8,0.15)';
      });
    });
    ['dragleave'].forEach(evt => {
      dashboardZone.addEventListener(evt, e => { 
        e.preventDefault();
        dashboardZone.style.borderColor = 'var(--accent)';
        dashboardZone.style.background = 'linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%)';
      });
    });
    dashboardZone.addEventListener('drop', e => {
      e.preventDefault();
      e.stopPropagation();
      dashboardZone.style.borderColor = 'var(--accent)';
      dashboardZone.style.background = 'linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%)';
      const files = e.dataTransfer.files;
      if (files.length) {
        handleDashboardQuickScrubFiles(files);
      }
    });
  }
  
  // Share profile modal backdrop click
  const spModal = document.getElementById('shareProfileModal');
  if (spModal) {
    spModal.addEventListener('click', e => {
      if (e.target === spModal) closeShareProfileModal();
    });
  }
});

function handleLogin() {
  const pass = document.getElementById('loginPass').value;
  const user = document.getElementById('loginUser').value;
  const role = document.getElementById('loginRole')?.value || 'underwriter';
  
  if (pass.endsWith('!#')) {
    sessionStorage.setItem('greatdane_logged_in', 'true');
    // Save username and role
    const displayName = user ? user.split('@')[0] : 'User';
    localStorage.setItem('greatdane_username', displayName);
    localStorage.setItem('greatdane_role', role);
    updateHeaderUsername(displayName);
    document.getElementById('loginOverlay').classList.add('hidden');
    
    // If ISO role, show ISO portal
    if (role === 'iso') {
      showISOPortal();
    }
  } else {
    document.getElementById('loginError').classList.add('active');
    document.getElementById('loginPass').classList.add('shake');
    setTimeout(() => document.getElementById('loginPass').classList.remove('shake'), 400);
  }
}

function getCurrentUserRole() {
  return localStorage.getItem('greatdane_role') || 'underwriter';
}

function showISOPortal() {
  document.getElementById('isoPortalModal')?.classList.add('active');
  renderISOPortal();
}

function closeISOPortal() {
  document.getElementById('isoPortalModal')?.classList.remove('active');
}

function renderISOPortal() {
  const isoName = localStorage.getItem('greatdane_username') || 'ISO Partner';
  const isoDeals = allDeals.filter(d => d.isoName === isoName || d.submittedBy === isoName);
  
  const funded = isoDeals.filter(d => d.status === 'funded');
  const totalVolume = funded.reduce((a, d) => a + (d.fundedAmount || 0), 0);
  
  // Calculate commission based on buy/sell rate spread
  let totalCommission = 0;
  let totalSpread = 0;
  funded.forEach(d => {
    const buyRate = d.buyRate || 1.25;
    const sellRate = d.sellRate || d.factorRate || 1.35;
    const spread = sellRate - buyRate;
    const fundingAmount = d.fundedAmount || 0;
    const payback = fundingAmount * sellRate;
    const buyPayback = fundingAmount * buyRate;
    const commission = payback - buyPayback; // ISO keeps the spread
    totalCommission += commission;
    totalSpread += spread;
  });
  const avgSpread = funded.length ? (totalSpread / funded.length) : 0;
  
  document.getElementById('isoPortalStats').innerHTML = `
    <div class="analytics-card">
      <div class="analytics-label">Deals Submitted</div>
      <div class="analytics-value">${isoDeals.length}</div>
    </div>
    <div class="analytics-card">
      <div class="analytics-label">Funded Volume</div>
      <div class="analytics-value text-positive">$${Math.round(totalVolume).toLocaleString()}</div>
    </div>
    <div class="analytics-card">
      <div class="analytics-label">Total Commission</div>
      <div class="analytics-value text-accent">$${Math.round(totalCommission).toLocaleString()}</div>
      <div style="font-size: 0.7rem; color: var(--text-muted);">Avg spread: ${(avgSpread * 100).toFixed(1)} pts</div>
    </div>
    <div class="analytics-card">
      <div class="analytics-label">Approval Rate</div>
      <div class="analytics-value">${isoDeals.length ? Math.round(funded.length / isoDeals.length * 100) : 0}%</div>
    </div>
  `;
  
  document.getElementById('isoPortalDeals').innerHTML = isoDeals.length ? isoDeals.map(d => {
    const status = DEAL_STATUSES.find(s => s.id === d.status) || DEAL_STATUSES[0];
    const buyRate = d.buyRate || 1.25;
    const sellRate = d.sellRate || d.factorRate || 1.35;
    const spread = sellRate - buyRate;
    const commission = d.fundedAmount ? Math.round(d.fundedAmount * spread) : 0;
    
    return `
      <div class="renewal-card" style="cursor: pointer;" onclick="viewISODealDetail(${d.id})">
        <div class="renewal-header">
          <div>
            <div style="font-weight: 700;">${d.businessName || 'Untitled'}</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">Submitted ${new Date(d.createdAt).toLocaleDateString()}</div>
          </div>
          <span class="status-badge status-${status.id}">${status.label}</span>
        </div>
        <div style="display: flex; gap: 24px; margin-top: 12px; flex-wrap: wrap;">
          <div><span style="color: var(--text-muted); font-size: 0.75rem;">Score</span><div style="font-weight: 700;">${d.score || 0}</div></div>
          <div><span style="color: var(--text-muted); font-size: 0.75rem;">FICO</span><div style="font-weight: 700;">${d.fico || 'N/A'}</div></div>
          <div><span style="color: var(--text-muted); font-size: 0.75rem;">Industry</span><div style="font-weight: 700;">${d.industry || 'N/A'}</div></div>
          ${d.fundedAmount ? `
            <div><span style="color: var(--text-muted); font-size: 0.75rem;">Funded</span><div style="font-weight: 700; color: var(--tier-a);">$${Math.round(d.fundedAmount).toLocaleString()}</div></div>
            <div><span style="color: var(--text-muted); font-size: 0.75rem;">Buy Rate</span><div style="font-weight: 700;">${buyRate.toFixed(2)}</div></div>
            <div><span style="color: var(--text-muted); font-size: 0.75rem;">Sell Rate</span><div style="font-weight: 700;">${sellRate.toFixed(2)}</div></div>
            <div><span style="color: var(--text-muted); font-size: 0.75rem;">Commission</span><div style="font-weight: 700; color: var(--accent);">$${commission.toLocaleString()}</div></div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('') : '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No deals submitted yet. Submit your first deal above!</div>';
}

function submitISODeal() {
  const businessName = document.getElementById('isoBusinessName')?.value;
  const ownerName = document.getElementById('isoOwnerName')?.value;
  const industry = document.getElementById('isoIndustry')?.value;
  const fico = parseInt(document.getElementById('isoFico')?.value) || 650;
  const notes = document.getElementById('isoNotes')?.value;
  
  if (!businessName) {
    alert('Please enter a business name');
    return;
  }
  
  const isoName = localStorage.getItem('greatdane_username') || 'ISO Partner';
  
  const deal = {
    id: Date.now(),
    businessName,
    ownerName,
    industry,
    fico,
    notes,
    isoName,
    submittedBy: isoName,
    status: 'new',
    score: 0,
    months: [],
    createdAt: new Date().toISOString()
  };
  
  allDeals.unshift(deal);
  saveDealsToStorage();
  
  // Clear form
  document.getElementById('isoBusinessName').value = '';
  document.getElementById('isoOwnerName').value = '';
  document.getElementById('isoIndustry').value = '';
  document.getElementById('isoFico').value = '';
  document.getElementById('isoNotes').value = '';
  
  renderISOPortal();
  triggerWebhook('newDeal', deal);
  showToast('Deal Submitted', `${businessName} has been submitted for review`);
}

function viewISODealDetail(dealId) {
  const deal = allDeals.find(d => d.id === dealId);
  if (!deal) return;
  
  alert(`Deal: ${deal.businessName}\nStatus: ${deal.status}\nScore: ${deal.score}\nFICO: ${deal.fico}\n\nContact your account manager for more details.`);
}

function updateHeaderUsername(name) {
  const el = document.getElementById('headerUsername');
  if (el) el.textContent = name || 'User';
  
  // Update role display
  const role = localStorage.getItem('greatdane_role') || 'underwriter';
  const roleEl = document.getElementById('headerRole');
  if (roleEl) {
    roleEl.textContent = role === 'iso' ? '(ISO)' : role === 'manager' ? '(MGR)' : '';
  }
  
  // Show ISO portal button if ISO
  const isoBtn = document.getElementById('isoPortalBtn');
  if (isoBtn) {
    isoBtn.style.display = role === 'iso' ? '' : 'none';
  }
}

function initUsername() {
  const saved = localStorage.getItem('greatdane_username');
  if (saved) updateHeaderUsername(saved);
}

function toggleTheme() {
  const current = document.body.dataset.theme || 'dark';
  const next = current === 'light' ? 'dark' : 'light';
  setTheme(next);
}

function setTheme(theme) {
  document.body.classList.remove('light-mode', 'black-mode');
  document.body.dataset.theme = theme;
  
  if (theme === 'light') {
    document.body.classList.add('light-mode');
  } else if (theme === 'black') {
    document.body.classList.add('black-mode');
  }
  
  localStorage.setItem('greatdane_theme', theme);
  updateThemeButtons();
}

function setAccentColor(color) {
  const colors = {
    gold: { accent: '#eab308', dark: '#ca8a04' },
    blue: { accent: '#3b82f6', dark: '#2563eb' },
    green: { accent: '#22c55e', dark: '#16a34a' },
    purple: { accent: '#a855f7', dark: '#9333ea' },
    red: { accent: '#ef4444', dark: '#dc2626' },
    cyan: { accent: '#06b6d4', dark: '#0891b2' },
    orange: { accent: '#f97316', dark: '#ea580c' },
    pink: { accent: '#ec4899', dark: '#db2777' }
  };
  
  const c = colors[color] || colors.gold;
  document.documentElement.style.setProperty('--accent', c.accent);
  document.documentElement.style.setProperty('--accent-dark', c.dark);
  localStorage.setItem('greatdane_accent', color);
  updateAccentButtons();
}

function updateThemeButtons() {
  const theme = localStorage.getItem('greatdane_theme') || 'dark';
  document.querySelectorAll('.theme-option').forEach(btn => {
    if (btn.dataset.theme === theme) {
      btn.style.borderColor = 'var(--accent)';
      btn.style.boxShadow = '0 0 0 2px var(--accent)';
    } else {
      btn.style.borderColor = 'var(--border-primary)';
      btn.style.boxShadow = 'none';
    }
  });
}

function updateAccentButtons() {
  const accent = localStorage.getItem('greatdane_accent') || 'gold';
  document.querySelectorAll('.accent-option').forEach(btn => {
    if (btn.dataset.accent === accent) {
      btn.style.borderColor = '#fff';
      btn.style.transform = 'scale(1.1)';
    } else {
      btn.style.borderColor = 'transparent';
      btn.style.transform = 'scale(1)';
    }
  });
}

function toggleSidebar() {
  const sidebar = document.getElementById('dealsSidebar');
  sidebar.classList.toggle('collapsed');
  const isCollapsed = sidebar.classList.contains('collapsed');
  localStorage.setItem('greatdane_sidebar_collapsed', isCollapsed ? 'true' : 'false');
}

function initSidebar() {
  const saved = localStorage.getItem('greatdane_sidebar_collapsed');
  const isMobile = window.innerWidth <= 900;
  if (isMobile || saved === 'true') {
    document.getElementById('dealsSidebar').classList.add('collapsed');
  }
}

function initTheme() {
  const savedTheme = localStorage.getItem('greatdane_theme') || 'dark';
  const savedAccent = localStorage.getItem('greatdane_accent') || 'gold';
  
  setTheme(savedTheme);
  setAccentColor(savedAccent);
}
// Run immediately
initTheme();
initSidebar();
initUsername();

function initCharts() {
  const baseOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

  // Score Distribution (Pipeline)
  scoreChart = new Chart(document.getElementById('scoreChart'), {
    type: 'doughnut',
    data: {
      labels: ['Tier A (85+)', 'Tier B (70-84)', 'Tier C (55-69)', 'Tier D (40-54)', 'Tier E (<40)'],
      datasets: [{
        data: [0,0,0,0,0],
        backgroundColor: [TIER_COLORS.a, TIER_COLORS.b, TIER_COLORS.c, TIER_COLORS.d, TIER_COLORS.e],
        borderWidth: 0
      }]
    },
    options: {
      ...baseOpts,
      cutout: '65%',
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            color: '#a1a1aa',
            font: { size: 11, family: 'DM Sans' },
            padding: 12,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        }
      }
    }
  });

  // Deal Activity (created per month)
  volumeChart = new Chart(document.getElementById('volumeChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Deals', data: [], backgroundColor: '#eab308', borderRadius: 6 }] },
    options: {
      ...baseOpts,
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a', font: { family: 'DM Sans' } } },
        x: { grid: { display: false }, ticks: { color: '#71717a', font: { family: 'DM Sans' } } }
      }
    }
  });

  // Revenue Trend (total revenue across all deals by month)
  revenueTrendChart = new Chart(document.getElementById('revenueTrendChart'), {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Revenue', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.08)', fill: true, tension: 0.35 }] },
    options: {
      ...baseOpts,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });

  // Data Completeness (distribution)
  completionChart = new Chart(document.getElementById('completionChart'), {
    type: 'bar',
    data: { labels: ['0-39%', '40-59%', '60-79%', '80-100%'], datasets: [{ label: 'Deals', data: [0,0,0,0], backgroundColor: '#a855f7', borderRadius: 6 }] },
    options: {
      ...baseOpts,
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });
}

function renderDealList() {
  const c = document.getElementById('dealList');
  const pipelineTotal = document.getElementById('pipelineTotal');
  if (!c) return;
  
  if (!allDeals.length) {
    c.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>No deals yet</h3><p>No deals yet. Upload bank statements to get started.</p></div>';
    if (pipelineTotal) pipelineTotal.textContent = '0';
    return;
  }

  c.innerHTML = allDeals.map((d, i) => {
    const tc = d.score >= 85 ? TIER_COLORS.a : d.score >= 70 ? TIER_COLORS.b : d.score >= 55 ? TIER_COLORS.c : d.score >= 40 ? TIER_COLORS.d : TIER_COLORS.e;
    const active = currentDeal && currentDeal.id === d.id;
    const isSelected = batchSelectedDeals.has(d.id);

    const comp = calcDealCompleteness(d).pct;
    const compColor = comp >= 80 ? 'var(--tier-a)' : comp >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
    const ent = d.entityData ? Math.round(d.entityData.confidence || 0) : null;
    const entColor = ent === null ? 'var(--text-muted)' : ent >= 80 ? 'var(--tier-a)' : ent >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
    const bank = d.bankData ? Math.round(d.bankData.confidence || 0) : null;
    
    const status = d.status || 'new';
    const statusObj = DEAL_STATUSES.find(s => s.id === status) || DEAL_STATUSES[0];

    return `
      <div class="deal-item ${active ? 'active' : ''}" onclick="selectDeal(${i})">
        <div style="display: flex; align-items: flex-start; gap: 8px;">
          <div class="batch-checkbox ${isSelected ? 'checked' : ''}" data-deal-id="${d.id}" onclick="toggleBatchSelect(${d.id}, event)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div class="deal-item-top">
              <div class="deal-item-name">${d.businessName || 'Untitled Deal'}</div>
              <div class="deal-item-score" style="color: ${tc};">${d.score || 0}</div>
            </div>
            <div class="deal-item-meta">
              <div class="deal-item-industry">${d.industry || 'No industry'}</div>
              <div class="deal-item-owner">${d.ownerName || 'No owner'}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 6px; margin-top: 6px;">
              ${renderStatusDropdown(d.id, status)}
              ${d.assignedTo ? `<span style="font-size: 0.65rem; color: var(--text-muted);">@ ${d.assignedTo}</span>` : ''}
            </div>
            <div class="deal-item-submeta">
              <span class="deal-badge"><span style="width:6px;height:6px;border-radius:999px;background:${compColor};display:inline-block;"></span><span>${comp}% profile</span></span>
              <span class="deal-badge"><span style="width:6px;height:6px;border-radius:999px;background:${entColor};display:inline-block;"></span><span>${ent === null ? 'entity ' : `entity ${ent}%`}</span></span>
              <span class="deal-badge"><span style="width:6px;height:6px;border-radius:999px;background:${bank === null ? 'var(--text-muted)' : (bank >= 70 ? 'var(--tier-a)' : bank >= 50 ? 'var(--tier-c)' : 'var(--tier-e)')};display:inline-block;"></span><span>${bank === null ? 'bank ' : `bank ${bank}%`}</span></span>
            </div>
            <div class="deal-item-progress">
              <div class="deal-item-progress-bar" style="width: ${Math.min(100, Math.max(0, d.score || 0))}%; background: ${tc};"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  if (pipelineTotal) pipelineTotal.textContent = allDeals.length;
}

function filterDeals(q) {
  document.querySelectorAll('.deal-item').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

function addNewDeal() {
  const d = { id: Date.now(), businessName: 'New Business', dba: '', industry: '', tib: '', address: '', stateCode: '', entityType: '', entityStatus: '', formationDate: '', website: '', phone: '', ownerName: '', ownerEmail: '', ownerPhone: '', fico: 650, ownership: 100, score: 0, months: [], bankData: null, entityData: null, _fieldSource: {}, createdAt: new Date().toISOString() };
  allDeals.unshift(d);
  saveDealsToStorage();
  renderDealList();
  selectDeal(0);
  
  // Trigger webhook for new deal
  triggerWebhook('newDeal', d);
}

function selectDeal(i) {
  currentDeal = allDeals[i];
  showDetailView();
  populateDetailView();
}

function showDashboard() {
  const dashboardView = document.getElementById('dashboardView');
  const detailView = document.getElementById('detailView');
  if (dashboardView) dashboardView.style.display = 'block';
  if (detailView) detailView.classList.remove('active');
  currentDeal = null;
  updateDashboard();
  renderDealList();
}

function showDetailView() {
  const dashboardView = document.getElementById('dashboardView');
  const detailView = document.getElementById('detailView');
  if (dashboardView) dashboardView.style.display = 'none';
  if (detailView) detailView.classList.add('active');
}

function populateDetailView() {
  if (!currentDeal) return;
  
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = val || '';
  };
  
  setVal('editLegalName', currentDeal.businessName);
  setVal('editDba', currentDeal.dba);
  setVal('editIndustry', currentDeal.industry);
  setVal('editTib', currentDeal.tib);
  setVal('editAddress', currentDeal.address);
  setVal('editStateCode', currentDeal.stateCode);
  setVal('editEntityType', currentDeal.entityType);
  setVal('editEntityStatus', currentDeal.entityStatus);
  setVal('editFormationDate', currentDeal.formationDate);
  setVal('editWebsite', currentDeal.website);
  setVal('editPhone', currentDeal.phone);
  setVal('editOwnerName', currentDeal.ownerName);
  setVal('editOwnerEmail', currentDeal.ownerEmail);
  setVal('editOwnerPhone', currentDeal.ownerPhone);
  setVal('editFico', currentDeal.fico);
  setVal('editOwnership', currentDeal.ownership);

  renderFinancialTable();
  recalculateScore();
  updateOffer();
  updateProfileCompletenessUI();
  renderEntityVerificationCard();
  renderBankSummaryCard();
  renderDealInsights();
  renderDeepResearchCard();
  renderAllReportSections();
  updateIntelBadges();
  updateMetricsPanel();
  
  // Render stacking alert if applicable
  const stackingContainer = document.getElementById('stackingAlertContainer');
  if (stackingContainer) {
    stackingContainer.innerHTML = renderStackingAlert(currentDeal);
  }
  
  // Clear Hubble chat when switching deals
  clearHubbleChat();
  
  // Update sidebar panels
  updateSidebarPanels();
  
  // Auto-trigger all searches if business name exists (run in parallel immediately)
  if (currentDeal.businessName && getGeminiApiKey()) {
    if (!currentDeal.deepResearch) runDeepResearchAuto();
    if (!currentDeal.clearReport) runBackgroundAuto();
    if (!currentDeal.footprintReport) runFootprintAuto();
    if (currentDeal.months?.length > 0 && !currentDeal.debtReport) runDebtAnalysisAuto();
  }
}

function updateMetricsPanel() {
  if (!currentDeal) return;
  
  const months = currentDeal.months || [];
  const totalRev = months.reduce((s, m) => s + (m.revenue || 0), 0);
  const avgRev = months.length ? Math.round(totalRev / months.length) : 0;
  const totalDeposits = months.reduce((s, m) => s + (m.deposits || 0), 0);
  const avgDailyBal = months.length ? Math.round(months.reduce((s, m) => s + (m.avgDailyBal || 0), 0) / months.length) : 0;
  const totalNsf = months.reduce((s, m) => s + (m.nsfs || 0), 0);
  const totalNegDays = months.reduce((s, m) => s + (m.negatives || 0), 0);
  
  // Update metric cards with animation
  const setMetric = (id, value, format = 'number') => {
    const el = document.getElementById(id);
    if (!el) return;
    
    const oldText = el.textContent;
    let newText;
    if (format === 'currency') {
      newText = value ? '$' + Math.round(value).toLocaleString() : '--';
    } else {
      newText = value !== undefined && value !== null ? String(value) : '--';
    }
    
    // Only update and animate if value changed
    if (oldText !== newText) {
      el.textContent = newText;
      el.classList.add('updating');
      setTimeout(() => el.classList.remove('updating'), 500);
    }
  };
  
  setMetric('metricFico', currentDeal.fico);
  setMetric('metricAvgRev', avgRev, 'currency');
  setMetric('metricDeposits', totalDeposits, 'currency');
  setMetric('metricAvgBal', avgDailyBal, 'currency');
  setMetric('metricNsf', totalNsf);
  setMetric('metricNegDays', totalNegDays);
  
  // Color code NSF and negative days
  const nsfEl = document.getElementById('metricNsf');
  const negEl = document.getElementById('metricNegDays');
  if (nsfEl) {
    nsfEl.classList.remove('positive', 'negative', 'warning');
    if (totalNsf === 0) nsfEl.classList.add('positive');
    else if (totalNsf <= 3) nsfEl.classList.add('warning');
    else nsfEl.classList.add('negative');
  }
  if (negEl) {
    negEl.classList.remove('positive', 'negative', 'warning');
    if (totalNegDays === 0) negEl.classList.add('positive');
    else if (totalNegDays <= 5) negEl.classList.add('warning');
    else negEl.classList.add('negative');
  }
  
  // Update mini monthly chart
  updateMiniMonthlyChart();
}

function updateDealField(f, v) {
  if (!currentDeal) return;
  currentDeal[f] = v;
  currentDeal._fieldSource = currentDeal._fieldSource || {};
  currentDeal._fieldSource[f] = 'manual';
  saveDealsToStorage();
  if (f === 'businessName') renderDealList();
  updateProfileCompletenessUI();
}

function renderFinancialTable() {
  const container = document.getElementById('financialTablesContainer');
  if (!container) return;
  
  if (!currentDeal?.months?.length) {
    container.innerHTML = `
      <div class="table-wrapper">
        <table class="data-table" style="min-width: 1100px;">
          <thead>
            <tr>
              <th style="min-width: 90px;">Month</th>
              <th style="min-width: 110px;">Revenue</th>
              <th style="min-width: 100px;" title="Credits minus lender deposits, transfers, returns">True Credits</th>
              <th style="min-width: 100px;" title="Debits minus internal transfers">True Debits</th>
              <th style="min-width: 100px;">Avg Daily Bal</th>
              <th style="min-width: 80px;">Dep Count</th>
              <th style="min-width: 100px;">End Balance</th>
              <th style="min-width: 100px;">Debt Svc</th>
              <th style="min-width: 60px;">NSF</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-muted);">No financial data. Upload bank statements to begin.</td></tr>
          </tbody>
        </table>
      </div>
    `;
    return;
  }

  // Ensure normalized shape for UI
  currentDeal.months = normalizeMonths(currentDeal.months);
  
  // Apply avgDailyBal fallback for existing data that may have 0 values
  currentDeal.months.forEach(m => {
    if ((!m.avgDailyBal || m.avgDailyBal === 0) && m.endingBal > 0) {
      m.avgDailyBal = m.endingBal;
    }
  });
  
  // Group months by account
  const accountGroups = {};
  currentDeal.months.forEach((m, i) => {
    const acctId = m.accountLast4 || m.accountId || 'default';
    if (!accountGroups[acctId]) {
      accountGroups[acctId] = [];
    }
    accountGroups[acctId].push({ ...m, originalIndex: i });
  });
  
  const accountIds = Object.keys(accountGroups);
  const hasMultipleAccounts = accountIds.length > 1;
  
  // Build table HTML for each account
  let html = '';
  
  // Get account info if available
  const accounts = currentDeal.accounts || [];
  
  accountIds.forEach((acctId, acctIndex) => {
    const acctMonths = accountGroups[acctId];
    const acctInfo = accounts.find(a => a.accountLast4 === acctId || a.accountId === acctId) || {};
    const bankName = acctInfo.bankName || '';
    const acctType = acctInfo.accountType || 'Account';
    const last4Display = acctId !== 'default' ? `  ${acctId}` : '';
    
    // Calculate averages for this account
    const count = acctMonths.length;
    const avgs = {
      revenue: acctMonths.reduce((a, m) => a + (m.deposits || m.revenue || 0), 0) / count,
      trueCredits: acctMonths.reduce((a, m) => a + (m.trueCredits || 0), 0) / count,
      trueDebits: acctMonths.reduce((a, m) => a + (m.trueDebits || 0), 0) / count,
      avgDailyBal: acctMonths.reduce((a, m) => a + (m.avgDailyBal || 0), 0) / count,
      depositCount: Math.round(acctMonths.reduce((a, m) => a + (m.depositCount || 0), 0) / count),
      endingBal: acctMonths.reduce((a, m) => a + (m.endingBal || 0), 0) / count,
      debtService: acctMonths.reduce((a, m) => a + (m.debtService || 0), 0) / count,
      nsfs: acctMonths.reduce((a, m) => a + (m.nsfs || 0), 0)
    };
    
    const acctLabel = hasMultipleAccounts ? 
      `<div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 12px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; display: inline-flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        ${bankName ? bankName + ' - ' : ''}${acctType}${last4Display}
      </div>` : '';
    
    const rows = acctMonths.map((m, rowIdx) => `
      <tr class="table-row-animate" style="animation-delay: ${rowIdx * 0.05}s;">
        <td>${m.monthLabel || m.month || ''}</td>
        <td><input class="table-input table-positive" value="${formatCurrency(m.deposits || m.revenue)}" onchange="updateMonth(${m.originalIndex}, 'deposits', this.value)"></td>
        <td><input class="table-input table-positive" value="${formatCurrency(m.trueCredits)}" onchange="updateMonth(${m.originalIndex}, 'trueCredits', this.value)"></td>
        <td><input class="table-input table-negative" value="${formatCurrency(m.trueDebits)}" onchange="updateMonth(${m.originalIndex}, 'trueDebits', this.value)"></td>
        <td><input class="table-input" value="${formatCurrency(m.avgDailyBal)}" onchange="updateMonth(${m.originalIndex}, 'avgDailyBal', this.value)"></td>
        <td><input class="table-input" value="${m.depositCount ?? 0}" onchange="updateMonth(${m.originalIndex}, 'depositCount', this.value)"></td>
        <td><input class="table-input" value="${formatCurrency(m.endingBal)}" onchange="updateMonth(${m.originalIndex}, 'endingBal', this.value)"></td>
        <td><input class="table-input ${m.debtService > 0 ? 'table-warning' : ''}" value="${formatCurrency(m.debtService)}" onchange="updateMonth(${m.originalIndex}, 'debtService', this.value)"></td>
        <td><input class="table-input ${m.nsfs > 0 ? 'table-negative' : ''}" value="${m.nsfs || 0}" onchange="updateMonth(${m.originalIndex}, 'nsfs', this.value)"></td>
      </tr>
    `).join('');
    
    const avgRow = `
      <tr style="background: var(--bg-tertiary); font-weight: 600; border-top: 2px solid var(--accent);">
        <td style="color: var(--accent);">AVG/TOTAL</td>
        <td class="text-positive">${formatCurrency(avgs.revenue)}</td>
        <td class="text-positive">${formatCurrency(avgs.trueCredits)}</td>
        <td class="text-negative">${formatCurrency(avgs.trueDebits)}</td>
        <td>${formatCurrency(avgs.avgDailyBal)}</td>
        <td>${avgs.depositCount}</td>
        <td>${formatCurrency(avgs.endingBal)}</td>
        <td class="${avgs.debtService > 0 ? 'text-warning' : ''}">${formatCurrency(avgs.debtService)}</td>
        <td class="${avgs.nsfs > 0 ? 'text-negative' : ''}">${avgs.nsfs}</td>
      </tr>
    `;
    
    html += `
      <div style="${acctIndex > 0 ? 'margin-top: 20px;' : ''}">
        ${acctLabel}
        <div class="table-wrapper">
          <table class="data-table" style="min-width: 1100px;">
            <thead>
              <tr>
                <th style="min-width: 90px;">Month</th>
                <th style="min-width: 110px;">Revenue</th>
                <th style="min-width: 100px;" title="Credits minus lender deposits, transfers, returns">True Credits</th>
                <th style="min-width: 100px;" title="Debits minus internal transfers">True Debits</th>
                <th style="min-width: 100px;">Avg Daily Bal</th>
                <th style="min-width: 80px;">Dep Count</th>
                <th style="min-width: 100px;">End Balance</th>
                <th style="min-width: 100px;">Debt Svc</th>
                <th style="min-width: 60px;">NSF</th>
              </tr>
            </thead>
            <tbody>${rows}${avgRow}</tbody>
          </table>
        </div>
      </div>
    `;
  });
  
  // If multiple accounts, add a combined summary
  if (hasMultipleAccounts) {
    const allMonths = currentDeal.months;
    const count = allMonths.length;
    const combined = {
      revenue: allMonths.reduce((a, m) => a + (m.deposits || m.revenue || 0), 0) / count,
      trueCredits: allMonths.reduce((a, m) => a + (m.trueCredits || 0), 0) / count,
      trueDebits: allMonths.reduce((a, m) => a + (m.trueDebits || 0), 0) / count,
      avgDailyBal: allMonths.reduce((a, m) => a + (m.avgDailyBal || 0), 0) / count,
      depositCount: Math.round(allMonths.reduce((a, m) => a + (m.depositCount || 0), 0) / count),
      endingBal: allMonths.reduce((a, m) => a + (m.endingBal || 0), 0) / count,
      debtService: allMonths.reduce((a, m) => a + (m.debtService || 0), 0) / count,
      nsfs: allMonths.reduce((a, m) => a + (m.nsfs || 0), 0)
    };
    
    html += `
      <div style="margin-top: 24px; padding-top: 20px; border-top: 2px dashed var(--border-primary);">
        <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 12px; padding: 8px 12px; background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05)); border: 1px solid var(--accent); border-radius: 8px; display: inline-flex; align-items: center; gap: 8px; color: var(--accent);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          Combined Summary (${accountIds.length} Accounts)
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg Revenue</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--tier-a);">${formatCurrency(combined.revenue)}</div>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg True Credits</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--tier-a);">${formatCurrency(combined.trueCredits)}</div>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg True Debits</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: var(--tier-d);">${formatCurrency(combined.trueDebits)}</div>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg Daily Bal</div>
            <div style="font-size: 1.1rem; font-weight: 700;">${formatCurrency(combined.avgDailyBal)}</div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 12px;">
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg Dep Count</div>
            <div style="font-size: 1.1rem; font-weight: 700;">${combined.depositCount}</div>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg End Bal</div>
            <div style="font-size: 1.1rem; font-weight: 700;">${formatCurrency(combined.endingBal)}</div>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Avg Debt Svc</div>
            <div style="font-size: 1.1rem; font-weight: 700; ${combined.debtService > 0 ? 'color: var(--tier-d);' : ''}">${formatCurrency(combined.debtService)}</div>
          </div>
          <div style="background: var(--bg-secondary); border-radius: 10px; padding: 14px; text-align: center;">
            <div style="font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 6px;">Total NSFs</div>
            <div style="font-size: 1.1rem; font-weight: 700; ${combined.nsfs > 0 ? 'color: var(--tier-e);' : ''}">${combined.nsfs}</div>
          </div>
        </div>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function updateMonth(i, f, v) {
  if (!currentDeal?.months?.[i]) return;

  const currencyFields = new Set(['revenue','deposits','withdrawals','endingBal','avgDailyBal','overdraftFees','transfers','debtService','trueDeposits']);
  const intFields = new Set(['nsfs','negatives','depositCount']);

  if (currencyFields.has(f)) currentDeal.months[i][f] = parseCurrency(v);
  else if (intFields.has(f)) currentDeal.months[i][f] = parseInt(String(v).replace(/[^0-9-]/g, ''), 10) || 0;
  else currentDeal.months[i][f] = v;
  
  // Recalculate true deposits when deposits or transfers change
  if (f === 'deposits' || f === 'transfers') {
    const m = currentDeal.months[i];
    m.trueDeposits = (m.deposits || 0) - (m.transfers || 0);
  }

  // Maintain month normalization
  currentDeal.months = normalizeMonths(currentDeal.months);

  saveDealsToStorage();
  recalculateScore();
  renderDealInsights();
  updateProfileCompletenessUI();
}

function recalculateScore() {
  if (!currentDeal) return;
  
  // Component tracking
  let ficoComponent = 0;
  let revenueComponent = 0;
  let nsfPenalty = 0;
  let negDaysPenalty = 0;
  
  // Base score
  let s = 50;
  
  // FICO Component (+20 to -15)
  const fico = parseInt(currentDeal.fico) || 0;
  if (fico >= 700) ficoComponent = 20;
  else if (fico >= 650) ficoComponent = 10;
  else if (fico >= 600) ficoComponent = 0;
  else ficoComponent = -15;
  s += ficoComponent;
  
  // Revenue Consistency Component (+15 to -10)
  if (currentDeal.months?.length >= 3) {
    const revs = currentDeal.months.map(m => m.revenue);
    const avg = revs.reduce((a, b) => a + b, 0) / revs.length;
    if (avg > 0) {
      const variance = revs.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / revs.length;
      const cv = Math.sqrt(variance) / avg;
      if (cv < 0.2) revenueComponent = 15;
      else if (cv < 0.4) revenueComponent = 5;
      else revenueComponent = -10;
      s += revenueComponent;
    }
  }
  
  // NSF Penalty (-3 per NSF, max -30)
  const totalNSF = currentDeal.months?.reduce((a, m) => a + (m.nsfs || 0), 0) || 0;
  nsfPenalty = Math.min(totalNSF * 3, 30);
  s -= nsfPenalty;
  
  // Negative Days Penalty (-2 per day, max -20)
  const totalNeg = currentDeal.months?.reduce((a, m) => a + (m.negatives || 0), 0) || 0;
  negDaysPenalty = Math.min(totalNeg * 2, 20);
  s -= negDaysPenalty;
  
  // Final score (0-100)
  s = Math.max(0, Math.min(100, Math.round(s)));
  currentDeal.score = s;
  currentDeal.tier = s >= 85 ? 'A' : s >= 70 ? 'B' : s >= 55 ? 'C' : s >= 40 ? 'D' : 'E';
  saveDealsToStorage();
  
  // Trigger webhook for score calculation
  triggerWebhook('scoreCalc', currentDeal);
  
  // Update main score display
  const tc = s >= 85 ? TIER_COLORS.a : s >= 70 ? TIER_COLORS.b : s >= 55 ? TIER_COLORS.c : s >= 40 ? TIER_COLORS.d : TIER_COLORS.e;
  const tl = s >= 85 ? 'Excellent' : s >= 70 ? 'Good' : s >= 55 ? 'Fair' : s >= 40 ? 'Below Average' : 'High Risk';
  const mainScoreEl = document.getElementById('mainScore');
  const scoreTierEl = document.getElementById('scoreTier');
  const scoreRingEl = document.getElementById('scoreRing');
  
  const oldScore = mainScoreEl ? parseInt(mainScoreEl.textContent) : 0;
  
  if (mainScoreEl) {
    mainScoreEl.textContent = s;
    // Animate if score changed
    if (oldScore !== s && oldScore > 0) {
      mainScoreEl.classList.add('updating');
      setTimeout(() => mainScoreEl.classList.remove('updating'), 500);
    }
  }
  if (scoreTierEl) scoreTierEl.textContent = tl;
  if (scoreRingEl) {
    scoreRingEl.style.setProperty('--pct', s);
    scoreRingEl.style.setProperty('--score-color', tc);
    // Add pulse animation
    if (oldScore !== s && oldScore > 0) {
      scoreRingEl.style.transform = 'scale(1.05)';
      setTimeout(() => scoreRingEl.style.transform = '', 300);
    }
  }
  
  // Update component breakdown (if elements exist)
  const compFico = document.getElementById('compFico');
  const compRevenue = document.getElementById('compRevenue');
  const compNsf = document.getElementById('compNsf');
  const compNegDays = document.getElementById('compNegDays');
  const compTotal = document.getElementById('compTotal');
  
  if (compFico) {
    compFico.textContent = (ficoComponent >= 0 ? '+' : '') + ficoComponent;
    compFico.className = 'score-comp-value ' + (ficoComponent >= 0 ? 'text-positive' : 'text-negative');
  }
  if (compRevenue) {
    compRevenue.textContent = (revenueComponent >= 0 ? '+' : '') + revenueComponent;
    compRevenue.className = 'score-comp-value ' + (revenueComponent >= 0 ? 'text-positive' : 'text-negative');
  }
  if (compNsf) compNsf.textContent = nsfPenalty > 0 ? '-' + nsfPenalty : '0';
  if (compNegDays) compNegDays.textContent = negDaysPenalty > 0 ? '-' + negDaysPenalty : '0';
  if (compTotal) compTotal.textContent = s;
  
  renderDealList();
  updateOffer();
}

function setOfferTab(t) {
  currentOfferTab = t;
  document.querySelectorAll('.offer-tab').forEach(el => el.classList.toggle('active', el.dataset.offer === t));
  updateOffer();
}

let currentPaymentFrequency = 'daily';

function setPaymentFrequency(freq) {
  currentPaymentFrequency = freq;
  const freqDaily = document.getElementById('freqDaily');
  const freqWeekly = document.getElementById('freqWeekly');
  const paymentLabel = document.getElementById('paymentLabel');
  const paymentsCountLabel = document.getElementById('paymentsCountLabel');
  
  if (freqDaily) freqDaily.classList.toggle('active', freq === 'daily');
  if (freqWeekly) freqWeekly.classList.toggle('active', freq === 'weekly');
  if (paymentLabel) paymentLabel.textContent = freq === 'daily' ? 'Daily Payment' : 'Weekly Payment';
  if (paymentsCountLabel) paymentsCountLabel.textContent = freq === 'daily' ? '# of Payments' : '# of Weeks';
  updateOffer();
}

function updateOffer() {
  if (!currentDeal) return;
  const posSlider = document.getElementById('positionSlider');
  const hbSlider = document.getElementById('holdbackSlider');
  if (!posSlider || !hbSlider) return;
  
  const pm = parseFloat(posSlider.value);
  const hb = parseInt(hbSlider.value);
  
  const positionVal = document.getElementById('positionVal');
  const holdbackVal = document.getElementById('holdbackVal');
  if (positionVal) positionVal.textContent = pm.toFixed(1) + 'x';
  if (holdbackVal) holdbackVal.textContent = hb + '%';
  
  const avgRev = currentDeal.months?.length ? currentDeal.months.reduce((a, m) => a + m.revenue, 0) / currentDeal.months.length : 0;
  const cfgs = { conservative: { rm: 0.8, f: 1.35, t: 90 }, moderate: { rm: 1.0, f: 1.28, t: 120 }, aggressive: { rm: 1.3, f: 1.22, t: 180 } };
  const c = cfgs[currentOfferTab];
  const base = avgRev * c.rm * pm;
  const pb = base * c.f;
  const termDays = c.t;
  
  // Calculate based on frequency
  let payment, paymentsCount;
  if (currentPaymentFrequency === 'daily') {
    payment = pb / termDays;
    paymentsCount = termDays;
  } else {
    const weeks = Math.ceil(termDays / 5); // Business days per week
    payment = pb / weeks;
    paymentsCount = weeks;
  }
  
  const offerAmount = document.getElementById('offerAmount');
  const offerFactor = document.getElementById('offerFactor');
  const offerPayback = document.getElementById('offerPayback');
  const offerTerm = document.getElementById('offerTerm');
  const offerPayment = document.getElementById('offerPayment');
  const offerPaymentsCount = document.getElementById('offerPaymentsCount');
  
  if (offerAmount) offerAmount.textContent = '$' + Math.round(base).toLocaleString();
  if (offerFactor) offerFactor.textContent = c.f.toFixed(2);
  if (offerPayback) offerPayback.textContent = '$' + Math.round(pb).toLocaleString();
  if (offerTerm) offerTerm.textContent = termDays;
  if (offerPayment) offerPayment.textContent = '$' + Math.round(payment).toLocaleString();
  if (offerPaymentsCount) offerPaymentsCount.textContent = paymentsCount;
  
  // Store for ISO preview
  window.currentOfferData = { fundingAmount: base, payback: pb, termDays: termDays };
  updateBuySellRates();
}

function updateBuySellRates() {
  const data = window.currentOfferData || { fundingAmount: 0, payback: 0 };
  const fundingAmount = data.fundingAmount || 0;
  
  // Get buy/sell rates from sliders
  const buyRate = parseFloat(document.getElementById('isoBuyRate')?.value || 1.25);
  const sellRate = parseFloat(document.getElementById('isoSellRate')?.value || 1.35);
  const commPct = parseFloat(document.getElementById('isoCommission')?.value || 0);
  const points = parseFloat(document.getElementById('isoPoints')?.value || 0);
  
  // Calculate spread
  const spread = sellRate - buyRate;
  const spreadPts = Math.round(spread * 100);
  
  // Calculate amounts
  const buyPayback = fundingAmount * buyRate;
  const sellPayback = fundingAmount * sellRate;
  const spreadProfit = sellPayback - buyPayback; // ISO keeps this
  
  const commAmt = fundingAmount * (commPct / 100);
  const pointsAmt = fundingAmount * (points / 10000);
  const totalComp = spreadProfit + commAmt + pointsAmt;
  
  // Update displays
  if (document.getElementById('buyRateDisplay')) {
    document.getElementById('buyRateDisplay').textContent = buyRate.toFixed(2);
  }
  if (document.getElementById('sellRateDisplay')) {
    document.getElementById('sellRateDisplay').textContent = sellRate.toFixed(2);
  }
  if (document.getElementById('rateSpreadDisplay')) {
    document.getElementById('rateSpreadDisplay').textContent = spreadPts + ' pts';
    // Color code based on spread
    const el = document.getElementById('rateSpreadDisplay');
    el.style.color = spreadPts >= 10 ? 'var(--tier-a)' : spreadPts >= 5 ? 'var(--accent)' : 'var(--tier-e)';
  }
  if (document.getElementById('isoSpreadProfit')) {
    document.getElementById('isoSpreadProfit').textContent = '$' + Math.round(spreadProfit).toLocaleString();
  }
  if (document.getElementById('isoPointsCommAmt')) {
    document.getElementById('isoPointsCommAmt').textContent = '$' + Math.round(commAmt + pointsAmt).toLocaleString();
  }
  if (document.getElementById('isoTotalComp')) {
    document.getElementById('isoTotalComp').textContent = '$' + Math.round(totalComp).toLocaleString();
  }
  
  // Store rates on current deal for when it gets funded
  if (currentDeal) {
    currentDeal.buyRate = buyRate;
    currentDeal.sellRate = sellRate;
  }
}

// Alias for backward compatibility
function updateISOPreview() {
  updateBuySellRates();
}

function copyOfferToClipboard() {
  if (!currentDeal) return;
  const data = window.currentOfferData || {};
  const text = `OFFER SUMMARY
Business: ${currentDeal.businessName}
Funding Amount: $${Math.round(data.fundingAmount || 0).toLocaleString()}
Payback: $${Math.round(data.payback || 0).toLocaleString()}
Factor Rate: ${document.getElementById('offerFactor')?.textContent || '1.00'}
Term: ${data.termDays || 0} days
${currentPaymentFrequency === 'daily' ? 'Daily' : 'Weekly'} Payment: ${document.getElementById('offerPayment')?.textContent || '$0'}
# of Payments: ${document.getElementById('offerPaymentsCount')?.textContent || '0'}`;
  
  navigator.clipboard.writeText(text).then(() => {
    alert('Offer copied to clipboard!');
  });
}

function shareToToolbox() {
  if (!currentDeal) {
    alert('No deal selected. Please select a deal first.');
    return;
  }
  
  const cfgs = { 
    conservative: { rm: 0.8, f: 1.35, t: 90, label: 'Conservative' }, 
    moderate: { rm: 1.0, f: 1.28, t: 120, label: 'Moderate' }, 
    aggressive: { rm: 1.3, f: 1.22, t: 180, label: 'Aggressive' } 
  };
  
  // Get average revenue for calculations
  const avgRev = currentDeal.months?.length ? currentDeal.months.reduce((a, m) => a + m.revenue, 0) / currentDeal.months.length : 0;
  const pm = parseFloat(document.getElementById('positionSlider')?.value || 1);
  
  // Determine frequency - map to toolbox format (d=daily, w=weekly)
  const freq = currentPaymentFrequency === 'weekly' ? 'w' : 'd';
  
  // Max sell delta (spread between buy and max sell)
  const maxSellDelta = 0.07;
  
  // Build all three offer options with ISO format (buy factor + max factor)
  const offers = [];
  ['conservative', 'moderate', 'aggressive'].forEach((tier, idx) => {
    const c = cfgs[tier];
    const fundingAmount = Math.round(avgRev * c.rm * pm);
    if (fundingAmount > 0) {
      const buyFactor = c.f;
      const maxFactor = +(buyFactor + maxSellDelta).toFixed(2);
      offers.push({
        k: tier,
        l: c.label,
        a: fundingAmount,
        t: c.t,
        q: freq,
        bf: +buyFactor.toFixed(2),  // Buy factor
        mf: maxFactor,               // Max sell factor
        f: maxFactor                 // Current sell factor (defaults to max)
      });
    }
  });
  
  // If no valid offers, use current offer data
  if (offers.length === 0) {
    const data = window.currentOfferData || {};
    const c = cfgs[currentOfferTab] || cfgs.moderate;
    const buyFactor = c.f;
    const maxFactor = +(buyFactor + maxSellDelta).toFixed(2);
    offers.push({
      k: currentOfferTab,
      l: c.label || 'Offer',
      a: Math.round(data.fundingAmount || 5000),
      t: data.termDays || c.t,
      q: freq,
      bf: +buyFactor.toFixed(2),
      mf: maxFactor,
      f: maxFactor
    });
  }
  
  // Get ISO commission settings
  const commPct = parseFloat(document.getElementById('isoCommission')?.value || 10);
  const points = parseFloat(document.getElementById('isoPoints')?.value || 0);
  
  // Build ISO share data
  const shareData = {
    v: 1,
    m: 'iso',
    b: currentDeal.businessName || 'Business',
    c: currentDeal.ownerName || '',
    em: currentDeal.ownerEmail || '',
    ph: currentDeal.ownerPhone || '',
    cn: localStorage.getItem('gd_share_brandName') || '',
    logo: localStorage.getItem('gd_share_brandLogo') || '',
    ac: '#eab308',
    sf: 1,
    snd: { 
      n: localStorage.getItem('greatdane_username') || '', 
      e: localStorage.getItem('gd_share_senderEmail') || '', 
      p: '' 
    },
    iso: localStorage.getItem('gd_share_isoName') || '',
    ic: commPct,
    ip: points,
    o: offers
  };
  
  // Compress with LZString
  const json = JSON.stringify(shareData);
  const enc = LZString.compressToEncodedURIComponent(json);
  
  // Build URL to Approval Toolbox with ISO flag
  const toolboxUrl = `https://ables.ai/calculator.html?d=${enc}&iso=1`;
  
  // Copy to clipboard and show option to open
  if (navigator.clipboard) {
    navigator.clipboard.writeText(toolboxUrl).then(() => {
      if (confirm('ISO Toolbox link copied!\n\nOpen in Approval Toolbox?')) {
        window.open(toolboxUrl, '_blank');
      }
    }).catch(() => {
      prompt('Copy this link:', toolboxUrl);
    });
  } else {
    prompt('Copy this link:', toolboxUrl);
  }
}

async function createDealAndSearch() {
  const businessName = document.getElementById('entitySearchInput').value.trim();
  if (!businessName) { alert('Enter a business name to create a deal.'); return; }
  const apiKey = localStorage.getItem('greatdane_api_key');
  if (!apiKey) { alert('Enter your Gemini API key first.'); return; }
  
  // Create new deal with business name
  const newDeal = {
    id: Date.now(),
    businessName: businessName,
    dba: '',
    industry: '',
    tib: '',
    address: '',
    stateCode: '',
    entityType: '',
    entityStatus: '',
    formationDate: '',
    website: '',
    phone: '',
    ownerName: '',
    ownerEmail: '',
    ownerPhone: '',
    fico: 650,
    ownership: 100,
    score: 0,
    months: [],
    bankData: null,
    entityData: null,
    _fieldSource: {},
    createdAt: new Date().toISOString()
  };
  allDeals.unshift(newDeal);
  currentDeal = newDeal;
  saveDealsToStorage();
  renderDealList();
  
  // Trigger webhook for new deal
  triggerWebhook('newDeal', newDeal);
  
  // Go to detail view
  showDetailView();
  populateDetailView();
  
  // Clear search input
  document.getElementById('entitySearchInput').value = '';
  
  // Now search for entity data
  await searchAndFillEntity(businessName, apiKey);
}

async function searchAndFillEntity(businessName, apiKey) {
  const statusEl = document.createElement('div');
  statusEl.id = 'entitySearchStatus';
  statusEl.style.cssText = 'position: fixed; top: 80px; right: 24px; background: var(--bg-card); border: 1px solid var(--accent); border-radius: 12px; padding: 16px 20px; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);';
  statusEl.innerHTML = '<div style="width: 20px; height: 20px; border: 2px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div><span style="font-size: 0.85rem;">Verifying entity (exact match first)...</span><style>@keyframes spin { to { transform: rotate(360deg); } }</style>';
  document.body.appendChild(statusEl);

  try {
    const model = getGeminiModel();

    const prompt = `You are an underwriting OSINT analyst.

INPUT_NAME: "${businessName}"

GOAL: Identify the correct U.S. business entity record for the INPUT_NAME.

STRICT RULES:
- Search using the EXACT PHRASE in quotes first: "${businessName}"
- Prefer authoritative sources: State Secretary of State / business registry pages.
- Secondary sources allowed: SEC EDGAR, OpenCorporates, official company website.
- Avoid low-quality directories. Do NOT guess a state without evidence.
- If ambiguous, return multiple candidates.

Return JSON ONLY with this schema:
{
  "input_name": "",
  "normalized_input": "",
  "candidates": [
    {
      "legal_name": "",
      "dba": "",
      "state": "",
      "stateCode": "XX",
      "entityType": "",
      "status": "",
      "formationDate": "",
      "registeredAgent": "",
      "address": "",
      "officers": [],
      "industry": "",
      "hq": "",
      "sources": [{"title":"","url":""}],
      "evidence": ["<=20 word snippet"],
      "confidence": 0
    }
  ],
  "notes": ""
}`;

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.1 }
      })
    });

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);

    if (!parsed || !currentDeal) {
      statusEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-d)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span style="font-size: 0.85rem; color: var(--tier-d);">Entity parse failed (raw text shown in console)</span>';
      console.log('Entity raw response:', text);
      setTimeout(() => statusEl.remove(), 2500);
      return;
    }

    // Rank candidates locally to enforce exact/normalized-exact first
    const ranked = rankEntityCandidates(businessName, parsed.candidates || []);
    const best = ranked[0];

    if (best) {
      const entity = {
        businessName: best.legal_name || best.businessName || best.name || businessName,
        dba: best.dba || '',
        state: best.state || '',
        stateCode: (best.stateCode || '').toUpperCase(),
        entityType: best.entityType || '',
        status: best.status || '',
        formationDate: best.formationDate || '',
        registeredAgent: best.registeredAgent || '',
        address: best.address || '',
        officers: best.officers || [],
        industry: best.industry || '',
        hq: best.hq || '',
        confidence: best.confidence || 0,
        summary: parsed.notes || '',
        sources: best.sources || []
      };

      currentDeal.entityData = entity;

      // Auto-fill (but do not overwrite manual fields)
      currentDeal._fieldSource = currentDeal._fieldSource || {};

      const setAuto = (field, value) => {
        if (!value) return;
        const manual = currentDeal._fieldSource[field] === 'manual';
        const empty = !currentDeal[field] || String(currentDeal[field]).trim() === '';
        if (empty && !manual) {
          currentDeal[field] = value;
          currentDeal._fieldSource[field] = 'entity';
        }
      };

      setAuto('dba', entity.dba);
      setAuto('industry', entity.industry);
      setAuto('address', entity.address);
      setAuto('stateCode', entity.stateCode);
      setAuto('entityType', entity.entityType);
      setAuto('entityStatus', entity.status);
      setAuto('formationDate', entity.formationDate);
      setAuto('phone', '');
      setAuto('website', '');

      // Formation date -> TIB
      if (entity.formationDate && (!currentDeal.tib || String(currentDeal.tib).trim() === '')) {
        const years = Math.floor((Date.now() - new Date(entity.formationDate).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
        currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
      }

      // Officer -> ownerName (only if empty)
      if (entity.officers?.length && (!currentDeal.ownerName || String(currentDeal.ownerName).trim() === '')) {
        currentDeal.ownerName = entity.officers[0];
        currentDeal._fieldSource.ownerName = 'entity';
      }

      // Push values to UI
      populateDetailView();

      saveDealsToStorage();
      renderDealList();

      const tier = best._tier ?? 9;
      const tierLabel = tier === 0 ? 'Exact' : tier === 1 ? 'Normalized exact' : tier === 2 ? 'Partial' : 'Fuzzy';
      statusEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-a)" stroke-width="2" style="width: 20px; height: 20px;"><polyline points="20 6 9 17 4 12"/></svg><span style="font-size: 0.85rem; color: var(--tier-a);">Entity verified (${tierLabel} match)</span>`;
      setTimeout(() => statusEl.remove(), 2200);
    } else {
      statusEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-d)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span style="font-size: 0.85rem; color: var(--tier-d);">No candidates found</span>';
      setTimeout(() => statusEl.remove(), 2200);
    }
  } catch (err) {
    console.error(err);
    statusEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span style="font-size: 0.85rem; color: var(--tier-e);">Entity verification failed</span>';
    setTimeout(() => statusEl.remove(), 3000);
  }
}

async function handleQuickScrub(e) {
  const files = e.target?.files;
  if (!files?.length || !currentDeal) return;
  const apiKey = getGeminiApiKey();
  if (!apiKey) { alert('Enter your Gemini API key first.'); return; }

  // Use sidebar progress
  showFloatingProgress('Processing Documents');
  
  // Track document extraction
  startSearch('Document Extraction');
  
  // Track what we've already populated
  const populated = new Set();
  let searchesTriggered = false;
  
  // Helper to animate field population with visible flash
  const animateField = (el, value) => {
    if (!el || !value) return;
    const oldValue = el.value;
    el.value = value;
    
    // Only animate if value actually changed
    if (oldValue !== value) {
      el.classList.add('field-populated');
      // Also add a brief scale pulse
      el.style.transform = 'scale(1.02)';
      setTimeout(() => {
        el.style.transform = '';
        el.classList.remove('field-populated');
      }, 1500);
    }
  };
  
  // Helper to animate metric card value updates
  const animateMetric = (id, value, format = 'number') => {
    const el = document.getElementById(id);
    if (!el) return;
    const formatted = format === 'currency' ? '$' + Number(value).toLocaleString() : value;
    el.textContent = formatted;
    el.classList.add('value-updating');
    setTimeout(() => el.classList.remove('value-updating'), 600);
  };
  
  // Helper to update progress bar and percent together
  const updateProgress = (percent, text) => {
    const bar = document.getElementById('extractionBar');
    const pct = document.getElementById('extractionPercent');
    const phase = document.getElementById('extractionPhase');
    if (bar) bar.style.width = `${percent}%`;
    if (pct) pct.textContent = `${percent}%`;
    if (phase && text) phase.textContent = text;
    
    // Also update workflow progress bar for Document Extraction
    if (typeof setSearchProgress === 'function') {
      setSearchProgress('Document Extraction', percent);
    }
  };
  
  // Fire all searches as soon as we have a business name
  const triggerSearches = (businessName) => {
    if (searchesTriggered || !businessName) return;
    searchesTriggered = true;
    
    console.log(' Triggering all searches for:', businessName);
    
    // Fire ALL searches in parallel immediately - no awaits, fire and forget
    setTabLoading('tabBusiness', true);
    startSearch('Entity Verification');
    searchAndFillEntity(businessName, apiKey)
      .then(() => { setTabComplete('tabBusiness', true); endSearch('Entity Verification'); })
      .catch(() => { setTabLoading('tabBusiness', false); endSearch('Entity Verification'); });
    
    // All Intel searches fire simultaneously
    if (!currentDeal.deepResearch) runDeepResearchAuto();
    if (!currentDeal.clearReport) runBackgroundAuto();
    if (!currentDeal.footprintReport) runFootprintAuto();
  };
  
  // === PARALLEL QUICK EXTRACT ===
  // Fire a fast request to get business name while full extraction runs
  const quickExtractPromise = quickExtractBusinessName(files, apiKey).then(name => {
    if (name && !searchesTriggered) {
      console.log(' Quick extract found business name:', name);
      currentDeal.businessName = name;
      animateField(document.getElementById('fieldBusinessName'), name);
      renderDealList();
      triggerSearches(name);
    }
  }).catch(err => console.log('Quick extract skipped:', err.message));
  
  // Track streaming progress
  let lastLength = 0;
  let streamStarted = false;

  try {
    // Pass onChunk callback for REAL-TIME field population
    const extractedData = await processFilesWithGemini(files, apiKey, (streamText) => {
      // Show that data is streaming in - update progress based on response size
      const len = streamText.length;
      
      // Trigger immediately on first data, then every 100 chars
      if (!streamStarted || len > lastLength + 100) {
        lastLength = len;
        
        // Calculate progress based on what JSON sections we see
        let baseProgress = 18;
        if (streamText.includes('"business"')) baseProgress = 22;
        if (streamText.includes('"owner"')) baseProgress = 38;
        if (streamText.includes('"accounts"')) baseProgress = 50;
        if (streamText.includes('"months"')) baseProgress = 62;
        if (streamText.includes('"credit_report"')) baseProgress = 85;
        
        if (!streamStarted) {
          streamStarted = true;
          updateProgress(18, 'Receiving data...');
        } else if (!populated.has('businessName') && !populated.has('ownerName')) {
          // Keep updating progress as we receive data
          updateProgress(baseProgress, 'Extracting data...');
        }
      }
      
      // === REAL-TIME FIELD POPULATION AS DATA STREAMS IN ===
      
      // Business name - TRIGGER SEARCHES IMMEDIATELY
      if (!populated.has('businessName')) {
        const match = streamText.match(/"business"[\s\S]*?"name"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 1) {
          populated.add('businessName');
          currentDeal.businessName = match[1];
          animateField(document.getElementById('fieldBusinessName'), match[1]);
          updateProgress(25, `Found: ${match[1]}`);
          renderDealList(); // Update sidebar with real name
          
          // === FIRE SEARCHES AS SOON AS WE HAVE A NAME ===
          triggerSearches(match[1]);
        }
      }
      
      // DBA
      if (!populated.has('dba')) {
        const match = streamText.match(/"dba"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 1) {
          populated.add('dba');
          currentDeal.dba = match[1];
          animateField(document.getElementById('fieldDba'), match[1]);
        }
      }
      
      // Address
      if (!populated.has('address')) {
        const match = streamText.match(/"business"[\s\S]*?"address"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 3) {
          populated.add('address');
          currentDeal.address = match[1];
          animateField(document.getElementById('fieldAddress'), match[1]);
        }
      }
      
      // Industry
      if (!populated.has('industry')) {
        const match = streamText.match(/"industry"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 1) {
          populated.add('industry');
          currentDeal.industry = match[1];
          animateField(document.getElementById('fieldIndustry'), match[1]);
          updateProgress(30, `Industry: ${match[1]}`);
        }
      }
      
      // Owner name
      if (!populated.has('ownerName')) {
        const match = streamText.match(/"owner"[\s\S]*?"name"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 1) {
          populated.add('ownerName');
          currentDeal.ownerName = match[1];
          animateField(document.getElementById('fieldOwnerName'), match[1]);
          updateProgress(40, `Owner: ${match[1]}`);
        }
      }
      
      // Bank account detected
      if (!populated.has('bankAccount') && streamText.includes('"accounts"')) {
        const bankMatch = streamText.match(/"bankName"\s*:\s*"([^"]+)"/);
        const last4Match = streamText.match(/"accountLast4"\s*:\s*"([^"]+)"/);
        if (bankMatch || last4Match) {
          populated.add('bankAccount');
          updateProgress(50, `Bank: ${bankMatch?.[1] || ''} ${last4Match?.[1] || ''}`);
        }
      }
      
      // Monthly data - render table as months arrive
      if (streamText.includes('"months"') && streamText.includes('"deposits"')) {
        const monthMatches = [...streamText.matchAll(/"monthLabel"\s*:\s*"([^"]+)"/g)];
        const monthCount = monthMatches.length;
        
        if (monthCount > 0 && !populated.has('months' + monthCount)) {
          populated.add('months' + monthCount);
          const pct = 50 + Math.min(monthCount * 3, 30);
          updateProgress(pct, `${monthCount} month${monthCount > 1 ? 's' : ''} of bank data...`);
          
          // Try to parse and render partial months
          try {
            const monthsStart = streamText.indexOf('"months"');
            if (monthsStart > -1) {
              let bracketCount = 0;
              let inArray = false;
              let monthsText = '';
              
              for (let i = monthsStart; i < streamText.length; i++) {
                const char = streamText[i];
                if (char === '[') { bracketCount++; inArray = true; }
                if (char === ']') { bracketCount--; }
                if (inArray) monthsText += char;
                if (bracketCount === 0 && inArray) break;
              }
              
              if (monthsText && bracketCount === 0) {
                const partialMonths = JSON.parse(monthsText);
                if (Array.isArray(partialMonths) && partialMonths.length > 0) {
                  currentDeal.months = normalizeMonths(partialMonths);
                  renderFinancialTable();
                }
              }
            }
          } catch (e) {
            // Partial JSON not yet complete
          }
        }
      }
      
      // FICO score
      if (!populated.has('fico') && streamText.includes('"credit_report"')) {
        updateProgress(85, 'Processing credit data...');
        
        const ficoMatch = streamText.match(/"fico"\s*:\s*(\d+)/);
        if (ficoMatch && parseInt(ficoMatch[1]) > 300) {
          const ficoVal = parseInt(ficoMatch[1]);
          populated.add('fico');
          currentDeal.fico = ficoVal;
          animateField(document.getElementById('fieldFico'), ficoVal);
          updateProgress(90, `FICO: ${ficoVal}`);
        }
      }
    });

    // Keep raw extraction for audit
    currentDeal.bankData = extractedData;
    
    // Store accounts info
    if (extractedData.accounts) {
      currentDeal.accounts = extractedData.accounts;
    }

    // Auto-fill remaining fields (don't overwrite what streaming already set)
    currentDeal._fieldSource = currentDeal._fieldSource || {};

    const setAuto = (field, value) => {
      if (value === undefined || value === null) return;
      if (typeof value === 'string' && !value.trim()) return;
      const manual = currentDeal._fieldSource[field] === 'manual';
      const empty = !currentDeal[field] || String(currentDeal[field]).trim() === '';
      if (empty && !manual) {
        currentDeal[field] = value;
        currentDeal._fieldSource[field] = 'bank';
      }
    };

    // Fill any fields not already populated by streaming
    setAuto('businessName', extractedData?.business?.name || extractedData.businessName || '');
    setAuto('dba', extractedData?.business?.dba || extractedData.dba || '');
    setAuto('address', extractedData?.business?.address || extractedData.address || '');
    setAuto('industry', extractedData?.business?.industry || extractedData.industry || '');
    setAuto('stateCode', extractedData?.business?.stateCode || '');
    setAuto('entityType', extractedData?.business?.entityType || '');
    setAuto('entityStatus', extractedData?.business?.status || '');
    setAuto('formationDate', extractedData?.business?.formationDate || '');
    setAuto('website', extractedData?.business?.website || '');
    setAuto('phone', extractedData?.business?.phone || '');
    
    setAuto('ownerName', extractedData?.owner?.name || extractedData.ownerName || '');
    setAuto('ownerEmail', extractedData?.owner?.email || '');
    setAuto('ownerPhone', extractedData?.owner?.phone || '');
    setAuto('ownerSSNLast4', extractedData?.owner?.ssn_last4 || '');
    setAuto('ownerDOB', extractedData?.owner?.dob || '');
    setAuto('ownerAddress', extractedData?.owner?.address || '');

    // Credit Report (if provided) - more lenient validation
    if (extractedData?.credit_report) {
      const cr = extractedData.credit_report;
      const hasScores = cr.scores?.fico || cr.scores?.vantage || cr.scores?.experian || cr.scores?.equifax || cr.scores?.transunion;
      const hasTradelines = cr.tradelines?.length > 0;
      const hasSummary = cr.summary?.total_accounts > 0;
      const hasInquiries = cr.inquiries?.recent_inquiries?.length > 0 || cr.inquiries?.hard_inquiries_24mo > 0;
      const hasSubjectInfo = cr.subject_name || cr.bureau;
      const isNotScored = cr.scores?.score_status === 'not_scored';
      const hasEmployment = cr.employment?.employer;
      
      // Accept if we have any meaningful data
      if (hasScores || hasTradelines || hasSummary || hasInquiries || hasSubjectInfo || isNotScored || hasEmployment) {
        currentDeal.credit_report = cr;
        console.log('Credit report saved from QuickScrub:', cr);
        
        // Update FICO if available (override default 650)
        const creditScore = cr.scores?.fico || cr.scores?.experian || cr.scores?.vantage || cr.scores?.equifax || cr.scores?.transunion;
        if (creditScore) {
          if (!currentDeal.fico || currentDeal.fico === 650 || currentDeal.fico === 0) {
            currentDeal.fico = creditScore;
          }
        }
        
        // Trigger webhook for credit report
        triggerWebhook('credit', currentDeal);
        
        // Show toast about credit report
        let creditMsg = isNotScored ? 'Credit Report: Not Scored' : '';
        if (hasInquiries) {
          const inqCount = cr.inquiries.recent_inquiries?.length || cr.inquiries.hard_inquiries_24mo || 0;
          creditMsg = creditMsg ? `${creditMsg} | ${inqCount} inquiries` : `${inqCount} inquiries found`;
        }
        if (hasTradelines) {
          creditMsg = creditMsg ? `${creditMsg} | ${cr.tradelines.length} tradelines` : `${cr.tradelines.length} tradelines`;
        }
        if (creditMsg) {
          showToast('Credit Report Extracted', creditMsg, 'success');
        }
      }
    }

    // Months merge (fill blanks/zeros only)
    const incoming = normalizeMonths(extractedData.months || []);
    const existing = normalizeMonths(currentDeal.months || []);
    const byKey = new Map(existing.map(m => [m.monthKey, m]));

    for (const m of incoming) {
      const ex = byKey.get(m.monthKey);
      if (!ex) byKey.set(m.monthKey, m);
      else {
        const fields = ['revenue','deposits','withdrawals','endingBal','avgDailyBal','depositCount','overdraftFees','nsfs','negatives'];
        for (const f of fields) {
          const exVal = Number(ex[f] || 0);
          const inVal = Number(m[f] || 0);
          if ((exVal === 0 || Number.isNaN(exVal)) && inVal > 0) ex[f] = inVal;
        }
      }
    }

    currentDeal.months = [...byKey.values()].sort((a,b) => (a.monthKey || '').localeCompare(b.monthKey || ''));

    // Formation date -> TIB if empty
    if (currentDeal.formationDate && (!currentDeal.tib || String(currentDeal.tib).trim() === '')) {
      const years = Math.floor((Date.now() - new Date(currentDeal.formationDate).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
      currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
    }

    saveDealsToStorage();
    renderDealList();
    populateDetailView();
    
    // Hide progress immediately - UI is ready
    hideFloatingProgress(true);
    
    // Mark document extraction complete
    endSearch('Document Extraction');
    
    // Trigger webhook for bank statement processed
    triggerWebhook('bankProcessed', currentDeal);

    // Trigger searches if they weren't already fired during streaming
    if (!searchesTriggered && currentDeal.businessName) {
      triggerSearches(currentDeal.businessName);
    }
    
    // Run debt analysis immediately if we have bank data (wasn't triggered earlier since we need months)
    if (currentDeal.months?.length > 0) {
      console.log('Bank data processed, months:', currentDeal.months.length);
      if (!currentDeal.debtReport) {
        console.log('Starting debt analysis...');
        runDebtAnalysisAuto();
      } else {
        console.log('Debt report already exists, skipping auto-run');
      }
    }

  } catch (err) {
    console.error(err);
    hideFloatingProgress(false);
    endSearch('Document Extraction');
    showToast('Error', 'Error processing files: ' + (err.message || err), 'error');
  } finally {
    if (e.target) e.target.value = '';
  }
}

async function handleReScrub(e) {
  handleQuickScrub(e);
}

// Dashboard Quick Scrub drop zone handlers
function handleDashboardQuickScrubDrop(e) {
  e.preventDefault();
  const zone = document.getElementById('dashboardQuickScrubZone');
  zone.style.borderColor = 'var(--accent)';
  zone.style.background = 'linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%)';
  
  const files = e.dataTransfer.files;
  if (files.length) {
    handleDashboardQuickScrubFiles(files);
  }
}

async function handleDashboardQuickScrubFiles(files) {
  if (!files?.length) return;
  
  // If no deal selected, create a new one or ask user to select
  if (!currentDeal) {
    // Try to create a new deal from the files
    const newDeal = createNewDeal('New Business');
    selectDeal(newDeal.id);
    showToast('Created new deal for Quick Scrub');
  }
  
  // Simulate a file input event for the existing handler
  const fakeEvent = { target: { files: files } };
  await handleQuickScrub(fakeEvent);
  
  // Switch to deal view to show results
  showDealView();
}

// Re-scrub specific sections
async function rescrubSection(section) {
  if (!currentDeal) {
    showToast('Select a deal first', 'warning');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  // Find and update the button
  const btns = document.querySelectorAll('.rescrub-btn');
  let targetBtn = null;
  btns.forEach(btn => {
    if (btn.onclick?.toString().includes(`'${section}'`)) {
      targetBtn = btn;
    }
  });
  
  if (targetBtn) {
    targetBtn.classList.add('loading');
  }
  
  showToast(`Re-verifying ${section}...`, 'info');
  
  try {
    switch(section) {
      case 'business':
        await runBusinessRescrub();
        break;
      case 'owner':
        await runOwnerRescrub();
        break;
      case 'entity':
        await refreshEntityVerification();
        showToast('Entity verification refreshed', 'success');
        break;
      case 'research':
        currentDeal.deepResearch = null;
        setTabLoading('tabResearch', true);
        startSearch('Deep Research');
        await runDeepResearch();
        setTabLoading('tabResearch', false);
        endSearch('Deep Research');
        showToast('Research re-verified', 'success');
        break;
      case 'background':
        currentDeal.clearReport = null;
        setTabLoading('tabClear', true);
        startSearch('Background Check');
        await runClearReport();
        setTabLoading('tabClear', false);
        endSearch('Background Check');
        showToast('Background check re-verified', 'success');
        break;
      case 'footprint':
        currentDeal.footprintReport = null;
        setTabLoading('tabFootprint', true);
        startSearch('Digital Footprint');
        await runFootprintReport();
        setTabLoading('tabFootprint', false);
        endSearch('Digital Footprint');
        showToast('Footprint scan re-verified', 'success');
        break;
      case 'debt':
        currentDeal.debtReport = null;
        setTabLoading('tabDebt', true);
        startSearch('Debt Analysis');
        await runDebtReport();
        setTabLoading('tabDebt', false);
        endSearch('Debt Analysis');
        showToast('Debt analysis re-verified', 'success');
        break;
      default:
        showToast('Unknown section', 'error');
    }
  } catch (err) {
    console.error('Rescrub error:', err);
    showToast(`Error: ${err.message}`, 'error');
  } finally {
    if (targetBtn) {
      targetBtn.classList.remove('loading');
    }
  }
}

async function runBusinessRescrub() {
  // Run entity verification with fresh search
  const name = currentDeal.businessName;
  const state = currentDeal.stateCode;
  
  if (!name) {
    showToast('Enter business name first', 'warning');
    return;
  }
  
  // Set loading state
  setTabLoading('tabBusiness', true);
  startSearch('Business Verification');
  
  try {
    // Force refresh of entity verification
    currentDeal.entityReport = null;
    await runDeepResearchAuto();
    showToast('Business info re-verified', 'success');
  } finally {
    setTabLoading('tabBusiness', false);
    endSearch('Business Verification');
  }
}

async function runOwnerRescrub() {
  const ownerName = currentDeal.ownerName;
  
  if (!ownerName) {
    showToast('Enter owner name first', 'warning');
    return;
  }
  
  // Run background check on owner
  setTabLoading('tabClear', true);
  startSearch('Owner Verification');
  
  try {
    currentDeal.clearReport = null;
    await runBackgroundAuto();
    showToast('Owner info re-verified', 'success');
  } finally {
    setTabLoading('tabClear', false);
    endSearch('Owner Verification');
  }
}

// Credit Report specific upload handler
async function handleCreditReportUpload(e) {
  if (!currentDeal) return;
  const files = e.target.files;
  if (!files.length) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  // Set loading state on Credit tab
  setTabLoading('tabCredit', true);
  startSearch('Credit Analysis');
  
  // Use non-blocking floating progress
  showFloatingProgress('Analyzing Credit Report');
  
  try {
    const modelPref = getGeminiModel();
    const models = modelPref ? [modelPref, 'gemini-2.5-flash', 'gemini-2.0-flash'] : ['gemini-2.5-flash', 'gemini-2.0-flash'];
    
    // Build credit report specific prompt
    const instruction = `You are a credit report analyzer. Extract ALL data from this credit report.
Return ONLY valid JSON in this exact format:
{
  "credit_report": {
    "bureau": "",
    "report_date": "",
    "subject_name": "",
    "subject_address": "",
    "scores": {
      "fico": 0,
      "vantage": 0,
      "experian": 0,
      "equifax": 0,
      "transunion": 0,
      "score_status": "scored or not_scored",
      "score_reason": ""
    },
    "summary": {
      "total_accounts": 0,
      "open_accounts": 0,
      "closed_accounts": 0,
      "delinquent_accounts": 0,
      "derogatory_accounts": 0,
      "total_balance": 0,
      "total_credit_limit": 0,
      "credit_utilization": 0,
      "total_monthly_payment": 0,
      "oldest_account_age": "",
      "average_account_age": ""
    },
    "payment_history": {
      "on_time_percentage": 0,
      "late_30_days": 0,
      "late_60_days": 0,
      "late_90_days": 0,
      "collections": 0,
      "charge_offs": 0
    },
    "public_records": {
      "bankruptcies": [],
      "judgments": [],
      "liens": [],
      "foreclosures": []
    },
    "inquiries": {
      "hard_inquiries_24mo": 0,
      "recent_inquiries": [
        {
          "date": "",
          "creditor": "",
          "type": ""
        }
      ]
    },
    "tradelines": [
      {
        "creditor": "",
        "account_type": "",
        "account_number_last4": "",
        "date_opened": "",
        "credit_limit": 0,
        "high_balance": 0,
        "current_balance": 0,
        "monthly_payment": 0,
        "payment_status": "",
        "last_reported": "",
        "remarks": ""
      }
    ],
    "collections": [],
    "employment": {
      "employer": "",
      "date_hired": "",
      "date_reported": ""
    },
    "warnings": []
  }
}

IMPORTANT:
- For Experian reports with scores like "EXP/FAIR ISAAC V3 - 688", put 688 in BOTH "fico" AND "experian" fields
- For scores labeled as FICO, VantageScore, or specific bureau scores, put in the appropriate field
- If the score shows "Not Scored" or similar, set score_status to "not_scored" and include the reason
- Extract ALL tradelines/trade lines from the report - there may be many pages
- Extract ALL inquiries from the Inquiries section with dates and creditor names
- For the summary section, use values from "Report Summary" if available (Total # of Trades, Current Trades, etc.)
- Extract ALL employment information if present (there may be multiple employers)
- Extract any warning messages from the "Warning Messages" section
- For prequal or limited reports, still extract all available data
- Return 0 for numeric fields that are not available
- total_balance should use "Accounts Balance" value
- total_monthly_payment should use "Monthly Payment" value`;

    const parts = [{ text: instruction }];
    
    for (const file of files) {
      const base64 = await fileToBase64(file);
      const mimeType = file.type || (file.name.toLowerCase().endsWith('.pdf') ? 'application/pdf' : 'image/jpeg');
      parts.push({ inline_data: { mime_type: mimeType, data: base64 } });
    }
    
    let data = null;
    let lastErr = null;
    
    // Try each model until one works
    for (const model of models) {
      try {
        console.log('Trying credit report with model:', model);
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts }],
            generationConfig: { temperature: 0.1 }
          })
        });
        
        data = await res.json();
        
        // Check for API errors
        if (data.error) {
          console.warn('Model', model, 'failed:', data.error.message);
          lastErr = data.error.message;
          continue; // Try next model
        }
        
        // If we got a response, break out
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
          break;
        }
      } catch (err) {
        console.warn('Model', model, 'error:', err);
        lastErr = err.message;
      }
    }
    
    // If all models failed
    if (!data || data.error) {
      showToast('API Error', lastErr || 'Failed to analyze credit report', 'error');
      return;
    }
    
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    console.log('Credit report response:', text.substring(0, 1000));
    
    if (!text) {
      showToast('No Response', 'AI did not return any data', 'error');
      return;
    }
    
    const parsed = safeJsonFromText(text);
    console.log('Parsed credit report:', parsed);
    
    if (parsed?.credit_report) {
      const cr = parsed.credit_report;
      
      // More lenient validation - accept if we have ANY useful data
      const hasScores = cr.scores?.fico || cr.scores?.vantage || cr.scores?.experian || cr.scores?.equifax || cr.scores?.transunion;
      const hasTradelines = cr.tradelines?.length > 0;
      const hasSummary = cr.summary?.total_accounts > 0;
      const hasInquiries = cr.inquiries?.recent_inquiries?.length > 0 || cr.inquiries?.hard_inquiries_24mo > 0;
      const hasSubjectInfo = cr.subject_name || cr.bureau;
      const hasEmployment = cr.employment?.employer;
      const hasWarnings = cr.warnings?.length > 0;
      const isNotScored = cr.scores?.score_status === 'not_scored';
      
      // Accept if we have any meaningful data
      if (hasScores || hasTradelines || hasSummary || hasInquiries || hasSubjectInfo || hasEmployment || isNotScored) {
        currentDeal.credit_report = cr;
        
        // Also update FICO in main fields if present (override default 650)
        const creditScore = cr.scores?.fico || cr.scores?.experian || cr.scores?.vantage || cr.scores?.equifax || cr.scores?.transunion;
        if (creditScore) {
          // Update FICO if it's the default value OR if credit score is valid
          if (!currentDeal.fico || currentDeal.fico === 650 || currentDeal.fico === 0) {
            currentDeal.fico = creditScore;
          }
        }
        
        saveDealsToStorage();
        populateDetailView();
        switchIntelTab('credit');
        
        // Mark Credit tab complete
        setTabComplete('tabCredit', true);
        
        // Trigger webhook for credit report analyzed
        triggerWebhook('credit', currentDeal);
        
        // Build status message
        let statusMsg = '';
        if (isNotScored) {
          statusMsg = 'Report: Not Scored';
        } else if (hasScores) {
          statusMsg = `Score: ${cr.scores.fico || cr.scores.vantage || cr.scores.experian || 'N/A'}`;
        }
        if (hasInquiries) {
          statusMsg += ` | ${cr.inquiries.recent_inquiries?.length || cr.inquiries.hard_inquiries_24mo} inquiries`;
        }
        if (hasTradelines) {
          statusMsg += ` | ${cr.tradelines.length} tradelines`;
        }
        
        showToast('Credit Report Analyzed', statusMsg || 'Data extracted');
      } else {
        showToast('No Data Found', 'Could not extract credit data from file', 'warning');
      }
    } else {
      // Try to find credit data even if not in expected format
      console.warn('Credit report parse failed. Trying fallback...', text);
      
      // Try to extract any scores from the response
      const ficoMatch = text.match(/(?:fico|score)[:\s]*(\d{3})/i);
      const vantageMatch = text.match(/vantage[:\s]*(\d{3})/i);
      const notScoredMatch = text.match(/not\s*scored/i);
      
      if (ficoMatch || vantageMatch || notScoredMatch) {
        const fallbackReport = {
          bureau: 'Unknown',
          scores: {
            fico: ficoMatch ? parseInt(ficoMatch[1]) : 0,
            vantage: vantageMatch ? parseInt(vantageMatch[1]) : 0,
            score_status: notScoredMatch ? 'not_scored' : 'scored'
          },
          tradelines: [],
          inquiries: { recent_inquiries: [], hard_inquiries_24mo: 0 },
          summary: { total_accounts: 0 }
        };
        currentDeal.credit_report = fallbackReport;
        if (fallbackReport.scores.fico && !currentDeal.fico) {
          currentDeal.fico = fallbackReport.scores.fico;
        }
        saveDealsToStorage();
        populateDetailView();
        switchIntelTab('credit');
        setTabComplete('tabCredit', true);
        showToast('Partial Data', notScoredMatch ? 'Report shows Not Scored' : 'Extracted score only', 'warning');
      } else {
        showToast('Analysis Failed', 'Could not parse credit report - try a clearer image', 'error');
      }
    }
  } catch (err) {
    console.error('Credit report error:', err);
    hideFloatingProgress(false);
    showToast('Error', err.message, 'error');
    setTabLoading('tabCredit', false);
  } finally {
    hideFloatingProgress(true);
    endSearch('Credit Analysis');
    e.target.value = '';
  }
}

// Auto deep research (silent, no modal until complete)
// Tab loading state management
function setTabLoading(tabId, isLoading) {
  const tab = document.getElementById(tabId);
  if (!tab) return;
  if (isLoading) {
    tab.classList.add('loading');
    tab.classList.remove('has-data');
  } else {
    tab.classList.remove('loading');
  }
  // Update scrub status indicators
  if (typeof updateScrubStatus === 'function') updateScrubStatus();
}

function setTabComplete(tabId, hasData = true, hasWarning = false) {
  const tab = document.getElementById(tabId);
  if (!tab) return;
  tab.classList.remove('loading');
  if (hasData) tab.classList.add('has-data');
  if (hasWarning) tab.classList.add('has-warning');
  // Update scrub status indicators
  if (typeof updateScrubStatus === 'function') updateScrubStatus();
}

// Track active searches
const activeSearches = new Set();
const completedSearches = new Set();

// Track progress for each search (0-100)
const searchProgress = {
  'Document Extraction': 0,
  'Entity Verification': 0,
  'Deep Research': 0,
  'Background Check': 0,
  'Digital Footprint': 0,
  'Debt Analysis': 0
};

// Map search names to scrub status IDs and workflow IDs
const searchToScrubId = {
  'Document Extraction': 'scrubExtraction',
  'Entity Verification': 'scrubEntity',
  'Deep Research': 'scrubResearch',
  'Background Check': 'scrubBackground',
  'Digital Footprint': 'scrubFootprint',
  'Debt Analysis': 'scrubDebt'
};

const searchToWorkflowId = {
  'Document Extraction': 'wfExtraction',
  'Entity Verification': 'wfEntity',
  'Deep Research': 'wfResearch',
  'Background Check': 'wfBackground',
  'Digital Footprint': 'wfFootprint',
  'Debt Analysis': 'wfDebt'
};

// Progress animation intervals
const progressIntervals = {};

function showWorkflowProgress() {
  const el = document.getElementById('workflowProgress');
  if (el) {
    el.style.display = 'grid';
    // Reset all stages
    Object.keys(searchToWorkflowId).forEach(searchName => {
      searchProgress[searchName] = 0;
      updateStageProgress(searchName, 0);
      const stage = document.getElementById(searchToWorkflowId[searchName]);
      if (stage) stage.dataset.status = 'pending';
    });
    updateTotalProgress();
  }
}

function updateStageProgress(searchName, progress) {
  const wfId = searchToWorkflowId[searchName];
  const stage = document.getElementById(wfId);
  if (!stage) return;
  
  searchProgress[searchName] = progress;
  
  const fill = stage.querySelector('.stage-fill');
  const pct = stage.querySelector('.stage-pct');
  
  if (fill) fill.style.width = `${progress}%`;
  if (pct) pct.textContent = `${Math.round(progress)}%`;
  
  stage.dataset.progress = progress;
}

function updateTotalProgress() {
  const total = Object.values(searchProgress).reduce((a, b) => a + b, 0);
  const avg = Math.round(total / Object.keys(searchProgress).length);
  
  const totalEl = document.getElementById('workflowTotalPct');
  if (totalEl) {
    totalEl.textContent = `${avg}%`;
    totalEl.style.color = avg === 100 ? 'var(--tier-a)' : 'var(--accent)';
  }
}

function startProgressAnimation(searchName, duration = 10000) {
  // Clear existing interval
  if (progressIntervals[searchName]) {
    clearInterval(progressIntervals[searchName]);
  }
  
  const startTime = Date.now();
  const startProgress = searchProgress[searchName] || 0;
  
  progressIntervals[searchName] = setInterval(() => {
    const elapsed = Date.now() - startTime;
    // Progress to 90% over duration, leaving 10% for completion
    const targetProgress = Math.min(90, startProgress + (elapsed / duration) * 85);
    
    updateStageProgress(searchName, targetProgress);
    updateTotalProgress();
    
    if (targetProgress >= 90) {
      clearInterval(progressIntervals[searchName]);
    }
  }, 100);
}

// External function to set progress directly (for extraction which has real progress)
function setSearchProgress(searchName, progress) {
  // Stop animation if running
  if (progressIntervals[searchName]) {
    clearInterval(progressIntervals[searchName]);
    delete progressIntervals[searchName];
  }
  
  updateStageProgress(searchName, progress);
  updateTotalProgress();
}

function hideWorkflowProgress() {
  const el = document.getElementById('workflowProgress');
  if (el) {
    // Show completion flash
    showCompletionFlash('All searches complete!');
    
    // Delay hide to show completion
    setTimeout(() => {
      el.style.display = 'none';
    }, 2000);
  }
}

function showCompletionFlash(message) {
  // Remove any existing flash
  document.querySelectorAll('.completion-flash').forEach(el => el.remove());
  
  const flash = document.createElement('div');
  flash.className = 'completion-flash';
  flash.innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
    <span>${message}</span>
  `;
  document.body.appendChild(flash);
  
  // Auto-remove after animation
  setTimeout(() => flash.remove(), 3000);
}

function updateWorkflowProgress() {
  const totalSearches = Object.keys(searchToWorkflowId).length;
  const completedCount = completedSearches.size;
  const activeCount = activeSearches.size;
  
  // Update each stage status
  Object.entries(searchToWorkflowId).forEach(([searchName, wfId]) => {
    const stage = document.getElementById(wfId);
    if (!stage) return;
    
    if (completedSearches.has(searchName)) {
      stage.dataset.status = 'complete';
    } else if (activeSearches.has(searchName)) {
      stage.dataset.status = 'loading';
    } else {
      stage.dataset.status = 'pending';
    }
  });
  
  // Hide if all complete
  if (completedCount === totalSearches && activeCount === 0) {
    hideWorkflowProgress();
  }
}

function startSearch(searchName) {
  activeSearches.add(searchName);
  completedSearches.delete(searchName);
  
  // Show workflow progress if first search
  if (activeSearches.size === 1) {
    showWorkflowProgress();
  }
  
  // Start progress animation - different durations for different searches
  const durations = {
    'Document Extraction': 60000,  // 60s for OCR
    'Entity Verification': 8000,   // 8s
    'Deep Research': 15000,        // 15s
    'Background Check': 10000,     // 10s
    'Digital Footprint': 10000,    // 10s
    'Debt Analysis': 6000          // 6s
  };
  startProgressAnimation(searchName, durations[searchName] || 10000);
  
  updateSearchStatus();
  updateWorkflowProgress();
  updateScrubStatus();
  
  // Update sidebar scrub item
  const scrubId = searchToScrubId[searchName];
  if (scrubId) {
    const el = document.getElementById(scrubId);
    if (el) el.dataset.status = 'loading';
  }
}

function endSearch(searchName) {
  activeSearches.delete(searchName);
  completedSearches.add(searchName);
  
  // Stop progress animation and set to 100%
  if (progressIntervals[searchName]) {
    clearInterval(progressIntervals[searchName]);
    delete progressIntervals[searchName];
  }
  updateStageProgress(searchName, 100);
  updateTotalProgress();
  
  updateSearchStatus();
  updateWorkflowProgress();
  updateScrubStatus();
  
  // Update sidebar scrub item
  const scrubId = searchToScrubId[searchName];
  if (scrubId) {
    const el = document.getElementById(scrubId);
    if (el) el.dataset.status = 'complete';
  }
}

function updateSearchStatus() {
  // Update search summary in sidebar
  const summaryEl = document.getElementById('searchSummary');
  if (summaryEl) {
    const activeCount = activeSearches.size;
    const completeCount = completedSearches.size;
    
    if (activeCount > 0) {
      summaryEl.textContent = `${activeCount} running...`;
      summaryEl.style.color = 'var(--accent)';
    } else if (completeCount > 0) {
      summaryEl.textContent = `${completeCount} complete`;
      summaryEl.style.color = 'var(--tier-a)';
      // Clear after delay
      setTimeout(() => {
        if (activeSearches.size === 0) {
          summaryEl.textContent = '';
          completedSearches.clear();
        }
      }, 5000);
    } else {
      summaryEl.textContent = '';
    }
  }
}

async function runDeepResearchAuto() {
  if (!currentDeal?.businessName) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  // Set loading state
  setTabLoading('tabResearch', true);
  startSearch('Deep Research');
  
  const businessName = currentDeal.businessName;
  const state = currentDeal.stateCode || '';
  const address = currentDeal.address || '';
  
  // === PARALLEL MICRO-SEARCHES ===
  // Fire 5 focused searches simultaneously - each returns faster than one big search
  const microSearches = [
    {
      name: 'SOS/Entity',
      prompt: `Search for "${businessName}" business entity registration.
${state ? `State: ${state}` : 'Search all states'}
Return JSON: {"legal_name":"","dba":"","entity_type":"","state":"","formation_date":"","status":"","registered_agent":"","address":"","filing_number":""}
Be concise. JSON only.`
    },
    {
      name: 'UCC/Liens',
      prompt: `Search for UCC filings and liens against "${businessName}".
Return JSON: {"ucc_filings":[{"file_number":"","secured_party":"","filed_date":"","status":""}],"liens":[{"type":"","amount":"","filed_date":"","status":""}],"judgments":[{"case":"","amount":"","date":"","status":""}]}
Be concise. JSON only.`
    },
    {
      name: 'Reviews',
      prompt: `Search for "${businessName}" business reviews and BBB rating.
Return JSON: {"bbb_rating":"","bbb_accredited":false,"google_rating":"","google_reviews":0,"yelp_rating":"","yelp_reviews":0,"complaints":0,"review_summary":""}
Be concise. JSON only.`
    },
    {
      name: 'News',
      prompt: `Search for recent news about "${businessName}" business.
Return JSON: {"news":[{"title":"","source":"","date":"","summary":"","sentiment":"positive/negative/neutral"}],"press_releases":[],"awards":[]}
Be concise. JSON only. Max 5 news items.`
    },
    {
      name: 'Operations',
      prompt: `Search for "${businessName}" business operations info.
Return JSON: {"industry":"","naics":"","description":"","employee_count":"","revenue_estimate":"","years_in_business":0,"locations":[],"services":[],"competitors":[]}
Be concise. JSON only.`
    }
  ];
  
  // Show streaming container with status
  const streamContainer = document.getElementById('researchStreamContainer');
  const streamText = document.getElementById('researchStreamText');
  if (streamContainer) {
    streamContainer.style.display = 'block';
    if (streamText) streamText.textContent = `Running ${microSearches.length} parallel searches...`;
  }
  
  // Track completed searches
  let completed = 0;
  const results = {};
  
  // Fire ALL searches in parallel
  const searchPromises = microSearches.map(async (search) => {
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: search.prompt }] }],
          tools: [{ google_search: {} }],
          generationConfig: { temperature: 0.1, maxOutputTokens: 1000 }
        })
      });
      
      if (!res.ok) throw new Error(`API ${res.status}`);
      
      const data = await res.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const parsed = safeJsonFromText(text);
      
      completed++;
      if (streamText) streamText.textContent = `${completed}/${microSearches.length} searches complete...`;
      
      return { name: search.name, data: parsed };
    } catch (err) {
      completed++;
      console.warn(`Micro-search ${search.name} failed:`, err);
      return { name: search.name, data: null };
    }
  });
  
  try {
    // Wait for ALL parallel searches to complete
    const allResults = await Promise.all(searchPromises);
    
    // Merge results into unified structure
    const merged = {
      overview: {},
      ownership: { officers: [], ownership_structure: '' },
      operations: {},
      financials: {},
      compliance: { licenses: [], regulatory_actions: [], lawsuits: [], liens: [], ucc_filings: [] },
      reputation: { news_mentions: [], awards: [] },
      risk: { rating: 'LOW', red_flags: [], concerns: [] },
      sources: [],
      summary: '',
      confidence: 0
    };
    
    for (const result of allResults) {
      if (!result.data) continue;
      
      if (result.name === 'SOS/Entity') {
        merged.overview = { ...merged.overview, ...result.data };
      } else if (result.name === 'UCC/Liens') {
        merged.compliance.ucc_filings = result.data.ucc_filings || [];
        merged.compliance.liens = result.data.liens || [];
        if (result.data.judgments?.length) {
          merged.risk.red_flags.push(`${result.data.judgments.length} judgment(s) found`);
        }
      } else if (result.name === 'Reviews') {
        merged.reputation.bbb_rating = result.data.bbb_rating || '';
        merged.reputation.review_score = result.data.google_rating || result.data.yelp_rating || '';
        merged.reputation.review_count = (result.data.google_reviews || 0) + (result.data.yelp_reviews || 0);
        merged.reputation.review_summary = result.data.review_summary || '';
        if (result.data.complaints > 2) {
          merged.risk.concerns.push(`${result.data.complaints} complaints filed`);
        }
      } else if (result.name === 'News') {
        merged.reputation.news_mentions = result.data.news || [];
        merged.reputation.awards = result.data.awards || [];
        // Check for negative news
        const negNews = (result.data.news || []).filter(n => n.sentiment === 'negative');
        if (negNews.length > 0) {
          merged.risk.red_flags.push(`${negNews.length} negative news article(s)`);
        }
      } else if (result.name === 'Operations') {
        merged.operations = result.data;
        merged.financials = {
          revenue_estimate: result.data.revenue_estimate || '',
          employee_count: result.data.employee_count || '',
          years_in_business: result.data.years_in_business || 0,
          growth_trend: ''
        };
      }
    }
    
    // Calculate risk rating
    const flagCount = merged.risk.red_flags.length + merged.risk.concerns.length;
    merged.risk.rating = flagCount >= 3 ? 'HIGH' : flagCount >= 1 ? 'MEDIUM' : 'LOW';
    merged.confidence = Math.round((allResults.filter(r => r.data).length / allResults.length) * 100);
    merged.summary = `Research complete. ${merged.risk.red_flags.length} red flags, ${merged.risk.concerns.length} concerns identified.`;
    
    // Hide streaming container
    if (streamContainer) streamContainer.style.display = 'none';
    
    // Save and display
    currentDeal.deepResearch = merged;
    
    // Auto-apply key fields
    if (merged.overview?.legal_name && !currentDeal._fieldSource?.businessName) {
      currentDeal.businessName = merged.overview.legal_name;
    }
    if (merged.overview?.entity_type) currentDeal.entityType = merged.overview.entity_type;
    if (merged.overview?.status) currentDeal.entityStatus = merged.overview.status;
    if (merged.overview?.formation_date) currentDeal.formationDate = merged.overview.formation_date;
    if (merged.operations?.industry) currentDeal.industry = merged.operations.industry;
    if (merged.financials?.years_in_business) currentDeal.tib = `${merged.financials.years_in_business} years`;
    
    saveDealsToStorage();
    populateDetailView();
    
    triggerWebhook('research', currentDeal);
    setTabComplete('tabResearch', true, merged.risk?.rating === 'HIGH');
    showToast('Deep Research Complete', `${microSearches.length} searches merged  Risk: ${merged.risk.rating}`);
    
  } catch (err) {
    console.warn('Parallel research failed:', err);
    if (streamContainer) streamContainer.style.display = 'none';
    setTabLoading('tabResearch', false);
  } finally {
    endSearch('Deep Research');
  }
}

// Auto debt analysis - FAST version (no Google search needed, uses local bank data)
async function runDebtAnalysisAuto() {
  if (!currentDeal?.businessName || !currentDeal?.months?.length) {
    console.log('Debt analysis skipped: missing data');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  setTabLoading('tabDebt', true);
  startSearch('Debt Analysis');
  
  const streamContainer = document.getElementById('debtStreamContainer');
  if (streamContainer) streamContainer.style.display = 'block';
  
  try {
    const bankData = currentDeal.months;
    
    // Simplified prompt - analyze bank data for debt patterns
    const prompt = `Analyze this bank data for debt/MCA positions:
${JSON.stringify(bankData.map(m => ({month: m.monthLabel, deposits: m.deposits, withdrawals: m.withdrawals, debtService: m.debtService})))}

Look for: recurring payment patterns suggesting MCAs/loans, ACH debits to known funders.
Return JSON only:
{"active_positions":0,"estimated_monthly_debt":0,"positions":[{"funder":"","payment":"","frequency":"daily/weekly/monthly","confidence":"high/medium/low"}],"stacking_detected":false,"stacking_risk":"low/medium/high","summary":""}`;
    
    // Fast non-streaming call (no Google search needed)
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 1000 }
      })
    });
    
    if (streamContainer) streamContainer.style.display = 'none';
    
    if (!res.ok) throw new Error(`API ${res.status}`);
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.debtReport = parsed;
      saveDealsToStorage();
      renderDebtReportSection(parsed);
      updateIntelBadges();
      
      const hasWarning = (parsed.active_positions || 0) > 3 || parsed.stacking_detected;
      setTabComplete('tabDebt', true, hasWarning);
      
      showToast('Debt Analysis Complete', `${parsed.active_positions || 0} positions found`);
    } else {
      setTabLoading('tabDebt', false);
    }
  } catch (err) {
    console.error('Debt analysis failed:', err);
    if (streamContainer) streamContainer.style.display = 'none';
    setTabLoading('tabDebt', false);
  } finally {
    endSearch('Debt Analysis');
  }
}

// Auto background check (silent, runs automatically)
async function runBackgroundAuto() {
  if (!currentDeal?.businessName) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  // Set loading state
  setTabLoading('tabClear', true);
  startSearch('Background Check');
  
  const streamContainer = document.getElementById('backgroundStreamContainer');
  const streamText = document.getElementById('backgroundStreamText');
  if (streamContainer) {
    streamContainer.style.display = 'block';
    if (streamText) streamText.textContent = 'Searching public records...';
  }
  
  try {
    const businessName = currentDeal.businessName;
    const ownerName = currentDeal.ownerName || currentDeal.principalName || '';
    
    // Fast, focused prompt
    const prompt = `Search public records for "${businessName}"${ownerName ? ` and "${ownerName}"` : ''}.
Find: UCC filings, tax liens, judgments, lawsuits, bankruptcies.
Return JSON only:
{"ucc_filings":[{"secured_party":"","file_date":"","status":""}],"liens":[{"type":"","amount":"","date":""}],"judgments":[{"case":"","amount":"","date":""}],"lawsuits":[{"case":"","status":"","date":""}],"bankruptcies":[],"criminal":[],"summary":""}`;
    
    // Use fast non-streaming call
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 1500 }
      })
    });
    
    if (streamContainer) streamContainer.style.display = 'none';
    
    if (!res.ok) throw new Error(`API ${res.status}`);
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.clearReport = parsed;
      saveDealsToStorage();
      renderClearReportSection(parsed);
      updateIntelBadges();
      
      const hasWarning = (parsed.liens?.length || 0) > 0 || (parsed.judgments?.length || 0) > 0;
      setTabComplete('tabClear', true, hasWarning);
      
      showToast('Background Check Complete', `Found ${(parsed.ucc_filings?.length || 0) + (parsed.liens?.length || 0)} records`);
    }
  } catch (err) {
    console.warn('Auto background check failed:', err);
    if (streamContainer) streamContainer.style.display = 'none';
    setTabLoading('tabClear', false);
  } finally {
    endSearch('Background Check');
  }
}

// Auto footprint scan (silent, runs automatically)
async function runFootprintAuto() {
  if (!currentDeal?.businessName) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  // Set loading state
  setTabLoading('tabFootprint', true);
  startSearch('Digital Footprint');
  
  const streamContainer = document.getElementById('footprintStreamContainer');
  const streamText = document.getElementById('footprintStreamText');
  if (streamContainer) {
    streamContainer.style.display = 'block';
    if (streamText) streamText.textContent = 'Scanning digital presence...';
  }
  
  try {
    const businessName = currentDeal.businessName;
    
    // Fast, focused prompt
    const prompt = `Search for "${businessName}" online presence.
Find: website, social media, reviews, domain info.
Return JSON only:
{"website":{"url":"","status":"","ssl":true},"social_media":[{"platform":"","url":"","followers":""}],"reviews":{"google":{"rating":"","count":0},"yelp":{"rating":"","count":0}},"domain":{"registrar":"","created":"","expires":""},"online_score":"","summary":""}`;
    
    // Use fast non-streaming call
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 1500 }
      })
    });
    
    if (streamContainer) streamContainer.style.display = 'none';
    
    if (!res.ok) throw new Error(`API ${res.status}`);
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.footprintReport = parsed;
      saveDealsToStorage();
      renderFootprintReportSection(parsed);
      updateIntelBadges();
      
      setTabComplete('tabFootprint', true);
      
      showToast('Footprint Scan Complete', `Found ${parsed.social_media?.length || 0} social profiles`);
    }
  } catch (err) {
    console.warn('Auto footprint scan failed:', err);
    if (streamContainer) streamContainer.style.display = 'none';
    setTabLoading('tabFootprint', false);
  } finally {
    endSearch('Digital Footprint');
  }
}

// FULL RE-SCRUB - Re-checks EVERYTHING
async function fullReScrub() {
  if (!currentDeal) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const confirmed = confirm('Full Re-Scrub will:\n\n- Re-verify entity with Secretary of State\n- Run fresh Deep Research\n- Re-analyze all bank data\n- Update all auto-filled fields\n\nManual entries will be preserved.\n\nContinue?');
  if (!confirmed) return;
  
  // Use non-blocking floating progress
  showFloatingProgress('Full Re-Scrub');
  
  try {
    const businessName = currentDeal.businessName;
    const model = getGeminiModel();
    
    // Clear previous research to force refresh
    delete currentDeal.entityData;
    delete currentDeal.deepResearch;
    
    // Step 1: Entity Verification
    updateLoadingMessage('Verifying entity with Secretary of State...');
    if (businessName) {
      await searchAndFillEntity(businessName, apiKey);
    }
    
    // Step 2: Deep Research
    updateLoadingMessage('Running comprehensive deep research...');
    if (businessName) {
      const prompt = buildDeepResearchPrompt(businessName);
      
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          tools: [{ google_search: {} }],
          generationConfig: { temperature: 0.2 }
        })
      });

      const data = await res.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const research = safeJsonFromText(text);
      
      if (research) {
        currentDeal.deepResearch = research;
        
        // Apply research data (don't overwrite manual)
        const setIfEmpty = (field, value) => {
          if (!value) return;
          const manual = currentDeal._fieldSource?.[field] === 'manual';
          if (!manual) {
            currentDeal[field] = value;
            currentDeal._fieldSource = currentDeal._fieldSource || {};
            currentDeal._fieldSource[field] = 'research';
          }
        };
        
        setIfEmpty('entityType', research.overview?.entity_type);
        setIfEmpty('entityStatus', research.overview?.status);
        setIfEmpty('formationDate', research.overview?.formation_date);
        setIfEmpty('industry', research.operations?.industry);
        setIfEmpty('address', research.overview?.address);
        if (research.financials?.years_in_business) {
          setIfEmpty('tib', `${research.financials.years_in_business} years`);
        }
      }
    }
    
    // Step 3: Re-score
    updateLoadingMessage('Recalculating score...');
    saveDealsToStorage();
    populateDetailView();
    
    showToast('Full Re-Scrub Complete', currentDeal.deepResearch?.risk?.rating ? `Risk Rating: ${currentDeal.deepResearch.risk.rating}` : 'All data refreshed');
    
  } catch (err) {
    console.error('Full re-scrub failed:', err);
    hideFloatingProgress(false);
    showToast('Re-Scrub Error', err.message || err, 'error');
  } finally {
    hideFloatingProgress(true);
  }
}

function buildDeepResearchPrompt(businessName) {
  return `You are a comprehensive business research analyst.

BUSINESS: "${businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.industry ? `INDUSTRY: ${currentDeal.industry}` : ''}
${currentDeal?.address ? `ADDRESS: ${currentDeal.address}` : ''}

Conduct thorough research and provide a comprehensive analysis including:

1. COMPANY OVERVIEW - Legal name, DBAs, formation date/state, entity type, status, registered agent, addresses
2. OWNERSHIP & MANAGEMENT - Officers, directors, principals, ownership structure
3. BUSINESS OPERATIONS - Industry (NAICS/SIC), business model, services, competitors, locations
4. FINANCIAL INDICATORS - Revenue estimates, employee count, growth indicators
5. COMPLIANCE & LEGAL - Licenses, regulatory actions, lawsuits, liens, judgments, UCC filings
6. REPUTATION - Customer reviews, BBB status, news mentions, awards
7. RISK ASSESSMENT - Red flags, industry risks, operational concerns, overall rating (Low/Medium/High)

Return as JSON:
{
  "overview": {
    "legal_name": "", "dba": "", "entity_type": "", "state": "",
    "formation_date": "", "status": "", "registered_agent": "", "address": ""
  },
  "ownership": {
    "officers": [{"name": "", "title": ""}],
    "ownership_structure": ""
  },
  "operations": {
    "industry": "", "naics": "", "description": "",
    "services": [], "competitors": [], "locations": []
  },
  "financials": {
    "revenue_estimate": "", "employee_count": "",
    "years_in_business": 0, "growth_trend": ""
  },
  "compliance": {
    "licenses": [], "regulatory_actions": [],
    "lawsuits": [], "liens": [], "ucc_filings": []
  },
  "reputation": {
    "bbb_rating": "", "review_score": "",
    "review_count": 0, "news_mentions": [], "awards": []
  },
  "risk": {
    "rating": "", "red_flags": [],
    "industry_risks": [], "concerns": []
  },
  "sources": [{"title": "", "url": ""}],
  "summary": "",
  "confidence": 0
}`;
}

function showToast(title, message) {
  // Stack toasts - find existing ones and offset
  const existing = document.querySelectorAll('.toast-notification');
  const offset = existing.length * 70; // Stack with 70px gap
  
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div style="font-weight: 600; font-size: 0.85rem;">${title}</div>
    ${message ? `<div style="font-size: 0.75rem; opacity: 0.9;">${message}</div>` : ''}
  `;
  toast.style.cssText = `
    position: fixed; bottom: ${24 + offset}px; right: 24px; background: linear-gradient(135deg, var(--accent), #d97706);
    color: white; padding: 12px 18px; border-radius: 10px; z-index: 10000;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25); animation: slideInToast 0.3s ease;
    max-width: 280px;
  `;
  document.body.appendChild(toast);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOutToast 0.3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function updateLoadingMessage(msg) {
  // Update blocking overlay (if active)
  const titleEl = document.getElementById('loadingTitle');
  const descEl = document.getElementById('loadingDesc');
  if (titleEl) titleEl.textContent = msg;
  if (descEl) descEl.textContent = 'Please wait...';
  
  // Also update sidebar progress (if active)
  const extractionPhase = document.getElementById('extractionPhase');
  if (extractionPhase) extractionPhase.textContent = msg;
}

// === QUICK EXTRACT - Fast parallel business name extraction ===
// Runs simultaneously with full extraction to start searches faster
async function quickExtractBusinessName(files, apiKey) {
  // Use fastest model available
  const model = 'gemini-2.0-flash';
  
  // Only use first file for speed
  const file = files[0];
  if (!file) return null;
  
  const b64 = await fileToBase64(file);
  
  const prompt = `Look at this document and extract ONLY the business name. 
Return ONLY the business name as plain text, nothing else.
If you see multiple business names, return the primary/account holder name.
Example response: "ABC Company LLC"`;

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ 
          parts: [
            { text: prompt },
            { inline_data: { mime_type: file.type || 'application/pdf', data: b64 } }
          ] 
        }],
        generationConfig: { 
          temperature: 0.1,
          maxOutputTokens: 100  // Very short response
        }
      })
    });
    
    if (!res.ok) return null;
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    
    // Clean up response - remove quotes, trim
    const name = text.replace(/["'`]/g, '').trim();
    
    // Validate - should be reasonable business name length
    if (name.length > 2 && name.length < 200 && !name.includes('\n')) {
      return name;
    }
    return null;
  } catch (err) {
    console.log('Quick extract error:', err);
    return null;
  }
}

async function processFilesWithGemini(files, apiKey, onChunk = null) {
  const modelPref = getGeminiModel();
  const models = modelPref ? [modelPref, 'gemini-2.5-flash', 'gemini-2.0-flash'] : ['gemini-2.5-flash', 'gemini-2.0-flash'];

  const instruction = `You are a meticulous bank statement and credit report underwriter.

TASK: Extract and normalize the following from the provided PDFs/images. Documents may include bank statements AND/OR credit reports.

IMPORTANT: If there are MULTIPLE bank accounts in the statements, extract data for EACH account separately.

Return JSON ONLY in this schema:
{
  "business": {
    "name": "",
    "dba": "",
    "address": "",
    "phone": "",
    "website": "",
    "industry": "",
    "stateCode": "",
    "entityType": "",
    "status": "",
    "formationDate": ""
  },
  "owner": {
    "name": "",
    "email": "",
    "phone": "",
    "ssn_last4": "",
    "dob": "",
    "address": ""
  },
  "accounts": [
    {
      "accountId": "unique identifier like last4 or account name",
      "bankName": "",
      "accountType": "Checking/Savings/etc",
      "accountLast4": "1234",
      "statementCurrency": "USD"
    }
  ],
  "months": [
    {
      "accountId": "matches accounts[].accountId",
      "accountLast4": "1234",
      "monthKey": "YYYY-MM",
      "monthLabel": "Jan 2024",
      "revenue": 0,
      "deposits": 0,
      "withdrawals": 0,
      "trueCredits": 0,
      "trueDebits": 0,
      "lenderDeposits": 0,
      "transfers": 0,
      "returnItems": 0,
      "endingBal": 0,
      "avgDailyBal": 0,
      "depositCount": 0,
      "debtService": 0,
      "overdraftFees": 0,
      "nsfs": 0,
      "negatives": 0
    }
  ],
  "credit_report": {
    "bureau": "",
    "report_date": "",
    "subject_name": "",
    "subject_address": "",
    "scores": {
      "fico": 0,
      "vantage": 0,
      "experian": 0,
      "equifax": 0,
      "transunion": 0,
      "score_status": "scored or not_scored",
      "score_reason": ""
    },
    "summary": {
      "total_accounts": 0,
      "open_accounts": 0,
      "closed_accounts": 0,
      "delinquent_accounts": 0,
      "derogatory_accounts": 0,
      "total_balance": 0,
      "total_credit_limit": 0,
      "credit_utilization": 0,
      "total_monthly_payment": 0,
      "oldest_account_age": "",
      "average_account_age": ""
    },
    "payment_history": {
      "on_time_percentage": 0,
      "late_30_days": 0,
      "late_60_days": 0,
      "late_90_days": 0,
      "collections": 0,
      "charge_offs": 0
    },
    "public_records": {
      "bankruptcies": [],
      "judgments": [],
      "liens": [],
      "foreclosures": []
    },
    "inquiries": {
      "hard_inquiries_24mo": 0,
      "recent_inquiries": [
        {"date": "", "creditor": "", "type": ""}
      ]
    },
    "tradelines": [
      {
        "creditor": "",
        "account_type": "",
        "account_number_last4": "",
        "date_opened": "",
        "credit_limit": 0,
        "high_balance": 0,
        "current_balance": 0,
        "monthly_payment": 0,
        "payment_status": "",
        "last_reported": "",
        "remarks": ""
      }
    ],
    "collections": [
      {
        "creditor": "",
        "original_creditor": "",
        "balance": 0,
        "date_opened": "",
        "status": ""
      }
    ],
    "employment": {
      "employer": "",
      "date_hired": "",
      "date_reported": "",
      "occupation": "",
      "income": ""
    },
    "warnings": []
  },
  "confidence": 0,
  "warnings": []
}

GUIDELINES:
- If bank statements are provided: Extract monthly financial data accurately
- CRITICAL - EXACT NUMERICAL ACCURACY:
  * Use EXACT numbers from statement summaries - DO NOT round or estimate
  * deposits = EXACT "Total Credits" or "Total Deposits" from statement summary
  * withdrawals = EXACT "Total Debits" or "Total Withdrawals" from statement summary
  * endingBal = EXACT "Ending Balance" from statement summary
  * avgDailyBal = EXACT "Average Daily Balance" or "Average Ledger Balance" from statement
  * depositCount = EXACT count of deposit transactions from statement
  * nsfs = EXACT count of NSF/OD items from statement
  * Copy numbers exactly as shown - preserve cents (e.g., $45,231.87 not $45,232)
- CRITICAL FOR MULTIPLE ACCOUNTS:
  * If statements show multiple bank accounts (different account numbers), create separate entries in the "accounts" array
  * Each month entry should have an "accountId" and "accountLast4" matching the account it belongs to
  * Use the last 4 digits of account number as the accountId (e.g., "1234")
  * Extract data for ALL accounts, not just the primary one
- IMPORTANT FOR BANK STATEMENTS:
  * avgDailyBal (Average Daily Balance) is often shown on bank statements - look for "Average Daily Balance", "Avg Daily Bal", "Average Balance", or similar
  * If avgDailyBal is not explicitly shown, use the ending balance for that month
  * Extract deposits (total credits), withdrawals (total debits), ending balance for each month
  * trueCredits = total credits MINUS these NON-REVENUE items:
    - Lender deposits / loan proceeds (wires from lenders, MCA funding, SBA deposits)
    - Internal bank transfers (transfers between own accounts, Zelle to self)
    - Return items (bounced check deposits returned, returned ACH credits)
    - Purchase returns / refunds on debit cards
    - Reversed transactions
  * trueDebits = total debits MINUS these NON-EXPENSE items:
    - Internal bank transfers (transfers to own accounts)
    - Reversed transactions
    - Return item fees (count separately in overdraftFees)
  * Look for debt service payments (loan payments, credit card payments, MCA payments) and sum them in debtService field
- If credit reports are provided: Extract ALL credit data including tradelines, scores, payment history
- IMPORTANT FOR CREDIT REPORTS:
  * If the score shows "Not Scored", set score_status to "not_scored" and include the reason in score_reason
  * Extract ALL inquiries from the Inquiries section with date, creditor name, and type
  * Extract employment information if present (employer name, hire date, etc.)
  * Extract any warning messages into the warnings array
  * For prequal or limited reports, still extract all available data
- Use statement month totals when available. If only date-range totals exist, allocate ONLY if clearly broken out.
- If a field is not present, use empty string or 0 (do not hallucinate).
- IMPORTANT: months must be accurate; do not invent months outside the statement period.
- For credit reports: Extract ALL tradelines visible, include payment status (Current, 30 days, 60 days, etc.)
- If no credit report is provided, leave credit_report fields empty/zero.`;

  // Build multimodal parts with per-file labels
  const parts = [{ text: instruction }];
  for (const f of files) {
    const b64 = await fileToBase64(f);
    parts.push({ text: `FILE: ${f.name} (${f.type || 'application/pdf'})` });
    parts.push({ inline_data: { mime_type: f.type || 'application/pdf', data: b64 } });
  }

  let lastErr;
  for (const m of models) {
    try {
      // Use STREAMING API for real-time updates
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${m}:streamGenerateContent?alt=sse&key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts }],
          generationConfig: { temperature: 0.1 }
        })
      });
      
      if (!res.ok) {
        throw new Error(`API error: ${res.status}`);
      }
      
      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const jsonStr = line.slice(6);
              if (jsonStr.trim() === '[DONE]') continue;
              const data = JSON.parse(jsonStr);
              const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
              if (text) {
                fullText += text;
                // Call onChunk callback for real-time UI updates
                if (onChunk) onChunk(fullText);
              }
            } catch (e) {
              // Skip malformed JSON chunks
            }
          }
        }
      }
      
      const parsed = safeJsonFromText(fullText);
      if (parsed) {
        parsed.months = normalizeMonths(parsed.months || []);
        return parsed;
      }
    } catch (err) { lastErr = err; }
  }
  throw lastErr || new Error('Failed to process');
}

function fileToBase64(f) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(',')[1]);
    r.onerror = rej;
    r.readAsDataURL(f);
  });
}

let loadingInterval;

// Sidebar extraction progress - replaces floating progress bar
let extractionProgressInterval;

function showFloatingProgress(title = 'Processing Documents') {
  // Show sidebar extraction progress
  const extractionEl = document.getElementById('extractionProgress');
  if (extractionEl) extractionEl.style.display = 'block';
  
  const titleEl = document.getElementById('extractionTitle');
  const barEl = document.getElementById('extractionBar');
  const pctEl = document.getElementById('extractionPercent');
  const phaseEl = document.getElementById('extractionPhase');
  
  if (titleEl) titleEl.textContent = title;
  if (barEl) barEl.style.width = '3%';
  if (pctEl) pctEl.textContent = '3%';
  if (phaseEl) phaseEl.textContent = 'Preparing...';
  
  // Keep animating until streaming callback takes over
  let progress = 3;
  const phases = [
    { p: 5, t: 'Uploading documents...' },
    { p: 8, t: 'Sending to AI...' },
    { p: 10, t: 'Processing images...' },
    { p: 12, t: 'Running OCR...' },
    { p: 14, t: 'Analyzing pages...' },
    { p: 16, t: 'Waiting for response...' }
  ];
  let phaseIdx = 0;
  
  extractionProgressInterval = setInterval(() => {
    if (progress < 17) {
      progress += 0.15;
      if (barEl) barEl.style.width = `${progress}%`;
      if (pctEl) pctEl.textContent = `${Math.round(progress)}%`;
      
      while (phaseIdx < phases.length - 1 && progress >= phases[phaseIdx + 1].p) {
        phaseIdx++;
        if (phaseEl) phaseEl.textContent = phases[phaseIdx].t;
      }
    }
  }, 150);
}

function updateFloatingProgress(percent, status) {
  const barEl = document.getElementById('extractionBar');
  const pctEl = document.getElementById('extractionPercent');
  const phaseEl = document.getElementById('extractionPhase');
  
  if (barEl) barEl.style.width = `${percent}%`;
  if (pctEl) pctEl.textContent = `${Math.round(percent)}%`;
  if (status && phaseEl) phaseEl.textContent = status;
}

function hideFloatingProgress(success = true) {
  clearInterval(extractionProgressInterval);
  
  const extractionEl = document.getElementById('extractionProgress');
  const barEl = document.getElementById('extractionBar');
  const pctEl = document.getElementById('extractionPercent');
  const phaseEl = document.getElementById('extractionPhase');
  
  if (success) {
    if (barEl) barEl.style.width = '100%';
    if (pctEl) pctEl.textContent = '100%';
    if (phaseEl) phaseEl.textContent = 'Complete!';
    
    setTimeout(() => {
      if (extractionEl) extractionEl.style.display = 'none';
    }, 2000);
  } else {
    if (extractionEl) extractionEl.style.display = 'none';
  }
}

// Keep blocking overlay for special cases only
function showLoadingOverlay(customMessage) {
  document.getElementById('loadingOverlay').classList.add('active');
  let time = 45, prog = 0;
  const phases = customMessage ? [
    { t: customMessage, d: 'This may take a moment...', p: 100 }
  ] : [
    { t: 'OCR Processing', d: 'Extracting text from documents using advanced optical character recognition.', p: 20 },
    { t: 'Cash Flow Analysis', d: 'Analyzing deposit patterns, withdrawal frequency, and balance trends.', p: 40 },
    { t: 'Risk Assessment', d: 'Evaluating NSF occurrences, negative balances, and financial stability.', p: 60 },
    { t: 'Data Verification', d: 'Cross-referencing extracted data for accuracy and completeness.', p: 80 },
    { t: 'Finalizing ABLESCORE', d: 'Calculating comprehensive underwriting score based on all factors.', p: 100 }
  ];
  let phase = 0;
  function upd() {
    if (phase < phases.length) {
      document.getElementById('loadingTitle').textContent = phases[phase].t;
      document.getElementById('loadingDesc').textContent = phases[phase].d;
    }
  }
  upd();
  loadingInterval = setInterval(() => {
    time--;
    prog += 100 / 45;
    document.getElementById('loadingTimer').textContent = `00:${time.toString().padStart(2, '0')}`;
    document.getElementById('loadingBar').style.width = `${Math.min(prog, 100)}%`;
    document.getElementById('loadingPercent').textContent = `${Math.round(Math.min(prog, 100))}% COMPLETE`;
    if (prog >= phases[phase]?.p && phase < phases.length - 1) { phase++; upd(); }
    if (time <= 0) clearInterval(loadingInterval);
  }, 1000);
}

function hideLoadingOverlay() {
  clearInterval(loadingInterval);
  document.getElementById('loadingOverlay').classList.remove('active');
}

function updateDashboard() {
  const totalRev = allDeals.reduce((s, d) => s + (d.months?.reduce((x, m) => x + (m.revenue || 0), 0) || 0), 0);
  const avgScore = allDeals.length ? Math.round(allDeals.reduce((s, d) => s + (d.score || 0), 0) / allDeals.length) : 0;
  const approved = allDeals.filter(d => (d.score || 0) >= 55).length;
  const highRisk = allDeals.filter(d => (d.score || 0) < 40).length;

  // New dashboard metrics
  const allMonths = allDeals.flatMap(d => normalizeMonths(d.months || []));
  const avgMonthlyRev = allMonths.length ? Math.round(allMonths.reduce((a, m) => a + (m.revenue || 0), 0) / allMonths.length) : 0;

  const completionVals = allDeals.map(d => calcDealCompleteness(d).pct);
  const avgCompletion = completionVals.length ? Math.round(completionVals.reduce((a,b) => a + b, 0) / completionVals.length) : 0;

  const dashRevenue = document.getElementById('dashRevenue');
  const dashScore = document.getElementById('dashScore');
  const dashApproval = document.getElementById('dashApproval');
  const dashRisk = document.getElementById('dashRisk');
  const dashDeals = document.getElementById('dashDeals');
  const dashAvgMonthlyRev = document.getElementById('dashAvgMonthlyRev');
  const dashCompletion = document.getElementById('dashCompletion');

  if (dashRevenue) dashRevenue.textContent = '$' + totalRev.toLocaleString();
  if (dashScore) dashScore.textContent = avgScore;
  if (dashApproval) dashApproval.textContent = allDeals.length ? Math.round((approved / allDeals.length) * 100) + '%' : '0%';
  if (dashRisk) dashRisk.textContent = highRisk;
  if (dashDeals) dashDeals.textContent = allDeals.length;
  if (dashAvgMonthlyRev) dashAvgMonthlyRev.textContent = '$' + avgMonthlyRev.toLocaleString();
  if (dashCompletion) dashCompletion.textContent = avgCompletion + '%';

  // Score distribution
  if (scoreChart) {
    scoreChart.data.datasets[0].data = [
      allDeals.filter(d => (d.score || 0) >= 85).length,
      allDeals.filter(d => (d.score || 0) >= 70 && (d.score || 0) < 85).length,
      allDeals.filter(d => (d.score || 0) >= 55 && (d.score || 0) < 70).length,
      allDeals.filter(d => (d.score || 0) >= 40 && (d.score || 0) < 55).length,
      allDeals.filter(d => (d.score || 0) < 40).length
    ];
    scoreChart.update();
  }

  // Deal activity over last 6 months (created month)
  if (volumeChart) {
    const now = new Date();
    const labels = [];
    const counts = [];
    for (let i = 5; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      labels.push(monthLabelFromKey(key));
      const c = allDeals.filter(x => {
        const dt = new Date(x.id || Date.now());
        const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        return k === key;
      }).length;
      counts.push(c);
    }
    volumeChart.data.labels = labels;
    volumeChart.data.datasets[0].data = counts;
    volumeChart.update();
  }

  // Revenue trend over last 6 months (sum monthly revenue across deals)
  if (revenueTrendChart) {
    const now = new Date();
    const labels = [];
    const sums = [];
    const revByKey = new Map();
    for (const d of allDeals) {
      for (const m of normalizeMonths(d.months || [])) {
        revByKey.set(m.monthKey, (revByKey.get(m.monthKey) || 0) + (m.revenue || 0));
      }
    }
    for (let i = 5; i >= 0; i--) {
      const dt = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      labels.push(monthLabelFromKey(key));
      sums.push(Math.round(revByKey.get(key) || 0));
    }
    revenueTrendChart.data.labels = labels;
    revenueTrendChart.data.datasets[0].data = sums;
    revenueTrendChart.update();
  }

  // Completion distribution buckets
  if (completionChart) {
    const buckets = [0,0,0,0];
    for (const p of completionVals) {
      if (p < 40) buckets[0]++; else if (p < 60) buckets[1]++; else if (p < 80) buckets[2]++; else buckets[3]++;
    }
    completionChart.data.datasets[0].data = buckets;
    completionChart.update();
  }
  
  // === NEW ANALYTICS ===
  
  // Calculate new metrics
  const avgFico = allDeals.length ? Math.round(allDeals.filter(d => d.fico).reduce((s, d) => s + (d.fico || 0), 0) / allDeals.filter(d => d.fico).length) || 0 : 0;
  const totalDeposits = allMonths.reduce((s, m) => s + (m.deposits || 0), 0);
  const totalNsf = allMonths.reduce((s, m) => s + (m.nsfs || 0), 0);
  
  const dashAvgFico = document.getElementById('dashAvgFico');
  const dashTotalDeposits = document.getElementById('dashTotalDeposits');
  const dashTotalNsf = document.getElementById('dashTotalNsf');
  
  if (dashAvgFico) {
    dashAvgFico.textContent = avgFico || '--';
    dashAvgFico.style.color = avgFico >= 700 ? 'var(--tier-a)' : avgFico >= 650 ? 'var(--tier-b)' : avgFico >= 600 ? 'var(--tier-c)' : 'var(--tier-d)';
  }
  if (dashTotalDeposits) dashTotalDeposits.textContent = '$' + totalDeposits.toLocaleString();
  if (dashTotalNsf) {
    dashTotalNsf.textContent = totalNsf;
    dashTotalNsf.style.color = totalNsf === 0 ? 'var(--tier-a)' : totalNsf <= 5 ? 'var(--tier-c)' : 'var(--tier-e)';
  }
  
  // Score Tier Breakdown
  const tierCounts = {
    A: allDeals.filter(d => (d.score || 0) >= 85).length,
    B: allDeals.filter(d => (d.score || 0) >= 70 && (d.score || 0) < 85).length,
    C: allDeals.filter(d => (d.score || 0) >= 55 && (d.score || 0) < 70).length,
    D: allDeals.filter(d => (d.score || 0) >= 40 && (d.score || 0) < 55).length,
    E: allDeals.filter(d => (d.score || 0) < 40).length
  };
  const maxTier = Math.max(...Object.values(tierCounts), 1);
  
  ['A', 'B', 'C', 'D', 'E'].forEach(tier => {
    const bar = document.getElementById(`tier${tier}Bar`);
    const count = document.getElementById(`tier${tier}Count`);
    if (bar) bar.style.width = `${(tierCounts[tier] / maxTier) * 100}%`;
    if (count) count.textContent = tierCounts[tier];
  });
  
  // FICO Distribution
  const ficoCounts = {
    750: allDeals.filter(d => (d.fico || 0) >= 750).length,
    700: allDeals.filter(d => (d.fico || 0) >= 700 && (d.fico || 0) < 750).length,
    650: allDeals.filter(d => (d.fico || 0) >= 650 && (d.fico || 0) < 700).length,
    600: allDeals.filter(d => (d.fico || 0) >= 600 && (d.fico || 0) < 650).length,
    599: allDeals.filter(d => (d.fico || 0) > 0 && (d.fico || 0) < 600).length
  };
  const maxFico = Math.max(...Object.values(ficoCounts), 1);
  
  [750, 700, 650, 600, 599].forEach(range => {
    const bar = document.getElementById(`fico${range}Bar`);
    const count = document.getElementById(`fico${range}Count`);
    if (bar) bar.style.width = `${(ficoCounts[range] / maxFico) * 100}%`;
    if (count) count.textContent = ficoCounts[range];
  });
  
  // Top Industries
  const industries = {};
  allDeals.forEach(d => {
    const ind = d.industry || 'Unknown';
    industries[ind] = (industries[ind] || 0) + 1;
  });
  
  const sortedIndustries = Object.entries(industries)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  const industryContainer = document.getElementById('industryBreakdown');
  if (industryContainer) {
    if (sortedIndustries.length === 0 || (sortedIndustries.length === 1 && sortedIndustries[0][0] === 'Unknown')) {
      industryContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No industry data yet</div>';
    } else {
      const maxInd = sortedIndustries[0][1];
      industryContainer.innerHTML = sortedIndustries.map(([name, count], i) => {
        const colors = ['var(--tier-a)', 'var(--tier-b)', 'var(--tier-c)', 'var(--tier-d)', 'var(--text-muted)'];
        return `
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="width: 80px; font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${name}">${name}</span>
            <div style="flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
              <div style="height: 100%; background: ${colors[i]}; width: ${(count / maxInd) * 100}%;"></div>
            </div>
            <span style="width: 30px; text-align: right; font-size: 0.8rem;">${count}</span>
          </div>
        `;
      }).join('');
    }
  }
  
  // === ADVANCED ANALYTICS ===
  
  // Portfolio Health Score
  const strongDeals = allDeals.filter(d => (d.score || 0) >= 70).length;
  const moderateDeals = allDeals.filter(d => (d.score || 0) >= 40 && (d.score || 0) < 70).length;
  const atRiskDeals = allDeals.filter(d => (d.score || 0) < 40).length;
  
  const healthScore = allDeals.length ? Math.round(
    (strongDeals * 100 + moderateDeals * 60 + atRiskDeals * 20) / allDeals.length
  ) : 0;
  
  const healthScoreEl = document.getElementById('portfolioHealthScore');
  const healthRing = document.getElementById('portfolioHealthRing');
  if (healthScoreEl) healthScoreEl.textContent = healthScore;
  if (healthRing) {
    healthRing.style.strokeDasharray = `${healthScore} ${100 - healthScore}`;
    healthRing.style.stroke = healthScore >= 70 ? 'var(--tier-a)' : healthScore >= 40 ? 'var(--tier-c)' : 'var(--tier-e)';
  }
  
  const healthStrongEl = document.getElementById('healthStrong');
  const healthModerateEl = document.getElementById('healthModerate');
  const healthAtRiskEl = document.getElementById('healthAtRisk');
  if (healthStrongEl) healthStrongEl.textContent = strongDeals;
  if (healthModerateEl) healthModerateEl.textContent = moderateDeals;
  if (healthAtRiskEl) healthAtRiskEl.textContent = atRiskDeals;
  
  // Risk Matrix (Score vs FICO)
  const riskMatrix = document.getElementById('riskMatrix');
  if (riskMatrix) {
    // 5x5 grid: rows = FICO ranges (high to low), cols = Score ranges (low to high)
    const ficoRanges = [[750, 850], [700, 749], [650, 699], [600, 649], [0, 599]];
    const scoreRanges = [[0, 40], [40, 55], [55, 70], [70, 85], [85, 100]];
    
    let gridHtml = '';
    ficoRanges.forEach(([ficoMin, ficoMax]) => {
      scoreRanges.forEach(([scoreMin, scoreMax]) => {
        const count = allDeals.filter(d => {
          const fico = d.fico || 0;
          const score = d.score || 0;
          return fico >= ficoMin && fico <= ficoMax && score >= scoreMin && score < scoreMax;
        }).length;
        
        // Color based on risk (top-right = green/low risk, bottom-left = red/high risk)
        const riskLevel = (ficoMax - 600) / 250 + (scoreMax - 40) / 60;
        let bgColor = 'var(--bg-tertiary)';
        if (count > 0) {
          if (riskLevel > 1.3) bgColor = 'var(--tier-a)';
          else if (riskLevel > 1) bgColor = 'var(--tier-b)';
          else if (riskLevel > 0.7) bgColor = 'var(--tier-c)';
          else if (riskLevel > 0.4) bgColor = 'var(--tier-d)';
          else bgColor = 'var(--tier-e)';
        }
        
        gridHtml += `<div style="aspect-ratio: 1; background: ${bgColor}; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: ${count > 0 ? '#000' : 'var(--text-muted)'};" title="FICO ${ficoMin}-${ficoMax}, Score ${scoreMin}-${scoreMax}: ${count} deals">${count || ''}</div>`;
      });
    });
    riskMatrix.innerHTML = gridHtml;
  }
  
  // Recent Activity
  const activityContainer = document.getElementById('recentActivity');
  if (activityContainer) {
    const recentDeals = [...allDeals]
      .sort((a, b) => (b.id || 0) - (a.id || 0))
      .slice(0, 5);
    
    if (recentDeals.length === 0) {
      activityContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem;">No recent activity</div>';
    } else {
      activityContainer.innerHTML = recentDeals.map(d => {
        const timeAgo = getTimeAgo(d.id || d.createdAt);
        const scoreColor = (d.score || 0) >= 70 ? 'var(--tier-a)' : (d.score || 0) >= 40 ? 'var(--tier-c)' : 'var(--tier-e)';
        return `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer;" onclick="selectDealById(${d.id})">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${scoreColor};"></div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${d.businessName || 'Untitled'}</div>
              <div style="font-size: 0.7rem; color: var(--text-muted);">${timeAgo}</div>
            </div>
            <div style="font-size: 0.85rem; font-weight: 600; color: ${scoreColor};">${d.score || 0}</div>
          </div>
        `;
      }).join('');
    }
  }
  
  // Performance Metrics
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth()+1).padStart(2,'0')}`;
  
  const dealsThisMonthCount = allDeals.filter(d => {
    const dt = new Date(d.id || Date.now());
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}` === thisMonth;
  }).length;
  
  const dealsLastMonthCount = allDeals.filter(d => {
    const dt = new Date(d.id || Date.now());
    return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}` === lastMonthKey;
  }).length;
  
  const dealsThisMonthEl = document.getElementById('dealsThisMonth');
  const dealsMonthTrendEl = document.getElementById('dealsMonthTrend');
  if (dealsThisMonthEl) dealsThisMonthEl.textContent = dealsThisMonthCount;
  if (dealsMonthTrendEl) {
    const diff = dealsThisMonthCount - dealsLastMonthCount;
    if (diff > 0) {
      dealsMonthTrendEl.textContent = ` ${diff} vs last month`;
      dealsMonthTrendEl.style.color = 'var(--tier-a)';
    } else if (diff < 0) {
      dealsMonthTrendEl.textContent = ` ${Math.abs(diff)} vs last month`;
      dealsMonthTrendEl.style.color = 'var(--tier-e)';
    } else {
      dealsMonthTrendEl.textContent = 'Same as last month';
      dealsMonthTrendEl.style.color = 'var(--text-muted)';
    }
  }
  
  const conversionRateEl = document.getElementById('conversionRate');
  if (conversionRateEl) {
    const rate = allDeals.length ? Math.round((approved / allDeals.length) * 100) : 0;
    conversionRateEl.textContent = rate + '%';
    conversionRateEl.style.color = rate >= 70 ? 'var(--tier-a)' : rate >= 50 ? 'var(--tier-c)' : 'var(--tier-e)';
  }
  
  const avgDealSizeEl = document.getElementById('avgDealSize');
  if (avgDealSizeEl) {
    const avgSize = allDeals.length ? Math.round(totalRev / allDeals.length) : 0;
    avgDealSizeEl.textContent = '$' + avgSize.toLocaleString();
  }
}

function getTimeAgo(timestamp) {
  const now = Date.now();
  const diff = now - (timestamp || now);
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return new Date(timestamp).toLocaleDateString();
}

function selectDealById(id) {
  const idx = allDeals.findIndex(d => d.id === id);
  if (idx >= 0) selectDeal(idx);
}

function openMetricModal(type) {
  const modal = document.getElementById('metricModal');
  const title = document.getElementById('metricModalTitle');
  const subtitle = document.getElementById('metricModalSubtitle');
  const insights = document.getElementById('metricInsights');
  if (metricChart) metricChart.destroy();

  // Helper: last 6 month labels/keys
  const now = new Date();
  const keys = [];
  const labels = [];
  for (let i = 5; i >= 0; i--) {
    const dt = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    keys.push(key);
    labels.push(monthLabelFromKey(key));
  }

  const cfgs = {
    revenue: () => {
      const revByKey = new Map(keys.map(k => [k, 0]));
      for (const d of allDeals) {
        for (const m of normalizeMonths(d.months || [])) {
          if (revByKey.has(m.monthKey)) revByKey.set(m.monthKey, revByKey.get(m.monthKey) + (m.revenue || 0));
        }
      }
      const data = keys.map(k => Math.round(revByKey.get(k) || 0));
      return {
        t: 'Total Revenue Analysis',
        st: 'Total revenue by month (pipeline)',
        ct: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: '#22c55e', borderRadius: 6 }] },
        ins: [
          `Total pipeline revenue: $${Math.round(allDeals.reduce((s, d) => s + (d.months?.reduce((x, m) => x + (m.revenue || 0), 0) || 0), 0)).toLocaleString()}`,
          `Avg monthly revenue per statement month: $${(data.reduce((a,b)=>a+b,0)/(data.filter(x=>x>0).length||1)).toFixed(0)}`,
          `${allDeals.filter(d => (d.score||0) >= 55).length}/${allDeals.length} deals score  55`
        ]
      };
    },
    score: () => {
      const dist = [
        allDeals.filter(d => (d.score || 0) >= 85).length,
        allDeals.filter(d => (d.score || 0) >= 70 && (d.score || 0) < 85).length,
        allDeals.filter(d => (d.score || 0) >= 55 && (d.score || 0) < 70).length,
        allDeals.filter(d => (d.score || 0) >= 40 && (d.score || 0) < 55).length,
        allDeals.filter(d => (d.score || 0) < 40).length
      ];
      return {
        t: 'ABLESCORE Distribution',
        st: 'Score breakdown by tier',
        ct: 'doughnut',
        data: { labels: ['A','B','C','D','E'], datasets: [{ data: dist, backgroundColor: [TIER_COLORS.a, TIER_COLORS.b, TIER_COLORS.c, TIER_COLORS.d, TIER_COLORS.e] }] },
        ins: [
          `Avg score: ${allDeals.length ? Math.round(allDeals.reduce((s,d)=>s+(d.score||0),0)/allDeals.length) : 0}`,
          `Tier A+B count: ${dist[0] + dist[1]}`,
          `High-risk (<40) count: ${dist[4]}`
        ]
      };
    },
    approval: () => {
      const approved = allDeals.filter(d => (d.score || 0) >= 55).length;
      const rate = allDeals.length ? Math.round((approved / allDeals.length) * 100) : 0;

      // Use created month as proxy trend
      const byKey = new Map(keys.map(k => [k, { total: 0, approved: 0 }]));
      for (const d of allDeals) {
        const dt = new Date(d.id || Date.now());
        const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        if (!byKey.has(k)) continue;
        byKey.get(k).total += 1;
        if ((d.score || 0) >= 55) byKey.get(k).approved += 1;
      }
      const data = keys.map(k => {
        const v = byKey.get(k);
        return v.total ? Math.round((v.approved / v.total) * 100) : 0;
      });

      return {
        t: 'Approval Rate Trends',
        st: `Current approval rate: ${rate}% (score  55)`,
        ct: 'line',
        data: { labels, datasets: [{ data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }] },
        ins: [
          `Approved deals: ${approved}`,
          `High-risk deals: ${allDeals.filter(d => (d.score||0) < 40).length}`,
          `Avg profile completeness: ${allDeals.length ? Math.round(allDeals.map(d=>calcDealCompleteness(d).pct).reduce((a,b)=>a+b,0)/allDeals.length) : 0}%`
        ]
      };
    },
    risk: () => {
      const high = allDeals.filter(d => (d.score || 0) < 40);
      const lowFico = high.filter(d => (parseInt(d.fico,10) || 0) < 600).length;
      const nsfHeavy = high.filter(d => (d.months?.reduce((a,m)=>a+(m.nsfs||0),0) || 0) >= 3).length;
      const negHeavy = high.filter(d => (d.months?.reduce((a,m)=>a+(m.negatives||0),0) || 0) >= 10).length;
      const revVar = high.filter(d => {
        const revs = (d.months||[]).map(m => m.revenue || 0).filter(x=>x>0);
        if (revs.length < 3) return false;
        const avg = revs.reduce((a,b)=>a+b,0)/revs.length;
        const variance = revs.reduce((a,b)=>a+Math.pow(b-avg,2),0)/revs.length;
        const cv = Math.sqrt(variance) / (avg || 1);
        return cv >= 0.4;
      }).length;

      return {
        t: 'High Risk Analysis',
        st: 'Drivers among deals scoring below 40',
        ct: 'bar',
        data: { labels: ['Low FICO', 'NSF  3', 'Neg Days  10', 'Rev Variance'], datasets: [{ data: [lowFico, nsfHeavy, negHeavy, revVar], backgroundColor: '#ef4444', borderRadius: 6 }] },
        ins: [
          `High-risk deals: ${high.length}`,
          `Most common signal: ${['Low FICO','NSF  3','Neg Days  10','Rev Variance'][[lowFico,nsfHeavy,negHeavy,revVar].indexOf(Math.max(lowFico,nsfHeavy,negHeavy,revVar))] || ''}`,
          `Recommendation: enrich entity + bank data to improve confidence`
        ]
      };
    },
    deals: () => {
      const byKey = new Map(keys.map(k => [k, 0]));
      for (const d of allDeals) {
        const dt = new Date(d.id || Date.now());
        const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        if (byKey.has(k)) byKey.set(k, byKey.get(k) + 1);
      }
      const data = keys.map(k => byKey.get(k) || 0);
      return {
        t: 'Deal Activity',
        st: 'Deals created per month',
        ct: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: '#eab308', borderRadius: 6 }] },
        ins: [
          `Total deals: ${allDeals.length}`,
          `Deals last 30 days (approx): ${allDeals.filter(d => (Date.now() - (d.id || 0)) < 30*24*60*60*1000).length}`,
          `Avg score: ${allDeals.length ? Math.round(allDeals.reduce((s,d)=>s+(d.score||0),0)/allDeals.length) : 0}`
        ]
      };
    },
    completion: () => {
      const vals = allDeals.map(d => calcDealCompleteness(d).pct);
      const buckets = [0,0,0,0];
      for (const p of vals) { if (p < 40) buckets[0]++; else if (p < 60) buckets[1]++; else if (p < 80) buckets[2]++; else buckets[3]++; }
      return {
        t: 'Profile Completeness',
        st: 'Data quality distribution (required fields)',
        ct: 'bar',
        data: { labels: ['0-39%', '40-59%', '60-79%', '80-100%'], datasets: [{ data: buckets, backgroundColor: '#a855f7', borderRadius: 6 }] },
        ins: [
          `Avg completion: ${vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0}%`,
          `Deals  80%: ${buckets[3]}`,
          `Deals < 60%: ${buckets[0] + buckets[1]}`
        ]
      };
    },
    avg_monthly_revenue: () => {
      const allMonths = allDeals.flatMap(d => normalizeMonths(d.months || []));
      const revs = allMonths.map(m => m.revenue || 0);
      const avg = revs.length ? Math.round(revs.reduce((a,b)=>a+b,0)/revs.length) : 0;
      return {
        t: 'Avg Monthly Revenue',
        st: 'Average across all statement months',
        ct: 'line',
        data: { labels, datasets: [{ data: labels.map((_,i)=>0), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.08)', fill: true, tension: 0.35 }] },
        ins: [
          `Avg monthly revenue: $${avg.toLocaleString()}`,
          `Statement months captured: ${revs.length}`,
          `Tip: Upload full 3-6 month package to stabilize variance`
        ]
      };
    }
  };

  const builder = cfgs[type] || cfgs.score;
  const c = builder();

  title.textContent = c.t;
  subtitle.textContent = c.st;
  insights.innerHTML = c.ins.map(i => `<div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--accent); font-size: 0.85rem; color: var(--text-secondary);">${i}</div>`).join('');

  metricChart = new Chart(document.getElementById('metricModalChart'), {
    type: c.ct,
    data: c.data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: c.ct === 'doughnut', position: 'bottom', labels: { color: '#a1a1aa', font: { family: 'DM Sans' } } } },
      scales: c.ct === 'doughnut' ? {} : {
        y: { grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });

  modal.classList.add('active');
}

function closeMetricModal() { document.getElementById('metricModal').classList.remove('active'); }
function closeEntityModal() { document.getElementById('entityModal').classList.remove('active'); }
function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }
function closeBankDataModal() { 
  document.getElementById('bankDataModal').classList.remove('active'); 
  if (window.bankDataChartInstance) {
    window.bankDataChartInstance.destroy();
    window.bankDataChartInstance = null;
  }
}

// ===============================
// BANK STATEMENT ANALYSIS MODAL
// ===============================
function closeBankAnalysisModal() { 
  document.getElementById('bankAnalysisModal').classList.remove('active'); 
}

function openBankAnalysisModal() {
  if (!currentDeal?.months?.length) {
    showToast('No bank data available', 'warning');
    return;
  }
  
  const modal = document.getElementById('bankAnalysisModal');
  const months = currentDeal.months || [];
  const accounts = currentDeal.accounts || [];
  const debtReport = currentDeal.debtReport || {};
  
  // Calculate summary metrics
  const count = months.length;
  const avgRevenue = months.reduce((a, m) => a + (m.deposits || m.revenue || 0), 0) / count;
  const avgDailyBal = months.reduce((a, m) => a + (m.avgDailyBal || m.endingBal || 0), 0) / count;
  const avgDepCount = Math.round(months.reduce((a, m) => a + (m.depositCount || 0), 0) / count);
  const totalNsfs = months.reduce((a, m) => a + (m.nsfs || 0), 0);
  
  // Get date range
  const sortedMonths = [...months].sort((a, b) => (a.monthKey || '').localeCompare(b.monthKey || ''));
  const firstMonth = sortedMonths[0]?.monthLabel || sortedMonths[0]?.month || 'N/A';
  const lastMonth = sortedMonths[sortedMonths.length - 1]?.monthLabel || sortedMonths[sortedMonths.length - 1]?.month || 'N/A';
  
  // Monthly debt payments from debt report or monthly data
  const monthlyDebtPayments = debtReport.monthly_payments ? 
    parseCurrency(debtReport.monthly_payments) : 
    months.reduce((a, m) => a + (m.debtService || 0), 0) / count;
  
  // Count unique accounts
  const uniqueAccounts = new Set(months.map(m => m.accountLast4 || m.accountId || 'default'));
  const accountCount = uniqueAccounts.size;
  
  // Populate Summary Metrics
  const summaryBody = document.getElementById('bankAnalysisSummary');
  const summaryMetrics = [
    { label: 'Analysis Period', value: `${firstMonth} - ${lastMonth}` },
    { label: 'Months Analyzed', value: count },
    { label: 'Accounts Detected', value: accountCount > 1 ? `${accountCount} accounts` : '1 account' },
    { label: 'Average Monthly Revenue', value: formatCurrency(avgRevenue) },
    { label: 'Average Daily Balance', value: formatCurrency(avgDailyBal) },
    { label: 'Average Deposit Count', value: avgDepCount },
    { label: 'Monthly Debt Payments', value: formatCurrency(monthlyDebtPayments) },
    { label: 'Total NSFs', value: totalNsfs }
  ];
  
  summaryBody.innerHTML = summaryMetrics.map(m => `
    <tr style="border-bottom: 1px solid #f0f0f0;">
      <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.label}</td>
      <td style="padding: 14px 16px; font-size: 0.9rem; color: #333; font-weight: 500;">${m.value}</td>
    </tr>
  `).join('');
  
  // Populate Monthly Detail - group by account if multiple
  const monthlyBody = document.getElementById('bankAnalysisMonthly');
  
  if (accountCount > 1) {
    // Group by account
    const byAccount = {};
    sortedMonths.forEach(m => {
      const acctId = m.accountLast4 || m.accountId || 'default';
      if (!byAccount[acctId]) byAccount[acctId] = [];
      byAccount[acctId].push(m);
    });
    
    let html = '';
    Object.entries(byAccount).forEach(([acctId, acctMonths]) => {
      const acctInfo = accounts.find(a => a.accountLast4 === acctId || a.accountId === acctId) || {};
      const bankName = acctInfo.bankName || '';
      const acctType = acctInfo.accountType || '';
      const last4Display = acctId !== 'default' ? `  ${acctId}` : '';
      
      html += `
        <tr style="background: #f5f5f5;">
          <td colspan="6" style="padding: 12px 16px; font-size: 0.8rem; font-weight: 600; color: #333;">
            ${bankName ? bankName + ' - ' : ''}${acctType}${last4Display}
          </td>
        </tr>
      `;
      
      acctMonths.forEach(m => {
        html += `
          <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.monthLabel || m.month || ''}</td>
            <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${formatCurrency(m.deposits || m.revenue || 0)}</td>
            <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${formatCurrency(m.avgDailyBal || m.endingBal || 0)}</td>
            <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.depositCount || 0}</td>
            <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${formatCurrency(m.endingBal || 0)}</td>
            <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.nsfs || 0}</td>
          </tr>
        `;
      });
    });
    monthlyBody.innerHTML = html;
  } else {
    // Single account - simple list
    monthlyBody.innerHTML = sortedMonths.map(m => `
      <tr style="border-bottom: 1px solid #f0f0f0;">
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.monthLabel || m.month || ''}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${formatCurrency(m.deposits || m.revenue || 0)}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${formatCurrency(m.avgDailyBal || m.endingBal || 0)}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.depositCount || 0}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${formatCurrency(m.endingBal || 0)}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${m.nsfs || 0}</td>
      </tr>
    `).join('');
  }
  
  // Populate Detected Debt Obligations
  const debtBody = document.getElementById('bankAnalysisDebt');
  const positions = debtReport.positions || [];
  
  if (positions.length > 0) {
    debtBody.innerHTML = positions.map(p => `
      <tr style="border-bottom: 1px solid #f0f0f0;">
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${p.lender || p.creditor || 'Unknown'}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${p.type || p.product_type || 'Loan'}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${p.balance || p.estimated_balance || '$0.00'}</td>
        <td style="padding: 14px 16px; font-size: 0.9rem; color: #333;">${p.payment || p.monthly_payment || '$0.00'}</td>
      </tr>
    `).join('');
  } else {
    // Try to generate debt positions from bank statement patterns if no debt report
    debtBody.innerHTML = `
      <tr>
        <td colspan="4" style="padding: 24px 16px; text-align: center; color: #666; font-size: 0.9rem;">
          No debt obligations detected. Run Debt Analysis for detailed detection.
        </td>
      </tr>
    `;
  }
  
  modal.classList.add('active');
}

// ===============================
// BANK DATA DETAIL MODAL
// ===============================
function openBankMetricDetail(metric) {
  if (!currentDeal) return;
  
  const modal = document.getElementById('bankDataModal');
  const months = currentDeal.months || [];
  const bankData = currentDeal.bankData || {};
  
  // Update title based on metric clicked
  const titles = {
    fico: 'FICO Score Analysis',
    revenue: 'Revenue Analysis',
    deposits: 'Deposit Analysis',
    balance: 'Balance Analysis',
    nsf: 'NSF/Overdraft Analysis',
    negdays: 'Negative Days Analysis',
    monthly: 'Complete Monthly Breakdown'
  };
  
  document.getElementById('bankDataModalTitle').innerHTML = `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
    ${titles[metric] || 'Bank Data Analysis'}
  `;
  document.getElementById('bankDataModalSubtitle').textContent = currentDeal.businessName || 'Business';
  
  // Calculate totals
  let totalRevenue = 0, totalDeposits = 0, totalBalance = 0, totalNsf = 0, totalNegDays = 0;
  let lowestBalance = Infinity;
  
  months.forEach(m => {
    const rev = parseFloat(String(m.revenue || m.totalRevenue || 0).replace(/[$,]/g, '')) || 0;
    const dep = parseFloat(String(m.deposits || m.totalDeposits || 0).replace(/[$,]/g, '')) || 0;
    const bal = parseFloat(String(m.avgBalance || m.averageBalance || 0).replace(/[$,]/g, '')) || 0;
    const endBal = parseFloat(String(m.endingBalance || m.endBalance || 0).replace(/[$,]/g, '')) || 0;
    const nsf = parseInt(m.nsf || m.nsfCount || 0) || 0;
    const neg = parseInt(m.negativeDays || m.negDays || 0) || 0;
    
    totalRevenue += rev;
    totalDeposits += dep;
    totalBalance += bal;
    totalNsf += nsf;
    totalNegDays += neg;
    if (endBal < lowestBalance) lowestBalance = endBal;
  });
  
  const avgRevenue = months.length > 0 ? totalRevenue / months.length : 0;
  const avgBalance = months.length > 0 ? totalBalance / months.length : 0;
  
  // Update summary stats
  document.getElementById('bankModalTotalRev').textContent = formatCurrency(totalRevenue);
  document.getElementById('bankModalAvgRev').textContent = formatCurrency(avgRevenue);
  document.getElementById('bankModalTotalDep').textContent = formatCurrency(totalDeposits);
  document.getElementById('bankModalAvgBal').textContent = formatCurrency(avgBalance);
  document.getElementById('bankModalNsf').textContent = totalNsf;
  document.getElementById('bankModalNsf').style.color = totalNsf > 3 ? 'var(--tier-e)' : totalNsf > 0 ? 'var(--tier-d)' : 'var(--tier-a)';
  document.getElementById('bankModalNegDays').textContent = totalNegDays;
  document.getElementById('bankModalNegDays').style.color = totalNegDays > 10 ? 'var(--tier-e)' : totalNegDays > 0 ? 'var(--tier-d)' : 'var(--tier-a)';
  document.getElementById('bankModalLowestBal').textContent = lowestBalance === Infinity ? '$0' : formatCurrency(lowestBalance);
  document.getElementById('bankModalLowestBal').style.color = lowestBalance < 0 ? 'var(--tier-e)' : 'var(--text-primary)';
  
  // Build table
  const tbody = document.getElementById('bankDataTableBody');
  if (months.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No bank data available. Upload bank statements to see analysis.</td></tr>';
  } else {
    tbody.innerHTML = months.map((m, i) => {
      const rev = parseFloat(String(m.revenue || m.totalRevenue || 0).replace(/[$,]/g, '')) || 0;
      const dep = parseFloat(String(m.deposits || m.totalDeposits || 0).replace(/[$,]/g, '')) || 0;
      const bal = parseFloat(String(m.avgBalance || m.averageBalance || 0).replace(/[$,]/g, '')) || 0;
      const endBal = parseFloat(String(m.endingBalance || m.endBalance || 0).replace(/[$,]/g, '')) || 0;
      const nsf = parseInt(m.nsf || m.nsfCount || 0) || 0;
      const neg = parseInt(m.negativeDays || m.negDays || 0) || 0;
      
      return `
        <tr>
          <td style="font-weight: 600;">${m.month || `Month ${i + 1}`}</td>
          <td style="color: var(--tier-a);">${formatCurrency(rev)}</td>
          <td>${formatCurrency(dep)}</td>
          <td>${formatCurrency(bal)}</td>
          <td style="color: ${endBal < 0 ? 'var(--tier-e)' : 'var(--text-primary)'};">${formatCurrency(endBal)}</td>
          <td style="color: ${nsf > 0 ? 'var(--tier-e)' : 'var(--text-muted)'};">${nsf}</td>
          <td style="color: ${neg > 0 ? 'var(--tier-d)' : 'var(--text-muted)'};">${neg}</td>
        </tr>
      `;
    }).join('');
  }
  
  // Create chart based on metric type
  renderBankDataChart(metric, months);
  
  modal.classList.add('active');
}

function renderBankDataChart(metric, months) {
  const ctx = document.getElementById('bankDataChart').getContext('2d');
  
  if (window.bankDataChartInstance) {
    window.bankDataChartInstance.destroy();
  }
  
  if (months.length === 0) {
    // No data - show empty state
    window.bankDataChartInstance = new Chart(ctx, {
      type: 'bar',
      data: { labels: ['No Data'], datasets: [{ data: [0], backgroundColor: 'var(--bg-tertiary)' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    return;
  }
  
  const labels = months.map((m, i) => m.month || `M${i + 1}`);
  
  // Determine what to show based on metric
  let datasets = [];
  let chartType = 'bar';
  
  if (metric === 'revenue' || metric === 'monthly') {
    const revenues = months.map(m => parseFloat(String(m.revenue || m.totalRevenue || 0).replace(/[$,]/g, '')) || 0);
    datasets.push({
      label: 'Revenue',
      data: revenues,
      backgroundColor: 'rgba(34, 197, 94, 0.7)',
      borderColor: '#22c55e',
      borderWidth: 2
    });
  }
  
  if (metric === 'deposits' || metric === 'monthly') {
    const deposits = months.map(m => parseFloat(String(m.deposits || m.totalDeposits || 0).replace(/[$,]/g, '')) || 0);
    datasets.push({
      label: 'Deposits',
      data: deposits,
      backgroundColor: 'rgba(132, 204, 22, 0.7)',
      borderColor: '#84cc16',
      borderWidth: 2
    });
  }
  
  if (metric === 'balance') {
    const balances = months.map(m => parseFloat(String(m.avgBalance || m.averageBalance || 0).replace(/[$,]/g, '')) || 0);
    const endBalances = months.map(m => parseFloat(String(m.endingBalance || m.endBalance || 0).replace(/[$,]/g, '')) || 0);
    chartType = 'line';
    datasets = [
      { label: 'Avg Balance', data: balances, borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', fill: true, tension: 0.4 },
      { label: 'End Balance', data: endBalances, borderColor: '#f97316', backgroundColor: 'transparent', tension: 0.4 }
    ];
  }
  
  if (metric === 'nsf') {
    const nsfs = months.map(m => parseInt(m.nsf || m.nsfCount || 0) || 0);
    datasets = [{ label: 'NSFs', data: nsfs, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: '#ef4444', borderWidth: 2 }];
  }
  
  if (metric === 'negdays') {
    const negDays = months.map(m => parseInt(m.negativeDays || m.negDays || 0) || 0);
    datasets = [{ label: 'Negative Days', data: negDays, backgroundColor: 'rgba(249, 115, 22, 0.7)', borderColor: '#f97316', borderWidth: 2 }];
  }
  
  if (metric === 'fico') {
    // FICO doesn't change monthly, show score breakdown
    const fico = currentDeal.fico || 0;
    const ranges = ['800+', '750-799', '700-749', '650-699', '600-649', '<600'];
    const rangeData = [0, 0, 0, 0, 0, 0];
    if (fico >= 800) rangeData[0] = 1;
    else if (fico >= 750) rangeData[1] = 1;
    else if (fico >= 700) rangeData[2] = 1;
    else if (fico >= 650) rangeData[3] = 1;
    else if (fico >= 600) rangeData[4] = 1;
    else rangeData[5] = 1;
    
    window.bankDataChartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ranges,
        datasets: [{
          data: rangeData.map(v => v === 0 ? 0.1 : 1),
          backgroundColor: ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444', '#dc2626'].map((c, i) => rangeData[i] ? c : 'rgba(255,255,255,0.1)')
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() } },
          title: { display: true, text: `FICO: ${fico}`, color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim(), font: { size: 16, weight: '700' } }
        }
      }
    });
    return;
  }
  
  window.bankDataChartInstance = new Chart(ctx, {
    type: chartType,
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          display: datasets.length > 1,
          labels: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() }
        }
      },
      scales: {
        x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted').trim() }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted').trim() }, grid: { color: 'rgba(255,255,255,0.05)' } }
      }
    }
  });
}

function updateMiniMonthlyChart() {
  const container = document.getElementById('miniMonthlyChart');
  if (!container || !currentDeal) return;
  
  const months = currentDeal.months || [];
  if (months.length === 0) {
    container.innerHTML = '<div style="width: 100%; text-align: center; color: var(--text-muted); font-size: 0.75rem;">No data</div>';
    return;
  }
  
  const revenues = months.map(m => parseFloat(String(m.revenue || m.totalRevenue || 0).replace(/[$,]/g, '')) || 0);
  const maxRev = Math.max(...revenues, 1);
  
  container.innerHTML = revenues.map((rev, i) => {
    const height = Math.max(5, (rev / maxRev) * 100);
    const color = rev > maxRev * 0.7 ? 'var(--tier-a)' : rev > maxRev * 0.4 ? 'var(--tier-c)' : 'var(--tier-d)';
    return `<div style="flex: 1; height: ${height}%; background: ${color}; border-radius: 2px; min-width: 8px;" title="${months[i].month || `M${i+1}`}: ${formatCurrency(rev)}"></div>`;
  }).join('');
}

function toggleSidebar() {
  const sidebar = document.getElementById('detailSidebar');
  sidebar.classList.toggle('collapsed');
  localStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed'));
}

function initSidebarState() {
  const collapsed = localStorage.getItem('sidebar_collapsed') === 'true';
  if (collapsed) {
    document.getElementById('detailSidebar')?.classList.add('collapsed');
  }
  // Initialize panel states
  initPanelStates();
}

// ===============================
// COLLAPSIBLE PANEL FUNCTIONS
// ===============================
function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  if (panel) {
    panel.classList.toggle('collapsed');
    localStorage.setItem(panelId + '_collapsed', panel.classList.contains('collapsed'));
  }
}

function initPanelStates() {
  // Clear any stored collapsed states and force ALL panels expanded
  const allPanels = ['panelScore', 'panelQuickScrub', 'panelHubble', 'panelQuickActions', 'panelDealNotes', 'panelStackingStatus', 'panelDocStatus'];
  allPanels.forEach(panelId => {
    // Clear stored state
    localStorage.removeItem(panelId + '_collapsed');
    
    // Force panel expanded
    const panel = document.getElementById(panelId);
    if (panel) {
      panel.classList.remove('collapsed');
    }
  });
}

// ===============================
// HUBBLE AI CHAT (Gemini API)
// ===============================
let hubbleHistory = [];

async function sendHubbleMessage() {
  const input = document.getElementById('hubbleInput');
  const message = input.value.trim();
  if (!message || !currentDeal) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    addChatMessage('system', 'Please add your Gemini API key in Settings.');
    return;
  }
  
  input.value = '';
  addChatMessage('user', message);
  
  const sendBtn = document.getElementById('hubbleSendBtn');
  sendBtn.disabled = true;
  
  const dealContext = buildDealContext();
  
  // Build conversation history for context
  let historyContext = '';
  if (hubbleHistory.length > 0) {
    historyContext = '\n\nPrevious conversation:\n' + hubbleHistory.map(h => `${h.role}: ${h.content}`).join('\n');
  }
  
  try {
    const model = getGeminiModel();
    const prompt = `You are Hubble, an expert MCA underwriter assistant. Analyze deals and provide insights on cash flow, risk, and funding recommendations. Be concise and direct.

Current deal context:
${dealContext}
${historyContext}

User question: ${message}

Provide a helpful, concise response.`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.4, maxOutputTokens: 1024 }
      })
    });
    
    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
    
    hubbleHistory.push({ role: 'user', content: message });
    hubbleHistory.push({ role: 'assistant', content: reply });
    
    // Keep history manageable
    if (hubbleHistory.length > 10) {
      hubbleHistory = hubbleHistory.slice(-10);
    }
    
    addChatMessage('assistant', reply);
  } catch (err) {
    console.error('Hubble error:', err);
    addChatMessage('system', 'Error: ' + err.message);
  } finally {
    sendBtn.disabled = false;
  }
}

function buildDealContext() {
  if (!currentDeal) return 'No deal selected.';
  
  const months = currentDeal.months || [];
  const totalRev = months.reduce((s, m) => s + (m.revenue || 0), 0);
  const avgRev = months.length ? Math.round(totalRev / months.length) : 0;
  const totalNsf = months.reduce((s, m) => s + (m.nsfs || 0), 0);
  const totalNegDays = months.reduce((s, m) => s + (m.negatives || 0), 0);
  const avgDailyBal = months.length ? Math.round(months.reduce((s, m) => s + (m.avgDailyBal || 0), 0) / months.length) : 0;
  
  let context = `Business: ${currentDeal.businessName || 'Unknown'}
DBA: ${currentDeal.dba || 'N/A'}
Industry: ${currentDeal.industry || 'Unknown'}
Time in Business: ${currentDeal.tib || 'Unknown'}
Entity Type: ${currentDeal.entityType || 'Unknown'}
Status: ${currentDeal.entityStatus || 'Unknown'}
State: ${currentDeal.stateCode || 'Unknown'}

Owner: ${currentDeal.ownerName || 'Unknown'}
FICO Score: ${currentDeal.fico || 'Unknown'}
Ownership: ${currentDeal.ownership || 100}%

ABLESCORE: ${currentDeal.score || 0}/100
Tier: ${currentDeal.tier || 'Unknown'}

Financial Summary (${months.length} months of data):
- Total Revenue: $${totalRev.toLocaleString()}
- Average Monthly Revenue: $${avgRev.toLocaleString()}
- Average Daily Balance: $${avgDailyBal.toLocaleString()}
- Total NSFs: ${totalNsf}
- Total Negative Days: ${totalNegDays}`;

  if (currentDeal.deepResearch?.risk) {
    context += `

Risk Assessment:
- Rating: ${currentDeal.deepResearch.risk.rating || 'Unknown'}
- Score: ${currentDeal.deepResearch.risk.score || 'Unknown'}/100`;
  }

  if (currentDeal.credit_report) {
    context += `

Credit Report:
- FICO: ${currentDeal.credit_report.scores?.fico || 'N/A'}
- Total Accounts: ${currentDeal.credit_report.summary?.total_accounts || 'N/A'}
- Delinquent: ${currentDeal.credit_report.summary?.delinquent_accounts || 'N/A'}`;
  }

  return context;
}

function addChatMessage(role, content) {
  const container = document.getElementById('hubbleMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'ai-message ' + role;
  
  // Format markdown-like content
  let formatted = content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
  
  msgDiv.innerHTML = formatted;
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

function quickHubble(prompt) {
  document.getElementById('hubbleInput').value = prompt;
  sendHubbleMessage();
}

function clearHubbleChat() {
  hubbleHistory = [];
  const container = document.getElementById('hubbleMessages');
  container.innerHTML = '<div class="ai-message system">Ask me anything about this deal. I can analyze financials, research the business, assess risk, and more.</div>';
}

function switchSettingsTab(tab) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('settingsTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('settingsPanel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

function openSettingsModal() {
  const apiKey = localStorage.getItem('greatdane_api_key') || '';
  const model = localStorage.getItem('greatdane_model') || 'gemini-2.5-flash';
  document.getElementById('settingsApiKey').value = apiKey;
  document.getElementById('settingsModel').value = model;
  loadUnderwritingSettings();
  // Update theme and accent button states
  if (typeof updateThemeButtons === 'function') updateThemeButtons();
  if (typeof updateAccentButtons === 'function') updateAccentButtons();
  document.getElementById('settingsModal').classList.add('active');
}

function loadUnderwritingSettings() {
  const defaults = {
    ficoWeight: 50, ficoFloor: 500, ficoCeiling: 800,
    revenueWeight: 20, revenueThreshold: 10,
    nsfPenaltyMax: 15, nsfThreshold: 3,
    negativeDayPenaltyMax: 10, negativeDayThreshold: 5,
    tib6moBonus: 5, tib12moBonus: 8, tib24moBonus: 10,
    collectWeight: 15, minAvgDailyBal: 500, depositFreqWeight: 10, lowBalPenalty: 10
  };
  Object.keys(defaults).forEach(key => {
    const val = localStorage.getItem('uw_' + key) || defaults[key];
    const el = document.getElementById('uw_' + key);
    if (el) {
      el.value = val;
      const display = document.getElementById('uw_' + key + '_val');
      if (display) display.textContent = val;
    }
  });
  
  // Load webhook settings
  loadWebhookSettings();
}

function updateUnderwritingSetting(key, value) {
  localStorage.setItem('uw_' + key, value);
  const display = document.getElementById('uw_' + key + '_val');
  if (display) display.textContent = value;
}

function resetUnderwritingDefaults() {
  const defaults = {
    ficoWeight: 50, ficoFloor: 500, ficoCeiling: 800,
    revenueWeight: 20, revenueThreshold: 10,
    nsfPenaltyMax: 15, nsfThreshold: 3,
    negativeDayPenaltyMax: 10, negativeDayThreshold: 5,
    tib6moBonus: 5, tib12moBonus: 8, tib24moBonus: 10,
    collectWeight: 15, minAvgDailyBal: 500, depositFreqWeight: 10, lowBalPenalty: 10
  };
  Object.keys(defaults).forEach(key => {
    localStorage.setItem('uw_' + key, defaults[key]);
    const el = document.getElementById('uw_' + key);
    if (el) el.value = defaults[key];
    const display = document.getElementById('uw_' + key + '_val');
    if (display) display.textContent = defaults[key];
  });
  showToast('Underwriting settings reset to defaults', 'success');
}

// ===============================
// WEBHOOK / ZAPIER INTEGRATION
// ===============================
function loadWebhookSettings() {
  const webhookFields = ['webhookNewDeal', 'webhookBankProcessed', 'webhookScoreCalc', 'webhookResearch', 'webhookCredit', 'webhookStatus'];
  webhookFields.forEach(field => {
    const el = document.getElementById(field);
    if (el) el.value = localStorage.getItem(field) || '';
  });
  
  const enabled = document.getElementById('webhooksEnabled');
  if (enabled) enabled.checked = localStorage.getItem('webhooksEnabled') === 'true';
  
  const includeMonths = document.getElementById('webhookIncludeMonths');
  if (includeMonths) includeMonths.checked = localStorage.getItem('webhookIncludeMonths') === 'true';
}

function saveWebhookSettings() {
  const webhookFields = ['webhookNewDeal', 'webhookBankProcessed', 'webhookScoreCalc', 'webhookResearch', 'webhookCredit', 'webhookStatus'];
  webhookFields.forEach(field => {
    const el = document.getElementById(field);
    if (el) localStorage.setItem(field, el.value);
  });
  
  const enabled = document.getElementById('webhooksEnabled');
  if (enabled) localStorage.setItem('webhooksEnabled', enabled.checked);
  
  const includeMonths = document.getElementById('webhookIncludeMonths');
  if (includeMonths) localStorage.setItem('webhookIncludeMonths', includeMonths.checked);
}

async function triggerWebhook(type, data) {
  if (localStorage.getItem('webhooksEnabled') !== 'true') return;
  
  const webhookMap = {
    'newDeal': 'webhookNewDeal',
    'bankProcessed': 'webhookBankProcessed',
    'scoreCalc': 'webhookScoreCalc',
    'research': 'webhookResearch',
    'credit': 'webhookCredit',
    'status': 'webhookStatus'
  };
  
  const webhookUrl = localStorage.getItem(webhookMap[type]);
  if (!webhookUrl) return;
  
  try {
    const includeMonths = localStorage.getItem('webhookIncludeMonths') === 'true';
    const payload = {
      event: type,
      timestamp: new Date().toISOString(),
      deal: {
        id: data.id,
        businessName: data.businessName,
        dba: data.dba,
        industry: data.industry,
        address: data.address,
        stateCode: data.stateCode,
        entityType: data.entityType,
        entityStatus: data.entityStatus,
        formationDate: data.formationDate,
        tib: data.tib,
        website: data.website,
        phone: data.phone,
        ownerName: data.ownerName,
        ownerEmail: data.ownerEmail,
        ownerPhone: data.ownerPhone,
        fico: data.fico,
        score: data.score,
        tier: data.tier,
        createdAt: data.createdAt
      }
    };
    
    // Add monthly data if enabled
    if (includeMonths && data.months?.length) {
      payload.deal.months = data.months;
      payload.deal.summary = {
        totalRevenue: data.months.reduce((s, m) => s + (m.revenue || 0), 0),
        avgMonthlyRevenue: Math.round(data.months.reduce((s, m) => s + (m.revenue || 0), 0) / data.months.length),
        totalDeposits: data.months.reduce((s, m) => s + (m.deposits || 0), 0),
        avgDailyBalance: Math.round(data.months.reduce((s, m) => s + (m.avgDailyBal || 0), 0) / data.months.length),
        totalNSFs: data.months.reduce((s, m) => s + (m.nsfs || 0), 0),
        totalNegativeDays: data.months.reduce((s, m) => s + (m.negatives || 0), 0)
      };
    }
    
    // Add type-specific data
    if (type === 'research' && data.deepResearch) {
      payload.research = {
        riskRating: data.deepResearch.risk?.rating,
        riskScore: data.deepResearch.risk?.score,
        industry: data.deepResearch.operations?.industry,
        yearsInBusiness: data.deepResearch.financials?.years_in_business
      };
    }
    
    if (type === 'credit' && data.credit_report) {
      payload.credit = {
        fico: data.credit_report.scores?.fico,
        vantage: data.credit_report.scores?.vantage,
        totalAccounts: data.credit_report.summary?.total_accounts,
        delinquent: data.credit_report.summary?.delinquent_accounts,
        utilization: data.credit_report.summary?.credit_utilization
      };
    }
    
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'no-cors',
      body: JSON.stringify(payload)
    });
    
    console.log(`Webhook triggered: ${type}`);
  } catch (err) {
    console.error('Webhook error:', err);
  }
}

async function testWebhook() {
  if (!currentDeal) {
    showToast('No Deal Selected', 'Open a deal first to test webhooks', 'warning');
    return;
  }
  
  const webhooks = [
    { field: 'webhookNewDeal', name: 'New Deal' },
    { field: 'webhookBankProcessed', name: 'Bank Processed' },
    { field: 'webhookScoreCalc', name: 'Score Calc' },
    { field: 'webhookResearch', name: 'Research' },
    { field: 'webhookCredit', name: 'Credit' },
    { field: 'webhookStatus', name: 'Status' }
  ];
  
  let triggered = 0;
  for (const wh of webhooks) {
    const url = localStorage.getItem(wh.field);
    if (url) {
      try {
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          mode: 'no-cors',
          body: JSON.stringify({
            event: 'test',
            timestamp: new Date().toISOString(),
            webhookType: wh.name,
            deal: {
              id: currentDeal.id,
              businessName: currentDeal.businessName,
              score: currentDeal.score,
              message: 'This is a test webhook from GreatDane Underwriter'
            }
          })
        });
        triggered++;
      } catch (err) {
        console.error(`Test webhook error (${wh.name}):`, err);
      }
    }
  }
  
  if (triggered > 0) {
    showToast('Webhooks Tested', `${triggered} webhook(s) triggered successfully`);
  } else {
    showToast('No Webhooks', 'No webhook URLs configured', 'warning');
  }
}

function saveSettings() {
  const apiKey = document.getElementById('settingsApiKey').value;
  const model = document.getElementById('settingsModel').value;
  if (apiKey) localStorage.setItem('greatdane_api_key', apiKey);
  localStorage.setItem('greatdane_model', model);
  
  // Update API key status
  const statusEl = document.getElementById('apiKeyStatus');
  if (statusEl && apiKey) {
    statusEl.className = 'api-key-status valid';
    statusEl.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      <span>API key saved successfully</span>
    `;
  }
  
  // Show toast and close modal
  showToast('Settings Saved', 'Your preferences have been saved');
  closeSettingsModal();
}

// Auto-save settings on change (without closing modal)
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('settingsApiKey')?.addEventListener('input', () => {
    const apiKey = document.getElementById('settingsApiKey').value;
    const model = document.getElementById('settingsModel').value;
    if (apiKey) localStorage.setItem('greatdane_api_key', apiKey);
    localStorage.setItem('greatdane_model', model);
  });
  document.getElementById('settingsModel')?.addEventListener('change', () => {
    const model = document.getElementById('settingsModel').value;
    localStorage.setItem('greatdane_model', model);
  });
});

function exportDeals() {
  const data = { deals: allDeals, exportDate: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `greatdane-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importDeals(e) {
  const file = e.target?.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const data = JSON.parse(evt.target.result);
      if (data.deals?.length) {
        allDeals = [...data.deals, ...allDeals];
        saveDealsToStorage();
        renderDealList();
        alert(`Imported ${data.deals.length} deals successfully.`);
      }
    } catch (err) {
      alert('Failed to import: Invalid file format.');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function clearAllData() {
  if (confirm('Are you sure? This will delete ALL deals and cannot be undone.')) {
    allDeals = [];
    currentDeal = null;
    saveDealsToStorage();
    renderDealList();
    showDashboard();
    alert('All data cleared.');
  }
}

async function handleHeaderQuickScrub(e) {
  const files = e.target?.files;
  if (!files?.length) return;
  const apiKey = localStorage.getItem('greatdane_api_key');
  if (!apiKey) { alert('Enter your Gemini API key first (click Settings).'); return; }
  
  // === IMMEDIATELY CREATE DEAL AND SHOW PAGE ===
  const newDeal = {
    id: Date.now(),
    businessName: 'Processing...',
    dba: '',
    industry: '',
    tib: '',
    address: '',
    stateCode: '',
    entityType: '',
    entityStatus: '',
    formationDate: '',
    website: '',
    phone: '',
    ownerName: '',
    ownerEmail: '',
    ownerPhone: '',
    fico: 650,
    ownership: 100,
    score: 0,
    months: [],
    accounts: [],
    bankData: null,
    entityData: null,
    _fieldSource: {}
  };
  
  allDeals.unshift(newDeal);
  currentDeal = newDeal;
  saveDealsToStorage();
  renderDealList();
  showDetailView();
  populateDetailView();
  
  // Show non-blocking floating progress
  showFloatingProgress('Extracting Document Data');
  
  // Start tracking document extraction
  startSearch('Document Extraction');
  
  // Track detected values for progress and search triggering
  const detected = {};
  let lastLength = 0;
  let streamStarted = false;
  let searchesTriggered = false;
  
  // Helper to update progress bar and percent
  const updateProgress = (percent, text) => {
    const bar = document.getElementById('extractionBar');
    const pct = document.getElementById('extractionPercent');
    const phase = document.getElementById('extractionPhase');
    if (bar) bar.style.width = `${percent}%`;
    if (pct) pct.textContent = `${percent}%`;
    if (phase && text) phase.textContent = text;
    
    // Sync with workflow progress bar
    if (typeof setSearchProgress === 'function') {
      setSearchProgress('Document Extraction', percent);
    }
  };
  
  // Helper to animate field with visible flash
  const animateField = (el, value) => {
    if (!el || !value) return;
    const oldValue = el.value;
    el.value = value;
    
    // Only animate if value actually changed
    if (oldValue !== value) {
      el.classList.add('field-populated');
      el.style.transform = 'scale(1.02)';
      setTimeout(() => {
        el.style.transform = '';
        el.classList.remove('field-populated');
      }, 1500);
    }
  };
  
  // Fire all searches as soon as we have a business name
  const triggerSearches = (businessName) => {
    if (searchesTriggered || !businessName || businessName === 'Processing...') return;
    searchesTriggered = true;
    
    console.log(' Triggering all searches for:', businessName);
    
    // Fire ALL searches in parallel immediately - no awaits
    setTabLoading('tabBusiness', true);
    startSearch('Entity Verification');
    searchAndFillEntity(businessName, apiKey)
      .then(() => { setTabComplete('tabBusiness', true); endSearch('Entity Verification'); })
      .catch(() => { setTabLoading('tabBusiness', false); endSearch('Entity Verification'); });
    
    // All Intel searches fire simultaneously - fire and forget
    runDeepResearchAuto();
    runBackgroundAuto();
    runFootprintAuto();
  };
  
  // === PARALLEL QUICK EXTRACT ===
  // Fire a fast request to get business name while full extraction runs
  const quickExtractPromise = quickExtractBusinessName(files, apiKey).then(name => {
    if (name && !searchesTriggered && name !== 'Processing...') {
      console.log(' Quick extract found business name:', name);
      currentDeal.businessName = name;
      animateField(document.getElementById('editLegalName'), name);
      renderDealList();
      triggerSearches(name);
    }
  }).catch(err => console.log('Quick extract skipped:', err.message));
  
  try {
    // Pass onChunk for real-time progress updates AND field population
    const extractedData = await processFilesWithGemini(files, apiKey, (streamText) => {
      const len = streamText.length;
      
      if (!streamStarted || len > lastLength + 100) {
        lastLength = len;
        
        let baseProgress = 18;
        if (streamText.includes('"business"')) baseProgress = 22;
        if (streamText.includes('"owner"')) baseProgress = 38;
        if (streamText.includes('"accounts"')) baseProgress = 50;
        if (streamText.includes('"months"')) baseProgress = 62;
        if (streamText.includes('"credit_report"')) baseProgress = 85;
        
        if (!streamStarted) {
          streamStarted = true;
          updateProgress(18, 'Receiving data...');
        } else if (!detected.businessName && !detected.ownerName) {
          updateProgress(baseProgress, 'Extracting data...');
        }
      }
      
      // === REAL-TIME FIELD POPULATION ===
      if (!detected.businessName) {
        const match = streamText.match(/"business"[\s\S]*?"name"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 1) {
          detected.businessName = match[1];
          currentDeal.businessName = match[1];
          animateField(document.getElementById('editLegalName'), match[1]);
          updateProgress(25, `Found: ${match[1]}`);
          renderDealList(); // Update sidebar with real name
          
          // === TRIGGER ALL SEARCHES AS SOON AS WE HAVE A NAME ===
          triggerSearches(match[1]);
        }
      }
      
      if (!detected.ownerName) {
        const match = streamText.match(/"owner"[\s\S]*?"name"\s*:\s*"([^"]+)"/);
        if (match && match[1] && match[1].length > 1) {
          detected.ownerName = match[1];
          currentDeal.ownerName = match[1];
          animateField(document.getElementById('editOwnerName'), match[1]);
          updateProgress(40, `Owner: ${match[1]}`);
        }
      }
      
      if (!detected.bank && streamText.includes('"accounts"')) {
        const bankMatch = streamText.match(/"bankName"\s*:\s*"([^"]+)"/);
        const last4Match = streamText.match(/"accountLast4"\s*:\s*"([^"]+)"/);
        if (bankMatch || last4Match) {
          detected.bank = true;
          updateProgress(55, `Bank: ${bankMatch?.[1] || ''} ${last4Match?.[1] || ''}`);
        }
      }
      
      if (streamText.includes('"months"')) {
        const monthMatches = [...streamText.matchAll(/"monthLabel"\s*:\s*"([^"]+)"/g)];
        const monthCount = monthMatches.length;
        if (monthCount > 0 && monthCount !== detected.monthCount) {
          detected.monthCount = monthCount;
          const pct = 55 + Math.min(monthCount * 3, 30);
          updateProgress(pct, `${monthCount} month${monthCount > 1 ? 's' : ''} of data...`);
        }
      }
      
      if (!detected.fico && streamText.includes('"credit_report"')) {
        const ficoMatch = streamText.match(/"fico"\s*:\s*(\d+)/);
        if (ficoMatch && parseInt(ficoMatch[1]) > 300) {
          detected.fico = parseInt(ficoMatch[1]);
          currentDeal.fico = detected.fico;
          animateField(document.getElementById('editFico'), detected.fico);
          updateProgress(90, `FICO: ${detected.fico}`);
        }
      }
    });
    
    // Update deal with full extracted data
    currentDeal.businessName = extractedData?.business?.name || extractedData.businessName || detected.businessName || 'New Deal';
    currentDeal.dba = extractedData?.business?.dba || extractedData.dba || '';
    currentDeal.industry = extractedData?.business?.industry || extractedData.industry || '';
    currentDeal.address = extractedData?.business?.address || extractedData.address || '';
    currentDeal.stateCode = extractedData?.business?.stateCode || '';
    currentDeal.entityType = extractedData?.business?.entityType || '';
    currentDeal.entityStatus = extractedData?.business?.status || '';
    currentDeal.formationDate = extractedData?.business?.formationDate || '';
    currentDeal.website = extractedData?.business?.website || '';
    currentDeal.phone = extractedData?.business?.phone || '';
    currentDeal.ownerName = extractedData?.owner?.name || extractedData.ownerName || detected.ownerName || '';
    currentDeal.ownerEmail = extractedData?.owner?.email || '';
    currentDeal.ownerPhone = extractedData?.owner?.phone || '';
    currentDeal.months = normalizeMonths(extractedData.months || []);
    currentDeal.accounts = extractedData.accounts || [];
    currentDeal.bankData = extractedData;
    
    // Handle credit report
    if (extractedData?.credit_report) {
      currentDeal.credit_report = extractedData.credit_report;
      const creditScore = extractedData.credit_report.scores?.fico || extractedData.credit_report.scores?.experian;
      if (creditScore) currentDeal.fico = creditScore;
    }
    
    saveDealsToStorage();
    renderDealList();
    populateDetailView();
    recalculateScore();
    updateOffer();
    
    // Mark document extraction complete
    endSearch('Document Extraction');
    
    // Trigger searches if not already done
    if (!searchesTriggered && currentDeal.businessName !== 'New Deal') {
      triggerSearches(currentDeal.businessName);
    }
    
    // Run debt analysis now that we have months
    if (currentDeal.months?.length > 0 && !currentDeal.debtReport) {
      runDebtAnalysisAuto();
    }
    
  } catch (err) {
    console.error(err);
    hideFloatingProgress(false);
    endSearch('Document Extraction');
    showToast('Error', 'Error processing files: ' + err.message, 'error');
  } finally {
    hideFloatingProgress(true);
    e.target.value = '';
  }
}

async function searchEntity() {
  const query = document.getElementById('entitySearchInput').value.trim();
  if (!query) { alert('Enter a business name to search.'); return; }
  const apiKey = getGeminiApiKey();
  if (!apiKey) { alert('Enter your Gemini API key first.'); return; }

  const modal = document.getElementById('entityModal');
  const body = document.getElementById('entityModalBody');
  const subtitle = document.getElementById('entityModalSubtitle');

  subtitle.textContent = `Searching: ${query}`;
  body.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="width: 40px; height: 40px; border: 3px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div><p style="color: var(--text-muted);">Searching with Gemini API...</p></div><style>@keyframes spin { to { transform: rotate(360deg); } }</style>';
  modal.classList.add('active');

  try {
    const model = getGeminiModel();
    const prompt = `You are an underwriting OSINT analyst.

INPUT_NAME: "${query}"

GOAL: Identify the correct U.S. business entity record for the INPUT_NAME.

STRICT RULES:
- Search using the EXACT PHRASE in quotes first: "${query}"
- Prefer authoritative sources: State Secretary of State / business registry pages.
- Secondary sources allowed: SEC EDGAR, OpenCorporates, official company website.
- Avoid low-quality directories. Do NOT guess a state without evidence.
- If ambiguous, return multiple candidates.

Return JSON ONLY with this schema:
{
  "input_name": "",
  "normalized_input": "",
  "candidates": [
    {
      "legal_name": "",
      "dba": "",
      "state": "",
      "stateCode": "XX",
      "entityType": "",
      "status": "",
      "formationDate": "",
      "registeredAgent": "",
      "address": "",
      "officers": [],
      "industry": "",
      "hq": "",
      "sources": [{"title":"","url":""}],
      "evidence": ["<=20 word snippet"],
      "confidence": 0
    }
  ],
  "notes": ""
}`;

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.1 }
      })
    });

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    if (!parsed) throw new Error('Failed to parse entity JSON');

    const ranked = rankEntityCandidates(query, parsed.candidates || []);
    const best = ranked[0];
    if (!best) throw new Error('No candidates found');

    const entity = {
      businessName: best.legal_name || query,
      dba: best.dba || '',
      state: best.state || '',
      stateCode: (best.stateCode || '').toUpperCase(),
      entityType: best.entityType || '',
      status: best.status || '',
      formationDate: best.formationDate || '',
      registeredAgent: best.registeredAgent || '',
      address: best.address || '',
      officers: best.officers || [],
      industry: best.industry || '',
      hq: best.hq || '',
      confidence: best.confidence || 0,
      sources: best.sources || [],
      summary: parsed.notes || ''
    };

    renderEntityResults(entity, query);

  } catch (err) {
    console.error(err);
    body.innerHTML = `<div style="padding: 20px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="color: var(--tier-e); font-weight: 600;">Search Failed</p><p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p></div>`;
  }
}

function renderEntityResults(entity, query) {
  const body = document.getElementById('entityModalBody');
  const subtitle = document.getElementById('entityModalSubtitle');
  const statusColor = entity.status?.toLowerCase().includes('active') ? 'var(--tier-a)' : 'var(--tier-e)';
  const confColor = entity.confidence >= 80 ? 'var(--tier-a)' : entity.confidence >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
  
  subtitle.textContent = entity.businessName || query;
  
  body.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <div style="font-size: 2.5rem; font-weight: 800; color: var(--accent); line-height: 1;">${entity.stateCode || '--'}</div>
        <div>
          <div style="font-size: 1.1rem; font-weight: 600;">${entity.state || 'Unknown State'}</div>
          <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);">Primary Jurisdiction</div>
        </div>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 1.75rem; font-weight: 700; color: ${confColor};">${entity.confidence || 0}%</div>
        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);">Confidence</div>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Entity Type</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.entityType || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Status</div>
        <div style="font-size: 0.9rem; font-weight: 600; color: ${statusColor};">${entity.status || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Formation Date</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.formationDate || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Industry</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.industry || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Registered Agent</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.registeredAgent || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Address</div>
        <div style="font-size: 0.85rem; font-weight: 500;">${entity.address || '--'}</div>
      </div>
    </div>
    
    ${entity.officers?.length ? `
    <div style="background: var(--bg-secondary); border: 1px solid var(--border-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
      <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); margin-bottom: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Officers / Members
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${entity.officers.map(o => `<span style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">${o}</span>`).join('')}
      </div>
    </div>
    ` : ''}
    
    ${entity.summary ? `
    <div style="background: var(--bg-secondary); border: 1px solid var(--border-secondary); border-radius: 12px; padding: 16px;">
      <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); margin-bottom: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Summary
      </div>
      <div style="font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary);">${entity.summary}</div>
    </div>
    ` : ''}
    
    <div style="margin-top: 20px; display: flex; gap: 12px;">
      <button class="btn-primary" style="flex: 1; justify-content: center;" onclick="applyEntityToDeal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="20 6 9 17 4 12"/></svg>
        Apply to Current Deal
      </button>
      <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="closeEntityModal()">Close</button>
    </div>
  `;
  
  window.lastEntityResult = entity;
}

function applyEntityToDeal() {
  if (!currentDeal || !window.lastEntityResult) {
    alert('No deal selected or no entity data available.');
    return;
  }
  const e = window.lastEntityResult;
  currentDeal.entityData = e;

  // Apply and mark as manual (because user clicked Apply)
  const set = (field, value, elId) => {
    if (!value) return;
    currentDeal[field] = value;
    currentDeal._fieldSource = currentDeal._fieldSource || {};
    currentDeal._fieldSource[field] = 'manual';
    if (elId && document.getElementById(elId)) document.getElementById(elId).value = value;
  };

  set('businessName', e.businessName || e.legal_name, 'editLegalName');
  set('dba', e.dba, 'editDba');
  set('industry', e.industry, 'editIndustry');
  set('address', e.address, 'editAddress');
  set('stateCode', e.stateCode, 'editStateCode');
  set('entityType', e.entityType, 'editEntityType');
  set('entityStatus', e.status, 'editEntityStatus');
  set('formationDate', e.formationDate, 'editFormationDate');

  // Derive TIB if possible
  if (currentDeal.formationDate) {
    const years = Math.floor((Date.now() - new Date(currentDeal.formationDate).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
    currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
    if (document.getElementById('editTib')) document.getElementById('editTib').value = currentDeal.tib;
  }

  saveDealsToStorage();
  renderDealList();
  updateProfileCompletenessUI();
  renderEntityVerificationCard();
  closeEntityModal();
}

function saveDealsToStorage() { localStorage.setItem('greatdane_deals', JSON.stringify(allDeals)); }
function loadDealsFromStorage() {
  const s = localStorage.getItem('greatdane_deals');
  if (s) allDeals = JSON.parse(s);
  renderDealList();
}
function formatCurrency(v) { return '$' + (v || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function parseCurrency(s) { return parseFloat(String(s).replace(/[$,]/g, '')) || 0; }


function normalizeName(name) {
  return String(name || '')
    .toLowerCase()
    .replace(/&/g, ' and ')
    .replace(/[^a-z0-9\s]/g, ' ')
    .replace(/\b(incorporated|inc|llc|l\s*\.?l\s*\.?c\s*\.?|ltd|limited|corp|corporation|co|company|pllc|lp|llp|l\s*\.?p\s*\.?|l\s*\.?l\s*\.?p\s*\.?)\b/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function matchTier(inputName, candidateName) {
  const aRaw = String(inputName || '').trim().toLowerCase();
  const bRaw = String(candidateName || '').trim().toLowerCase();
  if (!aRaw || !bRaw) return 99;
  if (aRaw === bRaw) return 0; // exact
  const a = normalizeName(aRaw);
  const b = normalizeName(bRaw);
  if (a && b && a === b) return 1; // normalized exact
  if (a && b && (b.includes(a) || a.includes(b))) return 2; // partial
  // token overlap heuristic (cheap fuzzy)
  const ta = new Set(a.split(' ').filter(Boolean));
  const tb = new Set(b.split(' ').filter(Boolean));
  const inter = [...ta].filter(x => tb.has(x)).length;
  const union = new Set([...ta, ...tb]).size || 1;
  const j = inter / union;
  return j >= 0.6 ? 3 : 4;
}

function monthLabelFromKey(key) {
  const m = String(key || '').match(/^(\d{4})-(\d{2})$/);
  if (!m) return String(key || '');
  const y = parseInt(m[1], 10);
  const mo = parseInt(m[2], 10);
  const names = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return (names[mo-1] || 'Month') + ' ' + y;
}

function parseMonthKey(str) {
  if (!str) return '';
  const s = String(str).trim();
  // Accept already normalized YYYY-MM
  if (/^\d{4}-\d{2}$/.test(s)) return s;

  // Accept formats like "Jan 2024", "January 2024", "01/2024"
  const m1 = s.match(/^(\d{1,2})\/(\d{4})$/);
  if (m1) return `${m1[2]}-${String(m1[1]).padStart(2,'0')}`;

  const m2 = s.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{4})$/i);
  if (m2) {
    const map = { jan:'01', feb:'02', mar:'03', apr:'04', may:'05', jun:'06', jul:'07', aug:'08', sep:'09', sept:'09', oct:'10', nov:'11', dec:'12' };
    return `${m2[2]}-${map[m2[1].toLowerCase()] || '01'}`;
  }

  // Accept "2024-01-31" -> "2024-01"
  const m3 = s.match(/^(\d{4})-(\d{2})-\d{2}$/);
  if (m3) return `${m3[1]}-${m3[2]}`;

  return '';
}

function normalizeMonths(months) {
  const list = Array.isArray(months) ? months : [];
  const out = [];
  const seen = new Set();

  for (const raw of list) {
    const m = { ...raw };
    const key = m.monthKey || parseMonthKey(m.monthLabel) || parseMonthKey(m.month);
    if (!key) continue;
    m.monthKey = key;
    m.monthLabel = m.monthLabel || monthLabelFromKey(key);
    m.month = m.monthLabel;

    // defaults
    m.revenue = Number(m.revenue || 0);
    m.deposits = Number(m.deposits || 0);
    m.withdrawals = Number(m.withdrawals || 0);
    m.endingBal = Number(m.endingBal || 0);
    m.avgDailyBal = Number(m.avgDailyBal || 0);
    m.depositCount = Number(m.depositCount || 0);
    m.overdraftFees = Number(m.overdraftFees || 0);
    m.nsfs = Number(m.nsfs || 0);
    m.negatives = Number(m.negatives || 0);
    m.transfers = Number(m.transfers || 0);
    m.lenderDeposits = Number(m.lenderDeposits || 0);
    m.returnItems = Number(m.returnItems || 0);
    m.debtService = Number(m.debtService || 0);
    m.trueDeposits = Number(m.trueDeposits || 0);
    m.trueCredits = Number(m.trueCredits || 0);
    m.trueDebits = Number(m.trueDebits || 0);
    
    // Calculate trueDeposits if not provided
    if (m.trueDeposits === 0 && m.deposits > 0) {
      m.trueDeposits = m.deposits - m.transfers - m.lenderDeposits;
    }
    
    // Calculate trueCredits if not provided
    // Exclude: transfers, lender deposits, return items
    if (m.trueCredits === 0 && m.deposits > 0) {
      m.trueCredits = Math.max(0, m.deposits - m.transfers - m.lenderDeposits - m.returnItems);
    }
    
    // Calculate trueDebits if not provided (use withdrawals minus transfers)
    if (m.trueDebits === 0 && m.withdrawals > 0) {
      m.trueDebits = Math.max(0, m.withdrawals - m.transfers);
    }
    
    // Calculate avgDailyBal if not provided but we have ending balance
    if (m.avgDailyBal === 0 && m.endingBal > 0) {
      // Estimate: use ending balance as proxy, or calculate from deposits/withdrawals
      // A simple estimate: ending balance is a reasonable proxy for average daily balance
      m.avgDailyBal = m.endingBal;
    }

    if (!seen.has(key)) {
      seen.add(key);
      out.push(m);
    } else {
      // merge into existing: fill missing/zero fields only
      const ex = out.find(x => x.monthKey === key);
      const fields = ['revenue','deposits','withdrawals','endingBal','avgDailyBal','depositCount','overdraftFees','nsfs','negatives','transfers','lenderDeposits','returnItems','debtService','trueDeposits','trueCredits','trueDebits'];
      for (const f of fields) {
        const exVal = Number(ex[f] || 0);
        const inVal = Number(m[f] || 0);
        if ((exVal === 0 || Number.isNaN(exVal)) && inVal > 0) ex[f] = inVal;
      }
    }
  }

  out.sort((a, b) => (a.monthKey || '').localeCompare(b.monthKey || ''));
  return out;
}

function calcDealCompleteness(deal) {
  if (!deal) return { pct: 0, missing: [] };

  const missing = [];
  const must = [
    { k: 'businessName', label: 'Legal name' },
    { k: 'industry', label: 'Industry' },
    { k: 'address', label: 'Address' },
    { k: 'stateCode', label: 'Incorp. state' },
    { k: 'entityType', label: 'Entity type' },
    { k: 'formationDate', label: 'Formation date' },
    { k: 'ownerName', label: 'Owner name' },
    { k: 'fico', label: 'FICO' }
  ];
  for (const f of must) {
    const v = deal[f.k];
    if (v === undefined || v === null || String(v).trim() === '' || (f.k === 'fico' && !(parseInt(v,10) > 0))) missing.push(f.label);
  }
  const monthsOk = (deal.months?.length || 0) >= 3;
  if (!monthsOk) missing.push(' 3 months financials');

  const totalRequired = must.length + 1;
  const completed = totalRequired - missing.length;
  const pct = Math.max(0, Math.min(100, Math.round((completed / totalRequired) * 100)));
  return { pct, missing };
}

function updateProfileCompletenessUI() {
  if (!currentDeal) return;
  const { pct, missing } = calcDealCompleteness(currentDeal);
  const pctEl = document.getElementById('profileCompletionPct');
  const barEl = document.getElementById('profileCompletionBar');
  const listEl = document.getElementById('profileMissingList');
  if (!pctEl || !barEl || !listEl) return;

  pctEl.textContent = pct + '%';
  barEl.style.width = pct + '%';

  if (!missing.length) {
    listEl.innerHTML = '<div class="check-item"><strong>All required fields captured</strong><span class="tag" style="border-color: var(--tier-a); color: var(--tier-a);">Ready</span></div>';
  } else {
    listEl.innerHTML = missing.slice(0, 6).map(m => `<div class="check-item"><strong>${m}</strong><span class="tag">Missing</span></div>`).join('');
  }
}

function renderDealInsights() {
  if (!currentDeal) return;
  const kpi = document.getElementById('dealKpis');
  const canvas = document.getElementById('dealCashflowChart');

  if (!kpi || !canvas) return;

  const months = normalizeMonths(currentDeal.months || []);
  currentDeal.months = months;

  const dep = months.map(m => m.deposits || m.revenue || 0);
  const wdr = months.map(m => m.withdrawals || 0);
  const labels = months.map(m => m.monthLabel || m.month);

  const avgDep = dep.length ? dep.reduce((a,b) => a + b, 0) / dep.length : 0;
  const avgWdr = wdr.length ? wdr.reduce((a,b) => a + b, 0) / wdr.length : 0;
  const net = dep.reduce((a,b) => a + b, 0) - wdr.reduce((a,b) => a + b, 0);
  const totalNsfs = months.reduce((a,m) => a + (m.nsfs || 0), 0);
  const totalNeg = months.reduce((a,m) => a + (m.negatives || 0), 0);
  const totalOd = months.reduce((a,m) => a + (m.overdraftFees || 0), 0);

  const last = dep.length ? dep[dep.length-1] : 0;
  const prev = dep.length > 1 ? dep[dep.length-2] : 0;
  const mom = prev > 0 ? ((last - prev) / prev) * 100 : 0;
  
  // Get debt info
  const debt = currentDeal.debtReport;
  const debtTotal = debt?.total_debt || '$0';
  const debtMonthly = debt?.monthly_payments || '$0';
  const debtPositions = debt?.active_positions || 0;

  kpi.innerHTML = `
    <div class="kpi-stat"><div class="kpi-label">Avg Deposits</div><div class="kpi-value text-positive">$${Math.round(avgDep).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">Avg Withdrawals</div><div class="kpi-value">$${Math.round(avgWdr).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">Net Cash Flow</div><div class="kpi-value ${net >= 0 ? 'text-positive' : 'text-negative'}">$${Math.round(net).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">MoM Deposits</div><div class="kpi-value ${mom >= 0 ? 'text-positive' : 'text-negative'}">${(isFinite(mom) ? mom : 0).toFixed(1)}%</div></div>
    <div class="kpi-stat"><div class="kpi-label">NSFs</div><div class="kpi-value ${totalNsfs > 0 ? 'text-negative' : ''}">${totalNsfs}</div></div>
    <div class="kpi-stat"><div class="kpi-label">OD Fees</div><div class="kpi-value ${totalOd > 0 ? 'text-warning' : ''}">$${Math.round(totalOd).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">Est. Debt</div><div class="kpi-value ${debtPositions > 0 ? 'text-negative' : ''}">${debtTotal}</div></div>
    <div class="kpi-stat"><div class="kpi-label">Debt Pmts</div><div class="kpi-value ${debtPositions > 0 ? 'text-warning' : ''}">${debtMonthly}</div></div>
  `;

  if (dealCashflowChart) dealCashflowChart.destroy();
  dealCashflowChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Deposits', data: dep, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.06)', fill: true, tension: 0.35 },
        { label: 'Withdrawals', data: wdr, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.06)', fill: true, tension: 0.35 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'bottom', labels: { color: '#a1a1aa', font: { size: 11, family: 'DM Sans' } } } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });
  
  // Render business metrics charts
  renderBusinessMetricsCharts(months, labels);
}

// Business Metrics Charts
let revenueChartInstance = null;
let balanceChartInstance = null;

function renderBusinessMetricsCharts(months, labels) {
  if (!months || !months.length) return;
  
  const revenueCanvas = document.getElementById('revenueChart');
  const balanceCanvas = document.getElementById('balanceChart');
  
  // Revenue data
  const revenue = months.map(m => m.revenue || m.deposits || 0);
  const avgBal = months.map(m => m.avgDailyBal || m.endingBal || 0);
  const depCount = months.map(m => m.depositCount || 0);
  
  // Calculate metrics
  const avgDailyBal = avgBal.length ? avgBal.reduce((a,b) => a + b, 0) / avgBal.length : 0;
  const avgDepCount = depCount.length ? Math.round(depCount.reduce((a,b) => a + b, 0) / depCount.length) : 0;
  
  // Revenue stability (coefficient of variation)
  const avgRev = revenue.length ? revenue.reduce((a,b) => a + b, 0) / revenue.length : 0;
  const variance = revenue.length ? revenue.reduce((a,b) => a + Math.pow(b - avgRev, 2), 0) / revenue.length : 0;
  const stdDev = Math.sqrt(variance);
  const stability = avgRev > 0 ? Math.max(0, Math.min(100, 100 - (stdDev / avgRev * 100))) : 0;
  
  // Growth rate (first to last month)
  const firstRev = revenue[0] || 0;
  const lastRev = revenue[revenue.length - 1] || 0;
  const growthRate = firstRev > 0 ? ((lastRev - firstRev) / firstRev * 100) : 0;
  
  // Update metric displays
  const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  setEl('metricAvgDailyBal2', '$' + Math.round(avgDailyBal).toLocaleString());
  setEl('metricDepCount', avgDepCount || '--');
  setEl('metricStability', stability > 0 ? stability.toFixed(0) + '%' : '--');
  
  const growthEl = document.getElementById('metricGrowth');
  if (growthEl) {
    growthEl.textContent = growthRate !== 0 ? (growthRate > 0 ? '+' : '') + growthRate.toFixed(1) + '%' : '--';
    growthEl.style.color = growthRate > 0 ? 'var(--tier-a)' : growthRate < 0 ? 'var(--tier-e)' : 'var(--text-primary)';
  }
  
  // Revenue chart
  if (revenueCanvas) {
    if (revenueChartInstance) revenueChartInstance.destroy();
    revenueChartInstance = new Chart(revenueCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: revenue,
          backgroundColor: 'rgba(34, 197, 94, 0.6)',
          borderColor: '#22c55e',
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: v => '$' + (v/1000).toFixed(0) + 'k' } },
          x: { grid: { display: false }, ticks: { color: '#71717a', font: { size: 10 } } }
        }
      }
    });
  }
  
  // Balance chart
  if (balanceCanvas) {
    if (balanceChartInstance) balanceChartInstance.destroy();
    balanceChartInstance = new Chart(balanceCanvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: avgBal,
          borderColor: '#eab308',
          backgroundColor: 'rgba(234, 179, 8, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointBackgroundColor: '#eab308'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: v => '$' + (v/1000).toFixed(0) + 'k' } },
          x: { grid: { display: false }, ticks: { color: '#71717a', font: { size: 10 } } }
        }
      }
    });
  }
  
  // Render additional cash flow charts
  renderCashflowDetailCharts(months, labels);
}

// Additional Cash Flow Charts
let netCashflowChartInstance = null;
let debtServiceChartInstance = null;

function renderCashflowDetailCharts(months, labels) {
  if (!months || !months.length) return;
  
  const deposits = months.map(m => m.deposits || m.revenue || 0);
  const withdrawals = months.map(m => m.withdrawals || 0);
  const netCashflow = months.map(m => (m.deposits || m.revenue || 0) - (m.withdrawals || 0));
  const debtService = months.map(m => m.debtService || 0);
  
  // Net Cash Flow Bar Chart
  const netCashflowCanvas = document.getElementById('netCashflowChart');
  if (netCashflowCanvas) {
    if (netCashflowChartInstance) netCashflowChartInstance.destroy();
    netCashflowChartInstance = new Chart(netCashflowCanvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: netCashflow,
          backgroundColor: netCashflow.map(v => v >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
          borderColor: netCashflow.map(v => v >= 0 ? '#22c55e' : '#ef4444'),
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: v => (v >= 0 ? '+' : '') + '$' + (v/1000).toFixed(0) + 'k' } },
          x: { grid: { display: false }, ticks: { color: '#71717a', font: { size: 9 } } }
        }
      }
    });
  }
  
  // Debt Service Ratio Chart
  const debtServiceCanvas = document.getElementById('debtServiceChart');
  if (debtServiceCanvas) {
    // Calculate debt service ratio (debt payments / deposits)
    const debtRatio = months.map(m => {
      const dep = m.deposits || m.revenue || 0;
      const debt = m.debtService || 0;
      return dep > 0 ? (debt / dep * 100) : 0;
    });
    
    if (debtServiceChartInstance) debtServiceChartInstance.destroy();
    debtServiceChartInstance = new Chart(debtServiceCanvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: debtRatio,
          borderColor: '#f97316',
          backgroundColor: 'rgba(249, 115, 22, 0.1)',
          fill: true,
          tension: 0.4,
          pointRadius: 3,
          pointBackgroundColor: '#f97316'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { min: 0, max: 100, grid: { color: '#27272a' }, ticks: { color: '#71717a', callback: v => v + '%' } },
          x: { grid: { display: false }, ticks: { color: '#71717a', font: { size: 9 } } }
        }
      }
    });
  }
}

function updateFormationDate(dateStr) {
  if (!currentDeal) return;
  currentDeal.formationDate = dateStr || '';
  currentDeal._fieldSource = currentDeal._fieldSource || {};
  currentDeal._fieldSource.formationDate = 'manual';
  // Auto-update TIB if possible
  if (dateStr) {
    const years = Math.floor((Date.now() - new Date(dateStr).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
    currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
    const tibEl = document.getElementById('editTib');
    if (tibEl) tibEl.value = currentDeal.tib;
  }
  saveDealsToStorage();
  updateProfileCompletenessUI();
}

function renderEntityVerificationCard() {
  const summaryEl = document.getElementById('entityVerifySummary');
  const summaryEl2 = document.getElementById('entityVerifySummary2');
  const sourcesEl = document.getElementById('entityVerifySources');
  const sourcesEl2 = document.getElementById('entityVerifySources2');
  if (!summaryEl) return;

  const e = currentDeal?.entityData;
  if (!e) {
    const msg = 'Run entity verification to enrich the profile.';
    summaryEl.textContent = msg;
    if (summaryEl2) summaryEl2.textContent = 'Enter business name to verify entity.';
    sourcesEl.innerHTML = '';
    if (sourcesEl2) sourcesEl2.innerHTML = '';
    return;
  }

  const conf = Math.round(e.confidence || 0);
  const confColor = conf >= 80 ? 'var(--tier-a)' : conf >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
  const html = `
    <div style="display:flex; justify-content: space-between; align-items: baseline; gap: 12px;">
      <div style="font-weight: 700; color: var(--text-primary);">${e.businessName || e.legal_name || currentDeal.businessName || 'Entity'}</div>
      <div style="font-weight: 800; color: ${confColor};">${conf}%</div>
    </div>
    <div style="margin-top: 6px; color: var(--text-secondary);">
      <span style="color: var(--accent);">${e.stateCode || currentDeal.stateCode || '--'}</span>  ${e.entityType || currentDeal.entityType || '--'}  ${e.status || currentDeal.entityStatus || '--'}
    </div>
    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
      ${e.summary || e.notes || ''}
    </div>
  `;
  summaryEl.innerHTML = html;
  if (summaryEl2) summaryEl2.innerHTML = html;

  const sources = (e.sources || []).slice(0, 4);
  const sourcesHtml = sources.length
    ? sources.map(s => `<a href="${s.url}" target="_blank" rel="noopener noreferrer"> ${s.title || s.url}</a>`).join('<br>')
    : '';
  sourcesEl.innerHTML = sourcesHtml;
  if (sourcesEl2) sourcesEl2.innerHTML = sourcesHtml;
}

function renderBankSummaryCard() {
  const el = document.getElementById('bankSummaryBody');
  if (!el) return;
  const b = currentDeal?.bankData;
  if (!b) {
    el.textContent = 'No statements processed yet.';
    return;
  }

  const bankName = b.bank?.bankName || 'Bank';
  const acct = b.bank?.accountType ? `${b.bank.accountType}` : 'Account';
  const last4 = b.bank?.accountLast4 ? ` ${b.bank.accountLast4}` : '';
  const period = (b.statement?.startDate || b.statement?.endDate) ? `${b.statement.startDate || ''}  ${b.statement.endDate || ''}` : '';
  const conf = Math.round(b.confidence || 0);
  const confColor = conf >= 80 ? 'var(--tier-a)' : conf >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
  const warnings = Array.isArray(b.warnings) ? b.warnings : [];

  el.innerHTML = `
    <div style="display:flex; justify-content: space-between; align-items: baseline; gap: 12px;">
      <div style="font-weight: 700; color: var(--text-primary);">${bankName}</div>
      <div style="font-weight: 800; color: ${confColor};">${conf}%</div>
    </div>
    <div style="margin-top: 6px; color: var(--text-secondary);">
      ${acct} ${last4 ? ' ' + last4 : ''}<br>
      <span style="color: var(--text-muted); font-size: 0.8rem;">Statement period:</span> ${period}
    </div>
    ${warnings.length ? `<div style="margin-top: 10px; padding: 10px 12px; background: rgba(234,179,8,0.08); border: 1px solid rgba(234,179,8,0.2); border-radius: 10px; color: var(--text-secondary); font-size: 0.8rem;"><strong style="color: var(--tier-d);">Warnings:</strong><br>${warnings.slice(0,3).map(w => ` ${w}`).join('<br>')}</div>` : ''}
  `;
}

function renderDeepResearchCard() {
  const research = currentDeal?.deepResearch;
  
  // Update badge
  const badge = document.getElementById('badgeResearch');
  if (badge) {
    if (research?.risk?.rating) {
      badge.textContent = research.risk.rating;
      document.getElementById('tabResearch').classList.add('has-data');
      if (research.risk.rating === 'High') {
        document.getElementById('tabResearch').classList.add('has-warning');
      }
    } else {
      badge.textContent = '--';
    }
  }
  
  if (!research) {
    return;
  }
  
  // Risk Rating
  const riskRating = research.risk?.rating || 'Unknown';
  const riskColors = {
    'Low': { bg: 'rgba(34, 197, 94, 0.15)', border: 'rgba(34, 197, 94, 0.4)', text: 'var(--tier-a)' },
    'Medium': { bg: 'rgba(234, 179, 8, 0.15)', border: 'rgba(234, 179, 8, 0.4)', text: 'var(--tier-c)' },
    'High': { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.4)', text: 'var(--tier-e)' }
  };
  const riskStyle = riskColors[riskRating] || { bg: 'var(--bg-secondary)', border: 'var(--border-primary)', text: 'var(--text-muted)' };
  
  const banner = document.getElementById('researchRiskBanner');
  if (banner) {
    banner.style.background = riskStyle.bg;
    banner.style.border = `1px solid ${riskStyle.border}`;
  }
  
  const badgeEl = document.getElementById('researchRiskBadge');
  if (badgeEl) badgeEl.style.background = riskStyle.bg;
  
  const letterEl = document.getElementById('researchRiskLetter');
  if (letterEl) {
    letterEl.style.color = riskStyle.text;
    letterEl.textContent = riskRating[0] || '?';
  }
  
  const labelEl = document.getElementById('researchRiskLabel');
  if (labelEl) {
    labelEl.style.color = riskStyle.text;
    labelEl.textContent = riskRating;
  }
  
  const confEl = document.getElementById('researchConfidence');
  if (confEl) confEl.textContent = `Confidence: ${research.confidence || 0}%`;
  
  // Company Overview
  const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  setEl('researchLegalName', research.overview?.legal_name || 'N/A');
  setEl('researchDba', research.overview?.dba || 'N/A');
  setEl('researchEntityType', research.overview?.entity_type || 'N/A');
  setEl('researchState', research.overview?.state || 'N/A');
  setEl('researchFormation', research.overview?.formation_date || 'N/A');
  
  const statusEl = document.getElementById('researchStatus');
  const status = research.overview?.status || 'N/A';
  if (statusEl) {
    statusEl.textContent = status;
    statusEl.style.color = status.toLowerCase().includes('active') ? 'var(--tier-a)' : (status === 'N/A' ? '' : 'var(--tier-e)');
  }
  
  // Operations
  setEl('researchIndustry', research.operations?.industry || 'N/A');
  setEl('researchNaics', research.operations?.naics || 'N/A');
  setEl('researchDescription', research.operations?.description || '');
  
  // Financials
  setEl('researchRevenue', research.financials?.revenue_estimate || 'N/A');
  setEl('researchEmployees', research.financials?.employee_count || 'N/A');
  setEl('researchYears', research.financials?.years_in_business || 'N/A');
  setEl('researchTrend', research.financials?.growth_trend || 'N/A');
  
  // Red Flags
  const redFlags = research.risk?.red_flags || [];
  const redFlagsSection = document.getElementById('researchRedFlagsSection');
  if (redFlags.length > 0) {
    redFlagsSection.style.display = 'block';
    document.getElementById('researchRedFlagCount').textContent = redFlags.length;
    document.getElementById('researchRedFlagsList').innerHTML = redFlags.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('');
  } else {
    redFlagsSection.style.display = 'none';
  }
  
  // Compliance
  const lawsuits = research.compliance?.lawsuits?.length || 0;
  const liens = research.compliance?.liens?.length || 0;
  const ucc = research.compliance?.ucc_filings?.length || 0;
  
  const lawsuitsEl = document.getElementById('researchLawsuits');
  lawsuitsEl.textContent = `${lawsuits} Found`;
  lawsuitsEl.style.color = lawsuits > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const liensEl = document.getElementById('researchLiens');
  liensEl.textContent = `${liens} Found`;
  liensEl.style.color = liens > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  document.getElementById('researchUcc').textContent = `${ucc} Found`;
  
  // Reputation
  document.getElementById('researchBbb').textContent = research.reputation?.bbb_rating || 'N/A';
  const reviewScore = research.reputation?.review_score || 'N/A';
  const reviewCount = research.reputation?.review_count || 0;
  document.getElementById('researchReviews').textContent = reviewCount > 0 ? `${reviewScore} (${reviewCount} reviews)` : reviewScore;
  
  // Summary
  document.getElementById('researchSummary').textContent = research.summary || 'No summary available.';
  
  // Sources
  const sources = research.sources || [];
  document.getElementById('researchSourceCount').textContent = sources.length;
  document.getElementById('researchSourcesList').innerHTML = sources.slice(0, 5).map(s => 
    `<a href="${s.url}" target="_blank" style="color: var(--accent); text-decoration: none;">${s.title || 'Source'}</a>`
  ).join(' | ');
}

function switchIntelTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.intel-tab').forEach(tab => tab.classList.remove('active'));
  const activeTab = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  if (activeTab) activeTab.classList.add('active');
  
  // Update panels
  document.querySelectorAll('.intel-panel').forEach(panel => panel.classList.remove('active'));
  const activePanel = document.getElementById('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  if (activePanel) activePanel.classList.add('active');
}

function updateIntelBadges() {
  // Business badge - show completion status
  const badgeBusiness = document.getElementById('badgeBusiness');
  if (badgeBusiness) {
    const fields = ['businessName', 'dba', 'industry', 'address', 'stateCode', 'entityType', 'ownerName', 'fico'];
    const filled = fields.filter(f => currentDeal?.[f]).length;
    const pct = Math.round((filled / fields.length) * 100);
    badgeBusiness.textContent = pct + '%';
    if (pct > 50) document.getElementById('tabBusiness')?.classList.add('has-data');
  }
  
  // Research badge
  const research = currentDeal?.deepResearch;
  const badgeResearch = document.getElementById('badgeResearch');
  if (badgeResearch) {
    if (research?.risk?.rating) {
      badgeResearch.textContent = research.risk.rating;
      document.getElementById('tabResearch')?.classList.add('has-data');
      if (research.risk.rating === 'High') {
        document.getElementById('tabResearch')?.classList.add('has-warning');
      }
    } else {
      badgeResearch.textContent = '--';
    }
  }
  
  // BACKGROUND badge
  const clearReport = currentDeal?.clearReport;
  const badgeClear = document.getElementById('badgeClear');
  if (badgeClear) {
    if (clearReport) {
      const totalRecords = (clearReport.ucc_filings?.length || 0) + 
                          (clearReport.liens?.length || 0) + 
                          (clearReport.judgments?.length || 0) +
                          (clearReport.court_records?.length || 0) +
                          (clearReport.bankruptcies?.length || 0);
      badgeClear.textContent = totalRecords + ' records';
      document.getElementById('tabClear')?.classList.add('has-data');
      if (totalRecords > 0) {
        document.getElementById('tabClear')?.classList.add('has-warning');
      }
    } else {
      badgeClear.textContent = '--';
    }
  }
  
  // Footprint badge
  const footprint = currentDeal?.footprintReport;
  const badgeFootprint = document.getElementById('badgeFootprint');
  if (badgeFootprint) {
    if (footprint) {
      const socialCount = footprint.social_media?.length || 0;
      badgeFootprint.textContent = socialCount + ' profiles';
      document.getElementById('tabFootprint')?.classList.add('has-data');
    } else {
      badgeFootprint.textContent = '--';
    }
  }
  
  // Debt badge
  const debt = currentDeal?.debtReport;
  const badgeDebt = document.getElementById('badgeDebt');
  if (badgeDebt) {
    if (debt) {
      const positions = debt.active_positions || 0;
      badgeDebt.textContent = positions + ' positions';
      document.getElementById('tabDebt')?.classList.add('has-data');
      if (positions > 0) {
        document.getElementById('tabDebt')?.classList.add('has-warning');
      }
    } else {
      badgeDebt.textContent = '--';
    }
  }
  
  // Credit badge
  const credit = currentDeal?.credit_report;
  const badgeCredit = document.getElementById('badgeCredit');
  if (badgeCredit) {
    // Clear previous classes
    const tabCredit = document.getElementById('tabCredit');
    tabCredit?.classList.remove('has-data', 'has-caution', 'has-warning');
    
    if (credit) {
      const score = credit.scores?.fico || credit.scores?.vantage || credit.scores?.experian || credit.scores?.equifax || credit.scores?.transunion;
      const isNotScored = credit.scores?.score_status === 'not_scored';
      const inquiryCount = credit.inquiries?.recent_inquiries?.length || credit.inquiries?.hard_inquiries_24mo || 0;
      const tradelineCount = credit.tradelines?.length || 0;
      
      if (score) {
        badgeCredit.textContent = score;
        // Color based on FICO score: 600+ green, 550-599 orange, <550 red
        if (score >= 600) {
          tabCredit?.classList.add('has-data'); // Green
        } else if (score >= 550) {
          tabCredit?.classList.add('has-caution'); // Orange
        } else {
          tabCredit?.classList.add('has-warning'); // Red
        }
      } else if (isNotScored) {
        badgeCredit.textContent = 'N/S';
        tabCredit?.classList.add('has-warning'); // Red for not scored
      } else if (inquiryCount > 0 || tradelineCount > 0 || credit.bureau) {
        badgeCredit.textContent = inquiryCount > 0 ? `${inquiryCount} inq` : (tradelineCount > 0 ? `${tradelineCount} accts` : 'Data');
        tabCredit?.classList.add('has-data');
      } else {
        badgeCredit.textContent = '--';
      }
    } else {
      badgeCredit.textContent = '--';
    }
  }
  
  // Also update scrub status indicators
  updateScrubStatus();
}

// Update scrub status indicators in right panel
function updateScrubStatus() {
  if (!currentDeal) return;
  
  const setStatus = (id, status) => {
    const el = document.getElementById(id);
    if (el) el.dataset.status = status;
  };
  
  // Extraction status - based on whether we have bank data
  if (activeSearches.has('Document Extraction')) {
    setStatus('scrubExtraction', 'loading');
  } else if (currentDeal.months?.length > 0 || currentDeal.credit_report) {
    setStatus('scrubExtraction', 'complete');
  } else {
    setStatus('scrubExtraction', 'pending');
  }
  
  // Entity status
  if (activeSearches.has('Entity Verification') || document.getElementById('tabBusiness')?.classList.contains('loading')) {
    setStatus('scrubEntity', 'loading');
  } else if (currentDeal.entityData || currentDeal.entityReport) {
    setStatus('scrubEntity', 'complete');
  } else {
    setStatus('scrubEntity', 'pending');
  }
  
  // Research status
  if (activeSearches.has('Deep Research') || document.getElementById('tabResearch')?.classList.contains('loading')) {
    setStatus('scrubResearch', 'loading');
  } else if (currentDeal.deepResearch) {
    setStatus('scrubResearch', currentDeal.deepResearch.risk?.rating === 'HIGH' ? 'warning' : 'complete');
  } else {
    setStatus('scrubResearch', 'pending');
  }
  
  // Background status
  if (activeSearches.has('Background Check') || document.getElementById('tabClear')?.classList.contains('loading')) {
    setStatus('scrubBackground', 'loading');
  } else if (currentDeal.clearReport) {
    const hasRecords = (currentDeal.clearReport.ucc_filings?.length || 0) + 
                       (currentDeal.clearReport.liens?.length || 0) + 
                       (currentDeal.clearReport.judgments?.length || 0) > 0;
    setStatus('scrubBackground', hasRecords ? 'warning' : 'complete');
  } else {
    setStatus('scrubBackground', 'pending');
  }
  
  // Footprint status
  if (activeSearches.has('Digital Footprint') || document.getElementById('tabFootprint')?.classList.contains('loading')) {
    setStatus('scrubFootprint', 'loading');
  } else if (currentDeal.footprintReport) {
    setStatus('scrubFootprint', 'complete');
  } else {
    setStatus('scrubFootprint', 'pending');
  }
  
  // Debt status
  if (activeSearches.has('Debt Analysis') || document.getElementById('tabDebt')?.classList.contains('loading')) {
    setStatus('scrubDebt', 'loading');
  } else if (currentDeal.debtReport) {
    const positions = currentDeal.debtReport.active_positions || 0;
    setStatus('scrubDebt', positions > 0 ? 'warning' : 'complete');
  } else {
    setStatus('scrubDebt', 'pending');
  }
}

function openEntityForCurrentDeal() {
  if (!currentDeal?.entityData) { alert('No entity data yet. Click Refresh first.'); return; }
  renderEntityResults(currentDeal.entityData, currentDeal.businessName || '');
  document.getElementById('entityModal').classList.add('active');
}

function getGeminiApiKey() {
  return (localStorage.getItem('greatdane_api_key') || '').trim();
}

function getGeminiModel() {
  return (localStorage.getItem('greatdane_model') || 'gemini-2.5-flash').trim();
}

// AI Command Center Functions
let aiGeneratedChartInstance = null;

function runAICommandWith(query) {
  document.getElementById('aiCommandInput').value = query;
  runAICommand();
}

function closeAIResponse() {
  document.getElementById('aiResponseArea').style.display = 'none';
  if (aiGeneratedChartInstance) {
    aiGeneratedChartInstance.destroy();
    aiGeneratedChartInstance = null;
  }
}

async function runAICommand() {
  const input = document.getElementById('aiCommandInput');
  const query = input.value.trim();
  
  if (!query) {
    showToast('Error', 'Please enter a question or command.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    showToast('Error', 'Please set your Gemini API key in Settings.');
    return;
  }
  
  // Show response area with loading
  const responseArea = document.getElementById('aiResponseArea');
  const loadingEl = document.getElementById('aiResponseLoading');
  const contentEl = document.getElementById('aiResponseContent');
  const btn = document.getElementById('aiCommandBtn');
  
  responseArea.style.display = 'block';
  loadingEl.style.display = 'block';
  contentEl.style.display = 'none';
  document.getElementById('aiResponseQuery').textContent = `"${query}"`;
  
  btn.disabled = true;
  btn.innerHTML = '<div style="width: 18px; height: 18px; border: 2px solid rgba(0,0,0,0.3); border-top-color: #000; border-radius: 50%; animation: spin 1s linear infinite;"></div> Thinking...';
  
  // Gather current metrics data
  const metricsData = gatherDashboardMetrics();
  
  const prompt = `You are an AI assistant for a business underwriting platform called GREATDANE. You analyze deals and metrics for merchant cash advance underwriting.

CURRENT DASHBOARD DATA:
${JSON.stringify(metricsData, null, 2)}

USER QUERY: "${query}"

Analyze the data and respond to the user's query. If they ask for a chart, provide chart configuration.

IMPORTANT: Respond with a JSON object in this exact format:
{
  "answer": "Your detailed text response here explaining the analysis",
  "chart": null or {
    "type": "pie|bar|line|doughnut",
    "title": "Chart title",
    "labels": ["Label1", "Label2", ...],
    "data": [number1, number2, ...],
    "colors": ["#22c55e", "#84cc16", "#eab308", "#f97316", "#ef4444"]
  },
  "insights": [
    {"label": "Key Metric 1", "value": "Value", "trend": "up|down|neutral"},
    {"label": "Key Metric 2", "value": "Value", "trend": "up|down|neutral"}
  ],
  "actions": ["Suggested action 1", "Suggested action 2"]
}

If no chart is needed, set chart to null. Always provide a helpful answer.
If asked about score distribution, use tiers: A (750+), B (650-749), C (550-649), D (450-549), E (<450).
Use the actual data provided above to generate accurate responses and charts.`;

  try {
    const model = getGeminiModel();
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.4 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) {
      // If no JSON, show raw response
      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';
      document.getElementById('aiResponseText').textContent = text || 'No response received.';
      document.getElementById('aiResponseChart').style.display = 'none';
      document.getElementById('aiResponseInsights').style.display = 'none';
    } else {
      renderAIResponse(parsed);
    }
    
  } catch (err) {
    console.error('AI Command failed:', err);
    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';
    document.getElementById('aiResponseText').innerHTML = `<span style="color: var(--tier-e);">Error: ${err.message}</span>`;
    document.getElementById('aiResponseChart').style.display = 'none';
    document.getElementById('aiResponseInsights').style.display = 'none';
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Ask AI';
  }
}

function gatherDashboardMetrics() {
  // Gather all deals data
  const deals = JSON.parse(localStorage.getItem('greatdane_deals') || '[]');
  
  // Calculate metrics
  let totalRevenue = 0;
  let totalScore = 0;
  let scoreCount = 0;
  let approvedCount = 0;
  let highRiskCount = 0;
  const scoreTiers = { A: 0, B: 0, C: 0, D: 0, E: 0 };
  const industries = {};
  const monthlyDeals = {};
  
  deals.forEach(deal => {
    // Revenue
    if (deal.avgMonthlyRevenue) {
      const rev = parseFloat(String(deal.avgMonthlyRevenue).replace(/[$,]/g, '')) || 0;
      totalRevenue += rev;
    }
    
    // Scores
    if (deal.score && deal.score > 0) {
      totalScore += deal.score;
      scoreCount++;
      
      // Tier distribution
      if (deal.score >= 750) scoreTiers.A++;
      else if (deal.score >= 650) scoreTiers.B++;
      else if (deal.score >= 550) scoreTiers.C++;
      else if (deal.score >= 450) scoreTiers.D++;
      else scoreTiers.E++;
      
      // High risk
      if (deal.score < 550) highRiskCount++;
    }
    
    // Status
    if (deal.status === 'approved') approvedCount++;
    
    // Industries
    const ind = deal.industry || 'Unknown';
    industries[ind] = (industries[ind] || 0) + 1;
    
    // Monthly tracking
    const month = deal.created ? new Date(deal.created).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) : 'Unknown';
    monthlyDeals[month] = (monthlyDeals[month] || 0) + 1;
  });
  
  return {
    totalDeals: deals.length,
    totalRevenue: totalRevenue,
    avgRevenue: deals.length > 0 ? Math.round(totalRevenue / deals.length) : 0,
    avgScore: scoreCount > 0 ? Math.round(totalScore / scoreCount) : 0,
    approvalRate: deals.length > 0 ? Math.round((approvedCount / deals.length) * 100) : 0,
    highRiskCount: highRiskCount,
    scoreTiers: scoreTiers,
    industries: industries,
    monthlyDeals: monthlyDeals,
    deals: deals.map(d => ({
      name: d.businessName,
      score: d.score,
      revenue: d.avgMonthlyRevenue,
      industry: d.industry,
      status: d.status,
      fico: d.fico
    }))
  };
}

function renderAIResponse(response) {
  const loadingEl = document.getElementById('aiResponseLoading');
  const contentEl = document.getElementById('aiResponseContent');
  const textEl = document.getElementById('aiResponseText');
  const chartEl = document.getElementById('aiResponseChart');
  const insightsEl = document.getElementById('aiResponseInsights');
  
  loadingEl.style.display = 'none';
  contentEl.style.display = 'block';
  
  // Render answer text
  textEl.innerHTML = response.answer || 'No answer provided.';
  
  // Render chart if provided
  if (response.chart && response.chart.type) {
    chartEl.style.display = 'block';
    
    // Destroy previous chart
    if (aiGeneratedChartInstance) {
      aiGeneratedChartInstance.destroy();
    }
    
    const ctx = document.getElementById('aiGeneratedChart').getContext('2d');
    const chartConfig = {
      type: response.chart.type,
      data: {
        labels: response.chart.labels || [],
        datasets: [{
          data: response.chart.data || [],
          backgroundColor: response.chart.colors || ['#22c55e', '#84cc16', '#eab308', '#f97316', '#ef4444'],
          borderColor: response.chart.type === 'line' ? '#eab308' : 'transparent',
          borderWidth: response.chart.type === 'line' ? 3 : 0,
          tension: 0.4,
          fill: response.chart.type === 'line'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: response.chart.type === 'pie' || response.chart.type === 'doughnut' ? 'right' : 'top',
            labels: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary').trim() }
          },
          title: {
            display: true,
            text: response.chart.title || 'Chart',
            color: getComputedStyle(document.body).getPropertyValue('--text-primary').trim(),
            font: { size: 14, weight: '600' }
          }
        },
        scales: response.chart.type === 'pie' || response.chart.type === 'doughnut' ? {} : {
          x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted').trim() }, grid: { color: 'rgba(255,255,255,0.05)' } },
          y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-muted').trim() }, grid: { color: 'rgba(255,255,255,0.05)' } }
        }
      }
    };
    
    aiGeneratedChartInstance = new Chart(ctx, chartConfig);
  } else {
    chartEl.style.display = 'none';
  }
  
  // Render insights if provided
  if (response.insights && response.insights.length > 0) {
    insightsEl.style.display = 'block';
    insightsEl.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 16px;">
        ${response.insights.map(i => `
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 10px; text-align: center;">
            <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">${i.label}</div>
            <div style="font-size: 1.1rem; font-weight: 700; color: ${i.trend === 'up' ? 'var(--tier-a)' : i.trend === 'down' ? 'var(--tier-e)' : 'var(--text-primary)'};">${i.value}</div>
          </div>
        `).join('')}
      </div>
    `;
    
    // Add actions if provided
    if (response.actions && response.actions.length > 0) {
      insightsEl.innerHTML += `
        <div style="padding: 12px; background: rgba(234, 179, 8, 0.1); border-radius: 10px; border-left: 3px solid var(--accent);">
          <div style="font-size: 0.75rem; font-weight: 600; color: var(--accent); margin-bottom: 8px;"> Recommended Actions</div>
          <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);">
            ${response.actions.map(a => `<li style="margin-bottom: 4px;">${a}</li>`).join('')}
          </ul>
        </div>
      `;
    }
  } else {
    insightsEl.style.display = 'none';
  }
}

function safeJsonFromText(text) {
  const t = String(text || '');
  
  // Try to find JSON in different formats
  // 1. Try full JSON object match
  let m = t.match(/\{[\s\S]*\}/);
  if (!m) {
    // 2. Try after markdown code block
    const codeMatch = t.match(/```(?:json)?\s*([\s\S]*?)```/);
    if (codeMatch) {
      m = codeMatch[1].match(/\{[\s\S]*\}/);
    }
  }
  
  if (!m) return null;
  
  let raw = m[0]
    .replace(/```json/g, '')
    .replace(/```/g, '')
    .replace(/\u201c|\u201d/g, '"')
    .replace(/\u2018|\u2019/g, "'")
    .replace(/[\x00-\x1F\x7F]/g, ' ') // Remove control characters
    .trim();
  
  // Try multiple parse strategies
  try { 
    return JSON.parse(raw); 
  } catch (e1) {
    // Try fixing common issues
    try {
      // Fix trailing commas
      raw = raw.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
      return JSON.parse(raw);
    } catch (e2) {
      // Try stripping everything before first { and after last }
      try {
        const firstBrace = raw.indexOf('{');
        const lastBrace = raw.lastIndexOf('}');
        if (firstBrace >= 0 && lastBrace > firstBrace) {
          const cleaned = raw.substring(firstBrace, lastBrace + 1);
          return JSON.parse(cleaned);
        }
      } catch (e3) {
        console.warn('JSON parse attempts failed:', e3);
      }
    }
    return null;
  }
}

// Streaming API helper for real-time updates
async function streamGeminiAPI(prompt, options = {}) {
  const apiKey = getGeminiApiKey();
  const model = getGeminiModel();
  const { 
    onChunk = null,       // Callback for each text chunk
    useGoogleSearch = true,
    temperature = 0.2
  } = options;
  
  const requestBody = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { temperature }
  };
  
  if (useGoogleSearch) {
    requestBody.tools = [{ google_search: {} }];
  }
  
  const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?alt=sse&key=${apiKey}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestBody)
  });

  if (!res.ok) {
    throw new Error(`API error: ${res.status}`);
  }

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let fullText = '';
  
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value, { stream: true });
    const lines = chunk.split('\n');
    
    for (const line of lines) {
      if (line.startsWith('data: ')) {
        try {
          const jsonStr = line.slice(6);
          if (jsonStr.trim() === '[DONE]') continue;
          const data = JSON.parse(jsonStr);
          const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
          if (text) {
            fullText += text;
            if (onChunk) onChunk(fullText);
          }
        } catch (e) {
          // Skip invalid JSON chunks
        }
      }
    }
  }
  
  return fullText;
}

function rankEntityCandidates(inputName, candidates) {
  const input = String(inputName || '').trim();
  const list = Array.isArray(candidates) ? candidates : [];
  const ranked = list.map((c, idx) => {
    const name = c.legal_name || c.businessName || c.name || '';
    const tier = matchTier(input, name);
    const conf = Number(c.confidence || 0);
    const src = Array.isArray(c.sources) ? c.sources.length : 0;
    return { ...c, _idx: idx, _tier: tier, _conf: conf, _src: src, _name: name };
  }).sort((a, b) => (a._tier - b._tier) || (b._conf - a._conf) || (b._src - a._src));
  return ranked;
}

async function refreshEntityVerification() {
  const apiKey = getGeminiApiKey();
  if (!apiKey) { alert('Enter your Gemini API key first (Settings).'); return; }
  if (!currentDeal?.businessName) { alert('No business name set for this deal.'); return; }
  await searchAndFillEntity(currentDeal.businessName, apiKey);
}

// ============================================
// DEEP RESEARCH FUNCTIONS (Direct Gemini API)
// ============================================

async function runDeepResearch() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Researching: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Deep Research in Progress</p>
      <p style="color: var(--text-muted);">Using Gemini + Google Search to analyze business background...</p>
    </div>
    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid var(--accent);">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <div style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
        <span style="font-size: 0.75rem; color: var(--accent); text-transform: uppercase; font-weight: 600;">Live Feed</span>
      </div>
      <div id="deepResearchStream" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', monospace; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; line-height: 1.5;">Connecting...</div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
  `;
  modal.classList.add('active');
  
  try {
    const prompt = buildDeepResearchPrompt(currentDeal.businessName);
    const streamEl = document.getElementById('deepResearchStream');

    // Use streaming API
    const fullText = await streamGeminiAPI(prompt, {
      onChunk: (text) => {
        if (streamEl) {
          const display = text.slice(-500).replace(/```json|```/g, '');
          streamEl.textContent = display;
          streamEl.scrollTop = streamEl.scrollHeight;
        }
      },
      useGoogleSearch: true
    });

    const parsed = safeJsonFromText(fullText);
    
    if (!parsed) throw new Error('Failed to parse research results');
    
    currentDeal.deepResearch = parsed;
    saveDealsToStorage();
    
    // Update main card on detail view
    renderDeepResearchCard();
    updateIntelBadges();
    
    // Close modal and show success
    closeDeepResearchModal();
    showToast('Deep Research Complete', parsed.risk?.rating ? `Risk: ${parsed.risk.rating}` : 'Data applied');
    
  } catch (err) {
    console.error('Deep research failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Research Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function renderDeepResearchResults(research) {
  const body = document.getElementById('deepResearchBody');
  
  const riskColor = {
    'Low': 'var(--tier-a)',
    'Medium': 'var(--tier-c)',
    'High': 'var(--tier-e)'
  }[research.risk?.rating] || 'var(--text-muted)';
  
  body.innerHTML = `
    <div style="display: grid; gap: 20px;">
      <!-- Risk Summary Banner -->
      <div style="background: linear-gradient(135deg, ${riskColor}22, ${riskColor}11); border: 1px solid ${riskColor}44; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px;">
        <div style="width: 60px; height: 60px; background: ${riskColor}33; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <span style="font-size: 1.5rem; font-weight: 800; color: ${riskColor};">${research.risk?.rating?.[0] || '?'}</span>
        </div>
        <div>
          <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em;">Risk Rating</div>
          <div style="font-size: 1.25rem; font-weight: 700; color: ${riskColor};">${research.risk?.rating || 'Unknown'}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">Confidence: ${research.confidence || 0}%</div>
        </div>
      </div>
      
      <!-- Overview -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Company Overview
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 0.85rem;">
          <div><span style="color: var(--text-muted);">Legal Name:</span> ${research.overview?.legal_name || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">DBA:</span> ${research.overview?.dba || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">Entity Type:</span> ${research.overview?.entity_type || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">State:</span> ${research.overview?.state || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">Formation:</span> ${research.overview?.formation_date || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">Status:</span> <span style="color: ${research.overview?.status?.toLowerCase().includes('active') ? 'var(--tier-a)' : 'var(--tier-e)'};">${research.overview?.status || 'N/A'}</span></div>
        </div>
      </div>
      
      <!-- Operations & Financials -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            Operations
          </div>
          <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
            <div><span style="color: var(--text-muted);">Industry:</span> ${research.operations?.industry || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">NAICS:</span> ${research.operations?.naics || 'N/A'}</div>
            <div style="color: var(--text-secondary);">${research.operations?.description || ''}</div>
          </div>
        </div>
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Financials
          </div>
          <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
            <div><span style="color: var(--text-muted);">Revenue Est:</span> ${research.financials?.revenue_estimate || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">Employees:</span> ${research.financials?.employee_count || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">Years in Business:</span> ${research.financials?.years_in_business || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">Trend:</span> ${research.financials?.growth_trend || 'N/A'}</div>
          </div>
        </div>
      </div>
      
      <!-- Red Flags -->
      ${research.risk?.red_flags?.length ? `
      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Red Flags (${research.risk.red_flags.length})
        </div>
        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);">
          ${research.risk.red_flags.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('')}
        </ul>
      </div>
      ` : ''}
      
      <!-- Compliance -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Compliance & Legal
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 0.85rem;">
          <div>
            <div style="color: var(--text-muted); margin-bottom: 4px;">Lawsuits</div>
            <div style="color: ${research.compliance?.lawsuits?.length ? 'var(--tier-e)' : 'var(--tier-a)'}; font-weight: 600;">${research.compliance?.lawsuits?.length || 0} Found</div>
          </div>
          <div>
            <div style="color: var(--text-muted); margin-bottom: 4px;">Liens</div>
            <div style="color: ${research.compliance?.liens?.length ? 'var(--tier-e)' : 'var(--tier-a)'}; font-weight: 600;">${research.compliance?.liens?.length || 0} Found</div>
          </div>
          <div>
            <div style="color: var(--text-muted); margin-bottom: 4px;">UCC Filings</div>
            <div style="font-weight: 600;">${research.compliance?.ucc_filings?.length || 0} Found</div>
          </div>
        </div>
      </div>
      
      <!-- Reputation -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Reputation
        </div>
        <div style="display: flex; gap: 24px; font-size: 0.85rem;">
          <div>
            <div style="color: var(--text-muted);">BBB Rating:</div>
            <div style="font-weight: 600; font-size: 1.1rem;">${research.reputation?.bbb_rating || 'N/A'}</div>
          </div>
          <div>
            <div style="color: var(--text-muted);">Reviews:</div>
            <div style="font-weight: 600;">${research.reputation?.review_score || 'N/A'} (${research.reputation?.review_count || 0} reviews)</div>
          </div>
        </div>
      </div>
      
      <!-- Summary -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px;">Summary</div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">${research.summary || 'No summary available.'}</p>
      </div>
      
      <!-- Sources -->
      ${research.sources?.length ? `
      <div style="font-size: 0.8rem; color: var(--text-muted);">
        <div style="font-weight: 600; margin-bottom: 8px;">Sources (${research.sources.length})</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${research.sources.slice(0, 5).map(s => `<a href="${s.url}" target="_blank" style="color: var(--accent); text-decoration: none;">${s.title || 'Source'}</a>`).join(' | ')}
        </div>
      </div>
      ` : ''}
      
      <!-- Apply to Deal Button -->
      <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="applyResearchToDeal()">
        Apply Research to Deal
      </button>
    </div>
  `;
  
  // Store research for apply function
  window._lastDeepResearch = research;
}

function applyResearchToDeal() {
  const research = window._lastDeepResearch;
  if (!currentDeal || !research) return;
  
  // Update deal with research data
  if (research.overview?.legal_name) currentDeal.businessName = research.overview.legal_name;
  if (research.overview?.dba) currentDeal.dba = research.overview.dba;
  if (research.overview?.entity_type) currentDeal.entityType = research.overview.entity_type;
  if (research.overview?.state) currentDeal.stateCode = research.overview.state;
  if (research.overview?.formation_date) currentDeal.formationDate = research.overview.formation_date;
  if (research.overview?.status) currentDeal.entityStatus = research.overview.status;
  if (research.overview?.address) currentDeal.address = research.overview.address;
  if (research.operations?.industry) currentDeal.industry = research.operations.industry;
  
  // Store research data
  currentDeal.deepResearch = research;
  
  saveDealsToStorage();
  renderDealDetail();
  closeDeepResearchModal();
  
  alert('Research data applied to deal successfully!');
}

function closeDeepResearchModal() {
  document.getElementById('deepResearchModal').classList.remove('active');
}

// ===============================
// BACKGROUND CHECK
// ===============================
async function runClearReport() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Background Check: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--tier-a); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Background Check in Progress</p>
      <p style="color: var(--text-muted);">Searching UCC filings, liens, judgments, court records...</p>
    </div>
    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid var(--tier-a);">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <div style="width: 8px; height: 8px; background: var(--tier-a); border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
        <span style="font-size: 0.75rem; color: var(--tier-a); text-transform: uppercase; font-weight: 600;">Live Feed</span>
      </div>
      <div id="clearReportStream" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', monospace; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; line-height: 1.5;">Connecting...</div>
    </div>
  `;
  modal.classList.add('active');
  
  const ownerName = currentDeal.ownerName || currentDeal.principalName || '';
  const prompt = buildClearReportPrompt(currentDeal.businessName, ownerName);
  
  try {
    const streamEl = document.getElementById('clearReportStream');
    
    // Use streaming API
    const fullText = await streamGeminiAPI(prompt, {
      onChunk: (text) => {
        if (streamEl) {
          const display = text.slice(-500).replace(/```json|```/g, '');
          streamEl.textContent = display;
          streamEl.scrollTop = streamEl.scrollHeight;
        }
      },
      useGoogleSearch: true
    });
    
    const parsed = safeJsonFromText(fullText);
    
    if (!parsed) throw new Error('Failed to parse background check results');
    
    currentDeal.clearReport = parsed;
    saveDealsToStorage();
    renderClearReportSection(parsed);
    closeDeepResearchModal();
    showToast('Background Check Complete', `Found ${(parsed.ucc_filings?.length || 0) + (parsed.liens?.length || 0)} records`);
    
  } catch (err) {
    console.error('Background check failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Background Check Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function buildClearReportPrompt(businessName, ownerName) {
  return `You are a public records investigator conducting a background check on a business.

BUSINESS: "${businessName}"
${ownerName ? `OWNER/PRINCIPAL: "${ownerName}"` : ''}
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.address ? `ADDRESS: ${currentDeal.address}` : ''}

Search for and compile information on:
1. UCC FILINGS - All secured transactions, creditors, collateral types, filing dates, status
2. LIENS - Federal/state tax liens, mechanics liens, judgment liens
3. JUDGMENTS - Civil judgments, amounts, plaintiffs, dates
4. COURT RECORDS - Lawsuits, case types, parties, status, outcomes
5. BANKRUPTCIES - Any bankruptcy filings for business or owner
6. OWNER BACKGROUND - Criminal records, other business associations, address history

IMPORTANT: You MUST respond with ONLY valid JSON. No explanatory text before or after. Start directly with { and end with }.

{
  "ucc_filings": [{"filing_number": "string", "creditor": "string", "collateral": "string", "filed_date": "string", "status": "Active/Terminated", "original_amount": "string"}],
  "liens": [{"type": "Federal Tax/State Tax/Mechanics/Other", "creditor": "string", "amount": "$X", "filed_date": "string", "status": "string"}],
  "judgments": [{"case_number": "string", "plaintiff": "string", "amount": "$X", "date": "string", "court": "string", "status": "string"}],
  "court_records": [{"case_number": "string", "case_type": "string", "parties": "string", "filed_date": "string", "status": "string", "outcome": "string"}],
  "bankruptcies": [{"case_number": "string", "chapter": "7/11/13", "filed_date": "string", "status": "string", "court": "string"}],
  "owner_background": {
    "criminal_records": ["string array or empty"],
    "other_businesses": ["string array of other business names"],
    "address_history": ["string array"],
    "notes": "string with any other relevant findings"
  },
  "summary": "Brief summary of findings",
  "risk_level": "Low/Medium/High"
}

If no records found for a category, return an empty array []. Return ONLY the JSON object.`;
}

function renderClearReportSection(report) {
  // Hide placeholder, show data section
  const content = document.getElementById('clearReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('clearReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // UCC Filings
  const uccList = report.ucc_filings || [];
  document.getElementById('clearUccCount').textContent = uccList.length;
  document.getElementById('clearUccCount').style.background = uccList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearUccCount').style.color = uccList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearUccList').innerHTML = uccList.length ? uccList.map(u => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${u.creditor || 'Unknown Creditor'}</span>
        <span style="font-size: 0.75rem; background: ${u.status?.toLowerCase().includes('active') ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)'}; color: ${u.status?.toLowerCase().includes('active') ? 'var(--tier-e)' : 'var(--tier-a)'}; padding: 2px 8px; border-radius: 4px;">${u.status || 'Unknown'}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        ${u.collateral ? `Collateral: ${u.collateral}` : ''} ${u.filed_date ? `| Filed: ${u.filed_date}` : ''} ${u.original_amount ? `| Amount: ${u.original_amount}` : ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No UCC filings found</div>';
  
  // Liens
  const liensList = report.liens || [];
  document.getElementById('clearLiensCount').textContent = liensList.length;
  document.getElementById('clearLiensCount').style.background = liensList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearLiensCount').style.color = liensList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearLiensList').innerHTML = liensList.length ? liensList.map(l => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${l.type || 'Lien'}: ${l.creditor || 'Unknown'}</span>
        <span style="font-weight: 600; color: var(--tier-e);">${l.amount || ''}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Filed: ${l.filed_date || 'N/A'} | Status: ${l.status || 'Unknown'}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No liens found</div>';
  
  // Judgments
  const judgmentsList = report.judgments || [];
  document.getElementById('clearJudgmentsCount').textContent = judgmentsList.length;
  document.getElementById('clearJudgmentsCount').style.background = judgmentsList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearJudgmentsCount').style.color = judgmentsList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearJudgmentsList').innerHTML = judgmentsList.length ? judgmentsList.map(j => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${j.plaintiff || 'Unknown'} vs Business</span>
        <span style="font-weight: 600; color: var(--tier-e);">${j.amount || ''}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Case: ${j.case_number || 'N/A'} | ${j.court || ''} | ${j.date || ''} | ${j.status || ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No judgments found</div>';
  
  // Court Records
  const courtList = report.court_records || [];
  document.getElementById('clearCourtCount').textContent = courtList.length;
  document.getElementById('clearCourtList').innerHTML = courtList.length ? courtList.map(c => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="font-weight: 600;">${c.case_type || 'Case'}: ${c.case_number || ''}</div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Parties: ${c.parties || 'N/A'} | Filed: ${c.filed_date || 'N/A'} | Status: ${c.status || ''} ${c.outcome ? `| Outcome: ${c.outcome}` : ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No court records found</div>';
  
  // Bankruptcies
  const bankruptcyList = report.bankruptcies || [];
  document.getElementById('clearBankruptcyCount').textContent = bankruptcyList.length;
  document.getElementById('clearBankruptcyCount').style.background = bankruptcyList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearBankruptcyCount').style.color = bankruptcyList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearBankruptcyList').innerHTML = bankruptcyList.length ? bankruptcyList.map(b => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">Chapter ${b.chapter || '?'} Bankruptcy</span>
        <span style="font-size: 0.75rem; background: ${b.status?.toLowerCase().includes('discharged') ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 2px 8px; border-radius: 4px;">${b.status || ''}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Case: ${b.case_number || 'N/A'} | Filed: ${b.filed_date || 'N/A'} | Court: ${b.court || ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No bankruptcies found</div>';
  
  // Owner Background
  const owner = report.owner_background || {};
  document.getElementById('clearOwnerBackground').innerHTML = `
    ${owner.criminal_records?.length ? `<div style="margin-bottom: 12px;"><strong style="color: var(--tier-e);">Criminal Records:</strong> ${owner.criminal_records.join(', ')}</div>` : ''}
    ${owner.other_businesses?.length ? `<div style="margin-bottom: 12px;"><strong>Other Businesses:</strong> ${owner.other_businesses.join(', ')}</div>` : ''}
    ${owner.address_history?.length ? `<div style="margin-bottom: 12px;"><strong>Address History:</strong> ${owner.address_history.join(' | ')}</div>` : ''}
    ${owner.notes ? `<div>${owner.notes}</div>` : ''}
    ${!owner.criminal_records?.length && !owner.other_businesses?.length && !owner.notes ? '<div style="color: var(--text-muted);">No significant findings</div>' : ''}
  `;
}

// ===============================
// FOOTPRINT REPORT
// ===============================
async function runFootprintReport() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Digital Footprint: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: #06b6d4; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Scanning Digital Footprint</p>
      <p style="color: var(--text-muted);">Searching web presence, social media, reviews...</p>
    </div>
    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid #06b6d4;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <div style="width: 8px; height: 8px; background: #06b6d4; border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
        <span style="font-size: 0.75rem; color: #06b6d4; text-transform: uppercase; font-weight: 600;">Live Feed</span>
      </div>
      <div id="footprintReportStream" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', monospace; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; line-height: 1.5;">Connecting...</div>
    </div>
  `;
  modal.classList.add('active');
  
  const prompt = buildFootprintPrompt(currentDeal.businessName);
  
  try {
    const streamEl = document.getElementById('footprintReportStream');
    
    // Use streaming API
    const fullText = await streamGeminiAPI(prompt, {
      onChunk: (text) => {
        if (streamEl) {
          const display = text.slice(-500).replace(/```json|```/g, '');
          streamEl.textContent = display;
          streamEl.scrollTop = streamEl.scrollHeight;
        }
      },
      useGoogleSearch: true
    });
    
    const parsed = safeJsonFromText(fullText);
    
    if (!parsed) throw new Error('Failed to parse footprint results');
    
    currentDeal.footprintReport = parsed;
    saveDealsToStorage();
    renderFootprintReportSection(parsed);
    closeDeepResearchModal();
    showToast('Footprint Complete', `Found ${parsed.social_media?.length || 0} social profiles`);
    
  } catch (err) {
    console.error('Footprint report failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Footprint Report Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function buildFootprintPrompt(businessName) {
  return `You are a digital presence investigator.

BUSINESS: "${businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.industry ? `INDUSTRY: ${currentDeal.industry}` : ''}

Search and analyze:
1. WEB PRESENCE - Official website, domain age, SSL status, technology stack, SEO ranking
2. SOCIAL MEDIA - Facebook, Instagram, LinkedIn, Twitter/X, YouTube, TikTok presence
3. REVIEWS - Google reviews, Yelp, BBB, industry-specific platforms
4. NEWS & MENTIONS - Press releases, news articles, blog mentions, controversy

Return as JSON:
{
  "web_presence": {
    "website": "",
    "domain_age": "",
    "ssl_status": "",
    "has_ecommerce": false,
    "seo_visibility": "",
    "last_updated": "",
    "technology": []
  },
  "social_media": [
    {"platform": "Facebook", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "Instagram", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "LinkedIn", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "Twitter", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "YouTube", "url": "", "subscribers": "", "last_active": "", "videos": 0},
    {"platform": "TikTok", "url": "", "followers": "", "last_active": "", "engagement": ""}
  ],
  "reviews": {
    "google": {"rating": 0, "count": 0, "sentiment": ""},
    "yelp": {"rating": 0, "count": 0, "sentiment": ""},
    "bbb": {"rating": "", "accredited": false, "complaints": 0},
    "other": []
  },
  "news_mentions": [
    {"title": "", "source": "", "date": "", "sentiment": "", "url": ""}
  ],
  "digital_score": 0,
  "summary": ""
}`;
}

function renderFootprintReportSection(report) {
  // Hide placeholder, show data section
  const content = document.getElementById('footprintReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('footprintReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // Web Presence
  const web = report.web_presence || {};
  document.getElementById('footprintWeb').innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
      <div><span style="color: var(--text-muted);">Website:</span> ${web.website ? `<a href="${web.website}" target="_blank" style="color: var(--accent);">${web.website}</a>` : 'Not found'}</div>
      <div><span style="color: var(--text-muted);">Domain Age:</span> ${web.domain_age || 'N/A'}</div>
      <div><span style="color: var(--text-muted);">SSL:</span> <span style="color: ${web.ssl_status?.toLowerCase().includes('valid') ? 'var(--tier-a)' : 'var(--tier-e)'};">${web.ssl_status || 'N/A'}</span></div>
      <div><span style="color: var(--text-muted);">E-commerce:</span> ${web.has_ecommerce ? 'Yes' : 'No'}</div>
      <div><span style="color: var(--text-muted);">SEO Visibility:</span> ${web.seo_visibility || 'N/A'}</div>
      <div><span style="color: var(--text-muted);">Last Updated:</span> ${web.last_updated || 'N/A'}</div>
    </div>
    ${web.technology?.length ? `<div style="margin-top: 12px;"><span style="color: var(--text-muted);">Technology:</span> ${web.technology.join(', ')}</div>` : ''}
  `;
  
  // Social Media
  const socials = report.social_media || [];
  document.getElementById('footprintSocial').innerHTML = socials.filter(s => s.url || s.followers).map(s => `
    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
      <div style="font-weight: 600; margin-bottom: 4px;">${s.platform}</div>
      ${s.url ? `<a href="${s.url}" target="_blank" style="font-size: 0.75rem; color: var(--accent); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">View Profile</a>` : ''}
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        ${s.followers || s.subscribers || 'N/A'} ${s.platform === 'YouTube' ? 'subscribers' : 'followers'}
      </div>
      <div style="font-size: 0.75rem; color: var(--text-muted);">
        ${s.last_active ? `Active: ${s.last_active}` : ''} ${s.engagement ? `| ${s.engagement}` : ''}
      </div>
    </div>
  `).join('') || '<div style="grid-column: 1/-1; color: var(--text-muted);">No social media profiles found</div>';
  
  // Reviews
  const reviews = report.reviews || {};
  document.getElementById('footprintReviews').innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 0.75rem; color: var(--text-muted);">Google</div>
        <div style="font-size: 1.25rem; font-weight: 700; color: ${(reviews.google?.rating || 0) >= 4 ? 'var(--tier-a)' : (reviews.google?.rating || 0) >= 3 ? 'var(--tier-c)' : 'var(--tier-e)'};">${reviews.google?.rating || 'N/A'}</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">${reviews.google?.count || 0} reviews</div>
      </div>
      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 0.75rem; color: var(--text-muted);">Yelp</div>
        <div style="font-size: 1.25rem; font-weight: 700; color: ${(reviews.yelp?.rating || 0) >= 4 ? 'var(--tier-a)' : (reviews.yelp?.rating || 0) >= 3 ? 'var(--tier-c)' : 'var(--tier-e)'};">${reviews.yelp?.rating || 'N/A'}</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">${reviews.yelp?.count || 0} reviews</div>
      </div>
      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 0.75rem; color: var(--text-muted);">BBB</div>
        <div style="font-size: 1.25rem; font-weight: 700;">${reviews.bbb?.rating || 'N/A'}</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">${reviews.bbb?.accredited ? 'Accredited' : 'Not Accredited'}</div>
      </div>
    </div>
    ${reviews.google?.sentiment || reviews.yelp?.sentiment ? `
      <div style="margin-top: 12px; font-size: 0.85rem;">
        ${reviews.google?.sentiment ? `<div><strong>Google Sentiment:</strong> ${reviews.google.sentiment}</div>` : ''}
        ${reviews.yelp?.sentiment ? `<div><strong>Yelp Sentiment:</strong> ${reviews.yelp.sentiment}</div>` : ''}
      </div>
    ` : ''}
  `;
  
  // News & Mentions
  const news = report.news_mentions || [];
  document.getElementById('footprintNews').innerHTML = news.length ? news.map(n => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="font-weight: 600;">${n.title || 'News Article'}</div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        ${n.source || ''} ${n.date ? `| ${n.date}` : ''} 
        ${n.sentiment ? `| <span style="color: ${n.sentiment.toLowerCase().includes('positive') ? 'var(--tier-a)' : n.sentiment.toLowerCase().includes('negative') ? 'var(--tier-e)' : 'var(--text-muted)'};">${n.sentiment}</span>` : ''}
      </div>
      ${n.url ? `<a href="${n.url}" target="_blank" style="font-size: 0.75rem; color: var(--accent);">Read More</a>` : ''}
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No recent news mentions found</div>';
}

// ===============================
// DEBT REPORT
// ===============================
async function runDebtReport() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Debt Analysis: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--tier-e); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Analyzing Debt Obligations</p>
      <p style="color: var(--text-muted);">Reviewing bank statements, UCC filings, and debt patterns...</p>
    </div>
    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px; margin-top: 16px; border: 1px solid var(--tier-e);">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <div style="width: 8px; height: 8px; background: var(--tier-e); border-radius: 50%; animation: scrubPulse 1s ease-in-out infinite;"></div>
        <span style="font-size: 0.75rem; color: var(--tier-e); text-transform: uppercase; font-weight: 600;">Live Feed</span>
      </div>
      <div id="debtReportStream" style="font-size: 0.8rem; color: var(--text-secondary); font-family: 'SF Mono', monospace; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; line-height: 1.5;">Connecting...</div>
    </div>
  `;
  modal.classList.add('active');
  
  // Gather bank statement data
  const bankData = currentDeal.months || [];
  const prompt = buildDebtReportPrompt(currentDeal.businessName, bankData);
  
  try {
    const streamEl = document.getElementById('debtReportStream');
    
    // Use streaming API
    const fullText = await streamGeminiAPI(prompt, {
      onChunk: (text) => {
        if (streamEl) {
          const display = text.slice(-500).replace(/```json|```/g, '');
          streamEl.textContent = display;
          streamEl.scrollTop = streamEl.scrollHeight;
        }
      },
      useGoogleSearch: true
    });
    
    const parsed = safeJsonFromText(fullText);
    
    if (!parsed) throw new Error('Failed to parse debt analysis');
    
    currentDeal.debtReport = parsed;
    saveDealsToStorage();
    renderDebtReportSection(parsed);
    closeDeepResearchModal();
    showToast('Debt Analysis Complete', `Est. Total: ${parsed.total_debt || '$0'}`);
    
  } catch (err) {
    console.error('Debt report failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Debt Analysis Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function buildDebtReportPrompt(businessName, bankData) {
  const bankSummary = bankData.map(m => 
    `${m.monthLabel || m.month}: Revenue $${(m.revenue || 0).toLocaleString()}, Deposits $${(m.deposits || 0).toLocaleString()}, Withdrawals $${(m.withdrawals || 0).toLocaleString()}, Ending Balance $${(m.endingBal || 0).toLocaleString()}`
  ).join('\n');
  
  return `You are a debt analyst specializing in MCA and business lending.

BUSINESS: "${businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}

BANK STATEMENT DATA:
${bankSummary || 'No bank data available'}

${currentDeal?.clearReport ? `UCC FILINGS FOUND: ${JSON.stringify(currentDeal.clearReport.ucc_filings || [])}` : ''}

Analyze and identify:
1. EXISTING DEBT - MCA positions, term loans, lines of credit, equipment financing from UCC filings
2. PAYMENT PATTERNS - Regular outgoing payments that suggest debt service
3. LARGE TRANSACTIONS - Unusual large withdrawals or deposits that may indicate funding/payoffs
4. DEBT LOAD - Estimate total outstanding debt and monthly payment obligations
5. STACKING INDICATORS - Signs of multiple MCA positions or debt stacking

IMPORTANT: You MUST respond with ONLY valid JSON. No explanatory text before or after. Start directly with { and end with }.

{
  "total_debt": "$X estimated",
  "monthly_payments": "$X",
  "active_positions": 0,
  "debt_obligations": [
    {
      "type": "MCA/Term Loan/LOC/Equipment/Other",
      "creditor": "creditor name",
      "estimated_balance": "$X",
      "payment_amount": "$X",
      "payment_frequency": "daily/weekly/monthly",
      "filed_date": "date or N/A",
      "status": "Active/Paid Off/Unknown"
    }
  ],
  "large_transactions": [
    {
      "date": "date",
      "description": "description",
      "amount": "$X",
      "type": "Debit/Credit",
      "analysis": "Possible MCA funding/Loan payment/Unknown"
    }
  ],
  "stacking_indicators": ["string array of warning signs"],
  "debt_to_revenue_ratio": "X%",
  "risk_assessment": "Low/Medium/High",
  "summary": "Brief summary of debt situation"
}

If no debt found, return empty arrays. Return ONLY the JSON object.`;
}

function renderDebtReportSection(report) {
  // Hide placeholder, show data section
  const content = document.getElementById('debtReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('debtReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // Summary metrics
  document.getElementById('debtTotal').textContent = report.total_debt || '$0';
  document.getElementById('debtMonthly').textContent = report.monthly_payments || '$0';
  document.getElementById('debtPositions').textContent = report.active_positions || 0;
  
  // Color code based on positions
  const positions = report.active_positions || 0;
  document.getElementById('debtPositions').style.color = positions === 0 ? 'var(--tier-a)' : positions <= 2 ? 'var(--tier-c)' : 'var(--tier-e)';
  
  // Debt Table
  const debts = report.debt_obligations || [];
  document.getElementById('debtTableBody').innerHTML = debts.length ? debts.map(d => `
    <tr>
      <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: ${d.type?.includes('MCA') ? 'rgba(239, 68, 68, 0.2)' : 'rgba(234, 179, 8, 0.2)'};">${d.type || 'Unknown'}</span></td>
      <td>${d.creditor || 'Unknown'}</td>
      <td style="font-weight: 600;">${d.estimated_balance || 'N/A'}</td>
      <td>${d.payment_amount || 'N/A'}${d.payment_frequency ? ` (${d.payment_frequency})` : ''}</td>
      <td>${d.filed_date || 'N/A'}</td>
      <td><span style="color: ${d.status?.toLowerCase().includes('active') ? 'var(--tier-e)' : 'var(--tier-a)'};">${d.status || 'Unknown'}</span></td>
    </tr>
  `).join('') : '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">No debt obligations identified</td></tr>';
  
  // Large Transactions
  const transactions = report.large_transactions || [];
  document.getElementById('largeTransactionsBody').innerHTML = transactions.length ? transactions.map(t => `
    <tr>
      <td>${t.date || 'N/A'}</td>
      <td>${t.description || 'Unknown'}</td>
      <td style="font-weight: 600; color: ${t.type?.toLowerCase().includes('debit') ? 'var(--tier-e)' : 'var(--tier-a)'};">${t.type?.toLowerCase().includes('debit') ? '-' : '+'}${t.amount || ''}</td>
      <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: ${t.type?.toLowerCase().includes('debit') ? 'rgba(239, 68, 68, 0.15)' : 'rgba(34, 197, 94, 0.15)'};">${t.type || ''}</span></td>
      <td style="font-size: 0.8rem; color: var(--text-secondary);">${t.analysis || ''}</td>
    </tr>
  `).join('') : '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">No large transactions identified</td></tr>';
}

// ===============================
// CUSTOM QUERY
// ===============================
async function runCustomQuery() {
  const queryInput = document.getElementById('customResearchQuery');
  const query = queryInput.value.trim();
  
  if (!query) {
    showToast('Error', 'Please enter a question or command.');
    return;
  }
  
  if (!currentDeal?.businessName) {
    showToast('Error', 'No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    showToast('Error', 'Enter your Gemini API key first (Settings).');
    return;
  }
  
  // Show inline loading
  const resultsContainer = document.getElementById('inlineQueryResults');
  const loadingEl = document.getElementById('inlineQueryLoading');
  const contentEl = document.getElementById('inlineQueryContent');
  const btn = document.getElementById('customQueryBtn');
  
  resultsContainer.style.display = 'block';
  loadingEl.style.display = 'block';
  contentEl.style.display = 'none';
  btn.disabled = true;
  btn.innerHTML = '<div style="width: 14px; height: 14px; border: 2px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>';
  
  const prompt = `You are a business intelligence researcher.

BUSINESS: "${currentDeal.businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.industry ? `INDUSTRY: ${currentDeal.industry}` : ''}
${currentDeal?.address ? `ADDRESS: ${currentDeal.address}` : ''}

USER QUESTION/COMMAND: "${query}"

Search the web and provide a comprehensive answer to this question about the business. Be specific and cite sources.

Return as JSON:
{
  "question": "${query}",
  "answer": "",
  "key_findings": [],
  "sources": [{"title": "", "url": ""}],
  "confidence": 0
}`;
  
  try {
    const model = getGeminiModel();
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.3 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) throw new Error('Failed to parse response');
    
    // Store in deal
    if (!currentDeal.customQueries) currentDeal.customQueries = [];
    currentDeal.customQueries.unshift(parsed);
    saveDealsToStorage();
    
    // Show inline results
    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';
    
    document.getElementById('inlineQueryQuestion').textContent = `Q: ${parsed.question || query}`;
    document.getElementById('inlineQueryAnswer').textContent = parsed.answer || 'No answer available.';
    
    const findingsEl = document.getElementById('inlineQueryFindings');
    if (parsed.key_findings?.length) {
      findingsEl.innerHTML = `
        <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 6px; font-size: 0.8rem; color: var(--accent);">Key Findings</div>
          <ul style="margin: 0; padding-left: 16px; font-size: 0.8rem; color: var(--text-secondary);">
            ${parsed.key_findings.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('')}
          </ul>
        </div>
      `;
    } else {
      findingsEl.innerHTML = '';
    }
    
    const sourcesEl = document.getElementById('inlineQuerySources');
    if (parsed.sources?.length && parsed.sources[0]?.url) {
      sourcesEl.innerHTML = `Sources: ${parsed.sources.map(s => `<a href="${s.url}" target="_blank" style="color: var(--accent);">${s.title || 'Link'}</a>`).join(', ')}`;
    } else {
      sourcesEl.innerHTML = '';
    }
    
    // Also render in the Research tab for history
    renderCustomQuerySection(parsed);
    queryInput.value = '';
    showToast('Research Complete', `Confidence: ${parsed.confidence || 0}%`);
    
  } catch (err) {
    console.error('Custom query failed:', err);
    loadingEl.style.display = 'none';
    contentEl.style.display = 'block';
    document.getElementById('inlineQueryQuestion').textContent = 'Error';
    document.getElementById('inlineQueryAnswer').innerHTML = `<span style="color: var(--tier-e);">${err.message}</span>`;
    document.getElementById('inlineQueryFindings').innerHTML = '';
    document.getElementById('inlineQuerySources').innerHTML = '';
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Search';
  }
}

function closeInlineQuery() {
  document.getElementById('inlineQueryResults').style.display = 'none';
}

function renderCustomQuerySection(result) {
  const section = document.getElementById('customQuerySection');
  section.style.display = 'block';
  
  document.getElementById('customQueryQuestion').textContent = `Q: ${result.question || ''}`;
  document.getElementById('customQueryAnswer').innerHTML = `
    <div style="margin-bottom: 12px;">${result.answer || 'No answer available.'}</div>
    ${result.key_findings?.length ? `
      <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem;">Key Findings:</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem;">
          ${result.key_findings.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('')}
        </ul>
      </div>
    ` : ''}
  `;
  
  const sources = result.sources || [];
  document.getElementById('customQuerySources').innerHTML = sources.length ? 
    `<strong>Sources:</strong> ${sources.slice(0, 5).map(s => `<a href="${s.url}" target="_blank" style="color: var(--accent);">${s.title || 'Source'}</a>`).join(' | ')}` : '';
}

// ===============================
// CREDIT REPORT RENDER
// ===============================
function renderCreditReportSection(report) {
  // More lenient check - accept if we have any useful data
  const hasScores = report?.scores?.fico || report?.scores?.vantage || report?.scores?.experian || report?.scores?.equifax || report?.scores?.transunion;
  const hasTradelines = report?.tradelines?.length > 0;
  const hasInquiries = report?.inquiries?.recent_inquiries?.length > 0 || report?.inquiries?.hard_inquiries_24mo > 0;
  const hasSubjectInfo = report?.subject_name || report?.bureau;
  const isNotScored = report?.scores?.score_status === 'not_scored';
  const hasEmployment = report?.employment?.employer;
  
  if (!report || (!hasScores && !hasTradelines && !hasInquiries && !hasSubjectInfo && !isNotScored && !hasEmployment)) {
    document.getElementById('creditReportSection').style.display = 'none';
    return;
  }
  
  // Hide placeholder, show data section
  const content = document.getElementById('creditReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('creditReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // Bureau and date - also show "Not Scored" status
  let bureauText = report.bureau ? `${report.bureau}${report.report_date ? ' - ' + report.report_date : ''}` : '';
  if (isNotScored) {
    bureauText += bureauText ? ' | NOT SCORED' : 'NOT SCORED';
  }
  document.getElementById('creditReportBureau').textContent = bureauText;
  
  // Credit Scores with color coding
  function scoreColor(score) {
    if (!score || score === 0) return 'var(--text-muted)';
    if (score >= 740) return 'var(--tier-a)';
    if (score >= 670) return 'var(--tier-b)';
    if (score >= 580) return 'var(--tier-c)';
    if (score >= 500) return 'var(--tier-d)';
    return 'var(--tier-e)';
  }
  
  const scores = report.scores || {};
  ['fico', 'vantage', 'experian', 'equifax', 'transunion'].forEach(type => {
    const el = document.getElementById(`creditScore${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (!el) return;
    const val = scores[type] || 0;
    const scoreEl = el.querySelector('.credit-score-value');
    if (scoreEl) {
      if (isNotScored && type === 'experian') {
        scoreEl.textContent = 'N/S';
        scoreEl.style.color = 'var(--text-muted)';
      } else {
        scoreEl.textContent = val || '--';
        scoreEl.style.color = scoreColor(val);
      }
    }
  });
  
  // Account Summary
  const summary = report.summary || {};
  document.getElementById('creditTotalAccounts').textContent = summary.total_accounts || 0;
  document.getElementById('creditOpenAccounts').textContent = summary.open_accounts || 0;
  
  const delinquent = summary.delinquent_accounts || 0;
  document.getElementById('creditDelinquentAccounts').textContent = delinquent;
  document.getElementById('creditDelinquentAccounts').style.color = delinquent > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const derogatory = summary.derogatory_accounts || 0;
  document.getElementById('creditDerogatoryAccounts').textContent = derogatory;
  document.getElementById('creditDerogatoryAccounts').style.color = derogatory > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  document.getElementById('creditTotalBalance').textContent = formatCurrency(summary.total_balance || 0);
  document.getElementById('creditTotalLimit').textContent = formatCurrency(summary.total_credit_limit || 0);
  
  const utilization = summary.credit_utilization || 0;
  document.getElementById('creditUtilization').textContent = `${utilization}%`;
  document.getElementById('creditUtilization').style.color = utilization > 50 ? (utilization > 75 ? 'var(--tier-e)' : 'var(--tier-d)') : 'var(--tier-a)';
  
  document.getElementById('creditMonthlyPayment').textContent = formatCurrency(summary.total_monthly_payment || 0);
  
  // Payment History
  const payment = report.payment_history || {};
  const onTime = payment.on_time_percentage || 0;
  document.getElementById('creditOnTime').textContent = `${onTime}%`;
  document.getElementById('creditOnTime').style.color = onTime >= 95 ? 'var(--tier-a)' : onTime >= 80 ? 'var(--tier-c)' : 'var(--tier-e)';
  
  const late30 = payment.late_30_days || 0;
  document.getElementById('creditLate30').textContent = late30;
  document.getElementById('creditLate30').style.color = late30 > 0 ? 'var(--tier-d)' : 'var(--tier-a)';
  
  const late60 = payment.late_60_days || 0;
  document.getElementById('creditLate60').textContent = late60;
  document.getElementById('creditLate60').style.color = late60 > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const late90 = payment.late_90_days || 0;
  document.getElementById('creditLate90').textContent = late90;
  document.getElementById('creditLate90').style.color = late90 > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const collections = payment.collections || 0;
  document.getElementById('creditCollections').textContent = collections;
  document.getElementById('creditCollections').style.color = collections > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const chargeOffs = payment.charge_offs || 0;
  document.getElementById('creditChargeOffs').textContent = chargeOffs;
  document.getElementById('creditChargeOffs').style.color = chargeOffs > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  // Public Records
  const publicRecords = report.public_records || {};
  const hasPublicRecords = (publicRecords.bankruptcies?.length || 0) + (publicRecords.judgments?.length || 0) + (publicRecords.liens?.length || 0) + (publicRecords.foreclosures?.length || 0) > 0;
  
  const publicSection = document.getElementById('creditPublicRecordsSection');
  if (hasPublicRecords) {
    publicSection.style.display = 'block';
    let publicHtml = '';
    if (publicRecords.bankruptcies?.length) {
      publicHtml += publicRecords.bankruptcies.map(b => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Bankruptcy:</strong> ${typeof b === 'string' ? b : `Chapter ${b.chapter || '?'} - ${b.status || ''} (${b.filed_date || ''})`}
        </div>
      `).join('');
    }
    if (publicRecords.judgments?.length) {
      publicHtml += publicRecords.judgments.map(j => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Judgment:</strong> ${typeof j === 'string' ? j : `${j.plaintiff || ''} - ${j.amount || ''} (${j.date || ''})`}
        </div>
      `).join('');
    }
    if (publicRecords.liens?.length) {
      publicHtml += publicRecords.liens.map(l => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Lien:</strong> ${typeof l === 'string' ? l : `${l.type || 'Tax'} - ${l.amount || ''} (${l.filed_date || ''})`}
        </div>
      `).join('');
    }
    if (publicRecords.foreclosures?.length) {
      publicHtml += publicRecords.foreclosures.map(f => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Foreclosure:</strong> ${typeof f === 'string' ? f : `${f.status || ''} (${f.date || ''})`}
        </div>
      `).join('');
    }
    document.getElementById('creditPublicRecordsList').innerHTML = publicHtml;
  } else {
    publicSection.style.display = 'none';
  }
  
  // Inquiries
  const inquiries = report.inquiries || {};
  const recentInquiries = inquiries.recent_inquiries || [];
  // Use count if provided, otherwise use length of recent_inquiries
  const inquiryCount = inquiries.hard_inquiries_24mo || recentInquiries.length || 0;
  document.getElementById('creditInquiryCount').textContent = inquiryCount;
  document.getElementById('creditInquiryCount').style.background = inquiryCount > 5 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('creditInquiryCount').style.color = inquiryCount > 5 ? 'var(--tier-e)' : '';
  
  document.getElementById('creditInquiriesList').innerHTML = recentInquiries.length ? 
    recentInquiries.map(i => `
      <div style="display: inline-block; padding: 6px 12px; background: var(--bg-tertiary); border-radius: 6px; margin: 4px 4px 4px 0; font-size: 0.8rem;">
        ${typeof i === 'string' ? i : `<strong>${i.creditor || 'Unknown'}</strong>${i.date ? ' - ' + i.date : ''}${i.type ? ' (' + i.type + ')' : ''}`}
      </div>
    `).join('') : '<div style="color: var(--text-muted);">No recent inquiries</div>';
  
  // Tradelines Table
  const tradelines = report.tradelines || [];
  document.getElementById('creditTradelineCount').textContent = tradelines.length;
  document.getElementById('creditTradelinesBody').innerHTML = tradelines.length ? tradelines.map(t => {
    const statusColor = t.payment_status?.toLowerCase().includes('current') ? 'var(--tier-a)' : 
                        t.payment_status?.toLowerCase().includes('30') ? 'var(--tier-d)' :
                        t.payment_status?.toLowerCase().includes('60') || t.payment_status?.toLowerCase().includes('90') ? 'var(--tier-e)' : 'var(--text-secondary)';
    return `
      <tr>
        <td style="font-weight: 500;">${t.creditor || 'Unknown'}</td>
        <td>${t.account_type || 'N/A'}</td>
        <td>${t.date_opened || 'N/A'}</td>
        <td>${t.credit_limit ? formatCurrency(t.credit_limit) : (t.high_balance ? formatCurrency(t.high_balance) : 'N/A')}</td>
        <td style="font-weight: 600;">${t.current_balance ? formatCurrency(t.current_balance) : '$0'}</td>
        <td>${t.monthly_payment ? formatCurrency(t.monthly_payment) : 'N/A'}</td>
        <td><span style="color: ${statusColor}; font-weight: 500;">${t.payment_status || 'N/A'}</span></td>
      </tr>
    `;
  }).join('') : '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No tradelines available</td></tr>';
  
  // Collections Table
  const collectionAccounts = report.collections || [];
  const collectionsSection = document.getElementById('creditCollectionsSection');
  if (collectionAccounts.length > 0) {
    collectionsSection.style.display = 'block';
    document.getElementById('creditCollectionsCount').textContent = collectionAccounts.length;
    document.getElementById('creditCollectionsBody').innerHTML = collectionAccounts.map(c => `
      <tr>
        <td style="font-weight: 500;">${c.creditor || 'Unknown'}</td>
        <td>${c.original_creditor || 'N/A'}</td>
        <td style="font-weight: 600; color: var(--tier-e);">${c.balance ? formatCurrency(c.balance) : 'N/A'}</td>
        <td>${c.date_opened || 'N/A'}</td>
        <td>${c.status || 'N/A'}</td>
      </tr>
    `).join('');
  } else {
    collectionsSection.style.display = 'none';
  }
  
  // Employment Section
  const employment = report.employment;
  const employmentSection = document.getElementById('creditEmploymentSection');
  if (employment?.employer) {
    employmentSection.style.display = 'block';
    let empHtml = `<div style="padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px;">`;
    empHtml += `<strong>${employment.employer}</strong>`;
    if (employment.date_hired) empHtml += `<br><span style="color: var(--text-muted);">Hired: ${employment.date_hired}</span>`;
    if (employment.date_reported) empHtml += `<br><span style="color: var(--text-muted);">Reported: ${employment.date_reported}</span>`;
    if (employment.occupation) empHtml += `<br><span style="color: var(--text-muted);">Occupation: ${employment.occupation}</span>`;
    if (employment.income) empHtml += `<br><span style="color: var(--text-muted);">Income: ${employment.income}</span>`;
    empHtml += `</div>`;
    document.getElementById('creditEmploymentInfo').innerHTML = empHtml;
  } else {
    employmentSection.style.display = 'none';
  }
  
  // Warnings Section
  const warnings = report.warnings || [];
  const warningsSection = document.getElementById('creditWarningsSection');
  if (warnings.length > 0) {
    warningsSection.style.display = 'block';
    document.getElementById('creditWarningsList').innerHTML = warnings.map(w => 
      `<div style="padding: 8px 12px; background: rgba(239, 68, 68, 0.05); border-radius: 6px; margin-bottom: 6px;">${typeof w === 'string' ? w : w.message || w.code || JSON.stringify(w)}</div>`
    ).join('');
  } else {
    warningsSection.style.display = 'none';
  }
  
  // Score Reason Section (for Not Scored reports)
  const scoreReasonSection = document.getElementById('creditScoreReasonSection');
  if (report.scores?.score_status === 'not_scored' || report.scores?.score_reason) {
    scoreReasonSection.style.display = 'block';
    let reasonText = '<strong>Status:</strong> Not Scored';
    if (report.scores?.score_reason) {
      reasonText += `<br><br><strong>Reason:</strong> ${report.scores.score_reason}`;
    }
    document.getElementById('creditScoreReasonText').innerHTML = reasonText;
  } else {
    scoreReasonSection.style.display = 'none';
  }
}

function formatCurrency(val) {
  if (typeof val === 'string' && val.includes('$')) return val;
  const num = parseFloat(val) || 0;
  return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Also render existing report sections on page load
function renderAllReportSections() {
  if (currentDeal?.clearReport) renderClearReportSection(currentDeal.clearReport);
  if (currentDeal?.footprintReport) renderFootprintReportSection(currentDeal.footprintReport);
  if (currentDeal?.debtReport) renderDebtReportSection(currentDeal.debtReport);
  if (currentDeal?.credit_report) renderCreditReportSection(currentDeal.credit_report);
  if (currentDeal?.customQueries?.length) renderCustomQuerySection(currentDeal.customQueries[0]);
  
  // Update all tab badges
  updateIntelBadges();
}




/* =========================================================
   APPROVAL SEND / SHARE (Inspired by Approval Toolbox)
   - Single-file share links (ISO calculator + Merchant view)
   - No backend required (mailto / copy-to-clipboard)
   ========================================================= */

(function(){
  const GD_SHARE_KEYS = {
    brandName: 'gd_share_brand_name',
    brandLogo: 'gd_share_brand_logo',
    brandAccent: 'gd_share_brand_accent',
    senderName: 'gd_share_sender_name',
    senderEmail: 'gd_share_sender_email',
    senderPhone: 'gd_share_sender_phone',
    isoName: 'gd_share_iso_name',
    maxSellDelta: 'gd_share_max_sell_delta',
    showFactor: 'gd_share_show_factor',
    isoBrandName: 'gd_iso_brand_name',
    isoBrandLogo: 'gd_iso_brand_logo'
  };

  function $(id){ return document.getElementById(id); }

  function gdBaseUrl(){
    return window.location.href.split('?')[0].split('#')[0];
  }

  function gdMoney(n){
    const num = Number(n || 0);
    return '$' + Math.round(num).toLocaleString();
  }

  function gdPct(n){
    const num = Number(n || 0);
    return (num * 100).toFixed(1) + '%';
  }

  function gdClamp(n, min, max){
    return Math.min(max, Math.max(min, n));
  }

  function gdSafeParseFloat(v, fallback=0){
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : fallback;
  }

  function gdEncode(obj){
    try{
      const json = JSON.stringify(obj);
      const utf8 = encodeURIComponent(json).replace(/%([0-9A-F]{2})/g, (_,p1) => String.fromCharCode(parseInt(p1,16)));
      const b64 = btoa(utf8).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
      return b64;
    } catch(e){
      console.error('gdEncode error', e);
      return '';
    }
  }

  function gdDecode(str){
    try{
      let b64 = (str || '').replace(/-/g,'+').replace(/_/g,'/');
      while (b64.length % 4) b64 += '=';
      const binary = atob(b64);
      const utf8 = Array.prototype.map.call(binary, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('');
      const json = decodeURIComponent(utf8);
      return JSON.parse(json);
    } catch(e){
      console.error('gdDecode error', e);
      return null;
    }
  }

  function gdBuildLink(data, isIso){
    const enc = gdEncode(data);
    if (!enc) return '';
    return gdBaseUrl() + '?d=' + enc + (isIso ? '&iso=1' : '');
  }

  function gdGetAvgRevenue(){
    try{
      if (!window.currentDeal) return 0;
      const months = window.currentDeal.months || [];
      if (!months.length) return 0;
      const total = months.reduce((a,m) => a + (Number(m.revenue)||0), 0);
      return total / months.length;
    } catch(e){
      return 0;
    }
  }

  function gdOfferCfg(){
    return {
      conservative: { label: 'Conservative', rm: 0.8, f: 1.35, t: 90 },
      moderate: { label: 'Moderate', rm: 1.0, f: 1.28, t: 120 },
      aggressive: { label: 'Aggressive', rm: 1.3, f: 1.22, t: 180 }
    };
  }

  function gdSelectedOfferKeys(){
    const keys = [];
    if ($('shareOptConservative')?.checked) keys.push('conservative');
    if ($('shareOptModerate')?.checked) keys.push('moderate');
    if ($('shareOptAggressive')?.checked) keys.push('aggressive');
    return keys.length ? keys : ['moderate'];
  }

  function gdGetOfferOptions({mode='client', maxSellDelta=0.07}={}){
    const cfg = gdOfferCfg();
    const pm = gdSafeParseFloat($('positionSlider')?.value, 1);
    const avgRev = gdGetAvgRevenue();
    const q = (window.currentPaymentFrequency || 'daily');

    return gdSelectedOfferKeys().map(k => {
      const c = cfg[k];
      const amount = avgRev * c.rm * pm;
      const termDays = c.t;
      const buyFactor = c.f;
      const maxFactor = buyFactor + maxSellDelta;

      if (mode === 'iso'){
        return { k, l: c.label, a: Math.round(amount), t: termDays, q, bf: +buyFactor.toFixed(2), mf: +maxFactor.toFixed(2), f: +maxFactor.toFixed(2) };
      }
      return { k, l: c.label, a: Math.round(amount), t: termDays, q, f: +buyFactor.toFixed(2) };
    });
  }

  function gdGetShareFormData(){
    const accentDefault = (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#eab308').trim() || '#eab308';
    const expiryRaw = $('shareExpiry')?.value || '';
    let expiryISO = null;
    if (expiryRaw){
      // keep as yyyy-mm-dd (local) for display
      expiryISO = expiryRaw;
    }

    const showFactor = ($('shareShowFactor')?.value || 'yes') === 'yes';

    return {
      businessName: ($('shareBusinessName')?.value || '').trim(),
      contactName: ($('shareContactName')?.value || '').trim(),
      contactEmail: ($('shareContactEmail')?.value || '').trim(),
      contactPhone: ($('shareContactPhone')?.value || '').trim(),
      brandName: ($('shareBrandName')?.value || '').trim(),
      brandLogo: ($('shareBrandLogo')?.value || '').trim(),
      brandAccent: ($('shareBrandAccent')?.value || accentDefault).trim(),
      expiry: expiryISO,
      senderName: ($('shareSenderName')?.value || '').trim(),
      senderEmail: ($('shareSenderEmail')?.value || '').trim(),
      senderPhone: ($('shareSenderPhone')?.value || '').trim(),
      isoName: ($('shareISOName')?.value || '').trim(),
      maxSellDelta: gdSafeParseFloat($('shareMaxSellDelta')?.value, 0.07),
      showFactor
    };
  }

  function gdPersistShareDefaults(){
    const d = gdGetShareFormData();
    try{
      localStorage.setItem(GD_SHARE_KEYS.brandName, d.brandName);
      localStorage.setItem(GD_SHARE_KEYS.brandLogo, d.brandLogo);
      localStorage.setItem(GD_SHARE_KEYS.brandAccent, d.brandAccent);
      localStorage.setItem(GD_SHARE_KEYS.senderName, d.senderName);
      localStorage.setItem(GD_SHARE_KEYS.senderEmail, d.senderEmail);
      localStorage.setItem(GD_SHARE_KEYS.senderPhone, d.senderPhone);
      localStorage.setItem(GD_SHARE_KEYS.isoName, d.isoName);
      localStorage.setItem(GD_SHARE_KEYS.maxSellDelta, String(d.maxSellDelta));
      localStorage.setItem(GD_SHARE_KEYS.showFactor, d.showFactor ? 'yes' : 'no');
    } catch(e){}
  }

  function gdLoadShareDefaults(){
    const accentDefault = (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#eab308').trim() || '#eab308';

    const setIfExists = (id, val) => { if ($(id) && val != null && val !== '') $(id).value = val; };

    setIfExists('shareBrandName', localStorage.getItem(GD_SHARE_KEYS.brandName) || '');
    setIfExists('shareBrandLogo', localStorage.getItem(GD_SHARE_KEYS.brandLogo) || '');
    setIfExists('shareBrandAccent', localStorage.getItem(GD_SHARE_KEYS.brandAccent) || accentDefault);

    setIfExists('shareSenderName', localStorage.getItem(GD_SHARE_KEYS.senderName) || (localStorage.getItem('greatdane_username') || ''));
    setIfExists('shareSenderEmail', localStorage.getItem(GD_SHARE_KEYS.senderEmail) || '');
    setIfExists('shareSenderPhone', localStorage.getItem(GD_SHARE_KEYS.senderPhone) || '');

    setIfExists('shareISOName', localStorage.getItem(GD_SHARE_KEYS.isoName) || '');

    const msd = localStorage.getItem(GD_SHARE_KEYS.maxSellDelta);
    if ($('shareMaxSellDelta')) $('shareMaxSellDelta').value = msd ? msd : '0.07';

    const sf = localStorage.getItem(GD_SHARE_KEYS.showFactor);
    if ($('shareShowFactor')) $('shareShowFactor').value = sf || 'yes';
  }

  function gdBuildShareData(mode){
    const f = gdGetShareFormData();
    const opts = gdGetOfferOptions({ mode, maxSellDelta: f.maxSellDelta });
    const commPct = gdSafeParseFloat(document.getElementById('isoCommission')?.value, 10);
    const points = gdSafeParseFloat(document.getElementById('isoPoints')?.value, 0);

    return {
      v: 1,
      m: mode,              // mode: client | iso
      b: f.businessName,    // business name
      c: f.contactName,     // contact name
      em: f.contactEmail,
      ph: f.contactPhone,
      ex: f.expiry,         // yyyy-mm-dd
      cn: f.brandName,
      logo: f.brandLogo,
      ac: f.brandAccent,
      sf: f.showFactor ? 1 : 0,
      snd: { n: f.senderName, e: f.senderEmail, p: f.senderPhone },
      iso: f.isoName,
      ic: commPct,
      ip: points,
      o: opts
    };
  }

  function gdRefreshShareLinks(){
    try{
      gdPersistShareDefaults();
      const clientData = gdBuildShareData('client');
      const isoData = gdBuildShareData('iso');
      const clientLink = gdBuildLink(clientData, false);
      const isoLink = gdBuildLink(isoData, true);

      if ($('shareClientLink')) $('shareClientLink').value = clientLink;
      if ($('shareIsoLink')) $('shareIsoLink').value = isoLink;
    } catch(e){
      console.error('gdRefreshShareLinks error', e);
    }
  }

  function gdCopyToClipboard(text, successMsg){
    if (!text) { showToast('Nothing to copy', 'Generate the link first.'); return; }
    navigator.clipboard.writeText(text).then(() => {
      showToast('Copied', successMsg || 'Copied to clipboard');
    }).catch(() => {
      // fallback
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showToast('Copied', successMsg || 'Copied to clipboard');
      } catch(e){
        alert('Copy failed. Please copy manually.');
      }
    });
  }

  function gdRecordShare(type, url){
    try{
      if (!window.currentDeal) return;
      const now = Date.now();
      if (!window.currentDeal._shareHistory) window.currentDeal._shareHistory = [];
      window.currentDeal._shareHistory.unshift({ type, url, ts: now });
      window.currentDeal._shareHistory = window.currentDeal._shareHistory.slice(0, 8);
      if (typeof saveDealsToStorage === 'function') saveDealsToStorage();
      if (typeof populateDetailView === 'function') populateDetailView();
    } catch(e){}
  }

  function gdRenderShareHistory(){
    const list = $('shareHistoryList');
    const wrap = $('shareHistoryWrap');
    if (!list || !wrap) return;

    const items = (window.currentDeal && window.currentDeal._shareHistory) ? window.currentDeal._shareHistory : [];
    if (!items.length){
      list.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem;">No links saved yet. Copy a link to add it here.</div>';
      return;
    }

    list.innerHTML = '';
    for (const it of items){
      const dt = new Date(it.ts || Date.now());
      const label = it.type === 'iso' ? 'ISO Link' : 'Merchant Link';
      const meta = dt.toLocaleString();
      const row = document.createElement('div');
      row.className = 'gd-share-history-item';
      row.innerHTML = `
        <div class="gd-share-history-meta">
          <div class="t1">${label}</div>
          <div class="t2">${meta}</div>
        </div>
        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn-secondary" style="padding: 8px 14px;" data-action="open">Open</button>
          <button class="btn-secondary" style="padding: 8px 14px;" data-action="copy">Copy</button>
        </div>
      `;
      row.querySelector('[data-action="open"]').addEventListener('click', () => window.open(it.url, '_blank'));
      row.querySelector('[data-action="copy"]').addEventListener('click', () => gdCopyToClipboard(it.url, 'Link copied'));
      list.appendChild(row);
    }
  }

  // Public functions for HTML onclick handlers
  window.openApprovalShareModal = function(){
    if (!window.currentDeal){
      showToast('No deal selected', 'Open a deal to share an approval.');
      return;
    }

    // Prefill from deal
    if ($('shareBusinessName')) $('shareBusinessName').value = window.currentDeal.businessName || '';
    if ($('shareContactName')) $('shareContactName').value = window.currentDeal.ownerName || '';
    if ($('shareContactEmail')) $('shareContactEmail').value = window.currentDeal.ownerEmail || '';
    if ($('shareContactPhone')) $('shareContactPhone').value = window.currentDeal.ownerPhone || '';

    gdLoadShareDefaults();

    // Init checkboxes default (keep existing user choice if present)
    if ($('shareOptConservative') && $('shareOptConservative').checked == null) $('shareOptConservative').checked = true;
    if ($('shareOptModerate') && $('shareOptModerate').checked == null) $('shareOptModerate').checked = true;
    if ($('shareOptAggressive') && $('shareOptAggressive').checked == null) $('shareOptAggressive').checked = true;

    gdRefreshShareLinks();
    gdRenderShareHistory();

    $('approvalShareModal')?.classList.add('active');
  };

  window.closeApprovalShareModal = function(){
    $('approvalShareModal')?.classList.remove('active');
  };

  window.gdCopyShareLink = function(type){
    gdRefreshShareLinks();
    const url = type === 'iso' ? $('shareIsoLink')?.value : $('shareClientLink')?.value;
    gdCopyToClipboard(url, (type === 'iso' ? 'ISO link copied' : 'Merchant link copied'));
    gdRecordShare(type === 'iso' ? 'iso' : 'client', url);
    gdRenderShareHistory();
  };

  window.gdPreviewShare = function(type){
    gdRefreshShareLinks();
    const url = type === 'iso' ? $('shareIsoLink')?.value : $('shareClientLink')?.value;
    if (!url) { showToast('No link', 'Generate the link first.'); return; }
    window.open(url, '_blank');
  };

  window.gdCopyShareSMS = function(){
    gdRefreshShareLinks();
    const f = gdGetShareFormData();
    const url = $('shareClientLink')?.value || '';
    const cfg = gdOfferCfg();
    const opts = gdGetOfferOptions({mode:'client', maxSellDelta: f.maxSellDelta});
    const first = opts[0];
    let summary = '';
    if (first){
      const payback = first.a * first.f;
      const termDays = first.t;
      const freq = first.q === 'daily' ? 'daily' : 'weekly';
      const count = first.q === 'daily' ? termDays : Math.ceil(termDays/5);
      const payment = payback / count;
      summary = `${first.l}: ${gdMoney(first.a)} / ${gdMoney(payment)} ${freq} / ${termDays}d`;
    }
    const msg = `Funding approval for ${f.businessName || 'your business'}.\n${summary}\nView offer: ${url}`;
    gdCopyToClipboard(msg, 'SMS text copied');
  };

  window.gdOpenShareEmail = function(){
    gdRefreshShareLinks();
    const f = gdGetShareFormData();
    const url = $('shareClientLink')?.value || '';
    const to = encodeURIComponent(f.contactEmail || '');
    const subject = encodeURIComponent(`Funding approval for ${f.businessName || 'your business'}`);
    const bodyLines = [
      `Hello${f.contactName ? ' ' + f.contactName : ''},`,
      ``,
      `Your business ${f.businessName || ''} has been pre-approved for funding.`,
      `View your offer options here:`,
      url,
      ``,
      (f.senderName || f.senderEmail || f.senderPhone) ? `Questions? Reply here or contact ${[f.senderName, f.senderPhone, f.senderEmail].filter(Boolean).join('  ')}.` : '',
      ``,
      ``
    ].filter(Boolean);
    const body = encodeURIComponent(bodyLines.join('\n'));
    const href = `mailto:${to}?subject=${subject}&body=${body}`;
    window.location.href = href;
  };

  // Auto refresh links when fields change (modal)
  function gdInitShareModalListeners(){
    const ids = [
      'shareBusinessName','shareContactName','shareContactEmail','shareContactPhone',
      'shareBrandName','shareBrandLogo','shareBrandAccent','shareExpiry',
      'shareSenderName','shareSenderEmail','shareSenderPhone','shareISOName',
      'shareMaxSellDelta','shareShowFactor',
      'shareOptConservative','shareOptModerate','shareOptAggressive'
    ];
    ids.forEach(id => {
      const el = $(id);
      if (!el) return;
      const evt = (el.type === 'checkbox' || el.tagName === 'SELECT') ? 'change' : 'input';
      el.addEventListener(evt, () => {
        gdRefreshShareLinks();
      });
    });

    // Clicking outside modal closes it
    const modal = $('approvalShareModal');
    if (modal){
      modal.addEventListener('click', (e) => {
        if (e.target === modal) window.closeApprovalShareModal();
      });
    }
  }

  // -------------------------
  // SHARE MODE (Client / ISO)
  // -------------------------
  let gdShareData = null;
  let gdShareIsIso = false;
  let gdShareActiveIdx = 0;
  let gdClientAction = 'accept';

  function gdApplyBranding(data){
    const overlay = $('gdShareOverlay');
    if (!overlay) return;

    const accent = (data && data.ac) ? data.ac : (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#eab308');
    overlay.style.setProperty('--accent', accent);

    // Glow derived from accent (simple)
    overlay.style.setProperty('--glow-gold', 'rgba(234,179,8,0.25)');
  }

  function gdSetShareHeader(data){
    const company = $('gdShareCompanyName');
    const logo = $('gdShareLogo');
    const modeLabel = $('gdShareModeLabel');
    if (company) company.textContent = (data.cn || data.iso || 'Approval');
    if (modeLabel) modeLabel.textContent = gdShareIsIso ? 'ISO Calculator' : 'Funding Approval';

    if (logo){
      if (data.logo){
        logo.src = data.logo;
        logo.classList.remove('hidden');
      } else {
        logo.classList.add('hidden');
      }
    }
  }

  function gdRenderShareTabs(data){
    const tabs = $('gdShareTabs');
    if (!tabs) return;
    tabs.innerHTML = '';
    const opts = data.o || [];
    opts.forEach((opt, idx) => {
      const btn = document.createElement('button');
      btn.className = 'gd-share-tab' + (idx === gdShareActiveIdx ? ' active' : '');
      btn.textContent = opt.l || `Option ${idx+1}`;
      btn.addEventListener('click', () => {
        gdShareActiveIdx = idx;
        gdRenderShare();
      });
      tabs.appendChild(btn);
    });
  }

  function gdCalcMetrics(opt){
    const amount = Number(opt.a || 0);
    const factor = Number(opt.f || opt.bf || 1);
    const payback = amount * factor;
    const termDays = Number(opt.t || 0);
    const q = opt.q || 'daily';
    let count = termDays;
    if (q !== 'daily') count = Math.ceil(termDays / 5);
    const payment = count ? (payback / count) : 0;
    return { amount, factor, payback, termDays, q, count, payment };
  }

  function gdRenderShare(){
    const data = gdShareData;
    if (!data) return;

    const opts = data.o || [];
    const opt = opts[gdShareActiveIdx] || opts[0];
    if (!opt) return;

    gdApplyBranding(data);
    gdSetShareHeader(data);
    gdRenderShareTabs(data);

    $('gdShareGreeting').textContent = gdShareIsIso
      ? `Hello${data.iso ? ' ' + data.iso : ''}`
      : `Hello${data.c ? ' ' + data.c : ''}`;

    $('gdShareBusiness').textContent = data.b || 'your business';

    if (data.ex){
      $('gdShareExpiryWrap')?.classList.remove('hidden');
      $('gdShareExpiry').textContent = data.ex;
    } else {
      $('gdShareExpiryWrap')?.classList.add('hidden');
    }

    // Metrics
    const m = gdCalcMetrics(opt);
    $('gdShareAmount').textContent = gdMoney(m.amount);
    $('gdSharePayback').textContent = gdMoney(m.payback);

    const showFactor = data.sf !== 0;
    if (showFactor){
      $('gdShareFactorWrap')?.classList.remove('hidden');
      $('gdShareFactor').textContent = (m.factor ? m.factor.toFixed(2) : '1.00') + 'x';
    } else {
      $('gdShareFactorWrap')?.classList.add('hidden');
    }

    $('gdShareTerm').textContent = m.termDays + ' days';
    $('gdSharePaymentLabel').textContent = (m.q === 'daily' ? 'Daily Payment' : 'Weekly Payment');
    $('gdShareCountLabel').textContent = (m.q === 'daily' ? '# of Payments' : '# of Weeks');
    $('gdSharePayment').textContent = gdMoney(m.payment);
    $('gdShareCount').textContent = String(m.count);

    // Contact info
    const contactParts = [];
    const snd = data.snd || {};
    if (snd.n) contactParts.push(`<strong style="color: var(--text-primary);">${snd.n}</strong>`);
    if (snd.p) contactParts.push(snd.p);
    if (snd.e) contactParts.push(snd.e);
    const contactHtml = contactParts.length
      ? `Questions? Contact ${contactParts.join('  ')}.`
      : `Questions? Contact your representative.`;
    $('gdShareContactInfo').innerHTML = contactHtml;

    // ISO panel
    if (gdShareIsIso){
      $('gdIsoPanel')?.classList.remove('hidden');
      $('gdClientActions')?.classList.add('hidden');
      $('gdShareBackBtn')?.classList.remove('hidden');

      // Setup slider bounds based on bf/mf
      const bf = Number(opt.bf || opt.f || 1.0);
      const mf = Number(opt.mf || opt.f || 1.0);
      const slider = $('gdIsoFactorSlider');
      if (slider){
        slider.min = bf.toFixed(2);
        slider.max = mf.toFixed(2);
        slider.step = '0.01';
        slider.value = Number(opt.f || mf).toFixed(2);
      }
      $('gdIsoBuyFactor').textContent = bf.toFixed(2) + 'x';
      $('gdIsoMaxFactor').textContent = mf.toFixed(2) + 'x';
      $('gdIsoSellFactor').textContent = Number(opt.f || mf).toFixed(2) + 'x';

      const sell = Number(opt.f || mf);
      const spread = (sell - bf) * m.amount;
      $('gdIsoSpread').textContent = gdMoney(spread);
      $('gdIsoSpreadPct').textContent = (m.amount ? ((spread / m.amount) * 100).toFixed(1) : '0.0') + '%';

      // Commission estimate (optional) using commission% + points from link data
      const commPct = Number(data.ic || 0);
      const points = Number(data.ip || 0);
      const commAmt = m.amount * (commPct/100);
      const pointsAmt = m.amount * (points/10000);
      $('gdIsoComm').textContent = gdMoney(commAmt + pointsAmt);

      // Load ISO brand defaults for merchant re-share
      if ($('gdIsoBrandName') && !$('gdIsoBrandName').dataset.touched){
        $('gdIsoBrandName').value = (localStorage.getItem(GD_SHARE_KEYS.isoBrandName) || data.cn || '');
      }
      if ($('gdIsoBrandLogo') && !$('gdIsoBrandLogo').dataset.touched){
        $('gdIsoBrandLogo').value = (localStorage.getItem(GD_SHARE_KEYS.isoBrandLogo) || data.logo || '');
      }

      gdIsoUpdateMerchantLink();
    } else {
      $('gdIsoPanel')?.classList.add('hidden');
      $('gdClientActions')?.classList.remove('hidden');
      $('gdShareBackBtn')?.classList.add('hidden');
    }
  }

  function gdIsoUpdateMerchantLink(){
    const linkEl = $('gdIsoMerchantLink');
    if (!gdShareData || !gdShareIsIso || !linkEl) return;

    const brandName = ($('gdIsoBrandName')?.value || '').trim();
    const brandLogo = ($('gdIsoBrandLogo')?.value || '').trim();

    // Persist ISO brand fields
    try{
      if ($('gdIsoBrandName')) localStorage.setItem(GD_SHARE_KEYS.isoBrandName, brandName);
      if ($('gdIsoBrandLogo')) localStorage.setItem(GD_SHARE_KEYS.isoBrandLogo, brandLogo);
    } catch(e){}

    // Build client payload from ISO payload + chosen sell factors
    const clientData = JSON.parse(JSON.stringify(gdShareData || {}));
    clientData.m = 'client';
    clientData.cn = brandName || clientData.cn;
    clientData.logo = brandLogo || clientData.logo;
    // strip buy/max factors
    clientData.o = (clientData.o || []).map(op => ({ k: op.k, l: op.l, a: op.a, t: op.t, q: op.q, f: op.f }));
    const link = gdBuildLink(clientData, false);
    linkEl.value = link;
  }

  // Public ISO functions
  window.gdIsoCopyMerchantLink = function(){
    gdIsoUpdateMerchantLink();
    const url = $('gdIsoMerchantLink')?.value || '';
    gdCopyToClipboard(url, 'Merchant link copied');
  };

  window.gdIsoCopySMS = function(){
    gdIsoUpdateMerchantLink();
    const url = $('gdIsoMerchantLink')?.value || '';
    const data = gdShareData || {};
    const msg = `Funding approval for ${data.b || 'your business'}.\nView offer: ${url}`;
    gdCopyToClipboard(msg, 'SMS text copied');
  };

  window.gdIsoOpenEmail = function(){
    gdIsoUpdateMerchantLink();
    const url = $('gdIsoMerchantLink')?.value || '';
    const data = gdShareData || {};
    const to = encodeURIComponent(data.em || '');
    const subject = encodeURIComponent(`Funding approval for ${data.b || 'your business'}`);
    const body = encodeURIComponent([
      `Hello${data.c ? ' ' + data.c : ''},`,
      ``,
      `Your business ${data.b || ''} has been pre-approved for funding.`,
      `View your offer options here:`,
      url,
      ``,
      ``
    ].join('\n'));
    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
  };

  // Slider changes
  function gdAttachIsoSlider(){
    const slider = $('gdIsoFactorSlider');
    if (!slider) return;
    slider.addEventListener('input', () => {
      if (!gdShareData || !gdShareIsIso) return;
      const opt = (gdShareData.o || [])[gdShareActiveIdx];
      if (!opt) return;
      opt.f = gdSafeParseFloat(slider.value, opt.f || opt.mf || opt.bf || 1);
      $('gdIsoSellFactor').textContent = Number(opt.f).toFixed(2) + 'x';
      gdRenderShare(); // re-render updates metrics and merchant link
    });
  }

  // Client accept/decline (mailto)
  window.gdClientRespond = function(action){
    gdClientAction = action === 'decline' ? 'decline' : 'accept';
    const t = gdClientAction === 'accept' ? 'Accept Offer' : 'Decline Offer';
    $('gdClientActionTitle').textContent = t;
    $('gdClientActionSubtitle').textContent = 'This will open your email client with a prefilled response.';
    $('gdClientActionModal')?.classList.add('active');

    // Prefill
    if ($('gdClientRespName') && !$('gdClientRespName').value) $('gdClientRespName').value = (gdShareData?.c || '');
    if ($('gdClientRespEmail') && !$('gdClientRespEmail').value) $('gdClientRespEmail').value = (gdShareData?.em || '');
  };

  window.gdCloseClientActionModal = function(){
    $('gdClientActionModal')?.classList.remove('active');
  };

  function gdBuildClientResponseText(){
    const data = gdShareData || {};
    const opts = data.o || [];
    const opt = opts[gdShareActiveIdx] || opts[0];
    const m = opt ? gdCalcMetrics(opt) : { amount:0, factor:0, payback:0, termDays:0, q:'daily', count:0, payment:0 };

    const name = ($('gdClientRespName')?.value || '').trim();
    const email = ($('gdClientRespEmail')?.value || '').trim();
    const msg = ($('gdClientRespMsg')?.value || '').trim();

    const lines = [
      `Response: ${gdClientAction.toUpperCase()}`,
      `Business: ${data.b || ''}`,
      `Contact: ${name || data.c || ''}`,
      email ? `Email: ${email}` : '',
      ``,
      `Selected Option: ${opt?.l || ''}`,
      `Funding Amount: ${gdMoney(m.amount)}`,
      `Total Payback: ${gdMoney(m.payback)}`,
      (data.sf !== 0) ? `Factor: ${(m.factor||0).toFixed(2)}x` : '',
      `Term: ${m.termDays} days`,
      `${m.q === 'daily' ? 'Daily' : 'Weekly'} Payment: ${gdMoney(m.payment)}`,
      `${m.q === 'daily' ? '# of Payments' : '# of Weeks'}: ${m.count}`,
      msg ? `` : '',
      msg ? `Message: ${msg}` : ''
    ].filter(Boolean);

    return lines.join('\n');
  }

  window.gdCopyClientResponse = function(){
    const text = gdBuildClientResponseText();
    gdCopyToClipboard(text, 'Response copied');
  };

  window.gdSendClientResponse = function(){
    const data = gdShareData || {};
    const snd = data.snd || {};
    const to = encodeURIComponent(snd.e || '');
    const subject = encodeURIComponent(`${gdClientAction === 'accept' ? 'Offer Accepted' : 'Offer Declined'} - ${data.b || ''}`);
    const body = encodeURIComponent(gdBuildClientResponseText());
    if (!snd.e){
      gdCopyToClipboard(gdBuildClientResponseText(), 'Response copied (no sender email provided)');
      showToast('Sender email missing', 'Copied response instead.');
      return;
    }
    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
    showToast('Opening email', 'A draft response is ready to send.');
    $('gdClientActionModal')?.classList.remove('active');
  };

  window.gdSharePrint = function(){ window.print(); };

  window.gdShareBackToEditor = function(){ window.location.href = gdBaseUrl(); };

  // Enter share mode if URL has data
  function gdCheckShareModeOnLoad(){
    const params = new URLSearchParams(window.location.search);
    const d = params.get('d');
    
    // Check for shared profile link first
    const sp = params.get('sp');
    if (sp) {
      checkSharedProfileOnLoad(sp);
      return;
    }
    
    if (!d) return;

    // Bypass login overlay for share links
    $('loginOverlay')?.classList.add('hidden');

    const data = gdDecode(d);
    if (!data){
      showToast('Invalid link', 'Could not decode share data.');
      return;
    }

    gdShareData = data;
    gdShareIsIso = params.get('iso') === '1';

    // Hide main app UI
    document.querySelector('.main-header')?.classList.add('hidden');
    document.querySelector('.app-container')?.classList.add('hidden');

    // Show share overlay
    const overlay = $('gdShareOverlay');
    overlay?.classList.remove('hidden');

    // ISO brand input listeners
    $('gdIsoBrandName')?.addEventListener('input', (e) => { e.target.dataset.touched = '1'; gdIsoUpdateMerchantLink(); });
    $('gdIsoBrandLogo')?.addEventListener('input', (e) => { e.target.dataset.touched = '1'; gdIsoUpdateMerchantLink(); });

    // Close response modal when clicking backdrop
    $('gdClientActionModal')?.addEventListener('click', (e) => { if (e.target === $('gdClientActionModal')) $('gdClientActionModal').classList.remove('active'); });

    gdAttachIsoSlider();
    gdRenderShare();
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    gdInitShareModalListeners();
    gdCheckShareModeOnLoad();
  });

})();

// ==================== SHARE PROFILE FUNCTIONS ====================

function openShareProfileModal() {
  if (!currentDeal) {
    showToast('Select a deal first', 'warning');
    return;
  }
  
  document.getElementById('shareProfileBusinessName').textContent = currentDeal.businessName || 'Business';
  document.getElementById('shareProfileOwnerName').textContent = currentDeal.ownerName ? `Owner: ${currentDeal.ownerName}` : '';
  document.getElementById('shareProfileLinkSection').style.display = 'none';
  document.getElementById('shareProfileModal').classList.add('active');
}

function closeShareProfileModal() {
  document.getElementById('shareProfileModal').classList.remove('active');
}

function generateShareProfileLink() {
  if (!currentDeal) return;
  
  // Build share data based on checkboxes
  const shareData = {
    v: 1, // version
    ts: Date.now(),
    business: {},
    owner: {},
    financials: [],
    score: null,
    research: null,
    credit: null
  };
  
  if (document.getElementById('shareIncludeBusiness').checked) {
    shareData.business = {
      name: currentDeal.businessName || '',
      dba: currentDeal.dba || '',
      industry: currentDeal.industry || '',
      tib: currentDeal.tib || '',
      address: currentDeal.address || '',
      stateCode: currentDeal.stateCode || '',
      entityType: currentDeal.entityType || '',
      entityStatus: currentDeal.entityStatus || '',
      phone: currentDeal.phone || '',
      website: currentDeal.website || ''
    };
  }
  
  if (document.getElementById('shareIncludeOwner').checked) {
    shareData.owner = {
      name: currentDeal.ownerName || '',
      email: currentDeal.ownerEmail || '',
      phone: currentDeal.ownerPhone || '',
      ownership: currentDeal.ownership || ''
    };
  }
  
  if (document.getElementById('shareIncludeFinancials').checked && currentDeal.financials?.length) {
    shareData.financials = currentDeal.financials.slice(0, 6); // Last 6 months
  }
  
  if (document.getElementById('shareIncludeScore').checked) {
    shareData.score = {
      value: currentDeal.score || 0,
      tier: currentDeal.tier || 'c',
      fico: currentDeal.fico || 0
    };
  }
  
  if (document.getElementById('shareIncludeResearch').checked && currentDeal.deepResearch) {
    shareData.research = {
      risk: currentDeal.deepResearch.risk_rating || '',
      confidence: currentDeal.deepResearch.confidence || 0,
      redFlags: currentDeal.deepResearch.red_flags || []
    };
  }
  
  if (document.getElementById('shareIncludeCredit').checked && currentDeal.credit_report) {
    const cr = currentDeal.credit_report;
    shareData.credit = {
      fico: cr.scores?.fico || 0,
      totalAccounts: cr.summary?.total_accounts || 0,
      openAccounts: cr.summary?.open_accounts || 0,
      totalBalance: cr.summary?.total_balance || 0,
      utilization: cr.summary?.credit_utilization || 0
    };
  }
  
  // Compress and encode
  const jsonStr = JSON.stringify(shareData);
  const encoded = btoa(encodeURIComponent(jsonStr));
  
  // Generate URL
  const baseUrl = window.location.origin + window.location.pathname;
  const shareUrl = `${baseUrl}?sp=${encoded}`;
  
  document.getElementById('shareProfileLinkInput').value = shareUrl;
  document.getElementById('shareProfileLinkSection').style.display = 'block';
  
  showToast('Link Generated', 'success');
}

function copyShareProfileLink() {
  const input = document.getElementById('shareProfileLinkInput');
  input.select();
  document.execCommand('copy');
  showToast('Link Copied!', 'success');
}

function checkSharedProfileOnLoad(encodedData) {
  try {
    const jsonStr = decodeURIComponent(atob(encodedData));
    const data = JSON.parse(jsonStr);
    
    if (!data || data.v !== 1) {
      showToast('Invalid share link', 'error');
      return;
    }
    
    // Bypass login
    document.getElementById('loginOverlay')?.classList.add('hidden');
    
    // Hide main app
    document.querySelector('.main-header')?.classList.add('hidden');
    document.querySelector('.app-container')?.classList.add('hidden');
    
    // Show shared profile view
    const view = document.getElementById('sharedProfileView');
    view.classList.remove('hidden');
    
    renderSharedProfile(data);
    
  } catch (e) {
    console.error('Error parsing share data:', e);
    showToast('Invalid share link', 'error');
  }
}

function renderSharedProfile(data) {
  // Timestamp
  const date = new Date(data.ts);
  document.getElementById('spTimestamp').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
  
  // Business name
  document.getElementById('spBusinessName').textContent = data.business?.name || 'Business Profile';
  
  // Score banner
  if (data.score) {
    const tierColors = { a: '#22c55e', b: '#84cc16', c: '#eab308', d: '#f97316', e: '#ef4444' };
    const tierLabels = { a: 'Excellent', b: 'Good', c: 'Fair', d: 'Poor', e: 'High Risk' };
    const tier = data.score.tier || 'c';
    const color = tierColors[tier] || tierColors.c;
    
    document.getElementById('spScoreCircle').textContent = data.score.value || '--';
    document.getElementById('spScoreCircle').style.background = color;
    document.getElementById('spScoreCircle').style.color = tier === 'c' ? '#000' : '#fff';
    document.getElementById('spScoreLabel').textContent = tierLabels[tier] || 'Fair';
    document.getElementById('spFico').textContent = data.score.fico || '--';
  } else {
    document.getElementById('spScoreBanner').style.display = 'none';
  }
  
  // Business info
  if (data.business && Object.keys(data.business).some(k => data.business[k])) {
    const b = data.business;
    document.getElementById('spBusinessInfo').innerHTML = `
      <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        Business Information
      </div>
      <div style="display: grid; gap: 8px; font-size: 0.85rem;">
        ${b.name ? `<div><span style="color: var(--text-muted);">Legal Name:</span> ${b.name}</div>` : ''}
        ${b.dba ? `<div><span style="color: var(--text-muted);">DBA:</span> ${b.dba}</div>` : ''}
        ${b.industry ? `<div><span style="color: var(--text-muted);">Industry:</span> ${b.industry}</div>` : ''}
        ${b.tib ? `<div><span style="color: var(--text-muted);">Time in Business:</span> ${b.tib}</div>` : ''}
        ${b.address ? `<div><span style="color: var(--text-muted);">Address:</span> ${b.address}</div>` : ''}
        ${b.entityType ? `<div><span style="color: var(--text-muted);">Entity Type:</span> ${b.entityType}</div>` : ''}
        ${b.entityStatus ? `<div><span style="color: var(--text-muted);">Status:</span> ${b.entityStatus}</div>` : ''}
        ${b.phone ? `<div><span style="color: var(--text-muted);">Phone:</span> ${b.phone}</div>` : ''}
        ${b.website ? `<div><span style="color: var(--text-muted);">Website:</span> ${b.website}</div>` : ''}
      </div>
    `;
  } else {
    document.getElementById('spBusinessInfo').style.display = 'none';
  }
  
  // Owner info
  if (data.owner && Object.keys(data.owner).some(k => data.owner[k])) {
    const o = data.owner;
    document.getElementById('spOwnerInfo').innerHTML = `
      <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Owner Information
      </div>
      <div style="display: grid; gap: 8px; font-size: 0.85rem;">
        ${o.name ? `<div><span style="color: var(--text-muted);">Name:</span> ${o.name}</div>` : ''}
        ${o.email ? `<div><span style="color: var(--text-muted);">Email:</span> ${o.email}</div>` : ''}
        ${o.phone ? `<div><span style="color: var(--text-muted);">Phone:</span> ${o.phone}</div>` : ''}
        ${o.ownership ? `<div><span style="color: var(--text-muted);">Ownership:</span> ${o.ownership}%</div>` : ''}
      </div>
    `;
  } else {
    document.getElementById('spOwnerInfo').style.display = 'none';
  }
  
  // Financials
  if (data.financials && data.financials.length > 0) {
    const fmtCurrency = (v) => '$' + (parseFloat(v) || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    let rows = data.financials.map(f => `
      <tr>
        <td style="padding: 8px 12px;">${f.month || '--'}</td>
        <td style="padding: 8px 12px; color: var(--tier-a);">${fmtCurrency(f.revenue)}</td>
        <td style="padding: 8px 12px; color: var(--tier-b);">${fmtCurrency(f.deposits)}</td>
        <td style="padding: 8px 12px; color: var(--tier-d);">${fmtCurrency(f.withdrawals)}</td>
        <td style="padding: 8px 12px;">${fmtCurrency(f.endingBalance)}</td>
      </tr>
    `).join('');
    
    document.getElementById('spFinancials').innerHTML = `
      <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Monthly Financials
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
          <thead>
            <tr style="background: var(--bg-tertiary);">
              <th style="padding: 8px 12px; text-align: left;">Month</th>
              <th style="padding: 8px 12px; text-align: left;">Revenue</th>
              <th style="padding: 8px 12px; text-align: left;">Deposits</th>
              <th style="padding: 8px 12px; text-align: left;">Withdrawals</th>
              <th style="padding: 8px 12px; text-align: left;">Ending Bal</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  } else {
    document.getElementById('spFinancials').style.display = 'none';
  }
  
  // Research
  if (data.research) {
    const r = data.research;
    document.getElementById('spResearch').style.display = 'block';
    let flagsHtml = r.redFlags?.length ? r.redFlags.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('') : '<li>No red flags identified</li>';
    document.getElementById('spResearch').innerHTML = `
      <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Deep Research Summary
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
        <div><span style="color: var(--text-muted);">Risk Rating:</span> <strong>${r.risk || 'N/A'}</strong></div>
        <div><span style="color: var(--text-muted);">Confidence:</span> <strong>${r.confidence || 0}%</strong></div>
      </div>
      <div style="font-weight: 500; margin-bottom: 8px;">Red Flags:</div>
      <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);">${flagsHtml}</ul>
    `;
  }
  
  // Credit
  if (data.credit) {
    const c = data.credit;
    document.getElementById('spCredit').style.display = 'block';
    const fmtCurrency = (v) => '$' + (parseFloat(v) || 0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    document.getElementById('spCredit').innerHTML = `
      <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Credit Summary
      </div>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; font-size: 0.85rem;">
        <div><span style="color: var(--text-muted);">FICO Score:</span><div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">${c.fico || '--'}</div></div>
        <div><span style="color: var(--text-muted);">Total Accounts:</span><div style="font-size: 1.1rem; font-weight: 600;">${c.totalAccounts || 0}</div></div>
        <div><span style="color: var(--text-muted);">Total Balance:</span><div style="font-size: 1.1rem; font-weight: 600;">${fmtCurrency(c.totalBalance)}</div></div>
        <div><span style="color: var(--text-muted);">Utilization:</span><div style="font-size: 1.1rem; font-weight: 600;">${c.utilization || 0}%</div></div>
      </div>
    `;
  }
}

function printSharedProfile() {
  window.print();
}

function generateShareLink() {
  // Open existing share modal if available
  if (typeof gdOpenShareModal === 'function') {
    gdOpenShareModal();
  } else {
    openShareProfileModal();
  }
}

</script>

<!-- KEYBOARD SHORTCUTS MODAL -->
<div class="modal-overlay" id="shortcutsModal">
  <div class="modal" style="max-width: 550px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Keyboard Shortcuts</div>
        <div class="modal-subtitle">Speed up your workflow</div>
      </div>
      <button class="modal-close" onclick="closeShortcutsModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="shortcuts-grid">
        <div class="shortcut-item"><span class="shortcut-key">N</span><span class="shortcut-desc">New Deal</span></div>
        <div class="shortcut-item"><span class="shortcut-key">/</span><span class="shortcut-desc">Focus Search</span></div>
        <div class="shortcut-item"><span class="shortcut-key">Esc</span><span class="shortcut-desc">Back / Close</span></div>
        <div class="shortcut-item"><span class="shortcut-key">S</span><span class="shortcut-desc">Save Deal</span></div>
        <div class="shortcut-item"><span class="shortcut-key">D</span><span class="shortcut-desc">Dashboard</span></div>
        <div class="shortcut-item"><span class="shortcut-key">A</span><span class="shortcut-desc">Analytics</span></div>
        <div class="shortcut-item"><span class="shortcut-key">R</span><span class="shortcut-desc">Renewals</span></div>
        <div class="shortcut-item"><span class="shortcut-key">T</span><span class="shortcut-desc">Team</span></div>
        <div class="shortcut-item"><span class="shortcut-key">P</span><span class="shortcut-desc">Export PDF</span></div>
        <div class="shortcut-item"><span class="shortcut-key">?</span><span class="shortcut-desc">Show Shortcuts</span></div>
        <div class="shortcut-item"><span class="shortcut-key">Ctrl+A</span><span class="shortcut-desc">Select All Deals</span></div>
        <div class="shortcut-item"><span class="shortcut-key">Del</span><span class="shortcut-desc">Delete Selected</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ANALYTICS MODAL -->
<div class="modal-overlay" id="analyticsModal">
  <div class="modal" style="max-width: 1000px; width: 95%;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Performance Analytics</div>
        <div class="modal-subtitle">Funding volume, approval rates, and ISO performance</div>
      </div>
      <button class="modal-close" onclick="closeAnalyticsModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
      <div class="analytics-grid">
        <div class="analytics-card">
          <div class="analytics-label">Total Funded</div>
          <div class="analytics-value text-positive" id="analyticsTotalFunded">$0</div>
          <div class="analytics-change up" id="analyticsFundedChange">+0% vs last month</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Deals Funded</div>
          <div class="analytics-value" id="analyticsDealsCount">0</div>
          <div class="analytics-change" id="analyticsDealsChange">0 this month</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Approval Rate</div>
          <div class="analytics-value text-accent" id="analyticsApprovalRate">0%</div>
          <div class="analytics-change" id="analyticsApprovalChange">of submitted deals</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Avg Deal Size</div>
          <div class="analytics-value" id="analyticsAvgDeal">$0</div>
          <div class="analytics-change" id="analyticsAvgChange">average funding</div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-title">Funding Volume Over Time</div>
          <div class="chart-filters">
            <button class="chart-filter active" onclick="setAnalyticsRange('7d')">7D</button>
            <button class="chart-filter" onclick="setAnalyticsRange('30d')">30D</button>
            <button class="chart-filter" onclick="setAnalyticsRange('90d')">90D</button>
            <button class="chart-filter" onclick="setAnalyticsRange('1y')">1Y</button>
          </div>
        </div>
        <div style="height: 250px;"><canvas id="analyticsVolumeChart"></canvas></div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="chart-container" style="margin-bottom: 0;">
          <div class="chart-title" style="margin-bottom: 12px;">Approval by Industry</div>
          <div style="height: 200px;"><canvas id="analyticsIndustryChart"></canvas></div>
        </div>
        <div class="chart-container" style="margin-bottom: 0;">
          <div class="chart-title" style="margin-bottom: 12px;">ISO Performance</div>
          <div id="analyticsISOList" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- TEAM MANAGEMENT MODAL -->
<div class="modal-overlay" id="teamModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Team Management</div>
        <div class="modal-subtitle">Manage users, roles, and permissions</div>
      </div>
      <button class="modal-close" onclick="closeTeamModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="font-weight: 700;">Team Members</div>
        <button class="btn-primary" onclick="openAddTeamMember()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Member
        </button>
      </div>
      <div id="teamMembersList"></div>
      
      <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-secondary);">
        <div style="font-weight: 700; margin-bottom: 12px;">Pending Approvals</div>
        <div id="pendingApprovalsList"></div>
      </div>
    </div>
  </div>
</div>

<!-- RENEWALS MODAL -->
<div class="modal-overlay" id="renewalsModal">
  <div class="modal" style="max-width: 900px; width: 95%;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Portfolio & Renewals</div>
        <div class="modal-subtitle">Track funded deals and renewal opportunities</div>
      </div>
      <button class="modal-close" onclick="closeRenewalsModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
      <div class="analytics-grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="analytics-card">
          <div class="analytics-label">Active Positions</div>
          <div class="analytics-value" id="renewalActiveCount">0</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Ready to Renew</div>
          <div class="analytics-value text-positive" id="renewalRTRCount">0</div>
        </div>
        <div class="analytics-card">
          <div class="analytics-label">Total Outstanding</div>
          <div class="analytics-value text-accent" id="renewalOutstanding">$0</div>
        </div>
      </div>
      <div id="renewalsList"></div>
    </div>
  </div>
</div>

<!-- CREDIT PULL MODAL -->
<div class="modal-overlay" id="creditPullModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Credit Data</div>
        <div class="modal-subtitle" id="creditPullSubtitle">Pull via API or upload credit report</div>
      </div>
      <button class="modal-close" onclick="closeCreditPullModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <!-- Mode Tabs -->
      <div style="display: flex; gap: 8px; margin-bottom: 20px;">
        <button class="btn-secondary" id="creditModeApi" onclick="setCreditMode('api')" style="flex: 1; justify-content: center;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 12a9 9 0 11-9-9"/><path d="M21 3v9h-9"/></svg>
          API Pull
        </button>
        <button class="btn-primary" id="creditModeUpload" onclick="setCreditMode('upload')" style="flex: 1; justify-content: center;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Upload Report
        </button>
      </div>
      
      <!-- API Mode -->
      <div id="creditPullApiMode" style="display: none;">
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 0.85rem; color: var(--accent-blue);">
            <strong>API Integration</strong><br>
            <span style="font-size: 0.8rem; color: var(--text-secondary);">Configure your bureau API credentials in Settings  Integrations</span>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label class="form-label">First Name</label>
            <input type="text" class="form-input" id="creditFirstName" placeholder="John">
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">Last Name</label>
            <input type="text" class="form-input" id="creditLastName" placeholder="Doe">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label class="form-label">SSN</label>
            <input type="password" class="form-input" id="creditSSN" placeholder="XXX-XX-XXXX" maxlength="11">
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">DOB</label>
            <input type="date" class="form-input" id="creditDOB">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label class="form-label">Address</label>
            <input type="text" class="form-input" id="creditAddress" placeholder="123 Main St">
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">Zip Code</label>
            <input type="text" class="form-input" id="creditZip" placeholder="12345" maxlength="5">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Bureau</label>
          <select class="form-input" id="creditBureau">
            <option value="experian">Experian</option>
            <option value="equifax">Equifax</option>
            <option value="transunion">TransUnion</option>
            <option value="all">All Bureaus (Tri-Merge)</option>
          </select>
        </div>
        <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="executeCreditPull()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M9 12l2 2 4-4"/></svg>
          Pull Credit Report
        </button>
        <div style="font-size: 0.75rem; color: var(--text-muted); text-align: center; margin-top: 8px;">
          Requires bureau API credentials (Experian Connect, Equifax API, etc.)
        </div>
      </div>
      
      <!-- Upload Mode -->
      <div id="creditPullUploadMode">
        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
          <div style="font-size: 0.85rem; color: var(--tier-a);">
            <strong>Gemini Vision AI</strong><br>
            <span style="font-size: 0.8rem; color: var(--text-secondary);">Upload a credit report PDF or screenshot and AI will extract all data</span>
          </div>
        </div>
        
        <div class="dropzone" id="creditUploadZone" style="padding: 40px 20px; cursor: pointer; border: 2px dashed var(--border-primary); border-radius: 12px; text-align: center; transition: all 0.2s;" onclick="document.getElementById('creditUploadInput').click()">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 48px; height: 48px; margin: 0 auto 12px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <div style="font-weight: 600; margin-bottom: 4px;">Drop credit report here</div>
          <div style="font-size: 0.8rem; color: var(--text-muted);">PDF, PNG, JPG  Supports all major bureau formats</div>
        </div>
        <input type="file" id="creditUploadInput" style="display: none;" accept=".pdf,image/*" onchange="handleCreditUploadInModal(event)">
        
        <div id="creditUploadStatus" style="margin-top: 16px; display: none;">
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
            <div class="loading-spinner" style="width: 24px; height: 24px; border: 2px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <div>
              <div style="font-weight: 600;" id="creditUploadStatusText">Analyzing with Gemini Vision...</div>
              <div style="font-size: 0.75rem; color: var(--text-muted);">Extracting scores, tradelines, and payment history</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Results -->
      <div id="creditPullResult" class="hidden">
        <div class="credit-pull-card">
          <div class="credit-score-display">
            <div class="credit-score-value" id="creditScoreValue">---</div>
            <div class="credit-score-label" id="creditScoreLabel">FICO Score</div>
          </div>
          <div class="credit-factors" id="creditFactors"></div>
        </div>
        
        <!-- Additional Credit Data -->
        <div id="creditDetailedData" style="margin-top: 16px;"></div>
        
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button class="btn-primary" style="flex: 1;" onclick="applyCreditToDeall()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"/></svg>
            Apply to Deal
          </button>
          <button class="btn-secondary" style="flex: 1;" onclick="resetCreditPullModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Pull Another
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- DOCUMENT CHECKLIST MODAL -->
<div class="modal-overlay" id="docsModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <div>
        <div class="modal-title">Document Checklist</div>
        <div class="modal-subtitle" id="docsModalSubtitle">Required documents for underwriting</div>
      </div>
      <button class="modal-close" onclick="closeDocsModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
      <div class="doc-checklist" id="docChecklist"></div>
      <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
        <button class="btn-secondary" style="width: 100%;" onclick="addCustomDocument()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Custom Document
        </button>
      </div>
    </div>
  </div>
</div>

<!-- BATCH TOOLBAR -->
<div class="batch-toolbar hidden" id="batchToolbar">
  <span class="batch-count"><span id="batchSelectedCount">0</span> selected</span>
  <button class="btn-secondary" onclick="batchChangeStatus()">Change Status</button>
  <button class="btn-secondary" onclick="batchExport()">Export</button>
  <button class="btn-secondary" onclick="batchAssign()">Assign</button>
  <button class="btn-secondary" style="color: var(--tier-e);" onclick="batchDelete()">Delete</button>
  <button class="btn-secondary" onclick="clearBatchSelection()">Cancel</button>
</div>

<!-- ISO PORTAL MODAL -->
<div class="modal-overlay" id="isoPortalModal">
  <div class="modal" style="max-width: 900px; width: 95%;">
    <div class="modal-header">
      <div>
        <div class="modal-title">ISO Partner Portal</div>
        <div class="modal-subtitle">Submit deals and track commissions</div>
      </div>
      <button class="modal-close" onclick="closeISOPortal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" style="max-height: 75vh; overflow-y: auto;">
      <!-- Stats -->
      <div class="analytics-grid" id="isoPortalStats" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 24px;"></div>
      
      <!-- Submit New Deal -->
      <div class="card" style="margin-bottom: 24px;">
        <div class="card-title" style="margin-bottom: 16px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 18px; height: 18px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Submit New Deal
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
          <div class="form-group">
            <label class="form-label">Business Name *</label>
            <input type="text" class="form-input" id="isoBusinessName" placeholder="ABC Company LLC">
          </div>
          <div class="form-group">
            <label class="form-label">Owner Name</label>
            <input type="text" class="form-input" id="isoOwnerName" placeholder="John Doe">
          </div>
          <div class="form-group">
            <label class="form-label">Industry</label>
            <input type="text" class="form-input" id="isoIndustry" placeholder="Restaurant, Retail, etc.">
          </div>
          <div class="form-group">
            <label class="form-label">Est. FICO</label>
            <input type="number" class="form-input" id="isoFico" placeholder="650">
          </div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label class="form-label">Notes</label>
          <textarea class="form-input" id="isoNotes" rows="2" placeholder="Additional notes about the deal..."></textarea>
        </div>
        <button class="btn-primary" style="width: 100%; justify-content: center; margin-top: 16px;" onclick="submitISODeal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          Submit for Review
        </button>
      </div>
      
      <!-- Deal List -->
      <div style="font-weight: 700; margin-bottom: 12px;">Your Submitted Deals</div>
      <div id="isoPortalDeals"></div>
    </div>
  </div>
</div>

<script>
// ============================================
// FEATURE 1: PDF EXPORT
// ============================================
function generateOfferPDF() {
  if (!currentDeal) {
    alert('No deal selected.');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const data = window.currentOfferData || {};
  const avgRev = currentDeal.months?.length ? currentDeal.months.reduce((a, m) => a + m.revenue, 0) / currentDeal.months.length : 0;
  
  // Header
  doc.setFillColor(234, 179, 8);
  doc.rect(0, 0, 220, 35, 'F');
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  doc.text('FUNDING APPROVAL', 105, 20, { align: 'center' });
  doc.setFontSize(10);
  doc.text('Term Sheet', 105, 28, { align: 'center' });
  
  // Business Info
  doc.setTextColor(50, 50, 50);
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text('Business Information', 20, 50);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.text(`Business Name: ${currentDeal.businessName || 'N/A'}`, 20, 60);
  doc.text(`Owner: ${currentDeal.ownerName || 'N/A'}`, 20, 67);
  doc.text(`Industry: ${currentDeal.industry || 'N/A'}`, 20, 74);
  doc.text(`Time in Business: ${currentDeal.tib || 'N/A'}`, 120, 60);
  doc.text(`FICO Score: ${currentDeal.fico || 'N/A'}`, 120, 67);
  doc.text(`Date: ${new Date().toLocaleDateString()}`, 120, 74);
  
  // Offer Details
  doc.setFillColor(245, 245, 245);
  doc.rect(15, 85, 180, 60, 'F');
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.text('Offer Details', 20, 97);
  
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(11);
  const offerY = 107;
  doc.text('Funding Amount:', 25, offerY);
  doc.setFont('helvetica', 'bold');
  doc.text('$' + Math.round(data.fundingAmount || 0).toLocaleString(), 80, offerY);
  
  doc.setFont('helvetica', 'normal');
  doc.text('Total Payback:', 25, offerY + 10);
  doc.setFont('helvetica', 'bold');
  doc.text('$' + Math.round(data.payback || 0).toLocaleString(), 80, offerY + 10);
  
  doc.setFont('helvetica', 'normal');
  doc.text('Factor Rate:', 25, offerY + 20);
  doc.text(document.getElementById('offerFactor')?.textContent || '1.00', 80, offerY + 20);
  
  doc.text('Term:', 120, offerY);
  doc.text((data.termDays || 0) + ' days', 155, offerY);
  
  doc.text('Payment:', 120, offerY + 10);
  doc.text(document.getElementById('offerPayment')?.textContent || '$0', 155, offerY + 10);
  
  doc.text('Frequency:', 120, offerY + 20);
  doc.text(currentPaymentFrequency === 'daily' ? 'Daily' : 'Weekly', 155, offerY + 20);
  
  // Bank Summary
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(12);
  doc.text('Bank Analysis Summary', 20, 160);
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(10);
  doc.text(`Average Monthly Revenue: $${Math.round(avgRev).toLocaleString()}`, 20, 170);
  doc.text(`Total Deposits: $${Math.round(currentDeal.months?.reduce((a, m) => a + m.deposits, 0) || 0).toLocaleString()}`, 20, 177);
  doc.text(`Average Balance: $${Math.round(currentDeal.months?.reduce((a, m) => a + m.avgBalance, 0) / (currentDeal.months?.length || 1) || 0).toLocaleString()}`, 120, 170);
  doc.text(`NSF Count: ${currentDeal.months?.reduce((a, m) => a + m.nsf, 0) || 0}`, 120, 177);
  
  // Score
  doc.setFillColor(234, 179, 8);
  doc.circle(180, 200, 15, 'F');
  doc.setTextColor(0, 0, 0);
  doc.setFontSize(16);
  doc.setFont('helvetica', 'bold');
  doc.text(String(currentDeal.score || 0), 180, 203, { align: 'center' });
  doc.setFontSize(8);
  doc.text('SCORE', 180, 210, { align: 'center' });
  
  // Footer
  doc.setTextColor(100, 100, 100);
  doc.setFontSize(8);
  doc.text('This term sheet is for informational purposes only and does not constitute a binding offer.', 105, 280, { align: 'center' });
  doc.text('Generated by GREATDANE Underwriting Platform', 105, 285, { align: 'center' });
  
  // Save
  doc.save(`${currentDeal.businessName || 'Offer'}_TermSheet.pdf`);
  showToast('PDF Generated', 'Term sheet downloaded successfully.');
}

// ============================================
// FEATURE 2: KEYBOARD SHORTCUTS
// ============================================
function initKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Ignore if typing in input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
      if (e.key === 'Escape') {
        e.target.blur();
      }
      return;
    }
    
    // Ignore if modal is open (except Escape)
    const activeModal = document.querySelector('.modal-overlay.active');
    if (activeModal && e.key !== 'Escape') return;
    
    switch(e.key.toLowerCase()) {
      case 'n':
        if (!e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          document.getElementById('headerSearchInput')?.focus();
        }
        break;
      case '/':
        e.preventDefault();
        document.getElementById('dealSearch')?.focus();
        break;
      case 'escape':
        e.preventDefault();
        closeAllModals();
        if (document.querySelector('.detail-view.active')) {
          showDashboard();
        }
        break;
      case 's':
        if (!e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          saveCurrentDeal();
        }
        break;
      case 'd':
        if (!e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          showDashboard();
        }
        break;
      case 'a':
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          selectAllDeals();
        } else {
          e.preventDefault();
          openAnalyticsModal();
        }
        break;
      case 'r':
        e.preventDefault();
        openRenewalsModal();
        break;
      case 't':
        e.preventDefault();
        openTeamModal();
        break;
      case 'p':
        e.preventDefault();
        generateOfferPDF();
        break;
      case '?':
        e.preventDefault();
        openShortcutsModal();
        break;
      case 'delete':
      case 'backspace':
        if (batchSelectedDeals.size > 0) {
          e.preventDefault();
          batchDelete();
        }
        break;
    }
  });
}

function closeAllModals() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}

function openShortcutsModal() {
  document.getElementById('shortcutsModal').classList.add('active');
}
function closeShortcutsModal() {
  document.getElementById('shortcutsModal').classList.remove('active');
}

// ============================================
// FEATURE 3: DEAL STATUS PIPELINE
// ============================================
const DEAL_STATUSES = [
  { id: 'new', label: 'New', color: '#3b82f6' },
  { id: 'review', label: 'In Review', color: '#a855f7' },
  { id: 'docs', label: 'Docs Requested', color: '#eab308' },
  { id: 'approved', label: 'Approved', color: '#22c55e' },
  { id: 'funded', label: 'Funded', color: '#22c55e' },
  { id: 'declined', label: 'Declined', color: '#ef4444' },
  { id: 'renewal', label: 'Renewal', color: '#06b6d4' }
];

function getStatusBadge(status) {
  const s = DEAL_STATUSES.find(st => st.id === status) || DEAL_STATUSES[0];
  return `<span class="status-badge status-${s.id}">${s.label}</span>`;
}

function updateDealStatus(dealId, newStatus) {
  const deal = allDeals.find(d => d.id === dealId);
  if (!deal) return;
  
  deal.status = newStatus;
  deal.statusHistory = deal.statusHistory || [];
  deal.statusHistory.push({
    status: newStatus,
    timestamp: new Date().toISOString(),
    user: localStorage.getItem('greatdane_username') || 'System'
  });
  
  // If funded, track funding date and amount
  if (newStatus === 'funded') {
    deal.fundedDate = new Date().toISOString();
    deal.fundedAmount = window.currentOfferData?.fundingAmount || 0;
    deal.termDays = window.currentOfferData?.termDays || 90;
  }
  
  saveDealsToStorage();
  renderDealList();
  
  // Trigger webhook
  triggerWebhook('statusChange', { deal, newStatus });
  
  showToast('Status Updated', `Deal moved to ${DEAL_STATUSES.find(s => s.id === newStatus)?.label || newStatus}`);
}

function renderStatusDropdown(dealId, currentStatus) {
  const s = DEAL_STATUSES.find(st => st.id === currentStatus) || DEAL_STATUSES[0];
  return `
    <div class="status-dropdown" onclick="event.stopPropagation();">
      <span class="status-badge status-${s.id}" onclick="toggleStatusMenu(${dealId})">${s.label}</span>
      <div class="status-dropdown-menu" id="statusMenu_${dealId}">
        ${DEAL_STATUSES.map(st => `
          <div class="status-dropdown-item" onclick="updateDealStatus(${dealId}, '${st.id}')">
            <span class="status-dot" style="background: ${st.color};"></span>
            ${st.label}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function toggleStatusMenu(dealId) {
  const menu = document.getElementById(`statusMenu_${dealId}`);
  document.querySelectorAll('.status-dropdown-menu').forEach(m => {
    if (m !== menu) m.classList.remove('active');
  });
  menu?.classList.toggle('active');
}

// Close status menus when clicking outside
document.addEventListener('click', () => {
  document.querySelectorAll('.status-dropdown-menu').forEach(m => m.classList.remove('active'));
});

// ============================================
// FEATURE 4: BATCH SELECTION
// ============================================
let batchSelectedDeals = new Set();

function toggleBatchSelect(dealId, event) {
  event?.stopPropagation();
  if (batchSelectedDeals.has(dealId)) {
    batchSelectedDeals.delete(dealId);
  } else {
    batchSelectedDeals.add(dealId);
  }
  updateBatchUI();
}

function selectAllDeals() {
  if (batchSelectedDeals.size === allDeals.length) {
    batchSelectedDeals.clear();
  } else {
    allDeals.forEach(d => batchSelectedDeals.add(d.id));
  }
  updateBatchUI();
}

function clearBatchSelection() {
  batchSelectedDeals.clear();
  updateBatchUI();
}

function updateBatchUI() {
  const toolbar = document.getElementById('batchToolbar');
  const count = batchSelectedDeals.size;
  
  if (count > 0) {
    toolbar?.classList.remove('hidden');
    document.getElementById('batchSelectedCount').textContent = count;
  } else {
    toolbar?.classList.add('hidden');
  }
  
  // Update checkboxes in deal list
  document.querySelectorAll('.batch-checkbox').forEach(cb => {
    const dealId = parseInt(cb.dataset.dealId);
    if (batchSelectedDeals.has(dealId)) {
      cb.classList.add('checked');
    } else {
      cb.classList.remove('checked');
    }
  });
}

function batchChangeStatus() {
  const newStatus = prompt('Enter new status (new, review, docs, approved, funded, declined):');
  if (!newStatus || !DEAL_STATUSES.find(s => s.id === newStatus)) {
    alert('Invalid status');
    return;
  }
  batchSelectedDeals.forEach(id => updateDealStatus(id, newStatus));
  clearBatchSelection();
}

function batchExport() {
  const deals = allDeals.filter(d => batchSelectedDeals.has(d.id));
  const csv = [
    ['Business', 'Owner', 'Industry', 'FICO', 'Score', 'Status', 'Avg Revenue'].join(','),
    ...deals.map(d => [
      d.businessName,
      d.ownerName,
      d.industry,
      d.fico,
      d.score,
      d.status || 'new',
      d.months?.length ? Math.round(d.months.reduce((a, m) => a + m.revenue, 0) / d.months.length) : 0
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `deals_export_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Export Complete', `${deals.length} deals exported to CSV`);
}

function batchAssign() {
  const user = prompt('Assign to user (enter username):');
  if (!user) return;
  batchSelectedDeals.forEach(id => {
    const deal = allDeals.find(d => d.id === id);
    if (deal) {
      deal.assignedTo = user;
      deal.assignedDate = new Date().toISOString();
    }
  });
  saveDealsToStorage();
  showToast('Deals Assigned', `${batchSelectedDeals.size} deals assigned to ${user}`);
  clearBatchSelection();
}

function batchDelete() {
  if (!confirm(`Delete ${batchSelectedDeals.size} selected deals? This cannot be undone.`)) return;
  allDeals = allDeals.filter(d => !batchSelectedDeals.has(d.id));
  saveDealsToStorage();
  renderDealList();
  clearBatchSelection();
  showToast('Deals Deleted', 'Selected deals have been removed');
}

// ============================================
// FEATURE 5: BANK STATEMENT OCR (via Gemini Vision)
// ============================================
async function processStatementWithOCR(file) {
  const apiKey = localStorage.getItem('greatdane_api_key');
  if (!apiKey) {
    showToast('API Key Required', 'Please add your Gemini API key in settings');
    return null;
  }
  
  // Convert file to base64
  const base64 = await new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(file);
  });
  
  const prompt = `Analyze this bank statement image and extract the following data in JSON format:
  {
    "bankName": "name of bank",
    "accountType": "checking/savings",
    "accountLast4": "last 4 digits",
    "statementPeriod": { "start": "YYYY-MM-DD", "end": "YYYY-MM-DD" },
    "beginningBalance": number,
    "endingBalance": number,
    "totalDeposits": number,
    "totalWithdrawals": number,
    "averageDailyBalance": number,
    "nsfCount": number,
    "negativeDays": number,
    "largestDeposit": number,
    "regularDeposits": [{ "description": "", "amount": number, "frequency": "weekly/biweekly/monthly" }],
    "suspiciousActivity": ["list of any concerning patterns"],
    "mcaPayments": [{ "lender": "", "amount": number }]
  }
  Return ONLY valid JSON, no markdown or explanation.`;
  
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inline_data: { mime_type: file.type, data: base64 } }
          ]
        }]
      })
    });
    
    const result = await response.json();
    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      return JSON.parse(jsonMatch[0]);
    }
  } catch (e) {
    console.error('OCR Error:', e);
  }
  return null;
}

// ============================================
// FEATURE 6: DOCUMENT CHECKLIST
// ============================================
const REQUIRED_DOCS = [
  { id: 'bank3', name: '3 Months Bank Statements', required: true },
  { id: 'bank6', name: '6 Months Bank Statements', required: false },
  { id: 'idfront', name: 'Driver License (Front)', required: true },
  { id: 'idback', name: 'Driver License (Back)', required: false },
  { id: 'voided', name: 'Voided Check', required: true },
  { id: 'app', name: 'Signed Application', required: true },
  { id: 'taxret', name: 'Business Tax Returns', required: false },
  { id: 'taxid', name: 'EIN Letter / Tax ID', required: false },
  { id: 'lease', name: 'Business Lease', required: false }
];

function openDocsModal() {
  if (!currentDeal) return;
  document.getElementById('docsModalSubtitle').textContent = `Documents for ${currentDeal.businessName}`;
  renderDocChecklist();
  document.getElementById('docsModal').classList.add('active');
}

function closeDocsModal() {
  document.getElementById('docsModal').classList.remove('active');
}

function renderDocChecklist() {
  const docs = currentDeal?.documents || {};
  const container = document.getElementById('docChecklist');
  
  container.innerHTML = REQUIRED_DOCS.map(doc => {
    const status = docs[doc.id];
    const isComplete = status?.uploaded;
    const isExpired = status?.expiry && new Date(status.expiry) < new Date();
    
    return `
      <div class="doc-item ${isComplete ? 'complete' : ''} ${isExpired ? 'expired' : ''}">
        <div class="doc-status ${isComplete ? 'complete' : 'pending'} ${isExpired ? 'expired' : ''}">
          ${isComplete ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' : 
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>'}
        </div>
        <div class="doc-info">
          <div class="doc-name">${doc.name} ${doc.required ? '<span style="color: var(--tier-e);">*</span>' : ''}</div>
          <div class="doc-meta">${isComplete ? `Uploaded ${new Date(status.uploadedAt).toLocaleDateString()}` : 'Not uploaded'}</div>
        </div>
        <div class="doc-actions">
          <button class="btn-secondary" style="padding: 6px 10px; font-size: 0.75rem;" onclick="uploadDocument('${doc.id}')">
            ${isComplete ? 'Replace' : 'Upload'}
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function uploadDocument(docId) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf,.jpg,.jpeg,.png';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    currentDeal.documents = currentDeal.documents || {};
    currentDeal.documents[docId] = {
      uploaded: true,
      uploadedAt: new Date().toISOString(),
      fileName: file.name,
      fileSize: file.size
    };
    
    saveDealsToStorage();
    renderDocChecklist();
    showToast('Document Uploaded', file.name);
  };
  input.click();
}

function addCustomDocument() {
  const name = prompt('Enter document name:');
  if (!name) return;
  const id = 'custom_' + Date.now();
  REQUIRED_DOCS.push({ id, name, required: false, custom: true });
  renderDocChecklist();
}

// ============================================
// FEATURE 7: STACKING DETECTION
// ============================================
// ============================================
// FEATURE 7: STACKING DETECTION (Gemini API)
// ============================================
async function analyzeStackingWithAI(deal) {
  if (!deal?.months?.length) return [];
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return detectStackingBasic(deal); // Fallback to basic
  
  // If we already have stacking analysis cached, return it
  if (deal.stackingAnalysis && Date.now() - (deal.stackingAnalysisTime || 0) < 3600000) {
    return deal.stackingAnalysis;
  }
  
  const bankData = deal.bankData || {};
  const months = deal.months || [];
  
  // Build comprehensive financial picture for AI
  const financialSummary = {
    businessName: deal.businessName,
    avgMonthlyRevenue: months.length ? Math.round(months.reduce((a, m) => a + (m.revenue || 0), 0) / months.length) : 0,
    avgMonthlyDeposits: months.length ? Math.round(months.reduce((a, m) => a + (m.deposits || 0), 0) / months.length) : 0,
    avgDailyBalance: months.length ? Math.round(months.reduce((a, m) => a + (m.avgBalance || m.avgDailyBal || 0), 0) / months.length) : 0,
    totalNSFs: months.reduce((a, m) => a + (m.nsf || m.nsfs || 0), 0),
    totalNegativeDays: months.reduce((a, m) => a + (m.negatives || m.negativeDays || 0), 0),
    monthlyData: months.map(m => ({
      month: m.month,
      revenue: m.revenue,
      deposits: m.deposits,
      withdrawals: m.withdrawals || (m.deposits - (m.endBalance - m.startBalance)),
      avgBalance: m.avgBalance || m.avgDailyBal,
      endBalance: m.endBalance,
      nsfs: m.nsf || m.nsfs || 0,
      negativeDays: m.negatives || m.negativeDays || 0
    })),
    rawTransactions: bankData.transactions || [],
    extractedMCAPayments: bankData.mcaPayments || []
  };
  
  const prompt = `You are an MCA underwriter analyzing bank statements for STACKING (existing MCA/loan positions).

BANK DATA:
${JSON.stringify(financialSummary, null, 2)}

ANALYZE FOR:
1. **Daily/Weekly ACH patterns** - Regular identical debits suggesting MCA payments (typically $200-$2000 daily or $1000-$10000 weekly)
2. **Known MCA lender names** - Look for: Yellowstone, Credibly, Rapid Finance, OnDeck, Kabbage, Fundbox, CAN Capital, Libertas, Pearl Capital, Everest, Clear Balance, Forward, Unique, Fox, Greenbox, Bizfi, Behalf, PayPal Working Capital, Square Capital, Amazon Lending, Shopify Capital
3. **ACH debit patterns** - Multiple same-day debits, round-number recurring withdrawals
4. **Cash flow stress indicators** - High NSFs around payment dates, balance drops to near-zero regularly
5. **Revenue vs withdrawal ratio** - If withdrawals exceed 40% of deposits, likely stacked

Return ONLY valid JSON:
{
  "stackingDetected": true/false,
  "confidence": 0-100,
  "estimatedPositions": 0,
  "estimatedDailyPayment": 0,
  "estimatedTotalBalance": 0,
  "indicators": [
    {
      "type": "mca_payment|ach_pattern|lender_name|cash_stress|high_utilization",
      "severity": "high|medium|low",
      "description": "specific finding",
      "evidence": "what data supports this",
      "recommendation": "what to do"
    }
  ],
  "detectedLenders": ["list of suspected lenders"],
  "riskLevel": "high|medium|low|clear",
  "summary": "1-2 sentence summary for underwriter"
}`;

  try {
    const model = getGeminiModel();
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 2000 }
      })
    });
    
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    
    if (jsonMatch) {
      const result = JSON.parse(jsonMatch[0]);
      // Cache the result
      deal.stackingAnalysis = result.indicators || [];
      deal.stackingData = result;
      deal.stackingAnalysisTime = Date.now();
      saveDealsToStorage();
      return result.indicators || [];
    }
  } catch (e) {
    console.error('Stacking AI analysis error:', e);
  }
  
  return detectStackingBasic(deal);
}

function detectStackingBasic(deal) {
  // Fallback basic detection without API
  if (!deal?.months?.length) return [];
  
  const stackingIndicators = [];
  const totalNSF = deal.months.reduce((a, m) => a + (m.nsf || m.nsfs || 0), 0);
  
  if (totalNSF > 3) {
    stackingIndicators.push({
      type: 'nsf_pattern',
      severity: 'high',
      description: `${totalNSF} NSF occurrences detected`,
      evidence: 'Multiple returned payments',
      recommendation: 'Review for existing payment obligations'
    });
  }
  
  const balances = deal.months.map(m => m.avgBalance || m.avgDailyBal || 0).filter(b => b > 0);
  if (balances.length > 1) {
    const avgBalance = balances.reduce((a, b) => a + b, 0) / balances.length;
    const volatility = Math.sqrt(balances.reduce((a, b) => a + Math.pow(b - avgBalance, 2), 0) / balances.length) / avgBalance;
    
    if (volatility > 0.5) {
      stackingIndicators.push({
        type: 'cash_stress',
        severity: 'medium',
        description: 'High balance volatility detected',
        evidence: `${Math.round(volatility * 100)}% variance in average daily balance`,
        recommendation: 'May indicate cash flow stress from existing positions'
      });
    }
  }
  
  return stackingIndicators;
}

function detectStacking(deal) {
  // Synchronous wrapper - returns cached or basic results
  // For AI analysis, use analyzeStackingWithAI() directly
  if (deal?.stackingAnalysis) {
    return deal.stackingAnalysis;
  }
  return detectStackingBasic(deal);
}

function renderStackingAlert(deal) {
  const indicators = detectStacking(deal);
  const stackingData = deal?.stackingData;
  
  if (!indicators?.length && !stackingData?.stackingDetected) return '';
  
  const riskLevel = stackingData?.riskLevel || (indicators.some(i => i.severity === 'high') ? 'high' : 'medium');
  
  // Build compact summary
  const summaryParts = [];
  indicators.forEach(i => summaryParts.push(i.description));
  if (stackingData?.detectedLenders?.length) {
    summaryParts.push(`${stackingData.detectedLenders.length} suspected lenders`);
  }
  const summaryText = summaryParts.slice(0, 3).join('  ');
  
  return `
    <div class="stacking-alert">
      <div class="stacking-alert-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <span>Potential Stacking Detected</span>
      </div>
      <div class="stacking-alert-details">${summaryText}</div>
      <button class="btn-secondary" style="padding: 4px 10px; font-size: 0.7rem;" onclick="runStackingAnalysis()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;"><path d="M21 12a9 9 0 11-9-9"/><path d="M21 3v9h-9"/></svg>
        Analyze
      </button>
      <span class="stacking-alert-badge ${riskLevel}">${riskLevel.toUpperCase()}</span>
    </div>
  `;
}

async function runStackingAnalysis() {
  if (!currentDeal) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key in Settings to run AI stacking analysis.');
    return;
  }
  
  showToast('Analyzing', 'Running AI stacking detection...');
  
  try {
    await analyzeStackingWithAI(currentDeal);
    
    // Re-render the stacking alert
    const container = document.getElementById('stackingAlertContainer');
    if (container) {
      container.innerHTML = renderStackingAlert(currentDeal);
    }
    
    showToast('Analysis Complete', currentDeal.stackingData?.summary || 'Stacking analysis updated');
  } catch (e) {
    console.error('Stacking analysis error:', e);
    showToast('Error', 'Failed to analyze stacking');
  }
}

// ============================================
// FEATURE 8: WEBHOOK INTEGRATIONS
// ============================================
const WEBHOOK_EVENTS = ['newDeal', 'statusChange', 'funded', 'declined', 'documentUploaded'];

function getWebhooks() {
  try {
    return JSON.parse(localStorage.getItem('greatdane_webhooks') || '[]');
  } catch { return []; }
}

function saveWebhooks(webhooks) {
  localStorage.setItem('greatdane_webhooks', JSON.stringify(webhooks));
}

async function triggerWebhook(event, data) {
  const webhooks = getWebhooks().filter(w => w.events.includes(event) && w.enabled);
  
  for (const webhook of webhooks) {
    try {
      await fetch(webhook.url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        mode: 'no-cors',
        body: JSON.stringify({
          event,
          timestamp: new Date().toISOString(),
          data
        })
      });
    } catch (e) {
      console.error('Webhook error:', webhook.url, e);
    }
  }
}

// ============================================
// FEATURE 9: ADVANCED HUBBLE AI
// ============================================
const HUBBLE_ADVANCED_COMMANDS = {
  'compare': async (deal) => {
    const similar = allDeals.filter(d => 
      d.id !== deal.id && 
      d.industry === deal.industry && 
      Math.abs((d.fico || 650) - (deal.fico || 650)) < 50
    ).slice(0, 3);
    
    if (!similar.length) return 'No similar deals found for comparison.';
    
    const avgScore = similar.reduce((a, d) => a + (d.score || 0), 0) / similar.length;
    const avgFunding = similar.reduce((a, d) => a + (d.fundedAmount || 0), 0) / similar.length;
    
    return `Compared to ${similar.length} similar ${deal.industry || 'industry'} deals:\n` +
      `- This deal scores ${deal.score || 0} vs avg ${Math.round(avgScore)}\n` +
      `- Typical funding: $${Math.round(avgFunding).toLocaleString()}\n` +
      `- ${deal.score > avgScore ? 'Above average performance' : 'May need additional review'}`;
  },
  
  'memo': async (deal) => {
    const avgRev = deal.months?.length ? deal.months.reduce((a, m) => a + m.revenue, 0) / deal.months.length : 0;
    return `UNDERWRITING MEMO\n` +
      `Business: ${deal.businessName}\n` +
      `Industry: ${deal.industry || 'N/A'}\n` +
      `Time in Business: ${deal.tib || 'N/A'}\n\n` +
      `FINANCIALS:\n` +
      `- Avg Monthly Revenue: $${Math.round(avgRev).toLocaleString()}\n` +
      `- FICO: ${deal.fico || 'N/A'}\n` +
      `- ABLESCORE: ${deal.score || 0}\n\n` +
      `RECOMMENDATION: ${deal.score >= 70 ? 'APPROVE' : deal.score >= 50 ? 'APPROVE WITH CONDITIONS' : 'DECLINE OR COUNTEROFFER'}`;
  },
  
  'counteroffer': async (deal) => {
    const data = window.currentOfferData || {};
    const reducedAmount = Math.round((data.fundingAmount || 0) * 0.75);
    const shorterTerm = Math.round((data.termDays || 90) * 0.8);
    
    return `COUNTEROFFER SUGGESTION:\n` +
      `If standard offer is too risky, consider:\n` +
      `- Reduced funding: $${reducedAmount.toLocaleString()} (75% of calculated)\n` +
      `- Shorter term: ${shorterTerm} days\n` +
      `- Higher factor rate: +0.05 adjustment\n` +
      `- Require additional documentation`;
  }
};

// ============================================
// FEATURE 10-11: TEAM MANAGEMENT
// ============================================
const DEFAULT_TEAM = [
  { id: 1, name: 'Admin User', email: 'admin@company.com', role: 'admin', avatar: 'AU' },
];

function getTeamMembers() {
  try {
    return JSON.parse(localStorage.getItem('greatdane_team') || JSON.stringify(DEFAULT_TEAM));
  } catch { return DEFAULT_TEAM; }
}

function saveTeamMembers(team) {
  localStorage.setItem('greatdane_team', JSON.stringify(team));
}

function openTeamModal() {
  renderTeamMembers();
  renderPendingApprovals();
  document.getElementById('teamModal').classList.add('active');
}

function closeTeamModal() {
  document.getElementById('teamModal').classList.remove('active');
}

function renderTeamMembers() {
  const team = getTeamMembers();
  document.getElementById('teamMembersList').innerHTML = team.map(m => `
    <div class="team-member">
      <div class="team-avatar">${m.avatar || m.name.split(' ').map(n => n[0]).join('')}</div>
      <div class="team-info">
        <div class="team-name">${m.name}</div>
        <div class="team-role">${m.email}</div>
      </div>
      <span class="role-badge ${m.role}">${m.role}</span>
    </div>
  `).join('');
}

function renderPendingApprovals() {
  const pending = allDeals.filter(d => d.status === 'approved' && d.requiresManagerApproval);
  const container = document.getElementById('pendingApprovalsList');
  
  if (!pending.length) {
    container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem;">No pending approvals</div>';
    return;
  }
  
  container.innerHTML = pending.map(d => `
    <div class="team-member">
      <div class="team-info">
        <div class="team-name">${d.businessName}</div>
        <div class="team-role">Requested by ${d.approvalRequestedBy || 'Unknown'}</div>
      </div>
      <button class="btn-primary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="approveManagerRequest(${d.id})">Approve</button>
    </div>
  `).join('');
}

function openAddTeamMember() {
  const name = prompt('Enter member name:');
  if (!name) return;
  const email = prompt('Enter email:');
  if (!email) return;
  const role = prompt('Enter role (admin, manager, underwriter, iso):') || 'underwriter';
  
  const team = getTeamMembers();
  team.push({
    id: Date.now(),
    name,
    email,
    role,
    avatar: name.split(' ').map(n => n[0]).join('')
  });
  saveTeamMembers(team);
  renderTeamMembers();
  showToast('Member Added', `${name} has been added to the team`);
}

// ============================================
// FEATURE 12: ANALYTICS
// ============================================
let analyticsVolumeChart = null;
let analyticsIndustryChart = null;

function openAnalyticsModal() {
  calculateAnalytics();
  document.getElementById('analyticsModal').classList.add('active');
}

function closeAnalyticsModal() {
  document.getElementById('analyticsModal').classList.remove('active');
}

function calculateAnalytics() {
  const funded = allDeals.filter(d => d.status === 'funded');
  const totalFunded = funded.reduce((a, d) => a + (d.fundedAmount || 0), 0);
  const approvalRate = allDeals.length ? (funded.length / allDeals.length * 100) : 0;
  const avgDeal = funded.length ? totalFunded / funded.length : 0;
  
  document.getElementById('analyticsTotalFunded').textContent = '$' + Math.round(totalFunded).toLocaleString();
  document.getElementById('analyticsDealsCount').textContent = funded.length;
  document.getElementById('analyticsApprovalRate').textContent = Math.round(approvalRate) + '%';
  document.getElementById('analyticsAvgDeal').textContent = '$' + Math.round(avgDeal).toLocaleString();
  
  renderVolumeChart();
  renderIndustryChart();
  renderISOPerformance();
}

function renderVolumeChart() {
  const ctx = document.getElementById('analyticsVolumeChart')?.getContext('2d');
  if (!ctx) return;
  
  if (analyticsVolumeChart) analyticsVolumeChart.destroy();
  
  // Generate last 30 days of data
  const labels = [];
  const data = [];
  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    
    const dayFunded = allDeals.filter(d => {
      if (!d.fundedDate) return false;
      const fd = new Date(d.fundedDate);
      return fd.toDateString() === date.toDateString();
    }).reduce((a, d) => a + (d.fundedAmount || 0), 0);
    
    data.push(dayFunded);
  }
  
  analyticsVolumeChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Funded Amount',
        data,
        backgroundColor: 'rgba(234, 179, 8, 0.6)',
        borderColor: '#eab308',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { callback: v => '$' + (v/1000) + 'k' }
        }
      }
    }
  });
}

function renderIndustryChart() {
  const ctx = document.getElementById('analyticsIndustryChart')?.getContext('2d');
  if (!ctx) return;
  
  if (analyticsIndustryChart) analyticsIndustryChart.destroy();
  
  const industries = {};
  allDeals.forEach(d => {
    const ind = d.industry || 'Unknown';
    industries[ind] = (industries[ind] || 0) + 1;
  });
  
  const sorted = Object.entries(industries).sort((a, b) => b[1] - a[1]).slice(0, 5);
  
  analyticsIndustryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: sorted.map(s => s[0]),
      datasets: [{
        data: sorted.map(s => s[1]),
        backgroundColor: ['#eab308', '#3b82f6', '#22c55e', '#a855f7', '#ef4444']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'right' } }
    }
  });
}

function renderISOPerformance() {
  const isos = {};
  allDeals.filter(d => d.status === 'funded' && d.isoName).forEach(d => {
    const iso = d.isoName;
    if (!isos[iso]) isos[iso] = { count: 0, volume: 0 };
    isos[iso].count++;
    isos[iso].volume += d.fundedAmount || 0;
  });
  
  const sorted = Object.entries(isos).sort((a, b) => b[1].volume - a[1].volume).slice(0, 5);
  
  document.getElementById('analyticsISOList').innerHTML = sorted.length ? sorted.map(([name, data]) => `
    <div class="team-member" style="margin-bottom: 8px;">
      <div class="team-info">
        <div class="team-name">${name}</div>
        <div class="team-role">${data.count} deals funded</div>
      </div>
      <div style="font-weight: 700; color: var(--accent);">$${Math.round(data.volume).toLocaleString()}</div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No ISO data yet</div>';
}

function setAnalyticsRange(range) {
  document.querySelectorAll('.chart-filter').forEach(f => f.classList.remove('active'));
  event.target.classList.add('active');
  // In a real implementation, this would filter the chart data
  renderVolumeChart();
}

// ============================================
// FEATURE 13: RENEWALS
// ============================================
function openRenewalsModal() {
  calculateRenewals();
  document.getElementById('renewalsModal').classList.add('active');
}

function closeRenewalsModal() {
  document.getElementById('renewalsModal').classList.remove('active');
}

function calculateRenewals() {
  const funded = allDeals.filter(d => d.status === 'funded' && d.fundedDate);
  
  const renewals = funded.map(d => {
    const fundedDate = new Date(d.fundedDate);
    const termDays = d.termDays || 90;
    const endDate = new Date(fundedDate);
    endDate.setDate(endDate.getDate() + termDays);
    
    const today = new Date();
    const daysElapsed = Math.floor((today - fundedDate) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.max(0, termDays - daysElapsed);
    const percentComplete = Math.min(100, Math.round((daysElapsed / termDays) * 100));
    
    const amountPaid = (d.fundedAmount || 0) * (d.factorRate || 1.28) * (percentComplete / 100);
    const amountRemaining = (d.fundedAmount || 0) * (d.factorRate || 1.28) - amountPaid;
    
    const isRTR = percentComplete >= 50;
    
    return {
      ...d,
      daysElapsed,
      daysRemaining,
      percentComplete,
      amountPaid,
      amountRemaining,
      isRTR,
      rtrStatus: percentComplete >= 70 ? 'ready' : percentComplete >= 50 ? 'soon' : 'not-ready'
    };
  });
  
  const active = renewals.filter(r => r.percentComplete < 100);
  const rtr = renewals.filter(r => r.isRTR);
  const outstanding = renewals.reduce((a, r) => a + r.amountRemaining, 0);
  
  document.getElementById('renewalActiveCount').textContent = active.length;
  document.getElementById('renewalRTRCount').textContent = rtr.length;
  document.getElementById('renewalOutstanding').textContent = '$' + Math.round(outstanding).toLocaleString();
  
  document.getElementById('renewalsList').innerHTML = renewals.map(r => `
    <div class="renewal-card">
      <div class="renewal-header">
        <div>
          <div style="font-weight: 700;">${r.businessName}</div>
          <div style="font-size: 0.8rem; color: var(--text-muted);">Funded $${Math.round(r.fundedAmount || 0).toLocaleString()} on ${new Date(r.fundedDate).toLocaleDateString()}</div>
        </div>
        <span class="rtr-badge ${r.rtrStatus}">${r.rtrStatus === 'ready' ? 'RTR' : r.rtrStatus === 'soon' ? 'Soon' : 'Active'}</span>
      </div>
      <div class="renewal-progress">
        <div class="renewal-progress-bar" style="width: ${r.percentComplete}%;"></div>
      </div>
      <div class="renewal-stats">
        <div class="renewal-stat">
          <div class="renewal-stat-value">${r.percentComplete}%</div>
          <div class="renewal-stat-label">Complete</div>
        </div>
        <div class="renewal-stat">
          <div class="renewal-stat-value">${r.daysRemaining}</div>
          <div class="renewal-stat-label">Days Left</div>
        </div>
        <div class="renewal-stat">
          <div class="renewal-stat-value">$${Math.round(r.amountPaid).toLocaleString()}</div>
          <div class="renewal-stat-label">Paid</div>
        </div>
        <div class="renewal-stat">
          <div class="renewal-stat-value">$${Math.round(r.amountRemaining).toLocaleString()}</div>
          <div class="renewal-stat-label">Remaining</div>
        </div>
      </div>
      ${r.isRTR ? `<button class="btn-primary" style="width: 100%; margin-top: 12px;" onclick="initiateRenewal(${r.id})">Start Renewal</button>` : ''}
    </div>
  `).join('') || '<div style="color: var(--text-muted); text-align: center; padding: 40px;">No funded positions yet</div>';
}

function initiateRenewal(dealId) {
  const deal = allDeals.find(d => d.id === dealId);
  if (!deal) return;
  
  // Create renewal deal
  const renewalDeal = {
    ...deal,
    id: Date.now(),
    status: 'new',
    parentDealId: dealId,
    isRenewal: true,
    createdAt: new Date().toISOString()
  };
  
  allDeals.unshift(renewalDeal);
  saveDealsToStorage();
  
  closeRenewalsModal();
  currentDeal = renewalDeal;
  showDetailView();
  populateDetailView();
  
  showToast('Renewal Created', `Renewal deal created for ${deal.businessName}`);
}

// ============================================
// FEATURE 14: CREDIT PULL
// ============================================
function openCreditPullModal() {
  if (!currentDeal) return;
  document.getElementById('creditPullSubtitle').textContent = `Credit data for ${currentDeal.ownerName || 'owner'}`;
  
  // Reset modal state
  resetCreditPullModal();
  
  // Pre-fill name from deal
  const names = (currentDeal.ownerName || '').split(' ');
  document.getElementById('creditFirstName').value = names[0] || '';
  document.getElementById('creditLastName').value = names.slice(1).join(' ') || '';
  
  // Default to upload mode (most common use case)
  setCreditMode('upload');
  
  document.getElementById('creditPullModal').classList.add('active');
}

function closeCreditPullModal() {
  document.getElementById('creditPullModal').classList.remove('active');
}

function setCreditMode(mode) {
  const apiBtn = document.getElementById('creditModeApi');
  const uploadBtn = document.getElementById('creditModeUpload');
  const apiMode = document.getElementById('creditPullApiMode');
  const uploadMode = document.getElementById('creditPullUploadMode');
  
  if (mode === 'api') {
    apiBtn.classList.remove('btn-secondary');
    apiBtn.classList.add('btn-primary');
    uploadBtn.classList.remove('btn-primary');
    uploadBtn.classList.add('btn-secondary');
    apiMode.style.display = 'block';
    uploadMode.style.display = 'none';
  } else {
    uploadBtn.classList.remove('btn-secondary');
    uploadBtn.classList.add('btn-primary');
    apiBtn.classList.remove('btn-primary');
    apiBtn.classList.add('btn-secondary');
    uploadMode.style.display = 'block';
    apiMode.style.display = 'none';
  }
}

function resetCreditPullModal() {
  document.getElementById('creditPullResult').classList.add('hidden');
  document.getElementById('creditPullApiMode').style.display = 'none';
  document.getElementById('creditPullUploadMode').style.display = 'block';
  document.getElementById('creditUploadStatus').style.display = 'none';
  document.getElementById('creditDetailedData').innerHTML = '';
  window.lastCreditPullData = null;
}

function executeCreditPull() {
  // API mode - would connect to bureau API
  const firstName = document.getElementById('creditFirstName').value;
  const lastName = document.getElementById('creditLastName').value;
  const ssn = document.getElementById('creditSSN').value;
  const bureau = document.getElementById('creditBureau').value;
  
  if (!firstName || !lastName || ssn.length < 9) {
    alert('Please fill in all required fields (full SSN required for API pull)');
    return;
  }
  
  // Check for API credentials
  const apiCredentials = localStorage.getItem('greatdane_credit_api_key');
  if (!apiCredentials) {
    alert('Credit bureau API not configured.\n\nTo enable API pulls, add your bureau credentials in Settings  Integrations.\n\nAlternatively, use "Upload Report" to analyze an existing credit report with AI.');
    return;
  }
  
  showToast('Pulling Credit', `Connecting to ${bureau}...`);
  
  // This would be the actual API call
  // For now, show placeholder
  setTimeout(() => {
    showToast('API Not Configured', 'Configure bureau credentials in Settings');
  }, 1500);
}

async function handleCreditUploadInModal(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key in Settings to analyze credit reports with AI.');
    return;
  }
  
  // Show loading state
  document.getElementById('creditUploadStatus').style.display = 'block';
  document.getElementById('creditUploadStatusText').textContent = `Analyzing ${file.name}...`;
  
  try {
    // Convert file to base64
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    
    const model = getGeminiModel();
    const prompt = `You are a credit report analyzer. Extract ALL data from this credit report image/PDF.

Return ONLY valid JSON in this exact format:
{
  "scores": {
    "fico": 0,
    "vantage": 0,
    "experian": 0,
    "equifax": 0,
    "transunion": 0
  },
  "bureau": "experian|equifax|transunion|unknown",
  "report_date": "YYYY-MM-DD",
  "subject_name": "",
  "summary": {
    "total_accounts": 0,
    "open_accounts": 0,
    "delinquent_accounts": 0,
    "total_balance": 0,
    "total_credit_limit": 0,
    "credit_utilization": 0,
    "total_monthly_payment": 0
  },
  "payment_history": {
    "on_time_percentage": 0,
    "late_30_days": 0,
    "late_60_days": 0,
    "late_90_days": 0,
    "collections": 0
  },
  "inquiries": {
    "hard_inquiries_24mo": 0
  },
  "public_records": {
    "bankruptcies": 0,
    "judgments": 0,
    "liens": 0
  },
  "tradelines": [
    {
      "creditor": "",
      "type": "credit_card|installment|mortgage|auto|other",
      "balance": 0,
      "limit": 0,
      "payment": 0,
      "status": "current|late|collection|closed"
    }
  ]
}

Extract the PRIMARY credit score (FICO preferred). Include ALL visible tradelines.`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inline_data: { mime_type: file.type.includes('pdf') ? 'application/pdf' : file.type, data: base64 } }
          ]
        }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 4000 }
      })
    });
    
    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    
    if (jsonMatch) {
      const creditData = JSON.parse(jsonMatch[0]);
      displayCreditResults(creditData);
    } else {
      throw new Error('Could not parse credit data from response');
    }
  } catch (err) {
    console.error('Credit analysis error:', err);
    document.getElementById('creditUploadStatus').style.display = 'none';
    showToast('Analysis Failed', 'Could not extract credit data. Try a clearer image.');
  }
}

function displayCreditResults(creditData) {
  document.getElementById('creditUploadStatus').style.display = 'none';
  
  // Get primary score
  const scores = creditData.scores || {};
  const primaryScore = scores.fico || scores.vantage || scores.experian || scores.equifax || scores.transunion || 0;
  
  document.getElementById('creditScoreValue').textContent = primaryScore || '---';
  document.getElementById('creditScoreLabel').textContent = 
    primaryScore >= 750 ? 'Excellent' : 
    primaryScore >= 700 ? 'Good' : 
    primaryScore >= 650 ? 'Fair' : 
    primaryScore >= 600 ? 'Poor' : 'Very Poor';
  
  // Payment history and summary
  const ph = creditData.payment_history || {};
  const summary = creditData.summary || {};
  
  document.getElementById('creditFactors').innerHTML = `
    <div class="credit-factor">
      <div class="credit-factor-label">Payment History</div>
      <div class="credit-factor-value">${ph.on_time_percentage || 0}% on-time</div>
    </div>
    <div class="credit-factor">
      <div class="credit-factor-label">Credit Utilization</div>
      <div class="credit-factor-value">${summary.credit_utilization || 0}%</div>
    </div>
    <div class="credit-factor">
      <div class="credit-factor-label">Total Accounts</div>
      <div class="credit-factor-value">${summary.total_accounts || 0}</div>
    </div>
    <div class="credit-factor">
      <div class="credit-factor-label">Hard Inquiries</div>
      <div class="credit-factor-value">${creditData.inquiries?.hard_inquiries_24mo || 0}</div>
    </div>
  `;
  
  // Detailed data
  const tradelines = creditData.tradelines || [];
  const publicRecords = creditData.public_records || {};
  
  let detailedHtml = '';
  
  // Public records warning
  if (publicRecords.bankruptcies || publicRecords.judgments || publicRecords.liens) {
    detailedHtml += `
      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
        <div style="font-weight: 700; color: var(--tier-e); margin-bottom: 6px;"> Public Records Found</div>
        <div style="font-size: 0.85rem; display: flex; gap: 16px;">
          ${publicRecords.bankruptcies ? `<span>Bankruptcies: ${publicRecords.bankruptcies}</span>` : ''}
          ${publicRecords.judgments ? `<span>Judgments: ${publicRecords.judgments}</span>` : ''}
          ${publicRecords.liens ? `<span>Liens: ${publicRecords.liens}</span>` : ''}
        </div>
      </div>
    `;
  }
  
  // Summary stats
  detailedHtml += `
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
      <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 8px; text-align: center;">
        <div style="font-size: 1rem; font-weight: 700;">$${(summary.total_balance || 0).toLocaleString()}</div>
        <div style="font-size: 0.7rem; color: var(--text-muted);">Total Balance</div>
      </div>
      <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 8px; text-align: center;">
        <div style="font-size: 1rem; font-weight: 700;">$${(summary.total_credit_limit || 0).toLocaleString()}</div>
        <div style="font-size: 0.7rem; color: var(--text-muted);">Credit Limit</div>
      </div>
      <div style="background: var(--bg-tertiary); padding: 10px; border-radius: 8px; text-align: center;">
        <div style="font-size: 1rem; font-weight: 700;">$${(summary.total_monthly_payment || 0).toLocaleString()}</div>
        <div style="font-size: 0.7rem; color: var(--text-muted);">Monthly Pmts</div>
      </div>
    </div>
  `;
  
  // Tradelines summary
  if (tradelines.length > 0) {
    detailedHtml += `
      <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem;">${tradelines.length} Tradelines Found</div>
      <div style="max-height: 150px; overflow-y: auto; font-size: 0.8rem;">
        ${tradelines.slice(0, 10).map(t => `
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-secondary);">
            <span>${t.creditor || 'Unknown'} (${t.type || 'other'})</span>
            <span style="color: ${t.status === 'current' ? 'var(--tier-a)' : 'var(--tier-e)'};">$${(t.balance || 0).toLocaleString()}</span>
          </div>
        `).join('')}
        ${tradelines.length > 10 ? `<div style="text-align: center; padding: 8px; color: var(--text-muted);">+ ${tradelines.length - 10} more tradelines</div>` : ''}
      </div>
    `;
  }
  
  document.getElementById('creditDetailedData').innerHTML = detailedHtml;
  
  // Store for applying to deal
  window.lastCreditPullData = creditData;
  window.lastCreditPullScore = primaryScore;
  
  document.getElementById('creditPullResult').classList.remove('hidden');
  document.getElementById('creditPullUploadMode').style.display = 'none';
  document.getElementById('creditPullApiMode').style.display = 'none';
  
  showToast('Credit Analyzed', `Score: ${primaryScore}, ${tradelines.length} tradelines`);
}

function applyCreditToDeall() {
  if (!currentDeal) return;
  
  const score = window.lastCreditPullScore;
  const data = window.lastCreditPullData;
  
  if (score) {
    currentDeal.fico = score;
    currentDeal.ficoPulledAt = new Date().toISOString();
  }
  
  if (data) {
    currentDeal.creditReport = data;
    currentDeal.creditReportDate = new Date().toISOString();
  }
  
  saveDealsToStorage();
  closeCreditPullModal();
  populateDetailView();
  
  showToast('Credit Applied', `FICO ${score || 'N/A'} applied to deal`);
}

// Keep old function name for backward compatibility
function applyCredItToDeeal() {
  applyCreditToDeall();
}

// ============================================
// SIDEBAR PANEL FUNCTIONS
// ============================================

function updateSidebarPanels() {
  if (!currentDeal) return;
  updateSidebarNotes();
  updateSidebarStackingStatus();
  updateSidebarDocStatus();
}

function updateSidebarNotes() {
  const notesEl = document.getElementById('sidebarDealNotes');
  if (notesEl && currentDeal) {
    notesEl.value = currentDeal.notes || '';
  }
}

function saveSidebarDealNotes() {
  if (!currentDeal) return;
  const notesEl = document.getElementById('sidebarDealNotes');
  if (notesEl) {
    currentDeal.notes = notesEl.value;
    saveDealsToStorage();
    const statusEl = document.getElementById('sidebarNotesStatus');
    if (statusEl) {
      statusEl.textContent = 'Saved ';
      statusEl.style.color = 'var(--success)';
      setTimeout(() => {
        statusEl.textContent = 'Notes auto-save';
        statusEl.style.color = 'var(--text-muted)';
      }, 2000);
    }
  }
}

function updateSidebarStackingStatus() {
  const container = document.getElementById('sidebarStackingStatus');
  if (!container || !currentDeal) return;
  
  if (currentDeal.stackingAnalysis) {
    const analysis = currentDeal.stackingAnalysis;
    const riskColors = {
      high: 'var(--danger)',
      medium: 'var(--warning)',
      low: 'var(--accent)',
      clear: 'var(--success)'
    };
    const riskColor = riskColors[analysis.riskLevel] || 'var(--text-muted)';
    
    container.innerHTML = `
      <div style="padding: 8px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <div style="width: 10px; height: 10px; border-radius: 50%; background: ${riskColor};"></div>
          <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary); text-transform: capitalize;">${analysis.riskLevel} Risk</span>
          <span style="font-size: 0.7rem; color: var(--text-muted); margin-left: auto;">${analysis.confidence || 0}% conf</span>
        </div>
        ${analysis.estimatedPositions ? `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px;">
          <div style="background: var(--bg-secondary); padding: 6px 8px; border-radius: 6px; text-align: center;">
            <div style="font-size: 0.95rem; font-weight: 700; color: var(--text-primary);">${analysis.estimatedPositions}</div>
            <div style="font-size: 0.6rem; color: var(--text-muted);">POSITIONS</div>
          </div>
          <div style="background: var(--bg-secondary); padding: 6px 8px; border-radius: 6px; text-align: center;">
            <div style="font-size: 0.95rem; font-weight: 700; color: var(--text-primary);">$${(analysis.estimatedDailyPayment || 0).toLocaleString()}</div>
            <div style="font-size: 0.6rem; color: var(--text-muted);">DAILY PMT</div>
          </div>
        </div>
        ` : ''}
        ${analysis.detectedLenders?.length ? `
        <div style="font-size: 0.65rem; color: var(--text-muted); margin-bottom: 4px;">SUSPECTED LENDERS</div>
        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
          ${analysis.detectedLenders.slice(0, 3).map(l => `<span style="font-size: 0.65rem; padding: 2px 6px; background: var(--bg-tertiary); border-radius: 4px; color: var(--text-secondary);">${l}</span>`).join('')}
          ${analysis.detectedLenders.length > 3 ? `<span style="font-size: 0.65rem; padding: 2px 6px; color: var(--text-muted);">+${analysis.detectedLenders.length - 3}</span>` : ''}
        </div>
        ` : ''}
      </div>
    `;
  } else {
    container.innerHTML = `
      <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 0.8rem;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 24px; height: 24px; margin-bottom: 8px; opacity: 0.5;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <div>No stacking analysis yet</div>
        <button class="btn-secondary" style="margin-top: 10px; padding: 6px 12px; font-size: 0.75rem;" onclick="runStackingAnalysis()">Run Analysis</button>
      </div>
    `;
  }
}

function updateSidebarDocStatus() {
  const container = document.getElementById('sidebarDocStatus');
  if (!container || !currentDeal) return;
  
  const docs = [
    { name: 'Bank Statements', key: 'months', check: (d) => d.months?.length > 0 },
    { name: 'Application', key: 'application', check: (d) => d.application || d.applicationReceived },
    { name: 'Driver\'s License', key: 'driversLicense', check: (d) => d.driversLicense || d.dlReceived },
    { name: 'Voided Check', key: 'voidedCheck', check: (d) => d.voidedCheck || d.voidedCheckReceived },
    { name: 'Credit Report', key: 'creditReport', check: (d) => d.creditReport || d.fico }
  ];
  
  const docItems = docs.map(doc => {
    const hasDoc = doc.check(currentDeal);
    const icon = hasDoc 
      ? `<svg viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`
      : `<svg viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="width: 16px; height: 16px;"><circle cx="12" cy="12" r="10"/></svg>`;
    return `
      <div class="sidebar-doc-item" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-secondary); border-radius: 8px;">
        ${icon}
        <span style="font-size: 0.8rem; color: ${hasDoc ? 'var(--text-primary)' : 'var(--text-secondary)'};">${doc.name}</span>
      </div>
    `;
  }).join('');
  
  const received = docs.filter(d => d.check(currentDeal)).length;
  const total = docs.length;
  
  container.innerHTML = `
    <div style="margin-bottom: 10px; font-size: 0.75rem; color: var(--text-muted);">${received}/${total} documents received</div>
    ${docItems}
  `;
}

function duplicateDeal() {
  if (!currentDeal) {
    showToast('No Deal Selected', 'Select a deal to duplicate', 'warning');
    return;
  }
  
  const newDeal = JSON.parse(JSON.stringify(currentDeal));
  newDeal.id = Date.now();
  newDeal.businessName = (currentDeal.businessName || 'Deal') + ' (Copy)';
  newDeal.status = 'New';
  newDeal.createdAt = new Date().toISOString();
  
  allDeals.push(newDeal);
  saveDealsToStorage();
  renderDealList();
  
  // Select the new deal
  const idx = allDeals.findIndex(d => d.id === newDeal.id);
  if (idx >= 0) selectDeal(idx);
  
  showToast('Deal Duplicated', `Created copy: ${newDeal.businessName}`, 'success');
}

// ============================================
// INITIALIZE NEW FEATURES
// ============================================
document.addEventListener('DOMContentLoaded', () => {
  initKeyboardShortcuts();
});

function saveCurrentDeal() {
  if (!currentDeal) return;
  saveDealsToStorage();
  showToast('Deal Saved', 'Changes have been saved');
}
</script>
</body>
</html>
