<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GREATDANE | Intelligent Underwriting</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-tertiary: #1a1a1a;
      --bg-card: #111111;
      --text-primary: #f5f5f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --tier-a: #22c55e;
      --tier-b: #84cc16;
      --tier-c: #eab308;
      --tier-d: #f97316;
      --tier-e: #ef4444;
      --accent-blue: #3b82f6;
      --accent-purple: #a855f7;
      --border-primary: #27272a;
      --border-secondary: #1f1f22;
      --glow-gold: rgba(234, 179, 8, 0.15);
    }
    
    /* LIGHT MODE */
    body.light-mode {
      --bg-primary: #f8f8f8;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f0f0f0;
      --bg-card: #ffffff;
      --text-primary: #18181b;
      --text-secondary: #52525b;
      --text-muted: #71717a;
      --border-primary: #e4e4e7;
      --border-secondary: #d4d4d8;
      --glow-gold: rgba(234, 179, 8, 0.25);
    }
    body.light-mode .bg-grid {
      background-image: linear-gradient(rgba(234, 179, 8, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.05) 1px, transparent 1px);
    }
    body.light-mode .bg-gradient {
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(234, 179, 8, 0.12), transparent);
    }
    body.light-mode .main-header {
      background: rgba(255, 255, 255, 0.95);
    }
    body.light-mode .login-overlay {
      background: rgba(255, 255, 255, 0.98);
    }
    body.light-mode .loading-overlay {
      background: rgba(255, 255, 255, 0.98);
    }
    
    /* THEME TOGGLE */
    .theme-toggle {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .theme-toggle svg { width: 18px; height: 18px; }
    .theme-toggle .sun-icon { display: none; }
    .theme-toggle .moon-icon { display: block; }
    body.light-mode .theme-toggle .sun-icon { display: block; }
    body.light-mode .theme-toggle .moon-icon { display: none; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      overflow-x: hidden;
      width: 100%;
      max-width: 100vw;
    }
    body {
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: linear-gradient(rgba(234, 179, 8, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(234, 179, 8, 0.02) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }
    .bg-gradient {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 600px;
      background: radial-gradient(ellipse 80% 50% at 50% 0%, var(--glow-gold), transparent);
      pointer-events: none;
      z-index: 0;
    }

    /* HEADER */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(10, 10, 10, 0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-secondary);
      z-index: 100;
    }
    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo img,
    .header-logo > svg {
      width: 36px;
      height: 36px;
      border-radius: 10px;
    }
    .header-logo h1 {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: -0.5px;
    }
    .header-logo h1 span { color: var(--text-muted); }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .search-input-wrap {
      display: flex;
      align-items: center;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 50px;
      padding: 4px 4px 4px 14px;
      gap: 8px;
      transition: all 0.2s;
    }
    .search-input-wrap:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow-gold);
    }
    .search-input-wrap svg:first-child { width: 14px; height: 14px; color: var(--text-muted); flex-shrink: 0; }
    .search-input-wrap input {
      width: 180px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
    }
    .search-input-wrap input:focus { outline: none; }
    .search-input-wrap input::placeholder { color: var(--text-muted); }
    .search-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 2px solid var(--accent);
      border-radius: 50%;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .search-btn:hover {
      background: var(--accent);
      color: #000;
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
    }
    .search-btn svg { width: 14px; height: 14px; }
    .btn-primary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary:hover {
      background: rgba(234, 179, 8, 0.1);
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(234, 179, 8, 0.2);
    }
    .btn-primary svg { width: 16px; height: 16px; }
    .btn-secondary {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn-secondary svg { width: 14px; height: 14px; }
    .btn-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .btn-icon svg { width: 18px; height: 18px; }

    /* INTEL TABS */
    .intel-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .intel-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .intel-tab:hover {
      color: var(--text-primary);
      background: var(--bg-secondary);
    }
    .intel-tab.active {
      background: var(--bg-secondary);
      color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .intel-tab svg { width: 14px; height: 14px; }
    .intel-tab .tab-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 10px;
      background: var(--bg-primary);
    }
    .intel-tab.active .tab-badge {
      background: rgba(234, 179, 8, 0.2);
      color: var(--accent);
    }
    .intel-tab.has-data .tab-badge {
      background: rgba(34, 197, 94, 0.2);
      color: var(--tier-a);
    }
    .intel-tab.has-warning .tab-badge {
      background: rgba(239, 68, 68, 0.2);
      color: var(--tier-e);
    }
    .intel-panel {
      display: none;
    }
    .intel-panel.active {
      display: block;
    }

    /* LAYOUT */
    .app-container {
      display: flex;
      padding-top: 64px;
      min-height: 100vh;
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      flex-shrink: 0;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-secondary);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
      position: sticky;
      top: 64px;
    }
    .sidebar.collapsed {
      width: 0;
      overflow: hidden;
      border-right: none;
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-secondary);
    }
    .sidebar-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .sidebar-title h2 {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    .sidebar-title button {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.2s;
    }
    .sidebar-title button:hover {
      background: var(--glow-gold);
      border-color: var(--accent);
    }
    .sidebar-title button svg { width: 14px; height: 14px; }
    .sidebar-search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
    }
    .sidebar-search svg { width: 14px; height: 14px; color: var(--text-muted); flex-shrink: 0; }
    .sidebar-search input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.8rem;
      font-family: inherit;
    }
    .sidebar-search input:focus { outline: none; }
    .sidebar-search input::placeholder { color: var(--text-muted); }
    .deal-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .deal-item {
      padding: 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      margin-bottom: 4px;
    }
    .deal-item:hover {
      background: var(--bg-tertiary);
      border-left-color: var(--accent);
    }
    .deal-item.active {
      background: var(--bg-tertiary);
      border-left-color: var(--accent);
    }
    .deal-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .deal-item-name {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 160px;
    }
    .deal-item-score {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
    }
    .deal-item-progress {
      height: 4px;
      background: var(--border-primary);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .deal-item-progress-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }
    .deal-item-owner {
      font-size: 0.7rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .sidebar-footer strong { color: var(--accent); }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    .empty-state svg { width: 40px; height: 40px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 0.8rem; }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      min-width: 0;
      padding: 24px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* DASHBOARD */
    .dashboard-view { max-width: 1200px; margin: 0 auto; }
    
    /* DETAIL VIEW - FULL WIDTH */
    .detail-view {
      display: none;
    }
    .detail-view.active { display: block; }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      opacity: 0;
      transition: opacity 0.3s;
    }
    .metric-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent);
      box-shadow: 0 12px 32px rgba(234, 179, 8, 0.12);
    }
    .metric-card:hover::before { opacity: 1; }
    .metric-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .metric-value { font-size: 1.75rem; font-weight: 700; }
    .metric-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 24px;
      position: relative;
    }
    .chart-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      border-radius: 16px 16px 0 0;
    }
    .chart-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-title svg { width: 16px; height: 16px; }
    .chart-container { height: 240px; }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-family: inherit;
      cursor: pointer;
      transition: color 0.2s;
      margin-bottom: 24px;
    }
    .back-btn:hover { color: var(--text-primary); }
    .back-btn svg { width: 16px; height: 16px; }
    
    /* Top Panels Row - Equal Height */
    .top-panels-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      align-items: start;
      margin-bottom: 20px;
    }
    @media (max-width: 1200px) {
      .top-panels-row { grid-template-columns: 1fr 1fr; }
      .top-panels-row > *:nth-child(3) { grid-column: span 2; }
    }
    @media (max-width: 800px) {
      .top-panels-row { grid-template-columns: 1fr; }
      .top-panels-row > * { grid-column: span 1 !important; }
    }
    
    /* Collapsible Panel */
    .collapsible-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .collapsible-panel.collapsed .panel-body {
      max-height: 0;
      padding: 0 20px;
      opacity: 0;
      overflow: hidden;
    }
    .collapsible-panel .panel-body {
      max-height: 2000px;
      padding: 20px;
      padding-top: 0;
      opacity: 1;
      transition: all 0.3s ease;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.3s;
    }
    .panel-header:hover {
      background: var(--bg-secondary);
    }
    .collapsible-panel:not(.collapsed) .panel-header {
      border-bottom-color: var(--border-secondary);
    }
    .panel-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent);
    }
    .panel-title svg {
      width: 18px;
      height: 18px;
    }
    .panel-toggle {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    .panel-toggle:hover {
      background: var(--accent);
      color: #000;
    }
    .panel-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }
    .collapsible-panel.collapsed .panel-toggle svg {
      transform: rotate(-90deg);
    }
    
    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .metric-card {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      border: 1px solid var(--border-secondary);
    }
    .metric-card.highlight {
      background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.05));
      border-color: var(--accent);
    }
    .metric-value {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
    }
    .metric-value.positive { color: var(--tier-a); }
    .metric-value.negative { color: var(--tier-e); }
    .metric-value.warning { color: var(--accent); }
    .metric-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 6px;
    }
    .metric-change {
      font-size: 0.7rem;
      margin-top: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }
    .metric-change.up { color: var(--tier-a); }
    .metric-change.down { color: var(--tier-e); }
    
    /* AI Chat Panel */
    .ai-chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 300px;
    }
    .ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: var(--bg-secondary);
      border-radius: 10px;
      margin-bottom: 12px;
      max-height: 280px;
      min-height: 200px;
    }
    .ai-message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .ai-message.user {
      background: var(--accent);
      color: #000;
      margin-left: 20%;
      border-bottom-right-radius: 4px;
    }
    .ai-message.assistant {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      margin-right: 20%;
      border-bottom-left-radius: 4px;
    }
    .ai-message.system {
      background: transparent;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-align: center;
      padding: 6px;
    }
    .ai-chat-input-row {
      display: flex;
      gap: 8px;
    }
    .ai-chat-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 24px;
      border: 1px solid var(--border-primary);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 0.85rem;
    }
    .ai-chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .ai-chat-send {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, background 0.2s;
    }
    .ai-chat-send:hover {
      transform: scale(1.05);
      background: #d4a00a;
    }
    .ai-chat-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .ai-chat-send svg {
      width: 20px;
      height: 20px;
      color: #000;
    }
    
    /* Mini dropzone */
    .mini-dropzone {
      border: 2px dashed var(--border-primary);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-secondary);
    }
    .mini-dropzone:hover {
      border-color: var(--accent);
      background: rgba(234,179,8,0.05);
    }
    .mini-dropzone.dragover {
      border-color: var(--accent);
      background: rgba(234,179,8,0.1);
    }
    .mini-dropzone svg {
      width: 32px;
      height: 32px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .mini-dropzone h4 {
      font-size: 0.9rem;
      margin: 0 0 4px 0;
      color: var(--text-primary);
    }
    .mini-dropzone p {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0;
    }
    
    .detail-grid {
      display: flex;
      gap: 20px;
      width: 100%;
    }
    .detail-sidebar {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: all 0.3s ease;
      position: relative;
    }
    .detail-sidebar.collapsed {
      width: 48px;
      min-width: 48px;
      max-width: 48px;
      overflow: hidden;
    }
    .detail-sidebar.collapsed .card {
      opacity: 0;
      pointer-events: none;
    }
    .detail-sidebar.collapsed .sidebar-toggle {
      transform: rotate(180deg);
    }
    .sidebar-toggle {
      position: absolute;
      top: 8px;
      right: -12px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-primary);
      border: 1px solid var(--border-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .sidebar-toggle:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .sidebar-toggle svg {
      width: 14px;
      height: 14px;
    }
    .detail-main {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .detail-main > * {
      width: 100% !important;
      box-sizing: border-box;
    }
    .detail-main .card,
    .detail-main .dropzone,
    .detail-main .info-cards-row,
    .detail-main .table-wrapper {
      width: 100% !important;
    }
    @media (max-width: 1100px) {
      .detail-sidebar { width: 240px; min-width: 240px; max-width: 240px; }
      .detail-sidebar.collapsed { width: 48px; min-width: 48px; max-width: 48px; }
    }
    @media (max-width: 900px) {
      .detail-grid { 
        flex-direction: column;
      }
      .detail-sidebar { 
        order: 1; 
        width: 100% !important; 
        min-width: 100% !important;
        max-width: 100% !important;
      }
      .detail-sidebar.collapsed {
        width: 100% !important;
        min-width: 100% !important;
        max-width: 100% !important;
      }
      .sidebar-toggle { display: none; }
      .detail-main { order: 0; }
    }
    .info-cards-row {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
    }
    .info-cards-row > .card {
      width: 100% !important;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      box-sizing: border-box;
    }
    .card-accent::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light), var(--tier-d));
      border-radius: 16px 16px 0 0;
    }
    .card-title {
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title svg { width: 14px; height: 14px; }

    /* SCORE CARD */
    .score-card {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .score-ring {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: conic-gradient(var(--score-color, var(--tier-c)) calc(var(--pct, 0) * 1%), var(--border-primary) 0);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .score-ring-inner {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .score-number { font-size: 1.5rem; font-weight: 800; }
    .score-info .score-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .score-info .score-tier { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }
    .score-info .score-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }
    
    /* Score Breakdown */
    .score-breakdown {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-secondary);
    }
    .score-breakdown-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 12px;
    }
    .score-component {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    .score-component:last-child { border-bottom: none; }
    .score-comp-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    .score-comp-value {
      font-size: 0.85rem;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    .score-component.score-total {
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid var(--accent);
      border-bottom: none;
    }
    .score-component.score-total .score-comp-label {
      color: var(--text-primary);
      font-weight: 600;
    }
    .score-component.score-total .score-comp-value {
      color: var(--accent);
      font-size: 1rem;
    }
    .text-negative { color: var(--tier-e); }
    .text-positive { color: var(--tier-a); }
    .text-accent { color: var(--accent); }

    /* FORMS */
    .form-group { margin-bottom: 16px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: block;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .form-input {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.2s;
    }
    .form-input:hover { border-color: var(--border-primary); }
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--glow-gold);
    }
    .form-input::placeholder { color: var(--text-muted); }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* DATA TABLE */
    .table-wrapper { overflow-x: auto; width: 100%; max-width: 100%; }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    .data-table th {
      padding: 12px 16px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      text-align: center;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-primary);
    }
    .data-table th:first-child { text-align: left; border-radius: 8px 0 0 0; }
    .data-table th:last-child { border-radius: 0 8px 0 0; }
    .data-table td {
      padding: 12px 16px;
      font-size: 0.85rem;
      text-align: center;
      border-bottom: 1px solid var(--border-secondary);
      color: var(--text-secondary);
    }
    .data-table td:first-child {
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
    }
    .data-table tr:hover td { background: var(--bg-secondary); }
    .table-input {
      width: 100%;
      padding: 6px;
      background: transparent;
      border: none;
      border-bottom: 1px solid transparent;
      color: inherit;
      font-size: inherit;
      font-weight: 500;
      font-family: inherit;
      text-align: center;
      font-feature-settings: "tnum";
      transition: border-color 0.2s;
    }
    .table-input:focus {
      outline: none;
      border-bottom-color: var(--accent);
    }
    .table-positive { color: var(--tier-a); }
    .table-negative { color: var(--tier-e); }
    .table-warning { color: var(--tier-d); }

    /* OFFER CALCULATOR */
    .offer-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .offer-tab {
      padding: 10px 20px;
      background: transparent;
      border: 2px solid var(--border-primary);
      border-radius: 50px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .offer-tab:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }
    .offer-tab.active {
      background: transparent;
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent), 0 0 12px rgba(234, 179, 8, 0.2);
    }
    .offer-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .offer-stat {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 16px;
    }
    .offer-stat-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .offer-stat-value { font-size: 1.25rem; font-weight: 700; }
    .slider-group { margin-bottom: 16px; }
    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .slider-label { font-size: 0.75rem; color: var(--text-muted); }
    .slider-value { font-size: 0.85rem; font-weight: 700; color: var(--accent); }
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: var(--border-primary);
      border-radius: 3px;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(234, 179, 8, 0.4);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(234, 179, 8, 0.5);
    }

    /* MODALS */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s;
      padding: 24px;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.25s;
    }
    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      background: var(--bg-tertiary);
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; }
    .modal-subtitle { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
    .modal-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-close:hover {
      border-color: var(--tier-e);
      color: var(--tier-e);
      background: rgba(239, 68, 68, 0.1);
    }
    .modal-close svg { width: 18px; height: 18px; }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(90vh - 100px);
    }

    /* LOGIN OVERLAY */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .login-overlay.hidden { display: none; }
    .login-card { width: 100%; max-width: 380px; }
    .login-header { text-align: center; margin-bottom: 40px; }
    .login-logo { position: relative; margin-bottom: 20px; }
    .login-logo img,
    .login-logo > svg {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      position: relative;
    }
    .login-logo::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(234, 179, 8, 0.3) 0%, transparent 70%);
      filter: blur(20px);
    }
    .login-brand { font-size: 1.75rem; font-weight: 800; letter-spacing: -1px; }
    .login-brand span { color: var(--text-muted); }
    .login-tagline { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
    .login-form { display: flex; flex-direction: column; gap: 16px; }
    .login-error {
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: var(--tier-e);
      font-size: 0.8rem;
      text-align: center;
      display: none;
    }
    .login-error.active { display: block; }
    .login-footer { text-align: center; margin-top: 40px; }
    .login-footer p {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .login-footer .engine { color: var(--accent); margin-top: 8px; }

    /* LOADING OVERLAY */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      z-index: 1500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .loading-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .loading-content { width: 100%; max-width: 600px; }
    .loading-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-primary);
      margin-bottom: 32px;
    }
    .loading-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .loading-brand img,
    .loading-brand > svg { width: 40px; height: 40px; border-radius: 10px; }
    .loading-brand h2 { font-size: 1.1rem; font-weight: 800; }
    .loading-brand h2 span { color: var(--text-muted); }
    .loading-brand p { font-size: 0.75rem; color: var(--text-muted); }
    .loading-timer { text-align: right; }
    .loading-timer .time {
      font-size: 2rem;
      font-weight: 700;
      font-family: monospace;
      color: var(--accent);
    }
    .loading-timer .label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }
    .loading-phase { margin-bottom: 32px; }
    .loading-phase h3 { font-size: 1rem; font-weight: 700; margin-bottom: 8px; }
    .loading-phase p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
    .loading-progress {
      height: 4px;
      background: var(--border-primary);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--tier-a));
      border-radius: 2px;
      transition: width 0.3s;
    }
    .loading-footer {
      display: flex;
      justify-content: space-between;
      font-size: 0.65rem;
      font-family: monospace;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* UTILITIES */
    .text-positive { color: var(--tier-a); }
    .text-warning { color: var(--tier-d); }
    .text-negative { color: var(--tier-e); }
    .text-accent { color: var(--accent); }
    .text-blue { color: var(--accent-blue); }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }
    .shake { animation: shake 0.4s; }
    
    @keyframes slideInToast {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutToast {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* DROPZONE */
    .dropzone {
      border: 2px dashed var(--border-primary);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: var(--bg-secondary);
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    .dropzone:hover, .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .dropzone.dragover {
      transform: scale(1.01);
      box-shadow: 0 0 0 4px var(--glow-gold);
    }
    .dropzone svg { width: 48px; height: 48px; color: var(--text-muted); margin-bottom: 12px; }
    .dropzone:hover svg { color: var(--accent); }
    .dropzone h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
    .dropzone p { font-size: 0.8rem; color: var(--text-muted); }
    .dropzone .hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 12px; opacity: 0.7; }
    .dropzone-mini {
      border: 2px dashed var(--border-primary);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-tertiary);
    }
    .dropzone-mini:hover {
      border-color: var(--accent);
      background: rgba(234, 179, 8, 0.05);
    }
    .dropzone-mini svg { width: 24px; height: 24px; color: var(--text-muted); margin-bottom: 8px; }
    .dropzone-mini:hover svg { color: var(--accent); }
    .dropzone-mini p { font-size: 0.75rem; color: var(--text-muted); }
  
    /* PROFILE COMPLETENESS + LINEAGE */
    .completion-bar {
      height: 8px;
      background: var(--border-primary);
      border-radius: 999px;
      overflow: hidden;
      margin: 10px 0 12px;
    }
    .completion-bar > div {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--tier-e), var(--tier-c), var(--tier-a));
      transition: width 0.25s ease;
    }
    .checklist { display: flex; flex-direction: column; gap: 8px; }
    .check-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .check-item strong { color: var(--text-primary); font-weight: 600; }
    .check-item .tag {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-primary);
      color: var(--text-muted);
      white-space: nowrap;
    }
    .mini-btn-row { display: flex; gap: 10px; margin-top: 14px; }
    .source-links a { color: var(--accent); text-decoration: none; word-break: break-word; display: inline-block; margin-top: 6px; font-size: 0.8rem; }
    .source-links a:hover { text-decoration: underline; }

    /* KPI GRID */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    .kpi-stat {
      background: var(--bg-secondary);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 14px;
      min-width: 0;
    }
    .kpi-label {
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .kpi-value { font-size: 1.1rem; font-weight: 700; font-variant-numeric: tabular-nums; }
    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .kpi-grid { grid-template-columns: 1fr; } }


    /* DEAL LIST BADGES */
    .deal-item-submeta {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .deal-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-primary);
      background: rgba(255,255,255,0.03);
    }

    /* GRADIENT LOGO */
    .header-logo img,
    .header-logo > svg,
    .login-logo img,
    .login-logo > svg,
    .loading-brand img,
    .loading-brand > svg {
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(234, 179, 8, 0.15);
    }

    /* MOBILE RESPONSIVE */
    @media (max-width: 768px) {
      .main-header {
        padding: 0 12px;
        height: 56px;
      }
      .header-logo h1 {
        font-size: 1rem;
      }
      .header-actions {
        gap: 8px;
      }
      .search-input-wrap {
        display: none;
      }
      .btn-primary {
        padding: 8px 12px;
        font-size: 0.75rem;
      }
      .btn-primary svg {
        width: 14px;
        height: 14px;
      }
      .btn-icon {
        width: 36px;
        height: 36px;
      }
      .theme-toggle {
        width: 36px;
        height: 36px;
      }
      .app-container {
        flex-direction: column;
        padding-top: 56px;
      }
      .sidebar {
        width: 100%;
        min-width: 100%;
        height: auto;
        max-height: 200px;
        position: relative;
        top: 0;
        border-right: none;
        border-bottom: 1px solid var(--border-secondary);
      }
      .sidebar.collapsed {
        display: none;
      }
      .sidebar-header {
        padding: 12px;
      }
      .deal-list {
        max-height: 120px;
      }
      .sidebar-footer {
        padding: 10px 12px;
      }
      .main-content {
        padding: 12px;
      }
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .metric-card {
        padding: 14px;
      }
      .metric-value {
        font-size: 1.25rem;
      }
      .card {
        padding: 16px;
      }
      .dropzone {
        padding: 24px 16px;
      }
      .dropzone h3 {
        font-size: 0.9rem;
      }
      .offer-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .data-table {
        min-width: 500px;
      }
      .form-row {
        grid-template-columns: 1fr;
        gap: 0;
      }
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
      .sidebar {
        max-height: 150px;
      }
      .deal-list {
        max-height: 80px;
      }
      .offer-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .offer-stat {
        padding: 12px;
      }
    }

  </style>
</head>
<body class="light-mode">
  <div class="bg-grid"></div>
  <div class="bg-gradient"></div>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">
          <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="GREATDANE" style="width: 80px; height: 80px; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);">
        </div>
        <h1 class="login-brand">GREAT<span>DANE</span></h1>
        <p class="login-tagline">Intelligent Underwriting Platform</p>
      </div>
      <div class="login-form">
        <div class="login-error" id="loginError">Invalid credentials. Password must end with !#</div>
        <div class="form-group">
          <label class="form-label">Username</label>
          <input type="text" class="form-input" id="loginUser" placeholder="admin@greatdane.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="loginPass" placeholder="Enter password">
        </div>
        <button class="btn-primary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="handleLogin()">Sign In</button>
      </div>
      <div class="login-footer">
        <p>Secure System Access Only</p>
        <p class="engine">Powered by ABLESCORE Engine v4.2</p>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-header">
        <div class="loading-brand">
          <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="GREATDANE" style="width: 40px; height: 40px; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);">
          <div>
            <h2>GREAT<span>DANE</span></h2>
            <p>Analyzing Documents</p>
          </div>
        </div>
        <div class="loading-timer">
          <div class="time" id="loadingTimer">00:45</div>
          <div class="label">Time Remaining</div>
        </div>
      </div>
      <div class="loading-phase">
        <h3 id="loadingTitle">Initializing Analysis</h3>
        <p id="loadingDesc">Please wait while we process your documents...</p>
      </div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loadingBar" style="width: 0%;"></div>
      </div>
      <div class="loading-footer">
        <span>ENGINE: DANESCORE v4.2</span>
        <span id="loadingPercent">0% COMPLETE</span>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="main-header">
    <div class="header-logo">
      <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="GREATDANE" style="width: 36px; height: 36px; filter: sepia(1) saturate(5) hue-rotate(10deg) brightness(1.1);">
      <h1>GREAT<span>DANE</span></h1>
    </div>
    <div class="header-actions">
      <div class="search-input-wrap" style="width: 280px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="entitySearchInput" placeholder="Business name..." autocomplete="off" style="width: 100%;">
        <button class="search-btn" onclick="createDealAndSearch()" title="Create Deal & Search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
      <button class="btn-primary" onclick="document.getElementById('headerFileUpload').click()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
        Quick Scrub
      </button>
      <input type="file" id="headerFileUpload" style="display: none;" accept=".pdf,image/*" multiple onchange="handleHeaderQuickScrub(event)">
      <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
        <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <button class="btn-icon" onclick="openSettingsModal()" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
  </header>

  <!-- APP -->
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="dealsSidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">
          <h2>Deal Pipeline</h2>
          <button onclick="addNewDeal()" title="Add New Deal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
        <div class="sidebar-search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="dealSearch" placeholder="Search deals..." oninput="filterDeals(this.value)">
        </div>
      </div>
      <div class="deal-list" id="dealList">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <p>No deals yet. Upload bank statements to get started.</p>
        </div>
      </div>
      <div class="sidebar-footer">
        <span>Total in Pipeline</span>
        <strong id="pipelineTotal">0</strong>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <!-- DASHBOARD -->
      <div class="dashboard-view" id="dashboardView">
        <div class="metrics-grid">
          <div class="metric-card" onclick="openMetricModal('revenue')">
            <div class="metric-label">Total Revenue</div>
            <div class="metric-value text-positive" id="dashRevenue">$0</div>
            <div class="metric-hint">Click for breakdown</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('score')">
            <div class="metric-label">Avg ABLESCORE</div>
            <div class="metric-value text-accent" id="dashScore">0</div>
            <div class="metric-hint">Click for distribution</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('approval')">
            <div class="metric-label">Approval Rate</div>
            <div class="metric-value text-blue" id="dashApproval">0%</div>
            <div class="metric-hint">Click for trends</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('risk')">
            <div class="metric-label">High Risk Deals</div>
            <div class="metric-value text-negative" id="dashRisk">0</div>
            <div class="metric-hint">Click for details</div>
          </div>
        </div>

        <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
          <div class="metric-card" onclick="openMetricModal('deals')">
            <div class="metric-label">Total Deals</div>
            <div class="metric-value" id="dashDeals">0</div>
            <div class="metric-hint">Click for activity</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('avg_monthly_revenue')">
            <div class="metric-label">Avg Monthly Revenue</div>
            <div class="metric-value text-positive" id="dashAvgMonthlyRev">$0</div>
            <div class="metric-hint">Across all deals</div>
          </div>
          <div class="metric-card" onclick="openMetricModal('completion')">
            <div class="metric-label">Avg Profile Completion</div>
            <div class="metric-value text-accent" id="dashCompletion">0%</div>
            <div class="metric-hint">Data quality signal</div>
          </div>
        </div>
        <div class="charts-grid">
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
              Score Distribution
            </div>
            <div class="chart-container"><canvas id="scoreChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
              Deal Activity
            </div>
            <div class="chart-container"><canvas id="volumeChart"></canvas></div>
          </div>
        </div>

        <div class="charts-grid" style="margin-top: 24px;">
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 14l3-3 4 4 6-6"/></svg>
              Revenue Trend
            </div>
            <div class="chart-container"><canvas id="revenueTrendChart"></canvas></div>
          </div>
          <div class="chart-card">
            <div class="chart-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
              Data Completeness
            </div>
            <div class="chart-container"><canvas id="completionChart"></canvas></div>
          </div>
        </div>
      </div>

      <!-- DETAIL -->
      <div class="detail-view" id="detailView">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <button class="back-btn" onclick="showDashboard()" style="margin-bottom: 0;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
            Back to Dashboard
          </button>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn-secondary" onclick="document.getElementById('rescrubUploadMain').click()" style="padding: 8px 14px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Re-Scrub
            </button>
            <input type="file" id="rescrubUploadMain" style="display: none;" accept=".pdf,image/*" multiple onchange="handleReScrub(event)">
            <button class="btn-secondary" onclick="fullReScrub()" style="padding: 8px 14px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
              Full Re-Scrub
            </button>
          </div>
        </div>
        
        <!-- TOP PANELS ROW - All Same Height, Collapsible -->
        <div class="top-panels-row">
          <!-- ABLESCORE & METRICS PANEL -->
          <div class="collapsible-panel" id="panelScore">
            <div class="panel-header" onclick="togglePanel('panelScore')">
              <div class="panel-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                ABLESCORE & Metrics
              </div>
              <button class="panel-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
            </div>
            <div class="panel-body">
              <!-- Score Ring -->
              <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                <div class="score-ring" id="scoreRing" style="--pct: 0; --score-color: var(--tier-c); flex-shrink: 0;">
                  <div class="score-ring-inner"><span class="score-number" id="mainScore">0</span></div>
                </div>
                <div>
                  <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em;">ABLESCORE v4.2</div>
                  <div style="font-size: 1.4rem; font-weight: 700;" id="scoreTier">Analyzing...</div>
                  <div style="font-size: 0.75rem; color: var(--text-muted);">Adjusted by risk factors</div>
                </div>
              </div>
              
              <!-- Enhanced Metrics Grid -->
              <div class="metrics-grid">
                <div class="metric-card highlight">
                  <div class="metric-value" id="metricFico">--</div>
                  <div class="metric-label">FICO</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricAvgRev">--</div>
                  <div class="metric-label">Avg Monthly Rev</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricDeposits">--</div>
                  <div class="metric-label">Total Deposits</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricAvgBal">--</div>
                  <div class="metric-label">Avg Daily Bal</div>
                </div>
              </div>
              
              <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="metric-card">
                  <div class="metric-value" id="metricNsf">0</div>
                  <div class="metric-label">NSFs</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricNegDays">0</div>
                  <div class="metric-label">Neg Days</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="metricMonths">0</div>
                  <div class="metric-label">Months Data</div>
                </div>
              </div>
              
              <!-- Score Components -->
              <div class="score-breakdown" id="scoreBreakdown" style="margin-top: 16px;">
                <div class="score-breakdown-title">Score Components</div>
                <div class="score-component">
                  <span class="score-comp-label">FICO Base</span>
                  <span class="score-comp-value" id="compFico">0</span>
                </div>
                <div class="score-component">
                  <span class="score-comp-label">Revenue Consistency</span>
                  <span class="score-comp-value" id="compRevenue">0</span>
                </div>
                <div class="score-component">
                  <span class="score-comp-label">NSF Penalty</span>
                  <span class="score-comp-value text-negative" id="compNsf">0</span>
                </div>
                <div class="score-component">
                  <span class="score-comp-label">Negative Days Penalty</span>
                  <span class="score-comp-value text-negative" id="compNegDays">0</span>
                </div>
                <div class="score-component score-total">
                  <span class="score-comp-label">Final Score</span>
                  <span class="score-comp-value" id="compTotal">0</span>
                </div>
              </div>
              
              <!-- Profile Completeness -->
              <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Profile Completeness</span>
                  <span style="font-size: 1.1rem; font-weight: 700;" id="profileCompletionPct">0%</span>
                </div>
                <div class="completion-bar"><div id="profileCompletionBar"></div></div>
                <div class="checklist" id="profileMissingList" style="margin-top: 10px;"></div>
              </div>
            </div>
          </div>
          
          <!-- QUICK SCRUB PANEL -->
          <div class="collapsible-panel" id="panelQuickScrub">
            <div class="panel-header" onclick="togglePanel('panelQuickScrub')">
              <div class="panel-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                Quick Scrub
              </div>
              <button class="panel-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
            </div>
            <div class="panel-body">
              <div class="mini-dropzone" id="miniQuickScrubZone" onclick="document.getElementById('quickScrubInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <h4>Drop Bank Statements Here</h4>
                <p>PDF or images - auto-fills financial data</p>
              </div>
              <input type="file" id="quickScrubInput" style="display: none;" accept=".pdf,image/*" multiple onchange="handleQuickScrub(event)">
              
              <!-- Statement Summary -->
              <div style="margin-top: 16px; padding: 14px; background: var(--bg-secondary); border-radius: 10px;">
                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px;">Statement Summary</div>
                <div id="bankSummaryBody" style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.7;">
                  No statements processed yet.
                </div>
              </div>
              
              <!-- Entity Verification Status -->
              <div style="margin-top: 16px; padding: 14px; background: var(--bg-secondary); border-radius: 10px;">
                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 10px;">Entity Verification</div>
                <div id="entityVerifySummary" style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.7;">
                  Run entity verification to enrich the profile.
                </div>
                <div class="source-links" id="entityVerifySources" style="margin-top: 10px;"></div>
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                  <button class="btn-secondary" style="flex: 1; justify-content: center; padding: 8px;" onclick="refreshEntityVerification()">Refresh</button>
                  <button class="btn-secondary" style="flex: 1; justify-content: center; padding: 8px; border-color: var(--accent); color: var(--accent);" onclick="runDeepResearch()">Deep Research</button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- HUBBLE AI CHAT PANEL -->
          <div class="collapsible-panel" id="panelHubble">
            <div class="panel-header" onclick="togglePanel('panelHubble')">
              <div class="panel-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Hubble
              </div>
              <button class="panel-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
            </div>
            <div class="panel-body">
              <div class="ai-chat-container">
                <div class="ai-chat-messages" id="hubbleMessages">
                  <div class="ai-message system">Ask me anything about this deal. I can analyze financials, research the business, assess risk, and more.</div>
                </div>
                <div class="ai-chat-input-row">
                  <input type="text" class="ai-chat-input" id="hubbleInput" placeholder="Ask about this business..." onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendHubbleMessage(); }">
                  <button class="ai-chat-send" onclick="sendHubbleMessage()" id="hubbleSendBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                  </button>
                </div>
              </div>
              <div style="margin-top: 12px;">
                <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">Quick Prompts:</div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <button class="btn-secondary" style="padding: 6px 10px; font-size: 0.7rem;" onclick="quickHubble('Analyze the cash flow health')">Cash Flow</button>
                  <button class="btn-secondary" style="padding: 6px 10px; font-size: 0.7rem;" onclick="quickHubble('What are the main risk factors?')">Risk Factors</button>
                  <button class="btn-secondary" style="padding: 6px 10px; font-size: 0.7rem;" onclick="quickHubble('Recommend funding amount')">Funding Rec</button>
                  <button class="btn-secondary" style="padding: 6px 10px; font-size: 0.7rem;" onclick="quickHubble('Summarize this deal')">Summary</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="detail-grid">
          <div class="detail-sidebar" id="detailSidebar" style="display: none;">
            <!-- Sidebar content moved to top panels -->
          </div>

          <div class="detail-main">
            <!-- INTEL CENTER - Main Navigation -->
            <div class="card" id="intelCenter">
              <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
                  Business Intelligence Center
                </div>
              </div>
              
              <!-- Custom Query Search -->
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <input type="text" id="customResearchQuery" class="form-input" placeholder="Ask any question about this business..." style="flex: 1; font-size: 0.85rem; border-color: var(--accent);" onkeydown="if(event.key==='Enter') runCustomQuery()">
                <button class="btn-secondary" style="padding: 8px 16px; white-space: nowrap; border-color: var(--accent); color: var(--accent);" onclick="runCustomQuery()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  Search
                </button>
              </div>
              
              <!-- Intel Tabs - BUSINESS first -->
              <div class="intel-tabs" style="margin-top: 16px;">
                <button class="intel-tab active" onclick="switchIntelTab('business')" id="tabBusiness">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                  BUSINESS
                  <span class="tab-badge has-data" id="badgeBusiness">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('research')" id="tabResearch">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  RESEARCH
                  <span class="tab-badge" id="badgeResearch">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('clear')" id="tabClear">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  BACKGROUND
                  <span class="tab-badge" id="badgeClear">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('footprint')" id="tabFootprint">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                  FOOTPRINT
                  <span class="tab-badge" id="badgeFootprint">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('debt')" id="tabDebt">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                  DEBT
                  <span class="tab-badge" id="badgeDebt">--</span>
                </button>
                <button class="intel-tab" onclick="switchIntelTab('credit')" id="tabCredit">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  CREDIT
                  <span class="tab-badge" id="badgeCredit">--</span>
                </button>
              </div>
              
              <!-- ==================== BUSINESS PANEL ==================== -->
              <div class="intel-panel active" id="panelBusiness">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <!-- Business Info Column -->
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                      Business Info
                    </div>
                    <div class="form-group">
                      <label class="form-label">Legal Name</label>
                      <input type="text" class="form-input" id="editLegalName" placeholder="Business Name" oninput="updateDealField('businessName', this.value)">
                    </div>
                    <div class="form-group">
                      <label class="form-label">DBA</label>
                      <input type="text" class="form-input" id="editDba" placeholder="Doing Business As" oninput="updateDealField('dba', this.value)">
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-input" id="editIndustry" placeholder="Industry" oninput="updateDealField('industry', this.value)">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Time in Business</label>
                        <input type="text" class="form-input" id="editTib" placeholder="e.g., 5 years" oninput="updateDealField('tib', this.value)">
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="form-label">Address</label>
                      <input type="text" class="form-input" id="editAddress" placeholder="Business Address" oninput="updateDealField('address', this.value)">
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Incorp. State</label>
                        <input type="text" class="form-input" id="editStateCode" placeholder="e.g., DE" maxlength="2" oninput="updateDealField('stateCode', this.value.toUpperCase())">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Entity Type</label>
                        <input type="text" class="form-input" id="editEntityType" placeholder="LLC / Corp / LP" oninput="updateDealField('entityType', this.value)">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Formation Date</label>
                        <input type="date" class="form-input" id="editFormationDate" oninput="updateFormationDate(this.value)">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-input" id="editEntityStatus" placeholder="Active / Inactive" oninput="updateDealField('entityStatus', this.value)">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="text" class="form-input" id="editWebsite" placeholder="https://..." oninput="updateDealField('website', this.value)">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-input" id="editPhone" placeholder="(###) ###-####" oninput="updateDealField('phone', this.value)">
                      </div>
                    </div>
                  </div>
                  <!-- Owner Info Column -->
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                      Owner Info
                    </div>
                    <div class="form-group">
                      <label class="form-label">Owner Name</label>
                      <input type="text" class="form-input" id="editOwnerName" placeholder="Owner Name" oninput="updateDealField('ownerName', this.value)">
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">FICO Score</label>
                        <input type="number" class="form-input" id="editFico" placeholder="FICO" oninput="updateDealField('fico', this.value); recalculateScore();">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Ownership %</label>
                        <input type="number" class="form-input" id="editOwnership" placeholder="%" oninput="updateDealField('ownership', this.value)">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Owner Email</label>
                        <input type="text" class="form-input" id="editOwnerEmail" placeholder="name@email.com" oninput="updateDealField('ownerEmail', this.value)">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Owner Phone</label>
                        <input type="text" class="form-input" id="editOwnerPhone" placeholder="(###) ###-####" oninput="updateDealField('ownerPhone', this.value)">
                      </div>
                    </div>
                    
                    <!-- Entity Verification Summary -->
                    <div style="margin-top: 20px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                      <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 14px; height: 14px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        Entity Verification
                      </div>
                      <div id="entityVerifySummary2" style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.6;">
                        Enter business name to verify entity.
                      </div>
                      <div class="source-links" id="entityVerifySources2" style="margin-top: 10px;"></div>
                      <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn-secondary" style="flex: 1; padding: 6px; font-size: 0.75rem;" onclick="refreshEntityVerification()">Refresh</button>
                        <button class="btn-secondary" style="flex: 1; padding: 6px; font-size: 0.75rem;" onclick="openEntityForCurrentDeal()">View Report</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== RESEARCH PANEL ==================== -->
              <div class="intel-panel" id="panelResearch">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="runDeepResearch()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Run Research
                  </button>
                </div>
                <!-- Risk Rating Banner -->
                <div id="researchRiskBanner" style="border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; background: var(--bg-secondary);">
                  <div id="researchRiskBadge" style="width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary);">
                    <span id="researchRiskLetter" style="font-size: 1.5rem; font-weight: 800; color: var(--text-muted);">?</span>
                  </div>
                  <div>
                    <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em;">Risk Rating</div>
                    <div id="researchRiskLabel" style="font-size: 1.25rem; font-weight: 700;">Click "Run Research" to analyze</div>
                    <div id="researchConfidence" style="font-size: 0.8rem; color: var(--text-secondary);">Confidence: 0%</div>
                  </div>
                </div>
                <!-- Company Overview -->
                <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Company Overview
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.85rem;">
                    <div><span style="color: var(--text-muted);">Legal Name:</span> <span id="researchLegalName">N/A</span></div>
                    <div><span style="color: var(--text-muted);">DBA:</span> <span id="researchDba">N/A</span></div>
                    <div><span style="color: var(--text-muted);">Entity Type:</span> <span id="researchEntityType">N/A</span></div>
                    <div><span style="color: var(--text-muted);">State:</span> <span id="researchState">N/A</span></div>
                    <div><span style="color: var(--text-muted);">Formation:</span> <span id="researchFormation">N/A</span></div>
                    <div><span style="color: var(--text-muted);">Status:</span> <span id="researchStatus">N/A</span></div>
                  </div>
                </div>
                <!-- Operations & Financials Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                      Operations
                    </div>
                    <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
                      <div><span style="color: var(--text-muted);">Industry:</span> <span id="researchIndustry">N/A</span></div>
                      <div><span style="color: var(--text-muted);">NAICS:</span> <span id="researchNaics">N/A</span></div>
                      <div id="researchDescription" style="color: var(--text-secondary); margin-top: 4px;"></div>
                    </div>
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                      Financials
                    </div>
                    <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
                      <div><span style="color: var(--text-muted);">Revenue Est:</span> <span id="researchRevenue">N/A</span></div>
                      <div><span style="color: var(--text-muted);">Employees:</span> <span id="researchEmployees">N/A</span></div>
                      <div><span style="color: var(--text-muted);">Years in Business:</span> <span id="researchYears">N/A</span></div>
                      <div><span style="color: var(--text-muted);">Trend:</span> <span id="researchTrend">N/A</span></div>
                    </div>
                  </div>
                </div>
                <!-- Red Flags Section -->
                <div id="researchRedFlagsSection" style="display: none; margin-top: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px;">
                  <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Red Flags (<span id="researchRedFlagCount">0</span>)
                  </div>
                  <ul id="researchRedFlagsList" style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);"></ul>
                </div>
                <!-- Compliance & Legal Row -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Compliance & Legal
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 0.85rem;">
                    <div>
                      <div style="color: var(--text-muted); margin-bottom: 4px;">Lawsuits</div>
                      <div id="researchLawsuits" style="font-weight: 600;">0 Found</div>
                    </div>
                    <div>
                      <div style="color: var(--text-muted); margin-bottom: 4px;">Liens</div>
                      <div id="researchLiens" style="font-weight: 600;">0 Found</div>
                    </div>
                    <div>
                      <div style="color: var(--text-muted); margin-bottom: 4px;">UCC Filings</div>
                      <div id="researchUcc" style="font-weight: 600;">0 Found</div>
                    </div>
                  </div>
                </div>
                <!-- Reputation Row -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    Reputation
                  </div>
                  <div style="display: flex; gap: 32px; font-size: 0.85rem;">
                    <div>
                      <div style="color: var(--text-muted);">BBB Rating:</div>
                      <div id="researchBbb" style="font-weight: 600; font-size: 1.1rem;">N/A</div>
                    </div>
                    <div>
                      <div style="color: var(--text-muted);">Reviews:</div>
                      <div id="researchReviews" style="font-weight: 600;">N/A</div>
                    </div>
                  </div>
                </div>
                <!-- Summary -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                  <div style="font-weight: 600; margin-bottom: 12px;">Summary</div>
                  <p id="researchSummary" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">No research data yet. Click "Run Research" to analyze this business.</p>
                </div>
                <!-- Sources -->
                <div id="researchSourcesSection" style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted);">
                  <div style="font-weight: 600; margin-bottom: 8px;">Sources (<span id="researchSourceCount">0</span>)</div>
                  <div id="researchSourcesList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
                <!-- Custom Query Result -->
                <div id="customQuerySection" style="display: none; margin-top: 24px; border-top: 1px solid var(--border-primary); padding-top: 24px;">
                  <div style="font-weight: 700; font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; color: var(--accent);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    Custom Research
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div id="customQueryQuestion" style="font-weight: 600; margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem;"></div>
                    <div id="customQueryAnswer" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7;"></div>
                    <div id="customQuerySources" style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted);"></div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== BACKGROUND PANEL ==================== -->
              <div class="intel-panel" id="panelClear">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="runClearReport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Run Background Check
                  </button>
                </div>
                <div id="clearReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Background Check Data</p>
                    <p style="font-size: 0.85rem;">Click "Run Background Check" to search UCC filings, liens, judgments, and court records.</p>
                  </div>
                </div>
                <div id="clearReportSection" style="display: none;">
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>UCC Filings</span><span id="clearUccCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearUccList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Liens</span><span id="clearLiensCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearLiensList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Judgments</span><span id="clearJudgmentsCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearJudgmentsList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Court Records</span><span id="clearCourtCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearCourtList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Bankruptcies</span><span id="clearBankruptcyCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="clearBankruptcyList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Owner/Principal Background</div>
                    <div id="clearOwnerBackground" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== FOOTPRINT PANEL ==================== -->
              <div class="intel-panel" id="panelFootprint">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="runFootprintReport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Run Footprint Scan
                  </button>
                </div>
                <div id="footprintReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Digital Footprint Data</p>
                    <p style="font-size: 0.85rem;">Click "Run Footprint Scan" to search web presence, social media, and reviews.</p>
                  </div>
                </div>
                <div id="footprintReportSection" style="display: none;">
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Web Presence</div><div id="footprintWeb" style="font-size: 0.85rem;"></div></div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Social Media</div><div id="footprintSocial" style="font-size: 0.85rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;"></div></div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">Reviews Summary</div><div id="footprintReviews" style="font-size: 0.85rem;"></div></div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;"><div style="font-weight: 600; margin-bottom: 12px;">News & Mentions</div><div id="footprintNews" style="font-size: 0.85rem;"></div></div>
                </div>
              </div>
              
              <!-- ==================== DEBT PANEL ==================== -->
              <div class="intel-panel" id="panelDebt">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
                  <button class="btn-secondary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="runDebtReport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
                    Run Debt Analysis
                  </button>
                </div>
                <div id="debtReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Debt Analysis Data</p>
                    <p style="font-size: 0.85rem;">Click "Run Debt Analysis" to analyze bank statements for debt obligations.</p>
                  </div>
                </div>
                <div id="debtReportSection" style="display: none;">
                  <div style="margin-bottom: 16px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Total Est. Debt</div><div id="debtTotal" style="font-size: 1.5rem; font-weight: 700; color: var(--tier-e);">$0</div></div>
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Monthly Payments</div><div id="debtMonthly" style="font-size: 1.5rem; font-weight: 700; color: var(--tier-d);">$0</div></div>
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">Active Positions</div><div id="debtPositions" style="font-size: 1.5rem; font-weight: 700;">0</div></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Identified Debt Obligations</div>
                    <div class="table-wrapper"><table class="data-table" style="font-size: 0.8rem;"><thead><tr><th>Type</th><th>Creditor</th><th>Est. Balance</th><th>Payment</th><th>Filed Date</th><th>Status</th></tr></thead><tbody id="debtTableBody"><tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">No debt data available</td></tr></tbody></table></div>
                  </div>
                  <div style="padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Large Transactions Identified</div>
                    <div class="table-wrapper"><table class="data-table" style="font-size: 0.8rem;"><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Analysis</th></tr></thead><tbody id="largeTransactionsBody"><tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">No large transactions identified</td></tr></tbody></table></div>
                  </div>
                </div>
              </div>
              
              <!-- ==================== CREDIT PANEL ==================== -->
              <div class="intel-panel" id="panelCredit">
                <div id="creditReportContent">
                  <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    <p style="font-size: 1rem; margin-bottom: 8px;">No Credit Report Data</p>
                    <p style="font-size: 0.85rem; margin-bottom: 16px;">Upload a credit report PDF to populate this section.</p>
                    <button class="btn-primary" onclick="document.getElementById('creditReportUpload').click()" style="padding: 10px 24px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                      Upload Credit Report
                    </button>
                    <input type="file" id="creditReportUpload" style="display: none;" accept=".pdf,image/*" onchange="handleCreditReportUpload(event)">
                  </div>
                </div>
                <div id="creditReportSection" style="display: none;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <span id="creditReportBureau" style="font-size: 0.75rem; font-weight: 500; background: var(--bg-tertiary); padding: 4px 12px; border-radius: 20px;"></span>
                    <button class="btn-secondary" onclick="document.getElementById('creditReportUpload2').click()" style="padding: 6px 12px; font-size: 0.75rem;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                      Re-Upload
                    </button>
                    <input type="file" id="creditReportUpload2" style="display: none;" accept=".pdf,image/*" onchange="handleCreditReportUpload(event)">
                  </div>
                  <div style="margin-bottom: 16px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                    <div id="creditScoreFico" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">FICO</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreVantage" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Vantage</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreExperian" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Experian</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreEquifax" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">Equifax</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                    <div id="creditScoreTransunion" style="padding: 16px; background: var(--bg-secondary); border-radius: 12px; text-align: center;"><div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px;">TransUnion</div><div class="credit-score-value" style="font-size: 1.75rem; font-weight: 800;">--</div></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Account Summary</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; font-size: 0.85rem;">
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Total Accounts</div><div id="creditTotalAccounts" style="font-weight: 600; font-size: 1.1rem;">0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Open</div><div id="creditOpenAccounts" style="font-weight: 600; font-size: 1.1rem; color: var(--tier-a);">0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Delinquent</div><div id="creditDelinquentAccounts" style="font-weight: 600; font-size: 1.1rem;">0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Derogatory</div><div id="creditDerogatoryAccounts" style="font-weight: 600; font-size: 1.1rem;">0</div></div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; font-size: 0.85rem; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Total Balance</div><div id="creditTotalBalance" style="font-weight: 600; font-size: 1.1rem;">$0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Credit Limit</div><div id="creditTotalLimit" style="font-weight: 600; font-size: 1.1rem;">$0</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Utilization</div><div id="creditUtilization" style="font-weight: 600; font-size: 1.1rem;">0%</div></div>
                      <div><div style="color: var(--text-muted); font-size: 0.75rem;">Monthly Payment</div><div id="creditMonthlyPayment" style="font-weight: 600; font-size: 1.1rem;">$0</div></div>
                    </div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px;">Payment History</div>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; font-size: 0.85rem;">
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">On-Time</div><div id="creditOnTime" style="font-weight: 700; font-size: 1.25rem; color: var(--tier-a);">0%</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">30 Days</div><div id="creditLate30" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">60 Days</div><div id="creditLate60" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">90+ Days</div><div id="creditLate90" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Collections</div><div id="creditCollections" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;"><div style="font-size: 0.7rem; color: var(--text-muted);">Charge-Offs</div><div id="creditChargeOffs" style="font-weight: 700; font-size: 1.25rem;">0</div></div>
                    </div>
                  </div>
                  <div id="creditPublicRecordsSection" style="display: none; margin-bottom: 16px; padding: 16px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                      Public Records
                    </div>
                    <div id="creditPublicRecordsList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Credit Inquiries (24 months)</span><span id="creditInquiryCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div id="creditInquiriesList" style="font-size: 0.85rem;"></div>
                  </div>
                  <div style="margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;"><span>Tradelines</span><span id="creditTradelineCount" style="background: var(--bg-tertiary); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div class="table-wrapper"><table class="data-table" style="font-size: 0.75rem;"><thead><tr><th>Creditor</th><th>Type</th><th>Opened</th><th>Limit</th><th>Balance</th><th>Payment</th><th>Status</th></tr></thead><tbody id="creditTradelinesBody"><tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No tradelines available</td></tr></tbody></table></div>
                  </div>
                  <div id="creditCollectionsSection" style="display: none; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; color: var(--tier-e);"><span>Collection Accounts</span><span id="creditCollectionsCount" style="background: rgba(239, 68, 68, 0.2); color: var(--tier-e); padding: 2px 10px; border-radius: 20px; font-size: 0.75rem;">0</span></div>
                    <div class="table-wrapper"><table class="data-table" style="font-size: 0.75rem;"><thead><tr><th>Creditor</th><th>Original Creditor</th><th>Balance</th><th>Date Opened</th><th>Status</th></tr></thead><tbody id="creditCollectionsBody"><tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">No collections</td></tr></tbody></table></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-title" style="justify-content: space-between;">
                <span style="display: flex; align-items: center; gap: 8px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                  Monthly Financials
                </span>
                <button class="btn-secondary" onclick="document.getElementById('rescrubUpload').click()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                  Add Documents
                </button>
                <input type="file" id="rescrubUpload" style="display: none;" accept=".pdf,image/*" multiple onchange="handleReScrub(event)">
              </div>
              <div class="table-wrapper">
                <table class="data-table">
                  <thead>
                    <tr><th>Month</th><th>Revenue</th><th>Deposits</th><th>Withdrawals</th><th>Ending Bal</th><th>Avg Daily Bal</th><th>Dep Cnt</th><th>OD Fees</th><th>NSFs</th><th>Neg Days</th></tr>
                  </thead>
                  <tbody id="financialTableBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--text-muted);">No financial data. Upload bank statements to begin.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="card">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 15l4-4 3 3 6-6"/></svg>
                Cash Flow Insights
              </div>
              <div class="chart-container" style="height: 220px;"><canvas id="dealCashflowChart"></canvas></div>
              <div class="kpi-grid" id="dealKpis"></div>
            </div>
            <div class="card card-accent">
              <div class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/></svg>
                Offer Calculator
              </div>
              <div class="offer-tabs">
                <button class="offer-tab active" data-offer="conservative" onclick="setOfferTab('conservative')">Conservative</button>
                <button class="offer-tab" data-offer="moderate" onclick="setOfferTab('moderate')">Moderate</button>
                <button class="offer-tab" data-offer="aggressive" onclick="setOfferTab('aggressive')">Aggressive</button>
              </div>
              <div class="offer-grid">
                <div class="offer-stat">
                  <div class="offer-stat-label">Funding Amount</div>
                  <div class="offer-stat-value text-positive" id="offerAmount">$0</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label">Factor Rate</div>
                  <div class="offer-stat-value text-accent" id="offerFactor">1.00</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label">Payback Amount</div>
                  <div class="offer-stat-value" id="offerPayback">$0</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label">Term (Days)</div>
                  <div class="offer-stat-value" id="offerTerm">0</div>
                </div>
              </div>
              
              <!-- Payment Frequency Toggle -->
              <div style="margin: 16px 0;">
                <div class="slider-label" style="margin-bottom: 8px;">Payment Frequency</div>
                <div class="offer-tabs" style="width: fit-content;">
                  <button class="offer-tab active" id="freqDaily" onclick="setPaymentFrequency('daily')">Daily</button>
                  <button class="offer-tab" id="freqWeekly" onclick="setPaymentFrequency('weekly')">Weekly</button>
                </div>
              </div>
              
              <div class="offer-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="offer-stat">
                  <div class="offer-stat-label" id="paymentLabel">Daily Payment</div>
                  <div class="offer-stat-value text-accent" id="offerPayment">$0</div>
                </div>
                <div class="offer-stat">
                  <div class="offer-stat-label" id="paymentsCountLabel"># of Payments</div>
                  <div class="offer-stat-value" id="offerPaymentsCount">0</div>
                </div>
              </div>
              
              <div class="slider-group">
                <div class="slider-header">
                  <span class="slider-label">Position Multiplier</span>
                  <span class="slider-value" id="positionVal">1.0x</span>
                </div>
                <input type="range" id="positionSlider" min="0.5" max="2" step="0.1" value="1" oninput="updateOffer()">
              </div>
              <div class="slider-group">
                <div class="slider-header">
                  <span class="slider-label">Holdback %</span>
                  <span class="slider-value" id="holdbackVal">15%</span>
                </div>
                <input type="range" id="holdbackSlider" min="10" max="25" step="1" value="15" oninput="updateOffer()">
              </div>
              
              <!-- ISO Preview Section -->
              <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-primary);">
                <div class="card-title" style="margin-bottom: 12px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  ISO Fee Preview
                </div>
                <div class="form-row" style="gap: 12px;">
                  <div class="form-group" style="flex: 1;">
                    <label class="form-label">Commission %</label>
                    <input type="number" class="form-input" id="isoCommission" value="10" min="0" max="20" step="0.5" oninput="updateISOPreview()">
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <label class="form-label">Points (BPS)</label>
                    <input type="number" class="form-input" id="isoPoints" value="0" min="0" max="500" step="25" oninput="updateISOPreview()">
                  </div>
                </div>
                <div class="offer-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 12px;">
                  <div class="offer-stat">
                    <div class="offer-stat-label">Commission</div>
                    <div class="offer-stat-value text-positive" id="isoCommissionAmt">$0</div>
                  </div>
                  <div class="offer-stat">
                    <div class="offer-stat-label">Points Fee</div>
                    <div class="offer-stat-value" id="isoPointsAmt">$0</div>
                  </div>
                  <div class="offer-stat">
                    <div class="offer-stat-label">Total Comp</div>
                    <div class="offer-stat-value text-accent" id="isoTotalComp">$0</div>
                  </div>
                </div>
              </div>
              
              <!-- Generate Offer Button -->
              <div style="margin-top: 20px; display: flex; gap: 12px;">
                <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="copyOfferToClipboard()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  Copy Offer
                </button>
                <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="generateOfferPDF()">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  Export PDF
                </button>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>

  <!-- METRIC MODAL -->
  <div class="modal-overlay" id="metricModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="metricModalTitle">Metric Analysis</div>
          <div class="modal-subtitle" id="metricModalSubtitle">Detailed breakdown</div>
        </div>
        <button class="modal-close" onclick="closeMetricModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="height: 250px; margin-bottom: 24px;"><canvas id="metricModalChart"></canvas></div>
        <div class="card-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
          Key Insights
        </div>
        <div id="metricInsights" style="display: flex; flex-direction: column; gap: 8px;"></div>
      </div>
    </div>
  </div>

  <!-- ENTITY SEARCH MODAL -->
  <div class="modal-overlay" id="entityModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Entity Report
          </div>
          <div class="modal-subtitle" id="entityModalSubtitle">Business verification results</div>
        </div>
        <button class="modal-close" onclick="closeEntityModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="entityModalBody">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <p>Search for a business entity to see verification results.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SETTINGS MODAL -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            Settings
          </div>
          <div class="modal-subtitle">Application &amp; Underwriting Configuration</div>
        </div>
        <button class="modal-close" onclick="closeSettingsModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      
      <!-- Settings Tabs -->
      <div style="display: flex; border-bottom: 1px solid var(--border-secondary); margin: 0 -20px; padding: 0 20px; flex-wrap: wrap;">
        <button class="settings-tab active" id="settingsTabGeneral" onclick="switchSettingsTab('general')" style="padding: 12px 16px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.85rem;">
          General
        </button>
        <button class="settings-tab" id="settingsTabUnderwriting" onclick="switchSettingsTab('underwriting')" style="padding: 12px 16px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.85rem;">
          Underwriting
        </button>
        <button class="settings-tab" id="settingsTabIntegrations" onclick="switchSettingsTab('integrations')" style="padding: 12px 16px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.85rem;">
          Integrations
        </button>
        <button class="settings-tab" id="settingsTabData" onclick="switchSettingsTab('data')" style="padding: 12px 16px; background: none; border: none; cursor: pointer; color: var(--text-secondary); font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; font-size: 0.85rem;">
          Data
        </button>
      </div>
      <style>
        .settings-tab.active { color: var(--accent) !important; border-bottom-color: var(--accent) !important; }
        .settings-panel { display: none; }
        .settings-panel.active { display: block; }
        .slider-group { margin-bottom: 16px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .slider-label { font-size: 0.8rem; color: var(--text-primary); }
        .slider-value { font-size: 0.8rem; color: var(--accent); font-weight: 600; min-width: 40px; text-align: right; }
        .slider-input { width: 100%; height: 6px; border-radius: 3px; background: var(--bg-tertiary); appearance: none; cursor: pointer; }
        .slider-input::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; }
        .slider-input::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none; }
        .slider-hint { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }
        .settings-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-secondary); }
        .settings-section:last-child { border-bottom: none; margin-bottom: 0; }
        .settings-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--accent); margin-bottom: 12px; font-weight: 600; }
      </style>
      
      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <!-- General Panel -->
        <div class="settings-panel active" id="settingsPanelGeneral">
          <div class="form-group">
            <label class="form-label">Gemini API Key</label>
            <input type="password" class="form-input" id="settingsApiKey" placeholder="Enter your Gemini API key">
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px;">Get your key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--accent);">Google AI Studio</a></div>
          </div>
          <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Default Model</label>
            <select class="form-input" id="settingsModel">
              <option value="gemini-2.5-flash">Gemini 2.5 Flash (Fast)</option>
              <option value="gemini-3-pro-preview">Gemini 3 Pro (Accurate)</option>
            </select>
          </div>
        </div>
        
        <!-- Underwriting Model Panel -->
        <div class="settings-panel" id="settingsPanelUnderwriting">
          <div class="settings-section">
            <div class="settings-section-title">FICO Score Settings</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">FICO Weight (% of total score)</span>
                <span class="slider-value" id="uw_ficoWeight_val">50</span>
              </div>
              <input type="range" class="slider-input" id="uw_ficoWeight" min="0" max="100" value="50" oninput="updateUnderwritingSetting('ficoWeight', this.value)">
              <div class="slider-hint">How much FICO contributes to the final ABLESCORE</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">FICO Floor</span>
                <span class="slider-value" id="uw_ficoFloor_val">500</span>
              </div>
              <input type="range" class="slider-input" id="uw_ficoFloor" min="300" max="600" value="500" oninput="updateUnderwritingSetting('ficoFloor', this.value)">
              <div class="slider-hint">Minimum FICO considered (below = 0 points)</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">FICO Ceiling</span>
                <span class="slider-value" id="uw_ficoCeiling_val">800</span>
              </div>
              <input type="range" class="slider-input" id="uw_ficoCeiling" min="700" max="850" value="800" oninput="updateUnderwritingSetting('ficoCeiling', this.value)">
              <div class="slider-hint">Maximum FICO considered (above = max points)</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Revenue Consistency</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Revenue Weight (% of total score)</span>
                <span class="slider-value" id="uw_revenueWeight_val">20</span>
              </div>
              <input type="range" class="slider-input" id="uw_revenueWeight" min="0" max="50" value="20" oninput="updateUnderwritingSetting('revenueWeight', this.value)">
              <div class="slider-hint">Bonus for consistent monthly revenue</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Consistency Threshold (%)</span>
                <span class="slider-value" id="uw_revenueThreshold_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_revenueThreshold" min="5" max="30" value="10" oninput="updateUnderwritingSetting('revenueThreshold', this.value)">
              <div class="slider-hint">Max variance % for full consistency bonus</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Penalty Settings</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">NSF Penalty Max</span>
                <span class="slider-value" id="uw_nsfPenaltyMax_val">15</span>
              </div>
              <input type="range" class="slider-input" id="uw_nsfPenaltyMax" min="5" max="30" value="15" oninput="updateUnderwritingSetting('nsfPenaltyMax', this.value)">
              <div class="slider-hint">Maximum penalty for NSF/overdraft fees</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">NSF Threshold (count)</span>
                <span class="slider-value" id="uw_nsfThreshold_val">3</span>
              </div>
              <input type="range" class="slider-input" id="uw_nsfThreshold" min="1" max="10" value="3" oninput="updateUnderwritingSetting('nsfThreshold', this.value)">
              <div class="slider-hint">NSFs above this trigger max penalty</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Negative Day Penalty Max</span>
                <span class="slider-value" id="uw_negativeDayPenaltyMax_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_negativeDayPenaltyMax" min="5" max="25" value="10" oninput="updateUnderwritingSetting('negativeDayPenaltyMax', this.value)">
              <div class="slider-hint">Maximum penalty for negative balance days</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Negative Day Threshold</span>
                <span class="slider-value" id="uw_negativeDayThreshold_val">5</span>
              </div>
              <input type="range" class="slider-input" id="uw_negativeDayThreshold" min="1" max="15" value="5" oninput="updateUnderwritingSetting('negativeDayThreshold', this.value)">
              <div class="slider-hint">Days above this trigger max penalty</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Time in Business Bonuses</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">6+ Months Bonus</span>
                <span class="slider-value" id="uw_tib6moBonus_val">5</span>
              </div>
              <input type="range" class="slider-input" id="uw_tib6moBonus" min="0" max="15" value="5" oninput="updateUnderwritingSetting('tib6moBonus', this.value)">
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">12+ Months Bonus</span>
                <span class="slider-value" id="uw_tib12moBonus_val">8</span>
              </div>
              <input type="range" class="slider-input" id="uw_tib12moBonus" min="0" max="20" value="8" oninput="updateUnderwritingSetting('tib12moBonus', this.value)">
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">24+ Months Bonus</span>
                <span class="slider-value" id="uw_tib24moBonus_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_tib24moBonus" min="0" max="25" value="10" oninput="updateUnderwritingSetting('tib24moBonus', this.value)">
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Collectability Settings</div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Collectability Weight (% of offer calc)</span>
                <span class="slider-value" id="uw_collectWeight_val">15</span>
              </div>
              <input type="range" class="slider-input" id="uw_collectWeight" min="0" max="30" value="15" oninput="updateUnderwritingSetting('collectWeight', this.value)">
              <div class="slider-hint">How much collectability affects offer amount</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Min Avg Daily Balance ($)</span>
                <span class="slider-value" id="uw_minAvgDailyBal_val">500</span>
              </div>
              <input type="range" class="slider-input" id="uw_minAvgDailyBal" min="0" max="5000" step="100" value="500" oninput="updateUnderwritingSetting('minAvgDailyBal', this.value)">
              <div class="slider-hint">Minimum average daily balance requirement</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Deposit Frequency Weight</span>
                <span class="slider-value" id="uw_depositFreqWeight_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_depositFreqWeight" min="0" max="25" value="10" oninput="updateUnderwritingSetting('depositFreqWeight', this.value)">
              <div class="slider-hint">Bonus for consistent deposit patterns</div>
            </div>
            <div class="slider-group">
              <div class="slider-header">
                <span class="slider-label">Low Balance Penalty</span>
                <span class="slider-value" id="uw_lowBalPenalty_val">10</span>
              </div>
              <input type="range" class="slider-input" id="uw_lowBalPenalty" min="0" max="20" value="10" oninput="updateUnderwritingSetting('lowBalPenalty', this.value)">
              <div class="slider-hint">Penalty for frequently low balances</div>
            </div>
          </div>
          
          <button class="btn-secondary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="resetUnderwritingDefaults()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
            Reset to Defaults
          </button>
        </div>
        
        <!-- Integrations Panel -->
        <div class="settings-panel" id="settingsPanelIntegrations">
          <div class="settings-section">
            <div class="settings-section-title">Zapier Webhooks</div>
            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 16px;">Connect to Zapier to automate workflows. Get webhook URLs from your Zapier Zaps.</p>
            
            <div class="form-group">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-a)" stroke-width="2" style="width: 14px; height: 14px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  New Deal Created
                </span>
              </label>
              <input type="text" class="form-input" id="webhookNewDeal" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when a new deal is added to the pipeline</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  Bank Statement Processed
                </span>
              </label>
              <input type="text" class="form-input" id="webhookBankProcessed" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered after Quick Scrub completes analysis</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-b)" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  Score Calculated
                </span>
              </label>
              <input type="text" class="form-input" id="webhookScoreCalc" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when ABLESCORE is calculated/updated</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-c)" stroke-width="2" style="width: 14px; height: 14px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
                  Deep Research Complete
                </span>
              </label>
              <input type="text" class="form-input" id="webhookResearch" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when deep business research finishes</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-d)" stroke-width="2" style="width: 14px; height: 14px;"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  Credit Report Analyzed
                </span>
              </label>
              <input type="text" class="form-input" id="webhookCredit" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when credit report data is extracted</div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
              <label class="form-label">
                <span style="display: flex; align-items: center; gap: 6px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" style="width: 14px; height: 14px;"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
                  Status Changed
                </span>
              </label>
              <input type="text" class="form-input" id="webhookStatus" placeholder="https://hooks.zapier.com/hooks/catch/..." oninput="saveWebhookSettings()">
              <div class="slider-hint">Triggered when deal status changes (approved, declined, etc.)</div>
            </div>
          </div>
          
          <div class="settings-section">
            <div class="settings-section-title">Webhook Settings</div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                <input type="checkbox" id="webhooksEnabled" onchange="saveWebhookSettings()" style="width: 16px; height: 16px; accent-color: var(--accent);">
                Enable Webhooks
              </label>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem;">
                <input type="checkbox" id="webhookIncludeMonths" onchange="saveWebhookSettings()" style="width: 16px; height: 16px; accent-color: var(--accent);">
                Include Monthly Financial Data
              </label>
            </div>
            <div class="slider-hint" style="margin-top: 8px;">When enabled, webhooks will include detailed month-by-month data</div>
          </div>
          
          <button class="btn-secondary" style="width: 100%; justify-content: center; margin-top: 8px;" onclick="testWebhook()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Test Webhooks
          </button>
        </div>
        
        <!-- Data Panel -->
        <div class="settings-panel" id="settingsPanelData">
          <div class="form-label" style="margin-bottom: 12px;">Data Management</div>
          <div style="display: flex; gap: 12px;">
            <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="exportDeals()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Export
            </button>
            <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="document.getElementById('importDealsInput').click()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Import
            </button>
            <input type="file" id="importDealsInput" style="display: none;" accept=".json" onchange="importDeals(event)">
          </div>
          <div style="margin-top: 20px;">
            <button class="btn-secondary" style="width: 100%; justify-content: center; color: var(--tier-e); border-color: var(--tier-e);" onclick="clearAllData()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              Clear All Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEEP RESEARCH MODAL -->
  <div class="modal-overlay" id="deepResearchModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <div>
          <div class="modal-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; display: inline; vertical-align: middle; margin-right: 8px; color: var(--accent);"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><path d="M11 8v6"/><path d="M8 11h6"/></svg>
            Deep Business Research
          </div>
          <div class="modal-subtitle" id="deepResearchSubtitle">Comprehensive background analysis</div>
        </div>
        <button class="modal-close" onclick="closeDeepResearchModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="deepResearchBody">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <p>Run deep research on a business to get comprehensive background analysis.</p>
        </div>
      </div>
    </div>
  </div>

<script>
let allDeals = [];
let currentDeal = null;
let currentOfferTab = 'conservative';
let scoreChart = null;
let volumeChart = null;
let revenueTrendChart = null;
let completionChart = null;
let dealCashflowChart = null;
let metricChart = null;
const TIER_COLORS = { a: '#22c55e', b: '#84cc16', c: '#eab308', d: '#f97316', e: '#ef4444' };

document.addEventListener('DOMContentLoaded', () => {
  initCharts();
  loadDealsFromStorage();
  updateDashboard();
  initSidebarState();
  if (sessionStorage.getItem('greatdane_logged_in') === 'true') document.getElementById('loginOverlay').classList.add('hidden');
  document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') handleLogin(); });
  document.getElementById('entitySearchInput').addEventListener('keydown', e => { if (e.key === 'Enter') createDealAndSearch(); });
  
  // Setup dropzone drag-drop for both regular and mini dropzone
  const setupDropzone = (elementId) => {
    const dropzone = document.getElementById(elementId);
    if (dropzone) {
      ['dragenter', 'dragover'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('dragover'); });
      });
      ['dragleave', 'drop'].forEach(evt => {
        dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('dragover'); });
      });
      dropzone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length) handleQuickScrub({ target: { files } });
      });
    }
  };
  
  setupDropzone('quickScrubZone');
  setupDropzone('miniQuickScrubZone');
});

function handleLogin() {
  const pass = document.getElementById('loginPass').value;
  if (pass.endsWith('!#')) {
    sessionStorage.setItem('greatdane_logged_in', 'true');
    document.getElementById('loginOverlay').classList.add('hidden');
  } else {
    document.getElementById('loginError').classList.add('active');
    document.getElementById('loginPass').classList.add('shake');
    setTimeout(() => document.getElementById('loginPass').classList.remove('shake'), 400);
  }
}

function toggleTheme() {
  document.body.classList.toggle('light-mode');
  const isLight = document.body.classList.contains('light-mode');
  localStorage.setItem('greatdane_theme', isLight ? 'light' : 'dark');
}

function initTheme() {
  const saved = localStorage.getItem('greatdane_theme');
  // Default to light mode unless explicitly set to dark
  if (saved === 'dark') {
    document.body.classList.remove('light-mode');
  } else {
    document.body.classList.add('light-mode');
  }
}
// Run immediately
initTheme();

function initCharts() {
  const baseOpts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

  // Score Distribution (Pipeline)
  scoreChart = new Chart(document.getElementById('scoreChart'), {
    type: 'doughnut',
    data: {
      labels: ['Tier A (85+)', 'Tier B (70-84)', 'Tier C (55-69)', 'Tier D (40-54)', 'Tier E (<40)'],
      datasets: [{
        data: [0,0,0,0,0],
        backgroundColor: [TIER_COLORS.a, TIER_COLORS.b, TIER_COLORS.c, TIER_COLORS.d, TIER_COLORS.e],
        borderWidth: 0
      }]
    },
    options: {
      ...baseOpts,
      cutout: '65%',
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            color: '#a1a1aa',
            font: { size: 11, family: 'DM Sans' },
            padding: 12,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        }
      }
    }
  });

  // Deal Activity (created per month)
  volumeChart = new Chart(document.getElementById('volumeChart'), {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'Deals', data: [], backgroundColor: '#eab308', borderRadius: 6 }] },
    options: {
      ...baseOpts,
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a', font: { family: 'DM Sans' } } },
        x: { grid: { display: false }, ticks: { color: '#71717a', font: { family: 'DM Sans' } } }
      }
    }
  });

  // Revenue Trend (total revenue across all deals by month)
  revenueTrendChart = new Chart(document.getElementById('revenueTrendChart'), {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Revenue', data: [], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.08)', fill: true, tension: 0.35 }] },
    options: {
      ...baseOpts,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });

  // Data Completeness (distribution)
  completionChart = new Chart(document.getElementById('completionChart'), {
    type: 'bar',
    data: { labels: ['0-39%', '40-59%', '60-79%', '80-100%'], datasets: [{ label: 'Deals', data: [0,0,0,0], backgroundColor: '#a855f7', borderRadius: 6 }] },
    options: {
      ...baseOpts,
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });
}

function renderDealList() {
  const c = document.getElementById('dealList');
  if (!allDeals.length) {
    c.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>No deals yet</h3><p>No deals yet. Upload bank statements to get started.</p></div>';
    document.getElementById('pipelineTotal').textContent = '0';
    return;
  }

  c.innerHTML = allDeals.map((d, i) => {
    const tc = d.score >= 85 ? TIER_COLORS.a : d.score >= 70 ? TIER_COLORS.b : d.score >= 55 ? TIER_COLORS.c : d.score >= 40 ? TIER_COLORS.d : TIER_COLORS.e;
    const active = currentDeal && currentDeal.id === d.id;

    const comp = calcDealCompleteness(d).pct;
    const compColor = comp >= 80 ? 'var(--tier-a)' : comp >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
    const ent = d.entityData ? Math.round(d.entityData.confidence || 0) : null;
    const entColor = ent === null ? 'var(--text-muted)' : ent >= 80 ? 'var(--tier-a)' : ent >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
    const bank = d.bankData ? Math.round(d.bankData.confidence || 0) : null;

    return `
      <div class="deal-item ${active ? 'active' : ''}" onclick="selectDeal(${i})">
        <div class="deal-item-top">
          <div class="deal-item-name">${d.businessName || 'Untitled Deal'}</div>
          <div class="deal-item-score" style="color: ${tc};">${d.score || 0}</div>
        </div>
        <div class="deal-item-meta">
          <div class="deal-item-industry">${d.industry || 'No industry'}</div>
          <div class="deal-item-owner">${d.ownerName || 'No owner'}</div>
        </div>
        <div class="deal-item-submeta">
          <span class="deal-badge"><span style="width:6px;height:6px;border-radius:999px;background:${compColor};display:inline-block;"></span><span>${comp}% profile</span></span>
          <span class="deal-badge"><span style="width:6px;height:6px;border-radius:999px;background:${entColor};display:inline-block;"></span><span>${ent === null ? 'entity ' : `entity ${ent}%`}</span></span>
          <span class="deal-badge"><span style="width:6px;height:6px;border-radius:999px;background:${bank === null ? 'var(--text-muted)' : (bank >= 70 ? 'var(--tier-a)' : bank >= 50 ? 'var(--tier-c)' : 'var(--tier-e)')};display:inline-block;"></span><span>${bank === null ? 'bank ' : `bank ${bank}%`}</span></span>
        </div>
        <div class="deal-item-progress">
          <div class="deal-item-progress-bar" style="width: ${Math.min(100, Math.max(0, d.score || 0))}%; background: ${tc};"></div>
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('pipelineTotal').textContent = allDeals.length;
}

function filterDeals(q) {
  document.querySelectorAll('.deal-item').forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

function addNewDeal() {
  const d = { id: Date.now(), businessName: 'New Business', dba: '', industry: '', tib: '', address: '', stateCode: '', entityType: '', entityStatus: '', formationDate: '', website: '', phone: '', ownerName: '', ownerEmail: '', ownerPhone: '', fico: 650, ownership: 100, score: 0, months: [], bankData: null, entityData: null, _fieldSource: {}, createdAt: new Date().toISOString() };
  allDeals.unshift(d);
  saveDealsToStorage();
  renderDealList();
  selectDeal(0);
  
  // Trigger webhook for new deal
  triggerWebhook('newDeal', d);
}

function selectDeal(i) {
  currentDeal = allDeals[i];
  showDetailView();
  populateDetailView();
}

function showDashboard() {
  document.getElementById('dashboardView').style.display = 'block';
  document.getElementById('detailView').classList.remove('active');
  currentDeal = null;
  updateDashboard();
  renderDealList();
}

function showDetailView() {
  document.getElementById('dashboardView').style.display = 'none';
  document.getElementById('detailView').classList.add('active');
}

function populateDetailView() {
  if (!currentDeal) return;
  document.getElementById('editLegalName').value = currentDeal.businessName || '';
  document.getElementById('editDba').value = currentDeal.dba || '';
  document.getElementById('editIndustry').value = currentDeal.industry || '';
  document.getElementById('editTib').value = currentDeal.tib || '';
  document.getElementById('editAddress').value = currentDeal.address || '';
  document.getElementById('editStateCode').value = currentDeal.stateCode || '';
  document.getElementById('editEntityType').value = currentDeal.entityType || '';
  document.getElementById('editEntityStatus').value = currentDeal.entityStatus || '';
  document.getElementById('editFormationDate').value = currentDeal.formationDate || '';
  document.getElementById('editWebsite').value = currentDeal.website || '';
  document.getElementById('editPhone').value = currentDeal.phone || '';

  document.getElementById('editOwnerName').value = currentDeal.ownerName || '';
  document.getElementById('editOwnerEmail').value = currentDeal.ownerEmail || '';
  document.getElementById('editOwnerPhone').value = currentDeal.ownerPhone || '';
  document.getElementById('editFico').value = currentDeal.fico || '';
  document.getElementById('editOwnership').value = currentDeal.ownership || '';

  renderFinancialTable();
  recalculateScore();
  updateOffer();
  updateProfileCompletenessUI();
  renderEntityVerificationCard();
  renderBankSummaryCard();
  renderDealInsights();
  renderDeepResearchCard();
  renderAllReportSections();
  updateIntelBadges();
  updateMetricsPanel();
  
  // Clear Hubble chat when switching deals
  clearHubbleChat();
  
  // Auto-trigger all searches if business name exists (staggered to avoid rate limits)
  if (currentDeal.businessName && getGeminiApiKey()) {
    if (!currentDeal.deepResearch) setTimeout(() => runDeepResearchAuto(), 500);
    if (!currentDeal.clearReport) setTimeout(() => runBackgroundAuto(), 2500);
    if (!currentDeal.footprintReport) setTimeout(() => runFootprintAuto(), 4500);
    if (currentDeal.months?.length > 0 && !currentDeal.debtReport) setTimeout(() => runDebtAnalysisAuto(), 1000);
  }
}

function updateMetricsPanel() {
  if (!currentDeal) return;
  
  const months = currentDeal.months || [];
  const totalRev = months.reduce((s, m) => s + (m.revenue || 0), 0);
  const avgRev = months.length ? Math.round(totalRev / months.length) : 0;
  const totalDeposits = months.reduce((s, m) => s + (m.deposits || 0), 0);
  const avgDailyBal = months.length ? Math.round(months.reduce((s, m) => s + (m.avgDailyBal || 0), 0) / months.length) : 0;
  const totalNsf = months.reduce((s, m) => s + (m.nsfs || 0), 0);
  const totalNegDays = months.reduce((s, m) => s + (m.negatives || 0), 0);
  
  // Update metric cards
  const setMetric = (id, value, format = 'number') => {
    const el = document.getElementById(id);
    if (!el) return;
    if (format === 'currency') {
      el.textContent = value ? '$' + Math.round(value).toLocaleString() : '--';
    } else {
      el.textContent = value !== undefined && value !== null ? value : '--';
    }
  };
  
  setMetric('metricFico', currentDeal.fico);
  setMetric('metricAvgRev', avgRev, 'currency');
  setMetric('metricDeposits', totalDeposits, 'currency');
  setMetric('metricAvgBal', avgDailyBal, 'currency');
  setMetric('metricNsf', totalNsf);
  setMetric('metricNegDays', totalNegDays);
  setMetric('metricMonths', months.length);
  
  // Color code NSF and negative days
  const nsfEl = document.getElementById('metricNsf');
  const negEl = document.getElementById('metricNegDays');
  if (nsfEl) {
    nsfEl.classList.remove('positive', 'negative', 'warning');
    if (totalNsf === 0) nsfEl.classList.add('positive');
    else if (totalNsf <= 3) nsfEl.classList.add('warning');
    else nsfEl.classList.add('negative');
  }
  if (negEl) {
    negEl.classList.remove('positive', 'negative', 'warning');
    if (totalNegDays === 0) negEl.classList.add('positive');
    else if (totalNegDays <= 5) negEl.classList.add('warning');
    else negEl.classList.add('negative');
  }
}

function updateDealField(f, v) {
  if (!currentDeal) return;
  currentDeal[f] = v;
  currentDeal._fieldSource = currentDeal._fieldSource || {};
  currentDeal._fieldSource[f] = 'manual';
  saveDealsToStorage();
  if (f === 'businessName') renderDealList();
  updateProfileCompletenessUI();
}

function renderFinancialTable() {
  const tb = document.getElementById('financialTableBody');
  if (!currentDeal?.months?.length) {
    tb.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: var(--text-muted);">No financial data. Upload bank statements to begin.</td></tr>';
    return;
  }

  // Ensure normalized shape for UI
  currentDeal.months = normalizeMonths(currentDeal.months);
  
  // Calculate averages/totals
  const months = currentDeal.months;
  const count = months.length;
  const avgs = {
    revenue: months.reduce((a, m) => a + (m.revenue || 0), 0) / count,
    deposits: months.reduce((a, m) => a + (m.deposits || 0), 0) / count,
    withdrawals: months.reduce((a, m) => a + (m.withdrawals || 0), 0) / count,
    endingBal: months.reduce((a, m) => a + (m.endingBal || 0), 0) / count,
    avgDailyBal: months.reduce((a, m) => a + (m.avgDailyBal || 0), 0) / count,
    depositCount: Math.round(months.reduce((a, m) => a + (m.depositCount || 0), 0) / count),
    overdraftFees: months.reduce((a, m) => a + (m.overdraftFees || 0), 0),
    nsfs: months.reduce((a, m) => a + (m.nsfs || 0), 0),
    negatives: months.reduce((a, m) => a + (m.negatives || 0), 0)
  };

  const rows = currentDeal.months.map((m, i) => `
    <tr>
      <td>${m.monthLabel || m.month || ''}</td>
      <td><input class="table-input table-positive" value="${formatCurrency(m.revenue)}" onchange="updateMonth(${i}, 'revenue', this.value)"></td>
      <td><input class="table-input table-positive" value="${formatCurrency(m.deposits)}" onchange="updateMonth(${i}, 'deposits', this.value)"></td>
      <td><input class="table-input table-negative" value="${formatCurrency(m.withdrawals)}" onchange="updateMonth(${i}, 'withdrawals', this.value)"></td>
      <td><input class="table-input" value="${formatCurrency(m.endingBal)}" onchange="updateMonth(${i}, 'endingBal', this.value)"></td>
      <td><input class="table-input" value="${formatCurrency(m.avgDailyBal)}" onchange="updateMonth(${i}, 'avgDailyBal', this.value)"></td>
      <td><input class="table-input" value="${m.depositCount ?? 0}" onchange="updateMonth(${i}, 'depositCount', this.value)"></td>
      <td><input class="table-input ${m.overdraftFees > 0 ? 'table-warning' : ''}" value="${formatCurrency(m.overdraftFees)}" onchange="updateMonth(${i}, 'overdraftFees', this.value)"></td>
      <td><input class="table-input ${m.nsfs > 0 ? 'table-negative' : ''}" value="${m.nsfs || 0}" onchange="updateMonth(${i}, 'nsfs', this.value)"></td>
      <td><input class="table-input ${m.negatives > 0 ? 'table-warning' : ''}" value="${m.negatives || 0}" onchange="updateMonth(${i}, 'negatives', this.value)"></td>
    </tr>
  `).join('');
  
  // Add averages/totals row
  const avgRow = `
    <tr style="background: var(--bg-tertiary); font-weight: 600; border-top: 2px solid var(--accent);">
      <td style="color: var(--accent);">AVG/TOTAL</td>
      <td class="text-positive">${formatCurrency(avgs.revenue)}</td>
      <td class="text-positive">${formatCurrency(avgs.deposits)}</td>
      <td class="text-negative">${formatCurrency(avgs.withdrawals)}</td>
      <td>${formatCurrency(avgs.endingBal)}</td>
      <td>${formatCurrency(avgs.avgDailyBal)}</td>
      <td>${avgs.depositCount}</td>
      <td class="${avgs.overdraftFees > 0 ? 'text-warning' : ''}">${formatCurrency(avgs.overdraftFees)}</td>
      <td class="${avgs.nsfs > 0 ? 'text-negative' : ''}">${avgs.nsfs}</td>
      <td class="${avgs.negatives > 0 ? 'text-warning' : ''}">${avgs.negatives}</td>
    </tr>
  `;
  
  tb.innerHTML = rows + avgRow;
}

function updateMonth(i, f, v) {
  if (!currentDeal?.months?.[i]) return;

  const currencyFields = new Set(['revenue','deposits','withdrawals','endingBal','avgDailyBal','overdraftFees']);
  const intFields = new Set(['nsfs','negatives','depositCount']);

  if (currencyFields.has(f)) currentDeal.months[i][f] = parseCurrency(v);
  else if (intFields.has(f)) currentDeal.months[i][f] = parseInt(String(v).replace(/[^0-9-]/g, ''), 10) || 0;
  else currentDeal.months[i][f] = v;

  // Maintain month normalization
  currentDeal.months = normalizeMonths(currentDeal.months);

  saveDealsToStorage();
  recalculateScore();
  renderDealInsights();
  updateProfileCompletenessUI();
}

function recalculateScore() {
  if (!currentDeal) return;
  
  // Component tracking
  let ficoComponent = 0;
  let revenueComponent = 0;
  let nsfPenalty = 0;
  let negDaysPenalty = 0;
  
  // Base score
  let s = 50;
  
  // FICO Component (+20 to -15)
  const fico = parseInt(currentDeal.fico) || 0;
  if (fico >= 700) ficoComponent = 20;
  else if (fico >= 650) ficoComponent = 10;
  else if (fico >= 600) ficoComponent = 0;
  else ficoComponent = -15;
  s += ficoComponent;
  
  // Revenue Consistency Component (+15 to -10)
  if (currentDeal.months?.length >= 3) {
    const revs = currentDeal.months.map(m => m.revenue);
    const avg = revs.reduce((a, b) => a + b, 0) / revs.length;
    if (avg > 0) {
      const variance = revs.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / revs.length;
      const cv = Math.sqrt(variance) / avg;
      if (cv < 0.2) revenueComponent = 15;
      else if (cv < 0.4) revenueComponent = 5;
      else revenueComponent = -10;
      s += revenueComponent;
    }
  }
  
  // NSF Penalty (-3 per NSF, max -30)
  const totalNSF = currentDeal.months?.reduce((a, m) => a + (m.nsfs || 0), 0) || 0;
  nsfPenalty = Math.min(totalNSF * 3, 30);
  s -= nsfPenalty;
  
  // Negative Days Penalty (-2 per day, max -20)
  const totalNeg = currentDeal.months?.reduce((a, m) => a + (m.negatives || 0), 0) || 0;
  negDaysPenalty = Math.min(totalNeg * 2, 20);
  s -= negDaysPenalty;
  
  // Final score (0-100)
  s = Math.max(0, Math.min(100, Math.round(s)));
  currentDeal.score = s;
  currentDeal.tier = s >= 85 ? 'A' : s >= 70 ? 'B' : s >= 55 ? 'C' : s >= 40 ? 'D' : 'E';
  saveDealsToStorage();
  
  // Trigger webhook for score calculation
  triggerWebhook('scoreCalc', currentDeal);
  
  // Update main score display
  const tc = s >= 85 ? TIER_COLORS.a : s >= 70 ? TIER_COLORS.b : s >= 55 ? TIER_COLORS.c : s >= 40 ? TIER_COLORS.d : TIER_COLORS.e;
  const tl = s >= 85 ? 'Excellent' : s >= 70 ? 'Good' : s >= 55 ? 'Fair' : s >= 40 ? 'Below Average' : 'High Risk';
  document.getElementById('mainScore').textContent = s;
  document.getElementById('scoreTier').textContent = tl;
  document.getElementById('scoreRing').style.setProperty('--pct', s);
  document.getElementById('scoreRing').style.setProperty('--score-color', tc);
  
  // Update component breakdown
  document.getElementById('compFico').textContent = (ficoComponent >= 0 ? '+' : '') + ficoComponent;
  document.getElementById('compFico').className = 'score-comp-value ' + (ficoComponent >= 0 ? 'text-positive' : 'text-negative');
  document.getElementById('compRevenue').textContent = (revenueComponent >= 0 ? '+' : '') + revenueComponent;
  document.getElementById('compRevenue').className = 'score-comp-value ' + (revenueComponent >= 0 ? 'text-positive' : 'text-negative');
  document.getElementById('compNsf').textContent = nsfPenalty > 0 ? '-' + nsfPenalty : '0';
  document.getElementById('compNegDays').textContent = negDaysPenalty > 0 ? '-' + negDaysPenalty : '0';
  document.getElementById('compTotal').textContent = s;
  
  renderDealList();
  updateOffer();
}

function setOfferTab(t) {
  currentOfferTab = t;
  document.querySelectorAll('.offer-tab').forEach(el => el.classList.toggle('active', el.dataset.offer === t));
  updateOffer();
}

let currentPaymentFrequency = 'daily';

function setPaymentFrequency(freq) {
  currentPaymentFrequency = freq;
  document.getElementById('freqDaily').classList.toggle('active', freq === 'daily');
  document.getElementById('freqWeekly').classList.toggle('active', freq === 'weekly');
  document.getElementById('paymentLabel').textContent = freq === 'daily' ? 'Daily Payment' : 'Weekly Payment';
  document.getElementById('paymentsCountLabel').textContent = freq === 'daily' ? '# of Payments' : '# of Weeks';
  updateOffer();
}

function updateOffer() {
  if (!currentDeal) return;
  const pm = parseFloat(document.getElementById('positionSlider').value);
  const hb = parseInt(document.getElementById('holdbackSlider').value);
  document.getElementById('positionVal').textContent = pm.toFixed(1) + 'x';
  document.getElementById('holdbackVal').textContent = hb + '%';
  const avgRev = currentDeal.months?.length ? currentDeal.months.reduce((a, m) => a + m.revenue, 0) / currentDeal.months.length : 0;
  const cfgs = { conservative: { rm: 0.8, f: 1.35, t: 90 }, moderate: { rm: 1.0, f: 1.28, t: 120 }, aggressive: { rm: 1.3, f: 1.22, t: 180 } };
  const c = cfgs[currentOfferTab];
  const base = avgRev * c.rm * pm;
  const pb = base * c.f;
  const termDays = c.t;
  
  // Calculate based on frequency
  let payment, paymentsCount;
  if (currentPaymentFrequency === 'daily') {
    payment = pb / termDays;
    paymentsCount = termDays;
  } else {
    const weeks = Math.ceil(termDays / 5); // Business days per week
    payment = pb / weeks;
    paymentsCount = weeks;
  }
  
  document.getElementById('offerAmount').textContent = '$' + Math.round(base).toLocaleString();
  document.getElementById('offerFactor').textContent = c.f.toFixed(2);
  document.getElementById('offerPayback').textContent = '$' + Math.round(pb).toLocaleString();
  document.getElementById('offerTerm').textContent = termDays;
  document.getElementById('offerPayment').textContent = '$' + Math.round(payment).toLocaleString();
  document.getElementById('offerPaymentsCount').textContent = paymentsCount;
  
  // Store for ISO preview
  window.currentOfferData = { fundingAmount: base, payback: pb, termDays: termDays };
  updateISOPreview();
}

function updateISOPreview() {
  const data = window.currentOfferData || { fundingAmount: 0, payback: 0 };
  const commPct = parseFloat(document.getElementById('isoCommission')?.value || 10);
  const points = parseFloat(document.getElementById('isoPoints')?.value || 0);
  
  const commAmt = data.fundingAmount * (commPct / 100);
  const pointsAmt = data.fundingAmount * (points / 10000);
  const total = commAmt + pointsAmt;
  
  if (document.getElementById('isoCommissionAmt')) {
    document.getElementById('isoCommissionAmt').textContent = '$' + Math.round(commAmt).toLocaleString();
    document.getElementById('isoPointsAmt').textContent = '$' + Math.round(pointsAmt).toLocaleString();
    document.getElementById('isoTotalComp').textContent = '$' + Math.round(total).toLocaleString();
  }
}

function copyOfferToClipboard() {
  if (!currentDeal) return;
  const data = window.currentOfferData || {};
  const text = `OFFER SUMMARY
Business: ${currentDeal.businessName}
Funding Amount: $${Math.round(data.fundingAmount || 0).toLocaleString()}
Payback: $${Math.round(data.payback || 0).toLocaleString()}
Factor Rate: ${document.getElementById('offerFactor')?.textContent || '1.00'}
Term: ${data.termDays || 0} days
${currentPaymentFrequency === 'daily' ? 'Daily' : 'Weekly'} Payment: ${document.getElementById('offerPayment')?.textContent || '$0'}
# of Payments: ${document.getElementById('offerPaymentsCount')?.textContent || '0'}`;
  
  navigator.clipboard.writeText(text).then(() => {
    alert('Offer copied to clipboard!');
  });
}

function generateOfferPDF() {
  alert('PDF generation coming soon. For now, use Copy Offer.');
}

async function createDealAndSearch() {
  const businessName = document.getElementById('entitySearchInput').value.trim();
  if (!businessName) { alert('Enter a business name to create a deal.'); return; }
  const apiKey = localStorage.getItem('greatdane_api_key');
  if (!apiKey) { alert('Enter your Gemini API key first.'); return; }
  
  // Create new deal with business name
  const newDeal = {
    id: Date.now(),
    businessName: businessName,
    dba: '',
    industry: '',
    tib: '',
    address: '',
    stateCode: '',
    entityType: '',
    entityStatus: '',
    formationDate: '',
    website: '',
    phone: '',
    ownerName: '',
    ownerEmail: '',
    ownerPhone: '',
    fico: 650,
    ownership: 100,
    score: 0,
    months: [],
    bankData: null,
    entityData: null,
    _fieldSource: {},
    createdAt: new Date().toISOString()
  };
  allDeals.unshift(newDeal);
  currentDeal = newDeal;
  saveDealsToStorage();
  renderDealList();
  
  // Trigger webhook for new deal
  triggerWebhook('newDeal', newDeal);
  
  // Go to detail view
  showDetailView();
  populateDetailView();
  
  // Clear search input
  document.getElementById('entitySearchInput').value = '';
  
  // Now search for entity data
  await searchAndFillEntity(businessName, apiKey);
}

async function searchAndFillEntity(businessName, apiKey) {
  const statusEl = document.createElement('div');
  statusEl.id = 'entitySearchStatus';
  statusEl.style.cssText = 'position: fixed; top: 80px; right: 24px; background: var(--bg-card); border: 1px solid var(--accent); border-radius: 12px; padding: 16px 20px; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);';
  statusEl.innerHTML = '<div style="width: 20px; height: 20px; border: 2px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div><span style="font-size: 0.85rem;">Verifying entity (exact match first)...</span><style>@keyframes spin { to { transform: rotate(360deg); } }</style>';
  document.body.appendChild(statusEl);

  try {
    const model = getGeminiModel();

    const prompt = `You are an underwriting OSINT analyst.

INPUT_NAME: "${businessName}"

GOAL: Identify the correct U.S. business entity record for the INPUT_NAME.

STRICT RULES:
- Search using the EXACT PHRASE in quotes first: "${businessName}"
- Prefer authoritative sources: State Secretary of State / business registry pages.
- Secondary sources allowed: SEC EDGAR, OpenCorporates, official company website.
- Avoid low-quality directories. Do NOT guess a state without evidence.
- If ambiguous, return multiple candidates.

Return JSON ONLY with this schema:
{
  "input_name": "",
  "normalized_input": "",
  "candidates": [
    {
      "legal_name": "",
      "dba": "",
      "state": "",
      "stateCode": "XX",
      "entityType": "",
      "status": "",
      "formationDate": "",
      "registeredAgent": "",
      "address": "",
      "officers": [],
      "industry": "",
      "hq": "",
      "sources": [{"title":"","url":""}],
      "evidence": ["<=20 word snippet"],
      "confidence": 0
    }
  ],
  "notes": ""
}`;

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.1 }
      })
    });

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);

    if (!parsed || !currentDeal) {
      statusEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-d)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span style="font-size: 0.85rem; color: var(--tier-d);">Entity parse failed (raw text shown in console)</span>';
      console.log('Entity raw response:', text);
      setTimeout(() => statusEl.remove(), 2500);
      return;
    }

    // Rank candidates locally to enforce exact/normalized-exact first
    const ranked = rankEntityCandidates(businessName, parsed.candidates || []);
    const best = ranked[0];

    if (best) {
      const entity = {
        businessName: best.legal_name || best.businessName || best.name || businessName,
        dba: best.dba || '',
        state: best.state || '',
        stateCode: (best.stateCode || '').toUpperCase(),
        entityType: best.entityType || '',
        status: best.status || '',
        formationDate: best.formationDate || '',
        registeredAgent: best.registeredAgent || '',
        address: best.address || '',
        officers: best.officers || [],
        industry: best.industry || '',
        hq: best.hq || '',
        confidence: best.confidence || 0,
        summary: parsed.notes || '',
        sources: best.sources || []
      };

      currentDeal.entityData = entity;

      // Auto-fill (but do not overwrite manual fields)
      currentDeal._fieldSource = currentDeal._fieldSource || {};

      const setAuto = (field, value) => {
        if (!value) return;
        const manual = currentDeal._fieldSource[field] === 'manual';
        const empty = !currentDeal[field] || String(currentDeal[field]).trim() === '';
        if (empty && !manual) {
          currentDeal[field] = value;
          currentDeal._fieldSource[field] = 'entity';
        }
      };

      setAuto('dba', entity.dba);
      setAuto('industry', entity.industry);
      setAuto('address', entity.address);
      setAuto('stateCode', entity.stateCode);
      setAuto('entityType', entity.entityType);
      setAuto('entityStatus', entity.status);
      setAuto('formationDate', entity.formationDate);
      setAuto('phone', '');
      setAuto('website', '');

      // Formation date -> TIB
      if (entity.formationDate && (!currentDeal.tib || String(currentDeal.tib).trim() === '')) {
        const years = Math.floor((Date.now() - new Date(entity.formationDate).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
        currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
      }

      // Officer -> ownerName (only if empty)
      if (entity.officers?.length && (!currentDeal.ownerName || String(currentDeal.ownerName).trim() === '')) {
        currentDeal.ownerName = entity.officers[0];
        currentDeal._fieldSource.ownerName = 'entity';
      }

      // Push values to UI
      populateDetailView();

      saveDealsToStorage();
      renderDealList();

      const tier = best._tier ?? 9;
      const tierLabel = tier === 0 ? 'Exact' : tier === 1 ? 'Normalized exact' : tier === 2 ? 'Partial' : 'Fuzzy';
      statusEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-a)" stroke-width="2" style="width: 20px; height: 20px;"><polyline points="20 6 9 17 4 12"/></svg><span style="font-size: 0.85rem; color: var(--tier-a);">Entity verified (${tierLabel} match)</span>`;
      setTimeout(() => statusEl.remove(), 2200);
    } else {
      statusEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-d)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span style="font-size: 0.85rem; color: var(--tier-d);">No candidates found</span>';
      setTimeout(() => statusEl.remove(), 2200);
    }
  } catch (err) {
    console.error(err);
    statusEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 20px; height: 20px;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span style="font-size: 0.85rem; color: var(--tier-e);">Entity verification failed</span>';
    setTimeout(() => statusEl.remove(), 3000);
  }
}

async function handleQuickScrub(e) {
  const files = e.target?.files;
  if (!files?.length || !currentDeal) return;
  const apiKey = getGeminiApiKey();
  if (!apiKey) { alert('Enter your Gemini API key first.'); return; }

  showLoadingOverlay();

  try {
    const extractedData = await processFilesWithGemini(files, apiKey);

    // Keep raw extraction for audit
    currentDeal.bankData = extractedData;

    // Auto-fill (do not overwrite manual)
    currentDeal._fieldSource = currentDeal._fieldSource || {};

    const setAuto = (field, value) => {
      if (value === undefined || value === null) return;
      if (typeof value === 'string' && !value.trim()) return;
      const manual = currentDeal._fieldSource[field] === 'manual';
      const empty = !currentDeal[field] || String(currentDeal[field]).trim() === '';
      if (empty && !manual) {
        currentDeal[field] = value;
        currentDeal._fieldSource[field] = 'bank';
      }
    };

    // Business fields
    setAuto('businessName', extractedData?.business?.name || extractedData.businessName || '');
    setAuto('dba', extractedData?.business?.dba || extractedData.dba || '');
    setAuto('address', extractedData?.business?.address || extractedData.address || '');
    setAuto('industry', extractedData?.business?.industry || extractedData.industry || '');
    setAuto('stateCode', extractedData?.business?.stateCode || '');
    setAuto('entityType', extractedData?.business?.entityType || '');
    setAuto('entityStatus', extractedData?.business?.status || '');
    setAuto('formationDate', extractedData?.business?.formationDate || '');
    setAuto('website', extractedData?.business?.website || '');
    setAuto('phone', extractedData?.business?.phone || '');

    // Owner
    setAuto('ownerName', extractedData?.owner?.name || extractedData.ownerName || '');
    setAuto('ownerEmail', extractedData?.owner?.email || '');
    setAuto('ownerPhone', extractedData?.owner?.phone || '');
    setAuto('ownerSSNLast4', extractedData?.owner?.ssn_last4 || '');
    setAuto('ownerDOB', extractedData?.owner?.dob || '');
    setAuto('ownerAddress', extractedData?.owner?.address || '');

    // Credit Report (if provided)
    if (extractedData?.credit_report) {
      const cr = extractedData.credit_report;
      const hasScores = cr.scores?.fico || cr.scores?.vantage || cr.scores?.experian || cr.scores?.equifax || cr.scores?.transunion;
      const hasTradelines = cr.tradelines?.length > 0;
      const hasSummary = cr.summary?.total_accounts > 0;
      if (hasScores || hasTradelines || hasSummary) {
        currentDeal.credit_report = cr;
        console.log('Credit report saved:', cr);
      }
    }

    // Months merge (fill blanks/zeros only)
    const incoming = normalizeMonths(extractedData.months || []);
    const existing = normalizeMonths(currentDeal.months || []);
    const byKey = new Map(existing.map(m => [m.monthKey, m]));

    for (const m of incoming) {
      const ex = byKey.get(m.monthKey);
      if (!ex) byKey.set(m.monthKey, m);
      else {
        const fields = ['revenue','deposits','withdrawals','endingBal','avgDailyBal','depositCount','overdraftFees','nsfs','negatives'];
        for (const f of fields) {
          const exVal = Number(ex[f] || 0);
          const inVal = Number(m[f] || 0);
          if ((exVal === 0 || Number.isNaN(exVal)) && inVal > 0) ex[f] = inVal;
        }
      }
    }

    currentDeal.months = [...byKey.values()].sort((a,b) => (a.monthKey || '').localeCompare(b.monthKey || ''));

    // Formation date -> TIB if empty
    if (currentDeal.formationDate && (!currentDeal.tib || String(currentDeal.tib).trim() === '')) {
      const years = Math.floor((Date.now() - new Date(currentDeal.formationDate).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
      currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
    }

    saveDealsToStorage();
    renderDealList();
    populateDetailView();
    
    // Trigger webhook for bank statement processed
    triggerWebhook('bankProcessed', currentDeal);

    // Auto-run entity verification if business name found
    if (currentDeal.businessName) {
      searchAndFillEntity(currentDeal.businessName, apiKey).then(() => {
        // Auto-trigger all Intel Center searches after entity verification completes
        if (currentDeal.businessName && currentDeal.months?.length > 0) {
          // Run all searches in parallel (staggered to avoid rate limits)
          if (!currentDeal.deepResearch) runDeepResearchAuto();
          setTimeout(() => { if (!currentDeal.clearReport) runBackgroundAuto(); }, 2000);
          setTimeout(() => { if (!currentDeal.footprintReport) runFootprintAuto(); }, 4000);
        }
      });
    }
    
    // Auto-run debt analysis if we have bank data
    if (currentDeal.months?.length > 0 && !currentDeal.debtReport) {
      runDebtAnalysisAuto();
    }

  } catch (err) {
    console.error(err);
    alert('Error processing files: ' + (err.message || err));
  } finally {
    hideLoadingOverlay();
    if (e.target) e.target.value = '';
  }
}

async function handleReScrub(e) {
  handleQuickScrub(e);
}

// Credit Report specific upload handler
async function handleCreditReportUpload(e) {
  if (!currentDeal) return;
  const files = e.target.files;
  if (!files.length) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  showLoadingOverlay('Analyzing credit report...');
  
  try {
    const model = getGeminiModel();
    
    // Build credit report specific prompt
    const instruction = `You are a credit report analyzer. Extract ALL data from this credit report.
Return ONLY valid JSON in this exact format:
{
  "credit_report": {
    "bureau": "",
    "report_date": "",
    "subject_name": "",
    "subject_address": "",
    "scores": {
      "fico": 0,
      "vantage": 0,
      "experian": 0,
      "equifax": 0,
      "transunion": 0
    },
    "summary": {
      "total_accounts": 0,
      "open_accounts": 0,
      "closed_accounts": 0,
      "delinquent_accounts": 0,
      "derogatory_accounts": 0,
      "total_balance": 0,
      "total_credit_limit": 0,
      "credit_utilization": 0,
      "total_monthly_payment": 0,
      "oldest_account_age": "",
      "average_account_age": ""
    },
    "payment_history": {
      "on_time_percentage": 0,
      "late_30_days": 0,
      "late_60_days": 0,
      "late_90_days": 0,
      "collections": 0,
      "charge_offs": 0
    },
    "public_records": {
      "bankruptcies": [],
      "judgments": [],
      "liens": [],
      "foreclosures": []
    },
    "inquiries": {
      "hard_inquiries_24mo": 0,
      "recent_inquiries": []
    },
    "tradelines": [
      {
        "creditor": "",
        "account_type": "",
        "account_number_last4": "",
        "date_opened": "",
        "credit_limit": 0,
        "high_balance": 0,
        "current_balance": 0,
        "monthly_payment": 0,
        "payment_status": "",
        "last_reported": "",
        "remarks": ""
      }
    ],
    "collections": [
      {
        "creditor": "",
        "original_creditor": "",
        "balance": 0,
        "date_opened": "",
        "status": ""
      }
    ]
  }
}

IMPORTANT:
- Extract ALL credit scores visible (FICO, VantageScore, and bureau-specific scores)
- Extract ALL tradelines visible in the report
- Look for scores labeled as "Score", "FICO", "VantageScore", or by bureau name
- Calculate on_time_percentage if not shown directly
- Include ALL accounts: credit cards, loans, mortgages, etc.`;

    const parts = [{ text: instruction }];
    
    for (const file of files) {
      const base64 = await fileToBase64(file);
      const mimeType = file.type || (file.name.toLowerCase().endsWith('.pdf') ? 'application/pdf' : 'image/jpeg');
      parts.push({ inline_data: { mime_type: mimeType, data: base64.split(',')[1] } });
    }
    
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts }],
        generationConfig: { temperature: 0.1 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed?.credit_report) {
      const cr = parsed.credit_report;
      const hasScores = cr.scores?.fico || cr.scores?.vantage || cr.scores?.experian || cr.scores?.equifax || cr.scores?.transunion;
      const hasTradelines = cr.tradelines?.length > 0;
      const hasSummary = cr.summary?.total_accounts > 0;
      
      if (hasScores || hasTradelines || hasSummary) {
        currentDeal.credit_report = cr;
        
        // Also update FICO in main fields if present
        if (cr.scores?.fico && !currentDeal.fico) {
          currentDeal.fico = cr.scores.fico;
        } else if (!currentDeal.fico) {
          // Use any available score
          currentDeal.fico = cr.scores?.vantage || cr.scores?.experian || cr.scores?.equifax || cr.scores?.transunion || 0;
        }
        
        saveDealsToStorage();
        populateDetailView();
        switchIntelTab('credit');
        
        // Trigger webhook for credit report analyzed
        triggerWebhook('credit', currentDeal);
        
        showToast('Credit Report Analyzed', `${cr.tradelines?.length || 0} tradelines extracted`);
      } else {
        showToast('No Data Found', 'Could not extract credit data from file', 'warning');
      }
    } else {
      showToast('Analysis Failed', 'Could not parse credit report', 'error');
    }
  } catch (err) {
    console.error('Credit report error:', err);
    showToast('Error', err.message, 'error');
  } finally {
    hideLoadingOverlay();
    e.target.value = '';
  }
}

// Auto deep research (silent, no modal until complete)
async function runDeepResearchAuto() {
  if (!currentDeal?.businessName) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  try {
    const model = getGeminiModel();
    const businessName = currentDeal.businessName;
    
    const prompt = buildDeepResearchPrompt(businessName);

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.deepResearch = parsed;
      // Auto-apply key fields
      if (parsed.overview?.legal_name && !currentDeal._fieldSource?.businessName) {
        currentDeal.businessName = parsed.overview.legal_name;
      }
      if (parsed.overview?.entity_type) currentDeal.entityType = parsed.overview.entity_type;
      if (parsed.overview?.status) currentDeal.entityStatus = parsed.overview.status;
      if (parsed.overview?.formation_date) currentDeal.formationDate = parsed.overview.formation_date;
      if (parsed.operations?.industry) currentDeal.industry = parsed.operations.industry;
      if (parsed.financials?.years_in_business) currentDeal.tib = `${parsed.financials.years_in_business} years`;
      
      saveDealsToStorage();
      populateDetailView();
      
      // Trigger webhook for deep research complete
      triggerWebhook('research', currentDeal);
      
      // Show subtle notification
      showToast('Deep Research Complete', parsed.risk?.rating ? `Risk: ${parsed.risk.rating}` : 'Data applied');
    }
  } catch (err) {
    console.warn('Auto deep research failed:', err);
  }
}

// Auto debt analysis (silent, runs automatically after bank data loaded)
async function runDebtAnalysisAuto() {
  if (!currentDeal?.businessName || !currentDeal?.months?.length) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  try {
    const model = getGeminiModel();
    const bankData = currentDeal.months || [];
    const prompt = buildDebtReportPrompt(currentDeal.businessName, bankData);
    
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.debtReport = parsed;
      saveDealsToStorage();
      renderDebtReportSection(parsed);
      updateIntelBadges();
      showToast('Debt Analysis Complete', `${parsed.active_positions || 0} positions found`);
    }
  } catch (err) {
    console.warn('Auto debt analysis failed:', err);
  }
}

// Auto background check (silent, runs automatically)
async function runBackgroundAuto() {
  if (!currentDeal?.businessName) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  try {
    const model = getGeminiModel();
    const ownerName = currentDeal.ownerName || currentDeal.principalName || '';
    const prompt = buildClearReportPrompt(currentDeal.businessName, ownerName);
    
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.clearReport = parsed;
      saveDealsToStorage();
      renderClearReportSection(parsed);
      updateIntelBadges();
      showToast('Background Check Complete', `Found ${(parsed.ucc_filings?.length || 0) + (parsed.liens?.length || 0)} records`);
    }
  } catch (err) {
    console.warn('Auto background check failed:', err);
  }
}

// Auto footprint scan (silent, runs automatically)
async function runFootprintAuto() {
  if (!currentDeal?.businessName) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) return;
  
  try {
    const model = getGeminiModel();
    const prompt = buildFootprintPrompt(currentDeal.businessName);
    
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (parsed) {
      currentDeal.footprintReport = parsed;
      saveDealsToStorage();
      renderFootprintReportSection(parsed);
      updateIntelBadges();
      showToast('Footprint Scan Complete', `Found ${parsed.social_media?.length || 0} social profiles`);
    }
  } catch (err) {
    console.warn('Auto footprint scan failed:', err);
  }
}

// FULL RE-SCRUB - Re-checks EVERYTHING
async function fullReScrub() {
  if (!currentDeal) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const confirmed = confirm('Full Re-Scrub will:\n\n- Re-verify entity with Secretary of State\n- Run fresh Deep Research\n- Re-analyze all bank data\n- Update all auto-filled fields\n\nManual entries will be preserved.\n\nContinue?');
  if (!confirmed) return;
  
  showLoadingOverlay('Running Full Re-Scrub...');
  
  try {
    const businessName = currentDeal.businessName;
    const model = getGeminiModel();
    
    // Clear previous research to force refresh
    delete currentDeal.entityData;
    delete currentDeal.deepResearch;
    
    // Step 1: Entity Verification
    updateLoadingMessage('Verifying entity with Secretary of State...');
    if (businessName) {
      await searchAndFillEntity(businessName, apiKey);
    }
    
    // Step 2: Deep Research
    updateLoadingMessage('Running comprehensive deep research...');
    if (businessName) {
      const prompt = buildDeepResearchPrompt(businessName);
      
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          tools: [{ google_search: {} }],
          generationConfig: { temperature: 0.2 }
        })
      });

      const data = await res.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const research = safeJsonFromText(text);
      
      if (research) {
        currentDeal.deepResearch = research;
        
        // Apply research data (don't overwrite manual)
        const setIfEmpty = (field, value) => {
          if (!value) return;
          const manual = currentDeal._fieldSource?.[field] === 'manual';
          if (!manual) {
            currentDeal[field] = value;
            currentDeal._fieldSource = currentDeal._fieldSource || {};
            currentDeal._fieldSource[field] = 'research';
          }
        };
        
        setIfEmpty('entityType', research.overview?.entity_type);
        setIfEmpty('entityStatus', research.overview?.status);
        setIfEmpty('formationDate', research.overview?.formation_date);
        setIfEmpty('industry', research.operations?.industry);
        setIfEmpty('address', research.overview?.address);
        if (research.financials?.years_in_business) {
          setIfEmpty('tib', `${research.financials.years_in_business} years`);
        }
      }
    }
    
    // Step 3: Re-score
    updateLoadingMessage('Recalculating score...');
    saveDealsToStorage();
    populateDetailView();
    
    showToast('Full Re-Scrub Complete', currentDeal.deepResearch?.risk?.rating ? `Risk Rating: ${currentDeal.deepResearch.risk.rating}` : 'All data refreshed');
    
  } catch (err) {
    console.error('Full re-scrub failed:', err);
    alert('Re-scrub error: ' + (err.message || err));
  } finally {
    hideLoadingOverlay();
  }
}

function buildDeepResearchPrompt(businessName) {
  return `You are a comprehensive business research analyst.

BUSINESS: "${businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.industry ? `INDUSTRY: ${currentDeal.industry}` : ''}
${currentDeal?.address ? `ADDRESS: ${currentDeal.address}` : ''}

Conduct thorough research and provide a comprehensive analysis including:

1. COMPANY OVERVIEW - Legal name, DBAs, formation date/state, entity type, status, registered agent, addresses
2. OWNERSHIP & MANAGEMENT - Officers, directors, principals, ownership structure
3. BUSINESS OPERATIONS - Industry (NAICS/SIC), business model, services, competitors, locations
4. FINANCIAL INDICATORS - Revenue estimates, employee count, growth indicators
5. COMPLIANCE & LEGAL - Licenses, regulatory actions, lawsuits, liens, judgments, UCC filings
6. REPUTATION - Customer reviews, BBB status, news mentions, awards
7. RISK ASSESSMENT - Red flags, industry risks, operational concerns, overall rating (Low/Medium/High)

Return as JSON:
{
  "overview": {
    "legal_name": "", "dba": "", "entity_type": "", "state": "",
    "formation_date": "", "status": "", "registered_agent": "", "address": ""
  },
  "ownership": {
    "officers": [{"name": "", "title": ""}],
    "ownership_structure": ""
  },
  "operations": {
    "industry": "", "naics": "", "description": "",
    "services": [], "competitors": [], "locations": []
  },
  "financials": {
    "revenue_estimate": "", "employee_count": "",
    "years_in_business": 0, "growth_trend": ""
  },
  "compliance": {
    "licenses": [], "regulatory_actions": [],
    "lawsuits": [], "liens": [], "ucc_filings": []
  },
  "reputation": {
    "bbb_rating": "", "review_score": "",
    "review_count": 0, "news_mentions": [], "awards": []
  },
  "risk": {
    "rating": "", "red_flags": [],
    "industry_risks": [], "concerns": []
  },
  "sources": [{"title": "", "url": ""}],
  "summary": "",
  "confidence": 0
}`;
}

function showToast(title, message) {
  const existing = document.querySelector('.toast-notification');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div style="font-weight: 600;">${title}</div>
    <div style="font-size: 0.85rem; opacity: 0.9;">${message}</div>
  `;
  toast.style.cssText = `
    position: fixed; bottom: 24px; right: 24px; background: linear-gradient(135deg, var(--accent), #d97706);
    color: white; padding: 16px 24px; border-radius: 12px; z-index: 10000;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3); animation: slideInToast 0.3s ease;
  `;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutToast 0.3s ease forwards';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function updateLoadingMessage(msg) {
  const titleEl = document.getElementById('loadingTitle');
  const descEl = document.getElementById('loadingDesc');
  if (titleEl) titleEl.textContent = msg;
  if (descEl) descEl.textContent = 'Please wait...';
}

async function processFilesWithGemini(files, apiKey) {
  const modelPref = getGeminiModel();
  const models = modelPref ? [modelPref, 'gemini-3-pro-preview', 'gemini-2.5-flash'] : ['gemini-3-pro-preview', 'gemini-2.5-flash'];

  const instruction = `You are a meticulous bank statement and credit report underwriter.

TASK: Extract and normalize the following from the provided PDFs/images. Documents may include bank statements AND/OR credit reports.

Return JSON ONLY in this schema:
{
  "business": {
    "name": "",
    "dba": "",
    "address": "",
    "phone": "",
    "website": "",
    "industry": "",
    "stateCode": "",
    "entityType": "",
    "status": "",
    "formationDate": ""
  },
  "owner": {
    "name": "",
    "email": "",
    "phone": "",
    "ssn_last4": "",
    "dob": "",
    "address": ""
  },
  "bank": {
    "bankName": "",
    "accountType": "",
    "accountLast4": "",
    "statementCurrency": "USD"
  },
  "statement": {
    "startDate": "",
    "endDate": ""
  },
  "months": [
    {
      "monthKey": "YYYY-MM",
      "monthLabel": "Jan 2024",
      "revenue": 0,
      "deposits": 0,
      "withdrawals": 0,
      "endingBal": 0,
      "avgDailyBal": 0,
      "depositCount": 0,
      "overdraftFees": 0,
      "nsfs": 0,
      "negatives": 0
    }
  ],
  "credit_report": {
    "bureau": "",
    "report_date": "",
    "subject_name": "",
    "subject_address": "",
    "scores": {
      "fico": 0,
      "vantage": 0,
      "experian": 0,
      "equifax": 0,
      "transunion": 0
    },
    "summary": {
      "total_accounts": 0,
      "open_accounts": 0,
      "closed_accounts": 0,
      "delinquent_accounts": 0,
      "derogatory_accounts": 0,
      "total_balance": 0,
      "total_credit_limit": 0,
      "credit_utilization": 0,
      "total_monthly_payment": 0,
      "oldest_account_age": "",
      "average_account_age": ""
    },
    "payment_history": {
      "on_time_percentage": 0,
      "late_30_days": 0,
      "late_60_days": 0,
      "late_90_days": 0,
      "collections": 0,
      "charge_offs": 0
    },
    "public_records": {
      "bankruptcies": [],
      "judgments": [],
      "liens": [],
      "foreclosures": []
    },
    "inquiries": {
      "hard_inquiries_24mo": 0,
      "recent_inquiries": []
    },
    "tradelines": [
      {
        "creditor": "",
        "account_type": "",
        "account_number_last4": "",
        "date_opened": "",
        "credit_limit": 0,
        "high_balance": 0,
        "current_balance": 0,
        "monthly_payment": 0,
        "payment_status": "",
        "last_reported": "",
        "remarks": ""
      }
    ],
    "collections": [
      {
        "creditor": "",
        "original_creditor": "",
        "balance": 0,
        "date_opened": "",
        "status": ""
      }
    ]
  },
  "confidence": 0,
  "warnings": []
}

GUIDELINES:
- If bank statements are provided: Extract monthly financial data accurately
- If credit reports are provided: Extract ALL credit data including tradelines, scores, payment history
- Use statement month totals when available. If only date-range totals exist, allocate ONLY if clearly broken out.
- If a field is not present, use empty string or 0 (do not hallucinate).
- If multiple accounts exist, extract the primary operating account totals.
- IMPORTANT: months must be accurate; do not invent months outside the statement period.
- For credit reports: Extract ALL tradelines visible, include payment status (Current, 30 days, 60 days, etc.)
- If no credit report is provided, leave credit_report fields empty/zero.`;

  // Build multimodal parts with per-file labels
  const parts = [{ text: instruction }];
  for (const f of files) {
    const b64 = await fileToBase64(f);
    parts.push({ text: `FILE: ${f.name} (${f.type || 'application/pdf'})` });
    parts.push({ inline_data: { mime_type: f.type || 'application/pdf', data: b64 } });
  }

  let lastErr;
  for (const m of models) {
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts }],
          generationConfig: { temperature: 0.1 }
        })
      });
      const data = await res.json();
      const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const parsed = safeJsonFromText(txt);
      if (parsed) {
        parsed.months = normalizeMonths(parsed.months || []);
        return parsed;
      }
    } catch (err) { lastErr = err; }
  }
  throw lastErr || new Error('Failed to process');
}

function fileToBase64(f) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result.split(',')[1]);
    r.onerror = rej;
    r.readAsDataURL(f);
  });
}

let loadingInterval;
function showLoadingOverlay(customMessage) {
  document.getElementById('loadingOverlay').classList.add('active');
  let time = 45, prog = 0;
  const phases = customMessage ? [
    { t: customMessage, d: 'This may take a moment...', p: 100 }
  ] : [
    { t: 'OCR Processing', d: 'Extracting text from documents using advanced optical character recognition.', p: 20 },
    { t: 'Cash Flow Analysis', d: 'Analyzing deposit patterns, withdrawal frequency, and balance trends.', p: 40 },
    { t: 'Risk Assessment', d: 'Evaluating NSF occurrences, negative balances, and financial stability.', p: 60 },
    { t: 'Data Verification', d: 'Cross-referencing extracted data for accuracy and completeness.', p: 80 },
    { t: 'Finalizing ABLESCORE', d: 'Calculating comprehensive underwriting score based on all factors.', p: 100 }
  ];
  let phase = 0;
  function upd() {
    if (phase < phases.length) {
      document.getElementById('loadingTitle').textContent = phases[phase].t;
      document.getElementById('loadingDesc').textContent = phases[phase].d;
    }
  }
  upd();
  loadingInterval = setInterval(() => {
    time--;
    prog += 100 / 45;
    document.getElementById('loadingTimer').textContent = `00:${time.toString().padStart(2, '0')}`;
    document.getElementById('loadingBar').style.width = `${Math.min(prog, 100)}%`;
    document.getElementById('loadingPercent').textContent = `${Math.round(Math.min(prog, 100))}% COMPLETE`;
    if (prog >= phases[phase]?.p && phase < phases.length - 1) { phase++; upd(); }
    if (time <= 0) clearInterval(loadingInterval);
  }, 1000);
}

function hideLoadingOverlay() {
  clearInterval(loadingInterval);
  document.getElementById('loadingOverlay').classList.remove('active');
}

function updateDashboard() {
  const totalRev = allDeals.reduce((s, d) => s + (d.months?.reduce((x, m) => x + (m.revenue || 0), 0) || 0), 0);
  const avgScore = allDeals.length ? Math.round(allDeals.reduce((s, d) => s + (d.score || 0), 0) / allDeals.length) : 0;
  const approved = allDeals.filter(d => (d.score || 0) >= 55).length;
  const highRisk = allDeals.filter(d => (d.score || 0) < 40).length;

  // New dashboard metrics
  const allMonths = allDeals.flatMap(d => normalizeMonths(d.months || []));
  const avgMonthlyRev = allMonths.length ? Math.round(allMonths.reduce((a, m) => a + (m.revenue || 0), 0) / allMonths.length) : 0;

  const completionVals = allDeals.map(d => calcDealCompleteness(d).pct);
  const avgCompletion = completionVals.length ? Math.round(completionVals.reduce((a,b) => a + b, 0) / completionVals.length) : 0;

  document.getElementById('dashRevenue').textContent = '$' + totalRev.toLocaleString();
  document.getElementById('dashScore').textContent = avgScore;
  document.getElementById('dashApproval').textContent = allDeals.length ? Math.round((approved / allDeals.length) * 100) + '%' : '0%';
  document.getElementById('dashRisk').textContent = highRisk;

  document.getElementById('dashDeals').textContent = allDeals.length;
  document.getElementById('dashAvgMonthlyRev').textContent = '$' + avgMonthlyRev.toLocaleString();
  document.getElementById('dashCompletion').textContent = avgCompletion + '%';

  // Score distribution
  if (scoreChart) {
    scoreChart.data.datasets[0].data = [
      allDeals.filter(d => (d.score || 0) >= 85).length,
      allDeals.filter(d => (d.score || 0) >= 70 && (d.score || 0) < 85).length,
      allDeals.filter(d => (d.score || 0) >= 55 && (d.score || 0) < 70).length,
      allDeals.filter(d => (d.score || 0) >= 40 && (d.score || 0) < 55).length,
      allDeals.filter(d => (d.score || 0) < 40).length
    ];
    scoreChart.update();
  }

  // Deal activity over last 6 months (created month)
  if (volumeChart) {
    const now = new Date();
    const labels = [];
    const counts = [];
    for (let i = 5; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      labels.push(monthLabelFromKey(key));
      const c = allDeals.filter(x => {
        const dt = new Date(x.id || Date.now());
        const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        return k === key;
      }).length;
      counts.push(c);
    }
    volumeChart.data.labels = labels;
    volumeChart.data.datasets[0].data = counts;
    volumeChart.update();
  }

  // Revenue trend over last 6 months (sum monthly revenue across deals)
  if (revenueTrendChart) {
    const now = new Date();
    const labels = [];
    const sums = [];
    const revByKey = new Map();
    for (const d of allDeals) {
      for (const m of normalizeMonths(d.months || [])) {
        revByKey.set(m.monthKey, (revByKey.get(m.monthKey) || 0) + (m.revenue || 0));
      }
    }
    for (let i = 5; i >= 0; i--) {
      const dt = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      labels.push(monthLabelFromKey(key));
      sums.push(Math.round(revByKey.get(key) || 0));
    }
    revenueTrendChart.data.labels = labels;
    revenueTrendChart.data.datasets[0].data = sums;
    revenueTrendChart.update();
  }

  // Completion distribution buckets
  if (completionChart) {
    const buckets = [0,0,0,0];
    for (const p of completionVals) {
      if (p < 40) buckets[0]++; else if (p < 60) buckets[1]++; else if (p < 80) buckets[2]++; else buckets[3]++;
    }
    completionChart.data.datasets[0].data = buckets;
    completionChart.update();
  }
}

function openMetricModal(type) {
  const modal = document.getElementById('metricModal');
  const title = document.getElementById('metricModalTitle');
  const subtitle = document.getElementById('metricModalSubtitle');
  const insights = document.getElementById('metricInsights');
  if (metricChart) metricChart.destroy();

  // Helper: last 6 month labels/keys
  const now = new Date();
  const keys = [];
  const labels = [];
  for (let i = 5; i >= 0; i--) {
    const dt = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    keys.push(key);
    labels.push(monthLabelFromKey(key));
  }

  const cfgs = {
    revenue: () => {
      const revByKey = new Map(keys.map(k => [k, 0]));
      for (const d of allDeals) {
        for (const m of normalizeMonths(d.months || [])) {
          if (revByKey.has(m.monthKey)) revByKey.set(m.monthKey, revByKey.get(m.monthKey) + (m.revenue || 0));
        }
      }
      const data = keys.map(k => Math.round(revByKey.get(k) || 0));
      return {
        t: 'Total Revenue Analysis',
        st: 'Total revenue by month (pipeline)',
        ct: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: '#22c55e', borderRadius: 6 }] },
        ins: [
          `Total pipeline revenue: $${Math.round(allDeals.reduce((s, d) => s + (d.months?.reduce((x, m) => x + (m.revenue || 0), 0) || 0), 0)).toLocaleString()}`,
          `Avg monthly revenue per statement month: $${(data.reduce((a,b)=>a+b,0)/(data.filter(x=>x>0).length||1)).toFixed(0)}`,
          `${allDeals.filter(d => (d.score||0) >= 55).length}/${allDeals.length} deals score  55`
        ]
      };
    },
    score: () => {
      const dist = [
        allDeals.filter(d => (d.score || 0) >= 85).length,
        allDeals.filter(d => (d.score || 0) >= 70 && (d.score || 0) < 85).length,
        allDeals.filter(d => (d.score || 0) >= 55 && (d.score || 0) < 70).length,
        allDeals.filter(d => (d.score || 0) >= 40 && (d.score || 0) < 55).length,
        allDeals.filter(d => (d.score || 0) < 40).length
      ];
      return {
        t: 'ABLESCORE Distribution',
        st: 'Score breakdown by tier',
        ct: 'doughnut',
        data: { labels: ['A','B','C','D','E'], datasets: [{ data: dist, backgroundColor: [TIER_COLORS.a, TIER_COLORS.b, TIER_COLORS.c, TIER_COLORS.d, TIER_COLORS.e] }] },
        ins: [
          `Avg score: ${allDeals.length ? Math.round(allDeals.reduce((s,d)=>s+(d.score||0),0)/allDeals.length) : 0}`,
          `Tier A+B count: ${dist[0] + dist[1]}`,
          `High-risk (<40) count: ${dist[4]}`
        ]
      };
    },
    approval: () => {
      const approved = allDeals.filter(d => (d.score || 0) >= 55).length;
      const rate = allDeals.length ? Math.round((approved / allDeals.length) * 100) : 0;

      // Use created month as proxy trend
      const byKey = new Map(keys.map(k => [k, { total: 0, approved: 0 }]));
      for (const d of allDeals) {
        const dt = new Date(d.id || Date.now());
        const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        if (!byKey.has(k)) continue;
        byKey.get(k).total += 1;
        if ((d.score || 0) >= 55) byKey.get(k).approved += 1;
      }
      const data = keys.map(k => {
        const v = byKey.get(k);
        return v.total ? Math.round((v.approved / v.total) * 100) : 0;
      });

      return {
        t: 'Approval Rate Trends',
        st: `Current approval rate: ${rate}% (score  55)`,
        ct: 'line',
        data: { labels, datasets: [{ data, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.4 }] },
        ins: [
          `Approved deals: ${approved}`,
          `High-risk deals: ${allDeals.filter(d => (d.score||0) < 40).length}`,
          `Avg profile completeness: ${allDeals.length ? Math.round(allDeals.map(d=>calcDealCompleteness(d).pct).reduce((a,b)=>a+b,0)/allDeals.length) : 0}%`
        ]
      };
    },
    risk: () => {
      const high = allDeals.filter(d => (d.score || 0) < 40);
      const lowFico = high.filter(d => (parseInt(d.fico,10) || 0) < 600).length;
      const nsfHeavy = high.filter(d => (d.months?.reduce((a,m)=>a+(m.nsfs||0),0) || 0) >= 3).length;
      const negHeavy = high.filter(d => (d.months?.reduce((a,m)=>a+(m.negatives||0),0) || 0) >= 10).length;
      const revVar = high.filter(d => {
        const revs = (d.months||[]).map(m => m.revenue || 0).filter(x=>x>0);
        if (revs.length < 3) return false;
        const avg = revs.reduce((a,b)=>a+b,0)/revs.length;
        const variance = revs.reduce((a,b)=>a+Math.pow(b-avg,2),0)/revs.length;
        const cv = Math.sqrt(variance) / (avg || 1);
        return cv >= 0.4;
      }).length;

      return {
        t: 'High Risk Analysis',
        st: 'Drivers among deals scoring below 40',
        ct: 'bar',
        data: { labels: ['Low FICO', 'NSF  3', 'Neg Days  10', 'Rev Variance'], datasets: [{ data: [lowFico, nsfHeavy, negHeavy, revVar], backgroundColor: '#ef4444', borderRadius: 6 }] },
        ins: [
          `High-risk deals: ${high.length}`,
          `Most common signal: ${['Low FICO','NSF  3','Neg Days  10','Rev Variance'][[lowFico,nsfHeavy,negHeavy,revVar].indexOf(Math.max(lowFico,nsfHeavy,negHeavy,revVar))] || ''}`,
          `Recommendation: enrich entity + bank data to improve confidence`
        ]
      };
    },
    deals: () => {
      const byKey = new Map(keys.map(k => [k, 0]));
      for (const d of allDeals) {
        const dt = new Date(d.id || Date.now());
        const k = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
        if (byKey.has(k)) byKey.set(k, byKey.get(k) + 1);
      }
      const data = keys.map(k => byKey.get(k) || 0);
      return {
        t: 'Deal Activity',
        st: 'Deals created per month',
        ct: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: '#eab308', borderRadius: 6 }] },
        ins: [
          `Total deals: ${allDeals.length}`,
          `Deals last 30 days (approx): ${allDeals.filter(d => (Date.now() - (d.id || 0)) < 30*24*60*60*1000).length}`,
          `Avg score: ${allDeals.length ? Math.round(allDeals.reduce((s,d)=>s+(d.score||0),0)/allDeals.length) : 0}`
        ]
      };
    },
    completion: () => {
      const vals = allDeals.map(d => calcDealCompleteness(d).pct);
      const buckets = [0,0,0,0];
      for (const p of vals) { if (p < 40) buckets[0]++; else if (p < 60) buckets[1]++; else if (p < 80) buckets[2]++; else buckets[3]++; }
      return {
        t: 'Profile Completeness',
        st: 'Data quality distribution (required fields)',
        ct: 'bar',
        data: { labels: ['0-39%', '40-59%', '60-79%', '80-100%'], datasets: [{ data: buckets, backgroundColor: '#a855f7', borderRadius: 6 }] },
        ins: [
          `Avg completion: ${vals.length ? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length) : 0}%`,
          `Deals  80%: ${buckets[3]}`,
          `Deals < 60%: ${buckets[0] + buckets[1]}`
        ]
      };
    },
    avg_monthly_revenue: () => {
      const allMonths = allDeals.flatMap(d => normalizeMonths(d.months || []));
      const revs = allMonths.map(m => m.revenue || 0);
      const avg = revs.length ? Math.round(revs.reduce((a,b)=>a+b,0)/revs.length) : 0;
      return {
        t: 'Avg Monthly Revenue',
        st: 'Average across all statement months',
        ct: 'line',
        data: { labels, datasets: [{ data: labels.map((_,i)=>0), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.08)', fill: true, tension: 0.35 }] },
        ins: [
          `Avg monthly revenue: $${avg.toLocaleString()}`,
          `Statement months captured: ${revs.length}`,
          `Tip: Upload full 3-6 month package to stabilize variance`
        ]
      };
    }
  };

  const builder = cfgs[type] || cfgs.score;
  const c = builder();

  title.textContent = c.t;
  subtitle.textContent = c.st;
  insights.innerHTML = c.ins.map(i => `<div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--accent); font-size: 0.85rem; color: var(--text-secondary);">${i}</div>`).join('');

  metricChart = new Chart(document.getElementById('metricModalChart'), {
    type: c.ct,
    data: c.data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: c.ct === 'doughnut', position: 'bottom', labels: { color: '#a1a1aa', font: { family: 'DM Sans' } } } },
      scales: c.ct === 'doughnut' ? {} : {
        y: { grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });

  modal.classList.add('active');
}

function closeMetricModal() { document.getElementById('metricModal').classList.remove('active'); }
function closeEntityModal() { document.getElementById('entityModal').classList.remove('active'); }
function closeSettingsModal() { document.getElementById('settingsModal').classList.remove('active'); }

function toggleSidebar() {
  const sidebar = document.getElementById('detailSidebar');
  sidebar.classList.toggle('collapsed');
  localStorage.setItem('sidebar_collapsed', sidebar.classList.contains('collapsed'));
}

function initSidebarState() {
  const collapsed = localStorage.getItem('sidebar_collapsed') === 'true';
  if (collapsed) {
    document.getElementById('detailSidebar')?.classList.add('collapsed');
  }
  // Initialize panel states
  initPanelStates();
}

// ===============================
// COLLAPSIBLE PANEL FUNCTIONS
// ===============================
function togglePanel(panelId) {
  const panel = document.getElementById(panelId);
  if (panel) {
    panel.classList.toggle('collapsed');
    localStorage.setItem(panelId + '_collapsed', panel.classList.contains('collapsed'));
  }
}

function initPanelStates() {
  ['panelScore', 'panelQuickScrub', 'panelHubble'].forEach(panelId => {
    const collapsed = localStorage.getItem(panelId + '_collapsed') === 'true';
    if (collapsed) {
      document.getElementById(panelId)?.classList.add('collapsed');
    }
  });
}

// ===============================
// HUBBLE AI CHAT (Gemini API)
// ===============================
let hubbleHistory = [];

async function sendHubbleMessage() {
  const input = document.getElementById('hubbleInput');
  const message = input.value.trim();
  if (!message || !currentDeal) return;
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    addChatMessage('system', 'Please add your Gemini API key in Settings.');
    return;
  }
  
  input.value = '';
  addChatMessage('user', message);
  
  const sendBtn = document.getElementById('hubbleSendBtn');
  sendBtn.disabled = true;
  
  const dealContext = buildDealContext();
  
  // Build conversation history for context
  let historyContext = '';
  if (hubbleHistory.length > 0) {
    historyContext = '\n\nPrevious conversation:\n' + hubbleHistory.map(h => `${h.role}: ${h.content}`).join('\n');
  }
  
  try {
    const model = getGeminiModel();
    const prompt = `You are Hubble, an expert MCA underwriter assistant. Analyze deals and provide insights on cash flow, risk, and funding recommendations. Be concise and direct.

Current deal context:
${dealContext}
${historyContext}

User question: ${message}

Provide a helpful, concise response.`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.4, maxOutputTokens: 1024 }
      })
    });
    
    const data = await response.json();
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
    
    hubbleHistory.push({ role: 'user', content: message });
    hubbleHistory.push({ role: 'assistant', content: reply });
    
    // Keep history manageable
    if (hubbleHistory.length > 10) {
      hubbleHistory = hubbleHistory.slice(-10);
    }
    
    addChatMessage('assistant', reply);
  } catch (err) {
    console.error('Hubble error:', err);
    addChatMessage('system', 'Error: ' + err.message);
  } finally {
    sendBtn.disabled = false;
  }
}

function buildDealContext() {
  if (!currentDeal) return 'No deal selected.';
  
  const months = currentDeal.months || [];
  const totalRev = months.reduce((s, m) => s + (m.revenue || 0), 0);
  const avgRev = months.length ? Math.round(totalRev / months.length) : 0;
  const totalNsf = months.reduce((s, m) => s + (m.nsfs || 0), 0);
  const totalNegDays = months.reduce((s, m) => s + (m.negatives || 0), 0);
  const avgDailyBal = months.length ? Math.round(months.reduce((s, m) => s + (m.avgDailyBal || 0), 0) / months.length) : 0;
  
  let context = `Business: ${currentDeal.businessName || 'Unknown'}
DBA: ${currentDeal.dba || 'N/A'}
Industry: ${currentDeal.industry || 'Unknown'}
Time in Business: ${currentDeal.tib || 'Unknown'}
Entity Type: ${currentDeal.entityType || 'Unknown'}
Status: ${currentDeal.entityStatus || 'Unknown'}
State: ${currentDeal.stateCode || 'Unknown'}

Owner: ${currentDeal.ownerName || 'Unknown'}
FICO Score: ${currentDeal.fico || 'Unknown'}
Ownership: ${currentDeal.ownership || 100}%

ABLESCORE: ${currentDeal.score || 0}/100
Tier: ${currentDeal.tier || 'Unknown'}

Financial Summary (${months.length} months of data):
- Total Revenue: $${totalRev.toLocaleString()}
- Average Monthly Revenue: $${avgRev.toLocaleString()}
- Average Daily Balance: $${avgDailyBal.toLocaleString()}
- Total NSFs: ${totalNsf}
- Total Negative Days: ${totalNegDays}`;

  if (currentDeal.deepResearch?.risk) {
    context += `

Risk Assessment:
- Rating: ${currentDeal.deepResearch.risk.rating || 'Unknown'}
- Score: ${currentDeal.deepResearch.risk.score || 'Unknown'}/100`;
  }

  if (currentDeal.credit_report) {
    context += `

Credit Report:
- FICO: ${currentDeal.credit_report.scores?.fico || 'N/A'}
- Total Accounts: ${currentDeal.credit_report.summary?.total_accounts || 'N/A'}
- Delinquent: ${currentDeal.credit_report.summary?.delinquent_accounts || 'N/A'}`;
  }

  return context;
}

function addChatMessage(role, content) {
  const container = document.getElementById('hubbleMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'ai-message ' + role;
  
  // Format markdown-like content
  let formatted = content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
  
  msgDiv.innerHTML = formatted;
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

function quickHubble(prompt) {
  document.getElementById('hubbleInput').value = prompt;
  sendHubbleMessage();
}

function clearHubbleChat() {
  hubbleHistory = [];
  const container = document.getElementById('hubbleMessages');
  container.innerHTML = '<div class="ai-message system">Ask me anything about this deal. I can analyze financials, research the business, assess risk, and more.</div>';
}

function switchSettingsTab(tab) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('settingsTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('settingsPanel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

function openSettingsModal() {
  const apiKey = localStorage.getItem('greatdane_api_key') || '';
  const model = localStorage.getItem('greatdane_model') || 'gemini-2.5-flash';
  document.getElementById('settingsApiKey').value = apiKey;
  document.getElementById('settingsModel').value = model;
  loadUnderwritingSettings();
  document.getElementById('settingsModal').classList.add('active');
}

function loadUnderwritingSettings() {
  const defaults = {
    ficoWeight: 50, ficoFloor: 500, ficoCeiling: 800,
    revenueWeight: 20, revenueThreshold: 10,
    nsfPenaltyMax: 15, nsfThreshold: 3,
    negativeDayPenaltyMax: 10, negativeDayThreshold: 5,
    tib6moBonus: 5, tib12moBonus: 8, tib24moBonus: 10,
    collectWeight: 15, minAvgDailyBal: 500, depositFreqWeight: 10, lowBalPenalty: 10
  };
  Object.keys(defaults).forEach(key => {
    const val = localStorage.getItem('uw_' + key) || defaults[key];
    const el = document.getElementById('uw_' + key);
    if (el) {
      el.value = val;
      const display = document.getElementById('uw_' + key + '_val');
      if (display) display.textContent = val;
    }
  });
  
  // Load webhook settings
  loadWebhookSettings();
}

function updateUnderwritingSetting(key, value) {
  localStorage.setItem('uw_' + key, value);
  const display = document.getElementById('uw_' + key + '_val');
  if (display) display.textContent = value;
}

function resetUnderwritingDefaults() {
  const defaults = {
    ficoWeight: 50, ficoFloor: 500, ficoCeiling: 800,
    revenueWeight: 20, revenueThreshold: 10,
    nsfPenaltyMax: 15, nsfThreshold: 3,
    negativeDayPenaltyMax: 10, negativeDayThreshold: 5,
    tib6moBonus: 5, tib12moBonus: 8, tib24moBonus: 10,
    collectWeight: 15, minAvgDailyBal: 500, depositFreqWeight: 10, lowBalPenalty: 10
  };
  Object.keys(defaults).forEach(key => {
    localStorage.setItem('uw_' + key, defaults[key]);
    const el = document.getElementById('uw_' + key);
    if (el) el.value = defaults[key];
    const display = document.getElementById('uw_' + key + '_val');
    if (display) display.textContent = defaults[key];
  });
  showToast('Underwriting settings reset to defaults', 'success');
}

// ===============================
// WEBHOOK / ZAPIER INTEGRATION
// ===============================
function loadWebhookSettings() {
  const webhookFields = ['webhookNewDeal', 'webhookBankProcessed', 'webhookScoreCalc', 'webhookResearch', 'webhookCredit', 'webhookStatus'];
  webhookFields.forEach(field => {
    const el = document.getElementById(field);
    if (el) el.value = localStorage.getItem(field) || '';
  });
  
  const enabled = document.getElementById('webhooksEnabled');
  if (enabled) enabled.checked = localStorage.getItem('webhooksEnabled') === 'true';
  
  const includeMonths = document.getElementById('webhookIncludeMonths');
  if (includeMonths) includeMonths.checked = localStorage.getItem('webhookIncludeMonths') === 'true';
}

function saveWebhookSettings() {
  const webhookFields = ['webhookNewDeal', 'webhookBankProcessed', 'webhookScoreCalc', 'webhookResearch', 'webhookCredit', 'webhookStatus'];
  webhookFields.forEach(field => {
    const el = document.getElementById(field);
    if (el) localStorage.setItem(field, el.value);
  });
  
  const enabled = document.getElementById('webhooksEnabled');
  if (enabled) localStorage.setItem('webhooksEnabled', enabled.checked);
  
  const includeMonths = document.getElementById('webhookIncludeMonths');
  if (includeMonths) localStorage.setItem('webhookIncludeMonths', includeMonths.checked);
}

async function triggerWebhook(type, data) {
  if (localStorage.getItem('webhooksEnabled') !== 'true') return;
  
  const webhookMap = {
    'newDeal': 'webhookNewDeal',
    'bankProcessed': 'webhookBankProcessed',
    'scoreCalc': 'webhookScoreCalc',
    'research': 'webhookResearch',
    'credit': 'webhookCredit',
    'status': 'webhookStatus'
  };
  
  const webhookUrl = localStorage.getItem(webhookMap[type]);
  if (!webhookUrl) return;
  
  try {
    const includeMonths = localStorage.getItem('webhookIncludeMonths') === 'true';
    const payload = {
      event: type,
      timestamp: new Date().toISOString(),
      deal: {
        id: data.id,
        businessName: data.businessName,
        dba: data.dba,
        industry: data.industry,
        address: data.address,
        stateCode: data.stateCode,
        entityType: data.entityType,
        entityStatus: data.entityStatus,
        formationDate: data.formationDate,
        tib: data.tib,
        website: data.website,
        phone: data.phone,
        ownerName: data.ownerName,
        ownerEmail: data.ownerEmail,
        ownerPhone: data.ownerPhone,
        fico: data.fico,
        score: data.score,
        tier: data.tier,
        createdAt: data.createdAt
      }
    };
    
    // Add monthly data if enabled
    if (includeMonths && data.months?.length) {
      payload.deal.months = data.months;
      payload.deal.summary = {
        totalRevenue: data.months.reduce((s, m) => s + (m.revenue || 0), 0),
        avgMonthlyRevenue: Math.round(data.months.reduce((s, m) => s + (m.revenue || 0), 0) / data.months.length),
        totalDeposits: data.months.reduce((s, m) => s + (m.deposits || 0), 0),
        avgDailyBalance: Math.round(data.months.reduce((s, m) => s + (m.avgDailyBal || 0), 0) / data.months.length),
        totalNSFs: data.months.reduce((s, m) => s + (m.nsfs || 0), 0),
        totalNegativeDays: data.months.reduce((s, m) => s + (m.negatives || 0), 0)
      };
    }
    
    // Add type-specific data
    if (type === 'research' && data.deepResearch) {
      payload.research = {
        riskRating: data.deepResearch.risk?.rating,
        riskScore: data.deepResearch.risk?.score,
        industry: data.deepResearch.operations?.industry,
        yearsInBusiness: data.deepResearch.financials?.years_in_business
      };
    }
    
    if (type === 'credit' && data.credit_report) {
      payload.credit = {
        fico: data.credit_report.scores?.fico,
        vantage: data.credit_report.scores?.vantage,
        totalAccounts: data.credit_report.summary?.total_accounts,
        delinquent: data.credit_report.summary?.delinquent_accounts,
        utilization: data.credit_report.summary?.credit_utilization
      };
    }
    
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      mode: 'no-cors',
      body: JSON.stringify(payload)
    });
    
    console.log(`Webhook triggered: ${type}`);
  } catch (err) {
    console.error('Webhook error:', err);
  }
}

async function testWebhook() {
  if (!currentDeal) {
    showToast('No Deal Selected', 'Open a deal first to test webhooks', 'warning');
    return;
  }
  
  const webhooks = [
    { field: 'webhookNewDeal', name: 'New Deal' },
    { field: 'webhookBankProcessed', name: 'Bank Processed' },
    { field: 'webhookScoreCalc', name: 'Score Calc' },
    { field: 'webhookResearch', name: 'Research' },
    { field: 'webhookCredit', name: 'Credit' },
    { field: 'webhookStatus', name: 'Status' }
  ];
  
  let triggered = 0;
  for (const wh of webhooks) {
    const url = localStorage.getItem(wh.field);
    if (url) {
      try {
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          mode: 'no-cors',
          body: JSON.stringify({
            event: 'test',
            timestamp: new Date().toISOString(),
            webhookType: wh.name,
            deal: {
              id: currentDeal.id,
              businessName: currentDeal.businessName,
              score: currentDeal.score,
              message: 'This is a test webhook from GreatDane Underwriter'
            }
          })
        });
        triggered++;
      } catch (err) {
        console.error(`Test webhook error (${wh.name}):`, err);
      }
    }
  }
  
  if (triggered > 0) {
    showToast('Webhooks Tested', `${triggered} webhook(s) triggered successfully`);
  } else {
    showToast('No Webhooks', 'No webhook URLs configured', 'warning');
  }
}

function saveSettings() {
  const apiKey = document.getElementById('settingsApiKey').value;
  const model = document.getElementById('settingsModel').value;
  if (apiKey) localStorage.setItem('greatdane_api_key', apiKey);
  localStorage.setItem('greatdane_model', model);
}

// Auto-save settings on change
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('settingsApiKey')?.addEventListener('input', saveSettings);
  document.getElementById('settingsModel')?.addEventListener('change', saveSettings);
});

function exportDeals() {
  const data = { deals: allDeals, exportDate: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `greatdane-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importDeals(e) {
  const file = e.target?.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const data = JSON.parse(evt.target.result);
      if (data.deals?.length) {
        allDeals = [...data.deals, ...allDeals];
        saveDealsToStorage();
        renderDealList();
        alert(`Imported ${data.deals.length} deals successfully.`);
      }
    } catch (err) {
      alert('Failed to import: Invalid file format.');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function clearAllData() {
  if (confirm('Are you sure? This will delete ALL deals and cannot be undone.')) {
    allDeals = [];
    currentDeal = null;
    saveDealsToStorage();
    renderDealList();
    showDashboard();
    alert('All data cleared.');
  }
}

async function handleHeaderQuickScrub(e) {
  const files = e.target?.files;
  if (!files?.length) return;
  const apiKey = localStorage.getItem('greatdane_api_key');
  if (!apiKey) { alert('Enter your Gemini API key first (click Settings).'); return; }
  
  showLoadingOverlay();
  
  try {
    const extractedData = await processFilesWithGemini(files, apiKey);
    
    // Create new deal from extracted data
    const newDeal = {
      id: Date.now(),
      businessName: extractedData?.business?.name || extractedData.businessName || 'New Deal',
      dba: extractedData?.business?.dba || extractedData.dba || '',
      industry: extractedData?.business?.industry || extractedData.industry || '',
      tib: '',
      address: extractedData?.business?.address || extractedData.address || '',
      stateCode: extractedData?.business?.stateCode || '',
      entityType: extractedData?.business?.entityType || '',
      entityStatus: extractedData?.business?.status || '',
      formationDate: extractedData?.business?.formationDate || '',
      website: extractedData?.business?.website || '',
      phone: extractedData?.business?.phone || '',
      ownerName: extractedData?.owner?.name || extractedData.ownerName || '',
      ownerEmail: extractedData?.owner?.email || '',
      ownerPhone: extractedData?.owner?.phone || '',
      fico: 650,
      ownership: 100,
      score: 0,
      months: normalizeMonths(extractedData.months || []),
      bankData: extractedData,
      entityData: null,
      _fieldSource: {}
    };
    
    allDeals.unshift(newDeal);
    currentDeal = newDeal;
    saveDealsToStorage();
    renderDealList();
    showDetailView();
    populateDetailView();
    recalculateScore();
    updateOffer();
    
    // Also search entity data
    if (newDeal.businessName && newDeal.businessName !== 'New Deal') {
      searchAndFillEntity(newDeal.businessName, apiKey);
    }
    
  } catch (err) {
    console.error(err);
    alert('Error processing files: ' + err.message);
  } finally {
    hideLoadingOverlay();
    e.target.value = '';
  }
}

async function searchEntity() {
  const query = document.getElementById('entitySearchInput').value.trim();
  if (!query) { alert('Enter a business name to search.'); return; }
  const apiKey = getGeminiApiKey();
  if (!apiKey) { alert('Enter your Gemini API key first.'); return; }

  const modal = document.getElementById('entityModal');
  const body = document.getElementById('entityModalBody');
  const subtitle = document.getElementById('entityModalSubtitle');

  subtitle.textContent = `Searching: ${query}`;
  body.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="width: 40px; height: 40px; border: 3px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div><p style="color: var(--text-muted);">Searching with Gemini API...</p></div><style>@keyframes spin { to { transform: rotate(360deg); } }</style>';
  modal.classList.add('active');

  try {
    const model = getGeminiModel();
    const prompt = `You are an underwriting OSINT analyst.

INPUT_NAME: "${query}"

GOAL: Identify the correct U.S. business entity record for the INPUT_NAME.

STRICT RULES:
- Search using the EXACT PHRASE in quotes first: "${query}"
- Prefer authoritative sources: State Secretary of State / business registry pages.
- Secondary sources allowed: SEC EDGAR, OpenCorporates, official company website.
- Avoid low-quality directories. Do NOT guess a state without evidence.
- If ambiguous, return multiple candidates.

Return JSON ONLY with this schema:
{
  "input_name": "",
  "normalized_input": "",
  "candidates": [
    {
      "legal_name": "",
      "dba": "",
      "state": "",
      "stateCode": "XX",
      "entityType": "",
      "status": "",
      "formationDate": "",
      "registeredAgent": "",
      "address": "",
      "officers": [],
      "industry": "",
      "hq": "",
      "sources": [{"title":"","url":""}],
      "evidence": ["<=20 word snippet"],
      "confidence": 0
    }
  ],
  "notes": ""
}`;

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.1 }
      })
    });

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    if (!parsed) throw new Error('Failed to parse entity JSON');

    const ranked = rankEntityCandidates(query, parsed.candidates || []);
    const best = ranked[0];
    if (!best) throw new Error('No candidates found');

    const entity = {
      businessName: best.legal_name || query,
      dba: best.dba || '',
      state: best.state || '',
      stateCode: (best.stateCode || '').toUpperCase(),
      entityType: best.entityType || '',
      status: best.status || '',
      formationDate: best.formationDate || '',
      registeredAgent: best.registeredAgent || '',
      address: best.address || '',
      officers: best.officers || [],
      industry: best.industry || '',
      hq: best.hq || '',
      confidence: best.confidence || 0,
      sources: best.sources || [],
      summary: parsed.notes || ''
    };

    renderEntityResults(entity, query);

  } catch (err) {
    console.error(err);
    body.innerHTML = `<div style="padding: 20px; text-align: center;"><svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><p style="color: var(--tier-e); font-weight: 600;">Search Failed</p><p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p></div>`;
  }
}

function renderEntityResults(entity, query) {
  const body = document.getElementById('entityModalBody');
  const subtitle = document.getElementById('entityModalSubtitle');
  const statusColor = entity.status?.toLowerCase().includes('active') ? 'var(--tier-a)' : 'var(--tier-e)';
  const confColor = entity.confidence >= 80 ? 'var(--tier-a)' : entity.confidence >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
  
  subtitle.textContent = entity.businessName || query;
  
  body.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <div style="font-size: 2.5rem; font-weight: 800; color: var(--accent); line-height: 1;">${entity.stateCode || '--'}</div>
        <div>
          <div style="font-size: 1.1rem; font-weight: 600;">${entity.state || 'Unknown State'}</div>
          <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);">Primary Jurisdiction</div>
        </div>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 1.75rem; font-weight: 700; color: ${confColor};">${entity.confidence || 0}%</div>
        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);">Confidence</div>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Entity Type</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.entityType || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Status</div>
        <div style="font-size: 0.9rem; font-weight: 600; color: ${statusColor};">${entity.status || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Formation Date</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.formationDate || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Industry</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.industry || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Registered Agent</div>
        <div style="font-size: 0.9rem; font-weight: 600;">${entity.registeredAgent || '--'}</div>
      </div>
      <div style="background: var(--bg-secondary); padding: 14px; border-radius: 10px; border: 1px solid var(--border-secondary);">
        <div style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px;">Address</div>
        <div style="font-size: 0.85rem; font-weight: 500;">${entity.address || '--'}</div>
      </div>
    </div>
    
    ${entity.officers?.length ? `
    <div style="background: var(--bg-secondary); border: 1px solid var(--border-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
      <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); margin-bottom: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Officers / Members
      </div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${entity.officers.map(o => `<span style="background: var(--bg-tertiary); border: 1px solid var(--border-primary); padding: 6px 12px; border-radius: 6px; font-size: 0.8rem;">${o}</span>`).join('')}
      </div>
    </div>
    ` : ''}
    
    ${entity.summary ? `
    <div style="background: var(--bg-secondary); border: 1px solid var(--border-secondary); border-radius: 12px; padding: 16px;">
      <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); margin-bottom: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Summary
      </div>
      <div style="font-size: 0.85rem; line-height: 1.7; color: var(--text-secondary);">${entity.summary}</div>
    </div>
    ` : ''}
    
    <div style="margin-top: 20px; display: flex; gap: 12px;">
      <button class="btn-primary" style="flex: 1; justify-content: center;" onclick="applyEntityToDeal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><polyline points="20 6 9 17 4 12"/></svg>
        Apply to Current Deal
      </button>
      <button class="btn-secondary" style="flex: 1; justify-content: center;" onclick="closeEntityModal()">Close</button>
    </div>
  `;
  
  window.lastEntityResult = entity;
}

function applyEntityToDeal() {
  if (!currentDeal || !window.lastEntityResult) {
    alert('No deal selected or no entity data available.');
    return;
  }
  const e = window.lastEntityResult;
  currentDeal.entityData = e;

  // Apply and mark as manual (because user clicked Apply)
  const set = (field, value, elId) => {
    if (!value) return;
    currentDeal[field] = value;
    currentDeal._fieldSource = currentDeal._fieldSource || {};
    currentDeal._fieldSource[field] = 'manual';
    if (elId && document.getElementById(elId)) document.getElementById(elId).value = value;
  };

  set('businessName', e.businessName || e.legal_name, 'editLegalName');
  set('dba', e.dba, 'editDba');
  set('industry', e.industry, 'editIndustry');
  set('address', e.address, 'editAddress');
  set('stateCode', e.stateCode, 'editStateCode');
  set('entityType', e.entityType, 'editEntityType');
  set('entityStatus', e.status, 'editEntityStatus');
  set('formationDate', e.formationDate, 'editFormationDate');

  // Derive TIB if possible
  if (currentDeal.formationDate) {
    const years = Math.floor((Date.now() - new Date(currentDeal.formationDate).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
    currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
    if (document.getElementById('editTib')) document.getElementById('editTib').value = currentDeal.tib;
  }

  saveDealsToStorage();
  renderDealList();
  updateProfileCompletenessUI();
  renderEntityVerificationCard();
  closeEntityModal();
}

function saveDealsToStorage() { localStorage.setItem('greatdane_deals', JSON.stringify(allDeals)); }
function loadDealsFromStorage() {
  const s = localStorage.getItem('greatdane_deals');
  if (s) allDeals = JSON.parse(s);
  renderDealList();
}
function formatCurrency(v) { return '$' + (v || 0).toLocaleString(); }
function parseCurrency(s) { return parseFloat(String(s).replace(/[$,]/g, '')) || 0; }


function normalizeName(name) {
  return String(name || '')
    .toLowerCase()
    .replace(/&/g, ' and ')
    .replace(/[^a-z0-9\s]/g, ' ')
    .replace(/\b(incorporated|inc|llc|l\s*\.?l\s*\.?c\s*\.?|ltd|limited|corp|corporation|co|company|pllc|lp|llp|l\s*\.?p\s*\.?|l\s*\.?l\s*\.?p\s*\.?)\b/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function matchTier(inputName, candidateName) {
  const aRaw = String(inputName || '').trim().toLowerCase();
  const bRaw = String(candidateName || '').trim().toLowerCase();
  if (!aRaw || !bRaw) return 99;
  if (aRaw === bRaw) return 0; // exact
  const a = normalizeName(aRaw);
  const b = normalizeName(bRaw);
  if (a && b && a === b) return 1; // normalized exact
  if (a && b && (b.includes(a) || a.includes(b))) return 2; // partial
  // token overlap heuristic (cheap fuzzy)
  const ta = new Set(a.split(' ').filter(Boolean));
  const tb = new Set(b.split(' ').filter(Boolean));
  const inter = [...ta].filter(x => tb.has(x)).length;
  const union = new Set([...ta, ...tb]).size || 1;
  const j = inter / union;
  return j >= 0.6 ? 3 : 4;
}

function monthLabelFromKey(key) {
  const m = String(key || '').match(/^(\d{4})-(\d{2})$/);
  if (!m) return String(key || '');
  const y = parseInt(m[1], 10);
  const mo = parseInt(m[2], 10);
  const names = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return (names[mo-1] || 'Month') + ' ' + y;
}

function parseMonthKey(str) {
  if (!str) return '';
  const s = String(str).trim();
  // Accept already normalized YYYY-MM
  if (/^\d{4}-\d{2}$/.test(s)) return s;

  // Accept formats like "Jan 2024", "January 2024", "01/2024"
  const m1 = s.match(/^(\d{1,2})\/(\d{4})$/);
  if (m1) return `${m1[2]}-${String(m1[1]).padStart(2,'0')}`;

  const m2 = s.match(/^(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{4})$/i);
  if (m2) {
    const map = { jan:'01', feb:'02', mar:'03', apr:'04', may:'05', jun:'06', jul:'07', aug:'08', sep:'09', sept:'09', oct:'10', nov:'11', dec:'12' };
    return `${m2[2]}-${map[m2[1].toLowerCase()] || '01'}`;
  }

  // Accept "2024-01-31" -> "2024-01"
  const m3 = s.match(/^(\d{4})-(\d{2})-\d{2}$/);
  if (m3) return `${m3[1]}-${m3[2]}`;

  return '';
}

function normalizeMonths(months) {
  const list = Array.isArray(months) ? months : [];
  const out = [];
  const seen = new Set();

  for (const raw of list) {
    const m = { ...raw };
    const key = m.monthKey || parseMonthKey(m.monthLabel) || parseMonthKey(m.month);
    if (!key) continue;
    m.monthKey = key;
    m.monthLabel = m.monthLabel || monthLabelFromKey(key);
    m.month = m.monthLabel;

    // defaults
    m.revenue = Number(m.revenue || 0);
    m.deposits = Number(m.deposits || 0);
    m.withdrawals = Number(m.withdrawals || 0);
    m.endingBal = Number(m.endingBal || 0);
    m.avgDailyBal = Number(m.avgDailyBal || 0);
    m.depositCount = Number(m.depositCount || 0);
    m.overdraftFees = Number(m.overdraftFees || 0);
    m.nsfs = Number(m.nsfs || 0);
    m.negatives = Number(m.negatives || 0);

    if (!seen.has(key)) {
      seen.add(key);
      out.push(m);
    } else {
      // merge into existing: fill missing/zero fields only
      const ex = out.find(x => x.monthKey === key);
      const fields = ['revenue','deposits','withdrawals','endingBal','avgDailyBal','depositCount','overdraftFees','nsfs','negatives'];
      for (const f of fields) {
        const exVal = Number(ex[f] || 0);
        const inVal = Number(m[f] || 0);
        if ((exVal === 0 || Number.isNaN(exVal)) && inVal > 0) ex[f] = inVal;
      }
    }
  }

  out.sort((a, b) => (a.monthKey || '').localeCompare(b.monthKey || ''));
  return out;
}

function calcDealCompleteness(deal) {
  if (!deal) return { pct: 0, missing: [] };

  const missing = [];
  const must = [
    { k: 'businessName', label: 'Legal name' },
    { k: 'industry', label: 'Industry' },
    { k: 'address', label: 'Address' },
    { k: 'stateCode', label: 'Incorp. state' },
    { k: 'entityType', label: 'Entity type' },
    { k: 'formationDate', label: 'Formation date' },
    { k: 'ownerName', label: 'Owner name' },
    { k: 'fico', label: 'FICO' }
  ];
  for (const f of must) {
    const v = deal[f.k];
    if (v === undefined || v === null || String(v).trim() === '' || (f.k === 'fico' && !(parseInt(v,10) > 0))) missing.push(f.label);
  }
  const monthsOk = (deal.months?.length || 0) >= 3;
  if (!monthsOk) missing.push(' 3 months financials');

  const totalRequired = must.length + 1;
  const completed = totalRequired - missing.length;
  const pct = Math.max(0, Math.min(100, Math.round((completed / totalRequired) * 100)));
  return { pct, missing };
}

function updateProfileCompletenessUI() {
  if (!currentDeal) return;
  const { pct, missing } = calcDealCompleteness(currentDeal);
  const pctEl = document.getElementById('profileCompletionPct');
  const barEl = document.getElementById('profileCompletionBar');
  const listEl = document.getElementById('profileMissingList');
  if (!pctEl || !barEl || !listEl) return;

  pctEl.textContent = pct + '%';
  barEl.style.width = pct + '%';

  if (!missing.length) {
    listEl.innerHTML = '<div class="check-item"><strong>All required fields captured</strong><span class="tag" style="border-color: var(--tier-a); color: var(--tier-a);">Ready</span></div>';
  } else {
    listEl.innerHTML = missing.slice(0, 6).map(m => `<div class="check-item"><strong>${m}</strong><span class="tag">Missing</span></div>`).join('');
  }
}

function renderDealInsights() {
  if (!currentDeal) return;
  const kpi = document.getElementById('dealKpis');
  const canvas = document.getElementById('dealCashflowChart');

  if (!kpi || !canvas) return;

  const months = normalizeMonths(currentDeal.months || []);
  currentDeal.months = months;

  const dep = months.map(m => m.deposits || m.revenue || 0);
  const wdr = months.map(m => m.withdrawals || 0);
  const labels = months.map(m => m.monthLabel || m.month);

  const avgDep = dep.length ? dep.reduce((a,b) => a + b, 0) / dep.length : 0;
  const avgWdr = wdr.length ? wdr.reduce((a,b) => a + b, 0) / wdr.length : 0;
  const net = dep.reduce((a,b) => a + b, 0) - wdr.reduce((a,b) => a + b, 0);
  const totalNsfs = months.reduce((a,m) => a + (m.nsfs || 0), 0);
  const totalNeg = months.reduce((a,m) => a + (m.negatives || 0), 0);
  const totalOd = months.reduce((a,m) => a + (m.overdraftFees || 0), 0);

  const last = dep.length ? dep[dep.length-1] : 0;
  const prev = dep.length > 1 ? dep[dep.length-2] : 0;
  const mom = prev > 0 ? ((last - prev) / prev) * 100 : 0;

  kpi.innerHTML = `
    <div class="kpi-stat"><div class="kpi-label">Avg Deposits</div><div class="kpi-value text-positive">$${Math.round(avgDep).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">Avg Withdrawals</div><div class="kpi-value">$${Math.round(avgWdr).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">Net Cash Flow</div><div class="kpi-value ${net >= 0 ? 'text-positive' : 'text-negative'}">$${Math.round(net).toLocaleString()}</div></div>
    <div class="kpi-stat"><div class="kpi-label">MoM Deposits</div><div class="kpi-value ${mom >= 0 ? 'text-positive' : 'text-negative'}">${(isFinite(mom) ? mom : 0).toFixed(1)}%</div></div>
    <div class="kpi-stat"><div class="kpi-label">NSFs</div><div class="kpi-value ${totalNsfs > 0 ? 'text-negative' : ''}">${totalNsfs}</div></div>
    <div class="kpi-stat"><div class="kpi-label">OD Fees</div><div class="kpi-value ${totalOd > 0 ? 'text-warning' : ''}">$${Math.round(totalOd).toLocaleString()}</div></div>
  `;

  if (dealCashflowChart) dealCashflowChart.destroy();
  dealCashflowChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Deposits', data: dep, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.06)', fill: true, tension: 0.35 },
        { label: 'Withdrawals', data: wdr, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.06)', fill: true, tension: 0.35 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true, position: 'bottom', labels: { color: '#a1a1aa', font: { size: 11, family: 'DM Sans' } } } },
      scales: {
        y: { beginAtZero: true, grid: { color: '#27272a' }, ticks: { color: '#71717a' } },
        x: { grid: { display: false }, ticks: { color: '#71717a' } }
      }
    }
  });
}

function updateFormationDate(dateStr) {
  if (!currentDeal) return;
  currentDeal.formationDate = dateStr || '';
  currentDeal._fieldSource = currentDeal._fieldSource || {};
  currentDeal._fieldSource.formationDate = 'manual';
  // Auto-update TIB if possible
  if (dateStr) {
    const years = Math.floor((Date.now() - new Date(dateStr).getTime()) / (365.25 * 24 * 60 * 60 * 1000));
    currentDeal.tib = years > 0 ? `${years} years` : 'Less than 1 year';
    const tibEl = document.getElementById('editTib');
    if (tibEl) tibEl.value = currentDeal.tib;
  }
  saveDealsToStorage();
  updateProfileCompletenessUI();
}

function renderEntityVerificationCard() {
  const summaryEl = document.getElementById('entityVerifySummary');
  const summaryEl2 = document.getElementById('entityVerifySummary2');
  const sourcesEl = document.getElementById('entityVerifySources');
  const sourcesEl2 = document.getElementById('entityVerifySources2');
  if (!summaryEl) return;

  const e = currentDeal?.entityData;
  if (!e) {
    const msg = 'Run entity verification to enrich the profile.';
    summaryEl.textContent = msg;
    if (summaryEl2) summaryEl2.textContent = 'Enter business name to verify entity.';
    sourcesEl.innerHTML = '';
    if (sourcesEl2) sourcesEl2.innerHTML = '';
    return;
  }

  const conf = Math.round(e.confidence || 0);
  const confColor = conf >= 80 ? 'var(--tier-a)' : conf >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
  const html = `
    <div style="display:flex; justify-content: space-between; align-items: baseline; gap: 12px;">
      <div style="font-weight: 700; color: var(--text-primary);">${e.businessName || e.legal_name || currentDeal.businessName || 'Entity'}</div>
      <div style="font-weight: 800; color: ${confColor};">${conf}%</div>
    </div>
    <div style="margin-top: 6px; color: var(--text-secondary);">
      <span style="color: var(--accent);">${e.stateCode || currentDeal.stateCode || '--'}</span>  ${e.entityType || currentDeal.entityType || '--'}  ${e.status || currentDeal.entityStatus || '--'}
    </div>
    <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
      ${e.summary || e.notes || ''}
    </div>
  `;
  summaryEl.innerHTML = html;
  if (summaryEl2) summaryEl2.innerHTML = html;

  const sources = (e.sources || []).slice(0, 4);
  const sourcesHtml = sources.length
    ? sources.map(s => `<a href="${s.url}" target="_blank" rel="noopener noreferrer"> ${s.title || s.url}</a>`).join('<br>')
    : '';
  sourcesEl.innerHTML = sourcesHtml;
  if (sourcesEl2) sourcesEl2.innerHTML = sourcesHtml;
}

function renderBankSummaryCard() {
  const el = document.getElementById('bankSummaryBody');
  if (!el) return;
  const b = currentDeal?.bankData;
  if (!b) {
    el.textContent = 'No statements processed yet.';
    return;
  }

  const bankName = b.bank?.bankName || 'Bank';
  const acct = b.bank?.accountType ? `${b.bank.accountType}` : 'Account';
  const last4 = b.bank?.accountLast4 ? ` ${b.bank.accountLast4}` : '';
  const period = (b.statement?.startDate || b.statement?.endDate) ? `${b.statement.startDate || ''}  ${b.statement.endDate || ''}` : '';
  const conf = Math.round(b.confidence || 0);
  const confColor = conf >= 80 ? 'var(--tier-a)' : conf >= 60 ? 'var(--tier-c)' : 'var(--tier-e)';
  const warnings = Array.isArray(b.warnings) ? b.warnings : [];

  el.innerHTML = `
    <div style="display:flex; justify-content: space-between; align-items: baseline; gap: 12px;">
      <div style="font-weight: 700; color: var(--text-primary);">${bankName}</div>
      <div style="font-weight: 800; color: ${confColor};">${conf}%</div>
    </div>
    <div style="margin-top: 6px; color: var(--text-secondary);">
      ${acct} ${last4 ? ' ' + last4 : ''}<br>
      <span style="color: var(--text-muted); font-size: 0.8rem;">Statement period:</span> ${period}
    </div>
    ${warnings.length ? `<div style="margin-top: 10px; padding: 10px 12px; background: rgba(234,179,8,0.08); border: 1px solid rgba(234,179,8,0.2); border-radius: 10px; color: var(--text-secondary); font-size: 0.8rem;"><strong style="color: var(--tier-d);">Warnings:</strong><br>${warnings.slice(0,3).map(w => ` ${w}`).join('<br>')}</div>` : ''}
  `;
}

function renderDeepResearchCard() {
  const research = currentDeal?.deepResearch;
  
  // Update badge
  const badge = document.getElementById('badgeResearch');
  if (badge) {
    if (research?.risk?.rating) {
      badge.textContent = research.risk.rating;
      document.getElementById('tabResearch').classList.add('has-data');
      if (research.risk.rating === 'High') {
        document.getElementById('tabResearch').classList.add('has-warning');
      }
    } else {
      badge.textContent = '--';
    }
  }
  
  if (!research) {
    return;
  }
  
  // Risk Rating
  const riskRating = research.risk?.rating || 'Unknown';
  const riskColors = {
    'Low': { bg: 'rgba(34, 197, 94, 0.15)', border: 'rgba(34, 197, 94, 0.4)', text: 'var(--tier-a)' },
    'Medium': { bg: 'rgba(234, 179, 8, 0.15)', border: 'rgba(234, 179, 8, 0.4)', text: 'var(--tier-c)' },
    'High': { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.4)', text: 'var(--tier-e)' }
  };
  const riskStyle = riskColors[riskRating] || { bg: 'var(--bg-secondary)', border: 'var(--border-primary)', text: 'var(--text-muted)' };
  
  const banner = document.getElementById('researchRiskBanner');
  if (banner) {
    banner.style.background = riskStyle.bg;
    banner.style.border = `1px solid ${riskStyle.border}`;
  }
  
  const badgeEl = document.getElementById('researchRiskBadge');
  if (badgeEl) badgeEl.style.background = riskStyle.bg;
  
  const letterEl = document.getElementById('researchRiskLetter');
  if (letterEl) {
    letterEl.style.color = riskStyle.text;
    letterEl.textContent = riskRating[0] || '?';
  }
  
  const labelEl = document.getElementById('researchRiskLabel');
  if (labelEl) {
    labelEl.style.color = riskStyle.text;
    labelEl.textContent = riskRating;
  }
  
  const confEl = document.getElementById('researchConfidence');
  if (confEl) confEl.textContent = `Confidence: ${research.confidence || 0}%`;
  
  // Company Overview
  const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  setEl('researchLegalName', research.overview?.legal_name || 'N/A');
  setEl('researchDba', research.overview?.dba || 'N/A');
  setEl('researchEntityType', research.overview?.entity_type || 'N/A');
  setEl('researchState', research.overview?.state || 'N/A');
  setEl('researchFormation', research.overview?.formation_date || 'N/A');
  
  const statusEl = document.getElementById('researchStatus');
  const status = research.overview?.status || 'N/A';
  if (statusEl) {
    statusEl.textContent = status;
    statusEl.style.color = status.toLowerCase().includes('active') ? 'var(--tier-a)' : (status === 'N/A' ? '' : 'var(--tier-e)');
  }
  
  // Operations
  setEl('researchIndustry', research.operations?.industry || 'N/A');
  setEl('researchNaics', research.operations?.naics || 'N/A');
  setEl('researchDescription', research.operations?.description || '');
  
  // Financials
  setEl('researchRevenue', research.financials?.revenue_estimate || 'N/A');
  setEl('researchEmployees', research.financials?.employee_count || 'N/A');
  setEl('researchYears', research.financials?.years_in_business || 'N/A');
  setEl('researchTrend', research.financials?.growth_trend || 'N/A');
  
  // Red Flags
  const redFlags = research.risk?.red_flags || [];
  const redFlagsSection = document.getElementById('researchRedFlagsSection');
  if (redFlags.length > 0) {
    redFlagsSection.style.display = 'block';
    document.getElementById('researchRedFlagCount').textContent = redFlags.length;
    document.getElementById('researchRedFlagsList').innerHTML = redFlags.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('');
  } else {
    redFlagsSection.style.display = 'none';
  }
  
  // Compliance
  const lawsuits = research.compliance?.lawsuits?.length || 0;
  const liens = research.compliance?.liens?.length || 0;
  const ucc = research.compliance?.ucc_filings?.length || 0;
  
  const lawsuitsEl = document.getElementById('researchLawsuits');
  lawsuitsEl.textContent = `${lawsuits} Found`;
  lawsuitsEl.style.color = lawsuits > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const liensEl = document.getElementById('researchLiens');
  liensEl.textContent = `${liens} Found`;
  liensEl.style.color = liens > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  document.getElementById('researchUcc').textContent = `${ucc} Found`;
  
  // Reputation
  document.getElementById('researchBbb').textContent = research.reputation?.bbb_rating || 'N/A';
  const reviewScore = research.reputation?.review_score || 'N/A';
  const reviewCount = research.reputation?.review_count || 0;
  document.getElementById('researchReviews').textContent = reviewCount > 0 ? `${reviewScore} (${reviewCount} reviews)` : reviewScore;
  
  // Summary
  document.getElementById('researchSummary').textContent = research.summary || 'No summary available.';
  
  // Sources
  const sources = research.sources || [];
  document.getElementById('researchSourceCount').textContent = sources.length;
  document.getElementById('researchSourcesList').innerHTML = sources.slice(0, 5).map(s => 
    `<a href="${s.url}" target="_blank" style="color: var(--accent); text-decoration: none;">${s.title || 'Source'}</a>`
  ).join(' | ');
}

function switchIntelTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.intel-tab').forEach(tab => tab.classList.remove('active'));
  const activeTab = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  if (activeTab) activeTab.classList.add('active');
  
  // Update panels
  document.querySelectorAll('.intel-panel').forEach(panel => panel.classList.remove('active'));
  const activePanel = document.getElementById('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
  if (activePanel) activePanel.classList.add('active');
}

function updateIntelBadges() {
  // Business badge - show completion status
  const badgeBusiness = document.getElementById('badgeBusiness');
  if (badgeBusiness) {
    const fields = ['businessName', 'dba', 'industry', 'address', 'stateCode', 'entityType', 'ownerName', 'fico'];
    const filled = fields.filter(f => currentDeal?.[f]).length;
    const pct = Math.round((filled / fields.length) * 100);
    badgeBusiness.textContent = pct + '%';
    if (pct > 50) document.getElementById('tabBusiness')?.classList.add('has-data');
  }
  
  // Research badge
  const research = currentDeal?.deepResearch;
  const badgeResearch = document.getElementById('badgeResearch');
  if (badgeResearch) {
    if (research?.risk?.rating) {
      badgeResearch.textContent = research.risk.rating;
      document.getElementById('tabResearch')?.classList.add('has-data');
      if (research.risk.rating === 'High') {
        document.getElementById('tabResearch')?.classList.add('has-warning');
      }
    } else {
      badgeResearch.textContent = '--';
    }
  }
  
  // BACKGROUND badge
  const clearReport = currentDeal?.clearReport;
  const badgeClear = document.getElementById('badgeClear');
  if (badgeClear) {
    if (clearReport) {
      const totalRecords = (clearReport.ucc_filings?.length || 0) + 
                          (clearReport.liens?.length || 0) + 
                          (clearReport.judgments?.length || 0) +
                          (clearReport.court_records?.length || 0) +
                          (clearReport.bankruptcies?.length || 0);
      badgeClear.textContent = totalRecords + ' records';
      document.getElementById('tabClear')?.classList.add('has-data');
      if (totalRecords > 0) {
        document.getElementById('tabClear')?.classList.add('has-warning');
      }
    } else {
      badgeClear.textContent = '--';
    }
  }
  
  // Footprint badge
  const footprint = currentDeal?.footprintReport;
  const badgeFootprint = document.getElementById('badgeFootprint');
  if (badgeFootprint) {
    if (footprint) {
      const socialCount = footprint.social_media?.length || 0;
      badgeFootprint.textContent = socialCount + ' profiles';
      document.getElementById('tabFootprint')?.classList.add('has-data');
    } else {
      badgeFootprint.textContent = '--';
    }
  }
  
  // Debt badge
  const debt = currentDeal?.debtReport;
  const badgeDebt = document.getElementById('badgeDebt');
  if (badgeDebt) {
    if (debt) {
      const positions = debt.active_positions || 0;
      badgeDebt.textContent = positions + ' positions';
      document.getElementById('tabDebt')?.classList.add('has-data');
      if (positions > 0) {
        document.getElementById('tabDebt')?.classList.add('has-warning');
      }
    } else {
      badgeDebt.textContent = '--';
    }
  }
  
  // Credit badge
  const credit = currentDeal?.credit_report;
  const badgeCredit = document.getElementById('badgeCredit');
  if (badgeCredit) {
    if (credit?.scores) {
      const score = credit.scores.fico || credit.scores.vantage || credit.scores.experian || credit.scores.equifax || credit.scores.transunion;
      if (score) {
        badgeCredit.textContent = score;
        document.getElementById('tabCredit')?.classList.add('has-data');
        if (score < 600) {
          document.getElementById('tabCredit')?.classList.add('has-warning');
        }
      } else {
        badgeCredit.textContent = '--';
      }
    } else {
      badgeCredit.textContent = '--';
    }
  }
}

function openEntityForCurrentDeal() {
  if (!currentDeal?.entityData) { alert('No entity data yet. Click Refresh first.'); return; }
  renderEntityResults(currentDeal.entityData, currentDeal.businessName || '');
  document.getElementById('entityModal').classList.add('active');
}

function getGeminiApiKey() {
  return (localStorage.getItem('greatdane_api_key') || '').trim();
}

function getGeminiModel() {
  return (localStorage.getItem('greatdane_model') || 'gemini-2.5-flash').trim();
}

function safeJsonFromText(text) {
  const t = String(text || '');
  
  // Try to find JSON in different formats
  // 1. Try full JSON object match
  let m = t.match(/\{[\s\S]*\}/);
  if (!m) {
    // 2. Try after markdown code block
    const codeMatch = t.match(/```(?:json)?\s*([\s\S]*?)```/);
    if (codeMatch) {
      m = codeMatch[1].match(/\{[\s\S]*\}/);
    }
  }
  
  if (!m) return null;
  
  let raw = m[0]
    .replace(/```json/g, '')
    .replace(/```/g, '')
    .replace(/\u201c|\u201d/g, '"')
    .replace(/\u2018|\u2019/g, "'")
    .replace(/[\x00-\x1F\x7F]/g, ' ') // Remove control characters
    .trim();
  
  // Try multiple parse strategies
  try { 
    return JSON.parse(raw); 
  } catch (e1) {
    // Try fixing common issues
    try {
      // Fix trailing commas
      raw = raw.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
      return JSON.parse(raw);
    } catch (e2) {
      // Try stripping everything before first { and after last }
      try {
        const firstBrace = raw.indexOf('{');
        const lastBrace = raw.lastIndexOf('}');
        if (firstBrace >= 0 && lastBrace > firstBrace) {
          const cleaned = raw.substring(firstBrace, lastBrace + 1);
          return JSON.parse(cleaned);
        }
      } catch (e3) {
        console.warn('JSON parse attempts failed:', e3);
      }
    }
    return null;
  }
}

function rankEntityCandidates(inputName, candidates) {
  const input = String(inputName || '').trim();
  const list = Array.isArray(candidates) ? candidates : [];
  const ranked = list.map((c, idx) => {
    const name = c.legal_name || c.businessName || c.name || '';
    const tier = matchTier(input, name);
    const conf = Number(c.confidence || 0);
    const src = Array.isArray(c.sources) ? c.sources.length : 0;
    return { ...c, _idx: idx, _tier: tier, _conf: conf, _src: src, _name: name };
  }).sort((a, b) => (a._tier - b._tier) || (b._conf - a._conf) || (b._src - a._src));
  return ranked;
}

async function refreshEntityVerification() {
  const apiKey = getGeminiApiKey();
  if (!apiKey) { alert('Enter your Gemini API key first (Settings).'); return; }
  if (!currentDeal?.businessName) { alert('No business name set for this deal.'); return; }
  await searchAndFillEntity(currentDeal.businessName, apiKey);
}

// ============================================
// DEEP RESEARCH FUNCTIONS (Direct Gemini API)
// ============================================

async function runDeepResearch() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Researching: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Deep Research in Progress</p>
      <p style="color: var(--text-muted);">Using Gemini + Google Search to analyze business background, compliance, and risk factors...</p>
      <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 16px;">This may take 30-60 seconds</p>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
  `;
  modal.classList.add('active');
  
  try {
    const model = getGeminiModel();
    const prompt = buildDeepResearchPrompt(currentDeal.businessName);

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });

    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) throw new Error('Failed to parse research results');
    
    currentDeal.deepResearch = parsed;
    saveDealsToStorage();
    
    // Update main card on detail view
    renderDeepResearchCard();
    updateIntelBadges();
    
    // Close modal and show success
    closeDeepResearchModal();
    showToast('Deep Research Complete', parsed.risk?.rating ? `Risk: ${parsed.risk.rating}` : 'Data applied');
    
  } catch (err) {
    console.error('Deep research failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Research Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function renderDeepResearchResults(research) {
  const body = document.getElementById('deepResearchBody');
  
  const riskColor = {
    'Low': 'var(--tier-a)',
    'Medium': 'var(--tier-c)',
    'High': 'var(--tier-e)'
  }[research.risk?.rating] || 'var(--text-muted)';
  
  body.innerHTML = `
    <div style="display: grid; gap: 20px;">
      <!-- Risk Summary Banner -->
      <div style="background: linear-gradient(135deg, ${riskColor}22, ${riskColor}11); border: 1px solid ${riskColor}44; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px;">
        <div style="width: 60px; height: 60px; background: ${riskColor}33; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <span style="font-size: 1.5rem; font-weight: 800; color: ${riskColor};">${research.risk?.rating?.[0] || '?'}</span>
        </div>
        <div>
          <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em;">Risk Rating</div>
          <div style="font-size: 1.25rem; font-weight: 700; color: ${riskColor};">${research.risk?.rating || 'Unknown'}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">Confidence: ${research.confidence || 0}%</div>
        </div>
      </div>
      
      <!-- Overview -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Company Overview
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 0.85rem;">
          <div><span style="color: var(--text-muted);">Legal Name:</span> ${research.overview?.legal_name || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">DBA:</span> ${research.overview?.dba || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">Entity Type:</span> ${research.overview?.entity_type || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">State:</span> ${research.overview?.state || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">Formation:</span> ${research.overview?.formation_date || 'N/A'}</div>
          <div><span style="color: var(--text-muted);">Status:</span> <span style="color: ${research.overview?.status?.toLowerCase().includes('active') ? 'var(--tier-a)' : 'var(--tier-e)'};">${research.overview?.status || 'N/A'}</span></div>
        </div>
      </div>
      
      <!-- Operations & Financials -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            Operations
          </div>
          <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
            <div><span style="color: var(--text-muted);">Industry:</span> ${research.operations?.industry || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">NAICS:</span> ${research.operations?.naics || 'N/A'}</div>
            <div style="color: var(--text-secondary);">${research.operations?.description || ''}</div>
          </div>
        </div>
        <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            Financials
          </div>
          <div style="font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px;">
            <div><span style="color: var(--text-muted);">Revenue Est:</span> ${research.financials?.revenue_estimate || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">Employees:</span> ${research.financials?.employee_count || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">Years in Business:</span> ${research.financials?.years_in_business || 'N/A'}</div>
            <div><span style="color: var(--text-muted);">Trend:</span> ${research.financials?.growth_trend || 'N/A'}</div>
          </div>
        </div>
      </div>
      
      <!-- Red Flags -->
      ${research.risk?.red_flags?.length ? `
      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; color: var(--tier-e); display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Red Flags (${research.risk.red_flags.length})
        </div>
        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary);">
          ${research.risk.red_flags.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('')}
        </ul>
      </div>
      ` : ''}
      
      <!-- Compliance -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          Compliance & Legal
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 0.85rem;">
          <div>
            <div style="color: var(--text-muted); margin-bottom: 4px;">Lawsuits</div>
            <div style="color: ${research.compliance?.lawsuits?.length ? 'var(--tier-e)' : 'var(--tier-a)'}; font-weight: 600;">${research.compliance?.lawsuits?.length || 0} Found</div>
          </div>
          <div>
            <div style="color: var(--text-muted); margin-bottom: 4px;">Liens</div>
            <div style="color: ${research.compliance?.liens?.length ? 'var(--tier-e)' : 'var(--tier-a)'}; font-weight: 600;">${research.compliance?.liens?.length || 0} Found</div>
          </div>
          <div>
            <div style="color: var(--text-muted); margin-bottom: 4px;">UCC Filings</div>
            <div style="font-weight: 600;">${research.compliance?.ucc_filings?.length || 0} Found</div>
          </div>
        </div>
      </div>
      
      <!-- Reputation -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="width: 16px; height: 16px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Reputation
        </div>
        <div style="display: flex; gap: 24px; font-size: 0.85rem;">
          <div>
            <div style="color: var(--text-muted);">BBB Rating:</div>
            <div style="font-weight: 600; font-size: 1.1rem;">${research.reputation?.bbb_rating || 'N/A'}</div>
          </div>
          <div>
            <div style="color: var(--text-muted);">Reviews:</div>
            <div style="font-weight: 600;">${research.reputation?.review_score || 'N/A'} (${research.reputation?.review_count || 0} reviews)</div>
          </div>
        </div>
      </div>
      
      <!-- Summary -->
      <div style="background: var(--bg-secondary); border-radius: 12px; padding: 16px;">
        <div style="font-weight: 600; margin-bottom: 12px;">Summary</div>
        <p style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin: 0;">${research.summary || 'No summary available.'}</p>
      </div>
      
      <!-- Sources -->
      ${research.sources?.length ? `
      <div style="font-size: 0.8rem; color: var(--text-muted);">
        <div style="font-weight: 600; margin-bottom: 8px;">Sources (${research.sources.length})</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${research.sources.slice(0, 5).map(s => `<a href="${s.url}" target="_blank" style="color: var(--accent); text-decoration: none;">${s.title || 'Source'}</a>`).join(' | ')}
        </div>
      </div>
      ` : ''}
      
      <!-- Apply to Deal Button -->
      <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="applyResearchToDeal()">
        Apply Research to Deal
      </button>
    </div>
  `;
  
  // Store research for apply function
  window._lastDeepResearch = research;
}

function applyResearchToDeal() {
  const research = window._lastDeepResearch;
  if (!currentDeal || !research) return;
  
  // Update deal with research data
  if (research.overview?.legal_name) currentDeal.businessName = research.overview.legal_name;
  if (research.overview?.dba) currentDeal.dba = research.overview.dba;
  if (research.overview?.entity_type) currentDeal.entityType = research.overview.entity_type;
  if (research.overview?.state) currentDeal.stateCode = research.overview.state;
  if (research.overview?.formation_date) currentDeal.formationDate = research.overview.formation_date;
  if (research.overview?.status) currentDeal.entityStatus = research.overview.status;
  if (research.overview?.address) currentDeal.address = research.overview.address;
  if (research.operations?.industry) currentDeal.industry = research.operations.industry;
  
  // Store research data
  currentDeal.deepResearch = research;
  
  saveDealsToStorage();
  renderDealDetail();
  closeDeepResearchModal();
  
  alert('Research data applied to deal successfully!');
}

function closeDeepResearchModal() {
  document.getElementById('deepResearchModal').classList.remove('active');
}

// ===============================
// BACKGROUND CHECK
// ===============================
async function runClearReport() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Background Check: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Background Check in Progress</p>
      <p style="color: var(--text-muted);">Searching UCC filings, liens, judgments, court records, and bankruptcies...</p>
      <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 16px;">This may take 30-60 seconds</p>
    </div>
  `;
  modal.classList.add('active');
  
  const ownerName = currentDeal.ownerName || currentDeal.principalName || '';
  const prompt = buildClearReportPrompt(currentDeal.businessName, ownerName);
  
  try {
    const model = getGeminiModel();
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) throw new Error('Failed to parse background check results');
    
    currentDeal.clearReport = parsed;
    saveDealsToStorage();
    renderClearReportSection(parsed);
    closeDeepResearchModal();
    showToast('Background Check Complete', `Found ${(parsed.ucc_filings?.length || 0) + (parsed.liens?.length || 0)} records`);
    
  } catch (err) {
    console.error('Background check failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Background Check Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function buildClearReportPrompt(businessName, ownerName) {
  return `You are a public records investigator conducting a background check on a business.

BUSINESS: "${businessName}"
${ownerName ? `OWNER/PRINCIPAL: "${ownerName}"` : ''}
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.address ? `ADDRESS: ${currentDeal.address}` : ''}

Search for and compile information on:
1. UCC FILINGS - All secured transactions, creditors, collateral types, filing dates, status
2. LIENS - Federal/state tax liens, mechanics liens, judgment liens
3. JUDGMENTS - Civil judgments, amounts, plaintiffs, dates
4. COURT RECORDS - Lawsuits, case types, parties, status, outcomes
5. BANKRUPTCIES - Any bankruptcy filings for business or owner
6. OWNER BACKGROUND - Criminal records, other business associations, address history

IMPORTANT: You MUST respond with ONLY valid JSON. No explanatory text before or after. Start directly with { and end with }.

{
  "ucc_filings": [{"filing_number": "string", "creditor": "string", "collateral": "string", "filed_date": "string", "status": "Active/Terminated", "original_amount": "string"}],
  "liens": [{"type": "Federal Tax/State Tax/Mechanics/Other", "creditor": "string", "amount": "$X", "filed_date": "string", "status": "string"}],
  "judgments": [{"case_number": "string", "plaintiff": "string", "amount": "$X", "date": "string", "court": "string", "status": "string"}],
  "court_records": [{"case_number": "string", "case_type": "string", "parties": "string", "filed_date": "string", "status": "string", "outcome": "string"}],
  "bankruptcies": [{"case_number": "string", "chapter": "7/11/13", "filed_date": "string", "status": "string", "court": "string"}],
  "owner_background": {
    "criminal_records": ["string array or empty"],
    "other_businesses": ["string array of other business names"],
    "address_history": ["string array"],
    "notes": "string with any other relevant findings"
  },
  "summary": "Brief summary of findings",
  "risk_level": "Low/Medium/High"
}

If no records found for a category, return an empty array []. Return ONLY the JSON object.`;
}

function renderClearReportSection(report) {
  // Hide placeholder, show data section
  const content = document.getElementById('clearReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('clearReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // UCC Filings
  const uccList = report.ucc_filings || [];
  document.getElementById('clearUccCount').textContent = uccList.length;
  document.getElementById('clearUccCount').style.background = uccList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearUccCount').style.color = uccList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearUccList').innerHTML = uccList.length ? uccList.map(u => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${u.creditor || 'Unknown Creditor'}</span>
        <span style="font-size: 0.75rem; background: ${u.status?.toLowerCase().includes('active') ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)'}; color: ${u.status?.toLowerCase().includes('active') ? 'var(--tier-e)' : 'var(--tier-a)'}; padding: 2px 8px; border-radius: 4px;">${u.status || 'Unknown'}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        ${u.collateral ? `Collateral: ${u.collateral}` : ''} ${u.filed_date ? `| Filed: ${u.filed_date}` : ''} ${u.original_amount ? `| Amount: ${u.original_amount}` : ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No UCC filings found</div>';
  
  // Liens
  const liensList = report.liens || [];
  document.getElementById('clearLiensCount').textContent = liensList.length;
  document.getElementById('clearLiensCount').style.background = liensList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearLiensCount').style.color = liensList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearLiensList').innerHTML = liensList.length ? liensList.map(l => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${l.type || 'Lien'}: ${l.creditor || 'Unknown'}</span>
        <span style="font-weight: 600; color: var(--tier-e);">${l.amount || ''}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Filed: ${l.filed_date || 'N/A'} | Status: ${l.status || 'Unknown'}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No liens found</div>';
  
  // Judgments
  const judgmentsList = report.judgments || [];
  document.getElementById('clearJudgmentsCount').textContent = judgmentsList.length;
  document.getElementById('clearJudgmentsCount').style.background = judgmentsList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearJudgmentsCount').style.color = judgmentsList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearJudgmentsList').innerHTML = judgmentsList.length ? judgmentsList.map(j => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">${j.plaintiff || 'Unknown'} vs Business</span>
        <span style="font-weight: 600; color: var(--tier-e);">${j.amount || ''}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Case: ${j.case_number || 'N/A'} | ${j.court || ''} | ${j.date || ''} | ${j.status || ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No judgments found</div>';
  
  // Court Records
  const courtList = report.court_records || [];
  document.getElementById('clearCourtCount').textContent = courtList.length;
  document.getElementById('clearCourtList').innerHTML = courtList.length ? courtList.map(c => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="font-weight: 600;">${c.case_type || 'Case'}: ${c.case_number || ''}</div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Parties: ${c.parties || 'N/A'} | Filed: ${c.filed_date || 'N/A'} | Status: ${c.status || ''} ${c.outcome ? `| Outcome: ${c.outcome}` : ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No court records found</div>';
  
  // Bankruptcies
  const bankruptcyList = report.bankruptcies || [];
  document.getElementById('clearBankruptcyCount').textContent = bankruptcyList.length;
  document.getElementById('clearBankruptcyCount').style.background = bankruptcyList.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('clearBankruptcyCount').style.color = bankruptcyList.length > 0 ? 'var(--tier-e)' : '';
  document.getElementById('clearBankruptcyList').innerHTML = bankruptcyList.length ? bankruptcyList.map(b => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="font-weight: 600;">Chapter ${b.chapter || '?'} Bankruptcy</span>
        <span style="font-size: 0.75rem; background: ${b.status?.toLowerCase().includes('discharged') ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 2px 8px; border-radius: 4px;">${b.status || ''}</span>
      </div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        Case: ${b.case_number || 'N/A'} | Filed: ${b.filed_date || 'N/A'} | Court: ${b.court || ''}
      </div>
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No bankruptcies found</div>';
  
  // Owner Background
  const owner = report.owner_background || {};
  document.getElementById('clearOwnerBackground').innerHTML = `
    ${owner.criminal_records?.length ? `<div style="margin-bottom: 12px;"><strong style="color: var(--tier-e);">Criminal Records:</strong> ${owner.criminal_records.join(', ')}</div>` : ''}
    ${owner.other_businesses?.length ? `<div style="margin-bottom: 12px;"><strong>Other Businesses:</strong> ${owner.other_businesses.join(', ')}</div>` : ''}
    ${owner.address_history?.length ? `<div style="margin-bottom: 12px;"><strong>Address History:</strong> ${owner.address_history.join(' | ')}</div>` : ''}
    ${owner.notes ? `<div>${owner.notes}</div>` : ''}
    ${!owner.criminal_records?.length && !owner.other_businesses?.length && !owner.notes ? '<div style="color: var(--text-muted);">No significant findings</div>' : ''}
  `;
}

// ===============================
// FOOTPRINT REPORT
// ===============================
async function runFootprintReport() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Digital Footprint: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Scanning Digital Footprint</p>
      <p style="color: var(--text-muted);">Searching web presence, social media, reviews, and news mentions...</p>
      <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 16px;">This may take 30-60 seconds</p>
    </div>
  `;
  modal.classList.add('active');
  
  const prompt = buildFootprintPrompt(currentDeal.businessName);
  
  try {
    const model = getGeminiModel();
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) throw new Error('Failed to parse footprint results');
    
    currentDeal.footprintReport = parsed;
    saveDealsToStorage();
    renderFootprintReportSection(parsed);
    closeDeepResearchModal();
    showToast('Footprint Complete', `Found ${parsed.social_media?.length || 0} social profiles`);
    
  } catch (err) {
    console.error('Footprint report failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Footprint Report Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function buildFootprintPrompt(businessName) {
  return `You are a digital presence investigator.

BUSINESS: "${businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.industry ? `INDUSTRY: ${currentDeal.industry}` : ''}

Search and analyze:
1. WEB PRESENCE - Official website, domain age, SSL status, technology stack, SEO ranking
2. SOCIAL MEDIA - Facebook, Instagram, LinkedIn, Twitter/X, YouTube, TikTok presence
3. REVIEWS - Google reviews, Yelp, BBB, industry-specific platforms
4. NEWS & MENTIONS - Press releases, news articles, blog mentions, controversy

Return as JSON:
{
  "web_presence": {
    "website": "",
    "domain_age": "",
    "ssl_status": "",
    "has_ecommerce": false,
    "seo_visibility": "",
    "last_updated": "",
    "technology": []
  },
  "social_media": [
    {"platform": "Facebook", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "Instagram", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "LinkedIn", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "Twitter", "url": "", "followers": "", "last_active": "", "engagement": ""},
    {"platform": "YouTube", "url": "", "subscribers": "", "last_active": "", "videos": 0},
    {"platform": "TikTok", "url": "", "followers": "", "last_active": "", "engagement": ""}
  ],
  "reviews": {
    "google": {"rating": 0, "count": 0, "sentiment": ""},
    "yelp": {"rating": 0, "count": 0, "sentiment": ""},
    "bbb": {"rating": "", "accredited": false, "complaints": 0},
    "other": []
  },
  "news_mentions": [
    {"title": "", "source": "", "date": "", "sentiment": "", "url": ""}
  ],
  "digital_score": 0,
  "summary": ""
}`;
}

function renderFootprintReportSection(report) {
  // Hide placeholder, show data section
  const content = document.getElementById('footprintReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('footprintReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // Web Presence
  const web = report.web_presence || {};
  document.getElementById('footprintWeb').innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
      <div><span style="color: var(--text-muted);">Website:</span> ${web.website ? `<a href="${web.website}" target="_blank" style="color: var(--accent);">${web.website}</a>` : 'Not found'}</div>
      <div><span style="color: var(--text-muted);">Domain Age:</span> ${web.domain_age || 'N/A'}</div>
      <div><span style="color: var(--text-muted);">SSL:</span> <span style="color: ${web.ssl_status?.toLowerCase().includes('valid') ? 'var(--tier-a)' : 'var(--tier-e)'};">${web.ssl_status || 'N/A'}</span></div>
      <div><span style="color: var(--text-muted);">E-commerce:</span> ${web.has_ecommerce ? 'Yes' : 'No'}</div>
      <div><span style="color: var(--text-muted);">SEO Visibility:</span> ${web.seo_visibility || 'N/A'}</div>
      <div><span style="color: var(--text-muted);">Last Updated:</span> ${web.last_updated || 'N/A'}</div>
    </div>
    ${web.technology?.length ? `<div style="margin-top: 12px;"><span style="color: var(--text-muted);">Technology:</span> ${web.technology.join(', ')}</div>` : ''}
  `;
  
  // Social Media
  const socials = report.social_media || [];
  document.getElementById('footprintSocial').innerHTML = socials.filter(s => s.url || s.followers).map(s => `
    <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
      <div style="font-weight: 600; margin-bottom: 4px;">${s.platform}</div>
      ${s.url ? `<a href="${s.url}" target="_blank" style="font-size: 0.75rem; color: var(--accent); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">View Profile</a>` : ''}
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        ${s.followers || s.subscribers || 'N/A'} ${s.platform === 'YouTube' ? 'subscribers' : 'followers'}
      </div>
      <div style="font-size: 0.75rem; color: var(--text-muted);">
        ${s.last_active ? `Active: ${s.last_active}` : ''} ${s.engagement ? `| ${s.engagement}` : ''}
      </div>
    </div>
  `).join('') || '<div style="grid-column: 1/-1; color: var(--text-muted);">No social media profiles found</div>';
  
  // Reviews
  const reviews = report.reviews || {};
  document.getElementById('footprintReviews').innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 0.75rem; color: var(--text-muted);">Google</div>
        <div style="font-size: 1.25rem; font-weight: 700; color: ${(reviews.google?.rating || 0) >= 4 ? 'var(--tier-a)' : (reviews.google?.rating || 0) >= 3 ? 'var(--tier-c)' : 'var(--tier-e)'};">${reviews.google?.rating || 'N/A'}</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">${reviews.google?.count || 0} reviews</div>
      </div>
      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 0.75rem; color: var(--text-muted);">Yelp</div>
        <div style="font-size: 1.25rem; font-weight: 700; color: ${(reviews.yelp?.rating || 0) >= 4 ? 'var(--tier-a)' : (reviews.yelp?.rating || 0) >= 3 ? 'var(--tier-c)' : 'var(--tier-e)'};">${reviews.yelp?.rating || 'N/A'}</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">${reviews.yelp?.count || 0} reviews</div>
      </div>
      <div style="text-align: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-size: 0.75rem; color: var(--text-muted);">BBB</div>
        <div style="font-size: 1.25rem; font-weight: 700;">${reviews.bbb?.rating || 'N/A'}</div>
        <div style="font-size: 0.75rem; color: var(--text-muted);">${reviews.bbb?.accredited ? 'Accredited' : 'Not Accredited'}</div>
      </div>
    </div>
    ${reviews.google?.sentiment || reviews.yelp?.sentiment ? `
      <div style="margin-top: 12px; font-size: 0.85rem;">
        ${reviews.google?.sentiment ? `<div><strong>Google Sentiment:</strong> ${reviews.google.sentiment}</div>` : ''}
        ${reviews.yelp?.sentiment ? `<div><strong>Yelp Sentiment:</strong> ${reviews.yelp.sentiment}</div>` : ''}
      </div>
    ` : ''}
  `;
  
  // News & Mentions
  const news = report.news_mentions || [];
  document.getElementById('footprintNews').innerHTML = news.length ? news.map(n => `
    <div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
      <div style="font-weight: 600;">${n.title || 'News Article'}</div>
      <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
        ${n.source || ''} ${n.date ? `| ${n.date}` : ''} 
        ${n.sentiment ? `| <span style="color: ${n.sentiment.toLowerCase().includes('positive') ? 'var(--tier-a)' : n.sentiment.toLowerCase().includes('negative') ? 'var(--tier-e)' : 'var(--text-muted)'};">${n.sentiment}</span>` : ''}
      </div>
      ${n.url ? `<a href="${n.url}" target="_blank" style="font-size: 0.75rem; color: var(--accent);">Read More</a>` : ''}
    </div>
  `).join('') : '<div style="color: var(--text-muted);">No recent news mentions found</div>';
}

// ===============================
// DEBT REPORT
// ===============================
async function runDebtReport() {
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Debt Analysis: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Analyzing Debt Obligations</p>
      <p style="color: var(--text-muted);">Reviewing bank statements, UCC filings, and identifying debt patterns...</p>
      <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 16px;">This may take 30-60 seconds</p>
    </div>
  `;
  modal.classList.add('active');
  
  // Gather bank statement data
  const bankData = currentDeal.months || [];
  const prompt = buildDebtReportPrompt(currentDeal.businessName, bankData);
  
  try {
    const model = getGeminiModel();
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.2 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) throw new Error('Failed to parse debt analysis');
    
    currentDeal.debtReport = parsed;
    saveDealsToStorage();
    renderDebtReportSection(parsed);
    closeDeepResearchModal();
    showToast('Debt Analysis Complete', `Est. Total: ${parsed.total_debt || '$0'}`);
    
  } catch (err) {
    console.error('Debt report failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Debt Analysis Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function buildDebtReportPrompt(businessName, bankData) {
  const bankSummary = bankData.map(m => 
    `${m.monthLabel || m.month}: Revenue $${(m.revenue || 0).toLocaleString()}, Deposits $${(m.deposits || 0).toLocaleString()}, Withdrawals $${(m.withdrawals || 0).toLocaleString()}, Ending Balance $${(m.endingBal || 0).toLocaleString()}`
  ).join('\n');
  
  return `You are a debt analyst specializing in MCA and business lending.

BUSINESS: "${businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}

BANK STATEMENT DATA:
${bankSummary || 'No bank data available'}

${currentDeal?.clearReport ? `UCC FILINGS FOUND: ${JSON.stringify(currentDeal.clearReport.ucc_filings || [])}` : ''}

Analyze and identify:
1. EXISTING DEBT - MCA positions, term loans, lines of credit, equipment financing from UCC filings
2. PAYMENT PATTERNS - Regular outgoing payments that suggest debt service
3. LARGE TRANSACTIONS - Unusual large withdrawals or deposits that may indicate funding/payoffs
4. DEBT LOAD - Estimate total outstanding debt and monthly payment obligations
5. STACKING INDICATORS - Signs of multiple MCA positions or debt stacking

IMPORTANT: You MUST respond with ONLY valid JSON. No explanatory text before or after. Start directly with { and end with }.

{
  "total_debt": "$X estimated",
  "monthly_payments": "$X",
  "active_positions": 0,
  "debt_obligations": [
    {
      "type": "MCA/Term Loan/LOC/Equipment/Other",
      "creditor": "creditor name",
      "estimated_balance": "$X",
      "payment_amount": "$X",
      "payment_frequency": "daily/weekly/monthly",
      "filed_date": "date or N/A",
      "status": "Active/Paid Off/Unknown"
    }
  ],
  "large_transactions": [
    {
      "date": "date",
      "description": "description",
      "amount": "$X",
      "type": "Debit/Credit",
      "analysis": "Possible MCA funding/Loan payment/Unknown"
    }
  ],
  "stacking_indicators": ["string array of warning signs"],
  "debt_to_revenue_ratio": "X%",
  "risk_assessment": "Low/Medium/High",
  "summary": "Brief summary of debt situation"
}

If no debt found, return empty arrays. Return ONLY the JSON object.`;
}

function renderDebtReportSection(report) {
  // Hide placeholder, show data section
  const content = document.getElementById('debtReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('debtReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // Summary metrics
  document.getElementById('debtTotal').textContent = report.total_debt || '$0';
  document.getElementById('debtMonthly').textContent = report.monthly_payments || '$0';
  document.getElementById('debtPositions').textContent = report.active_positions || 0;
  
  // Color code based on positions
  const positions = report.active_positions || 0;
  document.getElementById('debtPositions').style.color = positions === 0 ? 'var(--tier-a)' : positions <= 2 ? 'var(--tier-c)' : 'var(--tier-e)';
  
  // Debt Table
  const debts = report.debt_obligations || [];
  document.getElementById('debtTableBody').innerHTML = debts.length ? debts.map(d => `
    <tr>
      <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: ${d.type?.includes('MCA') ? 'rgba(239, 68, 68, 0.2)' : 'rgba(234, 179, 8, 0.2)'};">${d.type || 'Unknown'}</span></td>
      <td>${d.creditor || 'Unknown'}</td>
      <td style="font-weight: 600;">${d.estimated_balance || 'N/A'}</td>
      <td>${d.payment_amount || 'N/A'}${d.payment_frequency ? ` (${d.payment_frequency})` : ''}</td>
      <td>${d.filed_date || 'N/A'}</td>
      <td><span style="color: ${d.status?.toLowerCase().includes('active') ? 'var(--tier-e)' : 'var(--tier-a)'};">${d.status || 'Unknown'}</span></td>
    </tr>
  `).join('') : '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">No debt obligations identified</td></tr>';
  
  // Large Transactions
  const transactions = report.large_transactions || [];
  document.getElementById('largeTransactionsBody').innerHTML = transactions.length ? transactions.map(t => `
    <tr>
      <td>${t.date || 'N/A'}</td>
      <td>${t.description || 'Unknown'}</td>
      <td style="font-weight: 600; color: ${t.type?.toLowerCase().includes('debit') ? 'var(--tier-e)' : 'var(--tier-a)'};">${t.type?.toLowerCase().includes('debit') ? '-' : '+'}${t.amount || ''}</td>
      <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; background: ${t.type?.toLowerCase().includes('debit') ? 'rgba(239, 68, 68, 0.15)' : 'rgba(34, 197, 94, 0.15)'};">${t.type || ''}</span></td>
      <td style="font-size: 0.8rem; color: var(--text-secondary);">${t.analysis || ''}</td>
    </tr>
  `).join('') : '<tr><td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">No large transactions identified</td></tr>';
}

// ===============================
// CUSTOM QUERY
// ===============================
async function runCustomQuery() {
  const queryInput = document.getElementById('customResearchQuery');
  const query = queryInput.value.trim();
  
  if (!query) {
    alert('Please enter a question or command.');
    return;
  }
  
  if (!currentDeal?.businessName) {
    alert('No business name set for this deal.');
    return;
  }
  
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    alert('Enter your Gemini API key first (Settings).');
    return;
  }
  
  const modal = document.getElementById('deepResearchModal');
  const body = document.getElementById('deepResearchBody');
  const subtitle = document.getElementById('deepResearchSubtitle');
  
  subtitle.textContent = `Custom Research: ${currentDeal.businessName}`;
  body.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="width: 60px; height: 60px; border: 4px solid var(--border-primary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Researching...</p>
      <p style="color: var(--text-muted);">"${query}"</p>
      <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 16px;">Searching the web for answers...</p>
    </div>
  `;
  modal.classList.add('active');
  
  const prompt = `You are a business intelligence researcher.

BUSINESS: "${currentDeal.businessName}"
${currentDeal?.stateCode ? `STATE: ${currentDeal.stateCode}` : ''}
${currentDeal?.industry ? `INDUSTRY: ${currentDeal.industry}` : ''}
${currentDeal?.address ? `ADDRESS: ${currentDeal.address}` : ''}

USER QUESTION/COMMAND: "${query}"

Search the web and provide a comprehensive answer to this question about the business. Be specific and cite sources.

Return as JSON:
{
  "question": "${query}",
  "answer": "",
  "key_findings": [],
  "sources": [{"title": "", "url": ""}],
  "confidence": 0
}`;
  
  try {
    const model = getGeminiModel();
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        tools: [{ google_search: {} }],
        generationConfig: { temperature: 0.3 }
      })
    });
    
    const data = await res.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const parsed = safeJsonFromText(text);
    
    if (!parsed) throw new Error('Failed to parse response');
    
    // Store in deal
    if (!currentDeal.customQueries) currentDeal.customQueries = [];
    currentDeal.customQueries.unshift(parsed);
    saveDealsToStorage();
    
    renderCustomQuerySection(parsed);
    closeDeepResearchModal();
    queryInput.value = '';
    showToast('Research Complete', `Confidence: ${parsed.confidence || 0}%`);
    
  } catch (err) {
    console.error('Custom query failed:', err);
    body.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--tier-e)" stroke-width="2" style="width: 48px; height: 48px; margin-bottom: 16px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <p style="color: var(--tier-e); font-weight: 600;">Query Failed</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">${err.message}</p>
      </div>
    `;
  }
}

function renderCustomQuerySection(result) {
  const section = document.getElementById('customQuerySection');
  section.style.display = 'block';
  
  document.getElementById('customQueryQuestion').textContent = `Q: ${result.question || ''}`;
  document.getElementById('customQueryAnswer').innerHTML = `
    <div style="margin-bottom: 12px;">${result.answer || 'No answer available.'}</div>
    ${result.key_findings?.length ? `
      <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.85rem;">Key Findings:</div>
        <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem;">
          ${result.key_findings.map(f => `<li style="margin-bottom: 4px;">${f}</li>`).join('')}
        </ul>
      </div>
    ` : ''}
  `;
  
  const sources = result.sources || [];
  document.getElementById('customQuerySources').innerHTML = sources.length ? 
    `<strong>Sources:</strong> ${sources.slice(0, 5).map(s => `<a href="${s.url}" target="_blank" style="color: var(--accent);">${s.title || 'Source'}</a>`).join(' | ')}` : '';
}

// ===============================
// CREDIT REPORT RENDER
// ===============================
function renderCreditReportSection(report) {
  if (!report || (!report.scores?.fico && !report.scores?.vantage && !report.scores?.experian && !report.scores?.equifax && !report.scores?.transunion && !report.tradelines?.length)) {
    document.getElementById('creditReportSection').style.display = 'none';
    return;
  }
  
  // Hide placeholder, show data section
  const content = document.getElementById('creditReportContent');
  if (content) content.style.display = 'none';
  
  const section = document.getElementById('creditReportSection');
  section.style.display = 'block';
  
  // Update badge
  updateIntelBadges();
  
  // Bureau and date
  document.getElementById('creditReportBureau').textContent = report.bureau ? `${report.bureau}${report.report_date ? ' - ' + report.report_date : ''}` : '';
  
  // Credit Scores with color coding
  function scoreColor(score) {
    if (!score || score === 0) return 'var(--text-muted)';
    if (score >= 740) return 'var(--tier-a)';
    if (score >= 670) return 'var(--tier-b)';
    if (score >= 580) return 'var(--tier-c)';
    if (score >= 500) return 'var(--tier-d)';
    return 'var(--tier-e)';
  }
  
  const scores = report.scores || {};
  ['fico', 'vantage', 'experian', 'equifax', 'transunion'].forEach(type => {
    const el = document.getElementById(`creditScore${type.charAt(0).toUpperCase() + type.slice(1)}`);
    const val = scores[type] || 0;
    const scoreEl = el.querySelector('.credit-score-value');
    scoreEl.textContent = val || '--';
    scoreEl.style.color = scoreColor(val);
  });
  
  // Account Summary
  const summary = report.summary || {};
  document.getElementById('creditTotalAccounts').textContent = summary.total_accounts || 0;
  document.getElementById('creditOpenAccounts').textContent = summary.open_accounts || 0;
  
  const delinquent = summary.delinquent_accounts || 0;
  document.getElementById('creditDelinquentAccounts').textContent = delinquent;
  document.getElementById('creditDelinquentAccounts').style.color = delinquent > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const derogatory = summary.derogatory_accounts || 0;
  document.getElementById('creditDerogatoryAccounts').textContent = derogatory;
  document.getElementById('creditDerogatoryAccounts').style.color = derogatory > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  document.getElementById('creditTotalBalance').textContent = formatCurrency(summary.total_balance || 0);
  document.getElementById('creditTotalLimit').textContent = formatCurrency(summary.total_credit_limit || 0);
  
  const utilization = summary.credit_utilization || 0;
  document.getElementById('creditUtilization').textContent = `${utilization}%`;
  document.getElementById('creditUtilization').style.color = utilization > 50 ? (utilization > 75 ? 'var(--tier-e)' : 'var(--tier-d)') : 'var(--tier-a)';
  
  document.getElementById('creditMonthlyPayment').textContent = formatCurrency(summary.total_monthly_payment || 0);
  
  // Payment History
  const payment = report.payment_history || {};
  const onTime = payment.on_time_percentage || 0;
  document.getElementById('creditOnTime').textContent = `${onTime}%`;
  document.getElementById('creditOnTime').style.color = onTime >= 95 ? 'var(--tier-a)' : onTime >= 80 ? 'var(--tier-c)' : 'var(--tier-e)';
  
  const late30 = payment.late_30_days || 0;
  document.getElementById('creditLate30').textContent = late30;
  document.getElementById('creditLate30').style.color = late30 > 0 ? 'var(--tier-d)' : 'var(--tier-a)';
  
  const late60 = payment.late_60_days || 0;
  document.getElementById('creditLate60').textContent = late60;
  document.getElementById('creditLate60').style.color = late60 > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const late90 = payment.late_90_days || 0;
  document.getElementById('creditLate90').textContent = late90;
  document.getElementById('creditLate90').style.color = late90 > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const collections = payment.collections || 0;
  document.getElementById('creditCollections').textContent = collections;
  document.getElementById('creditCollections').style.color = collections > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  const chargeOffs = payment.charge_offs || 0;
  document.getElementById('creditChargeOffs').textContent = chargeOffs;
  document.getElementById('creditChargeOffs').style.color = chargeOffs > 0 ? 'var(--tier-e)' : 'var(--tier-a)';
  
  // Public Records
  const publicRecords = report.public_records || {};
  const hasPublicRecords = (publicRecords.bankruptcies?.length || 0) + (publicRecords.judgments?.length || 0) + (publicRecords.liens?.length || 0) + (publicRecords.foreclosures?.length || 0) > 0;
  
  const publicSection = document.getElementById('creditPublicRecordsSection');
  if (hasPublicRecords) {
    publicSection.style.display = 'block';
    let publicHtml = '';
    if (publicRecords.bankruptcies?.length) {
      publicHtml += publicRecords.bankruptcies.map(b => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Bankruptcy:</strong> ${typeof b === 'string' ? b : `Chapter ${b.chapter || '?'} - ${b.status || ''} (${b.filed_date || ''})`}
        </div>
      `).join('');
    }
    if (publicRecords.judgments?.length) {
      publicHtml += publicRecords.judgments.map(j => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Judgment:</strong> ${typeof j === 'string' ? j : `${j.plaintiff || ''} - ${j.amount || ''} (${j.date || ''})`}
        </div>
      `).join('');
    }
    if (publicRecords.liens?.length) {
      publicHtml += publicRecords.liens.map(l => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Lien:</strong> ${typeof l === 'string' ? l : `${l.type || 'Tax'} - ${l.amount || ''} (${l.filed_date || ''})`}
        </div>
      `).join('');
    }
    if (publicRecords.foreclosures?.length) {
      publicHtml += publicRecords.foreclosures.map(f => `
        <div style="padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; margin-bottom: 8px;">
          <strong>Foreclosure:</strong> ${typeof f === 'string' ? f : `${f.status || ''} (${f.date || ''})`}
        </div>
      `).join('');
    }
    document.getElementById('creditPublicRecordsList').innerHTML = publicHtml;
  } else {
    publicSection.style.display = 'none';
  }
  
  // Inquiries
  const inquiries = report.inquiries || {};
  const inquiryCount = inquiries.hard_inquiries_24mo || 0;
  document.getElementById('creditInquiryCount').textContent = inquiryCount;
  document.getElementById('creditInquiryCount').style.background = inquiryCount > 5 ? 'rgba(239, 68, 68, 0.2)' : 'var(--bg-tertiary)';
  document.getElementById('creditInquiryCount').style.color = inquiryCount > 5 ? 'var(--tier-e)' : '';
  
  const recentInquiries = inquiries.recent_inquiries || [];
  document.getElementById('creditInquiriesList').innerHTML = recentInquiries.length ? 
    recentInquiries.map(i => `
      <div style="display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 6px; margin: 4px 4px 4px 0; font-size: 0.8rem;">
        ${typeof i === 'string' ? i : `${i.creditor || 'Unknown'} - ${i.date || ''}`}
      </div>
    `).join('') : '<div style="color: var(--text-muted);">No recent inquiries</div>';
  
  // Tradelines Table
  const tradelines = report.tradelines || [];
  document.getElementById('creditTradelineCount').textContent = tradelines.length;
  document.getElementById('creditTradelinesBody').innerHTML = tradelines.length ? tradelines.map(t => {
    const statusColor = t.payment_status?.toLowerCase().includes('current') ? 'var(--tier-a)' : 
                        t.payment_status?.toLowerCase().includes('30') ? 'var(--tier-d)' :
                        t.payment_status?.toLowerCase().includes('60') || t.payment_status?.toLowerCase().includes('90') ? 'var(--tier-e)' : 'var(--text-secondary)';
    return `
      <tr>
        <td style="font-weight: 500;">${t.creditor || 'Unknown'}</td>
        <td>${t.account_type || 'N/A'}</td>
        <td>${t.date_opened || 'N/A'}</td>
        <td>${t.credit_limit ? formatCurrency(t.credit_limit) : (t.high_balance ? formatCurrency(t.high_balance) : 'N/A')}</td>
        <td style="font-weight: 600;">${t.current_balance ? formatCurrency(t.current_balance) : '$0'}</td>
        <td>${t.monthly_payment ? formatCurrency(t.monthly_payment) : 'N/A'}</td>
        <td><span style="color: ${statusColor}; font-weight: 500;">${t.payment_status || 'N/A'}</span></td>
      </tr>
    `;
  }).join('') : '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">No tradelines available</td></tr>';
  
  // Collections Table
  const collectionAccounts = report.collections || [];
  const collectionsSection = document.getElementById('creditCollectionsSection');
  if (collectionAccounts.length > 0) {
    collectionsSection.style.display = 'block';
    document.getElementById('creditCollectionsCount').textContent = collectionAccounts.length;
    document.getElementById('creditCollectionsBody').innerHTML = collectionAccounts.map(c => `
      <tr>
        <td style="font-weight: 500;">${c.creditor || 'Unknown'}</td>
        <td>${c.original_creditor || 'N/A'}</td>
        <td style="font-weight: 600; color: var(--tier-e);">${c.balance ? formatCurrency(c.balance) : 'N/A'}</td>
        <td>${c.date_opened || 'N/A'}</td>
        <td>${c.status || 'N/A'}</td>
      </tr>
    `).join('');
  } else {
    collectionsSection.style.display = 'none';
  }
}

function formatCurrency(val) {
  if (typeof val === 'string' && val.includes('$')) return val;
  const num = parseFloat(val) || 0;
  return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

// Also render existing report sections on page load
function renderAllReportSections() {
  if (currentDeal?.clearReport) renderClearReportSection(currentDeal.clearReport);
  if (currentDeal?.footprintReport) renderFootprintReportSection(currentDeal.footprintReport);
  if (currentDeal?.debtReport) renderDebtReportSection(currentDeal.debtReport);
  if (currentDeal?.credit_report) renderCreditReportSection(currentDeal.credit_report);
  if (currentDeal?.customQueries?.length) renderCustomQuerySection(currentDeal.customQueries[0]);
  
  // Update all tab badges
  updateIntelBadges();
}


</script>
</body>
</html>
