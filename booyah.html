<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GREATDANE Underwriter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { background: #09090b; color: #f4f4f5; font-family: 'Inter', system-ui, sans-serif; }
        .card { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 16px; }
        
        .score-ring {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--score-color) calc(var(--pct) * 1%), #333 0);
            display: flex; align-items: center; justify-content: center;
            transition: background 1s ease-out;
        }
        .score-ring-inner { width: 60px; height: 60px; border-radius: 50%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; }
        
        input[type="range"] { -webkit-appearance: none; background: #333; height: 6px; border-radius: 3px; width: 100%; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; transition: transform 0.1s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        
        .edit-input {
            background: transparent;
            border: 1px solid transparent;
            color: inherit;
            font-weight: 600;
            width: 100%;
            padding: 0 8px;
            border-radius: 6px;
            transition: all 0.2s;
            line-height: 1.2;
        }
        .edit-input:hover { border-color: #333; background: #1f1f1f; }
        .edit-input:focus { outline: none; border-color: #3b82f6; background: #111; }
        
        .table-input {
            background: transparent;
            width: 100%;
            text-align: center;
            outline: none;
            color: inherit;
            border-bottom: 1px solid transparent;
            font-weight: 500;
            font-feature-settings: "tnum"; 
        }
        .table-input:focus { border-bottom-color: #3b82f6; }

        .offer-tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #71717a;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .offer-tab.active {
            background: #27272a;
            color: white;
            border-color: #3f3f46;
        }
        .offer-tab:hover:not(.active) {
            color: #e4e4e7;
            background: #1f1f1f;
        }

        .modal { opacity: 0; visibility: hidden; transition: all 0.2s ease-in-out; pointer-events: none; }
        .modal.open { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        .modal.open .modal-content { transform: scale(1); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); border-color: #444; }

        #scrub-overlay { backdrop-filter: blur(5px); }
        .animate-spin-slow { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* Shake animation for failed login */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.5s; }

        /* Custom checkbox for dark mode */
        .custom-checkbox {
            appearance: none;
            background-color: #1a1a1a;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.15em;
            height: 1.15em;
            border: 1px solid #333;
            border-radius: 0.15em;
            display: grid;
            place-content: center;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-[#050505] z-[100] flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="mb-6">
                    <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="Great Dane Logo" class="w-16 h-16 object-contain grayscale rounded-2xl mx-auto">
                </div>
                <h2 class="text-2xl font-bold text-white tracking-tight">GREAT<span class="text-gray-500">DANE</span></h2>
            </div>

            <div id="login-form" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-1.5 uppercase tracking-widest">Username</label>
                    <input type="text" id="login-user" class="w-full bg-[#0a0a0a] border border-[#333] rounded-lg px-3 py-2.5 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="admin@greatdane.com">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 mb-1.5 uppercase tracking-widest">Password</label>
                    <input type="password" id="login-pass" class="w-full bg-[#0a0a0a] border border-[#333] rounded-lg px-3 py-2.5 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="••••••••">
                </div>
                
                <div class="flex items-center pt-1">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="login-remember" class="custom-checkbox">
                        <span class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors select-none">Remember me</span>
                    </label>
                </div>

                <button onclick="handleLogin()" class="w-full bg-white text-black font-bold rounded-lg py-2.5 mt-4 hover:bg-gray-200 transition-colors text-sm">Sign In</button>
                
                <p id="login-error" class="text-red-500 text-xs text-center mt-4 hidden">Invalid credentials.</p>
            </div>
            
            <div class="mt-12 text-center opacity-30">
                <p class="text-[9px] text-gray-500 font-mono uppercase tracking-widest">Secure System Access Only</p>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="scrub-overlay" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center transition-opacity duration-300">
        <!-- Main Content Area -->
        <div class="w-full max-w-3xl p-8">
            <!-- Header Section -->
            <div class="flex items-center justify-between mb-8 border-b border-gray-800 pb-4">
                <div class="flex items-center gap-4">
                    <div class="relative w-10 h-10">
                        <div class="absolute inset-0 border-2 border-blue-500 rounded-full animate-ping opacity-25"></div>
                        <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="Great Dane Logo" class="w-10 h-10 object-contain grayscale rounded-xl">
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white tracking-tight">GREAT<span class="text-gray-500">DANE</span></h2>
                        <p class="text-xs text-blue-400 font-mono" id="scrub-timer">Initializing...</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 uppercase tracking-widest">Processing Phase</p>
                    <p class="text-lg font-bold text-white" id="phase-title">Initializing...</p>
                </div>
            </div>

            <!-- Visualization Stage -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 h-64">
                <div class="flex flex-col justify-center space-y-4">
                    <div class="h-1 w-12 bg-blue-500 rounded-full"></div>
                    <h3 class="text-xl font-bold text-white" id="slide-title">Loading...</h3>
                    <p class="text-gray-400 text-sm leading-relaxed" id="slide-desc">Please wait...</p>
                    <div class="flex gap-2" id="slide-tags"></div>
                </div>
                <div class="bg-[#111] border border-[#222] rounded-xl p-4 flex items-center justify-center relative overflow-hidden shadow-2xl">
                    <canvas id="loadingCanvas" class="w-full h-full relative z-10"></canvas>
                    <div id="loadingIconContainer" class="hidden absolute inset-0 flex items-center justify-center z-20"></div>
                    <div class="absolute inset-0 bg-[linear-gradient(rgba(30,30,30,0.5)_1px,transparent_1px),linear-gradient(90deg,rgba(30,30,30,0.5)_1px,transparent_1px)] bg-[size:20px_20px] opacity-20"></div>
                </div>
            </div>

            <div class="w-full h-1 bg-[#222] rounded-full overflow-hidden relative">
                <div id="loading-bar" class="h-full bg-gradient-to-r from-blue-600 to-purple-500 w-0 transition-all duration-100 ease-linear"></div>
            </div>
            <div class="flex justify-between mt-2">
                <p class="text-[10px] text-gray-600 font-mono">MODEL: GEMINI-3-PRO</p>
                <p class="text-[10px] text-gray-600 font-mono" id="percent-text">0% COMPLETE</p>
            </div>
        </div>
    </div>

    <!-- ENTITY VERIFICATION MODAL (SOS Search) -->
    <div id="sos-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="modal-content bg-[#1a1a1a] border border-[#333] w-full max-w-lg rounded-2xl shadow-2xl p-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-blue-500"></i> Entity Report
                    </h3>
                    <p class="text-sm text-gray-400 mt-1">SOS Business Records Search</p>
                </div>
                <button onclick="closeSOSModal()" class="text-gray-500 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div id="sos-loading" class="hidden text-center py-8">
                <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-sm text-gray-400">Searching Secretary of State records...</p>
            </div>

            <div id="sos-content" class="space-y-4">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- MONTH DETAIL MODAL -->
    <div id="month-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="modal-content bg-[#1a1a1a] border border-[#333] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Content populated by JS -->
             <div class="p-6 border-b border-[#333] flex justify-between items-center bg-[#222]">
                <div>
                    <h3 class="text-lg font-bold text-white" id="modal-title">Analysis</h3>
                    <p class="text-xs text-gray-400">Deep dive</p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-[#333] rounded-lg transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-[#111] p-4 rounded-xl border border-[#333]">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Balance Volatility</h4>
                        <div class="h-32"><canvas id="modalBalanceChart"></canvas></div>
                    </div>
                    <div class="bg-[#111] p-4 rounded-xl border border-[#333]">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Inflow vs Outflow</h4>
                        <div class="h-32"><canvas id="modalFlowChart"></canvas></div>
                    </div>
                </div>
                 <div class="grid grid-cols-3 gap-4 mb-6">
                     <div class="p-4 bg-[#111] rounded-xl border border-[#333] text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Avg Deposit Size</p>
                        <p class="text-xl font-bold text-green-400 mt-1" id="modal-avg-dep">$0</p>
                     </div>
                     <div class="p-4 bg-[#111] rounded-xl border border-[#333] text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Largest Withdrawal</p>
                        <p class="text-xl font-bold text-red-400 mt-1" id="modal-max-wd">$0</p>
                     </div>
                     <div class="p-4 bg-[#111] rounded-xl border border-[#333] text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Zero Balance Days</p>
                        <p class="text-xl font-bold text-yellow-500 mt-1" id="modal-zero-days">0</p>
                     </div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><i data-lucide="scan-search" class="w-3 h-3"></i> AI Detected Patterns</h4>
                    <ul class="space-y-2 text-sm" id="modal-patterns"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- METRIC DETAIL MODAL -->
    <div id="metric-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
        <div class="modal-content bg-[#1a1a1a] border border-[#333] w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-[#333] flex justify-between items-center bg-[#222]">
                <div>
                    <h3 class="text-lg font-bold text-white" id="metric-modal-title">Metric Analysis</h3>
                    <p class="text-xs text-gray-400" id="metric-modal-subtitle">Detailed breakdown</p>
                </div>
                <button onclick="closeMetricModal()" class="p-2 hover:bg-[#333] rounded-lg transition-colors"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto">
                <div class="bg-[#111] p-6 rounded-xl border border-[#333] mb-6">
                    <div class="h-64"><canvas id="metricModalChart"></canvas></div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><i data-lucide="info" class="w-3 h-3"></i> Key Drivers</h4>
                    <ul class="space-y-3" id="metric-insights"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- HEADER -->
    <header class="flex items-center justify-between px-4 sm:px-6 py-4 border-b border-[#2a2a2a] bg-[#111] sticky top-0 z-40">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="lg:hidden p-1 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <img src="https://cdn.brandfetch.io/idnEMoYR3R/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1757490773610" alt="Great Dane Logo" class="w-8 h-8 object-contain grayscale rounded-xl">
            <h1 class="text-xl font-semibold tracking-tight hidden sm:block">GREAT<span class="text-gray-500">DANE</span></h1>
        </div>
        
        <div class="flex items-center gap-2 sm:gap-4">
            <!-- SOS Search -->
             <div class="relative group hidden md:block">
                <input type="text" id="sos-search-input" placeholder="SOS Entity Search..." class="w-32 focus:w-64 transition-all duration-300 bg-[#1a1a1a] border border-[#333] rounded-lg pl-3 pr-8 py-1.5 text-xs focus:outline-none focus:border-blue-500 text-white placeholder-gray-600" onkeydown="if(event.key === 'Enter') triggerSOS()">
                <button onclick="triggerSOS()" class="absolute right-2 top-1.5 text-gray-500 hover:text-blue-500"><i data-lucide="search" class="w-3.5 h-3.5"></i></button>
            </div>

            <div class="relative group hidden sm:block">
                <input type="password" id="header-api-key" placeholder="API Key" class="w-20 focus:w-64 transition-all duration-300 bg-[#1a1a1a] border border-[#333] rounded-lg pl-2 pr-7 py-1.5 text-xs focus:outline-none focus:border-blue-500 text-white placeholder-gray-600" onchange="saveHeaderApiKey(this.value)">
                <i data-lucide="key" class="absolute right-2 top-2 w-3 h-3 text-gray-600 pointer-events-none"></i>
            </div>

            <button onclick="document.getElementById('file-upload').click()" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-[#1a1a1a] border border-[#333] text-gray-300 rounded-lg text-xs font-medium hover:bg-[#222] hover:border-gray-500 hover:text-white transition-all group">
                <i data-lucide="scan-line" class="w-4 h-4 text-gray-400 group-hover:text-white transition-colors"></i>
                <span class="hidden sm:inline">Quick Scrub</span>
            </button>
            <input type="file" id="file-upload" class="hidden" accept=".pdf,image/*" multiple onchange="handleQuickScrub(event)">
            <input type="file" id="rescrub-upload" class="hidden" accept=".pdf,image/*" multiple onchange="handleReScrub(event)">
            
            <div class="h-6 w-px bg-[#333] hidden sm:block"></div>
            
            <div class="flex items-center gap-2 text-sm text-gray-400">
                <span class="hidden sm:inline">Underwriter</span>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-[#111] border-r border-[#2a2a2a] flex flex-col transition-transform duration-300 -translate-x-full lg:translate-x-0 lg:static lg:flex shadow-2xl lg:shadow-none">
             <div class="lg:hidden flex items-center justify-between p-4 border-b border-[#2a2a2a]">
                <span class="font-bold text-white">Pipeline</span>
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 border-b border-[#2a2a2a]">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                    <input type="text" placeholder="Search pipeline..." class="w-full bg-[#1a1a1a] border border-[#333] rounded-lg pl-9 pr-3 py-2 text-sm text-white focus:outline-none focus:border-gray-500" onkeyup="renderApplicationList(this.value)">
                </div>
            </div>
            <div id="app-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
            <div class="p-4 border-t border-[#2a2a2a]">
                <div class="flex justify-between text-xs text-gray-500 uppercase font-bold mb-2">
                    <span>Funded MTD</span>
                    <span class="text-green-500">$1.2M</span>
                </div>
                <div class="h-1 bg-[#333] rounded-full overflow-hidden">
                    <div class="h-full bg-green-500 w-[70%]"></div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 relative w-full">
            <!-- STATUS TABS -->
            <div class="flex items-center gap-2 mb-8 overflow-x-auto pb-2 scrollbar-hide">
                <button onclick="filterByStatus('all')" class="flex items-center gap-2 px-5 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-white text-black shadow-lg transition-all" data-tab="all">All <span class="ml-1 bg-black text-white px-1.5 py-0.5 rounded-full text-[10px] font-bold" id="count-all">0</span></button>
                <button onclick="filterByStatus('pending')" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-[#1a1a1a] text-gray-400 hover:bg-[#222] border border-[#2a2a2a]" data-tab="pending"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> Pending <span id="count-pending" class="ml-1 text-gray-600">0</span></button>
                <button onclick="filterByStatus('approved')" class="flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-[#1a1a1a] text-gray-400 hover:bg-[#222] border border-[#2a2a2a]" data-tab="approved"><span class="w-2 h-2 rounded-full bg-green-500"></span> Approved <span id="count-approved" class="ml-1 text-gray-600">0</span></button>
            </div>

            <!-- DASHBOARD VIEW -->
            <div id="dashboard-view">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div onclick="openMetricModal('funded')" class="card p-5 metric-card cursor-pointer hover:border-blue-500/50 hover:bg-[#1f1f1f] group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="dollar-sign" class="w-16 h-16 text-blue-500"></i></div>
                        <div class="flex justify-between items-start mb-2"><span class="text-xs text-gray-500 uppercase font-bold group-hover:text-blue-400 transition-colors">Total Funded</span><i data-lucide="dollar-sign" class="w-4 h-4 text-blue-500"></i></div>
                        <div class="text-2xl font-bold text-white relative z-10">$485,000</div>
                    </div>
                    <div onclick="openMetricModal('approval')" class="card p-5 metric-card cursor-pointer hover:border-green-500/50 hover:bg-[#1f1f1f] group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="check-circle" class="w-16 h-16 text-green-500"></i></div>
                        <div class="flex justify-between items-start mb-2"><span class="text-xs text-gray-500 uppercase font-bold group-hover:text-green-400 transition-colors">Approval Rate</span><i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i></div>
                        <div class="text-2xl font-bold text-white relative z-10">72%</div>
                    </div>
                    <div onclick="openMetricModal('pipeline')" class="card p-5 metric-card cursor-pointer hover:border-yellow-500/50 hover:bg-[#1f1f1f] group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="bar-chart-2" class="w-16 h-16 text-yellow-500"></i></div>
                        <div class="flex justify-between items-start mb-2"><span class="text-xs text-gray-500 uppercase font-bold group-hover:text-yellow-400 transition-colors">Pipeline Value</span><i data-lucide="bar-chart-2" class="w-4 h-4 text-yellow-500"></i></div>
                        <div class="text-2xl font-bold text-white relative z-10" id="pipeline-val">$0</div>
                    </div>
                    <div onclick="openMetricModal('avg_deal')" class="card p-5 metric-card cursor-pointer hover:border-purple-500/50 hover:bg-[#1f1f1f] group relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="activity" class="w-16 h-16 text-purple-500"></i></div>
                        <div class="flex justify-between items-start mb-2"><span class="text-xs text-gray-500 uppercase font-bold group-hover:text-purple-400 transition-colors">Avg Deal Size</span><i data-lucide="activity" class="w-4 h-4 text-purple-500"></i></div>
                        <div class="text-2xl font-bold text-white relative z-10">$48,500</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="card p-6"><h3 class="text-sm font-medium text-gray-400 mb-6">Pipeline Status</h3><div class="h-64"><canvas id="statusChart"></canvas></div></div>
                    <div class="card p-6"><h3 class="text-sm font-medium text-gray-400 mb-6">Weekly Fundings</h3><div class="h-64"><canvas id="fundingChart"></canvas></div></div>
                </div>

                <!-- DROP ZONE -->
                <div id="drop-zone" class="border-2 border-dashed border-[#333] rounded-2xl p-8 text-center hover:border-blue-500 hover:bg-[#1a1a1a] transition-all cursor-pointer group"
                     onclick="document.getElementById('file-upload').click()">
                    <div class="flex flex-col items-center gap-4 pointer-events-none">
                        <div class="p-4 bg-[#222] rounded-full group-hover:bg-blue-500/20 transition-colors ring-1 ring-[#333] group-hover:ring-blue-500/50">
                            <i data-lucide="scan-text" class="w-8 h-8 text-gray-400 group-hover:text-blue-400 transition-colors"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-200">Quick Scrub Analysis</h3>
                            <p class="text-sm text-gray-500 mt-1">Drop PDF bank statements here or click to scan</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DETAIL VIEW -->
            <div id="detail-view" class="hidden space-y-6">
                <!-- Detail Header -->
                <div class="card p-6">
                    <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-6">
                        <!-- Left Side: Title & Badge -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center flex-wrap gap-3 mb-1">
                                <input id="detail-business" type="text" class="edit-input text-3xl font-bold text-white bg-transparent border-transparent hover:border-[#333] focus:border-blue-500 min-w-[200px]" value="Business Name">
                                <span id="detail-status-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-[#222] border border-[#333] text-gray-300">Pending</span>
                                <span id="detail-model-badge" class="hidden items-center px-3 py-1 rounded-full text-[10px] font-bold border font-mono uppercase tracking-widest"></span>
                            </div>
                            <p id="detail-id" class="text-sm text-gray-500 font-mono pl-2">ID: --</p>
                        </div>

                        <!-- Right Side: Action Buttons -->
                        <div class="flex items-center gap-3 shrink-0">
                             <button onclick="document.getElementById('rescrub-upload').click()" class="h-14 px-5 bg-[#222] border border-blue-500/30 text-blue-400 rounded-xl text-sm font-bold hover:bg-[#2a2a2a] transition flex items-center justify-center gap-2 whitespace-nowrap min-w-[160px] shadow-lg">
                                <i data-lucide="file-plus" class="w-5 h-5"></i>
                                <span>Re-Scrub Docs</span>
                            </button>
                            <button onclick="goBack()" class="h-14 px-8 bg-[#222] border border-[#333] text-gray-300 rounded-xl text-sm font-bold hover:bg-[#2a2a2a] transition whitespace-nowrap shadow-lg">
                                Back
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                    <!-- Left Column: Data & Verification -->
                    <div class="xl:col-span-4 space-y-6">
                        
                        <!-- Score Card -->
                        <div class="card p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="text-xs text-gray-500 uppercase font-bold tracking-wider">Perepus Score</h4>
                                    <p class="text-xs text-gray-600">Auto-Updates on Edit</p>
                                </div>
                                <div class="score-ring" id="detail-ring" style="--pct: 0; --score-color: #555;">
                                    <div class="score-ring-inner">
                                        <span id="detail-score" class="text-xl font-bold">--</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between items-end border-t border-[#333] pt-4">
                                <div><p class="text-xs text-gray-500">Grade</p><p id="detail-grade" class="text-lg font-bold text-white">--</p></div>
                                <div class="text-right"><p class="text-xs text-gray-500">Risk Class</p><p id="detail-risk" class="text-sm font-mono text-gray-300">--</p></div>
                            </div>
                        </div>

                        <!-- Business Info -->
                        <div class="card overflow-hidden">
                            <div class="p-4 border-b border-[#2a2a2a] bg-[#1f1f1f] flex justify-between items-center">
                                <h4 class="text-sm font-bold flex items-center gap-2"><i data-lucide="building-2" class="w-4 h-4 text-blue-400"></i> Business Profile</h4>
                                <span id="verify-entity-match" class="text-[10px] bg-green-900/30 text-green-400 px-2 py-0.5 rounded border border-green-900/50">Verified</span>
                            </div>
                            <div class="p-4 grid grid-cols-2 gap-y-4 gap-x-2 text-sm">
                                <div><p class="text-xs text-gray-500">Legal Name</p><input id="detail-legal-name" class="edit-input" value="--"></div>
                                <div><p class="text-xs text-gray-500">DBA</p><input id="detail-dba" class="edit-input" value="--"></div>
                                <div><p class="text-xs text-gray-500">Entity Type</p><input id="detail-entity" class="edit-input" value="--" onchange="recalculateApproval()"></div>
                                <div><p class="text-xs text-gray-500">EIN</p><input id="detail-ein" class="edit-input text-gray-300 font-mono" value="--"></div>
                                <div><p class="text-xs text-gray-500">State Inc.</p><input id="detail-state-inc" class="edit-input" value="--"></div>
                                <div><p class="text-xs text-gray-500">Date Started</p><input id="detail-start-date" type="date" class="edit-input" value="2020-01-01" onchange="recalculateApproval()"></div>
                                <div class="col-span-2"><p class="text-xs text-gray-500">Address</p><input id="detail-biz-address" class="edit-input" value="--"></div>
                            </div>
                        </div>

                        <!-- Owner Info -->
                        <div class="card overflow-hidden">
                            <div class="p-4 border-b border-[#2a2a2a] bg-[#1f1f1f] flex justify-between items-center">
                                <h4 class="text-sm font-bold flex items-center gap-2"><i data-lucide="user" class="w-4 h-4 text-purple-400"></i> Owner Profile</h4>
                                <span id="verify-owner-match" class="text-[10px] bg-green-900/30 text-green-400 px-2 py-0.5 rounded border border-green-900/50">Verified</span>
                            </div>
                            <div class="p-4 grid grid-cols-2 gap-y-4 gap-x-2 text-sm">
                                <div><p class="text-xs text-gray-500">Name</p><input id="detail-owner-name" class="edit-input" value="--"></div>
                                <div><p class="text-xs text-gray-500">FICO</p><input id="detail-fico" type="number" class="edit-input text-blue-400 font-bold" value="0" oninput="recalculateApproval()"></div>
                                <div><p class="text-xs text-gray-500">SSN</p><input id="detail-ssn" class="edit-input text-gray-400 font-mono" value="--"></div>
                                <div><p class="text-xs text-gray-500">Ownership %</p><input id="detail-ownership" type="number" class="edit-input" value="0" oninput="recalculateApproval()"></div>
                                <div class="col-span-2 border-t border-[#333] pt-3 mt-1">
                                    <div class="flex justify-between items-center"><span class="text-xs text-gray-500">Background Check</span><span class="text-xs font-bold text-green-400">CLEAR</span></div>
                                    <div class="grid grid-cols-3 gap-2 mt-2">
                                        <div class="text-center p-1.5 bg-[#111] rounded"><p class="text-[10px] text-gray-500">Liens</p><input id="detail-liens" type="number" class="edit-input text-center text-xs font-bold text-green-400" value="0" oninput="recalculateApproval()"></div>
                                        <div class="text-center p-1.5 bg-[#111] rounded"><p class="text-[10px] text-gray-500">Judgments</p><input id="detail-judgments" type="number" class="edit-input text-center text-xs font-bold text-green-400" value="0" oninput="recalculateApproval()"></div>
                                        <div class="text-center p-1.5 bg-[#111] rounded"><p class="text-[10px] text-gray-500">Bkcy</p><select id="detail-bkcy" class="bg-transparent text-xs font-bold text-green-400 text-center w-full focus:outline-none" onchange="recalculateApproval()"><option value="No">No</option><option value="Yes">Yes</option></select></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recommended Stips -->
                        <div class="card overflow-hidden">
                            <div class="p-4 border-b border-[#2a2a2a] bg-[#1f1f1f] flex justify-between items-center">
                                <h4 class="text-sm font-bold flex items-center gap-2"><i data-lucide="clipboard-list" class="w-4 h-4 text-yellow-400"></i> Recommended Stips</h4>
                            </div>
                            <div class="p-4"><ul id="detail-stips" class="space-y-2 text-sm text-gray-300"></ul></div>
                        </div>
                    </div>

                    <!-- Right Column: Financials & Calculator -->
                    <div class="xl:col-span-8 space-y-6">
                        
                        <!-- Financial Summary Cards (Editable) -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="card p-4 border-t-2 border-green-500">
                                <p class="text-xs text-gray-500 uppercase">Avg Revenue</p>
                                <input id="detail-fin-revenue" type="text" class="edit-input text-2xl font-bold mt-1 text-green-400" value="0" onchange="formatInput(this); updateTableAverages(); recalculateApproval();">
                            </div>
                            <div class="card p-4 border-t-2 border-blue-500">
                                <p class="text-xs text-gray-500 uppercase">Avg ADB</p>
                                <input id="detail-fin-adb" type="text" class="edit-input text-2xl font-bold mt-1 text-blue-400" value="0" onchange="formatInput(this); updateTableAverages(); recalculateApproval();">
                            </div>
                            <div class="card p-4 border-t-2 border-yellow-500">
                                <p class="text-xs text-gray-500 uppercase">Avg Deposits</p>
                                <input id="detail-fin-deposits" type="text" class="edit-input text-2xl font-bold mt-1 text-yellow-400" value="0" onchange="formatInput(this); updateTableAverages(); recalculateApproval();">
                            </div>
                            <div class="card p-4 border-t-2 border-red-500">
                                <p class="text-xs text-gray-500 uppercase">Neg Days</p>
                                <input id="detail-neg-days" type="number" class="edit-input text-2xl font-bold mt-1 text-red-400" value="0" onchange="updateTableAverages(); recalculateApproval();">
                            </div>
                        </div>

                        <!-- Bank Worksheet Grid -->
                        <div class="card overflow-hidden">
                            <div class="p-4 border-b border-[#2a2a2a] flex justify-between items-center bg-[#1f1f1f]">
                                <h4 class="text-sm font-bold flex items-center gap-2"><i data-lucide="table" class="w-4 h-4 text-gray-400"></i> Cash Flow Analysis <span class="text-xs font-normal text-gray-500 ml-2">(Click row for details)</span></h4>
                                <span class="text-xs text-gray-500" id="detail-period">--</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-gray-500 uppercase bg-[#1a1a1a]">
                                        <tr>
                                            <th class="px-4 py-3 font-medium text-left text-gray-400">Month</th>
                                            <th class="px-4 py-3 text-center font-medium text-emerald-400/80">Revenue</th>
                                            <th class="px-4 py-3 text-center font-medium text-gray-500"># Dep</th>
                                            <th class="px-4 py-3 text-center font-medium text-gray-400">Deposits</th>
                                            <th class="px-4 py-3 text-center font-medium text-red-400/70">W/D</th>
                                            <th class="px-4 py-3 text-center font-medium text-blue-400/70">ADB</th>
                                            <th class="px-4 py-3 text-center font-medium text-gray-400">End Bal</th>
                                            <th class="px-4 py-3 text-center font-medium text-gray-400">NSF</th>
                                            <th class="px-4 py-3 text-center font-medium text-gray-400">Neg</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ws-monthly-data" class="divide-y divide-[#2a2a2a]"></tbody>
                                    <tfoot class="bg-[#1a1a1a] font-bold border-t border-[#333]">
                                        <tr>
                                            <td class="px-4 py-3 text-left text-gray-500 font-mono text-xs uppercase tracking-wider">AVG / SUM</td>
                                            <td class="px-4 py-3 text-center text-emerald-400 text-lg" id="foot-revenue">$0</td>
                                            <td class="px-4 py-3 text-center text-gray-500" id="foot-num-dep">0</td>
                                            <td class="px-4 py-3 text-center text-gray-300" id="foot-deposits">0</td>
                                            <td class="px-4 py-3 text-center text-red-400" id="foot-withdrawals">$0</td>
                                            <td class="px-4 py-3 text-center text-blue-400" id="foot-adb">$0</td>
                                            <td class="px-4 py-3 text-center text-gray-300" id="foot-ending">$0</td>
                                            <td class="px-4 py-3 text-center text-red-400" id="foot-nsf">0</td>
                                            <td class="px-4 py-3 text-center text-red-400" id="foot-neg">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- Offer Calculator with Tabs -->
                        <div class="card p-6 bg-gradient-to-br from-[#1a1a1a] to-[#0f0f0f] border-green-900/30">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h4 class="text-lg font-bold text-green-400">Recommended Offer</h4>
                                    <p class="text-xs text-gray-500 mt-1">Adjusted by score & risk class</p>
                                </div>
                                <div class="flex gap-2 bg-[#222] p-1 rounded-lg">
                                    <button onclick="switchOfferTab('conservative')" id="tab-conservative" class="offer-tab">Conservative</button>
                                    <button onclick="switchOfferTab('moderate')" id="tab-moderate" class="offer-tab active">Moderate</button>
                                    <button onclick="switchOfferTab('aggressive')" id="tab-aggressive" class="offer-tab">Aggressive</button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-6">
                                    <div><div class="flex justify-between text-xs mb-2 text-gray-400"><span>Funding Amount</span><span id="calc-amt-val" class="text-white font-bold">$0</span></div><input id="slider-amt" type="range" min="5000" max="150000" step="1000" oninput="updateCalc()"></div>
                                    <div><div class="flex justify-between text-xs mb-2 text-gray-400"><span>Buy Rate</span><span id="calc-buy-val" class="text-white font-bold">0.00</span></div><input id="slider-buy" type="range" min="1.00" max="1.40" step="0.01" oninput="updateCalc()"></div>
                                    <div><div class="flex justify-between text-xs mb-2 text-gray-400"><span>Sell Rate</span><span id="calc-sell-val" class="text-white font-bold">0.00</span></div><input id="slider-sell" type="range" min="1.10" max="1.55" step="0.01" oninput="updateCalc()"></div>
                                    <div><div class="flex justify-between text-xs mb-2 text-gray-400"><span>Term</span><span id="calc-term-val" class="text-white font-bold">0 mo</span></div><input id="slider-term" type="range" min="3" max="18" step="1" oninput="updateCalc()"></div>
                                    <div><div class="flex justify-between text-xs mb-2 text-gray-400"><span>Origination Fee</span><span id="calc-orig-val" class="text-white font-bold">2.0%</span></div><input id="slider-origination" type="range" min="0" max="5" step="0.5" value="2.0" oninput="updateCalc()"></div>
                                </div>
                                <div class="bg-[#111] rounded-xl p-5 border border-[#2a2a2a] space-y-4">
                                    <div class="flex justify-between items-center border-b border-[#2a2a2a] pb-3"><span class="text-xs text-gray-500">Payback Amount</span><span id="calc-payback" class="text-lg font-bold text-white">$0</span></div>
                                    <div class="flex justify-between items-center border-b border-[#2a2a2a] pb-3"><span class="text-xs text-gray-500">Daily Payment</span><span id="calc-daily" class="text-xl font-bold text-green-400">$0.00</span></div>
                                    <div class="flex justify-between items-center border-b border-[#2a2a2a] pb-3"><span class="text-xs text-gray-500">Net Funding</span><span id="calc-net" class="text-lg font-bold text-white">$0</span></div>
                                    <div class="flex justify-between items-center"><span class="text-xs text-gray-500">Commission (Spread)</span><span id="calc-comm" class="text-sm text-yellow-500">$0</span></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        lucide.createIcons();

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Toggle translate class
            sidebar.classList.toggle('-translate-x-full');
            
            // Toggle overlay visibility
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // --- STATE & INIT ---
        let deals = [
            { id: 'MC-842', name: 'Apex Logistics', status: 'Pending', amount: 50000, date: '2023-10-25' },
            { id: 'MC-841', name: 'Main St Cafe', status: 'Approved', amount: 35000, date: '2023-10-24' },
            { id: 'MC-840', name: 'Tech Solutions', status: 'Funded', amount: 120000, date: '2023-10-23', fundedDate: new Date().toISOString() },
            { id: 'MC-839', name: 'Green Gardens', status: 'Funded', amount: 45000, date: '2023-10-22', fundedDate: new Date(Date.now() - 86400000).toISOString() }, 
            { id: 'MC-838', name: 'Blue Sky Retail', status: 'Pending', amount: 25000, date: '2023-10-26' },
            { id: 'MC-837', name: 'Urban Eatery', status: 'Funded', amount: 60000, date: '2023-10-20', fundedDate: new Date(Date.now() - 172800000).toISOString() },
            { id: 'MC-836', name: 'Elite Fitness', status: 'Approved', amount: 80000, date: '2023-10-26' }
        ];
        
        let currentScenarios = {
            conservative: { amt: 0, buy: 0, sell: 0, term: 0 },
            moderate: { amt: 0, buy: 0, sell: 0, term: 0 },
            aggressive: { amt: 0, buy: 0, sell: 0, term: 0 }
        };
        let currentTab = 'moderate';
        let aiAnalysisResults = null;
        let detailCharts = {};
        let dashboardCharts = {}; 
        let metricChart = null; 
        
        // --- NEW LOADING LOGIC ---
        let loadingInterval;
        let loadingChart = null;
        let totalDuration = 45000; // 45 seconds per request
        let startTime;

        const phases = [
            {
                title: "Data Ingestion & OCR",
                headline: "Extracting Financial Genome",
                text: "Perepus AI is scanning document pixels to convert unstructured bank PDF data into a structured time-series format. We are identifying recurring deposits, isolating distinct revenue streams, and flagging anomalies in transaction descriptions for normalization.",
                tags: ["OCR", "Parsing", "Normalization"],
                type: "icon",
                icon: "scan-search"
            },
            {
                title: "Cash Flow Velocity",
                headline: "Analyzing Revenue Trends",
                text: "We calculate the Average Daily Balance (ADB) volatility. The model looks for 'hockey stick' growth curves versus seasonal variances. A consistent ADB indicates a higher probability of repayment compared to erratic cash spikes.",
                tags: ["ADB", "Volatility", "Trend"],
                type: "chart",
                chartType: "line"
            },
            {
                title: "Risk Vector Triangulation",
                headline: "Assessing Negative Probabilities",
                text: "The system triangulates negative days and NSF occurrences against industry benchmarks. We apply a penalty weight for stacked negative days (consecutive) while crediting consistency in ending daily balances.",
                tags: ["NSF", "Risk", "Penalty"],
                type: "chart",
                chartType: "radar"
            },
            {
                title: "Entity Verification",
                headline: "Cross-Referencing Owners",
                text: "Verifying corporate standing and owner FICO resilience. The model integrates background check data (liens/judgments) directly into the risk tiering, ensuring the 'Willingness to Pay' metric aligns with the calculated 'Ability to Pay'.",
                tags: ["FICO", "Liens", "KYC"],
                type: "icon",
                icon: "shield-check"
            },
            {
                title: "Scoring Synthesis",
                headline: "Finalizing Perepus Score",
                text: "Synthesizing all 1,200 data points into a final composite score (0-100). This score dictates the recommended Buy Rate and Term, optimizing for both conversion probability and portfolio performance yield.",
                tags: ["Scoring", "Yield", "Decision"],
                type: "icon",
                icon: "award"
            }
        ];

        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) {
                document.getElementById('header-api-key').value = savedKey;
            }
            renderApplicationList();
            updateCounts();
            updateDashboardCharts(); 
            initDropZone();
        };

        function saveHeaderApiKey(key) {
            localStorage.setItem('gemini_api_key', key.trim());
        }

        // --- LOGIN LOGIC ---
        function handleLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const error = document.getElementById('login-error');
            const overlay = document.getElementById('login-overlay');
            const form = document.getElementById('login-form');

            if (pass.endsWith('!#')) {
                // Success
                overlay.style.transition = 'opacity 0.5s';
                overlay.style.opacity = '0';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 500);
            } else {
                // Fail
                error.classList.remove('hidden');
                form.classList.add('shake');
                setTimeout(() => form.classList.remove('shake'), 500);
            }
        }

        // --- HELPER: CURRENCY FORMATTING ---
        function formatNumber(num) {
            if (num === '' || num === undefined || num === null) return '';
            return Number(num).toLocaleString();
        }

        function parseNumber(str) {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        function formatInput(input) {
            const val = parseNumber(input.value);
            input.value = val === 0 && input.value === '' ? '' : val.toLocaleString();
        }

        // --- UI FUNCTIONS ---
        function initDropZone() {
            const zone = document.getElementById('drop-zone');
            if(!zone) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            zone.addEventListener('dragover', () => {
                zone.classList.add('border-blue-500', 'bg-[#1a1a1a]');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('border-blue-500', 'bg-[#1a1a1a]');
            });

            zone.addEventListener('drop', (e) => {
                zone.classList.remove('border-blue-500', 'bg-[#1a1a1a]');
                const files = e.dataTransfer.files;
                processFiles(files);
            });
        }

        function filterByStatus(status) {
            renderApplicationList(status === 'all' ? '' : status);
        }

        function renderApplicationList(query = '') {
            const list = document.getElementById('app-list');
            let filtered = deals;
            if (query && ['Pending', 'Approved'].includes(query)) {
                 filtered = deals.filter(d => d.status.toLowerCase() === query.toLowerCase());
            } else if (query) {
                 filtered = deals.filter(d => d.name.toLowerCase().includes(query.toLowerCase()));
            }
            
            const progressMap = {
                'Pending': { pct: 45, color: 'bg-yellow-500', stage: 'Underwriting' },
                'Approved': { pct: 80, color: 'bg-green-500', stage: 'Closing' },
                'Funded': { pct: 100, color: 'bg-blue-500', stage: 'Funded' },
                'Declined': { pct: 100, color: 'bg-red-500', stage: 'Declined' }
            };

            list.innerHTML = filtered.map(d => {
                const p = progressMap[d.status] || progressMap['Pending'];
                return `
                <div onclick="loadExistingDeal('${d.id}')" class="p-4 rounded-xl hover:bg-[#1f1f1f] cursor-pointer group transition-all border border-transparent hover:border-[#333] mb-2 bg-[#161616]">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-sm text-gray-200">${d.name}</span>
                        <span class="text-xs font-mono text-gray-400 font-bold">$${d.amount.toLocaleString()}</span>
                    </div>
                    
                    <div class="w-full bg-[#333] h-1.5 rounded-full overflow-hidden mb-2">
                        <div class="h-full ${p.color} transition-all duration-500" style="width: ${p.pct}%"></div>
                    </div>

                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 rounded-full ${p.color}"></span>
                            <span class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">${p.stage}</span>
                        </div>
                        <span class="text-[10px] text-gray-600 font-mono">${d.date}</span>
                    </div>
                </div>
            `}).join('');
            
            const total = deals.reduce((acc, d) => acc + d.amount, 0);
            document.getElementById('pipeline-val').textContent = `$${total.toLocaleString()}`; 
        }

        function updateCounts() {
            document.getElementById('count-all').textContent = deals.length;
            document.getElementById('count-pending').textContent = deals.filter(d => d.status === 'Pending').length;
            document.getElementById('count-approved').textContent = deals.filter(d => d.status === 'Approved').length;
        }

        // --- DASHBOARD CHARTS LOGIC ---
        function updateDashboardCharts() {
            // 1. Prepare Data for Status Chart
            const statusCounts = { Pending: 0, Approved: 0, Funded: 0 };
            deals.forEach(d => {
                if (statusCounts[d.status] !== undefined) statusCounts[d.status]++;
                else statusCounts['Pending']++; // Default fallback
            });

            // 2. Prepare Data for Funding Chart (Last 5 days)
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            const fundingData = Array(5).fill(0);
            const labels = [];
            
            // Generate labels for last 5 days (e.g., Mon, Tue...)
            for(let i=4; i>=0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                labels.push(days[d.getDay()]);
            }

            // Sum up funded amounts
            deals.filter(d => d.status === 'Funded' && d.fundedDate).forEach(d => {
                const fDate = new Date(d.fundedDate);
                const diffTime = Math.abs(today - fDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 5) {
                    // map diffDays (0 is today, 4 is 4 days ago) to array index (4 is today, 0 is 4 days ago)
                    fundingData[4 - diffDays] += (d.amount / 1000); // Store in K
                }
            });

            // 3. Render Status Chart
            const ctxStatus = document.getElementById('statusChart');
            if (dashboardCharts.status) dashboardCharts.status.destroy();

            dashboardCharts.status = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Approved', 'Funded'],
                    datasets: [{
                        data: [statusCounts.Pending, statusCounts.Approved, statusCounts.Funded],
                        backgroundColor: ['#eab308', '#22c55e', '#3b82f6'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#999', font: { family: 'Inter', weight: 500 } } },
                        tooltip: {
                            bodyFont: { family: 'Inter' },
                            titleFont: { family: 'Inter' },
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart._metasets[context.datasetIndex].total;
                                    const percentage = Math.round((value / total) * 100) + '%';
                                    return `${label}: ${value} (${percentage})`;
                                }
                            }
                        }
                    },
                    cutout: '70%',
                    onClick: (evt, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const status = dashboardCharts.status.data.labels[index];
                            filterByStatus(status.toLowerCase());
                        }
                    }
                }
            });

            // 4. Render Funding Chart
            const ctxFunding = document.getElementById('fundingChart');
            if (dashboardCharts.funding) dashboardCharts.funding.destroy();

            dashboardCharts.funding = new Chart(ctxFunding, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Funded (k)',
                        data: fundingData,
                        backgroundColor: '#3b82f6',
                        borderRadius: 6,
                        hoverBackgroundColor: '#60a5fa'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#666', font: { family: 'Inter' } } 
                        },
                        y: { 
                            display: false, 
                            suggestedMax: Math.max(...fundingData) * 1.2 
                        }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            bodyFont: { family: 'Inter' },
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw}k Funded`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- UI POPULATION ---
        function populateUI(data, model) {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');

            setValue('detail-business', data.business.legal_name);
            setText('detail-id', 'APP-' + Math.floor(Math.random()*100000));
            
            const badge = document.getElementById('detail-model-badge');
            badge.classList.remove('hidden');
            if (model === 'STORED') {
                badge.innerHTML = '<i data-lucide="database" class="w-3 h-3 inline mr-1"></i> EXISTING';
                badge.className = "px-3 py-1 rounded-full text-[10px] border border-gray-500/30 bg-gray-500/10 text-gray-400 font-bold tracking-wider flex items-center";
            } else if (model.includes('gemini-3')) {
                badge.innerHTML = '<i data-lucide="zap" class="w-3 h-3 inline mr-1"></i> GEMINI 3 PRO';
                badge.className = "px-3 py-1 rounded-full text-[10px] border border-purple-500/30 bg-purple-500/10 text-purple-400 font-bold tracking-wider flex items-center";
            } else if (model.includes('gemini-2.5-pro')) {
                 badge.innerHTML = '<i data-lucide="cpu" class="w-3 h-3 inline mr-1"></i> GEMINI 2.5 PRO';
                 badge.className = "px-3 py-1 rounded-full text-[10px] border border-blue-500/30 bg-blue-500/10 text-blue-400 font-bold tracking-wider flex items-center";
            } else {
                badge.innerHTML = '<i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1"></i> GEMINI FLASH';
                badge.className = "px-3 py-1 rounded-full text-[10px] border border-yellow-500/30 bg-yellow-500/10 text-yellow-400 font-bold tracking-wider flex items-center";
            }
            lucide.createIcons();

            setValue('detail-legal-name', data.business.legal_name);
            setValue('detail-dba', data.business.dba);
            setValue('detail-entity', data.business.entity_type);
            setValue('detail-ein', data.business.ein);
            setValue('detail-state-inc', data.business.state);
            setValue('detail-start-date', data.business.start_date || "2020-01-01");
            setValue('detail-biz-address', data.business.address);

            setValue('detail-owner-name', data.owner.name);
            setValue('detail-fico', data.owner.fico);
            setValue('detail-ssn', data.owner.ssn);
            setValue('detail-ownership', parseInt(data.owner.ownership) || 100);

            setValue('detail-liens', parseInt(data.background.liens) || 0);
            setValue('detail-judgments', parseInt(data.background.judgments) || 0);

            const avgs = calculateAverages(data.financials.monthly_data);
            setValue('detail-fin-revenue', avgs.revenue.toLocaleString());
            setValue('detail-fin-deposits', avgs.deposits.toLocaleString());
            setValue('detail-fin-adb', avgs.adb.toLocaleString());
            setValue('detail-neg-days', avgs.neg_days);
            setText('detail-period', data.financials.period);

            const tbody = document.getElementById('ws-monthly-data');
            tbody.innerHTML = data.financials.monthly_data.map((m, index) => `
                <tr class="hover:bg-[#222] cursor-pointer group transition-colors" onclick="openMonthDetail(${index})">
                    <td class="px-4 py-3 flex items-center gap-2 font-medium">
                        ${m.month}
                        <i data-lucide="bar-chart-2" class="w-3 h-3 text-gray-600 group-hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                    </td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="text" class="table-input text-emerald-400 font-bold" value="${formatNumber(m.revenue)}" onchange="formatInput(this); updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="text" class="table-input text-gray-500" value="${m.num_deposits || 0}" onchange="formatInput(this); updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="text" class="table-input text-gray-300" value="${formatNumber(m.deposits)}" onchange="formatInput(this); updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="text" class="table-input text-red-400/70" value="${formatNumber(m.withdrawals || 0)}" onchange="formatInput(this); updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="text" class="table-input text-blue-400 font-bold" value="${formatNumber(m.adb)}" onchange="formatInput(this); updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="text" class="table-input text-gray-300" value="${formatNumber(m.ending)}" onchange="formatInput(this); updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="number" class="table-input text-gray-400" value="${m.nsf}" onchange="updateTableAverages(); recalculateApproval();"></td>
                    <td class="px-4 py-3" onclick="event.stopPropagation()"><input type="number" class="table-input text-red-400 font-bold" value="${m.neg_days}" onchange="updateTableAverages(); recalculateApproval();"></td>
                </tr>
            `).join('');
            
            updateTableAverages();
            lucide.createIcons();
        }

        function updateTableAverages() {
            let totalRev = 0, totalDep = 0, totalAdb = 0, totalEnd = 0, totalNsf = 0, totalNeg = 0;
            let totalWd = 0, totalNumDep = 0;
            let count = 0;

            const rows = document.querySelectorAll('#ws-monthly-data tr');
            rows.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if(inputs.length > 0) {
                    totalRev += parseNumber(inputs[0].value);
                    totalNumDep += parseNumber(inputs[1].value);
                    totalDep += parseNumber(inputs[2].value);
                    totalWd += parseNumber(inputs[3].value);
                    totalAdb += parseNumber(inputs[4].value);
                    totalEnd += parseNumber(inputs[5].value);
                    totalNsf += parseNumber(inputs[6].value);
                    totalNeg += parseNumber(inputs[7].value);
                    count++;
                }
            });

            if (count > 0) {
                const avgRev = Math.round(totalRev / count);
                const avgDep = Math.round(totalDep / count);
                const avgAdb = Math.round(totalAdb / count);
                const avgEnd = Math.round(totalEnd / count);
                const avgWd = Math.round(totalWd / count);
                const avgNumDep = Math.round(totalNumDep / count);

                document.getElementById('foot-revenue').textContent = '$' + avgRev.toLocaleString();
                document.getElementById('foot-num-dep').textContent = avgNumDep;
                document.getElementById('foot-deposits').textContent = '$' + avgDep.toLocaleString();
                document.getElementById('foot-withdrawals').textContent = '$' + avgWd.toLocaleString();
                document.getElementById('foot-adb').textContent = '$' + avgAdb.toLocaleString();
                document.getElementById('foot-ending').textContent = '$' + avgEnd.toLocaleString();
                document.getElementById('foot-nsf').textContent = totalNsf;
                document.getElementById('foot-neg').textContent = totalNeg;

                // Sync Summary Cards
                setValue('detail-fin-revenue', avgRev.toLocaleString()); 
                setValue('detail-fin-deposits', avgDep.toLocaleString());
                setValue('detail-fin-adb', avgAdb.toLocaleString());
                setValue('detail-neg-days', totalNeg); 
                
                recalculateApproval();
            }
        }
        
        // --- RECALCULATION ENGINE ---
        function recalculateApproval() {
            // 1. Get values from inputs (using parseNumber for currency fields)
            const fico = parseInt(document.getElementById('detail-fico').value) || 600;
            const revenue = parseNumber(document.getElementById('detail-fin-revenue').value);
            const adb = parseNumber(document.getElementById('detail-fin-adb').value);
            const negDays = parseNumber(document.getElementById('detail-neg-days').value);
            
            const ownership = parseInt(document.getElementById('detail-ownership').value) || 0;
            const startDate = document.getElementById('detail-start-date').value;
            const liens = parseInt(document.getElementById('detail-liens').value) || 0;
            const judgments = parseInt(document.getElementById('detail-judgments').value) || 0;
            const bkcy = document.getElementById('detail-bkcy').value === 'Yes';
            const entityType = document.getElementById('detail-entity').value.toLowerCase();

            // Calculate TIB
            let tibYears = 0;
            if(startDate) {
                const start = new Date(startDate);
                const now = new Date();
                tibYears = (now - start) / (1000 * 60 * 60 * 24 * 365);
            }

            // 2. Run Perepus Scoring Logic
            let score = 50; // Base
            
            score += Math.min(20, Math.floor((revenue - 20000) / 5000));
            score += Math.min(20, Math.floor((fico - 600) / 10));
            score += Math.min(10, Math.floor(adb / 1000));
            score += Math.min(10, Math.floor(tibYears * 2));

            if(entityType.includes('llc') || entityType.includes('corp') || entityType.includes('inc')) score += 5;

            score -= (negDays * 5);
            score -= (liens * 10);
            score -= (judgments * 15);
            if(bkcy) score -= 30;
            if(ownership < 50) score -= 15;

            score = Math.max(0, Math.min(99, score));

            // 3. Determine Grade
            let grade = "D";
            if (score >= 80) grade = "A";
            else if (score >= 70) grade = "B";
            else if (score >= 60) grade = "C";

            // 4. Update UI Score
            setText('detail-score', score);
            setText('detail-grade', grade + " Paper");
            setText('detail-risk', "Risk Class " + (5 - Math.floor(score/25))); 
            
            const ring = document.getElementById('detail-ring');
            ring.style.setProperty('--pct', score);
            ring.style.setProperty('--score-color', score >= 70 ? '#10b981' : score >= 50 ? '#eab308' : '#ef4444');

            // 5. Update Stips & Scenarios
            updateStips(score, negDays, liens, judgments, ownership);
            generateScenarios(revenue, score);
        }

        function updateStips(score, negDays, liens, judgments, ownership) {
            const list = document.getElementById('detail-stips');
            let items = [
                `<li class="flex items-center gap-2"><i data-lucide="check-square" class="w-3 h-3 text-gray-500"></i> Driver's License</li>`,
                `<li class="flex items-center gap-2"><i data-lucide="check-square" class="w-3 h-3 text-gray-500"></i> Voided Check</li>`,
                `<li class="flex items-center gap-2"><i data-lucide="check-square" class="w-3 h-3 text-gray-500"></i> Signed Application</li>`
            ];

            if (score < 60 || negDays > 3) {
                items.push(`<li class="flex items-center gap-2 text-yellow-400"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Bank Login Required</li>`);
            }
            if (liens > 0 || judgments > 0) {
                items.push(`<li class="flex items-center gap-2 text-yellow-400"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Proof of Satisfaction</li>`);
            }
            if (ownership < 100) {
                 items.push(`<li class="flex items-center gap-2 text-yellow-400"><i data-lucide="users" class="w-3 h-3"></i> Verify all owners > 20%</li>`);
            }
             if (score >= 80) {
                items.push(`<li class="flex items-center gap-2 text-green-400"><i data-lucide="star" class="w-3 h-3"></i> No Interview Needed</li>`);
            }

            list.innerHTML = items.join('');
            lucide.createIcons();
        }

        function generateScenarios(revenue, score) {
            let baseFactor = score >= 80 ? 1.25 : score >= 60 ? 1.32 : 1.40;
            let baseTerm = score >= 80 ? 9 : score >= 60 ? 6 : 4;
            let baseFunding = Math.round(revenue * (score >= 80 ? 1.0 : 0.8));
            let buyRate = Math.max(1.10, baseFactor - 0.12);

            currentScenarios.conservative = {
                amt: Math.round(baseFunding * 0.8),
                buy: buyRate,
                sell: Number((baseFactor - 0.03).toFixed(2)),
                term: Math.max(3, baseTerm - 2)
            };

            currentScenarios.moderate = {
                amt: baseFunding,
                buy: buyRate,
                sell: baseFactor,
                term: baseTerm
            };

            currentScenarios.aggressive = {
                amt: Math.round(baseFunding * 1.2),
                buy: buyRate,
                sell: Number((baseFactor + 0.05).toFixed(2)),
                term: Math.min(18, baseTerm + 3)
            };

            switchOfferTab(currentTab);
        }

        function switchOfferTab(type) {
            currentTab = type;
            
            ['conservative', 'moderate', 'aggressive'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === type) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const s = currentScenarios[type];
            document.getElementById('slider-amt').value = s.amt;
            document.getElementById('slider-buy').value = s.buy;
            document.getElementById('slider-sell').value = s.sell;
            document.getElementById('slider-term').value = s.term;
            
            updateCalc();
        }

        // --- LOAD EXISTING DEAL ---
        function loadExistingDeal(id) {
            const deal = deals.find(d => d.id === id);
            if (!deal) return;

            // Generate realistic mock data based on the deal summary
            const baseRev = deal.amount * 1.2; 
            const mockMonths = [
                { month: "Jul", revenue: Math.round(baseRev * 0.9), deposits: Math.round(baseRev * 0.95), withdrawals: Math.round(baseRev * 0.85), adb: Math.round(baseRev * 0.1), ending: 5000, num_deposits: 12, neg_days: 0, nsf: 0 },
                { month: "Aug", revenue: Math.round(baseRev * 1.1), deposits: Math.round(baseRev * 1.05), withdrawals: Math.round(baseRev * 0.95), adb: Math.round(baseRev * 0.15), ending: 8000, num_deposits: 15, neg_days: 0, nsf: 0 },
                { month: "Sep", revenue: Math.round(baseRev * 1.0), deposits: Math.round(baseRev), withdrawals: Math.round(baseRev * 0.98), adb: Math.round(baseRev * 0.12), ending: 6000, num_deposits: 14, neg_days: 1, nsf: 0 },
                { month: "Oct", revenue: Math.round(baseRev * 1.2), deposits: Math.round(baseRev * 1.15), withdrawals: Math.round(baseRev * 0.9), adb: Math.round(baseRev * 0.2), ending: 12000, num_deposits: 18, neg_days: 0, nsf: 0 }
            ];

            const fullData = {
                business: {
                    legal_name: deal.name,
                    dba: deal.name,
                    entity_type: "LLC",
                    state: "NY",
                    start_date: "2018-05-12",
                    ein: "45-XXXXXXX",
                    address: "123 Business Rd, New York, NY 10001"
                },
                owner: {
                    name: "John Doe",
                    fico: deal.status === 'Approved' ? 720 : 640,
                    ssn: "XXX-XX-XXXX",
                    ownership: 100
                },
                background: {
                    liens: 0,
                    judgments: 0,
                    bankruptcy: "No records found"
                },
                financials: {
                    period: "Jul - Oct 2023",
                    monthly_data: mockMonths
                }
            };

            // Set global state so other functions work
            aiAnalysisResults = fullData;

            // Load UI
            populateUI(fullData, "STORED");
            
            // Trigger score recalc
            recalculateApproval();
        }

        // --- GEMINI CORE ---

        async function callGemini(payload, key) {
            const primary = "gemini-3-pro-preview"; // The best model per uploaded docs
            const fallback = "gemini-2.5-pro"; // The advanced thinking model as fallback
            
            async function tryModel(model) {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if(!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(txt);
                }
                return { json: await resp.json(), model: model };
            }

            try {
                console.log(`Trying ${primary}...`);
                return await tryModel(primary);
            } catch(e) {
                console.warn(`${primary} failed, falling back to ${fallback}`, e);
                return await tryModel(fallback);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // --- ADD DOCUMENTS / RE-SCRUB ---
        async function handleReScrub(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            e.target.value = '';

            const key = document.getElementById('header-api-key').value;
            if(!key) {
                document.getElementById('header-api-key').focus();
                alert("Please enter Gemini API Key");
                return;
            }

            startLoadingSequence();

             try {
                const inlineData = await Promise.all(files.map(async f => {
                    let mime = f.type;
                    if (f.name.toLowerCase().endsWith('.pdf')) mime = 'application/pdf';
                    else if (!mime) mime = 'image/png';
                    return { inlineData: { mimeType: mime, data: await fileToBase64(f) }};
                }));

                const currentDataJSON = JSON.stringify(aiAnalysisResults || {});

                const prompt = `
                    You are an expert underwriter. I am providing existing analysis data and NEW additional bank statements/documents.
                    Please MERGE the new information into the existing data.
                    1. If new months are provided, add them to the monthly_data array (sort chronologically).
                    2. If better owner/business info is found, update it.
                    3. Recalculate totals based on the combined dataset.
                    
                    Existing Data: ${currentDataJSON}
                    
                    Return updated JSON structure (same schema as before).
                `;

                const payload = {
                    contents: [{ parts: [{ text: prompt }, ...inlineData] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const result = await callGemini(payload, key);
                const text = result.json.candidates[0].content.parts[0].text;
                const cleanedText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(cleanedText);

                populateUI(data, result.model);
                recalculateApproval(); 
                stopLoadingSequence();

            } catch(err) {
                console.error(err);
                stopLoadingSequence();
                alert("Error during re-scrub: " + err.message);
            }
        }

        // --- QUICK SCRUB ---
        async function handleQuickScrub(e) {
            await processFiles(e.target.files);
            e.target.value = ''; 
        }

        async function processFiles(fileList) {
            const files = Array.from(fileList);
            if (!files.length) return;

            const key = document.getElementById('header-api-key').value;
            if(!key) {
                document.getElementById('header-api-key').focus();
                alert("Please enter Gemini API Key");
                return;
            }

            startLoadingSequence();

            try {
                const inlineData = await Promise.all(files.map(async f => {
                    let mime = f.type;
                    if (f.name.toLowerCase().endsWith('.pdf')) mime = 'application/pdf';
                    else if (!mime) mime = 'image/png';
                    return { inlineData: { mimeType: mime, data: await fileToBase64(f) }};
                }));

                const prompt = `
                    You are an expert underwriter. Extract ALL data from these bank statements.
                    Return JSON:
                    {
                        "business": { "legal_name": "", "dba": "", "address": "", "entity_type": "", "state": "", "start_date": "YYYY-MM-DD", "ein": "", "industry": "", "tib": "" },
                        "owner": { "name": "", "title": "", "ownership": "100", "fico": 700, "ssn": "", "dob": "", "email": "", "phone": "", "address": "" },
                        "financials": {
                            "bank_name": "", "account_type": "", "account_num": "",
                            "period": "Oct - Dec 2024",
                            "monthly_data": [
                                { "month": "Oct", "revenue": 0, "num_deposits": 0, "deposits": 0, "withdrawals": 0, "adb": 0, "ending": 0, "nsf": 0, "neg_days": 0 }
                            ]
                        },
                        "background": { "bankruptcy": "No records found", "liens": "0", "judgments": "0", "ucc": "None", "ofac": "Clear" },
                        "score": 0,
                        "grade": "B",
                        "risk_class": 2
                    }
                `;

                const payload = {
                    contents: [{ parts: [{ text: prompt }, ...inlineData] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const result = await callGemini(payload, key);
                const text = result.json.candidates[0].content.parts[0].text;
                const cleanedText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const data = JSON.parse(cleanedText);
                
                aiAnalysisResults = data;

                populateUI(data, result.model);
                
                // Add new deal with Today's date
                deals.unshift({ 
                    id: 'NEW-'+Math.floor(Math.random()*1000), 
                    name: data.business?.legal_name || 'New Application', 
                    status: 'Pending', 
                    amount: currentScenarios.moderate.amt,
                    date: new Date().toISOString().split('T')[0]
                });
                
                renderApplicationList();
                updateCounts();
                updateDashboardCharts(); // Refresh charts with new data
                recalculateApproval(); 

                stopLoadingSequence();

            } catch(err) {
                console.error(err);
                stopLoadingSequence();
                alert("Error during analysis: " + err.message);
            }
        }

        // --- LOADING ANIMATION LOGIC ---
        function startLoadingSequence() {
            const overlay = document.getElementById('scrub-overlay');
            const phaseTitle = document.getElementById('phase-title');
            const slideTitle = document.getElementById('slide-title');
            const slideDesc = document.getElementById('slide-desc');
            const slideTags = document.getElementById('slide-tags');
            const loadingBar = document.getElementById('loading-bar');
            const percentText = document.getElementById('percent-text');
            const timerText = document.getElementById('scrub-timer');
            const iconContainer = document.getElementById('loadingIconContainer');
            const canvas = document.getElementById('loadingCanvas');

            overlay.classList.remove('hidden');
            startTime = Date.now();
            let currentPhaseIndex = -1;

            // Update Loop (runs often for smooth progress bar)
            loadingInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / totalDuration, 1);
                
                // Update Progress Bar
                loadingBar.style.width = `${progress * 100}%`;
                percentText.textContent = `${Math.floor(progress * 100)}% COMPLETE`;
                
                // Countdown Timer Logic
                const remaining = Math.max(0, Math.ceil((totalDuration - elapsed)/1000));
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                timerText.textContent = `Est. Remaining: ${mins}:${secs.toString().padStart(2, '0')}`;

                // Determine Phase based on time
                const phaseDuration = totalDuration / phases.length;
                const phaseIndex = Math.floor(elapsed / phaseDuration);

                if (phaseIndex !== currentPhaseIndex && phaseIndex < phases.length) {
                    currentPhaseIndex = phaseIndex;
                    const phase = phases[phaseIndex];
                    
                    // Update Text Content with Fade Effect
                    phaseTitle.style.opacity = 0;
                    slideTitle.style.opacity = 0;
                    slideDesc.style.opacity = 0;
                    
                    setTimeout(() => {
                        phaseTitle.textContent = phase.title;
                        slideTitle.textContent = phase.headline;
                        slideDesc.textContent = phase.text;
                        
                        // Update Tags
                        slideTags.innerHTML = phase.tags.map(t => 
                            `<span class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs font-mono border border-blue-500/30">${t}</span>`
                        ).join('');

                        phaseTitle.style.opacity = 1;
                        slideTitle.style.opacity = 1;
                        slideDesc.style.opacity = 1;
                    }, 200);

                    // Update Visuals
                    if (loadingChart) {
                        loadingChart.destroy();
                        loadingChart = null;
                    }

                    if (phase.type === 'icon') {
                        canvas.classList.add('hidden');
                        iconContainer.classList.remove('hidden');
                        // Use Lucide icons dynamically
                        iconContainer.innerHTML = `<i data-lucide="${phase.icon}" class="w-24 h-24 text-blue-500 animate-pulse"></i>`;
                        lucide.createIcons();
                    } else {
                        iconContainer.classList.add('hidden');
                        canvas.classList.remove('hidden');
                        renderLoadingChart(phase.chartType);
                    }
                }

            }, 100);
        }

        function renderLoadingChart(type) {
            const ctx = document.getElementById('loadingCanvas');
            
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 2000, easing: 'easeOutQuart' },
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } }
            };

            if (type === 'line') {
                // Simulate Revenue Growth
                loadingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [1,2,3,4,5,6,7,8],
                        datasets: [{
                            data: [10, 15, 12, 20, 25, 22, 30, 45],
                            borderColor: '#3b82f6',
                            borderWidth: 3,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: commonOptions
                });
            } else if (type === 'radar') {
                // Simulate Risk Analysis
                loadingChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['NSF', 'Neg Days', 'Vol', 'Slope', 'FICO'],
                        datasets: [{
                            data: [80, 90, 60, 85, 70],
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.2)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            r: {
                                grid: { color: '#333' },
                                ticks: { display: false },
                                pointLabels: { color: '#666', font: { size: 10 } }
                            }
                        }
                    }
                });
            }
        }

        function stopLoadingSequence() {
            clearInterval(loadingInterval);
            const overlay = document.getElementById('scrub-overlay');
            const loadingBar = document.getElementById('loading-bar');
            const percentText = document.getElementById('percent-text');
            
            // Fast forward to 100% visually
            loadingBar.style.width = '100%';
            percentText.textContent = "100% COMPLETE";
            
            if(loadingChart) loadingChart.destroy();

            setTimeout(() => {
                overlay.classList.add('hidden');
                // Reset for next time
                loadingBar.style.width = '0%';
            }, 800);
        }

        function goBack() {
            document.getElementById('detail-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if(el) el.textContent = val;
        }

        function setValue(id, val) {
            const el = document.getElementById(id);
            if(el) el.value = val;
        }

        // --- METRIC MODAL LOGIC ---
        function openMetricModal(type) {
            const modal = document.getElementById('metric-modal');
            const titleEl = document.getElementById('metric-modal-title');
            const subtitleEl = document.getElementById('metric-modal-subtitle');
            const listEl = document.getElementById('metric-insights');
            const ctx = document.getElementById('metricModalChart');

            modal.classList.add('open');
            if (metricChart) metricChart.destroy();

            // Common Chart Options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#666', font: { family: 'Inter' } } },
                    y: { grid: { color: '#333' }, ticks: { color: '#666', font: { family: 'Inter' } } }
                }
            };

            let chartData, chartType, options = commonOptions;

            if (type === 'funded') {
                titleEl.textContent = "Total Funded Analysis";
                subtitleEl.textContent = "Trend over the last 6 months";
                
                // Mock trend data
                const labels = ['May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
                const data = [120, 150, 180, 140, 210, 485]; // in K
                
                chartType = 'line';
                chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Funded Volume ($K)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                };

                listEl.innerHTML = `
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Highest Month</span><span class="text-white font-bold">October ($485k)</span></li>
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">YoY Growth</span><span class="text-green-400 font-bold">+24%</span></li>
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Total Deals</span><span class="text-white font-bold">${deals.filter(d => d.status === 'Funded').length}</span></li>
                `;

            } else if (type === 'approval') {
                titleEl.textContent = "Approval Rate Breakdown";
                subtitleEl.textContent = "Decision distribution";
                
                const approved = deals.filter(d => d.status === 'Approved' || d.status === 'Funded').length;
                const declined = 2; // Mock decline count
                const pending = deals.filter(d => d.status === 'Pending').length;

                chartType = 'doughnut';
                chartData = {
                    labels: ['Approved', 'Declined', 'Pending'],
                    datasets: [{
                        data: [approved, declined, pending],
                        backgroundColor: ['#22c55e', '#ef4444', '#eab308'],
                        borderWidth: 0
                    }]
                };
                options = {
                    ...commonOptions,
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: true, position: 'right', labels: { color: '#ccc', font: { family: 'Inter' } } } },
                    cutout: '60%'
                };

                listEl.innerHTML = `
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Approval Rate</span><span class="text-green-400 font-bold">72%</span></li>
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Primary Decline Reason</span><span class="text-white font-bold">Low NSF / Negative Days</span></li>
                `;

            } else if (type === 'pipeline') {
                titleEl.textContent = "Pipeline Composition";
                subtitleEl.textContent = "Value by stage";

                const pendingVal = deals.filter(d => d.status === 'Pending').reduce((a,b)=>a+b.amount,0);
                const approvedVal = deals.filter(d => d.status === 'Approved').reduce((a,b)=>a+b.amount,0);
                
                chartType = 'bar';
                chartData = {
                    labels: ['Pending Review', 'Approved (Unfunded)'],
                    datasets: [{
                        label: 'Value ($)',
                        data: [pendingVal, approvedVal],
                        backgroundColor: ['#eab308', '#22c55e'],
                        borderRadius: 6,
                        barThickness: 40
                    }]
                };

                listEl.innerHTML = `
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Total Pipeline</span><span class="text-white font-bold">$${((pendingVal+approvedVal)/1000).toFixed(0)}k</span></li>
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Actionable (Approved)</span><span class="text-green-400 font-bold">$${(approvedVal/1000).toFixed(0)}k</span></li>
                `;

            } else if (type === 'avg_deal') {
                titleEl.textContent = "Deal Size Distribution";
                subtitleEl.textContent = "Frequency by amount";

                // Bucket deals
                let buckets = { "0-25k": 0, "25-50k": 0, "50-100k": 0, "100k+": 0 };
                deals.forEach(d => {
                    if(d.amount < 25000) buckets["0-25k"]++;
                    else if(d.amount < 50000) buckets["25-50k"]++;
                    else if(d.amount < 100000) buckets["50-100k"]++;
                    else buckets["100k+"]++;
                });

                chartType = 'bar';
                chartData = {
                    labels: Object.keys(buckets),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(buckets),
                        backgroundColor: '#a855f7',
                        borderRadius: 6
                    }]
                };

                const totalVal = deals.reduce((a,b)=>a+b.amount,0);
                const avg = Math.round(totalVal / deals.length);

                listEl.innerHTML = `
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Average Size</span><span class="text-white font-bold">$${avg.toLocaleString()}</span></li>
                    <li class="flex items-center justify-between p-3 bg-[#222] rounded-lg"><span class="text-gray-300">Most Common Range</span><span class="text-purple-400 font-bold">50-100k</span></li>
                `;
            }

            metricChart = new Chart(ctx, {
                type: chartType,
                data: chartData,
                options: options
            });
        }

        function closeMetricModal() {
            document.getElementById('metric-modal').classList.remove('open');
        }
        
        // ... (Rest of functions to ensure completeness)
        async function triggerSOS() {
            const query = document.getElementById('sos-search-input').value;
            if (!query) return;
            const modal = document.getElementById('sos-modal');
            const content = document.getElementById('sos-content');
            const loading = document.getElementById('sos-loading');
            
            modal.classList.remove('hidden'); 
            modal.classList.add('open'); 
            content.innerHTML = ''; 
            loading.classList.remove('hidden');
            
            const key = document.getElementById('header-api-key').value;
            if(!key) { 
                loading.classList.add('hidden'); 
                content.innerHTML = `<p class="text-red-500">Please enter an API Key.</p>`; 
                return; 
            }
            
            try {
                const prompt = `
                    Perform a comprehensive business entity search for: "${query}". 
                    Prioritize official Secretary of State (.gov) and corporate registry data sources.
                    
                    Return a JSON object with this exact structure:
                    {
                        "entity_name": "Legal Name Found",
                        "verified": boolean,
                        "status": "Active / Good Standing / Forfeited / Suspended",
                        "incorporation_date": "YYYY-MM-DD or N/A",
                        "state_of_formation": "State",
                        "entity_type": "LLC / Corp / Inc",
                        "address": "Registered Address",
                        "registered_agent": "Name of Agent",
                        "officers": ["Name 1", "Name 2"],
                        "notes": "Brief summary of any red flags or confirmation.",
                        "sources": [{"title": "Source Title", "url": "URL"}]
                    }
                `;

                const payload = { 
                    contents: [{ parts: [{ text: prompt }] }], 
                    tools: [{ google_search: {} }], 
                    generationConfig: { responseMimeType: "application/json" } 
                };
                
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${key}`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                });
                
                if(!resp.ok) throw new Error(await resp.text());
                const result = await resp.json();
                const text = result.candidates[0].content.parts[0].text;
                const data = JSON.parse(text);
                
                loading.classList.add('hidden');
                
                // Logic for styling
                const isGood = data.status?.toLowerCase().match(/active|good|current/);
                const statusColor = isGood ? 'text-green-400' : 'text-red-400';
                const statusBg = isGood ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20';
                const icon = isGood ? 'check-circle' : 'alert-octagon';
                
                // Render Enhanced Report
                content.innerHTML = `
                    <div class="space-y-4">
                        <!-- Header Card -->
                        <div class="bg-[#222] rounded-xl p-5 border border-[#333]">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h4 class="text-xl font-bold text-white tracking-tight">${data.entity_name || query}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${statusBg} ${statusColor} border">
                                            ${data.status || 'Unknown Status'}
                                        </span>
                                        <span class="text-xs text-gray-500 font-mono">• ${data.state_of_formation || 'Unknown State'}</span>
                                    </div>
                                </div>
                                <div class="bg-[#1a1a1a] p-2 rounded-lg border border-[#333]">
                                    <i data-lucide="${icon}" class="w-6 h-6 ${statusColor}"></i>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-y-4 gap-x-8 text-sm">
                                <div>
                                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-0.5">Formation Date</p>
                                    <p class="text-white font-mono">${data.incorporation_date || '--'}</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-0.5">Entity Type</p>
                                    <p class="text-white">${data.entity_type || '--'}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-0.5">Registered Agent</p>
                                    <p class="text-white">${data.registered_agent || 'Not Listed'}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-0.5">Principal Address</p>
                                    <p class="text-white break-words">${data.address || 'Not Listed'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Officers / Notes -->
                        <div class="grid grid-cols-1 gap-4">
                            ${data.officers && data.officers.length > 0 ? `
                            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
                                <p class="text-gray-500 text-[10px] uppercase font-bold mb-2 flex items-center gap-2"><i data-lucide="users" class="w-3 h-3"></i> Officers / Directors</p>
                                <ul class="space-y-1">
                                    ${data.officers.map(o => `<li class="text-sm text-gray-300">• ${o}</li>`).join('')}
                                </ul>
                            </div>` : ''}
                            
                            <div class="bg-[#1a1a1a] p-4 rounded-xl border border-[#333]">
                                <p class="text-gray-500 text-[10px] uppercase font-bold mb-2 flex items-center gap-2"><i data-lucide="file-text" class="w-3 h-3"></i> Analysis Notes</p>
                                <p class="text-xs text-gray-400 leading-relaxed">${data.notes || 'No specific notes returned.'}</p>
                            </div>
                        </div>

                        <!-- Sources -->
                        ${data.sources && data.sources.length > 0 ? `
                        <div class="border-t border-[#333] pt-4 mt-2">
                            <p class="text-gray-600 text-[10px] uppercase font-bold mb-2">Verified Sources</p>
                            <div class="flex flex-wrap gap-2">
                                ${data.sources.map(s => `
                                    <a href="${s.url}" target="_blank" class="flex items-center gap-1.5 px-3 py-1.5 bg-[#111] hover:bg-[#222] border border-[#333] rounded-lg text-[10px] text-blue-400 hover:text-blue-300 transition-colors">
                                        <i data-lucide="link" class="w-3 h-3"></i> ${s.title.substring(0, 20)}${s.title.length > 20 ? '...' : ''}
                                    </a>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
                lucide.createIcons();
            } catch (e) { 
                loading.classList.add('hidden'); 
                content.innerHTML = `<div class="p-4 bg-red-900/20 border border-red-900 rounded-lg text-red-400 text-sm flex items-center gap-3"><i data-lucide="alert-circle" class="w-5 h-5"></i><span>Search failed: ${e.message}</span></div>`; 
                lucide.createIcons();
            }
        }

        function closeSOSModal() {
            document.getElementById('sos-modal').classList.remove('open');
            setTimeout(() => document.getElementById('sos-modal').classList.add('hidden'), 200);
        }

        // Ensure other previously defined functions are also present if not explicitly redefined above
        // (updateCounts, updateDashboardCharts, populateUI, updateTableAverages, recalculateApproval, callGemini, handleReScrub, handleQuickScrub, startLoadingSequence, stopLoadingSequence, goBack, openMetricModal, closeMetricModal)
    </script>
</body>
</html>
