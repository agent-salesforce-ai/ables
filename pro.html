<!DOCTYPE html>

<html class="theme-black" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>ABLESAI PRO | Underwriting Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<link href="data:image/svg+xml,%3Csvg viewBox='0 0 64 64' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cellipse cx='32' cy='32' rx='28' ry='8' stroke='%23ea580c' stroke-width='2.5' fill='none' transform='rotate(-20 32 32)' stroke-dasharray='70 140'/%3E%3Ccircle cx='32' cy='32' r='12' fill='%23eab308'/%3E%3Cellipse cx='32' cy='32' rx='28' ry='8' stroke='%23ea580c' stroke-width='2.5' fill='none' transform='rotate(-20 32 32)' stroke-dasharray='70 140' stroke-dashoffset='-70'/%3E%3Ccircle cx='54' cy='26' r='4' fill='%23a855f7'/%3E%3C/svg%3E" rel="icon" type="image/svg+xml"/>



<style>
    /* ============================================
       ABLESAI PRO THEME (PREMIUM BLACK + GOLD)
       ============================================ */
    :root,
    .theme-black {
      /* Typography Scale */
      --font-sans: 'DM Sans', system-ui, sans-serif;
      --font-serif: 'Instrument Serif', Georgia, serif;
      --text-2xs: 9px;
      --text-xs: 10px;
      --text-sm: 11px;
      --text-base: 12px;
      --text-md: 13px;
      --text-lg: 14px;
      --text-xl: 16px;
      --text-2xl: 18px;
      --text-3xl: 20px;
      --text-4xl: 24px;
      --text-5xl: 28px;
      --text-6xl: 36px;
      
      /* Colors */
      --bg-body: #000000;
      --bg-body-gradient: linear-gradient(135deg, #000000 0%, #050505 100%);
      --bg-card: #121212;
      --bg-card-inner: #0a0a0a;
      --bg-input: #1f1f1f;
      --bg-toggle: #1f1f1f;
      --bg-option-card: #0a0a0a;
      --bg-stat-hover: rgba(234, 179, 8, 0.2);
      --border-primary: #2a2a2a;
      --border-secondary: #1a1a1a;
      --text-primary: #f5f5f5;
      --text-secondary: #a3a3a3;
      --text-muted: #666666;
      --slider-track: #2a2a2a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.6), 0 2px 4px -2px rgb(0 0 0 / 0.5);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.7), 0 4px 6px -4px rgb(0 0 0 / 0.6);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.7), 0 8px 10px -6px rgb(0 0 0 / 0.6);
      --preview-header-bg: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
      --preview-header-text: #f5f5f5;
      --pattern-color: rgba(255,255,255,0.01);
      --chart-bg: #1f1f1f;
      --modal-overlay: rgba(0, 0, 0, 0.9);
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --accent-glow: rgba(234, 179, 8, 0.15);
      --accent-text: #000000;
      --accent-rgb: 234, 179, 8;
      --pro-gradient: linear-gradient(135deg, #eab308 0%, #f59e0b 50%, #eab308 100%);
      --pro-border: linear-gradient(135deg, #eab308, #f59e0b, #ca8a04);
    }

    * {
      -webkit-font-smoothing: antialiased;
    }

    body {
      background: var(--bg-body-gradient);
      min-height: 100vh;
    }

    /* ============================================
       CARDS
       ============================================ */
    .card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .card:hover {
      box-shadow: var(--shadow-lg), 0 0 30px rgba(234, 179, 8, 0.08);
      border-color: rgba(234, 179, 8, 0.2);
    }
    
    /* PRO Badge Styling */
    .pro-badge {
      background: var(--pro-gradient);
      color: #000;
      font-size: var(--text-2xs);
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    /* Premium glow effect on main result card */
    .calc-result-preview {
      position: relative;
    }
    
    .calc-result-preview::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.3), rgba(245, 158, 11, 0.1), rgba(234, 179, 8, 0.3));
      border-radius: 30px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .calc-result-preview:hover::before {
      opacity: 1;
    }

    /* ============================================
       TAB NAVIGATION
       ============================================ */
    /* ============================================
       MAIN HEADER
       ============================================ */
    .orbiting-moon {
      transform-origin: 32px 32px;
      animation: orbit 3s linear infinite, moonColor 2s ease-in-out infinite;
    }
    @keyframes orbit {
      0% { transform: rotate(-20deg) translate(26px, 0) scale(1); opacity: 1; }
      12.5% { transform: rotate(-20deg) translate(18px, 5px) scale(0.9); opacity: 1; }
      25% { transform: rotate(-20deg) translate(0, 7px) scale(0.75); opacity: 0.7; }
      37.5% { transform: rotate(-20deg) translate(-18px, 5px) scale(0.6); opacity: 0.5; }
      50% { transform: rotate(-20deg) translate(-26px, 0) scale(0.5); opacity: 0.4; }
      62.5% { transform: rotate(-20deg) translate(-18px, -5px) scale(0.6); opacity: 0.5; }
      75% { transform: rotate(-20deg) translate(0, -7px) scale(0.75); opacity: 0.7; }
      87.5% { transform: rotate(-20deg) translate(18px, -5px) scale(0.9); opacity: 1; }
      100% { transform: rotate(-20deg) translate(26px, 0) scale(1); opacity: 1; }
    }
    @keyframes moonColor {
      0%, 100% { fill: #a855f7; }
      25% { fill: #3b82f6; }
      50% { fill: #ec4899; }
      75% { fill: #10b981; }
    }

    .main-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 10px 24px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-secondary);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .main-header svg:first-of-type {
      width: 24px;
      height: 24px;
    }

    .main-header h1 {
      font-size: var(--text-xl);
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--text-primary);
    }
    
    .header-actions {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .info-btn,
    .settings-btn {
      background: transparent;
      border: none;
      padding: 4px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }
    
    .info-btn:hover,
    .settings-btn:hover {
      color: var(--accent);
      background: rgba(234, 179, 8, 0.1);
    }
    
    .info-btn svg,
    .settings-btn svg {
      width: 14px;
      height: 14px;
    }
    
    #themeToggleBtn {
      padding: 6px;
      border-radius: 6px;
      background: rgba(234, 179, 8, 0.08);
    }
    
    #themeToggleBtn:hover {
      background: rgba(234, 179, 8, 0.2);
      transform: rotate(15deg);
    }
    
    #themeToggleBtn svg {
      width: 18px;
      height: 18px;
    }
    
    body.light-theme #themeToggleBtn {
      background: rgba(99, 102, 241, 0.1);
      color: #6366f1;
    }
    
    body.light-theme #themeToggleBtn:hover {
      background: rgba(99, 102, 241, 0.2);
    }

    /* Settings Modal */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .settings-overlay.active {
      display: flex;
    }

    .settings-modal {
      background: var(--bg-card);
      border-radius: 16px;
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-secondary);
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .settings-header h2 {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
    }

    .settings-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .settings-close:hover {
      color: var(--text-primary);
    }

    .settings-body {
      padding: 12px;
    }

    .settings-section {
      margin-bottom: 12px;
    }

    .settings-section:last-child {
      margin-bottom: 0;
    }

    .settings-section-title {
      font-size: var(--text-sm);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .settings-subsection-title {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--accent);
      margin: 10px 0 6px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    .settings-subsection-title:first-of-type {
      margin-top: 0;
    }

    .settings-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .settings-section-header .settings-section-title {
      margin-bottom: 0;
    }

    .mode-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-label {
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      transition: color 0.2s ease;
    }

    .mode-label.active {
      color: var(--accent);
    }

    .mode-toggle {
      position: relative;
      width: 36px;
      height: 18px;
      background: var(--bg-main);
      border-radius: 9px;
      cursor: pointer;
      transition: background 0.2s ease;
      border: 1px solid var(--border-secondary);
    }

    .mode-toggle.advanced {
      background: var(--accent);
      border-color: var(--accent);
    }

    .mode-toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 12px;
      height: 12px;
      background: var(--text-primary);
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .mode-toggle.advanced .mode-toggle-knob {
      transform: translateX(18px);
      background: #0a0a0f;
    }

    .model-mode-panel {
      transition: opacity 0.2s ease;
    }

    .model-mode-panel.hidden {
      display: none;
    }

    .simple-mode-desc {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .preset-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 12px;
    }

    .preset-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 6px;
      background: var(--bg-card-inner);
      border: 2px solid var(--border-secondary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .preset-btn:hover {
      border-color: var(--accent);
      background: rgba(212, 175, 55, 0.05);
    }

    .preset-btn.active {
      border-color: var(--accent);
      background: rgba(212, 175, 55, 0.1);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .preset-icon {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 700;
      margin-bottom: 3px;
      color: #0a0a0f;
    }

    .preset-icon-conservative {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #ffffff;
    }

    .preset-icon-balanced {
      background: linear-gradient(135deg, var(--accent), #b8860b);
      color: #0a0a0f;
    }

    .preset-icon-aggressive {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #ffffff;
    }

    .preset-icon-retail {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #ffffff;
    }

    .preset-icon-new {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #ffffff;
    }

    .preset-icon-established {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: #ffffff;
    }

    .preset-icon-risky {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #ffffff;
    }

    .preset-icon-volume {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: #ffffff;
    }

    .quick-preset-btn .preset-icon {
      width: 24px;
      height: 24px;
      font-size: var(--text-2xs);
      margin-bottom: 0;
      margin-right: 6px;
      display: inline-flex;
    }

    .preset-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1px;
    }

    .preset-desc {
      font-size: var(--text-2xs);
      color: var(--text-muted);
      line-height: 1.2;
    }

    .simple-slider-group {
      border-top: 1px solid var(--border-secondary);
      padding-top: 8px;
    }

    .weight-total-indicator {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 6px;
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .weight-total-value {
      font-weight: 600;
      color: var(--accent);
    }

    .weight-total-value.warning {
      color: #f97316;
    }

    .weight-total-value.error {
      color: #ef4444;
    }

    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg-card-inner);
      border-radius: 6px;
      margin-bottom: 4px;
    }

    .settings-row:last-child {
      margin-bottom: 0;
    }

    .settings-row-label {
      font-size: var(--text-base);
      font-weight: 500;
      color: var(--text-primary);
    }

    .settings-row-desc {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: 1px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 22px;
      background: var(--bg-main);
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(18px);
    }

    /* Model Adjustment Sliders */
    .model-slider-row {
      padding: 6px 10px;
      background: var(--bg-card-inner);
      border-radius: 6px;
      margin-bottom: 3px;
    }

    .model-slider-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2px;
      gap: 8px;
    }

    .model-slider-label {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
    }

    .model-slider-value {
      font-size: var(--text-sm);
      font-weight: 700;
      color: var(--accent);
      min-width: 60px;
      text-align: right;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .model-slider-desc {
      font-size: var(--text-2xs);
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .model-slider-input {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #4a4a4a;
      border: 1px solid #666;
      border-radius: 3px;
      outline: none;
    }

    .model-slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: var(--accent);
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .model-slider-input::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: var(--accent);
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .settings-reset-btn {
      width: 100%;
      padding: 8px;
      background: var(--bg-card-inner);
      border: 1px solid var(--border-secondary);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
    }

    .settings-reset-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    /* Light Theme */
    body.light-theme {
      --bg-body: #f8fafc;
      --bg-body-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --bg-card-inner: #f1f5f9;
      --bg-input: #e2e8f0;
      --bg-toggle: #e2e8f0;
      --bg-option-card: #f8fafc;
      --bg-stat-hover: rgba(16, 185, 129, 0.15);
      --border-primary: #cbd5e1;
      --border-secondary: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --slider-track: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.05);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.05);
      --preview-header-bg: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #ffffff 100%);
      --preview-header-text: #0f172a;
      --pattern-color: rgba(0,0,0,0.02);
      --chart-bg: #f1f5f9;
      --modal-overlay: rgba(0, 0, 0, 0.4);
    }

    /* Header */
    body.light-theme .main-header {
      background: #ffffff;
      border-bottom-color: #e2e8f0;
    }

    body.light-theme .main-header h1 span:first-child {
      color: #0f172a !important;
    }

    body.light-theme .main-header h1 span:nth-child(2) {
      color: #9ca3af !important;
    }

    body.light-theme .main-header h1 span:last-child {
      color: var(--accent) !important;
    }

    /* Settings button */
    body.light-theme .settings-btn {
      color: #64748b;
    }

    body.light-theme .settings-btn:hover {
      color: var(--accent);
    }

    /* Tabs */
    body.light-theme .tab-nav {
      background: #ffffff;
      border-bottom-color: #e2e8f0;
    }

    body.light-theme .tab-btn {
      color: #64748b;
    }

    body.light-theme .tab-btn.active {
      color: #b45309;
      background: #fefce8;
    }
    
    body.light-theme .tab-btn.tab-pro::after {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    /* Cards */
    body.light-theme .card {
      background: #ffffff !important;
      border-color: #e2e8f0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    body.light-theme #calcSummaryCard,
    body.light-theme .risk-card {
      background: #ffffff !important;
    }

    /* Inner card sections */
    body.light-theme .p-4.rounded-lg[style*="background: var(--bg-card)"] {
      background: #f8fafc !important;
    }

    body.light-theme [style*="background: var(--bg-card-inner)"] {
      background: #f1f5f9 !important;
    }

    /* Score breakdown bars - ensure they use proper colors */
    body.light-theme .breakdown-fill {
      opacity: 1;
    }

    /* DSCR bar */
    body.light-theme .dscr-bar-track {
      background: #e2e8f0;
    }

    body.light-theme .dscr-marker {
      background: #94a3b8;
    }

    /* Sliders */
    body.light-theme input[type="range"] {
      background: #e2e8f0;
    }

    body.light-theme .model-slider-input {
      background: #d1d5db;
      border-color: #9ca3af;
    }
    
    body.light-theme .model-slider-input::-webkit-slider-thumb {
      border-color: #374151;
    }
    
    body.light-theme .model-slider-input::-moz-range-thumb {
      border-color: #374151;
    }

    /* Score meter */
    body.light-theme .score-meter-bar {
      background: linear-gradient(to right, #ef4444, #f97316, #eab308, #22c55e, #10b981);
    }

    body.light-theme .score-meter-track {
      background: #e2e8f0;
    }

    /* Settings modal */
    body.light-theme .settings-overlay {
      background: rgba(0,0,0,0.3);
    }

    body.light-theme .settings-modal {
      background: #ffffff;
      border-color: #e2e8f0;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }

    body.light-theme .settings-header {
      border-bottom-color: #e2e8f0;
    }

    body.light-theme .settings-row,
    body.light-theme .model-slider-row {
      background: #f8fafc;
    }

    body.light-theme .toggle-switch {
      background: #cbd5e1;
    }

    body.light-theme .toggle-switch.active {
      background: var(--accent);
    }

    /* Offer section */
    body.light-theme .offer-term-cell {
      background: rgba(16, 185, 129, 0.08);
    }

    body.light-theme .variance-badge {
      background: rgba(0,0,0,0.06);
    }

    /* Result card sections */
    body.light-theme .closing-breakdown {
      background: #f8fafc;
    }

    /* Section titles */
    body.light-theme .section-title {
      color: #0f172a;
    }

    /* Risk indicator text */
    body.light-theme .risk-value {
      color: #0f172a;
    }

    /* Tier badge backgrounds */
    body.light-theme .text-center.px-4.py-2.rounded-xl {
      background: #f1f5f9 !important;
    }

    /* FAB modal */
    body.light-theme .slider-modal,
    body.light-theme .slider-modal-content,
    body.light-theme .fab-modal-content {
      background: #ffffff;
      box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }

    /* Points table in MODEL INFO */
    body.light-theme .points-cell {
      border-color: #e2e8f0;
    }

    /* Ensure accent color text stays readable */
    body.light-theme [style*="color: var(--accent)"] {
      filter: brightness(0.85);
    }

    /* Settings modal text */
    body.light-theme .settings-header h2 {
      color: #0f172a;
    }

    body.light-theme .settings-section-title {
      color: #475569;
    }

    body.light-theme .settings-subsection-title {
      color: #b8860b;
      border-bottom-color: rgba(184, 134, 11, 0.3);
    }

    body.light-theme .mode-toggle {
      background: #e2e8f0;
      border-color: #cbd5e1;
    }

    body.light-theme .mode-toggle.advanced {
      background: var(--accent);
      border-color: var(--accent);
    }

    body.light-theme .mode-toggle-knob {
      background: #ffffff;
    }

    body.light-theme .preset-btn {
      background: #f8fafc;
      border-color: #e2e8f0;
    }

    body.light-theme .preset-btn:hover {
      background: rgba(184, 134, 11, 0.05);
    }

    body.light-theme .preset-btn.active {
      background: rgba(184, 134, 11, 0.1);
    }

    body.light-theme .settings-row-label {
      color: #0f172a;
    }

    body.light-theme .settings-row-desc {
      color: #64748b;
    }

    body.light-theme .model-slider-label {
      color: #0f172a;
    }

    body.light-theme .model-slider-desc {
      color: #64748b;
    }

    body.light-theme .settings-reset-btn {
      color: #475569;
    }

    body.light-theme .settings-reset-btn:hover {
      color: #0f172a;
    }

    /* Slider labels */
    body.light-theme .calc-slider-label,
    body.light-theme .override-slider-label {
      color: #0f172a;
    }

    /* Muted text elements */
    body.light-theme [style*="color: var(--text-muted)"] {
      color: #64748b !important;
    }

    body.light-theme [style*="color: var(--text-secondary)"] {
      color: #475569 !important;
    }

    body.light-theme [style*="color: var(--text-primary)"] {
      color: #0f172a !important;
    }

    /* Comparison labels */
    body.light-theme .comparison-label {
      color: #64748b;
    }

    body.light-theme .comparison-calc {
      color: #64748b;
    }

    /* Input fields */
    body.light-theme input[type="number"],
    body.light-theme select {
      background: #ffffff;
      border-color: #e2e8f0;
      color: #0f172a;
    }

    /* Select dropdowns */
    body.light-theme .industry-select-wrapper select {
      background: #ffffff;
      color: #0f172a;
    }

    /* Labels above inputs */
    body.light-theme label {
      color: #475569;
    }

    /* Metric subheaders - override white to dark in light theme */
    body.light-theme [style*="color: #ffffff"] {
      color: #475569 !important;
    }

    .tab-nav {
      display: flex;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-secondary);
      position: sticky;
      top: 45px;
      z-index: 99;
    }

    @media (max-width: 768px) {
      .tab-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        border-bottom: none;
        border-top: 1px solid var(--border-secondary);
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      
      .tab-nav::-webkit-scrollbar {
        display: none;
      }
      
      .tab-btn {
        padding: 12px 8px;
        min-width: auto;
        flex: 1 0 auto;
      }
      
      .tab-btn-inner {
        flex-direction: column;
        gap: 4px;
      }
      
      .tab-label {
        font-size: 8px;
        letter-spacing: 0.02em;
      }
      
      .tab-btn .tab-icon {
        width: 18px;
        height: 18px;
      }
      
      .tab-btn.tab-pro::after {
        display: none;
      }
      
      .tab-btn.active::before {
        top: auto;
        bottom: 0;
        border-radius: 3px 3px 0 0;
      }
      
      body {
        padding-bottom: 70px;
      }
    }

    @media (max-width: 1024px) {
      #calcRiskIndicators > div,
      #overrideRiskIndicators > div {
        border-right: none !important;
      }
    }

    .tab-btn {
      flex: 1;
      padding: 20px 28px;
      font-size: var(--text-md);
      font-weight: 800;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .tab-btn:hover:not(.active) {
      color: var(--text-secondary);
    }

    .tab-btn.active {
      color: #eab308;
      background: var(--bg-body);
    }

    .tab-btn.active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #eab308, #fde047);
      border-radius: 0 0 3px 3px;
    }
    
    /* PRO badge inline */
    .tab-btn.tab-pro::after {
      content: 'PRO';
      font-size: var(--text-2xs);
      font-weight: 800;
      margin-left: 8px;
      padding: 3px 6px;
      background: linear-gradient(135deg, #eab308, #f59e0b);
      color: #000;
      border-radius: 3px;
      vertical-align: middle;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* ============================================
       SECTION LABELS
       ============================================ */
    .section-indicator {
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--accent), var(--accent-light));
      border-radius: 4px;
    }

    .section-title {
      font-size: var(--text-sm);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    /* ============================================
       SLIDERS
       ============================================ */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
      outline: none;
      cursor: pointer;
      overflow: visible;
      touch-action: none;
    }

    .slider::-webkit-slider-runnable-track {
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
      margin-top: -8px;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 4px 12px rgba(0,0,0,0.15);
    }

    .slider::-webkit-slider-thumb:active {
      cursor: grabbing;
      transform: scale(1.05);
    }

    .slider::-moz-range-thumb {
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .slider::-moz-range-track {
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
    }

    /* ============================================
       EDITABLE INPUT VALUES
       ============================================ */
    .editable-value {
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-primary);
      outline: none;
      padding: 0;
      margin: 0;
      width: auto;
      min-width: 60px;
      max-width: 150px;
      cursor: text;
      transition: border-color 0.2s ease;
    }
    
    .editable-value:hover {
      border-bottom-color: var(--text-muted);
    }
    
    .editable-value:focus {
      border-bottom-color: var(--accent);
    }
    
    .editable-value::placeholder {
      color: var(--text-muted);
    }

    /* ============================================
       CALCULATOR RESULT PREVIEW
       ============================================ */
    .calc-result-preview {
      background: var(--bg-card);
      border-radius: 20px;
      border: 3px solid var(--accent);
      width: 100%;
      box-shadow: 
        0 0 30px rgba(var(--accent-rgb), 0.2),
        0 0 60px rgba(var(--accent-rgb), 0.08);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .calc-result-preview:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.25),
        0 0 80px rgba(var(--accent-rgb), 0.12);
    }

    .calc-preview-header {
      background: var(--preview-header-bg);
      padding: 32px 24px;
      text-align: center;
      position: relative;
    }

    .calc-preview-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 30% 20%, rgba(var(--accent-rgb), 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(var(--accent-rgb), 0.05) 0%, transparent 40%);
      pointer-events: none;
    }

    .calc-preview-label {
      font-size: var(--text-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .calc-preview-amount {
      font-size: clamp(2rem, 6vw, 2.75rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .calc-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      background: var(--bg-option-card);
    }

    .calc-stat-cell {
      padding: 20px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border-secondary);
    }

    .calc-stat-cell:nth-child(odd) {
      border-right: 1px solid var(--border-secondary);
    }

    .calc-stat-label {
      font-size: var(--text-2xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 4px;
    }

    .calc-stat-value {
      font-size: var(--text-2xl);
      font-weight: 800;
      color: var(--text-primary);
    }

    .calc-stat-value.accent {
      color: var(--accent);
    }

    .calc-payment-display {
      padding: 32px 24px;
      text-align: center;
      background: var(--bg-card);
    }

    .calc-payment-label {
      font-size: var(--text-xs);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .calc-payment-amount {
      font-size: 2.25rem;
      font-weight: 800;
      color: var(--text-primary);
    }

    /* ============================================
       PREVIEW STICKY WRAPPER
       ============================================ */
    .preview-sticky-wrapper {
      position: sticky;
      top: 80px;
    }

    /* ============================================
       SCORE PANEL
       ============================================ */
    .score-panel {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    
    /* Mobile score section - hidden on desktop */
    .mobile-score-section {
      display: none;
    }

    .score-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .score-body {
      padding: 16px 20px;
    }

    .breakdown-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .breakdown-bar-track {
      width: 96px;
      height: 8px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
    }

    .breakdown-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s ease;
    }

    /* ============================================
       TIER SCALE
       ============================================ */
    .tier-scale {
      display: flex;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 16px;
    }

    .tier-seg {
      flex: 1;
      padding: 8px 4px;
      text-align: center;
      font-size: var(--text-xs);
      font-weight: 700;
      color: rgba(0,0,0,0.8);
    }

    .tier-seg.tier-a { background: #10b981; }
    .tier-seg.tier-b { background: #22c55e; }
    .tier-seg.tier-c { background: #eab308; }
    .tier-seg.tier-d { background: #f97316; }
    .tier-seg.tier-e { background: #ef4444; }

    /* ============================================
       DECLINED STATE
       ============================================ */
    .declined-card {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
    }

    /* ============================================
       MODEL INFO SECTION
       ============================================ */
    .model-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    .model-card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .model-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .model-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      font-weight: 800;
      color: #000;
    }

    .model-card-body {
      padding: 20px;
    }

    .tier-table-row {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-secondary);
    }

    .tier-table-row:last-child {
      border-bottom: none;
    }

    .tier-badge {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      font-weight: 800;
      color: #000;
      margin-right: 16px;
      flex-shrink: 0;
    }

    .donut-section {
      display: flex;
      align-items: center;
      gap: 32px;
      flex-wrap: wrap;
    }

    .donut-chart {
      position: relative;
      width: 160px;
      height: 160px;
      flex-shrink: 0;
    }

    .donut-chart svg {
      transform: rotate(-90deg);
    }

    .donut-center {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .score-component {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .score-component-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .score-comp-badge {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      font-weight: 800;
      color: #000;
    }

    .score-component-body {
      padding: 20px;
    }

    .formula-value {
      font-family: var(--font-sans);
      font-size: var(--text-md);
      color: var(--text-secondary);
      background: var(--bg-input);
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border-secondary);
    }

    .score-gradient-bar {
      height: 10px;
      border-radius: 5px;
      background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #10b981 100%);
      margin-bottom: 8px;
    }

    .points-grid {
      display: flex;
      gap: 4px;
    }

    .points-cell {
      flex: 1;
      text-align: center;
      padding: 10px 4px;
      border-radius: 8px;
      font-size: var(--text-xs);
      font-weight: 700;
    }

    .tier-boxes {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .tier-box {
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid;
    }

    .buffer-boxes {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .rules-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .rules-card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      overflow: hidden;
    }

    .rules-card-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid var(--border-secondary);
    }

    .rules-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
    }

    .rules-card-body {
      padding: 16px 20px;
    }

    .rules-list {
      list-style: none;
    }

    .rules-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      font-size: var(--text-md);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-secondary);
    }

    .rules-list li:last-child {
      border-bottom: none;
    }

    .sizing-section {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      padding: 24px;
      margin-bottom: 24px;
    }

    .sizing-caps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .sizing-cap {
      text-align: center;
      padding: 20px;
      background: var(--bg-input);
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
    }

    .example-box {
      background: var(--bg-input);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-secondary);
    }

    /* ============================================
       SCROLLBAR
       ============================================ */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-body);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--border-primary);
      border-radius: 3px;
    }

    /* ============================================
       OVERRIDE TAB STYLES
       ============================================ */
    .override-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
      margin-top: 24px;
    }

    @media (max-width: 1024px) {
      .override-layout {
        grid-template-columns: 1fr;
      }
      .override-layout > .override-controls-column {
        order: 2;
      }
      .override-layout > .override-result-column {
        order: 1;
      }
    }

    .variance-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: var(--text-sm);
      font-weight: 700;
    }

    .variance-indicator.positive {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    .variance-indicator.negative {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .variance-indicator.neutral {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
    }

    .gauge-container {
      position: relative;
      width: 180px;
      height: 100px;
      margin: 0 auto;
    }

    .gauge-arc {
      fill: none;
      stroke-width: 16;
      stroke-linecap: round;
    }

    .gauge-bg {
      stroke: #374151;
    }
    
    body.light-theme .gauge-bg {
      stroke: #e2e8f0;
    }

    .gauge-fill {
      transition: stroke-dashoffset 0.5s ease;
    }

    .gauge-needle {
      transition: cx 0.5s ease, cy 0.5s ease;
      fill: var(--text-primary);
      stroke: none;
    }

    .gauge-center-label {
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }

    .risk-meter {
      height: 8px;
      background: var(--bg-card-inner);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .risk-meter-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease, background 0.3s ease;
    }

    .risk-meter-zones {
      position: absolute;
      inset: 0;
      display: flex;
    }

    .risk-zone {
      flex: 1;
      border-right: 1px solid var(--bg-card);
    }

    .risk-zone:last-child {
      border-right: none;
    }

    .dscr-bar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dscr-bar-track {
      flex: 1;
      height: 24px;
      background: var(--bg-card-inner);
      border-radius: 12px;
      position: relative;
      overflow: hidden;
    }

    .dscr-bar-fill {
      height: 100%;
      border-radius: 12px;
      transition: width 0.5s ease, background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 8px;
    }

    .dscr-marker {
      position: absolute;
      top: -8px;
      bottom: -8px;
      width: 2px;
      background: var(--text-primary);
    }

    .dscr-marker::after {
      content: attr(data-label);
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: var(--text-2xs);
      font-weight: 700;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .impact-chart {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .impact-item {
      background: var(--bg-card-inner);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border-secondary);
    }

    .impact-value {
      font-size: var(--text-4xl);
      font-weight: 800;
      margin-bottom: 4px;
    }

    .impact-label {
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .override-slider-group {
      background: var(--bg-option-card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border-secondary);
    }

    .override-slider-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .override-value-display {
      text-align: right;
    }

    .override-value-main {
      font-size: var(--text-5xl);
      font-weight: 800;
      color: var(--text-primary);
    }

    .override-value-calc {
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .comparison-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-secondary);
    }

    .comparison-row:last-child {
      border-bottom: none;
    }

    .comparison-label {
      font-size: var(--text-base);
      color: var(--text-secondary);
    }

    .comparison-values {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .comparison-calc {
      font-size: var(--text-base);
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .comparison-override {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
    }

    .pd-scale {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
    }

    .pd-scale-item {
      font-size: var(--text-2xs);
      font-weight: 600;
      text-transform: uppercase;
    }

    /* ============================================
       SUMMARY SCORE BAR
       ============================================ */
    .summary-score-bar {
      position: relative;
      height: 10px;
      background: linear-gradient(90deg, 
        #ef4444 0%, 
        #f97316 25%, 
        #eab308 50%, 
        #22c55e 75%, 
        #10b981 100%
      );
      border-radius: 5px;
      overflow: visible;
    }

    .summary-score-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: transparent;
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .summary-score-marker {
      position: absolute;
      top: -8px;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid var(--text-primary);
      transition: left 0.5s ease;
      font-size: 0;
    }
    
    .summary-score-marker::after {
      content: attr(data-score);
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-size: var(--text-sm);
      font-weight: 800;
      color: var(--text-primary);
      white-space: nowrap;
    }

    /* ============================================
       PAYMENT FREQUENCY TOGGLES
       ============================================ */
    .freq-toggle-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .freq-toggle {
      position: relative;
    }

    .freq-toggle input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .freq-toggle-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: var(--text-base);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.25s ease;
      background: var(--bg-card-inner);
      border: 2px solid var(--border-secondary);
      color: var(--text-muted);
    }

    .freq-toggle-btn:hover {
      border-color: var(--border-primary);
      color: var(--text-secondary);
    }

    .freq-toggle input:checked + .freq-toggle-btn {
      background: linear-gradient(135deg, rgba(16,185,129,0.2) 0%, rgba(16,185,129,0.1) 100%);
      border-color: #10b981;
      color: #10b981;
      box-shadow: 0 0 20px rgba(16,185,129,0.2);
    }

    /* ============================================
       CALC LAYOUT (matching override-layout)
       ============================================ */
    .calc-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
      margin-top: 24px;
    }
    
    .calc-result-column,
    .override-result-column {
      margin-top: 0;
      padding-top: 0;
    }
    
    .preview-sticky-wrapper {
      margin-top: 0;
      padding-top: 0;
    }
    
    .preview-sticky-wrapper > .calc-result-preview {
      margin-top: 0;
    }
    
    /* Remove space-y margin from first visible card after hidden mobile handle */
    .calc-controls-column > .card:first-of-type,
    .override-controls-column > .card:first-of-type {
      margin-top: 0 !important;
    }

    /* Score section wrapper - centered above results */
    .score-section-wrapper {
      margin-bottom: 24px;
    }
    
    /* Hide duplicate score card in drawer - shown separately above */
    .score-card-desktop {
      display: none;
    }

    /* Panel toggle handle - hidden on desktop */
    .mobile-panel-handle {
      display: none;
    }
    
    .drawer-label {
      display: none;
    }
    
    .drawer-chevrons {
      display: none;
    }

    /* ============================================
       RESPONSIVE - MOBILE
       ============================================ */
    @media (max-width: 1024px) {
      .calc-layout {
        display: block;
      }
      
      /* Results column full width */
      .calc-result-column {
        max-width: 100%;
        padding-bottom: 80px; /* Space for FAB */
      }
      
      /* Hide sliders column - controlled by modal */
      .calc-controls-column {
        display: none !important;
      }
      
      /* Floating Action Button */
      .slider-fab {
        display: flex !important;
        position: fixed;
        bottom: 70px;
        right: 16px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--accent);
        border: none;
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35);
        cursor: pointer;
        z-index: 200;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
        color: #000;
      }
      
      .slider-fab:active {
        transform: scale(0.95);
      }
      
      .slider-fab svg {
        width: 24px;
        height: 24px;
      }
      
      .slider-fab.hidden {
        display: none !important;
      }
      
      /* Slider Modal - expands from button */
      .slider-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.85);
        z-index: 300;
        align-items: center;
        justify-content: center;
        padding: 12px;
      }
      
      .slider-modal-overlay.active {
        display: flex !important;
      }
      
      /* Slider Modal Panel - FULL WIDTH HORIZONTAL */
      .slider-modal {
        width: 100%;
        max-width: 95vw;
        max-height: 90vh;
        background: var(--bg-card);
        border-radius: 16px;
        padding: 16px;
        overflow-y: auto;
        transform-origin: center center;
        animation: expandFromFab 0.25s ease-out;
        border: 1px solid var(--border-primary);
        box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      }
      
      @keyframes expandFromFab {
        from { 
          transform: scale(0.3);
          opacity: 0;
        }
        to { 
          transform: scale(1);
          opacity: 1;
        }
      }
      
      /* Score Meter in Modal - PROMINENT HORIZONTAL BAR */
      .modal-score-meter {
        background: var(--bg-option-card);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        border: 1px solid var(--border-secondary);
      }
      
      .modal-score-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 0;
      }
      
      .modal-score-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }
      
      .modal-tier-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 8px;
        background: rgba(0,0,0,0.3);
        border: 2px solid currentColor;
      }
      
      .modal-tier-letter {
        font-size: var(--text-3xl);
        font-weight: 900;
        line-height: 1;
      }
      
      .modal-tier-label {
        font-size: 7px;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        margin-top: 1px;
        white-space: nowrap;
      }
      
      .modal-score-text {
        display: flex;
        flex-direction: column;
      }
      
      .modal-score-label {
        font-size: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-bottom: 1px;
      }
      
      .modal-score-value {
        display: flex;
        align-items: baseline;
        gap: 2px;
      }
      
      .modal-score-number {
        font-size: var(--text-4xl);
        font-weight: 800;
        color: var(--text-primary);
        line-height: 1;
      }
      
      .modal-score-max {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--text-muted);
      }
      
      .modal-score-bar-container {
        flex: 1;
      }
      
      .modal-score-bar {
        height: 8px;
        background: rgba(255,255,255,0.08);
        border-radius: 4px;
        position: relative;
        overflow: visible;
      }
      
      .modal-score-bar-fill {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #10b981 100%);
        transition: width 0.3s ease;
      }
      
      .modal-score-bar-marker {
        position: absolute;
        top: -3px;
        width: 3px;
        height: 14px;
        background: white;
        border-radius: 2px;
        transform: translateX(-50%);
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      }
      
      .modal-score-scale {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
        font-size: 8px;
        font-weight: 700;
      }
      
      .modal-score-scale span {
        text-align: center;
        flex: 1;
      }
      
      /* Offer Terms Section */
      .modal-offer-terms {
        margin-bottom: 10px;
      }
      
      .modal-section-label {
        font-size: 8px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--accent);
        margin-bottom: 6px;
        text-align: center;
      }
      
      .slider-cell.offer-term-cell {
        background: var(--bg-option-card) !important;
        border: 1px solid var(--border-secondary) !important;
        text-align: center;
        padding: 10px 6px !important;
      }
      
      .slider-cell.offer-term-cell label {
        font-size: 8px !important;
        margin-bottom: 2px !important;
      }
      
      .slider-cell.offer-term-cell .value {
        font-size: var(--text-2xl) !important;
        color: var(--accent) !important;
        font-weight: 800 !important;
      }
      
      /* Override modal variance styling */
      .modal-override-section {
        margin-top: 8px;
      }
      
      .override-value-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .variance-badge {
        font-size: var(--text-xs);
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(100,100,100,0.3);
        color: var(--text-muted);
        font-weight: 500;
      }
      
      .variance-badge.positive {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
      }
      
      .variance-badge.negative {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
      }
      
      .slider-cell.override-slider-cell {
        background: var(--bg-option-card) !important;
        border: 1px solid var(--border-secondary) !important;
      }
      
      /* Compact Inline Risk Metrics */
      .modal-risk-metrics-inline {
        display: flex;
        gap: 12px;
        margin-top: 8px;
        padding: 10px 12px;
        background: var(--bg-option-card);
        border: 1px solid var(--border-secondary);
        border-radius: 10px;
      }
      
      .modal-pd-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
      }
      
      .modal-pd-gauge-small {
        position: relative;
      }
      
      .modal-pd-info {
        display: flex;
        flex-direction: column;
      }
      
      .modal-pd-number {
        font-size: var(--text-xl);
        font-weight: 800;
        color: var(--text-primary);
      }
      
      .modal-pd-text {
        font-size: var(--text-2xs);
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      
      .modal-dscr-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1.5;
      }
      
      .modal-dscr-mini-bar {
        flex: 1;
        height: 16px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      
      .modal-dscr-mini-fill {
        height: 100%;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 6px;
        transition: width 0.3s ease;
      }
      
      .modal-dscr-mini-fill span {
        font-size: var(--text-2xs);
        font-weight: 800;
        color: #000;
      }
      
      .modal-dscr-info {
        display: flex;
        flex-direction: column;
        min-width: 50px;
      }
      
      .modal-dscr-number {
        font-size: var(--text-xl);
        font-weight: 800;
        color: #10b981;
      }
      
      .modal-dscr-text {
        font-size: var(--text-2xs);
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      
      /* Hide old modal risk metrics styles - keep for reference */
      .modal-risk-metrics {
        display: none;
      }
      
      .modal-score-bar-fill {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, #ef4444 0%, #f97316 25%, #eab308 50%, #22c55e 75%, #10b981 100%);
        transition: width 0.3s ease;
      }
      
      .modal-score-bar-marker {
        position: absolute;
        top: -4px;
        width: 3px;
        height: 16px;
        background: white;
        border-radius: 2px;
        transform: translateX(-50%);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
      
      .modal-score-scale {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: var(--text-2xs);
        font-weight: 700;
      }
      
      .modal-score-scale span {
        text-align: center;
        flex: 1;
      }
      
      .slider-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 0 10px;
        border-bottom: 1px solid var(--border-secondary);
        margin-bottom: 10px;
      }
      
      .slider-modal-title {
        font-size: var(--text-sm);
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-primary);
      }
      
      .slider-modal-close {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        background: var(--bg-option-card);
        border: 1px solid var(--border-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: var(--text-2xl);
        transition: all 0.2s;
      }
      
      .slider-modal-close:hover {
        background: rgba(255,255,255,0.1);
        color: var(--text-primary);
      }
      
      /* Slider grid inside modal - 3 columns for horizontal layout */
      .slider-modal .sliders-grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 6px !important;
      }
      
      .slider-modal .slider-cell {
        padding: 10px 8px !important;
        border-radius: 10px !important;
        background: var(--bg-option-card) !important;
        border: 1px solid var(--border-secondary) !important;
      }
      
      .slider-modal .slider-cell label {
        font-size: 8px !important;
        margin-bottom: 2px !important;
        display: block;
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.3px;
      }
      
      .slider-modal .slider-cell .value {
        font-size: var(--text-lg) !important;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 6px;
      }
      
      .slider-modal .slider-cell input.value,
      .slider-modal .slider-cell input.editable-value {
        font-size: var(--text-lg) !important;
      }
      
      .slider-modal .slider-cell input[type="range"] {
        width: 100%;
        height: 5px !important;
      }
      
      /* Toggle sections in modal - 1x2 grid */
      .slider-modal .toggles-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
        margin-top: 10px;
      }
      
      .slider-modal .toggle-section {
        padding: 10px;
        background: var(--bg-option-card);
        border: 1px solid var(--border-secondary);
        border-radius: 10px;
      }
      
      .slider-modal .toggle-section label {
        font-size: 8px;
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.3px;
        display: block;
        text-align: center;
        margin-bottom: 8px;
      }
      
      .slider-modal .toggle-section .freq-toggle-group {
        flex-direction: row;
        gap: 4px;
        justify-content: center;
      }
      
      .slider-modal .toggle-section .freq-toggle-btn {
        padding: 6px 12px;
        font-size: var(--text-xs);
        font-weight: 700;
      }
      
      /* Override grid - 3 columns */
      .slider-modal .override-grid {
        grid-template-columns: repeat(3, 1fr) !important;
      }
      
      .slider-modal .override-grid .full-width {
        grid-column: 1 / -1;
      }
      
      /* Override modal toggle section */
      #modalOverrideContent .toggle-section {
        padding: 12px;
        background: var(--bg-option-card);
        border: 1px solid var(--border-secondary);
        border-radius: 12px;
      }
      
      #modalOverrideContent .toggle-section label {
        font-size: var(--text-2xs);
        color: var(--text-muted);
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.3px;
        display: block;
        text-align: center;
        margin-bottom: 10px;
      }
      
      #modalOverrideContent .toggle-section .freq-toggle-group {
        justify-content: center;
      }
      
      #modalOverrideContent .toggle-section .freq-toggle-btn {
        padding: 8px 14px;
        font-size: var(--text-sm);
        font-weight: 700;
      }
      
      /* Override layout */
      .override-layout {
        display: block;
      }
      
      .override-result-column {
        padding-bottom: 80px;
      }
      
      .override-controls-column {
        display: none !important;
      }
      
      /* Override tab mobile optimizations */
      #tab-override .card.p-3 {
        padding: 8px !important;
      }
      
      #tab-override .card .p-4 {
        padding: 10px !important;
      }
      
      /* Summary bar compact on mobile */
      #tab-override .flex.items-center.justify-between {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      #tab-override .flex.items-center.gap-6.flex-1 {
        justify-content: center;
      }
      
      #tab-override .flex.gap-6.flex-shrink-0 {
        justify-content: space-around;
        width: 100%;
      }
      
      /* Make score bar smaller on mobile */
      #tab-override .min-w-\[200px\] {
        min-width: 150px !important;
      }
      
      /* Risk analytics row - stack vertically */
      #overrideRiskIndicators {
        gap: 8px !important;
      }
      
      #overrideRiskIndicators > div {
        padding: 10px !important;
      }
      
      /* Override result card compact */
      #overrideResultCard .calc-preview-header {
        padding: 16px !important;
      }
      
      #overrideResultCard .calc-stats-grid {
        gap: 0 !important;
      }
      
      #overrideResultCard .p-4 {
        padding: 12px !important;
      }
    }
    
    /* Hide FAB on desktop */
    .slider-fab {
      display: none;
    }
    
    .slider-modal-overlay {
      display: none;
    }

    @media (max-width: 768px) {
      .tier-boxes, .buffer-boxes {
        grid-template-columns: repeat(2, 1fr);
      }
      .rules-grid, .sizing-caps {
        grid-template-columns: 1fr;
      }
      .calc-result-preview {
        border-radius: 20px;
        border-width: 3px;
      }
    }

    /* ============================================
       ABLESAI PRO - PREMIUM COMPONENTS
       ============================================ */
    
    /* PRO Badge Small */
    .pro-badge-sm {
      background: linear-gradient(135deg, #eab308, #f59e0b);
      color: #000;
      font-size: var(--text-2xs);
      font-weight: 700;
      padding: 1px 4px;
      border-radius: 3px;
      margin-left: 4px;
      vertical-align: middle;
    }
    
    /* Quick Action Bar */
    .quick-action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 24px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-secondary);
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .quick-actions-left, .quick-actions-right {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .quick-preset-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .quick-preset-btn:hover {
      background: var(--bg-input);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    
    .preset-icon {
      font-size: var(--text-base);
    }
    
    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .quick-action-btn:hover {
      background: var(--bg-input);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    
    .quick-action-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
    }
    
    .quick-action-btn.primary:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
    }
    
    /* Animated Score Gauge */
    .score-gauge-container {
      position: relative;
      width: 200px;
      height: 120px;
      margin: 0 auto;
    }
    
    .score-gauge {
      width: 100%;
      height: 100%;
    }
    
    .gauge-bg {
      fill: none;
      stroke: var(--bg-input);
      stroke-width: 20;
    }
    
    .gauge-fill {
      fill: none;
      stroke: var(--accent);
      stroke-width: 20;
      stroke-linecap: round;
      transform-origin: center;
      transition: stroke-dashoffset 1s ease-out, stroke 0.5s ease;
    }
    
    .gauge-needle {
      fill: var(--text-primary);
      transform-origin: 100px 100px;
      transition: transform 1s ease-out;
    }
    
    .gauge-center {
      fill: var(--bg-card);
      stroke: var(--border-primary);
      stroke-width: 2;
    }
    
    .gauge-score-text {
      font-size: var(--text-5xl);
      font-weight: 800;
      fill: var(--text-primary);
      text-anchor: middle;
    }
    
    .gauge-label-text {
      font-size: var(--text-xs);
      font-weight: 600;
      fill: var(--text-muted);
      text-anchor: middle;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    /* Sensitivity Analysis */
    .sensitivity-panel {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      padding: 20px;
    }
    
    .sensitivity-slider-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .sensitivity-slider-row:last-child {
      border-bottom: none;
    }
    
    .sensitivity-label {
      width: 120px;
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .sensitivity-slider {
      flex: 1;
    }
    
    .sensitivity-impact {
      width: 100px;
      text-align: right;
      font-size: var(--text-md);
      font-weight: 700;
    }
    
    .impact-positive { color: #22c55e; }
    .impact-negative { color: #ef4444; }
    .impact-neutral { color: var(--text-muted); }
    
    /* Risk Breakdown Chart */
    .risk-breakdown {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }
    
    .risk-factor-card {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .risk-factor-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .risk-factor-icon {
      font-size: var(--text-4xl);
      margin-bottom: 8px;
    }
    
    .risk-factor-name {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    
    .risk-factor-value {
      font-size: var(--text-3xl);
      font-weight: 800;
      color: var(--text-primary);
    }
    
    .risk-factor-bar {
      height: 4px;
      background: var(--bg-input);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .risk-factor-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }
    
    /* Alternative Offers */
    .offer-scenarios {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    
    .offer-card {
      background: var(--bg-option-card);
      border: 2px solid var(--border-secondary);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .offer-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .offer-card.recommended {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(234,179,8,0.1) 0%, rgba(234,179,8,0.02) 100%);
    }
    
    .offer-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .offer-type {
      font-size: var(--text-sm);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }
    
    .offer-badge {
      font-size: var(--text-2xs);
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    
    .offer-badge.conservative { background: #3b82f6; color: #fff; }
    .offer-badge.recommended { background: var(--accent); color: #000; }
    .offer-badge.aggressive { background: #ef4444; color: #fff; }
    
    .offer-amount {
      font-size: var(--text-5xl);
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .offer-detail {
      font-size: var(--text-base);
      color: var(--text-muted);
      margin: 4px 0;
    }
    
    /* Compact grid for MODEL SCORE tab */
    #calcOfferScenariosCard .offer-scenarios {
      gap: 12px;
    }
    
    #calcOfferScenariosCard .offer-card {
      padding: 14px;
      border-radius: 12px;
    }
    #calcOfferScenariosCard .offer-amount {
      font-size: var(--text-4xl);
    }
    #calcOfferScenariosCard .offer-detail {
      font-size: var(--text-sm);
    }
    #calcOfferScenariosCard .offer-type {
      font-size: var(--text-xs);
    }
    #calcOfferScenariosCard .offer-badge {
      font-size: var(--text-2xs);
      padding: 3px 8px;
    }
    #calcOfferScenariosCard .offer-expanded {
      margin-top: 10px;
      padding-top: 8px;
    }
    #calcOfferScenariosCard .offer-expanded-row {
      padding: 5px 0;
    }
    #calcOfferScenariosCard .offer-expanded-label {
      font-size: var(--text-2xs);
    }
    #calcOfferScenariosCard .offer-expanded-value {
      font-size: var(--text-sm);
    }
    #calcOfferScenariosCard .offer-load-btn {
      padding: 8px 12px;
      font-size: var(--text-xs);
      margin-top: 8px;
    }
    
    /* Compact grid for OFFER BUILDER tab (match Model Score) */
    #offerScenariosCard .offer-scenarios {
      gap: 12px;
    }
    
    #offerScenariosCard .offer-card {
      padding: 14px;
      border-radius: 12px;
    }
    #offerScenariosCard .offer-amount {
      font-size: var(--text-4xl);
    }
    #offerScenariosCard .offer-detail {
      font-size: var(--text-sm);
    }
    #offerScenariosCard .offer-type {
      font-size: var(--text-xs);
    }
    #offerScenariosCard .offer-badge {
      font-size: var(--text-2xs);
      padding: 3px 8px;
    }
    #offerScenariosCard .offer-expanded {
      margin-top: 10px;
      padding-top: 8px;
    }
    #offerScenariosCard .offer-expanded-row {
      padding: 5px 0;
    }
    #offerScenariosCard .offer-expanded-label {
      font-size: var(--text-2xs);
    }
    #offerScenariosCard .offer-expanded-value {
      font-size: var(--text-sm);
    }
    #offerScenariosCard .offer-load-btn {
      padding: 8px 12px;
      font-size: var(--text-xs);
      margin-top: 8px;
    }
    
    /* Selected offer card state */
    .offer-card.selected {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 3px rgba(234,179,8,0.3), 0 8px 24px rgba(0,0,0,0.3);
      transform: translateY(-4px);
    }
    
    .offer-card.selected.conservative-selected {
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.3), 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .offer-card.selected.aggressive-selected {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239,68,68,0.3), 0 8px 24px rgba(0,0,0,0.3);
    }
    
    /* Expanded offer card content - always visible */
    .offer-card .offer-expanded {
      max-height: 400px;
      overflow: visible;
      opacity: 1;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border-secondary);
    }
    
    .offer-expanded-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .offer-expanded-row:last-child {
      border-bottom: none;
    }
    
    .offer-expanded-label {
      font-size: var(--text-sm);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .offer-expanded-value {
      font-size: var(--text-md);
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .offer-load-btn {
      width: 100%;
      margin-top: 12px;
      padding: 10px 16px;
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: var(--text-sm);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .offer-load-btn:hover {
      background: var(--accent-light);
      transform: translateY(-1px);
    }
    
    .offer-load-btn.conservative-btn {
      background: #3b82f6;
      color: #fff;
    }
    
    .offer-load-btn.conservative-btn:hover {
      background: #60a5fa;
    }
    
    .offer-load-btn.aggressive-btn {
      background: #ef4444;
      color: #fff;
    }
    
    .offer-load-btn.aggressive-btn:hover {
      background: #f87171;
    }
    
    .offer-card .selected-indicator {
      display: none;
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 50%;
      align-items: center;
      justify-content: center;
    }
    
    .offer-card.selected .selected-indicator {
      display: flex;
    }
    
    .offer-card {
      position: relative;
    }
    
    /* Compare Mode */
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    
    .compare-card {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      overflow: hidden;
    }
    
    .compare-card-header {
      background: var(--bg-option-card);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .compare-card-title {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .compare-card-body {
      padding: 16px;
    }
    
    .compare-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .compare-row:last-child {
      border-bottom: none;
    }
    
    .compare-label {
      font-size: var(--text-sm);
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    .compare-value {
      font-size: var(--text-md);
      font-weight: 700;
      color: var(--text-primary);
    }
    
    /* Deal Notes */
    .deal-notes {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 16px;
    }
    
    .deal-notes-textarea {
      width: 100%;
      min-height: 100px;
      background: var(--bg-input);
      border: 1px solid var(--border-secondary);
      border-radius: 8px;
      padding: 12px;
      color: var(--text-primary);
      font-size: var(--text-md);
      resize: vertical;
    }
    
    .deal-notes-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Stacking Analysis */
    .stacking-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .stacking-table th,
    .stacking-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .stacking-table th {
      font-size: var(--text-xs);
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      background: var(--bg-option-card);
    }
    
    .stacking-table td {
      font-size: var(--text-md);
      color: var(--text-primary);
    }
    
    .position-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: var(--text-xs);
      font-weight: 700;
    }
    
    .position-1st { background: #22c55e; color: #000; }
    .position-2nd { background: #eab308; color: #000; }
    .position-3rd { background: #f97316; color: #000; }
    .position-4th { background: #ef4444; color: #fff; }
    
    /* Reports Section */
    .report-preview {
      background: #fff;
      color: #000;
      border-radius: 8px;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .report-header {
      border-bottom: 3px solid #eab308;
      padding-bottom: 20px;
      margin-bottom: 30px;
    }
    
    .report-logo {
      font-size: var(--text-4xl);
      font-weight: 800;
    }
    
    .report-title {
      font-size: var(--text-5xl);
      font-weight: 700;
      margin-top: 20px;
    }
    
    .report-section {
      margin-bottom: 30px;
    }
    
    .report-section-title {
      font-size: var(--text-lg);
      font-weight: 700;
      text-transform: uppercase;
      color: #666;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
      margin-bottom: 16px;
    }
    
    /* Confidence Meter */
    .confidence-meter {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .confidence-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .confidence-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .confidence-value {
      font-size: var(--text-lg);
      font-weight: 700;
      min-width: 50px;
      text-align: right;
    }
    
    /* AI Recommendation Box */
    .ai-recommendation {
      background: linear-gradient(135deg, rgba(234,179,8,0.15) 0%, rgba(234,179,8,0.05) 100%);
      border: 1px solid rgba(234,179,8,0.3);
      border-radius: 12px;
      padding: 16px;
    }
    
    .ai-recommendation-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .ai-icon {
      width: 24px;
      height: 24px;
      background: var(--accent);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-base);
    }
    
    .ai-recommendation-title {
      font-size: var(--text-base);
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .ai-recommendation-text {
      font-size: var(--text-md);
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    /* Cash Flow Projection Chart */
    .chart-container {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 20px;
      height: 250px;
    }
    
    /* Industry Benchmark */
    .benchmark-bar {
      position: relative;
      height: 32px;
      background: var(--bg-input);
      border-radius: 8px;
      overflow: visible;
      margin: 20px 0;
    }
    
    .benchmark-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.5s ease;
    }
    
    .benchmark-marker {
      position: absolute;
      top: -8px;
      width: 3px;
      height: 48px;
      background: var(--text-primary);
      border-radius: 2px;
    }
    
    .benchmark-label {
      position: absolute;
      top: 44px;
      transform: translateX(-50%);
      font-size: var(--text-xs);
      font-weight: 600;
      white-space: nowrap;
    }
    
    /* Keyboard Shortcut Hints */
    .kbd {
      display: inline-block;
      padding: 2px 6px;
      font-size: var(--text-xs);
      font-family: var(--font-sans);
      background: var(--bg-input);
      border: 1px solid var(--border-primary);
      border-radius: 4px;
      color: var(--text-muted);
    }
    
    /* Focus Mode */
    body.focus-mode .quick-action-bar,
    body.focus-mode .tab-nav,
    body.focus-mode .main-header {
      display: none;
    }
    
    body.focus-mode .tab-panel {
      padding-top: 20px;
    }
    
    /* Light Theme */
    body.theme-light {
      --bg-body: #f5f5f5;
      --bg-body-gradient: linear-gradient(135deg, #f5f5f5 0%, #e5e5e5 100%);
      --bg-card: #ffffff;
      --bg-card-inner: #f9f9f9;
      --bg-input: #f0f0f0;
      --bg-toggle: #e5e5e5;
      --bg-option-card: #fafafa;
      --border-primary: #e0e0e0;
      --border-secondary: #eaeaea;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --text-muted: #999999;
      --slider-track: #e0e0e0;
      --preview-header-bg: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
      --preview-header-text: #1a1a1a;
      --modal-overlay: rgba(0, 0, 0, 0.5);
    }
    
    /* Collapsible Sections */
    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: var(--bg-option-card);
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    
    .collapsible-header:hover {
      background: var(--bg-input);
    }
    
    .collapsible-icon {
      transition: transform 0.3s ease;
    }
    
    .collapsible-header.open .collapsible-icon {
      transform: rotate(180deg);
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsible-content.open {
      max-height: 2000px;
    }
    
    /* Multi-position Debt */
    .debt-position-row {
      display: grid;
      grid-template-columns: 80px 1fr 100px 100px 40px;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: var(--bg-option-card);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .debt-position-row input,
    .debt-position-row select {
      padding: 8px;
      background: var(--bg-input);
      border: 1px solid var(--border-secondary);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: var(--text-base);
    }
    
    .add-debt-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      background: var(--bg-option-card);
      border: 2px dashed var(--border-primary);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: var(--text-base);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-debt-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* Audit Trail */
    .audit-trail {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .audit-entry {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid var(--border-secondary);
    }
    
    .audit-time {
      font-size: var(--text-xs);
      color: var(--text-muted);
      min-width: 80px;
    }
    
    .audit-action {
      font-size: var(--text-base);
      color: var(--text-primary);
    }
    
    @media (max-width: 768px) {
      .quick-action-bar {
        padding: 8px 12px;
      }
      
      .quick-actions-left {
        display: none;
      }
      
      .risk-breakdown {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .offer-scenarios {
        grid-template-columns: 1fr;
      }
      
      .debt-position-row {
        grid-template-columns: 1fr 1fr;
      }
      
      /* Reports Mobile Styles */
      .report-preview {
        padding: 20px !important;
      }
      
      .report-title {
        font-size: var(--text-2xl) !important;
      }
      
      .report-logo {
        font-size: var(--text-2xl) !important;
      }
      
      .report-summary-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }
      
      .report-summary-grid > div {
        padding: 10px !important;
      }
      
      .report-big-value {
        font-size: var(--text-2xl) !important;
      }
      
      .report-profile-grid {
        grid-template-columns: 1fr !important;
      }
      
      .report-payment-grid {
        grid-template-columns: 1fr !important;
      }
      
      #tab-reports .lg\\:col-span-3 {
        grid-column: span 1 !important;
      }
      
      #tab-reports .lg\\:grid-cols-3 {
        grid-template-columns: 1fr !important;
      }
    }
  

/* ============================================================
   MINI UTILITY LAYER (Tailwind subset)  self-contained
   ============================================================ */
:root{ --font-sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
*,*::before,*::after{ box-sizing:border-box; }
html,body{ height:100%; }
body{ font-family: var(--font-sans); color: var(--text-primary); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
button, input, select, textarea{ font: inherit; color: inherit; }
:focus-visible{ outline: 3px solid rgba(var(--accent-rgb), .45); outline-offset: 2px; border-radius: 10px; }
::selection{ background: rgba(var(--accent-rgb), .25); }

/* Basic layout */
.hidden{ display:none !important; }
.block{ display:block; }
.flex{ display:flex; }
.grid{ display:grid; }
.flex-1{ flex:1 1 0%; }
.flex-wrap{ flex-wrap:wrap; }
.flex-shrink-0{ flex-shrink:0; }
.items-center{ align-items:center; }
.items-baseline{ align-items:baseline; }
.justify-center{ justify-content:center; }
.justify-between{ justify-content:space-between; }
.cursor-pointer{ cursor:pointer; }
.leading-relaxed{ line-height:1.625; }

.grid-cols-1{ grid-template-columns: repeat(1,minmax(0,1fr)); }
.grid-cols-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
.grid-cols-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
.grid-cols-4{ grid-template-columns: repeat(4,minmax(0,1fr)); }

.gap-0{ gap:0; } 
.gap-1{ gap:.25rem; } 
.gap-1\.5{ gap:.375rem; } 
.gap-2{ gap:.5rem; } 
.gap-3{ gap:.75rem; } 
.gap-4{ gap:1rem; } 
.gap-6{ gap:1.5rem; } 
.gap-x-8{ column-gap:2rem; } 
.gap-y-2{ row-gap:.5rem; }

.p-2{ padding:.5rem; } .p-3{ padding:.75rem; } .p-4{ padding:1rem; } .p-6{ padding:1.5rem; } .p-8{ padding:2rem; }
.px-2{ padding-left:.5rem; padding-right:.5rem; } 
.px-3{ padding-left:.75rem; padding-right:.75rem; } 
.px-4{ padding-left:1rem; padding-right:1rem; } 
.px-6{ padding-left:1.5rem; padding-right:1.5rem; } 
.px-1\.5{ padding-left:.375rem; padding-right:.375rem; }
.py-1{ padding-top:.25rem; padding-bottom:.25rem; } 
.py-2{ padding-top:.5rem; padding-bottom:.5rem; } 
.py-3{ padding-top:.75rem; padding-bottom:.75rem; } 
.py-0\.5{ padding-top:.125rem; padding-bottom:.125rem; } 
.py-1\.5{ padding-top:.375rem; padding-bottom:.375rem; }
.pt-2{ padding-top:.5rem; } .pt-3{ padding-top:.75rem; } .pb-0{ padding-bottom:0; }

.m-6{ margin:1.5rem; }
.mt-1{ margin-top:.25rem; } .mt-2{ margin-top:.5rem; } .mt-3{ margin-top:.75rem; } .mt-4{ margin-top:1rem; } .mt-6{ margin-top:1.5rem; } .mt-8{ margin-top:2rem; }
.mb-1{ margin-bottom:.25rem; } .mb-2{ margin-bottom:.5rem; } .mb-3{ margin-bottom:.75rem; } .mb-4{ margin-bottom:1rem; } .mb-6{ margin-bottom:1.5rem; } .mb-8{ margin-bottom:2rem; } .mb-12{ margin-bottom:3rem; }
.mx-auto{ margin-left:auto; margin-right:auto; }

.space-y-1 > :not([hidden]) ~ :not([hidden]){ margin-top:.25rem; }
.space-y-2 > :not([hidden]) ~ :not([hidden]){ margin-top:.5rem; }
.space-y-3 > :not([hidden]) ~ :not([hidden]){ margin-top:.75rem; }
.space-y-6 > :not([hidden]) ~ :not([hidden]){ margin-top:1.5rem; }

.w-full{ width:100%; } .w-1{ width:.25rem; } .w-2{ width:.5rem; } .w-3{ width:.75rem; } .w-8{ width:2rem; }
.h-0\.5{ height:.125rem; } .h-2{ height:.5rem; } .h-3{ height:.75rem; } .h-8{ height:2rem; }

.min-h-screen{ min-height:100vh; }
.min-w-\[200px\]{ min-width:200px; }
.max-w-\[1600px\]{ max-width:1600px; }

.rounded{ border-radius:.25rem; }
.rounded-lg{ border-radius:.5rem; }
.rounded-xl{ border-radius:.75rem; }
.rounded-full{ border-radius:9999px; }

.border{ border-width:1px; border-style:solid; border-color: var(--border-secondary); }

.text-center{ text-align:center; }
.text-xs{ font-size:.75rem; line-height:1rem; }
.text-sm{ font-size:.875rem; line-height:1.25rem; }
.text-lg{ font-size:1.125rem; line-height:1.75rem; }
.text-xl{ font-size:1.25rem; line-height:1.75rem; }
.text-2xl{ font-size:1.5rem; line-height:2rem; }
.text-3xl{ font-size:1.875rem; line-height:2.25rem; }
.text-4xl{ font-size:2.25rem; line-height:2.5rem; }
.text-5xl{ font-size:3rem; line-height:1; }
.text-\[7px\]{ font-size:7px; line-height:1; }
.text-\[8px\]{ font-size:8px; line-height:1; }
.text-\[9px\]{ font-size:9px; line-height:1; }
.text-\[10px\]{ font-size:10px; line-height:1.15; }

.font-sans{ font-family: var(--font-sans); }
.font-semibold{ font-weight:600; }
.font-bold{ font-weight:700; }
.font-extrabold{ font-weight:800; }
.font-black{ font-weight:900; }

.uppercase{ text-transform:uppercase; }
.tracking-wide{ letter-spacing:.025em; }
.tracking-wider{ letter-spacing:.05em; }

/* Responsive helpers (match common Tailwind breakpoints) */
@media (min-width: 768px){
  .md\:grid-cols-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
  .md\:grid-cols-4{ grid-template-columns: repeat(4,minmax(0,1fr)); }
}
@media (min-width: 1024px){
  .lg\:grid-cols-2{ grid-template-columns: repeat(2,minmax(0,1fr)); }
  .lg\:grid-cols-3{ grid-template-columns: repeat(3,minmax(0,1fr)); }
  .lg\:col-span-2{ grid-column: span 2 / span 2; }
  .lg\:col-span-3{ grid-column: span 3 / span 3; }
}

/* ============================================================
   UI FACELIFT (polish, accessibility, slider UX)
   ============================================================ */

/* Top chrome: slightly glassy */
.main-header{
  backdrop-filter: blur(14px);
  background: var(--bg-card);
  background: color-mix(in srgb, var(--bg-card) 86%, transparent);
}
.main-header::after{
  content:"";
  position:absolute;
  inset:auto 0 0 0;
  height:1px;
  background: linear-gradient(90deg, transparent, rgba(var(--accent-rgb),.35), transparent);
  pointer-events:none;
}
.quick-action-bar{
  backdrop-filter: blur(14px);
  background: var(--bg-card);
  background: color-mix(in srgb, var(--bg-card) 86%, transparent);
}

/* Buttons: consistent feel */
button{ -webkit-tap-highlight-color: transparent; }
.quick-action-btn, .quick-preset-btn, .tab-btn, .save-btn, .load-btn, .clear-btn{
  border-radius: 14px;
}
.quick-action-btn:active, .quick-preset-btn:active, .tab-btn:active{ transform: translateY(1px); }

/* Tabs: icons + better scan */
.tab-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
}
.tab-btn-inner{ display:flex; align-items:center; gap:12px; justify-content:center; }
.tab-btn .tab-icon{
  width:20px;
  height:20px;
  opacity:.9;
}

/* Range sliders: filled track + value bubble */
.slider{
  background: linear-gradient(to right, var(--accent) 0%, var(--accent) 50%, var(--slider-track) 50%, var(--slider-track) 100%);
}
.slider::-webkit-slider-runnable-track{ background: transparent; }
.slider::-moz-range-track{ background: transparent; }

.slider-wrap{
  position: relative;
}
.slider-bubble{
  position:absolute;
  top:-14px;
  left:0;
  transform: translate(-50%, -6px);
  padding: 5px 10px;
  font-size: var(--text-sm);
  font-weight: 800;
  letter-spacing: .06em;
  text-transform: uppercase;
  border-radius: 999px;
  background: rgba(0,0,0,.65);
  border: 1px solid rgba(var(--accent-rgb), .35);
  color: #fff;
  box-shadow: 0 10px 28px rgba(0,0,0,.35);
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease, transform .15s ease;
  white-space: nowrap;
}
.slider-wrap:hover .slider-bubble,
.slider-wrap.dragging .slider-bubble{
  opacity: 1;
  transform: translate(-50%, 0);
}

/* Modal: better mobile ergonomics */
.slider-modal{
  max-height: min(86vh, 900px);
}
.slider-modal-header{
  position: sticky;
  top: 0;
  z-index: 2;
  backdrop-filter: blur(14px);
}

/* Motion safety */
@media (prefers-reduced-motion: reduce){
  *,*::before,*::after{
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* Analytics PRO Card Grid */
.analytics-metric-card {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
  padding: 10px;
  text-align: center;
}
.analytics-subtabs {
  display: flex;
  gap: 4px;
  margin-bottom: 12px;
  background: var(--bg-input);
  padding: 4px;
  border-radius: 8px;
}
.analytics-subtab {
  flex: 1;
  padding: 8px 12px;
  font-size: var(--text-xs);
  font-weight: 600;
  color: var(--text-muted);
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.analytics-subtab:hover {
  color: var(--text-primary);
  background: rgba(234,179,8,0.1);
}
.analytics-subtab.active {
  color: var(--accent);
  background: var(--bg-card);
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.analytics-subtab-panel {
  display: none;
}
.analytics-subtab-panel.active {
  display: block;
}
.analytics-metric-box {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}
.analytics-card {
  background: var(--bg-card);
  border: 1px solid var(--border-subtle);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.analytics-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.analytics-card-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: var(--bg-input);
  border-bottom: 1px solid var(--border-subtle);
  font-size: var(--text-sm);
  font-weight: 700;
  color: var(--text-primary);
}
.analytics-card-header svg { color: var(--accent); }
.analytics-card-body {
  padding: 12px;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.analytics-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--bg-input);
  border-top: 1px solid var(--border-subtle);
  font-size: var(--text-2xs);
  color: var(--text-muted);
}
.analytics-card-footer svg { color: var(--text-muted); }
.analytics-card-stats {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.analytics-card-stats > div {
  display: flex;
  justify-content: space-between;
  font-size: var(--text-2xs);
}
.analytics-card-stats .stat-label { color: var(--text-muted); }
.analytics-card-stats .stat-value { color: var(--text-primary); font-weight: 600; }

/* Large Analytics Cards */
.analytics-card-lg {
    background: var(--bg-card);
    border: 1px solid var(--border-subtle);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    min-height: 320px;
}
.analytics-card-lg:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}
.analytics-card-lg-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 18px;
    background: var(--bg-input);
    border-radius: 12px 12px 0 0;
    font-size: var(--text-md);
    font-weight: 700;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-subtle);
}
.analytics-card-lg-header svg { color: var(--accent); }
.analytics-card-lg-body {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.analytics-card-lg-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 18px;
    background: var(--bg-input);
    border-radius: 0 0 12px 12px;
    font-size: var(--text-sm);
    color: var(--text-muted);
    border-top: 1px solid var(--border-subtle);
}
.analytics-card-lg-footer svg { color: var(--text-muted); }
.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: var(--text-base);
    border-bottom: 1px solid var(--border-subtle);
}
.stat-row:last-child { border-bottom: none; }
.stat-row span:first-child { color: var(--text-muted); }
.stat-row span:last-child { color: var(--text-primary); font-weight: 600; }
.stat-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    background: var(--bg-input);
    border-radius: 8px;
    gap: 4px;
}
.stat-box span:first-child { font-size: var(--text-xs); color: var(--text-muted); text-transform: uppercase; }
.stat-box span:last-child { font-size: var(--text-lg); font-weight: 700; color: var(--text-primary); }

/* Analytics Side Navigation */
.analytics-layout {
    display: flex;
    gap: 0;
    height: calc(100vh - 140px);
    overflow: hidden;
}
.analytics-sidenav {
    width: 200px;
    min-width: 200px;
    background: var(--bg-card);
    border-right: 1px solid var(--border-subtle);
    padding: 16px 0;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}
.analytics-sidenav-title {
    font-size: var(--text-2xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-muted);
    padding: 8px 16px;
    margin-bottom: 4px;
}
.analytics-sidenav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    font-size: var(--text-base);
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease;
    border-left: 3px solid transparent;
}
.analytics-sidenav-item:hover {
    background: rgba(234, 179, 8, 0.08);
    color: var(--text-primary);
}
.analytics-sidenav-item.active {
    background: rgba(234, 179, 8, 0.12);
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 600;
}
.analytics-sidenav-item svg {
    width: 16px;
    height: 16px;
    opacity: 0.7;
}
.analytics-sidenav-item.active svg {
    opacity: 1;
    color: var(--accent);
}
.analytics-sidenav-divider {
    height: 1px;
    background: var(--border-subtle);
    margin: 12px 16px;
}
.analytics-main-content {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    scroll-behavior: smooth;
}
.analytics-section {
    scroll-margin-top: 20px;
}
body.light-theme .analytics-sidenav {
    background: #f8fafc;
    border-right-color: #e2e8f0;
}
body.light-theme .analytics-sidenav-item:hover {
    background: rgba(99, 102, 241, 0.08);
}
body.light-theme .analytics-sidenav-item.active {
    background: rgba(99, 102, 241, 0.12);
    color: #6366f1;
    border-left-color: #6366f1;
}
body.light-theme .analytics-modal-overlay {
    background: rgba(255, 255, 255, 0.95);
}
body.light-theme .analytics-modal {
    background: #ffffff;
    border-color: #e2e8f0;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}
body.light-theme .analytics-modal-header {
    background: #f8fafc;
    border-bottom-color: #e2e8f0;
}

/* Mini Visualizations */
.analytics-mini-radar { height: 60px; display: flex; justify-content: center; }
.analytics-mini-gauge { height: 45px; }
.analytics-mini-chart { height: 35px; }
.analytics-mini-matrix { display: flex; justify-content: center; padding: 4px 0; }
.mini-matrix-grid {
  display: grid;
  grid-template-columns: repeat(3, 20px);
  grid-template-rows: repeat(3, 16px);
  gap: 2px;
}
.mini-matrix-grid > div { border-radius: 2px; }
.mini-matrix-grid .matrix-current { position: relative; }
.mini-matrix-grid .matrix-current::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 6px; height: 6px;
  background: var(--accent);
  border-radius: 50%;
  border: 1px solid #fff;
}
.analytics-mini-tornado { display: flex; flex-direction: column; gap: 4px; }
.tornado-bar { display: flex; height: 8px; justify-content: center; }
.tornado-neg { background: #ef4444; border-radius: 2px 0 0 2px; }
.tornado-pos { background: #10b981; border-radius: 0 2px 2px 0; }
.analytics-mini-bars { display: flex; flex-direction: column; gap: 6px; }
.mini-bar-row { display: flex; align-items: center; gap: 6px; }
.mini-bar-label { font-size: var(--text-2xs); color: var(--text-muted); width: 40px; }
.mini-bar-track { flex: 1; height: 6px; background: var(--bg-input); border-radius: 3px; position: relative; }
.mini-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; }
.mini-bar-avg { position: absolute; top: -2px; width: 2px; height: 10px; background: var(--text-muted); }
.analytics-mini-stack { display: flex; flex-direction: column; gap: 6px; }
.stack-position { display: flex; align-items: center; gap: 8px; }
.stack-badge { font-size: var(--text-2xs); font-weight: 700; padding: 2px 6px; background: rgba(234,179,8,0.2); color: var(--accent); border-radius: 3px; }
.stack-amount { font-size: var(--text-lg); font-weight: 800; color: var(--text-primary); }
.stack-bar-container { height: 6px; background: var(--bg-input); border-radius: 3px; }
.stack-bar-fill { height: 100%; background: var(--accent); border-radius: 3px; }
.analytics-mini-sparkline { height: 30px; display: flex; align-items: flex-end; gap: 2px; }
.spark-bar { flex: 1; background: var(--accent); border-radius: 2px 2px 0 0; min-height: 3px; }
.analytics-mini-amort { height: 35px; }
.analytics-mini-quality { display: flex; justify-content: center; }
.quality-score-ring { width: 55px; height: 55px; }
.analytics-mini-profit { display: flex; flex-direction: column; gap: 4px; }
.profit-bar { height: 6px; background: var(--bg-input); border-radius: 3px; overflow: hidden; }
.profit-fill { height: 100%; border-radius: 3px; }
.profit-fill.gross { background: #10b981; }
.profit-fill.loss { background: #ef4444; }
.profit-fill.net { background: var(--accent); }
.analytics-mini-checklist { display: flex; flex-direction: column; gap: 4px; }
.check-item { display: flex; align-items: center; gap: 6px; font-size: var(--text-2xs); color: var(--text-secondary); }
.check-item.pending { color: #eab308; }

/* Analytics Modal */
.analytics-modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  backdrop-filter: blur(8px);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  padding: 40px;
}
.analytics-modal-overlay.active { display: flex; }
.analytics-modal {
  background: var(--bg-card);
  border: 1px solid var(--border-primary);
  border-radius: 12px;
  width: 100%;
  max-width: 1000px;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
}
.analytics-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  background: var(--bg-input);
  border-bottom: 1px solid var(--border-subtle);
}
.analytics-modal-header h3 {
  font-size: var(--text-lg) !important;
}
.analytics-modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  transition: all 0.2s;
}
.analytics-modal-close svg {
  width: 20px;
  height: 20px;
}
.analytics-modal-close:hover { background: rgba(239,68,68,0.2); color: #ef4444; }
.analytics-modal-body {
  padding: 20px;
  overflow-y: auto;
  flex: 1;
  font-size: var(--text-base);
}
/* Modal content styling */
.analytics-modal-body .text-xs { font-size: var(--text-sm) !important; }
.analytics-modal-body .text-\[10px\] { font-size: var(--text-sm) !important; }
.analytics-modal-body .text-\[9px\] { font-size: var(--text-xs) !important; }
.analytics-modal-body .rounded-lg { border-radius: 8px !important; }

/* Analytics Mobile Override - placed after base styles */
@media (max-width: 768px) {
  .analytics-sidenav {
    display: none !important;
  }
  .analytics-layout {
    flex-direction: column !important;
    height: auto !important;
  }
  .analytics-main-content {
    width: 100% !important;
    padding: 12px !important;
    height: auto !important;
    overflow: visible !important;
  }
  .analytics-metrics-grid {
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 8px !important;
  }
  .analytics-metrics-grid > div {
    padding: 10px 6px !important;
  }
  .analytics-metrics-grid > div > div:nth-child(2) {
    font-size: var(--text-2xl) !important;
  }
  .analytics-cards-grid {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }
  .analytics-card-lg {
    min-height: auto !important;
  }
  .analytics-card-lg-body {
    padding: 12px !important;
  }
  .analytics-modal-overlay {
    padding: 10px !important;
  }
  .analytics-modal {
    width: 95vw !important;
    max-width: 95vw !important;
    max-height: 85vh !important;
  }
}

</style>
</head>
<body class="min-h-screen font-sans">
<!-- MAIN HEADER -->
<header class="main-header">
<svg fill="none" viewbox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
<!-- Back half of ring (behind planet) -->
<ellipse cx="32" cy="32" fill="none" rx="28" ry="8" stroke="#ea580c" stroke-dasharray="70 140" stroke-width="2.5" transform="rotate(-20 32 32)"></ellipse>
<!-- Planet -->
<circle cx="32" cy="32" fill="#eab308" r="12"></circle>
<!-- Front half of ring (in front of planet) -->
<ellipse cx="32" cy="32" fill="none" rx="28" ry="8" stroke="#ea580c" stroke-dasharray="70 140" stroke-dashoffset="-70" stroke-width="2.5" transform="rotate(-20 32 32)"></ellipse>
<!-- Orbiting moon -->
<circle class="orbiting-moon" cx="32" cy="32" fill="#a855f7" r="4"></circle>
</svg>
<h1><span style="color: #ffffff;">ABLES</span><span style="color: #9ca3af;">AI</span> <span style="font-size: 0.5em; font-weight: 600; color: var(--accent); vertical-align: super;">PRO</span></h1>
<div class="header-actions">
<button class="info-btn" id="themeToggleBtn" onclick="toggleTheme()" title="Switch to Light Mode" type="button">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
</button>
<button class="info-btn" onclick="switchTab('model', event)" title="Model Info" type="button">
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<circle cx="12" cy="12" r="10"></circle>
<path d="M12 16v-4"></path>
<path d="M12 8h.01"></path>
</svg>
</button>
<button class="settings-btn" onclick="openSettings()" title="Settings" type="button">
<svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
<circle cx="12" cy="12" r="3"></circle>
</svg>
</button>
</div>
</header>
<!-- TAB NAVIGATION -->
<nav class="tab-nav" role="tablist">
<button aria-controls="tab-calculator" aria-selected="true" class="tab-btn active" id="tabbtn-calculator" onclick="switchTab('calculator', event)" role="tab" tabindex="0" type="button"><span class="tab-btn-inner"><svg aria-hidden="true" class="tab-icon" viewbox="0 0 24 24"><path d="M7 2h10a2 2 0 0 1 2 2v3H5V4a2 2 0 0 1 2-2Zm12 7H5v11a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V9Zm-9 3h4v2H10v-2Zm0 4h7v2h-7v-2Z" fill="currentColor"></path></svg><span class="tab-label">MODEL SCORE</span></span></button>
<button aria-controls="tab-override" aria-selected="false" class="tab-btn" id="tabbtn-override" onclick="switchTab('override', event)" role="tab" tabindex="-1" type="button"><span class="tab-btn-inner"><svg aria-hidden="true" class="tab-icon" viewbox="0 0 24 24"><path d="M3 6h10v2H3V6Zm0 10h10v2H3v-2Zm0-5h18v2H3v-2Zm14-5h4v2h-4V6Zm0 10h4v2h-4v-2Z" fill="currentColor"></path></svg><span class="tab-label">OFFER BUILDER</span></span></button>
<button aria-controls="tab-analytics" aria-selected="false" class="tab-btn tab-pro" id="tabbtn-analytics" onclick="switchTab('analytics', event)" role="tab" tabindex="-1" type="button"><span class="tab-btn-inner"><svg aria-hidden="true" class="tab-icon" viewbox="0 0 24 24"><path d="M4 19h16v2H2V3h2v16Zm4-2H6V9h2v8Zm5 0h-2V5h2v12Zm5 0h-2v-6h2v6Z" fill="currentColor"></path></svg><span class="tab-label">ANALYTICS</span></span></button>
<button aria-controls="tab-compare" aria-selected="false" class="tab-btn tab-pro" id="tabbtn-compare" onclick="switchTab('compare', event)" role="tab" tabindex="-1" type="button"><span class="tab-btn-inner"><svg aria-hidden="true" class="tab-icon" viewbox="0 0 24 24"><path d="M10 3H5a2 2 0 0 0-2 2v14h7V3Zm11 0h-9v16h9V5a2 2 0 0 0-2-2Zm0 18H3v2h18v-2Z" fill="currentColor"></path></svg><span class="tab-label">COMPARE</span></span></button>
<button aria-controls="tab-reports" aria-selected="false" class="tab-btn tab-pro" id="tabbtn-reports" onclick="switchTab('reports', event)" role="tab" tabindex="-1" type="button"><span class="tab-btn-inner"><svg aria-hidden="true" class="tab-icon" viewbox="0 0 24 24"><path d="M6 2h9l5 5v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V8h4.5L14 3.5ZM8 12h8v2H8v-2Zm0 4h8v2H8v-2Zm0-8h4v2H8V8Z" fill="currentColor"></path></svg><span class="tab-label">REPORTS</span></span></button>
<button aria-controls="tab-send" aria-selected="false" class="tab-btn tab-pro" id="tabbtn-send" onclick="switchTab('send', event)" role="tab" tabindex="-1" type="button"><span class="tab-btn-inner"><svg aria-hidden="true" class="tab-icon" viewbox="0 0 24 24"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"></path></svg><span class="tab-label">SEND</span></span></button>
</nav>
<!-- QUICK ACTION BAR -->
<div class="quick-action-bar">
<div class="quick-actions-left">
<button class="quick-preset-btn" onclick="loadPreset('strong-retail')" title="Strong Retail Profile" type="button">
<span class="preset-icon preset-icon-retail">SR</span> Strong Retail
      </button>
<button class="quick-preset-btn" onclick="loadPreset('new-business')" title="New Business (3-6 mo)" type="button">
<span class="preset-icon preset-icon-new">NB</span> New Business
      </button>
<button class="quick-preset-btn" onclick="loadPreset('established')" title="Established (5+ years)" type="button">
<span class="preset-icon preset-icon-established">ES</span> Established
      </button>
<button class="quick-preset-btn" onclick="loadPreset('risky-restaurant')" title="Risky Restaurant Profile" type="button">
<span class="preset-icon preset-icon-risky">RR</span> Risky Restaurant
      </button>
<button class="quick-preset-btn" onclick="loadPreset('high-volume')" title="High Volume Merchant" type="button">
<span class="preset-icon preset-icon-volume">HV</span> High Volume
      </button>
</div>
<div class="quick-actions-right">
<button class="quick-action-btn" onclick="saveDeal()" title="Save Deal (Ctrl+S)" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        Save
      </button>
<button class="quick-action-btn" onclick="loadDeal()" title="Load Deal (Ctrl+O)" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
        Load
      </button>
<button class="quick-action-btn" onclick="addToCompare()" title="Add to Compare (Ctrl+D)" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><rect height="7" width="7" x="3" y="3"></rect><rect height="7" width="7" x="14" y="3"></rect><rect height="7" width="7" x="14" y="14"></rect><rect height="7" width="7" x="3" y="14"></rect></svg>
        Compare
      </button>
<button class="quick-action-btn primary" onclick="exportPDF()" title="Export PDF (Ctrl+P)" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" x2="12" y1="18" y2="12"></line><line x1="9" x2="15" y1="15" y2="15"></line></svg>
        Export PDF
      </button>
</div>
</div>
<!-- CALCULATOR TAB -->
<div aria-hidden="false" aria-labelledby="tabbtn-calculator" class="tab-panel active" id="tab-calculator" role="tabpanel" tabindex="0">
<div class="p-6 pb-0 max-w-[1600px] mx-auto">
<!-- Alternative Offer Scenarios (MODEL SCORE tab) -->
<div class="card p-4 mb-6 mx-6" id="calcOfferScenariosCard">
<div class="flex items-center gap-3 mb-3">
<div class="section-indicator"></div>
<h3 class="section-title" style="font-size: var(--text-base);">Alternative Offer Scenarios</h3>
</div>
<div class="offer-scenarios" id="calcOfferScenarios">
<div class="offer-card" id="calcOfferCardConservative" onclick="applyOffer('conservative')">
<div class="selected-indicator" style="background: #3b82f6;">
<svg fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24" width="14" height="14"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</div>
<div class="offer-card-header">
<span class="offer-type">Conservative</span>
<span class="offer-badge conservative">Safe</span>
</div>
<div class="offer-amount" id="calcOfferConservativeAmt">$0</div>
<div class="offer-detail" id="calcOfferConservativeTerm">0 months</div>
<div class="offer-detail" id="calcOfferConservativePmt">$0/day</div>
<div class="offer-expanded">
<div class="offer-expanded-row">
<span class="offer-expanded-label">Factor Rate</span>
<span class="offer-expanded-value" id="calcOfferConservativeFactor">1.00x</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Total Payback</span>
<span class="offer-expanded-value" id="calcOfferConservativePayback">$0</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Est. Holdback</span>
<span class="offer-expanded-value" id="calcOfferConservativeHoldback">0%</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Risk Level</span>
<span class="offer-expanded-value" style="color: #3b82f6;">Low</span>
</div>
<button class="offer-load-btn conservative-btn" onclick="event.stopPropagation(); loadOfferToOverride('conservative')">Load into Offer Builder</button>
</div>
</div>
<div class="offer-card recommended" id="calcOfferCardRecommended" onclick="applyOffer('recommended')">
<div class="selected-indicator">
<svg fill="none" stroke="#000" stroke-width="3" viewBox="0 0 24 24" width="14" height="14"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</div>
<div class="offer-card-header">
<span class="offer-type">Recommended</span>
<span class="offer-badge recommended">Best</span>
</div>
<div class="offer-amount" id="calcOfferRecommendedAmt">$0</div>
<div class="offer-detail" id="calcOfferRecommendedTerm">0 months</div>
<div class="offer-detail" id="calcOfferRecommendedPmt">$0/day</div>
<div class="offer-expanded">
<div class="offer-expanded-row">
<span class="offer-expanded-label">Factor Rate</span>
<span class="offer-expanded-value" id="calcOfferRecommendedFactor">1.00x</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Total Payback</span>
<span class="offer-expanded-value" id="calcOfferRecommendedPayback">$0</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Est. Holdback</span>
<span class="offer-expanded-value" id="calcOfferRecommendedHoldback">0%</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Risk Level</span>
<span class="offer-expanded-value" style="color: var(--accent);">Standard</span>
</div>
<button class="offer-load-btn" onclick="event.stopPropagation(); loadOfferToOverride('recommended')">Load into Offer Builder</button>
</div>
</div>
<div class="offer-card" id="calcOfferCardAggressive" onclick="applyOffer('aggressive')">
<div class="selected-indicator" style="background: #ef4444;">
<svg fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24" width="14" height="14"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</div>
<div class="offer-card-header">
<span class="offer-type">Aggressive</span>
<span class="offer-badge aggressive">Risk</span>
</div>
<div class="offer-amount" id="calcOfferAggressiveAmt">$0</div>
<div class="offer-detail" id="calcOfferAggressiveTerm">0 months</div>
<div class="offer-detail" id="calcOfferAggressivePmt">$0/day</div>
<div class="offer-expanded">
<div class="offer-expanded-row">
<span class="offer-expanded-label">Factor Rate</span>
<span class="offer-expanded-value" id="calcOfferAggressiveFactor">1.00x</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Total Payback</span>
<span class="offer-expanded-value" id="calcOfferAggressivePayback">$0</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Est. Holdback</span>
<span class="offer-expanded-value" id="calcOfferAggressiveHoldback">0%</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Risk Level</span>
<span class="offer-expanded-value" style="color: #ef4444;">Higher</span>
</div>
<button class="offer-load-btn aggressive-btn" onclick="event.stopPropagation(); loadOfferToOverride('aggressive')">Load into Offer Builder</button>
</div>
</div>
</div>
</div>
<!-- CREDIT ENGINE SECTION -->
<div class="card p-6 mb-6" id="calcCreditEngineCard">
<div class="flex items-center gap-3 mb-6">
<div class="section-indicator"></div>
<h3 class="section-title">ABLESAI PRO Credit Engine</h3>
</div>
<div class="score-panel" id="scorePanelTop">
<div class="score-header" id="scoreHeaderBgTop" style="background: linear-gradient(135deg, rgba(234,179,8,0.15) 0%, rgba(234,179,8,0.05) 100%);">
<div style="display: flex; align-items: center; justify-content: space-between;">
<div>
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);">ABLESAI Score</div>
<div id="scoreValueTop" style="font-size: 30px; font-weight: 900; color: #eab308;">62<span style="font-size: var(--text-2xl); font-weight: 600; color: var(--text-muted);">/100</span></div>
</div>
<div style="text-align: center;">
<div id="tierLetterTop" style="font-size: var(--text-6xl); font-weight: 900; color: #eab308;">C</div>
<div id="tierLabelTop" style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; color: var(--text-muted);">Mid-Prime</div>
</div>
</div>
</div>
<div class="score-body">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; color: var(--text-muted);">Score Breakdown</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotCreditTop" style="width: 8px; height: 8px; border-radius: 50%; background: #eab308;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Credit Score</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barCreditTop" style="width: 50%; background: #eab308;"></div></div>
<span data-component="credit" id="scoreCreditTop" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">15/30</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotBehaviorTop" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Behavior (<span id="eventsLabelTop">3</span> events)</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barBehaviorTop" style="width: 70%; background: #10b981;"></div></div>
<span data-component="behavior" id="scoreBehaviorTop" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">21/30</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotRevenueTop" style="width: 8px; height: 8px; border-radius: 50%; background: #eab308;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Revenue</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barRevenueTop" style="width: 46%; background: #eab308;"></div></div>
<span data-component="revenue" id="scoreRevenueTop" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">9/20</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotStabilityTop" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Stability</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barStabilityTop" style="width: 70%; background: #10b981;"></div></div>
<span data-component="stability" id="scoreStabilityTop" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">7/10</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotBufferTop" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Buffer (<span id="bufferPctTop">16</span>%)</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barBufferTop" style="width: 100%; background: #10b981;"></div></div>
<span data-component="buffer" id="scoreBufferTop" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">10/10</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotCollectTop" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Collectibility</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barCollectTop" style="width: 100%; background: #10b981;"></div></div>
<span data-component="collectibility" id="scoreCollectTop" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">15/15</span>
</div>
</div>
<div class="tier-scale">
<div class="tier-seg tier-a">A 80+</div>
<div class="tier-seg tier-b">B 65+</div>
<div class="tier-seg tier-c">C 50+</div>
<div class="tier-seg tier-d">D 35+</div>
<div class="tier-seg tier-e">E &lt;35</div>
</div>
</div>
</div>
<!-- Score & Offer Summary Row -->
<div class="p-3 flex items-center justify-between flex-wrap gap-3 rounded-lg mb-2 mt-3" style="background: var(--bg-card-inner);">
<div class="flex items-center gap-4 flex-1">
<div class="text-center px-3 py-1 rounded-xl flex-shrink-0" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">Tier</div>
<div class="text-2xl font-black" id="calcTierDisplay" style="color: var(--accent);">C</div>
</div>
<div class="flex-1 min-w-[180px]">
<div class="flex items-center justify-between mb-1">
<div class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">ABLESAI Score</div>
<div class="text-base font-extrabold" style="color: var(--text-primary);"><span id="calcScoreDisplay">62</span>/100</div>
</div>
<div class="summary-score-bar">
<div class="summary-score-fill" id="calcScoreFill" style="width: 62%;"></div>
<div class="summary-score-marker" data-score="62" id="calcScoreMarker" style="left: 62%;"></div>
</div>
<div class="flex justify-between mt-1">
<span class="text-[8px] font-bold" style="color: #ef4444;">E</span>
<span class="text-[8px] font-bold" style="color: #f97316;">D</span>
<span class="text-[8px] font-bold" style="color: #eab308;">C</span>
<span class="text-[8px] font-bold" style="color: #22c55e;">B</span>
<span class="text-[8px] font-bold" style="color: #10b981;">A</span>
</div>
</div>
</div>
<div class="flex gap-4 flex-shrink-0">
<div class="text-center">
<div class="text-[10px] font-bold uppercase" style="color: var(--text-muted);">Funding</div>
<div class="text-base font-bold" id="calcSummaryFunding" style="color: var(--text-primary);">$17,500</div>
</div>
<div class="text-center">
<div class="text-[10px] font-bold uppercase" style="color: var(--text-muted);">Factor</div>
<div class="text-base font-bold" id="calcSummaryFactor" style="color: var(--text-primary);">1.32x</div>
</div>
<div class="text-center">
<div class="text-[10px] font-bold uppercase" style="color: var(--text-muted);">Term</div>
<div class="text-base font-bold" id="calcSummaryTerm" style="color: var(--text-primary);">9 mo</div>
</div>
</div>
</div>
<!-- Risk Analytics Section -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-2" id="calcRiskIndicators">
<!-- Risk Impact Metrics -->
<div class="p-3 rounded-lg" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Risk Impact</div>
<div class="grid grid-cols-3 gap-2">
<div class="text-center p-2 rounded-lg" style="background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.3);">
<div class="text-lg font-extrabold" id="calcPdValue" style="color: #eab308;">10.0%</div>
<div class="text-[9px] font-bold uppercase tracking-wide" style="color: #eab308; opacity: 0.8;">PD</div>
</div>
<div class="text-center p-2 rounded-lg" style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);">
<div class="text-lg font-extrabold" id="calcDscrValue" style="color: #10b981;">1.85x</div>
<div class="text-[9px] font-bold uppercase tracking-wide" style="color: #10b981; opacity: 0.8;">DSCR</div>
</div>
<div class="text-center p-2 rounded-lg" style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);">
<div class="text-lg font-extrabold" id="calcRiskLevel" style="color: #10b981;">Low</div>
<div class="text-[9px] font-bold uppercase tracking-wide" style="color: #10b981; opacity: 0.8;">Risk</div>
</div>
</div>
</div>
<!-- Probability of Default Gauge -->
<div class="p-3 rounded-lg" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Probability of Default</div>
<div class="gauge-container" style="transform: scale(0.75); transform-origin: top center; margin-bottom: -15px;">
<svg height="100" viewbox="0 0 180 100" width="180">
<path class="gauge-arc gauge-bg" d="M 20 80 A 60 60 0 0 1 160 80"></path>
<path class="gauge-arc gauge-fill" d="M 20 80 A 60 60 0 0 1 160 80" id="calcPdGaugeFill" stroke="#10b981" stroke-dasharray="0 188"></path>
<circle class="gauge-needle" cx="20" cy="80" id="calcPdNeedle" r="4"></circle>
</svg>
<div class="gauge-center-label">
<div class="text-lg font-extrabold" id="calcPdDisplay" style="color: var(--text-primary);">10.0%</div>
<div class="text-[8px] font-bold uppercase" style="color: var(--text-muted);">Est. PD</div>
</div>
</div>
<div class="pd-scale" style="margin-top: -20px;">
<span class="pd-scale-item" style="color: #10b981; font-size: var(--text-2xs);">Low</span>
<span class="pd-scale-item" style="color: #eab308; font-size: var(--text-2xs);">Med</span>
<span class="pd-scale-item" style="color: #f97316; font-size: var(--text-2xs);">High</span>
<span class="pd-scale-item" style="color: #ef4444; font-size: var(--text-2xs);">Severe</span>
</div>
</div>
<!-- DSCR Impact -->
<div class="p-3 rounded-lg" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Debt Service Coverage</div>
<div class="dscr-bar mb-2">
<div class="text-[9px] font-bold" style="color: var(--text-muted);">0x</div>
<div class="dscr-bar-track">
<div class="dscr-marker" data-label="1x" style="left: 33%;"></div>
<div class="dscr-marker" data-label="1.5x" style="left: 50%;"></div>
<div class="dscr-marker" data-label="2x" style="left: 66%;"></div>
<div class="dscr-bar-fill" id="calcDscrBarFill" style="width: 62%; background: #10b981;">
<span class="text-[9px] font-bold" id="calcDscrBarValue" style="color: #000;">1.85x</span>
</div>
</div>
<div class="text-[9px] font-bold" style="color: var(--text-muted);">3x</div>
</div>
<div class="grid grid-cols-3 gap-2 text-center">
<div>
<div class="text-xs font-bold" id="calcDscrMonthlyRev" style="color: var(--text-primary);">$50,000</div>
<div class="text-[7px] font-bold uppercase" style="color: var(--text-muted);">Monthly Rev</div>
</div>
<div>
<div class="text-xs font-bold" id="calcDscrMonthlyDebt" style="color: var(--text-primary);">$2,574</div>
<div class="text-[7px] font-bold uppercase" style="color: var(--text-muted);">Monthly Debt</div>
</div>
<div>
<div class="text-xs font-bold" id="calcDscrRatio" style="color: #10b981;">1.85x</div>
<div class="text-[7px] font-bold uppercase" style="color: var(--text-muted);">DSCR</div>
</div>
</div>
<div class="mt-1 p-1.5 rounded-lg text-[8px]" id="calcDscrWarning" style="background: rgba(16, 185, 129, 0.1); color: #10b981; display: none;">
<strong>Healthy DSCR:</strong> Excellent revenue coverage for debt service.
            </div>
</div>
</div>
<!-- TWO COLUMN LAYOUT -->
<div class="calc-layout px-6 max-w-[1600px] mx-auto">
<!-- LEFT: INPUT PANEL -->
<div class="space-y-6 calc-controls-column" id="calcControlsPanel">
<div class="mobile-panel-handle" onclick="togglePanel('calcControlsPanel')">
<div class="drawer-handle-bar"></div>
<div class="drawer-label">
<div class="drawer-chevrons">
<div class="drawer-chevron"></div>
<div class="drawer-chevron"></div>
</div>
<span class="drawer-label-text"></span>
<div class="drawer-chevrons">
<div class="drawer-chevron"></div>
<div class="drawer-chevron"></div>
</div>
</div>
</div>
<!-- Input Sliders Card (this floats on mobile) -->
<div class="card p-4 sliders-card">
<div class="flex items-center gap-3 mb-4 sliders-header">
<div class="section-indicator"></div>
<h3 class="section-title">Input Parameters</h3>
</div>
<!-- Input Sliders -->
<div class="rounded-xl p-3 border mb-2" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block" style="color: var(--text-muted);">Credit Score (FICO)</label>
<div class="flex items-baseline gap-1.5 mb-2 mt-1">
<input class="editable-value" id="creditDisplay" onchange="updateFromInput('creditScore', this.value, 450, 850)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 70px;" type="text" value="650"/>
</div>
<input class="slider w-full" id="creditScore" max="850" min="450" oninput="calculate()" step="1" type="range" value="650"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>450</span>
<span>850</span>
</div>
</div>
<div class="rounded-xl p-3 border mb-2" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block" style="color: var(--text-muted);">Monthly Revenue</label>
<div class="flex items-baseline gap-1.5 mb-2 mt-1">
<input class="editable-value" id="revenueDisplay" onchange="updateFromInput('monthlyRevenue', this.value, 5000, 500000, true)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 120px;" type="text" value="$50,000"/>
</div>
<input class="slider w-full" id="monthlyRevenue" max="500000" min="5000" oninput="calculate()" step="1" type="range" value="50000"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>$5,000</span>
<span>$500,000</span>
</div>
</div>
<div class="rounded-xl p-3 border mb-2" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block" style="color: var(--text-muted);">Average Daily Balance</label>
<div class="flex items-baseline gap-1.5 mb-2 mt-1">
<input class="editable-value" id="balanceDisplay" onchange="updateFromInput('avgDailyBalance', this.value, 500, 100000, true)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 110px;" type="text" value="$8,000"/>
</div>
<input class="slider w-full" id="avgDailyBalance" max="100000" min="500" oninput="calculate()" step="1" type="range" value="8000"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>$500</span>
<span>$100,000</span>
</div>
</div>
<div class="rounded-xl p-3 border mb-2" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block" style="color: var(--text-muted);">Time in Business</label>
<div class="flex items-baseline gap-1.5 mb-2 mt-1">
<input class="editable-value" id="tibDisplay" onchange="updateFromInput('timeInBusiness', this.value, 3, 120)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 60px;" type="text" value="24"/>
<span class="text-sm font-semibold" style="color: var(--text-muted);">mo</span>
</div>
<input class="slider w-full" id="timeInBusiness" max="120" min="3" oninput="calculate()" step="1" type="range" value="24"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>3 mo</span>
<span>120 mo</span>
</div>
</div>
<div class="grid grid-cols-2 gap-2">
<div class="rounded-xl p-3 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block" style="color: var(--text-muted);">NSF / Overdrafts <span style="font-weight: 500; opacity: 0.7;">(90 Days)</span></label>
<div class="flex items-baseline gap-1.5 mb-2 mt-1">
<input class="editable-value" id="nsfDisplay" onchange="updateFromInput('nsfCount', this.value, 0, 15)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 50px;" type="text" value="0"/>
</div>
<input class="slider w-full" id="nsfCount" max="15" min="0" oninput="calculate()" step="1" type="range" value="0"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>0</span>
<span>15</span>
</div>
</div>
<div class="rounded-xl p-3 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block" style="color: var(--text-muted);">Negative Days <span style="font-weight: 500; opacity: 0.7;">(90 Days)</span></label>
<div class="flex items-baseline gap-1.5 mb-2 mt-1">
<input class="editable-value" id="negDaysDisplay" onchange="updateFromInput('negativeDays', this.value, 0, 15)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 50px;" type="text" value="0"/>
<span class="text-sm font-semibold" style="color: var(--text-muted);">days</span>
</div>
<input class="slider w-full" id="negativeDays" max="15" min="0" oninput="calculate()" step="1" type="range" value="0"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>0</span>
<span>15</span>
</div>
</div>
</div>
<!-- Existing Debt Payments -->
<div class="rounded-xl p-3 border mt-2" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<div class="flex items-center justify-between mb-2">
<label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Existing Debt Payments</label>
<div class="flex items-center gap-1">
<span class="text-[9px]" style="color: var(--text-muted);">paid</span>
<select class="text-[10px] font-semibold px-1.5 py-0.5 rounded" id="existingDebtFreqSelect" onchange="updateExistingDebtFreq()" style="background: var(--bg-primary); color: var(--text-muted); border: 1px solid var(--border-secondary);">
<option value="daily">daily</option>
<option value="weekly">weekly</option>
<option value="monthly">monthly</option>
</select>
</div>
</div>
<div class="flex items-baseline gap-1.5 mb-2">
<input class="editable-value" id="existingDebtDisplay" onchange="updateFromInput('existingDebt', this.value, 0, 15000, true)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 100px;" type="text" value="$0"/>
<span class="text-xs font-semibold" id="existingDebtFreqLabel" style="color: var(--text-muted);">/day</span>
</div>
<input class="slider w-full" id="existingDebt" max="15000" min="0" oninput="calculate()" step="1" type="range" value="0"/>
<div class="flex justify-between text-[10px] font-semibold mt-1 uppercase tracking-wider" style="color: var(--text-muted);">
<span>$0</span>
<span>$15,000</span>
</div>
<!-- Hidden radios for compatibility -->
<div style="display: none;">
<input checked="" name="existingDebtFreq" type="radio" value="daily"/>
<input name="existingDebtFreq" type="radio" value="weekly"/>
<input name="existingDebtFreq" type="radio" value="monthly"/>
</div>
</div>
<div class="mt-2">
<!-- Industry Dropdown -->
<div class="rounded-xl p-3 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
<label class="text-xs font-bold uppercase tracking-wide block mb-2" style="color: var(--text-muted);">Industry</label>
<select class="w-full px-2 py-1.5 rounded-lg text-xs font-semibold" id="industrySelect" onchange="handleIndustryChange()" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-secondary);">
<optgroup label="Standard Industries">
<option value="retail">Retail / E-commerce</option>
<option value="restaurant">Restaurant / Food Service</option>
<option value="construction">Construction / Contracting</option>
<option value="auto">Auto Repair / Dealer</option>
<option value="medical">Medical / Healthcare</option>
<option value="professional">Professional Services</option>
<option value="manufacturing">Manufacturing</option>
<option value="wholesale">Wholesale / Distribution</option>
<option value="beauty">Beauty / Salon / Spa</option>
<option value="fitness">Fitness / Gym</option>
<option value="other">Other (Standard)</option>
</optgroup>
<optgroup label="Restricted (Fleet Size Required)">
<option value="trucking">Trucking / Transportation</option>
</optgroup>
<optgroup label="Prohibited Industries">
<option value="gambling">Gambling / Casino</option>
<option value="adult">Adult Entertainment</option>
<option value="cannabis">Cannabis / CBD</option>
<option value="firearms">Firearms / Weapons</option>
<option value="crypto">Cryptocurrency</option>
<option value="collection">Debt Collection</option>
<option value="telemarketing">Telemarketing</option>
<option value="pawn">Pawn Shop</option>
</optgroup>
</select>
<div class="text-[9px] mt-1 font-semibold text-center" id="industryWarning" style="color: #ef4444; display: none;">Prohibited Industry</div>
<!-- Trucking Fleet Size (hidden by default) -->
<div id="truckingFleetSection" style="display: none; margin-top: 8px;">
<label class="text-[10px] font-bold uppercase tracking-wide block mb-1" style="color: var(--text-muted);">Fleet Size (# of Vehicles)</label>
<select class="w-full px-2 py-1.5 rounded-lg text-xs font-semibold" id="fleetSize" onchange="calculate()" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-secondary);">
<option value="1">1 vehicle</option>
<option value="2">2 vehicles</option>
<option value="3">3 vehicles</option>
<option value="4">4 vehicles</option>
<option value="5">5 vehicles</option>
<option value="6">6-10 vehicles</option>
<option value="11">11-20 vehicles</option>
<option value="21">21+ vehicles</option>
</select>
<div class="text-[9px] mt-1 font-semibold text-center" id="fleetWarning" style="color: #ef4444; display: none;">Minimum 5 vehicles required</div>
</div>
</div>
</div>
<!-- Recalculate Button -->
<button class="w-full mt-3 py-3 rounded-xl font-bold text-sm uppercase tracking-wider transition-all duration-200" id="recalcBtn" onclick="recalculateWithConfirm(this)" style="background: var(--accent); color: #000;" type="button">
            Recalculate
          </button>
<div class="text-center text-xs mt-1 font-semibold" id="calcConfirmMsg" style="color: #22c55e; opacity: 0; transition: opacity 0.3s;"></div>
</div>
</div>
<div class="calc-result-column">
<div class="card p-4">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Offer Preview</h3>
</div>
<div class="preview-sticky-wrapper">
<div class="calc-result-preview" id="resultCard">
<!-- Approved State -->
<div id="approvedSection">
<div class="calc-preview-header" id="resultHeader">
<div class="calc-preview-label" id="resultLabel">ABLESAI Tier C - Approved</div>
<div class="calc-preview-amount" id="offerFunding">$17,500</div>
</div>
<div class="calc-stats-grid">
<div class="calc-stat-cell">
<span class="calc-stat-label">Factor Rate</span>
<span class="calc-stat-value" id="offerFactor">1.32x</span>
</div>
<div class="calc-stat-cell">
<span class="calc-stat-label">Term</span>
<span class="calc-stat-value" id="offerTerm">9 Months</span>
</div>
<div class="calc-stat-cell">
<span class="calc-stat-label">Total Payback</span>
<span class="calc-stat-value" id="offerPayback">$23,100</span>
</div>
<div class="calc-stat-cell">
<span class="calc-stat-label" id="paymentFreqLabel">Daily Payment</span>
<span class="calc-stat-value accent" id="offerPayment">$117</span>
</div>
</div>
<!-- Holdback & APR Display -->
<div class="grid grid-cols-2 gap-0" style="border-bottom: 1px solid var(--border-secondary); background: rgba(var(--accent-rgb), 0.05);">
<div class="p-4 text-center" style="border-right: 1px solid var(--border-secondary);">
<div class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Holdback</div>
<div class="text-2xl font-extrabold" id="offerHoldback" style="color: var(--accent);">4.91%</div>
</div>
<div class="p-4 text-center">
<div class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Est. APR</div>
<div class="text-2xl font-extrabold" id="offerAPR" style="color: var(--accent);">42.7%</div>
</div>
</div>
<!-- Closing Breakdown -->
<div class="p-4" style="border-bottom: 1px solid var(--border-secondary);">
<div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Closing Breakdown</div>
<div class="space-y-2 text-xs">
<div class="flex justify-between" style="color: var(--text-secondary);">
<span>Gross Funding</span>
<span class="font-semibold" id="closingGross">$17,500</span>
</div>
<div class="flex justify-between" style="color: var(--text-muted);">
<span>Origination Fee (3%)</span>
<span id="closingOrig">-$525</span>
</div>
<div class="flex justify-between" style="color: var(--text-muted);">
<span>Admin Fee</span>
<span>-$995</span>
</div>
<div class="flex justify-between" style="color: var(--text-muted);">
<span>Wire Fee</span>
<span>-$50</span>
</div>
<div class="flex justify-between pt-2 mt-2" style="border-top: 1px solid var(--border-secondary); color: var(--accent);">
<span class="font-bold">Net Wire Amount</span>
<span class="font-bold" id="closingNet">$15,930</span>
</div>
</div>
</div>
<!-- Stips -->
<div class="p-4" style="border-bottom: 1px solid var(--border-secondary);">
<div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Required Documentation</div>
<div class="space-y-2">
<div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
<svg class="w-3 h-3" fill="none" stroke="currentColor" style="color: var(--accent);" viewbox="0 0 24 24">
<path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>Driver's License</span>
</div>
<div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
<svg class="w-3 h-3" fill="none" stroke="currentColor" style="color: var(--accent);" viewbox="0 0 24 24">
<path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>Voided Check</span>
</div>
<div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
<svg class="w-3 h-3" fill="none" stroke="currentColor" style="color: var(--accent);" viewbox="0 0 24 24">
<path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>3 Months Bank Statements</span>
</div>
<div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
<svg class="w-3 h-3" fill="none" stroke="currentColor" style="color: var(--accent);" viewbox="0 0 24 24">
<path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>Proof of Ownership</span>
</div>
<div class="flex items-center gap-2 text-xs" style="color: var(--text-secondary);">
<svg class="w-3 h-3" fill="none" stroke="currentColor" style="color: var(--accent);" viewbox="0 0 24 24">
<path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
<span>Landlord Contact</span>
</div>
</div>
</div>
<!-- Decision -->
<div class="calc-payment-display" id="decisionSection" style="background: rgba(var(--accent-rgb), 0.1);">
<div class="calc-payment-label" id="decisionLabel" style="color: var(--accent);">Decision</div>
<div class="calc-payment-amount" id="decisionStatus" style="color: var(--accent); font-size: 1.25rem;"> APPROVED</div>
</div>
</div>
<!-- Declined State -->
<div class="hidden" id="declinedSection">
<div class="declined-card m-6">
<div class="text-5xl mb-4" style="color: #ef4444;"></div>
<div class="text-xl font-bold mb-2" style="color: #ef4444;">APPLICATION DECLINED</div>
<div class="text-sm" id="declineReason" style="color: var(--text-secondary);">Does not meet minimum requirements</div>
</div>
<div class="calc-payment-display" style="background: rgba(239, 68, 68, 0.1);">
<div class="calc-payment-label" style="color: #ef4444;">Decision</div>
<div class="calc-payment-amount" style="color: #ef4444; font-size: 1.25rem;"> DECLINED</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- APPROVAL OVERRIDE TAB -->
<div aria-hidden="true" aria-labelledby="tabbtn-override" class="tab-panel" id="tab-override" role="tabpanel" tabindex="0">
<div class="p-6 pb-0 max-w-[1600px] mx-auto">
<!-- Alternative Offer Scenarios (OFFER BUILDER tab) -->
<div class="card p-4 mb-6 mx-6" id="offerScenariosCard">
<div class="flex items-center gap-3 mb-3">
<div class="section-indicator"></div>
<h3 class="section-title" style="font-size: var(--text-base);">Alternative Offer Scenarios</h3>
</div>
<div class="offer-scenarios" id="offerScenarios">
<div class="offer-card" id="offerCardConservative" onclick="applyOffer('conservative')">
<div class="selected-indicator" style="background: #3b82f6;">
<svg fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24" width="14" height="14"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</div>
<div class="offer-card-header">
<span class="offer-type">Conservative</span>
<span class="offer-badge conservative">Safe</span>
</div>
<div class="offer-amount" id="offerConservativeAmt">$0</div>
<div class="offer-detail" id="offerConservativeTerm">0 months</div>
<div class="offer-detail" id="offerConservativePmt">$0/day</div>
<div class="offer-expanded">
<div class="offer-expanded-row">
<span class="offer-expanded-label">Factor Rate</span>
<span class="offer-expanded-value" id="offerConservativeFactor">1.00x</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Total Payback</span>
<span class="offer-expanded-value" id="offerConservativePayback">$0</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Est. Holdback</span>
<span class="offer-expanded-value" id="offerConservativeHoldback">0%</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Risk Level</span>
<span class="offer-expanded-value" style="color: #3b82f6;">Low</span>
</div>
<button class="offer-load-btn conservative-btn" onclick="event.stopPropagation(); applyOfferToOverride('conservative')">Apply to Override</button>
</div>
</div>
<div class="offer-card recommended" id="offerCardRecommended" onclick="applyOffer('recommended')">
<div class="selected-indicator">
<svg fill="none" stroke="#000" stroke-width="3" viewBox="0 0 24 24" width="14" height="14"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</div>
<div class="offer-card-header">
<span class="offer-type">Recommended</span>
<span class="offer-badge recommended">Best</span>
</div>
<div class="offer-amount" id="offerRecommendedAmt">$0</div>
<div class="offer-detail" id="offerRecommendedTerm">0 months</div>
<div class="offer-detail" id="offerRecommendedPmt">$0/day</div>
<div class="offer-expanded">
<div class="offer-expanded-row">
<span class="offer-expanded-label">Factor Rate</span>
<span class="offer-expanded-value" id="offerRecommendedFactor">1.00x</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Total Payback</span>
<span class="offer-expanded-value" id="offerRecommendedPayback">$0</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Est. Holdback</span>
<span class="offer-expanded-value" id="offerRecommendedHoldback">0%</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Risk Level</span>
<span class="offer-expanded-value" style="color: var(--accent);">Standard</span>
</div>
<button class="offer-load-btn" onclick="event.stopPropagation(); applyOfferToOverride('recommended')">Apply to Override</button>
</div>
</div>
<div class="offer-card" id="offerCardAggressive" onclick="applyOffer('aggressive')">
<div class="selected-indicator" style="background: #ef4444;">
<svg fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24" width="14" height="14"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
</div>
<div class="offer-card-header">
<span class="offer-type">Aggressive</span>
<span class="offer-badge aggressive">Risk</span>
</div>
<div class="offer-amount" id="offerAggressiveAmt">$0</div>
<div class="offer-detail" id="offerAggressiveTerm">0 months</div>
<div class="offer-detail" id="offerAggressivePmt">$0/day</div>
<div class="offer-expanded">
<div class="offer-expanded-row">
<span class="offer-expanded-label">Factor Rate</span>
<span class="offer-expanded-value" id="offerAggressiveFactor">1.00x</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Total Payback</span>
<span class="offer-expanded-value" id="offerAggressivePayback">$0</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Est. Holdback</span>
<span class="offer-expanded-value" id="offerAggressiveHoldback">0%</span>
</div>
<div class="offer-expanded-row">
<span class="offer-expanded-label">Risk Level</span>
<span class="offer-expanded-value" style="color: #ef4444;">Higher</span>
</div>
<button class="offer-load-btn aggressive-btn" onclick="event.stopPropagation(); applyOfferToOverride('aggressive')">Apply to Override</button>
</div>
</div>
</div>
</div>
<!-- CREDIT ENGINE SECTION -->
<div class="card p-6 mb-6" id="overrideCreditEngineCard">
<div class="flex items-center gap-3 mb-6">
<div class="section-indicator"></div>
<h3 class="section-title">ABLESAI PRO Credit Engine</h3>
</div>
<div class="score-panel" id="scorePanelOverride">
<div class="score-header" id="scoreHeaderBgOverride" style="background: linear-gradient(135deg, rgba(234,179,8,0.15) 0%, rgba(234,179,8,0.05) 100%);">
<div style="display: flex; align-items: center; justify-content: space-between;">
<div>
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);">ABLESAI Score</div>
<div id="scoreValueOverride" style="font-size: 30px; font-weight: 900; color: #eab308;">62<span style="font-size: var(--text-2xl); font-weight: 600; color: var(--text-muted);">/100</span></div>
</div>
<div style="text-align: center;">
<div id="tierLetterOverride" style="font-size: var(--text-6xl); font-weight: 900; color: #eab308;">C</div>
<div id="tierLabelOverride" style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; color: var(--text-muted);">Mid-Prime</div>
</div>
</div>
</div>
<div class="score-body">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 16px; color: var(--text-muted);">Score Breakdown</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotCreditOverride" style="width: 8px; height: 8px; border-radius: 50%; background: #eab308;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Credit Score</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barCreditOverride" style="width: 50%; background: #eab308;"></div></div>
<span id="scoreCreditOverride" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">15/30</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotBehaviorOverride" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Behavior (<span id="eventsLabelOverride">3</span> events)</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barBehaviorOverride" style="width: 70%; background: #10b981;"></div></div>
<span id="scoreBehaviorOverride" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">21/30</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotRevenueOverride" style="width: 8px; height: 8px; border-radius: 50%; background: #eab308;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Revenue</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barRevenueOverride" style="width: 46%; background: #eab308;"></div></div>
<span id="scoreRevenueOverride" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">9/20</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotStabilityOverride" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Stability</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barStabilityOverride" style="width: 70%; background: #10b981;"></div></div>
<span id="scoreStabilityOverride" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">7/10</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotBufferOverride" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Buffer (<span id="bufferPctOverride">16</span>%)</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barBufferOverride" style="width: 100%; background: #10b981;"></div></div>
<span id="scoreBufferOverride" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">10/10</span>
</div>
</div>
<div class="breakdown-row">
<div style="display: flex; align-items: center; gap: 8px;">
<div id="dotCollectOverride" style="width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div>
<span style="font-size: var(--text-base); font-weight: 600; color: var(--text-secondary);">Collectibility</span>
</div>
<div style="display: flex; align-items: center; gap: 8px;">
<div class="breakdown-bar-track"><div class="breakdown-bar-fill" id="barCollectOverride" style="width: 100%; background: #10b981;"></div></div>
<span id="scoreCollectOverride" style="font-size: var(--text-base); font-weight: 700; width: 48px; text-align: right; color: var(--text-primary);">15/15</span>
</div>
</div>
<div class="tier-scale">
<div class="tier-seg tier-a">A 80+</div>
<div class="tier-seg tier-b">B 65+</div>
<div class="tier-seg tier-c">C 50+</div>
<div class="tier-seg tier-d">D 35+</div>
<div class="tier-seg tier-e">E &lt;35</div>
</div>
</div>
</div>
<!-- Score & Offer Summary Row -->
<div class="p-3 flex items-center justify-between flex-wrap gap-3 rounded-lg mb-2 mt-3" style="background: var(--bg-card-inner);">
<div class="flex items-center gap-4 flex-1">
<div class="text-center px-3 py-1 rounded-xl flex-shrink-0" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">Tier</div>
<div class="text-2xl font-black" id="overrideTierDisplay" style="color: var(--accent);">C</div>
</div>
<div class="flex-1 min-w-[180px]">
<div class="flex items-center justify-between mb-1">
<div class="text-[10px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">ABLESAI Score</div>
<div class="text-base font-extrabold" style="color: var(--text-primary);"><span id="overrideScoreDisplay">62</span>/100</div>
</div>
<div class="summary-score-bar">
<div class="summary-score-fill" id="overrideScoreFill" style="width: 62%;"></div>
<div class="summary-score-marker" data-score="62" id="overrideScoreMarker" style="left: 62%;"></div>
</div>
<div class="flex justify-between mt-1">
<span class="text-[8px] font-bold" style="color: #ef4444;">E</span>
<span class="text-[8px] font-bold" style="color: #f97316;">D</span>
<span class="text-[8px] font-bold" style="color: #eab308;">C</span>
<span class="text-[8px] font-bold" style="color: #22c55e;">B</span>
<span class="text-[8px] font-bold" style="color: #10b981;">A</span>
</div>
</div>
</div>
<div class="flex gap-4 flex-shrink-0">
<div class="text-center">
<div class="text-[10px] font-bold uppercase" style="color: var(--text-muted);">Funding</div>
<div class="text-base font-bold" id="calcFundingDisplay" style="color: var(--text-primary);">$17,500</div>
</div>
<div class="text-center">
<div class="text-[10px] font-bold uppercase" style="color: var(--text-muted);">Factor</div>
<div class="text-base font-bold" id="calcFactorDisplay" style="color: var(--text-primary);">1.32x</div>
</div>
<div class="text-center">
<div class="text-[10px] font-bold uppercase" style="color: var(--text-muted);">Term</div>
<div class="text-base font-bold" id="calcTermDisplay" style="color: var(--text-primary);">9 mo</div>
</div>
</div>
</div>
<!-- Bottom Row: Risk Analytics -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-2" id="overrideRiskIndicators">
<!-- Risk Impact Metrics -->
<div class="p-3 rounded-lg" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Risk Impact</div>
<div class="grid grid-cols-3 gap-2">
<div class="text-center p-2 rounded-lg" style="background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.3);">
<div class="text-lg font-extrabold" id="pdImpact" style="color: #eab308;">+2.1%</div>
<div class="text-[9px] font-bold uppercase tracking-wide" style="color: #eab308; opacity: 0.8;">PD Change</div>
</div>
<div class="text-center p-2 rounded-lg" style="background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3);">
<div class="text-lg font-extrabold" id="dscrImpact" style="color: #10b981;">1.85x</div>
<div class="text-[9px] font-bold uppercase tracking-wide" style="color: #10b981; opacity: 0.8;">DSCR</div>
</div>
<div class="text-center p-2 rounded-lg" style="background: rgba(234, 179, 8, 0.15); border: 1px solid rgba(234, 179, 8, 0.3);">
<div class="text-lg font-extrabold" id="riskScore" style="color: #eab308;">Medium</div>
<div class="text-[9px] font-bold uppercase tracking-wide" style="color: #eab308; opacity: 0.8;">Risk</div>
</div>
</div>
</div>
<!-- Probability of Default Gauge -->
<div class="p-3 rounded-lg" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Probability of Default</div>
<div class="gauge-container" style="transform: scale(0.75); transform-origin: top center; margin-bottom: -15px;">
<svg height="100" viewbox="0 0 180 100" width="180">
<path class="gauge-arc gauge-bg" d="M 20 80 A 60 60 0 0 1 160 80"></path>
<path class="gauge-arc gauge-fill" d="M 20 80 A 60 60 0 0 1 160 80" id="pdGaugeFill" stroke="#10b981" stroke-dasharray="0 188"></path>
<circle class="gauge-needle" cx="20" cy="80" id="pdNeedle" r="4"></circle>
</svg>
<div class="gauge-center-label">
<div class="text-lg font-extrabold" id="pdValue" style="color: var(--text-primary);">8.2%</div>
<div class="text-[8px] font-bold uppercase" style="color: var(--text-muted);">Est. PD</div>
</div>
</div>
<div class="pd-scale" style="margin-top: -20px;">
<span class="pd-scale-item" style="color: #10b981; font-size: var(--text-2xs);">Low</span>
<span class="pd-scale-item" style="color: #eab308; font-size: var(--text-2xs);">Med</span>
<span class="pd-scale-item" style="color: #f97316; font-size: var(--text-2xs);">High</span>
<span class="pd-scale-item" style="color: #ef4444; font-size: var(--text-2xs);">Severe</span>
</div>
</div>
<!-- DSCR Impact -->
<div class="p-3 rounded-lg" style="background: var(--bg-card);">
<div class="text-[10px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Debt Service Coverage</div>
<div class="dscr-bar mb-2">
<div class="text-[9px] font-bold" style="color: var(--text-muted);">0x</div>
<div class="dscr-bar-track">
<div class="dscr-marker" data-label="1x" style="left: 33%;"></div>
<div class="dscr-marker" data-label="1.5x" style="left: 50%;"></div>
<div class="dscr-marker" data-label="2x" style="left: 66%;"></div>
<div class="dscr-bar-fill" id="dscrBarFill" style="width: 62%; background: #10b981;">
<span class="text-[9px] font-bold" id="dscrBarValue" style="color: #000;">1.85x</span>
</div>
</div>
<div class="text-[9px] font-bold" style="color: var(--text-muted);">3x</div>
</div>
<div class="grid grid-cols-3 gap-2 text-center">
<div>
<div class="text-xs font-bold" id="dscrMonthlyRev" style="color: var(--text-primary);">$50,000</div>
<div class="text-[7px] font-bold uppercase" style="color: var(--text-muted);">Monthly Rev</div>
</div>
<div>
<div class="text-xs font-bold" id="dscrMonthlyDebt" style="color: var(--text-primary);">$2,574</div>
<div class="text-[7px] font-bold uppercase" style="color: var(--text-muted);">Monthly Debt</div>
</div>
<div>
<div class="text-xs font-bold" id="dscrRatio" style="color: #10b981;">1.85x</div>
<div class="text-[7px] font-bold uppercase" style="color: var(--text-muted);">DSCR</div>
</div>
</div>
<div class="mt-1 p-1.5 rounded-lg text-[8px]" id="dscrWarning" style="background: rgba(16, 185, 129, 0.1); color: #10b981; display: none;">
<strong>Healthy DSCR:</strong> Excellent revenue coverage for debt service.
            </div>
</div>
</div>
<!-- TWO COLUMN LAYOUT: Sliders + Card -->
<div class="override-layout px-6 max-w-[1600px] mx-auto">
<!-- LEFT: Override Controls -->
<div class="space-y-6 override-controls-column" id="overrideControlsPanel">
<div class="mobile-panel-handle" onclick="togglePanel('overrideControlsPanel')">
<div class="drawer-handle-bar"></div>
<div class="drawer-label">
<div class="drawer-chevrons">
<div class="drawer-chevron"></div>
<div class="drawer-chevron"></div>
</div>
<span class="drawer-label-text"></span>
<div class="drawer-chevrons">
<div class="drawer-chevron"></div>
<div class="drawer-chevron"></div>
</div>
</div>
</div>
<div class="card p-4">
<!-- Section Header -->
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Model Override Controls</h3>
</div>
<!-- Funding Override -->
<div class="override-slider-group mb-2">
<div class="override-slider-header">
<div>
<label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Funding Amount</label>
</div>
<div class="override-value-display">
<div class="override-value-main" id="overrideFundingDisplay">$17,500</div>
<div class="override-value-calc">Calc: <span id="calcFundingRef">$17,500</span></div>
</div>
</div>
<input class="slider w-full" id="overrideFunding" max="100000" min="5000" oninput="calculateOverride()" step="1" type="range" value="17500"/>
<div class="flex justify-between text-[10px] font-semibold mt-1" style="color: var(--text-muted);">
<span>$5,000</span>
<span>$100,000</span>
</div>
<div class="mt-2" id="fundingVarianceContainer">
<div class="variance-indicator neutral" id="fundingVariance">
<svg class="w-3 h-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M5 12h14" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span>No variance</span>
</div>
</div>
</div>
<!-- Factor Rate Override -->
<div class="override-slider-group mb-2">
<div class="override-slider-header">
<div>
<label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Factor Rate</label>
</div>
<div class="override-value-display">
<div class="override-value-main" id="overrideFactorDisplay">1.32x</div>
<div class="override-value-calc">Calc: <span id="calcFactorRef">1.32x</span></div>
</div>
</div>
<input class="slider w-full" id="overrideFactor" max="1.55" min="1.15" oninput="calculateOverride()" step="0.01" type="range" value="1.32"/>
<div class="flex justify-between text-[10px] font-semibold mt-1" style="color: var(--text-muted);">
<span>1.15x</span>
<span>1.55x</span>
</div>
<div class="mt-2" id="factorVarianceContainer">
<div class="variance-indicator neutral" id="factorVariance">
<svg class="w-3 h-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M5 12h14" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span>No variance</span>
</div>
</div>
</div>
<!-- Term Override -->
<div class="override-slider-group mb-2">
<div class="override-slider-header">
<div>
<label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Term Length</label>
</div>
<div class="override-value-display">
<div class="override-value-main" id="overrideTermDisplay">9 Months</div>
<div class="override-value-calc">Calc: <span id="calcTermRef">9 mo</span></div>
</div>
</div>
<input class="slider w-full" id="overrideTerm" max="15" min="3" oninput="calculateOverride()" step="1" type="range" value="9"/>
<div class="flex justify-between text-[10px] font-semibold mt-1" style="color: var(--text-muted);">
<span>3 mo</span>
<span>15 mo</span>
</div>
<div class="mt-2" id="termVarianceContainer">
<div class="variance-indicator neutral" id="termVariance">
<svg class="w-3 h-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path d="M5 12h14" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span>No variance</span>
</div>
</div>
</div>
<!-- Payment Frequency Override -->
<div class="override-slider-group mb-2 text-center">
<label class="text-xs font-bold uppercase tracking-wide block mb-2" style="color: var(--text-muted);">Payment Frequency</label>
<div class="freq-toggle-group">
<label class="freq-toggle">
<input checked="" name="overridePaymentFreq" onchange="calculateOverride()" type="radio" value="daily"/>
<span class="freq-toggle-btn">Daily</span>
</label>
<label class="freq-toggle">
<input name="overridePaymentFreq" onchange="calculateOverride()" type="radio" value="weekly"/>
<span class="freq-toggle-btn">Weekly</span>
</label>
</div>
</div>
<!-- Reset Button -->
<div class="grid grid-cols-2 gap-2 mt-2">
<button class="w-full py-2 px-4 rounded-xl font-bold text-sm transition-all" onclick="recalculateOverrideWithConfirm(this)" style="background: var(--accent); color: #000;" type="button">
              Recalculate
            </button>
<button class="w-full py-2 px-4 rounded-xl font-bold text-sm transition-all" onclick="resetOverride()" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary); color: var(--text-secondary);" type="button">
              Reset
            </button>
</div>
<div class="text-center text-xs mt-1 font-semibold" id="overrideConfirmMsg" style="color: #22c55e; opacity: 0; transition: opacity 0.3s;"></div>
</div>
</div>
<!-- RIGHT: Result Preview Card -->
<div class="override-result-column">
<div class="card p-4">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Override Preview</h3>
</div>
<div class="preview-sticky-wrapper">
<!-- Override Result Card -->
<div class="calc-result-preview" id="overrideResultCard">
<div class="calc-preview-header" id="overrideResultHeader">
<div class="calc-preview-label">Model Override</div>
<div class="calc-preview-amount" id="overrideOfferFunding">$17,500</div>
</div>
<div class="calc-stats-grid">
<div class="calc-stat-cell">
<span class="calc-stat-label">Factor Rate</span>
<span class="calc-stat-value" id="overrideOfferFactor">1.32x</span>
</div>
<div class="calc-stat-cell">
<span class="calc-stat-label">Term</span>
<span class="calc-stat-value" id="overrideOfferTerm">9 Months</span>
</div>
<div class="calc-stat-cell">
<span class="calc-stat-label">Total Payback</span>
<span class="calc-stat-value" id="overrideOfferPayback">$23,100</span>
</div>
<div class="calc-stat-cell">
<span class="calc-stat-label" id="overridePaymentFreqLabel">Daily Payment</span>
<span class="calc-stat-value accent" id="overrideOfferPayment">$117</span>
</div>
</div>
<!-- Holdback & APR Display -->
<div class="grid grid-cols-2 gap-0" style="border-bottom: 1px solid var(--border-secondary); background: rgba(var(--accent-rgb), 0.05);">
<div class="p-4 text-center" style="border-right: 1px solid var(--border-secondary);">
<div class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Holdback</div>
<div class="text-2xl font-extrabold" id="overrideOfferHoldback" style="color: var(--accent);">4.91%</div>
</div>
<div class="p-4 text-center">
<div class="text-xs font-bold uppercase tracking-wider mb-1" style="color: var(--text-muted);">Est. APR</div>
<div class="text-2xl font-extrabold" id="overrideOfferAPR" style="color: var(--accent);">42.7%</div>
</div>
</div>
<!-- Comparison Section -->
<div class="p-4" style="border-bottom: 1px solid var(--border-secondary);">
<div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Variance from Calculated</div>
<div class="comparison-row">
<span class="comparison-label">Funding</span>
<div class="comparison-values">
<span class="comparison-calc" id="compFundingCalc">$17,500</span>
<span class="comparison-override" id="compFundingOverride">$17,500</span>
<span class="text-xs font-bold" id="compFundingDiff" style="color: var(--text-muted);">+$0</span>
</div>
</div>
<div class="comparison-row">
<span class="comparison-label">Payback</span>
<div class="comparison-values">
<span class="comparison-calc" id="compPaybackCalc">$23,100</span>
<span class="comparison-override" id="compPaybackOverride">$23,100</span>
<span class="text-xs font-bold" id="compPaybackDiff" style="color: var(--text-muted);">+$0</span>
</div>
</div>
<div class="comparison-row">
<span class="comparison-label" id="compPaymentLabel">Daily Payment</span>
<div class="comparison-values">
<span class="comparison-calc" id="compPaymentCalc">$117</span>
<span class="comparison-override" id="compPaymentOverride">$117</span>
<span class="text-xs font-bold" id="compPaymentDiff" style="color: var(--text-muted);">+$0</span>
</div>
</div>
</div>
<!-- Closing Breakdown -->
<div class="p-4" style="border-bottom: 1px solid var(--border-secondary);">
<div class="text-xs font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Closing Breakdown</div>
<div class="space-y-2 text-xs">
<div class="flex justify-between" style="color: var(--text-secondary);">
<span>Gross Funding</span>
<span class="font-semibold" id="overrideClosingGross">$17,500</span>
</div>
<div class="flex justify-between" style="color: var(--text-muted);">
<span>Origination Fee (3%)</span>
<span id="overrideClosingOrig">-$525</span>
</div>
<div class="flex justify-between" style="color: var(--text-muted);">
<span>Admin Fee</span>
<span>-$995</span>
</div>
<div class="flex justify-between" style="color: var(--text-muted);">
<span>Wire Fee</span>
<span>-$50</span>
</div>
<div class="flex justify-between pt-2 mt-2" style="border-top: 1px solid var(--border-secondary); color: var(--accent);">
<span class="font-bold">Net Wire Amount</span>
<span class="font-bold" id="overrideClosingNet">$15,930</span>
</div>
</div>
</div>
<!-- Override Decision -->
<div class="calc-payment-display" id="overrideDecisionSection" style="background: rgba(var(--accent-rgb), 0.1);">
<div class="calc-payment-label" style="color: var(--accent);">Override Status</div>
<div class="calc-payment-amount" id="overrideDecisionStatus" style="color: var(--accent); font-size: 1.25rem;">APPROVED (OVERRIDE)</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- MODEL INFO TAB -->
<div aria-hidden="true" aria-labelledby="tabbtn-model" class="tab-panel" id="tab-model" role="tabpanel" tabindex="0">
<div class="model-container">
<!-- Intro Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
<!-- What is ABLESAI PRO -->
<div class="model-card">
<div class="model-card-header">
<div class="model-card-icon" style="background: #10b981;">?</div>
<span class="text-sm font-bold" style="color: var(--text-primary);">What is ABLESAI PRO?</span>
</div>
<div class="model-card-body">
<p class="text-sm leading-relaxed mb-3" style="color: var(--text-secondary);">
              ABLESAI PRO is a proprietary credit scoring algorithm designed specifically for Merchant Cash Advance (MCA) underwriting. Unlike traditional FICO scores that focus on consumer credit history, ABLESAI PRO evaluates a business's ability to repay based on actual cash flow performance.
            </p>
<p class="text-sm leading-relaxed" style="color: var(--text-secondary);">
              The model analyzes 5 key dimensions of business health, producing a score 0-100 that determines both approval status and pricing tier.
            </p>
</div>
</div>
<!-- Score Range & Tiers -->
<div class="model-card">
<div class="model-card-header">
<span class="text-sm font-bold" style="color: var(--text-primary);">Score Range &amp; Tiers</span>
</div>
<div class="model-card-body">
<div class="tier-table-row">
<div class="tier-badge" style="background: #10b981;">A</div>
<div class="flex-1">
<div class="text-sm font-bold" style="color: var(--text-primary);">Prime</div>
<div class="text-xs" style="color: var(--text-muted);">Factor: 1.18x | Term: 12 mo</div>
</div>
<div class="text-sm font-semibold" style="color: var(--text-secondary);">80-100 pts</div>
</div>
<div class="tier-table-row">
<div class="tier-badge" style="background: #22c55e;">B</div>
<div class="flex-1">
<div class="text-sm font-bold" style="color: var(--text-primary);">Standard</div>
<div class="text-xs" style="color: var(--text-muted);">Factor: 1.24x | Term: 10 mo</div>
</div>
<div class="text-sm font-semibold" style="color: var(--text-secondary);">65-79 pts</div>
</div>
<div class="tier-table-row">
<div class="tier-badge" style="background: #eab308;">C</div>
<div class="flex-1">
<div class="text-sm font-bold" style="color: var(--text-primary);">Mid-Prime</div>
<div class="text-xs" style="color: var(--text-muted);">Factor: 1.32x | Term: 9 mo</div>
</div>
<div class="text-sm font-semibold" style="color: var(--text-secondary);">50-64 pts</div>
</div>
<div class="tier-table-row">
<div class="tier-badge" style="background: #f97316;">D</div>
<div class="flex-1">
<div class="text-sm font-bold" style="color: var(--text-primary);">Elevated Risk</div>
<div class="text-xs" style="color: var(--text-muted);">Factor: 1.38x | Term: 6 mo</div>
</div>
<div class="text-sm font-semibold" style="color: var(--text-secondary);">35-49 pts</div>
</div>
<div class="tier-table-row">
<div class="tier-badge" style="background: #ef4444;">E</div>
<div class="flex-1">
<div class="text-sm font-bold" style="color: var(--text-primary);">High Risk</div>
<div class="text-xs" style="color: var(--text-muted);">Factor: 1.45x | Term: 4 mo</div>
</div>
<div class="text-sm font-semibold" style="color: var(--text-secondary);">0-34 pts</div>
</div>
</div>
</div>
</div>
<!-- Score Weight Distribution -->
<div class="text-[10px] font-bold uppercase tracking-wider mb-4" style="color: var(--text-muted);">Score Weight Distribution</div>
<div class="model-card mb-8">
<div class="model-card-body">
<div class="donut-section">
<div class="donut-chart">
<svg height="160" viewbox="0 0 160 160" width="160">
<circle cx="80" cy="80" fill="none" r="60" stroke="#1a1a1a" stroke-width="18"></circle>
<circle cx="80" cy="80" fill="none" r="60" stroke="#f97316" stroke-dasharray="113 377" stroke-dashoffset="0" stroke-linecap="round" stroke-width="18"></circle>
<circle cx="80" cy="80" fill="none" r="60" stroke="#eab308" stroke-dasharray="113 377" stroke-dashoffset="-113" stroke-linecap="round" stroke-width="18"></circle>
<circle cx="80" cy="80" fill="none" r="60" stroke="#10b981" stroke-dasharray="75 377" stroke-dashoffset="-226" stroke-linecap="round" stroke-width="18"></circle>
<circle cx="80" cy="80" fill="none" r="60" stroke="#06b6d4" stroke-dasharray="38 377" stroke-dashoffset="-301" stroke-linecap="round" stroke-width="18"></circle>
<circle cx="80" cy="80" fill="none" r="60" stroke="#8b5cf6" stroke-dasharray="38 377" stroke-dashoffset="-339" stroke-linecap="round" stroke-width="18"></circle>
</svg>
<div class="donut-center">
<span class="text-3xl font-extrabold" style="color: var(--text-primary);">100</span>
<span class="text-[9px] font-bold uppercase" style="color: var(--text-muted);">Max Points</span>
</div>
</div>
<div class="grid grid-cols-2 gap-3">
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded" style="background: #f97316;"></div>
<div>
<div class="text-xs" style="color: var(--text-secondary);">Credit Score</div>
<div class="text-[10px]" style="color: var(--text-muted);">30 points (30%)</div>
</div>
</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded" style="background: #eab308;"></div>
<div>
<div class="text-xs" style="color: var(--text-secondary);">Behavior</div>
<div class="text-[10px]" style="color: var(--text-muted);">30 points (30%)</div>
</div>
</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded" style="background: #10b981;"></div>
<div>
<div class="text-xs" style="color: var(--text-secondary);">Revenue</div>
<div class="text-[10px]" style="color: var(--text-muted);">20 points (20%)</div>
</div>
</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded" style="background: #06b6d4;"></div>
<div>
<div class="text-xs" style="color: var(--text-secondary);">Stability</div>
<div class="text-[10px]" style="color: var(--text-muted);">10 points (10%)</div>
</div>
</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded" style="background: #8b5cf6;"></div>
<div>
<div class="text-xs" style="color: var(--text-secondary);">Buffer</div>
<div class="text-[10px]" style="color: var(--text-muted);">10 points (10%)</div>
</div>
</div>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded" style="background: #ef4444;"></div>
<div>
<div class="text-xs" style="color: var(--text-secondary);">Prohibited Industry</div>
<div class="text-[10px]" style="color: var(--text-muted);">Auto-Decline</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Scoring Components -->
<div class="text-[10px] font-bold uppercase tracking-wider mb-4" style="color: var(--text-muted);">Scoring Components Explained</div>
<!-- Credit Score -->
<div class="score-component">
<div class="score-component-header">
<div class="score-comp-badge" style="background: #f97316;">30</div>
<div class="flex-1">
<h3 class="text-sm font-bold" style="color: var(--text-primary);">Credit Score (FICO)</h3>
<p class="text-xs" style="color: var(--text-muted);">Traditional credit quality indicator</p>
</div>
<span class="text-[10px] font-bold px-2 py-1 rounded" style="background: rgba(239,68,68,0.15); color: #ef4444;">KNOCKOUT: &lt;500</span>
</div>
<div class="score-component-body">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
<div class="formula-value">( (FICO - 500) / 300 ) x 30</div>
</div>
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Example</div>
<div class="formula-value">FICO 680 = (680-500)/300 x 30 = 18 pts</div>
</div>
</div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Score Curve</div>
<div class="score-gradient-bar"></div>
<div class="flex justify-between text-[9px]" style="color: var(--text-muted);">
<span>500</span><span>550</span><span>600</span><span>650</span><span>700</span><span>800+</span>
</div>
</div>
</div>
<!-- Behavior -->
<div class="score-component">
<div class="score-component-header">
<div class="score-comp-badge" style="background: #eab308;">30</div>
<div class="flex-1">
<h3 class="text-sm font-bold" style="color: var(--text-primary);">Behavior (Risk Events)</h3>
<p class="text-xs" style="color: var(--text-muted);">NSF/Overdrafts + Negative Balance Days (90-Day Period)</p>
</div>
<span class="text-[10px] font-bold px-2 py-1 rounded" style="background: rgba(239,68,68,0.15); color: #ef4444;">KNOCKOUT: &gt;10 events</span>
</div>
<div class="score-component-body">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
<div class="formula-value">30 - (events x 3)</div>
</div>
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Events = NSF + NEG DAYS</div>
<div class="formula-value">2 NSF + 1 neg day = 3 events = 21 pts</div>
</div>
</div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Points by Event Count</div>
<div class="points-grid">
<div class="points-cell" style="background: #10b981; color: #000;"><span class="block text-sm font-extrabold">30</span><span class="text-[8px]">0</span></div>
<div class="points-cell" style="background: #10b981; color: #000;"><span class="block text-sm font-extrabold">27</span><span class="text-[8px]">1</span></div>
<div class="points-cell" style="background: #22c55e; color: #000;"><span class="block text-sm font-extrabold">24</span><span class="text-[8px]">2</span></div>
<div class="points-cell" style="background: #22c55e; color: #000;"><span class="block text-sm font-extrabold">21</span><span class="text-[8px]">3</span></div>
<div class="points-cell" style="background: #eab308; color: #000;"><span class="block text-sm font-extrabold">18</span><span class="text-[8px]">4</span></div>
<div class="points-cell" style="background: #eab308; color: #000;"><span class="block text-sm font-extrabold">15</span><span class="text-[8px]">5</span></div>
<div class="points-cell" style="background: #f97316; color: #000;"><span class="block text-sm font-extrabold">12</span><span class="text-[8px]">6</span></div>
<div class="points-cell" style="background: #f97316; color: #000;"><span class="block text-sm font-extrabold">9</span><span class="text-[8px]">7</span></div>
<div class="points-cell" style="background: #ef4444; color: #fff;"><span class="block text-sm font-extrabold">6</span><span class="text-[8px]">8</span></div>
<div class="points-cell" style="background: #ef4444; color: #fff;"><span class="block text-sm font-extrabold">3</span><span class="text-[8px]">9</span></div>
<div class="points-cell" style="background: #7f1d1d; color: #fff;"><span class="block text-sm font-extrabold">0</span><span class="text-[8px]">10+</span></div>
</div>
</div>
</div>
<!-- Revenue -->
<div class="score-component">
<div class="score-component-header">
<div class="score-comp-badge" style="background: #10b981;">20</div>
<div class="flex-1">
<h3 class="text-sm font-bold" style="color: var(--text-primary);">Revenue (Monthly Deposits)</h3>
<p class="text-xs" style="color: var(--text-muted);">Business cash flow capacity</p>
</div>
<span class="text-[10px] font-bold px-2 py-1 rounded" style="background: rgba(239,68,68,0.15); color: #ef4444;">KNOCKOUT: &lt;$7,500</span>
</div>
<div class="score-component-body">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
<div class="formula-value">( (Rev - 7500) / 92500 ) x 20</div>
</div>
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Example</div>
<div class="formula-value">$50K/mo = (50000-7500)/92500 x 20 = 9.2 pts</div>
</div>
</div>
</div>
</div>
<!-- Stability -->
<div class="score-component">
<div class="score-component-header">
<div class="score-comp-badge" style="background: #06b6d4;">10</div>
<div class="flex-1">
<h3 class="text-sm font-bold" style="color: var(--text-primary);">Stability (Time in Business)</h3>
<p class="text-xs" style="color: var(--text-muted);">Business maturity and track record</p>
</div>
</div>
<div class="score-component-body">
<div class="text-[9px] font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Fixed Tier System</div>
<div class="tier-boxes">
<div class="tier-box" style="border-color: #10b981; background: rgba(16,185,129,0.1);">
<div class="text-2xl font-extrabold" style="color: #10b981;">10</div>
<div class="text-xs font-semibold" style="color: #10b981;">36+ mo</div>
<div class="text-[10px]" style="color: var(--text-muted);">3+ years</div>
</div>
<div class="tier-box" style="border-color: #22c55e; background: rgba(34,197,94,0.1);">
<div class="text-2xl font-extrabold" style="color: #22c55e;">7</div>
<div class="text-xs font-semibold" style="color: #22c55e;">24-35 mo</div>
<div class="text-[10px]" style="color: var(--text-muted);">2-3 years</div>
</div>
<div class="tier-box" style="border-color: #eab308; background: rgba(234,179,8,0.1);">
<div class="text-2xl font-extrabold" style="color: #eab308;">4</div>
<div class="text-xs font-semibold" style="color: #eab308;">12-23 mo</div>
<div class="text-[10px]" style="color: var(--text-muted);">1-2 years</div>
</div>
<div class="tier-box" style="border-color: #ef4444; background: rgba(239,68,68,0.1);">
<div class="text-2xl font-extrabold" style="color: #ef4444;">1</div>
<div class="text-xs font-semibold" style="color: #ef4444;">&lt;12 mo</div>
<div class="text-[10px]" style="color: var(--text-muted);">&lt;1 year</div>
</div>
</div>
</div>
</div>
<!-- Buffer -->
<div class="score-component">
<div class="score-component-header">
<div class="score-comp-badge" style="background: #8b5cf6;">10</div>
<div class="flex-1">
<h3 class="text-sm font-bold" style="color: var(--text-primary);">Buffer (ADB / Revenue Ratio)</h3>
<p class="text-xs" style="color: var(--text-muted);">Cash reserve as safety cushion</p>
</div>
</div>
<div class="score-component-body">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Formula</div>
<div class="formula-value">Avg Daily Balance / Monthly Revenue</div>
</div>
<div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-2" style="color: var(--text-muted);">Example</div>
<div class="formula-value">$5K ADB / $50K Rev = 10% = 10 pts</div>
</div>
</div>
<div class="text-[9px] font-bold uppercase tracking-wider mb-3" style="color: var(--text-muted);">Buffer Thresholds</div>
<div class="buffer-boxes">
<div class="tier-box" style="border-color: #10b981; background: rgba(16,185,129,0.1);">
<div class="text-2xl font-extrabold" style="color: #10b981;">10</div>
<div class="text-xs font-semibold" style="color: #10b981;">10%+</div>
<div class="text-[10px]" style="color: var(--text-muted);">Strong Reserve</div>
</div>
<div class="tier-box" style="border-color: #eab308; background: rgba(234,179,8,0.1);">
<div class="text-2xl font-extrabold" style="color: #eab308;">5</div>
<div class="text-xs font-semibold" style="color: #eab308;">5-9.9%</div>
<div class="text-[10px]" style="color: var(--text-muted);">Moderate</div>
</div>
<div class="tier-box" style="border-color: #ef4444; background: rgba(239,68,68,0.1);">
<div class="text-2xl font-extrabold" style="color: #ef4444;">0</div>
<div class="text-xs font-semibold" style="color: #ef4444;">&lt;5%</div>
<div class="text-[10px]" style="color: var(--text-muted);">Thin Margins</div>
</div>
</div>
</div>
</div>
<!-- Decline / Safety Rules -->
<div class="rules-grid">
<div class="rules-card">
<div class="rules-card-header" style="background: rgba(239,68,68,0.1);">
<div class="rules-icon" style="background: #ef4444; color: #fff;"></div>
<span class="text-sm font-bold" style="color: #ef4444;">Automatic Declines</span>
</div>
<div class="rules-card-body">
<p class="text-xs mb-3" style="color: var(--text-muted);">These criteria result in immediate decline:</p>
<ul class="rules-list">
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>FICO score below 500</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>Monthly revenue below $7,500</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>More than 10 risk events (90 days)</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>Qualified amount below $10,000</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>Prohibited industry (8 categories)</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>Trucking with less than 5 vehicles</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>Existing debt exceeds 25% of revenue</li>
</ul>
</div>
</div>
<div class="rules-card">
<div class="rules-card-header" style="background: rgba(234,179,8,0.1);">
<div class="rules-icon" style="background: #eab308; color: #000;">!</div>
<span class="text-sm font-bold" style="color: #eab308;">Safety Valves</span>
</div>
<div class="rules-card-body">
<p class="text-xs mb-3" style="color: var(--text-muted);">Credit triggers that force tier downgrades:</p>
<ul class="rules-list">
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #eab308;"></span>FICO &lt; 600 = Maximum Tier C</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #f97316;"></span>FICO &lt; 550 = Maximum Tier D</li>
<li><span class="w-2 h-2 rounded-full flex-shrink-0" style="background: #ef4444;"></span>FICO &lt; 520 = Forced to Tier E</li>
</ul>
</div>
</div>
</div>
<!-- Payment Frequency Logic -->
<div class="text-[10px] font-bold uppercase tracking-wider mb-4 mt-8" style="color: var(--text-muted);">Offer Payment Frequency</div>
<div class="model-card mb-8">
<div class="model-card-body">
<p class="text-sm mb-4" style="color: var(--text-secondary);">
            The model determines whether the approved offer will have <span style="color: var(--text-primary); font-weight: 600;">daily or weekly payments</span>. Weekly payments are offered only when all criteria are met:
          </p>
<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
<div class="p-3 rounded-lg" style="background: var(--card-bg); border: 1px solid var(--border-secondary);">
<div class="text-xs font-bold" style="color: var(--accent);">DSCR</div>
<div class="text-lg font-extrabold" style="color: var(--text-primary);">1.5x+</div>
<div class="text-[10px]" style="color: var(--text-muted);">Debt coverage ratio</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--card-bg); border: 1px solid var(--border-secondary);">
<div class="text-xs font-bold" style="color: var(--accent);">Debt Burden</div>
<div class="text-lg font-extrabold" style="color: var(--text-primary);">15%</div>
<div class="text-[10px]" style="color: var(--text-muted);">Max existing debt</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--card-bg); border: 1px solid var(--border-secondary);">
<div class="text-xs font-bold" style="color: var(--accent);">Cash Buffer</div>
<div class="text-lg font-extrabold" style="color: var(--text-primary);">8%+</div>
<div class="text-[10px]" style="color: var(--text-muted);">Balance / revenue</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--card-bg); border: 1px solid var(--border-secondary);">
<div class="text-xs font-bold" style="color: var(--accent);">Risk Events</div>
<div class="text-lg font-extrabold" style="color: var(--text-primary);">3</div>
<div class="text-[10px]" style="color: var(--text-muted);">Max NSF + neg days</div>
</div>
</div>
<p class="text-xs mt-4" style="color: var(--text-muted);">
            If any criterion fails, the offer defaults to daily payments (safer for lender, more manageable for merchant).
          </p>
</div>
</div>
<!-- Prohibited Industries -->
<div class="text-[10px] font-bold uppercase tracking-wider mb-4" style="color: var(--text-muted);">Prohibited Industries</div>
<div class="model-card mb-8">
<div class="model-card-body">
<p class="text-sm mb-4" style="color: var(--text-secondary);">
            The following industries result in automatic decline regardless of score:
          </p>
<div class="grid grid-cols-2 md:grid-cols-4 gap-2">
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Gambling/Casino</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Adult Entertainment</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Cannabis/CBD</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Firearms/Weapons</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Cryptocurrency</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Debt Collection</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Telemarketing</div>
<div class="text-xs px-3 py-2 rounded" style="background: rgba(239,68,68,0.1); color: #ef4444;">Pawn Shop</div>
</div>
<p class="text-xs mt-4" style="color: var(--text-muted);">
            Transportation/Trucking is restricted (requires minimum 5-vehicle fleet).
          </p>
</div>
</div>
<!-- Triple-Constraint Sizing -->
<div class="sizing-section">
<div class="flex items-center gap-3 mb-4">
<div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-extrabold" style="background: var(--accent); color: #000;">$</div>
<span class="text-sm font-bold" style="color: var(--text-primary);">Funding Calculation</span>
</div>
<p class="text-sm mb-6" style="color: var(--text-muted);">Funding is calculated using a <span class="font-semibold" style="color: var(--text-primary);">calibrated multiplier</span> adjusted by business factors, then capped by debt capacity.</p>
<div class="sizing-caps">
<div class="sizing-cap">
<div class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color: var(--accent);">BASE</div>
<div class="text-lg font-extrabold mb-1" style="color: var(--text-primary);">Revenue Multiple</div>
<div class="text-xs" style="color: var(--text-muted);">Starting point: 0.40x revenue</div>
<div class="text-[10px] mt-3 pt-3" style="border-top: 1px solid var(--border-secondary); color: var(--text-secondary);">Calibrated to RC+10%</div>
</div>
<div class="sizing-cap">
<div class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color: var(--accent);">ADJUST</div>
<div class="text-lg font-extrabold mb-1" style="color: var(--text-primary);">TIB / Credit / Events</div>
<div class="text-xs" style="color: var(--text-muted);">Bonuses and penalties applied</div>
<div class="text-[10px] mt-3 pt-3" style="border-top: 1px solid var(--border-secondary); color: var(--text-secondary);">10+ yr TIB: +0.80x bonus</div>
</div>
<div class="sizing-cap">
<div class="text-[10px] font-bold uppercase tracking-wider mb-1" style="color: var(--accent);">CAP</div>
<div class="text-lg font-extrabold mb-1" style="color: var(--text-primary);">Debt Capacity</div>
<div class="text-xs" style="color: var(--text-muted);">Total debt service max 25% of revenue</div>
<div class="text-[10px] mt-3 pt-3" style="border-top: 1px solid var(--border-secondary); color: var(--text-secondary);">Max funding: $165,000</div>
</div>
</div>
<div class="example-box">
<div class="flex items-center gap-2 mb-3">
<div class="w-3 h-0.5 rounded" style="background: var(--accent);"></div>
<span class="text-[9px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">Example: Existing Debt Impact</span>
</div>
<p class="text-sm leading-relaxed" style="color: var(--text-secondary);">
            Merchant with $50K revenue, $3K/mo existing debt:<br/>
<span class="font-semibold" style="color: var(--text-primary);">Max Debt Service:</span> $50K x 25% = $12,500/mo<br/>
<span class="font-semibold" style="color: var(--text-primary);">Available for New:</span> $12,500 - $3,000 = $9,500/mo<br/>
<span class="font-semibold" style="color: var(--text-primary);">Max New Funding:</span> ~$76K (at Tier B factor 1.24x, 10 mo)<br/>
<span class="font-semibold" style="color: var(--accent);">Final Amount:</span> min(calculated amount, debt-capped amount)
          </p>
</div>
</div>
<!-- Version Notes -->
<div class="text-[10px] font-bold uppercase tracking-wider mb-4 mt-8" style="color: var(--text-muted);">Version Notes</div>
<div class="model-card">
<div class="model-card-body">
<div class="mb-4">
<div class="flex items-center gap-2 mb-2">
<span class="text-xs font-bold" style="color: var(--accent);">v4.2</span>
<span class="text-[10px]" style="color: var(--text-muted);">December 2024</span>
</div>
<ul class="text-xs space-y-1" style="color: var(--text-secondary);">
<li>Model determines offer payment frequency (daily vs weekly) based on cash flow</li>
<li>Prohibited industries now auto-decline (8 categories)</li>
<li>Trucking requires minimum fleet size of 5 vehicles</li>
<li>Existing debt consideration with 25% revenue cap</li>
</ul>
</div>
<div class="mb-4">
<div class="flex items-center gap-2 mb-2">
<span class="text-xs font-bold" style="color: var(--text-secondary);">v4.1</span>
<span class="text-[10px]" style="color: var(--text-muted);">November 2024</span>
</div>
<ul class="text-xs space-y-1" style="color: var(--text-muted);">
<li>Funding calibrated to RC+10% methodology</li>
<li>Industry dropdown with 20+ categories</li>
<li>Risk indicator calculations (PD, LGD, EL, DSCR)</li>
</ul>
</div>
<div>
<div class="flex items-center gap-2 mb-2">
<span class="text-xs font-bold" style="color: var(--text-secondary);">v4.0</span>
<span class="text-[10px]" style="color: var(--text-muted);">October 2024</span>
</div>
<ul class="text-xs space-y-1" style="color: var(--text-muted);">
<li>PERREPUS 5-component scoring model</li>
<li>Tier-based pricing (A-E)</li>
<li>Triple-constraint sizing methodology</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<!-- ANALYTICS TAB (PRO) -->
<div aria-hidden="true" aria-labelledby="tabbtn-analytics" class="tab-panel" id="tab-analytics" role="tabpanel" tabindex="0">
<div class="analytics-layout">

<!-- Side Navigation -->
<nav class="analytics-sidenav">
<div class="analytics-sidenav-title">Key Metrics</div>
<div class="analytics-sidenav-item active" onclick="scrollToAnalyticsSection('metrics')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
<span>Overview</span>
</div>
<div class="analytics-sidenav-divider"></div>
<div class="analytics-sidenav-title">Analysis</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('score')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
<span>Score Analysis</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('risk')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
<span>Risk Metrics</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('cashflow')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
<span>Cash Flow</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('matrix')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
<span>Risk Matrix</span>
</div>
<div class="analytics-sidenav-divider"></div>
<div class="analytics-sidenav-title">Projections</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('sensitivity')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
<span>Sensitivity</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('benchmarks')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
<span>Benchmarks</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('stacking')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
<span>Stacking</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('historical')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
<span>Historical</span>
</div>
<div class="analytics-sidenav-divider"></div>
<div class="analytics-sidenav-title">Details</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('payment')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
<span>Payment</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('revenue')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
<span>Revenue</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('pricing')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
<span>Pricing</span>
</div>
<div class="analytics-sidenav-item" onclick="openAnalyticsModal('compliance')">
<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
<span>Compliance</span>
</div>
</nav>

<!-- Main Content -->
<div class="analytics-main-content" id="analyticsMainContent">

<!-- KEY METRICS ROW -->
<div id="analytics-section-metrics" class="analytics-section">
<div class="analytics-metrics-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px;">
<div style="background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.05)); border: 1px solid rgba(234,179,8,0.3); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px;">ABLESCORE</div>
<div style="font-size: var(--text-6xl); font-weight: 900; color: var(--accent);" id="analyticsHeaderScore">62</div>
<div style="font-size: var(--text-sm); color: var(--text-muted); margin-top: 2px;" id="analyticsHeaderTier">Tier C</div>
</div>
<div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px;">EST. PD</div>
<div style="font-size: var(--text-6xl); font-weight: 900; color: #eab308;" id="analyticsHeaderPD">8.2%</div>
<div style="font-size: var(--text-sm); color: var(--text-muted); margin-top: 2px;">Default Prob</div>
</div>
<div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px;">LGD</div>
<div style="font-size: var(--text-6xl); font-weight: 900; color: #f97316;" id="analyticsHeaderLGD">45%</div>
<div style="font-size: var(--text-sm); color: var(--text-muted); margin-top: 2px;">Loss Given Def</div>
</div>
<div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px;">EL</div>
<div style="font-size: var(--text-6xl); font-weight: 900; color: #ef4444;" id="analyticsHeaderEL">3.7%</div>
<div style="font-size: var(--text-sm); color: var(--text-muted); margin-top: 2px;">Expected Loss</div>
</div>
<div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px;">DSCR</div>
<div style="font-size: var(--text-6xl); font-weight: 900; color: #10b981;" id="analyticsHeaderDSCR">1.85x</div>
<div style="font-size: var(--text-sm); color: var(--text-muted); margin-top: 2px;">Debt Coverage</div>
</div>
<div style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; text-align: center;">
<div style="font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px;">ROI</div>
<div style="font-size: var(--text-6xl); font-weight: 900; color: #22c55e;" id="analyticsHeaderROI">30.0%</div>
<div style="font-size: var(--text-sm); color: var(--text-muted); margin-top: 2px;">Return</div>
</div>
</div>
</div><!-- End metrics section -->

<!-- ALL 12 CARDS IN 4x3 GRID -->
<div class="analytics-cards-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">

<!-- Row 1 -->
<!-- Card 1: Score Analysis -->
<div id="analytics-section-score" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('score')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span>Score Analysis</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; gap: 20px; align-items: center;">
<svg viewBox="0 0 100 100" style="width: 110px; height: 110px; flex-shrink: 0;">
<polygon points="50,10 90,35 75,85 25,85 10,35" fill="none" stroke="var(--border-subtle)" stroke-width="1" opacity="0.5"/>
<polygon id="miniRadarPoly" points="50,18 82,38 70,78 30,78 18,38" fill="rgba(234,179,8,0.3)" stroke="var(--accent)" stroke-width="2"/>
</svg>
<div style="flex: 1;">
<div class="stat-row"><span>Credit</span><span id="miniCreditPts">15/20</span></div>
<div class="stat-row"><span>Behavior</span><span id="miniBehaviorPts">12/15</span></div>
<div class="stat-row"><span>Revenue</span><span id="miniRevenuePts">21/30</span></div>
<div class="stat-row"><span>Stability</span><span>16/20</span></div>
<div class="stat-row"><span>Buffer</span><span>10/15</span></div>
</div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>5 Components</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 2: Risk Metrics -->
<div id="analytics-section-risk" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('risk')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg><span>Risk Metrics</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; gap: 20px; align-items: center;">
<div style="flex-shrink: 0;">
<svg viewBox="0 0 100 65" style="width: 120px;">
<path d="M 10 58 A 45 45 0 0 1 90 58" fill="none" stroke="var(--bg-input)" stroke-width="10" stroke-linecap="round"/>
<path d="M 10 58 A 45 45 0 0 1 90 58" fill="none" stroke="url(#lgPdGrad)" stroke-width="10" stroke-linecap="round" stroke-dasharray="141" id="miniPdArc" stroke-dashoffset="113"/>
<defs><linearGradient id="lgPdGrad" x1="0%" y1="0%" x2="100%"><stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#eab308"/><stop offset="100%" stop-color="#ef4444"/></linearGradient></defs>
<text x="50" y="52" text-anchor="middle" fill="var(--text-primary)" font-size="18" font-weight="800" id="miniPdValue">8.2%</text>
</svg>
</div>
<div style="flex: 1;">
<div class="stat-row"><span>LGD</span><span id="miniLGD">45%</span></div>
<div class="stat-row"><span>Expected Loss</span><span id="miniEL">3.7%</span></div>
<div class="stat-row"><span>$ Loss</span><span id="miniDollarEL">$1,850</span></div>
<div class="stat-row"><span>EAD</span><span>$50,000</span></div>
</div>
</div>
</div>
<div class="analytics-card-lg-footer"><span id="miniRiskLevel" style="color: #eab308;">Medium Risk</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 3: Cash Flow -->
<div id="analytics-section-cashflow" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('cashflow')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg><span>Cash Flow</span></div>
<div class="analytics-card-lg-body">
<div style="height: 85px; margin-bottom: 12px;">
<svg viewBox="0 0 200 60" style="width: 100%; height: 100%;">
<polyline points="10,45 40,40 70,42 100,35 130,30 160,25 190,20" fill="none" stroke="#10b981" stroke-width="2.5"/>
<polyline points="10,52 40,51 70,53 100,50 130,51 160,49 190,50" fill="none" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
<circle cx="190" cy="20" r="3" fill="#10b981"/>
</svg>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
<div class="stat-box"><span>Net CF</span><span style="color:#10b981;" id="miniNetCF">$250K</span></div>
<div class="stat-box"><span>Monthly</span><span id="miniMonthlyPmt">$8,333</span></div>
<div class="stat-box"><span>Term</span><span id="miniTerm">6 mo</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>6 Month Forecast</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 4: Risk Matrix -->
<div id="analytics-section-matrix" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('matrix')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span>Risk Matrix</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; gap: 20px; align-items: center;">
<div style="display: grid; grid-template-columns: repeat(4, 28px); grid-template-rows: repeat(4, 22px); gap: 3px;">
<div style="background:rgba(234,179,8,0.3); border-radius: 2px;"></div><div style="background:rgba(249,115,22,0.3); border-radius: 2px;"></div><div style="background:rgba(239,68,68,0.4); border-radius: 2px;"></div><div style="background:rgba(239,68,68,0.5); border-radius: 2px;"></div>
<div style="background:rgba(16,185,129,0.3); border-radius: 2px;"></div><div style="background:rgba(234,179,8,0.3); border-radius: 2px; position: relative;"><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:var(--accent);border-radius:50%;border:2px solid #fff;"></div></div><div style="background:rgba(249,115,22,0.3); border-radius: 2px;"></div><div style="background:rgba(239,68,68,0.4); border-radius: 2px;"></div>
<div style="background:rgba(16,185,129,0.4); border-radius: 2px;"></div><div style="background:rgba(16,185,129,0.3); border-radius: 2px;"></div><div style="background:rgba(234,179,8,0.3); border-radius: 2px;"></div><div style="background:rgba(249,115,22,0.3); border-radius: 2px;"></div>
<div style="background:rgba(16,185,129,0.5); border-radius: 2px;"></div><div style="background:rgba(16,185,129,0.4); border-radius: 2px;"></div><div style="background:rgba(16,185,129,0.3); border-radius: 2px;"></div><div style="background:rgba(234,179,8,0.3); border-radius: 2px;"></div>
</div>
<div style="flex: 1;">
<div class="stat-row"><span>Position</span><span id="miniMatrixPos">Med/Med</span></div>
<div class="stat-row"><span>Credit Risk</span><span style="color:#eab308;">Medium</span></div>
<div class="stat-row"><span>Liquidity</span><span style="color:#10b981;">Low</span></div>
<div class="stat-row"><span>Factors</span><span>6</span></div>
</div>
</div>
</div>
<div class="analytics-card-lg-footer"><span id="miniMatrixRisk" style="color: #eab308;">Medium</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Row 2 -->
<!-- Card 5: Sensitivity -->
<div id="analytics-section-sensitivity" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('sensitivity')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg><span>Sensitivity</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px;">
<div style="display: flex; align-items: center; gap: 6px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">Credit</span><div style="display: flex; flex: 1; height: 12px;"><div style="width: 35%; background: #ef4444; border-radius: 3px 0 0 3px;"></div><div style="width: 45%; background: #10b981; border-radius: 0 3px 3px 0;"></div></div></div>
<div style="display: flex; align-items: center; gap: 6px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">Revenue</span><div style="display: flex; flex: 1; height: 12px;"><div style="width: 28%; background: #ef4444; border-radius: 3px 0 0 3px;"></div><div style="width: 38%; background: #10b981; border-radius: 0 3px 3px 0;"></div></div></div>
<div style="display: flex; align-items: center; gap: 6px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">TIB</span><div style="display: flex; flex: 1; height: 12px;"><div style="width: 20%; background: #ef4444; border-radius: 3px 0 0 3px;"></div><div style="width: 25%; background: #10b981; border-radius: 0 3px 3px 0;"></div></div></div>
</div>
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
<div class="stat-box"><span>Key Driver</span><span>Credit</span></div>
<div class="stat-box"><span>Scenarios</span><span>5</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>Tornado Analysis</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 6: Benchmarks -->
<div id="analytics-section-benchmarks" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('benchmarks')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M18 20V10M12 20V4M6 20v-6"/></svg><span>Benchmarks</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; flex-direction: column; gap: 10px;">
<div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">Funding</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; position: relative;"><div style="height: 100%; width: 55%; background: var(--accent); border-radius: 5px;"></div><div style="position: absolute; top: -3px; left: 50%; width: 2px; height: 16px; background: var(--text-muted);"></div></div><span style="font-size: var(--text-2xs); color: #10b981;">+11%</span></div>
<div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">Score</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; position: relative;"><div style="height: 100%; width: 62%; background: var(--accent); border-radius: 5px;"></div><div style="position: absolute; top: -3px; left: 55%; width: 2px; height: 16px; background: var(--text-muted);"></div></div><span style="font-size: var(--text-2xs); color: #10b981;">+8%</span></div>
<div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">Default</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; position: relative;"><div style="height: 100%; width: 20%; background: #f97316; border-radius: 5px;"></div><div style="position: absolute; top: -3px; left: 24%; width: 2px; height: 16px; background: var(--text-muted);"></div></div><span style="font-size: var(--text-2xs); color: #10b981;">-15%</span></div>
<div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 50px;">Approval</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; position: relative;"><div style="height: 100%; width: 78%; background: #10b981; border-radius: 5px;"></div><div style="position: absolute; top: -3px; left: 68%; width: 2px; height: 16px; background: var(--text-muted);"></div></div><span style="font-size: var(--text-2xs); color: #10b981;">+15%</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span id="miniBenchVsAvg">Above Average</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 7: Stacking -->
<div id="analytics-section-stacking" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('stacking')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Stacking</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
<span style="font-size: var(--text-xs); font-weight: 700; padding: 4px 10px; background: rgba(234,179,8,0.2); color: var(--accent); border-radius: 4px;">1ST</span>
<span style="font-size: 22px; font-weight: 800; color: var(--text-primary);" id="miniStackAmount">$50K</span>
</div>
<div style="height: 10px; background: var(--bg-input); border-radius: 5px; margin-bottom: 10px;"><div style="height: 100%; width: 17%; background: var(--accent); border-radius: 5px;" id="miniStackBar"></div></div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
<div class="stat-box"><span>Daily</span><span id="miniStackDaily">$396</span></div>
<div class="stat-box"><span>Burden</span><span id="miniStackBurden" style="color:#10b981;">16.7%</span></div>
<div class="stat-box"><span>Capacity</span><span id="miniStackCapacity">$35K</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span id="miniStackRisk" style="color:#10b981;">Low Risk</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 8: Historical -->
<div id="analytics-section-historical" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('historical')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span>Historical</span></div>
<div class="analytics-card-lg-body">
<div style="height: 75px; display: flex; align-items: flex-end; gap: 5px; margin-bottom: 12px;">
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 50%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 55%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 48%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 62%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 68%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 72%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 65%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 78%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 85%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 82%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 92%;"></div>
<div style="flex: 1; background: var(--accent); border-radius: 3px 3px 0 0; height: 100%;"></div>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
<div class="stat-box"><span>YoY</span><span style="color:#10b981;">+12.4%</span></div>
<div class="stat-box"><span>Trend</span><span style="color:#10b981;">Up</span></div>
<div class="stat-box"><span>Months</span><span>12</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>Revenue Trend</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Row 3 -->
<!-- Card 9: Payments -->
<div id="analytics-section-payment" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('payment')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Payments</span></div>
<div class="analytics-card-lg-body">
<div style="height: 70px; margin-bottom: 12px;">
<svg viewBox="0 0 200 55" style="width: 100%; height: 100%;">
<defs><linearGradient id="amortGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="rgba(234,179,8,0.4)"/><stop offset="100%" stop-color="rgba(234,179,8,0.1)"/></linearGradient></defs>
<path d="M10,8 Q100,25 190,48 L190,55 L10,55 Z" fill="url(#amortGrad)"/>
<path d="M10,8 Q100,25 190,48" fill="none" stroke="var(--accent)" stroke-width="2.5"/>
</svg>
</div>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
<div class="stat-box"><span>Daily</span><span id="miniPayDaily">$396</span></div>
<div class="stat-box"><span>Weekly</span><span>$1,980</span></div>
<div class="stat-box"><span>Monthly</span><span id="miniPayMonthly">$8,316</span></div>
<div class="stat-box"><span>Total #</span><span id="miniPayTotal">126</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>Amortization</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 10: Revenue Quality -->
<div id="analytics-section-revenue" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('revenue')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>Revenue Quality</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; gap: 20px; align-items: center;">
<svg viewBox="0 0 80 80" style="width: 100px; height: 100px; flex-shrink: 0;">
<circle cx="40" cy="40" r="32" fill="none" stroke="var(--bg-input)" stroke-width="8"/>
<circle cx="40" cy="40" r="32" fill="none" stroke="#10b981" stroke-width="8" stroke-dasharray="201" stroke-dashoffset="30" transform="rotate(-90 40 40)" id="miniQualityRing"/>
<text x="40" y="46" text-anchor="middle" fill="var(--text-primary)" font-size="20" font-weight="800" id="miniQualityScore">85</text>
</svg>
<div style="flex: 1;">
<div class="stat-row"><span>Consistency</span><span style="color:#10b981;">92%</span></div>
<div class="stat-row"><span>Volatility</span><span style="color:#eab308;">18%</span></div>
<div class="stat-row"><span>Seasonality</span><span style="color:#10b981;">Low</span></div>
<div class="stat-row"><span>Growth</span><span style="color:#10b981;">+8%</span></div>
</div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>6 Indicators</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 11: Pricing -->
<div id="analytics-section-pricing" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('pricing')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg><span>Pricing</span></div>
<div class="analytics-card-lg-body">
<div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px;">
<div style="display: flex; align-items: center; gap: 6px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 45px;">Gross</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; overflow: hidden;"><div style="height: 100%; width: 100%; background: #10b981; border-radius: 5px;"></div></div><span style="font-size: var(--text-2xs); color: #10b981;">$15K</span></div>
<div style="display: flex; align-items: center; gap: 6px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 45px;">Costs</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; overflow: hidden;"><div style="height: 100%; width: 39%; background: #ef4444; border-radius: 5px;"></div></div><span style="font-size: var(--text-2xs); color: #ef4444;">-$5.9K</span></div>
<div style="display: flex; align-items: center; gap: 6px;"><span style="font-size: var(--text-2xs); color: var(--text-muted); width: 45px;">Net</span><div style="flex: 1; height: 10px; background: var(--bg-input); border-radius: 5px; overflow: hidden;"><div style="height: 100%; width: 61%; background: var(--accent); border-radius: 5px;"></div></div><span style="font-size: var(--text-2xs); color: var(--accent);" id="miniPricingNet">$9.1K</span></div>
</div>
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
<div class="stat-box"><span>Factor</span><span id="miniPricingFactor">1.30</span></div>
<div class="stat-box"><span>ROI</span><span style="color:#10b981;" id="miniPricingROI">30%</span></div>
<div class="stat-box"><span>IRR</span><span>65%</span></div>
</div>
</div>
<div class="analytics-card-lg-footer"><span>8 Metrics</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

<!-- Card 12: Compliance -->
<div id="analytics-section-compliance" class="analytics-section analytics-card-lg" onclick="openAnalyticsModal('compliance')">
<div class="analytics-card-lg-header"><svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg><span>Compliance</span></div>
<div class="analytics-card-lg-body">
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
<div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-input); border-radius: 6px;"><svg fill="none" height="14" stroke="#10b981" stroke-width="2.5" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span style="font-size: var(--text-xs);">Documents</span></div>
<div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-input); border-radius: 6px;"><svg fill="none" height="14" stroke="#10b981" stroke-width="2.5" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span style="font-size: var(--text-xs);">Identity</span></div>
<div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-input); border-radius: 6px;"><svg fill="none" height="14" stroke="#10b981" stroke-width="2.5" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span style="font-size: var(--text-xs);">Bank Verified</span></div>
<div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(234,179,8,0.1); border-radius: 6px;"><svg fill="none" height="14" stroke="#eab308" stroke-width="2.5" viewbox="0 0 24 24" width="14"><circle cx="12" cy="12" r="10"/></svg><span style="font-size: var(--text-xs); color: #eab308;">UCC Pending</span></div>
</div>
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 8px;">
<div style="padding: 4px; text-align: center; font-size: var(--text-2xs); background: rgba(16,185,129,0.1); color: #10b981; border-radius: 4px;">OFAC</div>
<div style="padding: 4px; text-align: center; font-size: var(--text-2xs); background: rgba(16,185,129,0.1); color: #10b981; border-radius: 4px;">Industry</div>
<div style="padding: 4px; text-align: center; font-size: var(--text-2xs); background: rgba(16,185,129,0.1); color: #10b981; border-radius: 4px;">State</div>
<div style="padding: 4px; text-align: center; font-size: var(--text-2xs); background: rgba(16,185,129,0.1); color: #10b981; border-radius: 4px;">Rate</div>
</div>
</div>
<div class="analytics-card-lg-footer"><span id="miniComplianceStatus" style="color:#10b981;">Ready</span><svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><path d="M9 18l6-6-6-6"/></svg></div>
</div>

</div>

</div>
</div><!-- analytics-main-content -->
</div><!-- analytics-layout -->
</div><!-- tab-analytics -->

<!-- ANALYTICS DETAIL MODAL -->
<div class="analytics-modal-overlay" id="analyticsModalOverlay" onclick="closeAnalyticsModal()">
<div class="analytics-modal" onclick="event.stopPropagation()">
<div class="analytics-modal-header">
<div style="display: flex; align-items: center; gap: 8px;">
<div class="section-indicator"></div>
<h3 style="font-size: var(--text-lg); font-weight: 700; color: var(--text-primary); margin: 0;" id="analyticsModalTitle">Score Analysis</h3>
<span style="padding: 2px 8px; border-radius: 4px; font-size: var(--text-2xs); font-weight: 700; background: rgba(234,179,8,0.2); color: var(--accent);">PRO</span>
</div>
<button onclick="closeAnalyticsModal()" class="analytics-modal-close">
<svg fill="none" height="20" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="20"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</button>
</div>
<div class="analytics-modal-body" id="analyticsModalBody">
</div>
</div>
</div>

<!-- COMPARE TAB (PRO) -->
<div aria-hidden="true" aria-labelledby="tabbtn-compare" class="tab-panel" id="tab-compare" role="tabpanel" tabindex="0">
<div class="p-6 max-w-[1600px] mx-auto">
<!-- Comparison Controls -->
<div class="flex justify-between items-center mb-6">
<div class="flex gap-2">
<button class="quick-action-btn" onclick="addToCompare()" type="button">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>
            Add Current Deal
          </button>
<button class="quick-action-btn" onclick="clearCompare()" type="button">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            Clear All
          </button>
</div>
<div class="text-sm" style="color: var(--text-muted);">
<span id="compareCount">0</span> deals in comparison
        </div>
</div>
<!-- Comparison Grid -->
<div class="compare-grid" id="compareGrid">
<div class="card p-8 text-center" style="border: 2px dashed var(--border-primary);">
<div class="text-4xl mb-4" style="opacity: 0.3;"></div>
<div class="text-sm" style="color: var(--text-muted);">No deals added yet</div>
<div class="text-xs mt-2" style="color: var(--text-muted);">Use "Add Current Deal" or press <kbd class="kbd">Ctrl+D</kbd></div>
</div>
</div>
<!-- Comparison Summary -->
<div class="card p-6 mt-6" id="compareSummary" style="display: none;">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Comparison Summary</h3>
</div>
<div class="grid grid-cols-4 gap-4">
<div class="text-center p-4" style="background: var(--bg-option-card); border-radius: 8px;">
<div class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Highest Funding</div>
<div class="text-xl font-bold" id="summaryHighestFunding" style="color: #22c55e;">--</div>
</div>
<div class="text-center p-4" style="background: var(--bg-option-card); border-radius: 8px;">
<div class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Best Score</div>
<div class="text-xl font-bold" id="summaryBestScore" style="color: var(--accent);">--</div>
</div>
<div class="text-center p-4" style="background: var(--bg-option-card); border-radius: 8px;">
<div class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Lowest Risk</div>
<div class="text-xl font-bold" id="summaryLowestRisk" style="color: #3b82f6;">--</div>
</div>
<div class="text-center p-4" style="background: var(--bg-option-card); border-radius: 8px;">
<div class="text-xs font-semibold uppercase" style="color: var(--text-muted);">Best ROI</div>
<div class="text-xl font-bold" id="summaryBestROI" style="color: #22c55e;">--</div>
</div>
</div>
</div>
</div>
</div>
<!-- REPORTS TAB (PRO) -->
<div aria-hidden="true" aria-labelledby="tabbtn-reports" class="tab-panel" id="tab-reports" role="tabpanel" tabindex="0">
<div class="p-6 max-w-[1600px] mx-auto">
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<!-- Report Options -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Report Options</h3>
</div>
<div class="space-y-3">
<label class="flex items-center gap-3 p-3 cursor-pointer" style="background: var(--bg-option-card); border-radius: 8px;">
<input checked="" id="reportExecSummary" style="accent-color: var(--accent);" type="checkbox"/>
<div>
<div class="text-sm font-semibold" style="color: var(--text-primary);">Executive Summary</div>
<div class="text-xs" style="color: var(--text-muted);">One-page overview</div>
</div>
</label>
<label class="flex items-center gap-3 p-3 cursor-pointer" style="background: var(--bg-option-card); border-radius: 8px;">
<input checked="" id="reportDetailedMemo" style="accent-color: var(--accent);" type="checkbox"/>
<div>
<div class="text-sm font-semibold" style="color: var(--text-primary);">Detailed Underwriting Memo</div>
<div class="text-xs" style="color: var(--text-muted);">Full analysis breakdown</div>
</div>
</label>
<label class="flex items-center gap-3 p-3 cursor-pointer" style="background: var(--bg-option-card); border-radius: 8px;">
<input id="reportRiskAssess" style="accent-color: var(--accent);" type="checkbox"/>
<div>
<div class="text-sm font-semibold" style="color: var(--text-primary);">Risk Assessment</div>
<div class="text-xs" style="color: var(--text-muted);">Detailed risk factors</div>
</div>
</label>
<label class="flex items-center gap-3 p-3 cursor-pointer" style="background: var(--bg-option-card); border-radius: 8px;">
<input id="reportAuditTrail" style="accent-color: var(--accent);" type="checkbox"/>
<div>
<div class="text-sm font-semibold" style="color: var(--text-primary);">Audit Trail</div>
<div class="text-xs" style="color: var(--text-muted);">Decision log</div>
</div>
</label>
</div>
<div class="mt-6 space-y-3">
<button class="quick-action-btn primary w-full justify-center" onclick="exportPDF()" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" x2="12" y1="18" y2="12"></line><line x1="9" x2="15" y1="15" y2="15"></line></svg>
              Export PDF Report
            </button>
<button class="quick-action-btn w-full justify-center" onclick="exportCSV()" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
              Export CSV Data
            </button>
<button class="quick-action-btn w-full justify-center" onclick="copyToClipboard()" type="button">
<svg fill="none" height="16" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="16"><rect height="13" rx="2" ry="2" width="13" x="9" y="9"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              Copy to Clipboard
            </button>
</div>
</div>
<!-- Deal Notes -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Deal Notes</h3>
</div>
<textarea class="deal-notes-textarea" id="dealNotes" placeholder="Add notes about this deal...

- Key considerations
- Special circumstances
- Follow-up items"></textarea>
<div class="mt-3 flex justify-between items-center">
<span class="text-xs" style="color: var(--text-muted);">Notes are saved with deal</span>
<button class="text-xs font-semibold" onclick="clearNotes()" style="color: var(--accent);" type="button">Clear</button>
</div>
</div>
<!-- Audit Trail -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Decision Audit Trail</h3>
</div>
<div class="audit-trail" id="auditTrail">
<div class="audit-entry">
<div class="audit-time">--:--</div>
<div class="audit-action" style="color: var(--text-muted);">No actions recorded yet</div>
</div>
</div>
</div>
<!-- Report Preview -->
<div class="card p-6 lg:col-span-3">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-3">
<div class="section-indicator"></div>
<h3 class="section-title">Report Preview</h3>
</div>
<div class="flex gap-2">
<button class="quick-action-btn" onclick="shareOfferCalculator()" type="button">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line></svg>
                Share
              </button>
<button class="quick-action-btn" onclick="toggleTheme()" type="button">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14"><circle cx="12" cy="12" r="5"></circle><line x1="12" x2="12" y1="1" y2="3"></line><line x1="12" x2="12" y1="21" y2="23"></line><line x1="4.22" x2="5.64" y1="4.22" y2="5.64"></line><line x1="18.36" x2="19.78" y1="18.36" y2="19.78"></line><line x1="1" x2="3" y1="12" y2="12"></line><line x1="21" x2="23" y1="12" y2="12"></line><line x1="4.22" x2="5.64" y1="19.78" y2="18.36"></line><line x1="18.36" x2="19.78" y1="5.64" y2="4.22"></line></svg>
                Toggle Theme
              </button>
</div>
</div>
<div class="report-preview" id="reportPreview">
<div class="report-header">
<div class="report-logo">
<span style="color: #000;">ABLES</span><span style="color: #eab308;">AI</span>
<span style="font-size: var(--text-xs); color: #eab308; vertical-align: super; margin-left: 2px;">PRO</span>
</div>
<div class="report-title">Underwriting Decision Report</div>
<div style="font-size: var(--text-base); color: #666; margin-top: 8px;">
                Generated: <span id="reportDate">--</span> | Deal ID: <span id="reportDealId">--</span>
</div>
</div>
<div class="report-section">
<div class="report-section-title">Executive Summary</div>
<div class="report-summary-grid grid grid-cols-4 gap-4 text-center">
<div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
<div style="font-size: var(--text-xs); color: #666; text-transform: uppercase;">ABLESCORE</div>
<div class="report-big-value" id="reportScore" style="font-size: var(--text-5xl); font-weight: 800; color: #eab308;">--</div>
</div>
<div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
<div style="font-size: var(--text-xs); color: #666; text-transform: uppercase;">Funding</div>
<div class="report-big-value" id="reportFunding" style="font-size: var(--text-5xl); font-weight: 800; color: #000;">--</div>
</div>
<div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
<div style="font-size: var(--text-xs); color: #666; text-transform: uppercase;">Term</div>
<div class="report-big-value" id="reportTerm" style="font-size: var(--text-5xl); font-weight: 800; color: #000;">--</div>
</div>
<div style="background: #f5f5f5; padding: 16px; border-radius: 8px;">
<div style="font-size: var(--text-xs); color: #666; text-transform: uppercase;">Factor</div>
<div class="report-big-value" id="reportFactor" style="font-size: var(--text-5xl); font-weight: 800; color: #000;">--</div>
</div>
</div>
</div>
<div class="report-section">
<div class="report-section-title">Decision</div>
<div id="reportDecision" style="font-size: var(--text-2xl); font-weight: 600; padding: 16px; background: #f0fdf4; border-left: 4px solid #22c55e; border-radius: 4px;">
                --
              </div>
</div>
<div class="report-section">
<div class="report-section-title">Merchant Profile</div>
<div class="report-profile-grid grid grid-cols-2 gap-x-8 gap-y-2" style="font-size: var(--text-md);">
<div class="flex justify-between py-2" style="border-bottom: 1px solid #eee;">
<span style="color: #666;">Monthly Revenue</span>
<span id="reportRevenue" style="font-weight: 600;">--</span>
</div>
<div class="flex justify-between py-2" style="border-bottom: 1px solid #eee;">
<span style="color: #666;">Credit Score</span>
<span id="reportCreditScore" style="font-weight: 600;">--</span>
</div>
<div class="flex justify-between py-2" style="border-bottom: 1px solid #eee;">
<span style="color: #666;">Time in Business</span>
<span id="reportTIB" style="font-weight: 600;">--</span>
</div>
<div class="flex justify-between py-2" style="border-bottom: 1px solid #eee;">
<span style="color: #666;">Avg Daily Balance</span>
<span id="reportADB" style="font-weight: 600;">--</span>
</div>
<div class="flex justify-between py-2" style="border-bottom: 1px solid #eee;">
<span style="color: #666;">NSF/Overdrafts (90d)</span>
<span id="reportNSF" style="font-weight: 600;">--</span>
</div>
<div class="flex justify-between py-2" style="border-bottom: 1px solid #eee;">
<span style="color: #666;">Negative Days (90d)</span>
<span id="reportNegDays" style="font-weight: 600;">--</span>
</div>
</div>
</div>
<div class="report-section">
<div class="report-section-title">Payment Terms</div>
<div class="report-payment-grid grid grid-cols-3 gap-4" style="font-size: var(--text-md);">
<div style="background: #f5f5f5; padding: 12px; border-radius: 6px;">
<div style="color: #666; font-size: var(--text-xs); text-transform: uppercase;">Payback Amount</div>
<div id="reportPayback" style="font-weight: 700; font-size: var(--text-xl);">--</div>
</div>
<div style="background: #f5f5f5; padding: 12px; border-radius: 6px;">
<div style="color: #666; font-size: var(--text-xs); text-transform: uppercase;">Daily Payment</div>
<div id="reportDailyPmt" style="font-weight: 700; font-size: var(--text-xl);">--</div>
</div>
<div style="background: #f5f5f5; padding: 12px; border-radius: 6px;">
<div style="color: #666; font-size: var(--text-xs); text-transform: uppercase;">Weekly Payment</div>
<div id="reportWeeklyPmt" style="font-weight: 700; font-size: var(--text-xl);">--</div>
</div>
</div>
</div>
<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: var(--text-xs); color: #999; text-align: center;">
              This report was generated by ABLESAI PRO Underwriting Engine. For internal use only.
            </div>
</div>
</div>
</div>
</div>
</div>
<!-- SEND TAB (PRO) -->
<div aria-hidden="true" aria-labelledby="tabbtn-send" class="tab-panel" id="tab-send" role="tabpanel" tabindex="0">
<div class="p-6 max-w-[1600px] mx-auto">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<!-- Left Column - Package Summary -->
<div class="space-y-6">
<!-- Deal Status Card -->
<div class="card p-6">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-3">
<div class="section-indicator"></div>
<h3 class="section-title">Package Status</h3>
</div>
<div id="sendDealStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold" style="background: rgba(16, 185, 129, 0.15); color: #10b981;">
<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
Ready to Send
</div>
</div>
<div class="text-xs" style="color: var(--text-muted);">
Package prepared: <span id="sendPackageTime">--</span>
</div>
</div>

<!-- Merchant Profile Summary -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Merchant Profile</h3>
</div>
<div class="grid grid-cols-2 gap-4">
<div class="p-3 rounded-lg" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">Credit Score</div>
<div class="text-lg font-bold" id="sendCreditScore" style="color: var(--text-primary);">--</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">Monthly Revenue</div>
<div class="text-lg font-bold" id="sendRevenue" style="color: var(--text-primary);">--</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">Avg Daily Balance</div>
<div class="text-lg font-bold" id="sendADB" style="color: var(--text-primary);">--</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">Time in Business</div>
<div class="text-lg font-bold" id="sendTIB" style="color: var(--text-primary);">--</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">NSF/Overdrafts (90d)</div>
<div class="text-lg font-bold" id="sendNSF" style="color: var(--text-primary);">--</div>
</div>
<div class="p-3 rounded-lg" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">Negative Days (90d)</div>
<div class="text-lg font-bold" id="sendNegDays" style="color: var(--text-primary);">--</div>
</div>
</div>
</div>

<!-- Approved Offer Terms -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Approved Offer Terms</h3>
</div>
<div class="grid grid-cols-2 gap-4 mb-4">
<div class="p-4 rounded-lg text-center" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">FUNDING AMOUNT</div>
<div class="text-2xl font-bold" id="sendFunding" style="color: var(--accent);">--</div>
</div>
<div class="p-4 rounded-lg text-center" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">FACTOR RATE</div>
<div class="text-2xl font-bold" id="sendFactor" style="color: var(--text-primary);">--</div>
</div>
<div class="p-4 rounded-lg text-center" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">PAYBACK AMOUNT</div>
<div class="text-2xl font-bold" id="sendPayback" style="color: var(--text-primary);">--</div>
</div>
<div class="p-4 rounded-lg text-center" style="background: var(--bg-option-card);">
<div class="text-xs font-semibold mb-1" style="color: var(--text-muted);">TERM LENGTH</div>
<div class="text-2xl font-bold" id="sendTerm" style="color: var(--text-primary);">--</div>
</div>
</div>
<!-- Daily Payment Highlight -->
<div class="p-4 rounded-lg text-center" style="background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(245, 158, 11, 0.1)); border: 1px solid rgba(234, 179, 8, 0.3);">
<div class="text-xs font-semibold mb-1" style="color: var(--accent);">DAILY PAYMENT</div>
<div class="text-3xl font-bold" id="sendDailyPayment" style="color: var(--accent);">--</div>
</div>
</div>

<!-- ABLESCORE Rating -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">ABLESCORE Rating</h3>
</div>
<div class="flex items-center gap-6">
<div class="flex-shrink-0 w-24 h-24 rounded-full flex items-center justify-center" style="background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.05)); border: 3px solid var(--accent);">
<div class="text-center">
<div class="text-3xl font-bold" id="sendScore" style="color: var(--accent);">--</div>
<div class="text-xs" style="color: var(--text-muted);">/100</div>
</div>
</div>
<div class="flex-1">
<div class="flex items-center gap-2 mb-2">
<span class="text-2xl font-bold" id="sendTierLetter" style="color: var(--accent);">--</span>
<span class="text-sm font-semibold px-2 py-0.5 rounded" id="sendTierBadge" style="background: rgba(234, 179, 8, 0.15); color: var(--accent);">--</span>
</div>
<div class="text-sm" id="sendRiskLevel" style="color: var(--text-secondary);">--</div>
</div>
</div>
</div>
</div>

<!-- Right Column - Preview & Sharing -->
<div class="space-y-6">
<!-- Shareable Link -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Shareable Offer Link</h3>
</div>
<div class="flex gap-2 mb-4">
<input type="text" id="sendShareableLink" readonly class="flex-1 px-4 py-3 rounded-lg text-sm" style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);" value="https://ables.ai/offer/..." />
<button onclick="copySendLink()" class="px-4 py-3 rounded-lg font-semibold text-sm" style="background: var(--accent); color: var(--accent-text);">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
</button>
</div>
<!-- Quick Share Buttons -->
<div class="grid grid-cols-3 gap-2">
<button onclick="sendViaEmail()" class="quick-action-btn justify-center" type="button">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
Email
</button>
<button onclick="sendViaSMS()" class="quick-action-btn justify-center" type="button">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
SMS
</button>
<button onclick="showQRCode()" class="quick-action-btn justify-center" type="button">
<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
QR Code
</button>
</div>
</div>

<!-- ISO Preview Card -->
<div class="card p-6">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-3">
<div class="section-indicator"></div>
<h3 class="section-title">ISO Calculator Preview</h3>
</div>
<span class="text-xs px-2 py-1 rounded" style="background: rgba(234, 179, 8, 0.15); color: var(--accent);">What Broker Sees</span>
</div>
<!-- Mini Preview -->
<div class="rounded-xl overflow-hidden" style="background: var(--bg-card-inner); border: 1px solid var(--border-secondary);">
<div class="p-6 text-center" style="background: linear-gradient(135deg, #000 0%, #0a0a0a 100%);">
<div class="text-xs font-semibold uppercase tracking-wider mb-2" style="color: #666;">Approved Funding</div>
<div class="text-4xl font-bold" id="sendPreviewFunding" style="color: #fff;">--</div>
</div>
<div class="grid grid-cols-2" style="background: #0a0a0a;">
<div class="p-4 text-center border-r border-b" style="border-color: #1a1a1a;">
<div class="text-xs" style="color: #666;">Factor</div>
<div class="text-lg font-bold" id="sendPreviewFactor" style="color: #fff;">--</div>
</div>
<div class="p-4 text-center border-b" style="border-color: #1a1a1a;">
<div class="text-xs" style="color: #666;">Term</div>
<div class="text-lg font-bold" id="sendPreviewTerm" style="color: #fff;">--</div>
</div>
<div class="p-4 text-center border-r" style="border-color: #1a1a1a;">
<div class="text-xs" style="color: #666;">Payback</div>
<div class="text-lg font-bold" id="sendPreviewPayback" style="color: #fff;">--</div>
</div>
<div class="p-4 text-center" style="border-color: #1a1a1a;">
<div class="text-xs" style="color: #666;">Daily</div>
<div class="text-lg font-bold" id="sendPreviewDaily" style="color: #eab308;">--</div>
</div>
</div>
</div>
</div>

<!-- Action Buttons -->
<div class="card p-6">
<div class="flex items-center gap-3 mb-4">
<div class="section-indicator"></div>
<h3 class="section-title">Send Package</h3>
</div>
<div class="space-y-3">
<button onclick="sendToISO()" class="quick-action-btn primary w-full justify-center py-3" type="button">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"></path><path d="M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
Send to ISO / Broker
</button>
<button onclick="sendToMerchant()" class="quick-action-btn w-full justify-center py-3" type="button">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
Send to Merchant
</button>
<button onclick="downloadSendPDF()" class="quick-action-btn w-full justify-center py-3" type="button">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
Download Package PDF
</button>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Floating Action Button for Sliders (Mobile) -->
<button class="slider-fab" id="sliderFab" onclick="openSliderModal()" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<rect fill="none" height="20" rx="2" stroke="currentColor" stroke-width="2" width="16" x="4" y="2"></rect>
<rect fill="currentColor" height="4" rx="1" width="10" x="7" y="5"></rect>
<circle cx="8" cy="13" fill="currentColor" r="1.2"></circle>
<circle cx="12" cy="13" fill="currentColor" r="1.2"></circle>
<circle cx="16" cy="13" fill="currentColor" r="1.2"></circle>
<circle cx="8" cy="17" fill="currentColor" r="1.2"></circle>
<circle cx="12" cy="17" fill="currentColor" r="1.2"></circle>
<circle cx="16" cy="17" fill="currentColor" r="1.2"></circle>
</svg>
</button>
<!-- Slider Modal Overlay -->
<div aria-hidden="true" aria-labelledby="modalTitle" aria-modal="true" class="slider-modal-overlay" id="sliderModalOverlay" onclick="closeSliderModal(event)" role="dialog">
<div class="slider-modal" onclick="event.stopPropagation()">
<div class="slider-modal-header">
<span class="slider-modal-title" id="modalTitle">Input Parameters</span>
<button aria-label="Close dialog" class="slider-modal-close" onclick="closeSliderModal()" type="button"></button>
</div>
<!-- MODEL SCORE Sliders (Qualifications) -->
<div id="modalCalcContent">
<!-- Score Meter -->
<div class="modal-score-meter">
<div class="modal-score-header">
<div class="modal-score-info">
<div class="modal-tier-badge" id="modalTierBadge" style="border-color: #eab308;">
<div class="modal-tier-letter" id="modalTierLetter" style="color: #eab308;">C</div>
<div class="modal-tier-label" id="modalTierLabel">Mid-Prime</div>
</div>
<div class="modal-score-text">
<div class="modal-score-label">ABLESAI Score</div>
<div class="modal-score-value">
<span class="modal-score-number" id="modalScoreNumber">62</span>
<span class="modal-score-max">/100</span>
</div>
</div>
</div>
<div class="modal-score-bar-container">
<div class="modal-score-bar">
<div class="modal-score-bar-fill" id="modalScoreBarFill" style="width: 100%;"></div>
<div class="modal-score-bar-marker" id="modalScoreMarker" style="left: 62%;"></div>
</div>
<div class="modal-score-scale">
<span style="color: #ef4444;">E <span style="opacity:0.6">0</span></span>
<span style="color: #f97316;">D <span style="opacity:0.6">35</span></span>
<span style="color: #eab308;">C <span style="opacity:0.6">50</span></span>
<span style="color: #22c55e;">B <span style="opacity:0.6">65</span></span>
<span style="color: #10b981;">A <span style="opacity:0.6">80+</span></span>
</div>
</div>
</div>
</div>
<!-- Offer Terms Section - between score and sliders -->
<div class="modal-offer-terms">
<div class="modal-section-label">Calculated Offer Terms</div>
<div class="sliders-grid">
<div class="slider-cell offer-term-cell">
<label>Funding Amount</label>
<div class="value" id="modalCalcFundingDisplay">$17,500</div>
</div>
<div class="slider-cell offer-term-cell">
<label>Factor Rate</label>
<div class="value" id="modalCalcFactorDisplay">1.32x</div>
</div>
<div class="slider-cell offer-term-cell">
<label>Term Length</label>
<div class="value" id="modalCalcTermDisplay">9 mo</div>
</div>
</div>
</div>
<div class="sliders-grid" id="modalSlidersGrid">
<!-- Credit -->
<div class="slider-cell">
<label>Credit Score</label>
<input class="value editable-value" id="modalCreditDisplay" onchange="updateFromModalInput('creditScore', 'modalCreditScore', this.value, 450, 850)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 60px; font-size: var(--text-lg);" type="text" value="650"/>
<input class="slider" id="modalCreditScore" max="850" min="450" oninput="syncSlider('creditScore', this.value)" step="1" type="range" value="650"/>
</div>
<!-- Revenue -->
<div class="slider-cell">
<label>Monthly Revenue</label>
<input class="value editable-value" id="modalRevenueDisplay" onchange="updateFromModalInput('monthlyRevenue', 'modalMonthlyRevenue', this.value, 5000, 500000, true)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 85px; font-size: var(--text-lg);" type="text" value="$50,000"/>
<input class="slider" id="modalMonthlyRevenue" max="500000" min="5000" oninput="syncSlider('monthlyRevenue', this.value)" step="1" type="range" value="50000"/>
</div>
<!-- Balance -->
<div class="slider-cell">
<label>Avg Daily Balance</label>
<input class="value editable-value" id="modalBalanceDisplay" onchange="updateFromModalInput('avgDailyBalance', 'modalAvgDailyBalance', this.value, 500, 100000, true)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 75px; font-size: var(--text-lg);" type="text" value="$8,000"/>
<input class="slider" id="modalAvgDailyBalance" max="100000" min="500" oninput="syncSlider('avgDailyBalance', this.value)" step="1" type="range" value="8000"/>
</div>
<!-- TIB -->
<div class="slider-cell">
<label>Time in Business</label>
<div style="display: flex; align-items: baseline; gap: 4px;">
<input class="value editable-value" id="modalTibDisplay" onchange="updateFromModalInput('timeInBusiness', 'modalTimeInBusiness', this.value, 3, 120)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 45px; font-size: var(--text-lg);" type="text" value="24"/>
<span style="font-size: var(--text-base); color: var(--text-muted);">mo</span>
</div>
<input class="slider" id="modalTimeInBusiness" max="120" min="3" oninput="syncSlider('timeInBusiness', this.value)" step="1" type="range" value="24"/>
</div>
<!-- NSF -->
<div class="slider-cell">
<label>NSF / Overdrafts <span style="font-weight: 400; opacity: 0.6;">(90 Days)</span></label>
<input class="value editable-value" id="modalNsfDisplay" onchange="updateFromModalInput('nsfCount', 'modalNsfCount', this.value, 0, 15)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 40px; font-size: var(--text-2xl);" type="text" value="0"/>
<input class="slider" id="modalNsfCount" max="15" min="0" oninput="syncSlider('nsfCount', this.value)" step="1" type="range" value="0"/>
</div>
<!-- Negative Days -->
<div class="slider-cell">
<label>Negative Days <span style="font-weight: 400; opacity: 0.6;">(90 Days)</span></label>
<div style="display: flex; align-items: baseline; gap: 4px;">
<input class="value editable-value" id="modalNegDaysDisplay" onchange="updateFromModalInput('negativeDays', 'modalNegativeDays', this.value, 0, 15)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 40px; font-size: var(--text-2xl);" type="text" value="0"/>
<span style="font-size: var(--text-base); color: var(--text-muted);">days</span>
</div>
<input class="slider" id="modalNegativeDays" max="30" min="0" oninput="syncSlider('negativeDays', this.value)" step="1" type="range" value="0"/>
</div>
</div>
<!-- Existing Debt - Full Width -->
<div class="slider-cell" style="margin-bottom: 8px;">
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
<label style="margin-bottom: 0;">Existing Debt Payments</label>
<div style="display: flex; align-items: center; gap: 4px;">
<span style="font-size: var(--text-2xs); color: var(--text-muted);">paid</span>
<select id="modalExistingDebtFreqSelect" onchange="syncExistingDebtFreq(this.value)" style="font-size: var(--text-2xs); padding: 2px 4px; background: var(--bg-primary); color: var(--text-muted); border: 1px solid var(--border-secondary); border-radius: 4px;">
<option value="daily">daily</option>
<option value="weekly">weekly</option>
<option value="monthly">monthly</option>
</select>
</div>
</div>
<input class="value editable-value" id="modalExistingDebtDisplay" onchange="updateFromModalInput('existingDebt', 'modalExistingDebt', this.value, 0, 15000, true)" onkeydown="if(event.key==='Enter'){this.blur()}" style="width: 75px; font-size: var(--text-lg);" type="text" value="$0"/>
<input class="slider" id="modalExistingDebt" max="15000" min="0" oninput="syncSlider('existingDebt', this.value)" step="1" type="range" value="0"/>
<!-- Hidden radios for compatibility -->
<div style="display: none;">
<input checked="" name="modalExistingDebtFreq" type="radio" value="daily"/>
<input name="modalExistingDebtFreq" type="radio" value="weekly"/>
<input name="modalExistingDebtFreq" type="radio" value="monthly"/>
</div>
</div>
<!-- Industry Dropdown -->
<div class="slider-cell" style="margin-bottom: 8px;">
<label>Industry</label>
<select class="w-full px-2 py-1.5 rounded-lg text-xs font-semibold" id="modalIndustrySelect" onchange="syncIndustry(this.value)" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-secondary);">
<optgroup label="Standard Industries">
<option value="retail">Retail / E-commerce</option>
<option value="restaurant">Restaurant / Food Service</option>
<option value="construction">Construction / Contracting</option>
<option value="auto">Auto Repair / Dealer</option>
<option value="medical">Medical / Healthcare</option>
<option value="professional">Professional Services</option>
<option value="manufacturing">Manufacturing</option>
<option value="wholesale">Wholesale / Distribution</option>
<option value="beauty">Beauty / Salon / Spa</option>
<option value="fitness">Fitness / Gym</option>
<option value="other">Other (Standard)</option>
</optgroup>
<optgroup label="Restricted (Fleet Size Required)">
<option value="trucking">Trucking / Transportation</option>
</optgroup>
<optgroup label="Prohibited Industries">
<option value="gambling">Gambling / Casino</option>
<option value="adult">Adult Entertainment</option>
<option value="cannabis">Cannabis / CBD</option>
<option value="firearms">Firearms / Weapons</option>
<option value="crypto">Cryptocurrency</option>
<option value="collection">Debt Collection</option>
<option value="telemarketing">Telemarketing</option>
<option value="pawn">Pawn Shop</option>
</optgroup>
</select>
<!-- Modal Fleet Size (hidden by default) -->
<div id="modalTruckingFleetSection" style="display: none; margin-top: 6px;">
<select class="w-full px-2 py-1 rounded-lg text-xs font-semibold" id="modalFleetSize" onchange="syncFleetSize(this.value)" style="background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border-secondary);">
<option value="1">1 vehicle</option>
<option value="2">2 vehicles</option>
<option value="3">3 vehicles</option>
<option value="4">4 vehicles</option>
<option value="5">5 vehicles</option>
<option value="6">6-10 vehicles</option>
<option value="11">11-20 vehicles</option>
<option value="21">21+ vehicles</option>
</select>
</div>
</div>
</div>
<!-- MODEL OVERRIDE Sliders (Terms) -->
<div id="modalOverrideContent" style="display: none;">
<!-- Score Meter for Override -->
<div class="modal-score-meter">
<div class="modal-score-header">
<div class="modal-score-info">
<div class="modal-tier-badge" id="modalOverrideTierBadge" style="border-color: #eab308;">
<div class="modal-tier-letter" id="modalOverrideTierLetter" style="color: #eab308;">C</div>
<div class="modal-tier-label" id="modalOverrideTierLabel">Mid-Prime</div>
</div>
<div class="modal-score-text">
<div class="modal-score-label">ABLESAI Score</div>
<div class="modal-score-value">
<span class="modal-score-number" id="modalOverrideScoreNumber">62</span>
<span class="modal-score-max">/100</span>
</div>
</div>
</div>
<div class="modal-score-bar-container">
<div class="modal-score-bar">
<div class="modal-score-bar-fill" id="modalOverrideScoreBarFill" style="width: 100%;"></div>
<div class="modal-score-bar-marker" id="modalOverrideScoreMarker" style="left: 62%;"></div>
</div>
<div class="modal-score-scale">
<span style="color: #ef4444;">E <span style="opacity:0.6">0</span></span>
<span style="color: #f97316;">D <span style="opacity:0.6">35</span></span>
<span style="color: #eab308;">C <span style="opacity:0.6">50</span></span>
<span style="color: #22c55e;">B <span style="opacity:0.6">65</span></span>
<span style="color: #10b981;">A <span style="opacity:0.6">80+</span></span>
</div>
</div>
</div>
<!-- Risk Metrics Row - Compact inline -->
<div class="modal-risk-metrics-inline">
<div class="modal-pd-inline">
<div class="modal-pd-gauge-small">
<svg height="36" viewbox="0 0 180 100" width="60">
<path class="gauge-arc gauge-bg" d="M 20 80 A 60 60 0 0 1 160 80"></path>
<path class="gauge-arc gauge-fill" d="M 20 80 A 60 60 0 0 1 160 80" id="modalPdGaugeFill" stroke="#10b981" stroke-dasharray="0 188"></path>
</svg>
</div>
<div class="modal-pd-info">
<span class="modal-pd-number" id="modalPdValue">8.2%</span>
<span class="modal-pd-text">Est. PD</span>
</div>
</div>
<div class="modal-dscr-inline">
<div class="modal-dscr-mini-bar">
<div class="modal-dscr-mini-fill" id="modalDscrFill" style="width: 62%; background: #10b981;">
<span id="modalDscrBarValue">1.85x</span>
</div>
</div>
<div class="modal-dscr-info">
<span class="modal-dscr-number" id="modalDscrRatio">1.85x</span>
<span class="modal-dscr-text">DSCR</span>
</div>
</div>
</div>
</div>
<!-- Calculated Terms (from model) -->
<div class="modal-offer-terms">
<div class="modal-section-label">Model Calculated Terms</div>
<div class="sliders-grid">
<div class="slider-cell offer-term-cell">
<label>Funding Amount</label>
<div class="value" id="modalOverrideCalcFunding">$17,500</div>
</div>
<div class="slider-cell offer-term-cell">
<label>Factor Rate</label>
<div class="value" id="modalOverrideCalcFactor">1.32x</div>
</div>
<div class="slider-cell offer-term-cell">
<label>Term Length</label>
<div class="value" id="modalOverrideCalcTerm">9 mo</div>
</div>
</div>
</div>
<!-- Override Sliders with Variance -->
<div class="modal-override-section">
<div class="modal-section-label" style="color: var(--text-muted);">Override Terms</div>
<div class="sliders-grid override-grid">
<!-- Funding Amount -->
<div class="slider-cell override-slider-cell">
<label>Funding Amount</label>
<div class="override-value-row">
<div class="value" id="modalOverrideFundingDisplay">$17,500</div>
<div class="variance-badge" id="modalFundingVariance">+$0</div>
</div>
<input class="slider" id="modalOverrideFunding" max="100000" min="5000" oninput="syncOverrideSlider('overrideFunding', this.value)" step="1" type="range" value="17500"/>
</div>
<!-- Factor Rate -->
<div class="slider-cell override-slider-cell">
<label>Factor Rate</label>
<div class="override-value-row">
<div class="value" id="modalOverrideFactorDisplay">1.32x</div>
<div class="variance-badge" id="modalFactorVariance">+0.00</div>
</div>
<input class="slider" id="modalOverrideFactor" max="1.55" min="1.15" oninput="syncOverrideSlider('overrideFactor', this.value)" step="0.01" type="range" value="1.32"/>
</div>
<!-- Term -->
<div class="slider-cell override-slider-cell">
<label>Term Length</label>
<div class="override-value-row">
<div class="value" id="modalOverrideTermDisplay">9 Months</div>
<div class="variance-badge" id="modalTermVariance">+0 mo</div>
</div>
<input class="slider" id="modalOverrideTerm" max="15" min="3" oninput="syncOverrideSlider('overrideTerm', this.value)" step="1" type="range" value="9"/>
</div>
</div>
</div>
<!-- Payment Frequency for Override -->
<div class="toggle-section" style="margin-top: 12px;">
<label>Payment Frequency</label>
<div class="freq-toggle-group">
<label class="freq-toggle">
<input checked="" name="modalOverridePaymentFreq" onchange="syncOverrideRadio('overridePaymentFreq', 'daily')" type="radio" value="daily"/>
<span class="freq-toggle-btn">Daily</span>
</label>
<label class="freq-toggle">
<input name="modalOverridePaymentFreq" onchange="syncOverrideRadio('overridePaymentFreq', 'weekly')" type="radio" value="weekly"/>
<span class="freq-toggle-btn">Weekly</span>
</label>
</div>
</div>
</div>
</div>
</div>
<!-- Settings Modal -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target === this) closeSettings()">
<div class="settings-modal">
<div class="settings-header">
<h2>Settings</h2>
<button class="settings-close" onclick="closeSettings()" type="button">
<svg fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<line x1="18" x2="6" y1="6" y2="18"></line>
<line x1="6" x2="18" y1="6" y2="18"></line>
</svg>
</button>
</div>
<div class="settings-body">
<!-- Appearance Section -->
<div class="settings-section">
<div class="settings-section-title">Appearance</div>
<div class="settings-row">
<div>
<div class="settings-row-label">Light Theme</div>
<div class="settings-row-desc">Switch to light mode for better visibility</div>
</div>
<div class="toggle-switch" id="themeToggle" onclick="toggleTheme()"></div>
</div>
</div>
<!-- Credit Model Tuning Section -->
<div class="settings-section">
<div class="settings-section-header">
<div class="settings-section-title">Credit Model Tuning</div>
<div class="mode-toggle-container">
<span class="mode-label" id="simpleModeLabel">Simple</span>
<div class="mode-toggle" id="modelModeToggle" onclick="toggleModelMode()">
<div class="mode-toggle-knob"></div>
</div>
<span class="mode-label" id="advancedModeLabel">Advanced</span>
</div>
</div>
<!-- Simple Mode Panel -->
<div class="model-mode-panel" id="simpleModelPanel">
<div class="simple-mode-desc">Choose a preset risk profile or adjust the overall model aggressiveness</div>
<div class="preset-buttons">
<button class="preset-btn" onclick="applyModelPreset('conservative')" id="presetConservative">
<span class="preset-icon preset-icon-conservative">C</span>
<span class="preset-name">Conservative</span>
<span class="preset-desc">Lower risk tolerance, stricter scoring</span>
</button>
<button class="preset-btn active" onclick="applyModelPreset('balanced')" id="presetBalanced">
<span class="preset-icon preset-icon-balanced">B</span>
<span class="preset-name">Balanced</span>
<span class="preset-desc">Default settings, moderate approach</span>
</button>
<button class="preset-btn" onclick="applyModelPreset('aggressive')" id="presetAggressive">
<span class="preset-icon preset-icon-aggressive">A</span>
<span class="preset-name">Aggressive</span>
<span class="preset-desc">Higher risk tolerance, more approvals</span>
</button>
</div>
<div class="simple-slider-group">
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Model Aggressiveness</span>
<span class="model-slider-value" id="aggressivenessValue">50%</span>
</div>
<div class="model-slider-desc">Overall risk tolerance (0% = Very Conservative, 100% = Very Aggressive)</div>
<input class="model-slider-input" id="aggressivenessSlider" type="range" min="0" max="100" value="50" oninput="updateAggressiveness()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Revenue Emphasis</span>
<span class="model-slider-value" id="revenueEmphasisValue">Medium</span>
</div>
<div class="model-slider-desc">How much weight to place on monthly revenue</div>
<input class="model-slider-input" id="revenueEmphasisSlider" type="range" min="1" max="3" value="2" oninput="updateRevenueEmphasis()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Credit Score Emphasis</span>
<span class="model-slider-value" id="creditEmphasisValue">Medium</span>
</div>
<div class="model-slider-desc">How much weight to place on personal credit</div>
<input class="model-slider-input" id="creditEmphasisSlider" type="range" min="1" max="3" value="2" oninput="updateCreditEmphasis()"/>
</div>
</div>
</div>
<!-- Advanced Mode Panel -->
<div class="model-mode-panel hidden" id="advancedModelPanel">
<div class="settings-subsection-title">Score Component Weights</div>
<div class="weight-total-indicator">
<span>Total Weight:</span>
<span id="totalWeightValue" class="weight-total-value">100%</span>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Revenue Weight</span>
<span class="model-slider-value" id="revenueWeightValue">30%</span>
</div>
<div class="model-slider-desc">Impact of monthly revenue on score calculation</div>
<input class="model-slider-input" id="revenueWeightSlider" max="50" min="10" oninput="updateModelWeights()" type="range" value="30"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Time in Business Weight</span>
<span class="model-slider-value" id="tibWeightValue">20%</span>
</div>
<div class="model-slider-desc">Impact of business age on score calculation</div>
<input class="model-slider-input" id="tibWeightSlider" max="35" min="5" oninput="updateModelWeights()" type="range" value="20"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Industry Risk Weight</span>
<span class="model-slider-value" id="industryWeightValue">15%</span>
</div>
<div class="model-slider-desc">Impact of industry classification on score</div>
<input class="model-slider-input" id="industryWeightSlider" max="30" min="5" oninput="updateModelWeights()" type="range" value="15"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Credit Score Weight</span>
<span class="model-slider-value" id="creditWeightValue">20%</span>
</div>
<div class="model-slider-desc">Impact of personal credit on score calculation</div>
<input class="model-slider-input" id="creditWeightSlider" max="35" min="5" oninput="updateModelWeights()" type="range" value="20"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Negative Days Weight</span>
<span class="model-slider-value" id="negDaysWeightValue">15%</span>
</div>
<div class="model-slider-desc">Impact of negative balance days on score</div>
<input class="model-slider-input" id="negDaysWeightSlider" max="30" min="5" oninput="updateModelWeights()" type="range" value="15"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Collectibility Weight</span>
<span class="model-slider-value" id="collectibilityWeightValue">15%</span>
</div>
<div class="model-slider-desc">Impact of payment collection probability on score</div>
<input class="model-slider-input" id="collectibilityWeightSlider" max="30" min="5" oninput="updateModelWeights()" type="range" value="15"/>
</div>
<div class="settings-subsection-title">Calculation Parameters</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Base PD Multiplier</span>
<span class="model-slider-value" id="pdMultiplierValue">1.0x</span>
</div>
<div class="model-slider-desc">Adjust base probability of default calculation</div>
<input class="model-slider-input" id="pdMultiplierSlider" max="150" min="50" oninput="updateModelWeights()" type="range" value="100"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Funding % of Revenue</span>
<span class="model-slider-value" id="maxFundingPctValue">150%</span>
</div>
<div class="model-slider-desc">Maximum funding as percentage of monthly revenue</div>
<input class="model-slider-input" id="maxFundingPctSlider" max="250" min="50" oninput="updateModelWeights()" type="range" value="150"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Factor Rate Spread</span>
<span class="model-slider-value" id="factorSpreadValue">0.20</span>
</div>
<div class="model-slider-desc">Range between min and max factor rates per tier</div>
<input class="model-slider-input" id="factorSpreadSlider" max="40" min="10" oninput="updateModelWeights()" type="range" value="20"/>
</div>
</div>
<button class="settings-reset-btn" onclick="resetModelWeights()" type="button">Reset to Defaults</button>
</div>
<!-- Underwriting Criteria Section -->
<div class="settings-section">
<div class="settings-section-title">Underwriting Criteria</div>
<div class="settings-subsection-title">Minimum Requirements</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Min Monthly Revenue</span>
<span class="model-slider-value" id="minRevenueValue">$10,000</span>
</div>
<div class="model-slider-desc">Minimum monthly revenue required for approval</div>
<input class="model-slider-input" id="minRevenueSlider" type="range" min="5000" max="50000" step="1000" value="10000" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Min Time in Business</span>
<span class="model-slider-value" id="minTibValue">6 months</span>
</div>
<div class="model-slider-desc">Minimum months in business required</div>
<input class="model-slider-input" id="minTibSlider" type="range" min="3" max="24" step="1" value="6" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Min Credit Score</span>
<span class="model-slider-value" id="minCreditValue">500</span>
</div>
<div class="model-slider-desc">Minimum personal credit score required</div>
<input class="model-slider-input" id="minCreditSlider" type="range" min="400" max="600" step="10" value="500" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Min ABLESCORE</span>
<span class="model-slider-value" id="minAblescoreValue">450</span>
</div>
<div class="model-slider-desc">Minimum ABLESCORE for auto-approval consideration</div>
<input class="model-slider-input" id="minAblescoreSlider" type="range" min="300" max="600" step="10" value="450" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="settings-subsection-title">Maximum Limits</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Funding Amount</span>
<span class="model-slider-value" id="maxFundingValue">$500,000</span>
</div>
<div class="model-slider-desc">Maximum single funding amount allowed</div>
<input class="model-slider-input" id="maxFundingSlider" type="range" min="50000" max="1000000" step="25000" value="500000" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Negative Days</span>
<span class="model-slider-value" id="maxNegDaysValue">15 days</span>
</div>
<div class="model-slider-desc">Maximum negative balance days allowed per month</div>
<input class="model-slider-input" id="maxNegDaysSlider" type="range" min="0" max="30" step="1" value="15" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max NSF Count</span>
<span class="model-slider-value" id="maxNsfValue">5</span>
</div>
<div class="model-slider-desc">Maximum NSF occurrences allowed in 90 days</div>
<input class="model-slider-input" id="maxNsfSlider" type="range" min="0" max="15" step="1" value="5" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Daily Payment %</span>
<span class="model-slider-value" id="maxDailyPctValue">15%</span>
</div>
<div class="model-slider-desc">Max daily payment as % of avg daily balance</div>
<input class="model-slider-input" id="maxDailyPctSlider" type="range" min="5" max="25" step="1" value="15" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="settings-subsection-title">Factor Rate Boundaries</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Min Factor Rate</span>
<span class="model-slider-value" id="minFactorValue">1.15</span>
</div>
<div class="model-slider-desc">Lowest factor rate offered (Tier A best)</div>
<input class="model-slider-input" id="minFactorSlider" type="range" min="110" max="130" step="1" value="115" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Factor Rate</span>
<span class="model-slider-value" id="maxFactorValue">1.49</span>
</div>
<div class="model-slider-desc">Highest factor rate offered (Tier E worst)</div>
<input class="model-slider-input" id="maxFactorSlider" type="range" min="140" max="180" step="1" value="149" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="settings-subsection-title">Term Boundaries</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Min Term Length</span>
<span class="model-slider-value" id="minTermValue">3 months</span>
</div>
<div class="model-slider-desc">Shortest term offered</div>
<input class="model-slider-input" id="minTermSlider" type="range" min="2" max="6" step="1" value="3" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Term Length</span>
<span class="model-slider-value" id="maxTermValue">18 months</span>
</div>
<div class="model-slider-desc">Longest term offered</div>
<input class="model-slider-input" id="maxTermSlider" type="range" min="12" max="24" step="1" value="18" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="settings-subsection-title">Position Stacking Rules</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Stacking Positions</span>
<span class="model-slider-value" id="maxPositionsValue">3</span>
</div>
<div class="model-slider-desc">Maximum existing MCA positions allowed</div>
<input class="model-slider-input" id="maxPositionsSlider" type="range" min="1" max="5" step="1" value="3" oninput="updateUnderwritingCriteria()"/>
</div>
<div class="model-slider-row">
<div class="model-slider-header">
<span class="model-slider-label">Max Total Balance %</span>
<span class="model-slider-value" id="maxStackBalanceValue">200%</span>
</div>
<div class="model-slider-desc">Max existing balance as % of monthly revenue</div>
<input class="model-slider-input" id="maxStackBalanceSlider" type="range" min="50" max="300" step="10" value="200" oninput="updateUnderwritingCriteria()"/>
</div>
<button class="settings-reset-btn" onclick="resetUnderwritingCriteria()" type="button">Reset Criteria to Defaults</button>
</div>
</div>
</div>
</div>
<script>
    
    // Verify global scope
    window.ABLESAI_PRO_LOADED = false;
    
    // ============================================
    // TIER SYSTEM
    // ============================================
    
    const TIER_COLORS = {
      A: { main: '#10b981', rgb: '16, 185, 129', label: 'Prime' },
      B: { main: '#22c55e', rgb: '34, 197, 94', label: 'Near-Prime' },
      C: { main: '#eab308', rgb: '234, 179, 8', label: 'Mid-Prime' },
      D: { main: '#f97316', rgb: '249, 115, 22', label: 'Sub-Prime' },
      E: { main: '#ef4444', rgb: '239, 68, 68', label: 'High-Risk' }
    };

    const TIER_DATA = {
      A: { factor: 1.18, multiplier: 1.40, termMonths: 12 },
      B: { factor: 1.24, multiplier: 1.00, termMonths: 10 },
      C: { factor: 1.32, multiplier: 0.65, termMonths: 9 },
      D: { factor: 1.38, multiplier: 0.50, termMonths: 6 },
      E: { factor: 1.45, multiplier: 0.40, termMonths: 4 }
    };

    // ============================================
    // MODEL WEIGHTS (adjustable via settings)
    // ============================================
    const MODEL_WEIGHTS = {
      revenue: 30,
      tib: 20,
      industry: 15,
      credit: 20,
      negDays: 15,
      collectibility: 15,
      pdMultiplier: 100,
      maxFundingPct: 150,
      factorSpread: 20
    };

    const DEFAULT_WEIGHTS = { ...MODEL_WEIGHTS };

    // ============================================
    // UNDERWRITING CRITERIA (adjustable via settings)
    // ============================================
    const UNDERWRITING_CRITERIA = {
      // Minimum Requirements
      minRevenue: 10000,
      minTib: 6,
      minCredit: 500,
      minAblescore: 450,
      // Maximum Limits
      maxFunding: 500000,
      maxNegDays: 15,
      maxNsf: 5,
      maxDailyPct: 15,
      // Factor Rate Boundaries
      minFactor: 115,  // stored as 115 = 1.15
      maxFactor: 149,  // stored as 149 = 1.49
      // Term Boundaries
      minTerm: 3,
      maxTerm: 18,
      // Position Stacking Rules
      maxPositions: 3,
      maxStackBalance: 200
    };

    const DEFAULT_CRITERIA = { ...UNDERWRITING_CRITERIA };

    // ============================================
    // SETTINGS FUNCTIONS
    // ============================================
    function openSettings() {
      document.getElementById('settingsOverlay').classList.add('active');
      loadSettingsValues();
    }

    function closeSettings() {
      document.getElementById('settingsOverlay').classList.remove('active');
    }

    // ============================================
    // MODEL TUNING FUNCTIONS (Simple/Advanced)
    // ============================================
    let modelModeAdvanced = false;

    function toggleModelMode() {
      modelModeAdvanced = !modelModeAdvanced;
      const toggle = document.getElementById('modelModeToggle');
      const simplePanel = document.getElementById('simpleModelPanel');
      const advancedPanel = document.getElementById('advancedModelPanel');
      const simpleLabel = document.getElementById('simpleModeLabel');
      const advancedLabel = document.getElementById('advancedModeLabel');

      toggle.classList.toggle('advanced', modelModeAdvanced);
      simplePanel.classList.toggle('hidden', modelModeAdvanced);
      advancedPanel.classList.toggle('hidden', !modelModeAdvanced);
      simpleLabel.classList.toggle('active', !modelModeAdvanced);
      advancedLabel.classList.toggle('active', modelModeAdvanced);

      localStorage.setItem('modelModeAdvanced', modelModeAdvanced);
    }

    function applyModelPreset(preset) {
      // Update button states
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('preset' + preset.charAt(0).toUpperCase() + preset.slice(1)).classList.add('active');

      // Apply preset values
      const presets = {
        conservative: {
          revenue: 25, tib: 25, industry: 15, credit: 25, negDays: 15, collectibility: 10,
          pdMultiplier: 120, maxFundingPct: 100, factorSpread: 15,
          aggressiveness: 25
        },
        balanced: {
          revenue: 30, tib: 20, industry: 15, credit: 20, negDays: 15, collectibility: 15,
          pdMultiplier: 100, maxFundingPct: 150, factorSpread: 20,
          aggressiveness: 50
        },
        aggressive: {
          revenue: 35, tib: 15, industry: 15, credit: 15, negDays: 15, collectibility: 20,
          pdMultiplier: 80, maxFundingPct: 200, factorSpread: 25,
          aggressiveness: 75
        }
      };

      const p = presets[preset];
      Object.assign(MODEL_WEIGHTS, {
        revenue: p.revenue,
        tib: p.tib,
        industry: p.industry,
        credit: p.credit,
        negDays: p.negDays,
        collectibility: p.collectibility,
        pdMultiplier: p.pdMultiplier,
        maxFundingPct: p.maxFundingPct,
        factorSpread: p.factorSpread
      });

      // Update aggressiveness slider
      document.getElementById('aggressivenessSlider').value = p.aggressiveness;
      document.getElementById('aggressivenessValue').textContent = p.aggressiveness + '%';

      // Sync emphasis sliders
      syncEmphasisFromWeights();

      // Save and recalculate
      localStorage.setItem('modelWeights', JSON.stringify(MODEL_WEIGHTS));
      localStorage.setItem('modelPreset', preset);
      loadSettingsValues();
      if (typeof calculate === 'function') calculate();
    }

    function updateAggressiveness() {
      const value = parseInt(document.getElementById('aggressivenessSlider').value);
      document.getElementById('aggressivenessValue').textContent = value + '%';

      // Map aggressiveness to model parameters
      // 0% = very conservative, 100% = very aggressive
      MODEL_WEIGHTS.pdMultiplier = Math.round(140 - (value * 0.8)); // 140 at 0%, 60 at 100%
      MODEL_WEIGHTS.maxFundingPct = Math.round(80 + (value * 1.7)); // 80% at 0%, 250% at 100%
      MODEL_WEIGHTS.factorSpread = Math.round(12 + (value * 0.18)); // 12 at 0%, 30 at 100%

      // Clear preset selection
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));

      localStorage.setItem('modelWeights', JSON.stringify(MODEL_WEIGHTS));
      loadSettingsValues();
      if (typeof calculate === 'function') calculate();
    }

    function updateRevenueEmphasis() {
      const value = parseInt(document.getElementById('revenueEmphasisSlider').value);
      const labels = ['Low', 'Medium', 'High'];
      document.getElementById('revenueEmphasisValue').textContent = labels[value - 1];

      // Adjust revenue weight: Low=20, Medium=30, High=40
      const newRevenue = 10 + (value * 10);
      const diff = newRevenue - MODEL_WEIGHTS.revenue;
      MODEL_WEIGHTS.revenue = newRevenue;
      
      // Redistribute difference to other weights proportionally
      redistributeWeights('revenue', diff);

      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      localStorage.setItem('modelWeights', JSON.stringify(MODEL_WEIGHTS));
      loadSettingsValues();
      updateTotalWeight();
      if (typeof calculate === 'function') calculate();
    }

    function updateCreditEmphasis() {
      const value = parseInt(document.getElementById('creditEmphasisSlider').value);
      const labels = ['Low', 'Medium', 'High'];
      document.getElementById('creditEmphasisValue').textContent = labels[value - 1];

      // Adjust credit weight: Low=10, Medium=20, High=30
      const newCredit = value * 10;
      const diff = newCredit - MODEL_WEIGHTS.credit;
      MODEL_WEIGHTS.credit = newCredit;
      
      // Redistribute difference to other weights proportionally
      redistributeWeights('credit', diff);

      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      localStorage.setItem('modelWeights', JSON.stringify(MODEL_WEIGHTS));
      loadSettingsValues();
      updateTotalWeight();
      if (typeof calculate === 'function') calculate();
    }

    function redistributeWeights(excludeKey, diff) {
      const keys = ['revenue', 'tib', 'industry', 'credit', 'negDays', 'collectibility'].filter(k => k !== excludeKey);
      const perKey = diff / keys.length;
      keys.forEach(k => {
        MODEL_WEIGHTS[k] = Math.max(5, Math.min(50, MODEL_WEIGHTS[k] - perKey));
      });
    }

    function syncEmphasisFromWeights() {
      // Revenue emphasis
      let revEmphasis = MODEL_WEIGHTS.revenue <= 22 ? 1 : MODEL_WEIGHTS.revenue >= 35 ? 3 : 2;
      const revSlider = document.getElementById('revenueEmphasisSlider');
      const revValue = document.getElementById('revenueEmphasisValue');
      if (revSlider) revSlider.value = revEmphasis;
      if (revValue) revValue.textContent = ['Low', 'Medium', 'High'][revEmphasis - 1];

      // Credit emphasis
      let credEmphasis = MODEL_WEIGHTS.credit <= 12 ? 1 : MODEL_WEIGHTS.credit >= 28 ? 3 : 2;
      const credSlider = document.getElementById('creditEmphasisSlider');
      const credValue = document.getElementById('creditEmphasisValue');
      if (credSlider) credSlider.value = credEmphasis;
      if (credValue) credValue.textContent = ['Low', 'Medium', 'High'][credEmphasis - 1];
    }

    function updateTotalWeight() {
      const total = MODEL_WEIGHTS.revenue + MODEL_WEIGHTS.tib + MODEL_WEIGHTS.industry + 
                    MODEL_WEIGHTS.credit + MODEL_WEIGHTS.negDays + MODEL_WEIGHTS.collectibility;
      const el = document.getElementById('totalWeightValue');
      if (el) {
        el.textContent = total + '%';
        el.classList.remove('warning', 'error');
        if (total < 95 || total > 105) el.classList.add('warning');
        if (total < 90 || total > 110) el.classList.add('error');
      }
    }

    function toggleThemeOld() {
      const toggle = document.getElementById('themeToggle');
      const isLight = document.body.classList.toggle('light-theme');
      toggle.classList.toggle('active', isLight);
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }

    function loadSettingsValues() {
      document.getElementById('revenueWeightSlider').value = MODEL_WEIGHTS.revenue;
      document.getElementById('revenueWeightValue').textContent = MODEL_WEIGHTS.revenue + '%';
      
      document.getElementById('tibWeightSlider').value = MODEL_WEIGHTS.tib;
      document.getElementById('tibWeightValue').textContent = MODEL_WEIGHTS.tib + '%';
      
      document.getElementById('industryWeightSlider').value = MODEL_WEIGHTS.industry;
      document.getElementById('industryWeightValue').textContent = MODEL_WEIGHTS.industry + '%';
      
      document.getElementById('creditWeightSlider').value = MODEL_WEIGHTS.credit;
      document.getElementById('creditWeightValue').textContent = MODEL_WEIGHTS.credit + '%';
      
      document.getElementById('negDaysWeightSlider').value = MODEL_WEIGHTS.negDays;
      document.getElementById('negDaysWeightValue').textContent = MODEL_WEIGHTS.negDays + '%';
      
      document.getElementById('collectibilityWeightSlider').value = MODEL_WEIGHTS.collectibility;
      document.getElementById('collectibilityWeightValue').textContent = MODEL_WEIGHTS.collectibility + '%';
      
      document.getElementById('pdMultiplierSlider').value = MODEL_WEIGHTS.pdMultiplier;
      document.getElementById('pdMultiplierValue').textContent = (MODEL_WEIGHTS.pdMultiplier / 100).toFixed(1) + 'x';
      
      document.getElementById('maxFundingPctSlider').value = MODEL_WEIGHTS.maxFundingPct;
      document.getElementById('maxFundingPctValue').textContent = MODEL_WEIGHTS.maxFundingPct + '%';
      
      document.getElementById('factorSpreadSlider').value = MODEL_WEIGHTS.factorSpread;
      document.getElementById('factorSpreadValue').textContent = (MODEL_WEIGHTS.factorSpread / 100).toFixed(2);
      
      // Load Underwriting Criteria values
      document.getElementById('minRevenueSlider').value = UNDERWRITING_CRITERIA.minRevenue;
      document.getElementById('minRevenueValue').textContent = '$' + UNDERWRITING_CRITERIA.minRevenue.toLocaleString();
      
      document.getElementById('minTibSlider').value = UNDERWRITING_CRITERIA.minTib;
      document.getElementById('minTibValue').textContent = UNDERWRITING_CRITERIA.minTib + ' months';
      
      document.getElementById('minCreditSlider').value = UNDERWRITING_CRITERIA.minCredit;
      document.getElementById('minCreditValue').textContent = UNDERWRITING_CRITERIA.minCredit;
      
      document.getElementById('minAblescoreSlider').value = UNDERWRITING_CRITERIA.minAblescore;
      document.getElementById('minAblescoreValue').textContent = UNDERWRITING_CRITERIA.minAblescore;
      
      document.getElementById('maxFundingSlider').value = UNDERWRITING_CRITERIA.maxFunding;
      document.getElementById('maxFundingValue').textContent = '$' + UNDERWRITING_CRITERIA.maxFunding.toLocaleString();
      
      document.getElementById('maxNegDaysSlider').value = UNDERWRITING_CRITERIA.maxNegDays;
      document.getElementById('maxNegDaysValue').textContent = UNDERWRITING_CRITERIA.maxNegDays + ' days';
      
      document.getElementById('maxNsfSlider').value = UNDERWRITING_CRITERIA.maxNsf;
      document.getElementById('maxNsfValue').textContent = UNDERWRITING_CRITERIA.maxNsf;
      
      document.getElementById('maxDailyPctSlider').value = UNDERWRITING_CRITERIA.maxDailyPct;
      document.getElementById('maxDailyPctValue').textContent = UNDERWRITING_CRITERIA.maxDailyPct + '%';
      
      document.getElementById('minFactorSlider').value = UNDERWRITING_CRITERIA.minFactor;
      document.getElementById('minFactorValue').textContent = (UNDERWRITING_CRITERIA.minFactor / 100).toFixed(2);
      
      document.getElementById('maxFactorSlider').value = UNDERWRITING_CRITERIA.maxFactor;
      document.getElementById('maxFactorValue').textContent = (UNDERWRITING_CRITERIA.maxFactor / 100).toFixed(2);
      
      document.getElementById('minTermSlider').value = UNDERWRITING_CRITERIA.minTerm;
      document.getElementById('minTermValue').textContent = UNDERWRITING_CRITERIA.minTerm + ' months';
      
      document.getElementById('maxTermSlider').value = UNDERWRITING_CRITERIA.maxTerm;
      document.getElementById('maxTermValue').textContent = UNDERWRITING_CRITERIA.maxTerm + ' months';
      
      document.getElementById('maxPositionsSlider').value = UNDERWRITING_CRITERIA.maxPositions;
      document.getElementById('maxPositionsValue').textContent = UNDERWRITING_CRITERIA.maxPositions;
      
      document.getElementById('maxStackBalanceSlider').value = UNDERWRITING_CRITERIA.maxStackBalance;
      document.getElementById('maxStackBalanceValue').textContent = UNDERWRITING_CRITERIA.maxStackBalance + '%';
    }

    function updateModelWeights() {
      MODEL_WEIGHTS.revenue = parseInt(document.getElementById('revenueWeightSlider').value);
      MODEL_WEIGHTS.tib = parseInt(document.getElementById('tibWeightSlider').value);
      MODEL_WEIGHTS.industry = parseInt(document.getElementById('industryWeightSlider').value);
      MODEL_WEIGHTS.credit = parseInt(document.getElementById('creditWeightSlider').value);
      MODEL_WEIGHTS.negDays = parseInt(document.getElementById('negDaysWeightSlider').value);
      MODEL_WEIGHTS.collectibility = parseInt(document.getElementById('collectibilityWeightSlider').value);
      MODEL_WEIGHTS.pdMultiplier = parseInt(document.getElementById('pdMultiplierSlider').value);
      MODEL_WEIGHTS.maxFundingPct = parseInt(document.getElementById('maxFundingPctSlider').value);
      MODEL_WEIGHTS.factorSpread = parseInt(document.getElementById('factorSpreadSlider').value);

      // Update display values
      document.getElementById('revenueWeightValue').textContent = MODEL_WEIGHTS.revenue + '%';
      document.getElementById('tibWeightValue').textContent = MODEL_WEIGHTS.tib + '%';
      document.getElementById('industryWeightValue').textContent = MODEL_WEIGHTS.industry + '%';
      document.getElementById('creditWeightValue').textContent = MODEL_WEIGHTS.credit + '%';
      document.getElementById('negDaysWeightValue').textContent = MODEL_WEIGHTS.negDays + '%';
      document.getElementById('collectibilityWeightValue').textContent = MODEL_WEIGHTS.collectibility + '%';
      document.getElementById('pdMultiplierValue').textContent = (MODEL_WEIGHTS.pdMultiplier / 100).toFixed(1) + 'x';
      document.getElementById('maxFundingPctValue').textContent = MODEL_WEIGHTS.maxFundingPct + '%';
      document.getElementById('factorSpreadValue').textContent = (MODEL_WEIGHTS.factorSpread / 100).toFixed(2);

      // Update total weight indicator
      updateTotalWeight();

      // Clear preset selection when manually adjusting
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      localStorage.removeItem('modelPreset');

      // Save to localStorage
      localStorage.setItem('modelWeights', JSON.stringify(MODEL_WEIGHTS));

      // Recalculate with new weights
      if (typeof calculate === 'function') {
        calculate();
      }
    }

    function resetModelWeights() {
      Object.assign(MODEL_WEIGHTS, DEFAULT_WEIGHTS);
      loadSettingsValues();
      localStorage.removeItem('modelWeights');
      localStorage.removeItem('modelPreset');
      
      // Reset to balanced preset in simple mode
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      const balancedBtn = document.getElementById('presetBalanced');
      if (balancedBtn) balancedBtn.classList.add('active');
      
      // Reset aggressiveness slider
      const aggSlider = document.getElementById('aggressivenessSlider');
      const aggValue = document.getElementById('aggressivenessValue');
      if (aggSlider) aggSlider.value = 50;
      if (aggValue) aggValue.textContent = '50%';
      
      // Sync emphasis sliders
      syncEmphasisFromWeights();
      updateTotalWeight();
      
      if (typeof calculate === 'function') {
        calculate();
      }
    }

    function updateUnderwritingCriteria() {
      // Read all slider values
      UNDERWRITING_CRITERIA.minRevenue = parseInt(document.getElementById('minRevenueSlider').value);
      UNDERWRITING_CRITERIA.minTib = parseInt(document.getElementById('minTibSlider').value);
      UNDERWRITING_CRITERIA.minCredit = parseInt(document.getElementById('minCreditSlider').value);
      UNDERWRITING_CRITERIA.minAblescore = parseInt(document.getElementById('minAblescoreSlider').value);
      UNDERWRITING_CRITERIA.maxFunding = parseInt(document.getElementById('maxFundingSlider').value);
      UNDERWRITING_CRITERIA.maxNegDays = parseInt(document.getElementById('maxNegDaysSlider').value);
      UNDERWRITING_CRITERIA.maxNsf = parseInt(document.getElementById('maxNsfSlider').value);
      UNDERWRITING_CRITERIA.maxDailyPct = parseInt(document.getElementById('maxDailyPctSlider').value);
      UNDERWRITING_CRITERIA.minFactor = parseInt(document.getElementById('minFactorSlider').value);
      UNDERWRITING_CRITERIA.maxFactor = parseInt(document.getElementById('maxFactorSlider').value);
      UNDERWRITING_CRITERIA.minTerm = parseInt(document.getElementById('minTermSlider').value);
      UNDERWRITING_CRITERIA.maxTerm = parseInt(document.getElementById('maxTermSlider').value);
      UNDERWRITING_CRITERIA.maxPositions = parseInt(document.getElementById('maxPositionsSlider').value);
      UNDERWRITING_CRITERIA.maxStackBalance = parseInt(document.getElementById('maxStackBalanceSlider').value);

      // Update display values
      document.getElementById('minRevenueValue').textContent = '$' + UNDERWRITING_CRITERIA.minRevenue.toLocaleString();
      document.getElementById('minTibValue').textContent = UNDERWRITING_CRITERIA.minTib + ' months';
      document.getElementById('minCreditValue').textContent = UNDERWRITING_CRITERIA.minCredit;
      document.getElementById('minAblescoreValue').textContent = UNDERWRITING_CRITERIA.minAblescore;
      document.getElementById('maxFundingValue').textContent = '$' + UNDERWRITING_CRITERIA.maxFunding.toLocaleString();
      document.getElementById('maxNegDaysValue').textContent = UNDERWRITING_CRITERIA.maxNegDays + ' days';
      document.getElementById('maxNsfValue').textContent = UNDERWRITING_CRITERIA.maxNsf;
      document.getElementById('maxDailyPctValue').textContent = UNDERWRITING_CRITERIA.maxDailyPct + '%';
      document.getElementById('minFactorValue').textContent = (UNDERWRITING_CRITERIA.minFactor / 100).toFixed(2);
      document.getElementById('maxFactorValue').textContent = (UNDERWRITING_CRITERIA.maxFactor / 100).toFixed(2);
      document.getElementById('minTermValue').textContent = UNDERWRITING_CRITERIA.minTerm + ' months';
      document.getElementById('maxTermValue').textContent = UNDERWRITING_CRITERIA.maxTerm + ' months';
      document.getElementById('maxPositionsValue').textContent = UNDERWRITING_CRITERIA.maxPositions;
      document.getElementById('maxStackBalanceValue').textContent = UNDERWRITING_CRITERIA.maxStackBalance + '%';

      // Save to localStorage
      localStorage.setItem('underwritingCriteria', JSON.stringify(UNDERWRITING_CRITERIA));

      // Recalculate with new criteria
      if (typeof calculate === 'function') {
        calculate();
      }
    }

    function resetUnderwritingCriteria() {
      Object.assign(UNDERWRITING_CRITERIA, DEFAULT_CRITERIA);
      loadSettingsValues();
      localStorage.removeItem('underwritingCriteria');
      if (typeof calculate === 'function') {
        calculate();
      }
    }

    // Load saved settings on page load
    function loadSavedSettings() {
      // Load theme
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        document.getElementById('themeToggle').classList.add('active');
      }

      // Load model weights
      const savedWeights = localStorage.getItem('modelWeights');
      if (savedWeights) {
        try {
          Object.assign(MODEL_WEIGHTS, JSON.parse(savedWeights));
        } catch (e) {
          console.error('Error loading model weights:', e);
        }
      }

      // Load underwriting criteria
      const savedCriteria = localStorage.getItem('underwritingCriteria');
      if (savedCriteria) {
        try {
          Object.assign(UNDERWRITING_CRITERIA, JSON.parse(savedCriteria));
        } catch (e) {
          console.error('Error loading underwriting criteria:', e);
        }
      }

      // Load model mode (simple/advanced)
      const savedMode = localStorage.getItem('modelModeAdvanced');
      if (savedMode === 'true') {
        modelModeAdvanced = true;
        const toggle = document.getElementById('modelModeToggle');
        const simplePanel = document.getElementById('simpleModelPanel');
        const advancedPanel = document.getElementById('advancedModelPanel');
        if (toggle) toggle.classList.add('advanced');
        if (simplePanel) simplePanel.classList.add('hidden');
        if (advancedPanel) advancedPanel.classList.remove('hidden');
        const simpleLabel = document.getElementById('simpleModeLabel');
        const advancedLabel = document.getElementById('advancedModeLabel');
        if (simpleLabel) simpleLabel.classList.remove('active');
        if (advancedLabel) advancedLabel.classList.add('active');
      }

      // Load preset selection
      const savedPreset = localStorage.getItem('modelPreset');
      if (savedPreset) {
        document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
        const presetBtn = document.getElementById('preset' + savedPreset.charAt(0).toUpperCase() + savedPreset.slice(1));
        if (presetBtn) presetBtn.classList.add('active');
      }

      // Sync emphasis sliders from weights
      syncEmphasisFromWeights();
    }

    function getBarColor(pct) {
      if (pct >= 80) return '#10b981';
      if (pct >= 60) return '#22c55e';
      if (pct >= 40) return '#eab308';
      if (pct >= 20) return '#f97316';
      return '#ef4444';
    }

    function getTier(score) {
      if (score >= 80) return 'A';
      if (score >= 65) return 'B';
      if (score >= 50) return 'C';
      if (score >= 35) return 'D';
      return 'E';
    }
    
    // Smooth interpolation for factor, term, and multiplier based on score
    // Every point change produces different values
    function getSmoothTierData(score) {
      // Clamp score to 0-100
      const s = Math.max(0, Math.min(100, score));
      
      // Factor: 1.48 at score 0, 1.15 at score 100 (linear interpolation)
      const factor = 1.48 - (s / 100) * 0.33;
      
      // Term: 3 months at score 0, 14 months at score 100 (linear)
      const termMonths = Math.round(3 + (s / 100) * 11);
      
      // Multiplier: 0.30 at score 0, 1.50 at score 100 (linear)
      const multiplier = 0.30 + (s / 100) * 1.20;
      
      return {
        factor: Math.round(factor * 100) / 100,  // Round to 2 decimals
        termMonths: termMonths,
        multiplier: Math.round(multiplier * 100) / 100
      };
    }

    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }
    
    // Update slider from text input
    function updateFromInput(sliderId, inputValue, min, max, isCurrency = false) {
      // Parse value - remove currency symbols and commas
      let value = inputValue.replace(/[$,\s]/g, '').replace(/mo|days?/gi, '').trim();
      value = parseFloat(value) || 0;
      
      // Clamp to valid range
      value = Math.max(min, Math.min(max, value));
      
      // Update slider
      const slider = document.getElementById(sliderId);
      if (slider) {
        slider.value = value;
      }
      
      // Trigger recalculation
      calculate();
    }
    
    // Update from modal text input (syncs both modal and main sliders)
    function updateFromModalInput(mainSliderId, modalSliderId, inputValue, min, max, isCurrency = false) {
      // Parse value - remove currency symbols and commas
      let value = inputValue.replace(/[$,\s]/g, '').replace(/mo|days?/gi, '').trim();
      value = parseFloat(value) || 0;
      
      // Clamp to valid range
      value = Math.max(min, Math.min(max, value));
      
      // Update both sliders
      const mainSlider = document.getElementById(mainSliderId);
      const modalSlider = document.getElementById(modalSliderId);
      if (mainSlider) mainSlider.value = value;
      if (modalSlider) modalSlider.value = value;
      
      // Trigger recalculation
      calculate();
    }

    // Update indicator box styling based on color
    function updateIndicatorBox(elementId, color) {
      const el = document.getElementById(elementId);
      if (!el) return;
      const box = el.parentElement;
      const colorMap = {
        '#ef4444': { bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.3)' },
        '#f97316': { bg: 'rgba(249, 115, 22, 0.15)', border: 'rgba(249, 115, 22, 0.3)' },
        '#eab308': { bg: 'rgba(234, 179, 8, 0.15)', border: 'rgba(234, 179, 8, 0.3)' },
        '#22c55e': { bg: 'rgba(34, 197, 94, 0.15)', border: 'rgba(34, 197, 94, 0.3)' },
        '#10b981': { bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.3)' }
      };
      const colors = colorMap[color] || colorMap['#eab308'];
      box.style.background = colors.bg;
      box.style.borderColor = colors.border;
      const label = box.querySelector('div:last-child');
      if (label) label.style.color = color;
    }

    // Mobile panel toggle
    function togglePanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.toggle('collapsed');
      }
    }

    // ============================================
    // SLIDER MODAL (Mobile)
    // ============================================
    let currentModalMode = 'calc'; // 'calc' or 'override'
    
    function openSliderModal() {
      // Detect which tab is active by checking the tab panel
      const overridePanel = document.getElementById('tab-override');
      const isOverrideActive = overridePanel && overridePanel.classList.contains('active');
      
      currentModalMode = isOverrideActive ? 'override' : 'calc';
      
      // Update modal title and content visibility
      const modalTitle = document.getElementById('modalTitle');
      const calcContent = document.getElementById('modalCalcContent');
      const overrideContent = document.getElementById('modalOverrideContent');
      
      if (currentModalMode === 'override') {
        modalTitle.textContent = 'Adjust Offer Terms';
        calcContent.style.display = 'none';
        overrideContent.style.display = 'block';
        syncOverrideModalFromMain();
      } else {
        modalTitle.textContent = 'Input Parameters';
        calcContent.style.display = 'block';
        overrideContent.style.display = 'none';
        syncModalFromMain();
      }
      
      document.getElementById('sliderModalOverlay').classList.add('active');
      document.getElementById('sliderFab').classList.add('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeSliderModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('sliderModalOverlay').classList.remove('active');
      document.getElementById('sliderFab').classList.remove('hidden');
      document.body.style.overflow = '';
    }
    
    // Sync override modal sliders from main override sliders
    function syncOverrideModalFromMain() {
      const funding = document.getElementById('overrideFunding').value;
      const factor = document.getElementById('overrideFactor').value;
      const term = document.getElementById('overrideTerm').value;
      
      document.getElementById('modalOverrideFunding').value = funding;
      document.getElementById('modalOverrideFactor').value = factor;
      document.getElementById('modalOverrideTerm').value = term;
      
      document.getElementById('modalOverrideFundingDisplay').textContent = formatCurrency(parseInt(funding));
      document.getElementById('modalOverrideFactorDisplay').textContent = parseFloat(factor).toFixed(2) + 'x';
      document.getElementById('modalOverrideTermDisplay').textContent = term + ' Months';
      
      // Sync payment frequency
      const selectedFreq = document.querySelector('input[name="overridePaymentFreq"]:checked');
      if (selectedFreq) {
        const modalFreq = document.querySelector('input[name="modalOverridePaymentFreq"][value="' + selectedFreq.value + '"]');
        if (modalFreq) modalFreq.checked = true;
      }
      
      // Update override score meter
      updateModalOverrideScoreMeter();
      
      // Update calculated terms and variances
      updateModalDisplays();
    }
    
    function updateModalOverrideScoreMeter() {
      if (!window.calcOffer) return;
      
      const score = window.calcOffer.score || 0;
      const tier = window.calcOffer.tier || 'E';
      const tierColors = window.calcOffer.tierColors || { main: '#ef4444' };
      
      const tierLabels = {
        'A': 'Prime',
        'B': 'Near-Prime', 
        'C': 'Mid-Prime',
        'D': 'Sub-Prime',
        'E': 'Deep Sub'
      };
      
      const scoreEl = document.getElementById('modalOverrideScoreNumber');
      const tierEl = document.getElementById('modalOverrideTierLetter');
      const labelEl = document.getElementById('modalOverrideTierLabel');
      const markerEl = document.getElementById('modalOverrideScoreMarker');
      const badgeEl = document.getElementById('modalOverrideTierBadge');
      
      if (scoreEl) scoreEl.textContent = score;
      if (tierEl) {
        tierEl.textContent = tier;
        tierEl.style.color = tierColors.main;
      }
      if (labelEl) labelEl.textContent = tierLabels[tier] || 'Unknown';
      if (markerEl) markerEl.style.left = score + '%';
      if (badgeEl) badgeEl.style.borderColor = tierColors.main;
      
      // Update risk metrics
      updateModalRiskMetrics();
    }
    
    function updateModalRiskMetrics() {
      if (!window.calcOffer) return;
      
      const calc = window.calcOffer;
      const el = (id) => document.getElementById(id);
      
      // Get override values from modal or main sliders
      const overrideFunding = parseInt(el('overrideFunding')?.value) || calc.funding;
      const overrideFactor = parseFloat(el('overrideFactor')?.value) || calc.factor;
      const overrideTerm = parseInt(el('overrideTerm')?.value) || calc.term;
      
      const payback = overrideFunding * overrideFactor;
      
      // Calculate PD
      const tierPD = { A: 3, B: 6, C: 10, D: 18, E: 28 };
      let basePD = tierPD[calc.tier] || 10;
      
      const fundingRatio = overrideFunding / calc.funding;
      const factorRatio = overrideFactor / calc.factor;
      const termRatio = overrideTerm / calc.term;
      
      let pdAdjustment = 0;
      pdAdjustment += (fundingRatio - 1) * 15;
      pdAdjustment -= (factorRatio - 1) * 8;
      pdAdjustment += (termRatio - 1) * 5;
      
      const estimatedPD = Math.max(1, Math.min(40, basePD + pdAdjustment));
      
      // Update modal PD gauge
      if (el('modalPdValue')) el('modalPdValue').textContent = estimatedPD.toFixed(1) + '%';
      
      const pdPct = estimatedPD / 40;
      const arcLength = 188 * pdPct;
      if (el('modalPdGaugeFill')) el('modalPdGaugeFill').setAttribute('stroke-dasharray', `${arcLength} 188`);
      
      let pdColor = '#10b981';
      if (estimatedPD > 25) pdColor = '#ef4444';
      else if (estimatedPD > 15) pdColor = '#f97316';
      else if (estimatedPD > 5) pdColor = '#eab308';
      if (el('modalPdGaugeFill')) el('modalPdGaugeFill').setAttribute('stroke', pdColor);
      
      // Calculate DSCR (including existing debt)
      const monthlyDebt = payback / overrideTerm;
      const existingDebt = parseInt(document.getElementById('existingDebt')?.value) || 0;
      const totalMonthlyDebt = monthlyDebt + existingDebt;
      const dscr = calc.revenue / totalMonthlyDebt;
      
      if (el('modalDscrRevenue')) el('modalDscrRevenue').textContent = formatCurrency(calc.revenue);
      if (el('modalDscrDebt')) el('modalDscrDebt').textContent = formatCurrency(Math.floor(totalMonthlyDebt)) + (existingDebt > 0 ? ' (incl. existing)' : '');
      if (el('modalDscrRatio')) el('modalDscrRatio').textContent = dscr.toFixed(2) + 'x';
      if (el('modalDscrBarValue')) el('modalDscrBarValue').textContent = dscr.toFixed(2) + 'x';
      
      const dscrPct = Math.min(100, (dscr / 3) * 100);
      if (el('modalDscrFill')) el('modalDscrFill').style.width = dscrPct + '%';
      
      let dscrColor = '#ef4444';
      if (dscr >= 2) dscrColor = '#10b981';
      else if (dscr >= 1.5) dscrColor = '#22c55e';
      else if (dscr >= 1.25) dscrColor = '#eab308';
      else if (dscr >= 1) dscrColor = '#f97316';
      
      if (el('modalDscrFill')) el('modalDscrFill').style.background = dscrColor;
      if (el('modalDscrRatio')) el('modalDscrRatio').style.color = dscrColor;
      
      // DSCR warning
      const dscrWarning = el('modalDscrWarning');
      if (dscrWarning) {
        if (dscr < 1) {
          dscrWarning.style.display = 'block';
          dscrWarning.style.background = 'rgba(239, 68, 68, 0.1)';
          dscrWarning.style.color = '#ef4444';
          dscrWarning.innerHTML = '<strong>Warning:</strong> DSCR below 1.0x';
        } else if (dscr < 1.25) {
          dscrWarning.style.display = 'block';
          dscrWarning.style.background = 'rgba(249, 115, 22, 0.1)';
          dscrWarning.style.color = '#f97316';
          dscrWarning.innerHTML = '<strong>Caution:</strong> Tight debt coverage';
        } else if (dscr >= 2) {
          dscrWarning.style.display = 'block';
          dscrWarning.style.background = 'rgba(16, 185, 129, 0.1)';
          dscrWarning.style.color = '#10b981';
          dscrWarning.innerHTML = '<strong>Healthy:</strong> Excellent coverage';
        } else {
          dscrWarning.style.display = 'none';
        }
      }
    }
    
    // Sync override slider from modal to main
    function syncOverrideSlider(mainId, value) {
      const mainSlider = document.getElementById(mainId);
      if (mainSlider) {
        mainSlider.value = value;
        calculateOverride();
        
        // Update modal display
        if (mainId === 'overrideFunding') {
          document.getElementById('modalOverrideFundingDisplay').textContent = formatCurrency(parseInt(value));
        } else if (mainId === 'overrideFactor') {
          document.getElementById('modalOverrideFactorDisplay').textContent = parseFloat(value).toFixed(2) + 'x';
        } else if (mainId === 'overrideTerm') {
          document.getElementById('modalOverrideTermDisplay').textContent = value + ' Months';
        }
        
        // Update variance badges and risk metrics
        updateModalOverrideVariances();
        updateModalRiskMetrics();
      }
    }
    
    // Sync override radio from modal to main
    function syncOverrideRadio(name, value) {
      const mainRadio = document.querySelector('input[name="' + name + '"][value="' + value + '"]');
      if (mainRadio) {
        mainRadio.checked = true;
        calculateOverride();
      }
    }
    
    function syncModalFromMain() {
      // Sync slider values
      const mainModal = {
        'monthlyRevenue': 'modalMonthlyRevenue',
        'avgDailyBalance': 'modalAvgDailyBalance',
        'creditScore': 'modalCreditScore',
        'timeInBusiness': 'modalTimeInBusiness',
        'nsfCount': 'modalNsfCount',
        'negativeDays': 'modalNegativeDays',
        'existingDebt': 'modalExistingDebt'
      };
      
      Object.entries(mainModal).forEach(([mainId, modalId]) => {
        const main = document.getElementById(mainId);
        const modal = document.getElementById(modalId);
        if (main && modal) {
          modal.value = main.value;
        }
      });
      
      // Sync existing debt frequency (dropdown + hidden radios)
      const debtFreqVal = document.querySelector('input[name="existingDebtFreq"]:checked')?.value || 'daily';
      const modalDebtFreq = document.querySelector(`input[name="modalExistingDebtFreq"][value="${debtFreqVal}"]`);
      if (modalDebtFreq) modalDebtFreq.checked = true;
      const modalDebtFreqSelect = document.getElementById('modalExistingDebtFreqSelect');
      if (modalDebtFreqSelect) modalDebtFreqSelect.value = debtFreqVal;
      
      // Sync industry dropdown
      const industryVal = document.getElementById('industrySelect')?.value || 'retail';
      const modalIndustry = document.getElementById('modalIndustrySelect');
      if (modalIndustry) modalIndustry.value = industryVal;
      
      // Sync fleet size and visibility for trucking
      const fleetVal = document.getElementById('fleetSize')?.value || '1';
      const modalFleet = document.getElementById('modalFleetSize');
      if (modalFleet) modalFleet.value = fleetVal;
      
      // Show/hide trucking sections
      const isTrucking = industryVal === 'trucking';
      const truckingSection = document.getElementById('truckingFleetSection');
      const modalTruckingSection = document.getElementById('modalTruckingFleetSection');
      if (truckingSection) truckingSection.style.display = isTrucking ? 'block' : 'none';
      if (modalTruckingSection) modalTruckingSection.style.display = isTrucking ? 'block' : 'none';
      
      // Update displays
      updateModalDisplays();
      updateModalScoreMeter();
    }
    
    function updateModalScoreMeter() {
      if (!window.calcOffer) return;
      
      const score = window.calcOffer.score || 0;
      const tier = window.calcOffer.tier || 'E';
      const tierColors = window.calcOffer.tierColors || { main: '#ef4444' };
      
      const tierLabels = {
        'A': 'Prime',
        'B': 'Near-Prime', 
        'C': 'Mid-Prime',
        'D': 'Sub-Prime',
        'E': 'Deep Sub'
      };
      
      const scoreEl = document.getElementById('modalScoreNumber');
      const tierEl = document.getElementById('modalTierLetter');
      const labelEl = document.getElementById('modalTierLabel');
      const markerEl = document.getElementById('modalScoreMarker');
      const badgeEl = document.getElementById('modalTierBadge');
      
      if (scoreEl) scoreEl.textContent = score;
      if (tierEl) {
        tierEl.textContent = tier;
        tierEl.style.color = tierColors.main;
      }
      if (labelEl) labelEl.textContent = tierLabels[tier] || 'Unknown';
      if (markerEl) markerEl.style.left = score + '%';
      if (badgeEl) badgeEl.style.borderColor = tierColors.main;
    }
    
    function syncSlider(mainId, value) {
      const main = document.getElementById(mainId);
      if (main) {
        main.value = value;
        calculate();
        updateModalDisplays();
        updateModalScoreMeter();
      }
    }
    
    function syncRadio(name, value) {
      const main = document.querySelector(`input[name="${name}"][value="${value}"]`);
      if (main) {
        main.checked = true;
        calculate();
        updateModalScoreMeter();
      }
    }
    
    function syncIndustry(value) {
      const main = document.getElementById('industrySelect');
      if (main) {
        main.value = value;
        // Trigger industry change handler for trucking fleet visibility
        handleIndustryChange();
        updateModalScoreMeter();
      }
    }
    
    function updateExistingDebtFreq() {
      const select = document.getElementById('existingDebtFreqSelect');
      const value = select ? select.value : 'daily';
      // Sync hidden radio buttons
      const radio = document.querySelector(`input[name="existingDebtFreq"][value="${value}"]`);
      if (radio) radio.checked = true;
      // Sync modal radio
      const modalRadio = document.querySelector(`input[name="modalExistingDebtFreq"][value="${value}"]`);
      if (modalRadio) modalRadio.checked = true;
      // Sync modal dropdown
      const modalSelect = document.getElementById('modalExistingDebtFreqSelect');
      if (modalSelect) modalSelect.value = value;
      // Update label
      const freqLabels = { daily: '/day', weekly: '/week', monthly: '/month' };
      const label = document.getElementById('existingDebtFreqLabel');
      if (label) label.textContent = freqLabels[value];
      calculate();
    }
    
    function syncExistingDebtFreq(value) {
      // Sync main dropdown
      const mainSelect = document.getElementById('existingDebtFreqSelect');
      if (mainSelect) mainSelect.value = value;
      // Sync all radios
      const radio = document.querySelector(`input[name="existingDebtFreq"][value="${value}"]`);
      if (radio) radio.checked = true;
      const modalRadio = document.querySelector(`input[name="modalExistingDebtFreq"][value="${value}"]`);
      if (modalRadio) modalRadio.checked = true;
      // Update label
      const freqLabels = { daily: '/day', weekly: '/week', monthly: '/month' };
      const label = document.getElementById('existingDebtFreqLabel');
      if (label) label.textContent = freqLabels[value];
      calculate();
    }
    
    function updateModalDisplays() {
      const revenue = parseInt(document.getElementById('monthlyRevenue').value) || 0;
      const balance = parseInt(document.getElementById('avgDailyBalance').value) || 0;
      const credit = parseInt(document.getElementById('creditScore').value) || 0;
      const tib = parseInt(document.getElementById('timeInBusiness').value) || 0;
      const nsf = parseInt(document.getElementById('nsfCount').value) || 0;
      const negDays = parseInt(document.getElementById('negativeDays').value) || 0;
      const existingDebtRaw = parseInt(document.getElementById('existingDebt').value) || 0;
      const existingDebtFreq = document.querySelector('input[name="existingDebtFreq"]:checked')?.value || 'daily';
      
      const debtFreqLabels = { daily: '/day', weekly: '/wk', monthly: '/mo' };
      
      const el = (id) => document.getElementById(id);
      if (el('modalRevenueDisplay')) el('modalRevenueDisplay').value = formatCurrency(revenue);
      if (el('modalBalanceDisplay')) el('modalBalanceDisplay').value = formatCurrency(balance);
      if (el('modalCreditDisplay')) el('modalCreditDisplay').value = credit;
      if (el('modalTibDisplay')) el('modalTibDisplay').value = tib;
      if (el('modalNsfDisplay')) el('modalNsfDisplay').value = nsf;
      if (el('modalNegDaysDisplay')) el('modalNegDaysDisplay').value = negDays;
      if (el('modalExistingDebtDisplay')) el('modalExistingDebtDisplay').value = formatCurrency(existingDebtRaw);
      
      // Update offer terms from calcOffer (MODEL SCORE modal)
      if (window.calcOffer) {
        if (el('modalCalcFundingDisplay')) el('modalCalcFundingDisplay').textContent = formatCurrency(window.calcOffer.funding || 0);
        if (el('modalCalcFactorDisplay')) el('modalCalcFactorDisplay').textContent = (window.calcOffer.factor || 1).toFixed(2) + 'x';
        if (el('modalCalcTermDisplay')) el('modalCalcTermDisplay').textContent = (window.calcOffer.term || 0) + ' mo';
        
        // Update MODEL OVERRIDE modal calculated terms
        if (el('modalOverrideCalcFunding')) el('modalOverrideCalcFunding').textContent = formatCurrency(window.calcOffer.funding || 0);
        if (el('modalOverrideCalcFactor')) el('modalOverrideCalcFactor').textContent = (window.calcOffer.factor || 1).toFixed(2) + 'x';
        if (el('modalOverrideCalcTerm')) el('modalOverrideCalcTerm').textContent = (window.calcOffer.term || 0) + ' mo';
      }
      
      // Update override modal variances
      updateModalOverrideVariances();
    }
    
    function updateModalOverrideVariances() {
      if (!window.calcOffer) return;
      
      const el = (id) => document.getElementById(id);
      const calcFunding = window.calcOffer.funding || 0;
      const calcFactor = window.calcOffer.factor || 1;
      const calcTerm = window.calcOffer.term || 0;
      
      const overrideFunding = parseInt(el('overrideFunding')?.value) || calcFunding;
      const overrideFactor = parseFloat(el('overrideFactor')?.value) || calcFactor;
      const overrideTerm = parseInt(el('overrideTerm')?.value) || calcTerm;
      
      // Calculate variances
      const fundingDiff = overrideFunding - calcFunding;
      const factorDiff = overrideFactor - calcFactor;
      const termDiff = overrideTerm - calcTerm;
      
      // Update funding variance badge
      const fundingBadge = el('modalFundingVariance');
      if (fundingBadge) {
        const fundingSign = fundingDiff >= 0 ? '+' : '';
        fundingBadge.textContent = fundingSign + formatCurrency(fundingDiff);
        fundingBadge.className = 'variance-badge' + (fundingDiff > 0 ? ' positive' : fundingDiff < 0 ? ' negative' : '');
      }
      
      // Update factor variance badge
      const factorBadge = el('modalFactorVariance');
      if (factorBadge) {
        const factorSign = factorDiff >= 0 ? '+' : '';
        factorBadge.textContent = factorSign + factorDiff.toFixed(2);
        factorBadge.className = 'variance-badge' + (factorDiff > 0 ? ' positive' : factorDiff < 0 ? ' negative' : '');
      }
      
      // Update term variance badge
      const termBadge = el('modalTermVariance');
      if (termBadge) {
        const termSign = termDiff >= 0 ? '+' : '';
        termBadge.textContent = termSign + termDiff + ' mo';
        termBadge.className = 'variance-badge' + (termDiff > 0 ? ' positive' : termDiff < 0 ? ' negative' : '');
      }
    }

    function recalculateWithConfirm(btn) {
      calculate();
      
      // Get calculated values for verification
      const score = document.getElementById('scoreValueTop').textContent.replace('/100', '');
      const funding = document.getElementById('offerFunding').textContent;
      const payback = document.getElementById('offerPayback').textContent;
      const payment = document.getElementById('offerPayment').textContent;
      
      // Show confirmation message
      const msg = document.getElementById('calcConfirmMsg');
      msg.innerHTML = 'Verified: Score ' + score + ' | ' + funding + ' funding | ' + payback + ' payback | ' + payment + '/day';
      msg.style.opacity = '1';
      
      // Button flash
      const origBg = btn.style.background;
      btn.style.background = '#22c55e';
      btn.textContent = 'Verified';
      
      setTimeout(() => {
        btn.style.background = origBg;
        btn.textContent = 'Recalculate';
      }, 1500);
      
      setTimeout(() => {
        msg.style.opacity = '0';
      }, 4000);
    }
    
    function recalculateOverrideWithConfirm(btn) {
      calculateOverride();
      
      // Get override calculated values for verification
      const funding = document.getElementById('overrideOfferFunding').textContent;
      const payback = document.getElementById('overrideOfferPayback').textContent;
      const payment = document.getElementById('overrideOfferPayment').textContent;
      const factor = document.getElementById('overrideFactorDisplay').textContent;
      
      // Show confirmation message
      const msg = document.getElementById('overrideConfirmMsg');
      msg.innerHTML = 'Verified: ' + funding + ' x ' + factor + ' = ' + payback + ' | ' + payment + '/day';
      msg.style.opacity = '1';
      
      // Button flash
      const origBg = btn.style.background;
      btn.style.background = '#22c55e';
      btn.textContent = 'Verified';
      
      setTimeout(() => {
        btn.style.background = origBg;
        btn.textContent = 'Recalculate';
      }, 1500);
      
      setTimeout(() => {
        msg.style.opacity = '0';
      }, 4000);
    }

    // Prohibited industry codes (auto-decline)
    const PROHIBITED_INDUSTRIES = ['gambling', 'adult', 'cannabis', 'firearms', 'crypto', 'collection', 'telemarketing', 'pawn'];
    
    // Handle industry dropdown change - show/hide fleet size for trucking
    function handleIndustryChange() {
      const industry = document.getElementById('industrySelect').value;
      const truckingSection = document.getElementById('truckingFleetSection');
      const modalTruckingSection = document.getElementById('modalTruckingFleetSection');
      const industryWarning = document.getElementById('industryWarning');
      const fleetWarning = document.getElementById('fleetWarning');
      
      // Show/hide trucking fleet section
      if (industry === 'trucking') {
        if (truckingSection) truckingSection.style.display = 'block';
        if (modalTruckingSection) modalTruckingSection.style.display = 'block';
        if (industryWarning) industryWarning.style.display = 'none';
        // Check fleet size
        const fleetSize = parseInt(document.getElementById('fleetSize').value) || 1;
        if (fleetWarning) fleetWarning.style.display = fleetSize < 5 ? 'block' : 'none';
      } else {
        if (truckingSection) truckingSection.style.display = 'none';
        if (modalTruckingSection) modalTruckingSection.style.display = 'none';
        if (fleetWarning) fleetWarning.style.display = 'none';
        // Show prohibited warning
        if (industryWarning) {
          industryWarning.style.display = PROHIBITED_INDUSTRIES.includes(industry) ? 'block' : 'none';
        }
      }
      
      calculate();
    }
    
    // Sync fleet size from modal to main
    function syncFleetSize(value) {
      const main = document.getElementById('fleetSize');
      if (main) {
        main.value = value;
        // Update fleet warning
        const fleetWarning = document.getElementById('fleetWarning');
        if (fleetWarning) fleetWarning.style.display = parseInt(value) < 5 ? 'block' : 'none';
        calculate();
      }
    }
    
    function calculate() {
      // Get values
      const revenue = parseInt(document.getElementById('monthlyRevenue').value) || 0;
      const balance = parseInt(document.getElementById('avgDailyBalance').value) || 0;
      const credit = parseInt(document.getElementById('creditScore').value) || 0;
      const tib = parseInt(document.getElementById('timeInBusiness').value) || 0;
      const nsf = parseInt(document.getElementById('nsfCount').value) || 0;
      const negDays = parseInt(document.getElementById('negativeDays').value) || 0;
      const existingDebtRaw = parseInt(document.getElementById('existingDebt').value) || 0;
      const existingDebtFreq = document.querySelector('input[name="existingDebtFreq"]:checked').value;
      
      // Convert existing debt to monthly
      let existingDebt = existingDebtRaw;
      if (existingDebtFreq === 'daily') {
        existingDebt = existingDebtRaw * 22; // ~22 business days/month
      } else if (existingDebtFreq === 'weekly') {
        existingDebt = existingDebtRaw * 4.33; // ~4.33 weeks/month
      }
      existingDebt = Math.floor(existingDebt);
      
      // Get industry and check status
      const industry = document.getElementById('industrySelect').value;
      const isProhibited = PROHIBITED_INDUSTRIES.includes(industry);
      const fleetSize = parseInt(document.getElementById('fleetSize')?.value) || 1;
      const isTruckingDecline = industry === 'trucking' && fleetSize < 5;
      
      // Update fleet warning for trucking
      const fleetWarning = document.getElementById('fleetWarning');
      if (fleetWarning && industry === 'trucking') {
        fleetWarning.style.display = fleetSize < 5 ? 'block' : 'none';
      }

      // Update displays (using .value for editable inputs)
      document.getElementById('revenueDisplay').value = formatCurrency(revenue);
      document.getElementById('balanceDisplay').value = formatCurrency(balance);
      document.getElementById('creditDisplay').value = credit;
      document.getElementById('tibDisplay').value = tib;
      document.getElementById('nsfDisplay').value = nsf;
      document.getElementById('negDaysDisplay').value = negDays;
      
      // Update existing debt display with frequency label
      const debtFreqLabels = { daily: '/day', weekly: '/wk', monthly: '/mo' };
      document.getElementById('existingDebtDisplay').value = formatCurrency(existingDebtRaw);
      document.getElementById('existingDebtFreqLabel').textContent = debtFreqLabels[existingDebtFreq];

      // Calculate ABLESAI PRO score components using MODEL_WEIGHTS
      // Normalize weights to sum to 100
      const totalWeight = MODEL_WEIGHTS.revenue + MODEL_WEIGHTS.tib + MODEL_WEIGHTS.industry + MODEL_WEIGHTS.credit + MODEL_WEIGHTS.negDays + MODEL_WEIGHTS.collectibility;
      const normalize = 100 / totalWeight;

      const creditWeight = MODEL_WEIGHTS.credit * normalize;
      const revenueWeight = MODEL_WEIGHTS.revenue * normalize;
      const tibWeight = MODEL_WEIGHTS.tib * normalize;
      const negDaysWeight = MODEL_WEIGHTS.negDays * normalize;
      const industryWeight = MODEL_WEIGHTS.industry * normalize;
      const collectWeight = MODEL_WEIGHTS.collectibility * normalize;

      // Credit score component (smooth linear scale 450-850)
      const creditPts = credit < 450 ? 0 : Math.min(creditWeight, ((credit - 450) / 400) * creditWeight);
      
      // Behavior component (NSF + negative days) - smooth decay
      const events = nsf + negDays;
      const behavePts = Math.max(0, negDaysWeight * Math.pow(0.85, events));
      
      // Revenue component (smooth log scale for diminishing returns)
      const revNorm = Math.min(1, Math.log10(Math.max(revenue, 5000) / 5000) / Math.log10(100));
      const revPts = revNorm * revenueWeight;
      
      // Time in business / stability component (smooth scale 0-120 months)
      const tibNorm = Math.min(1, tib / 120);
      const stabPts = tibNorm * tibWeight;
      
      // Buffer / industry component (smooth scale 0-20% buffer ratio)
      const buffer = balance / revenue;
      const bufferNorm = Math.min(1, buffer / 0.20);
      const bufferPts = bufferNorm * industryWeight;

      // Collectibility component - smooth decay based on risk factors
      const debtBurden = existingDebt / revenue;
      // Start at 100%, smooth decay for each risk factor
      let collectMult = 1.0;
      collectMult *= Math.pow(0.88, nsf);  // Each NSF reduces by 12%
      collectMult *= Math.max(0.4, 1 - (Math.max(0, 0.15 - buffer) / 0.15) * 0.6);  // Buffer below 15% hurts
      collectMult *= Math.max(0.5, 1 - debtBurden * 2.5);  // Debt burden penalty
      const collectPts = collectWeight * Math.max(0, collectMult);

      // Total score (no restricted penalty - prohibited industries auto-decline)
      let totalScore = Math.round(creditPts + behavePts + revPts + stabPts + bufferPts + collectPts);
      totalScore = Math.max(0, Math.min(100, totalScore));

      // Determine tier with safety valves
      let tier = getTier(totalScore);
      if (credit < 520) tier = 'E';
      else if (credit < 550 && (tier === 'A' || tier === 'B' || tier === 'C')) tier = 'D';
      else if (credit < 600 && (tier === 'A' || tier === 'B')) tier = 'C';

      let tierColors = TIER_COLORS[tier];
      // Use smooth interpolation for actual values (tier letter is just for display)
      let tierData = getSmoothTierData(totalScore);

      // Update accent color
      document.documentElement.style.setProperty('--accent', tierColors.main);
      document.documentElement.style.setProperty('--accent-rgb', tierColors.rgb);

      // Top Credit Engine section updates (MODEL SCORE tab)
      document.getElementById('scoreValueTop').innerHTML = `${totalScore}<span class="text-lg font-semibold" style="color: var(--text-muted);">/100</span>`;
      document.getElementById('scoreValueTop').style.color = tierColors.main;
      document.getElementById('tierLetterTop').textContent = tier;
      document.getElementById('tierLetterTop').style.color = tierColors.main;
      document.getElementById('tierLabelTop').textContent = tierColors.label;
      document.getElementById('scoreHeaderBgTop').style.background = `linear-gradient(135deg, ${tierColors.main}15 0%, ${tierColors.main}05 100%)`;

      // Override Credit Engine section updates (MODEL OVERRIDE tab)
      document.getElementById('scoreValueOverride').innerHTML = `${totalScore}<span class="text-lg font-semibold" style="color: var(--text-muted);">/100</span>`;
      document.getElementById('scoreValueOverride').style.color = tierColors.main;
      document.getElementById('tierLetterOverride').textContent = tier;
      document.getElementById('tierLetterOverride').style.color = tierColors.main;
      document.getElementById('tierLabelOverride').textContent = tierColors.label;
      document.getElementById('scoreHeaderBgOverride').style.background = `linear-gradient(135deg, ${tierColors.main}15 0%, ${tierColors.main}05 100%)`;

      // Analytics Credit Engine section updates (ANALYTICS tab) - optional if present
      const scoreAnalytics = document.getElementById('scoreValueAnalytics');
      if (scoreAnalytics) {
        scoreAnalytics.innerHTML = `${totalScore}<span style="font-size: var(--text-2xl); font-weight: 600; color: var(--text-muted);">/100</span>`;
        scoreAnalytics.style.color = tierColors.main;
      }
      const tierLetterAnalytics = document.getElementById('tierLetterAnalytics');
      if (tierLetterAnalytics) {
        tierLetterAnalytics.textContent = tier;
        tierLetterAnalytics.style.color = tierColors.main;
      }
      const tierLabelAnalytics = document.getElementById('tierLabelAnalytics');
      if (tierLabelAnalytics) tierLabelAnalytics.textContent = tierColors.label;
      const scoreHeaderBgAnalytics = document.getElementById('scoreHeaderBgAnalytics');
      if (scoreHeaderBgAnalytics) scoreHeaderBgAnalytics.style.background = `linear-gradient(135deg, ${tierColors.main}15 0%, ${tierColors.main}05 100%)`;

      // Update breakdown bars
      document.getElementById('eventsLabelTop').textContent = events;
      document.getElementById('bufferPctTop').textContent = Math.round(buffer * 100);
      document.getElementById('eventsLabelOverride').textContent = events;
      document.getElementById('bufferPctOverride').textContent = Math.round(buffer * 100);
      // Analytics breakdown elements removed - using updateAnalyticsCards instead

      // Credit bar (weight: 20)
      const creditPct = (creditPts / creditWeight) * 100;
      document.getElementById('barCreditTop').style.width = creditPct + '%';
      document.getElementById('barCreditTop').style.background = getBarColor(creditPct);
      document.getElementById('dotCreditTop').style.background = getBarColor(creditPct);
      document.getElementById('scoreCreditTop').textContent = Math.round(creditPts) + '/' + Math.round(creditWeight);
      document.getElementById('barCreditOverride').style.width = creditPct + '%';
      document.getElementById('barCreditOverride').style.background = getBarColor(creditPct);
      document.getElementById('dotCreditOverride').style.background = getBarColor(creditPct);
      document.getElementById('scoreCreditOverride').textContent = Math.round(creditPts) + '/' + Math.round(creditWeight);

      // Behavior bar (weight: 15)
      const behavePct = (behavePts / negDaysWeight) * 100;
      document.getElementById('barBehaviorTop').style.width = behavePct + '%';
      document.getElementById('barBehaviorTop').style.background = getBarColor(behavePct);
      document.getElementById('dotBehaviorTop').style.background = getBarColor(behavePct);
      document.getElementById('scoreBehaviorTop').textContent = Math.round(behavePts) + '/' + Math.round(negDaysWeight);
      document.getElementById('barBehaviorOverride').style.width = behavePct + '%';
      document.getElementById('barBehaviorOverride').style.background = getBarColor(behavePct);
      document.getElementById('dotBehaviorOverride').style.background = getBarColor(behavePct);
      document.getElementById('scoreBehaviorOverride').textContent = Math.round(behavePts) + '/' + Math.round(negDaysWeight);

      // Revenue bar (weight: 30)
      const revPct = (revPts / revenueWeight) * 100;
      document.getElementById('barRevenueTop').style.width = revPct + '%';
      document.getElementById('barRevenueTop').style.background = getBarColor(revPct);
      document.getElementById('dotRevenueTop').style.background = getBarColor(revPct);
      document.getElementById('scoreRevenueTop').textContent = Math.round(revPts) + '/' + Math.round(revenueWeight);
      document.getElementById('barRevenueOverride').style.width = revPct + '%';
      document.getElementById('barRevenueOverride').style.background = getBarColor(revPct);
      document.getElementById('dotRevenueOverride').style.background = getBarColor(revPct);
      document.getElementById('scoreRevenueOverride').textContent = Math.round(revPts) + '/' + Math.round(revenueWeight);

      // Stability bar (weight: 20)
      const stabPct = (stabPts / tibWeight) * 100;
      document.getElementById('barStabilityTop').style.width = stabPct + '%';
      document.getElementById('barStabilityTop').style.background = getBarColor(stabPct);
      document.getElementById('dotStabilityTop').style.background = getBarColor(stabPct);
      document.getElementById('scoreStabilityTop').textContent = Math.round(stabPts) + '/' + Math.round(tibWeight);
      document.getElementById('barStabilityOverride').style.width = stabPct + '%';
      document.getElementById('barStabilityOverride').style.background = getBarColor(stabPct);
      document.getElementById('dotStabilityOverride').style.background = getBarColor(stabPct);
      document.getElementById('scoreStabilityOverride').textContent = Math.round(stabPts) + '/' + Math.round(tibWeight);

      // Buffer bar (weight: 15)
      const bufferPctBar = (bufferPts / industryWeight) * 100;
      document.getElementById('barBufferTop').style.width = bufferPctBar + '%';
      document.getElementById('barBufferTop').style.background = getBarColor(bufferPctBar);
      document.getElementById('dotBufferTop').style.background = getBarColor(bufferPctBar);
      document.getElementById('scoreBufferTop').textContent = Math.round(bufferPts) + '/' + Math.round(industryWeight);
      document.getElementById('barBufferOverride').style.width = bufferPctBar + '%';
      document.getElementById('barBufferOverride').style.background = getBarColor(bufferPctBar);
      document.getElementById('dotBufferOverride').style.background = getBarColor(bufferPctBar);
      document.getElementById('scoreBufferOverride').textContent = Math.round(bufferPts) + '/' + Math.round(industryWeight);

      // Collectibility bar
      const collectPctBar = (collectPts / collectWeight) * 100;
      document.getElementById('barCollectTop').style.width = collectPctBar + '%';
      document.getElementById('barCollectTop').style.background = getBarColor(collectPctBar);
      document.getElementById('dotCollectTop').style.background = getBarColor(collectPctBar);
      document.getElementById('scoreCollectTop').textContent = Math.round(collectPts) + '/' + Math.round(collectWeight);
      document.getElementById('barCollectOverride').style.width = collectPctBar + '%';
      document.getElementById('barCollectOverride').style.background = getBarColor(collectPctBar);
      document.getElementById('dotCollectOverride').style.background = getBarColor(collectPctBar);
      document.getElementById('scoreCollectOverride').textContent = Math.round(collectPts) + '/' + Math.round(collectWeight);

      // Check for declines
      let declined = false;
      let declineReason = '';

      if (isProhibited) {
        declined = true;
        declineReason = 'Prohibited industry - not eligible for funding';
      } else if (isTruckingDecline) {
        declined = true;
        declineReason = 'Trucking requires minimum fleet size of 5 vehicles';
      } else if (credit < 500) {
        declined = true;
        declineReason = 'Credit score below minimum threshold (500)';
      } else if (revenue < 7500) {
        declined = true;
        declineReason = 'Monthly revenue below minimum threshold ($7,500)';
      } else if (events > 10) {
        declined = true;
        declineReason = 'Too many risk events (NSF + Negative Days > 10)';
      }

      // =====================================================
      // FUNDING CALCULATION - Calibrated to RC + 10%
      // Based on analysis of real RC offers
      // SMOOTH CONTINUOUS SCORING - every slider move changes output
      // =====================================================
      
      // Base multiplier
      let fundingMult = 0.40;
      
      // TIB bonus: smooth scale from 0 to 120 months (0 to +0.60)
      // Beyond 120mo, diminishing returns up to 240mo (+0.15 more)
      const tibMonths = Math.min(tib, 240);
      if (tibMonths <= 120) {
        fundingMult += (tibMonths / 120) * 0.60;  // 0-120mo: linear to +0.60
      } else {
        fundingMult += 0.60 + ((tibMonths - 120) / 120) * 0.15;  // 120-240mo: +0.15 more
      }
      
      // Credit adjustment: smooth scale from 450 to 850
      // 450 = -0.10, 650 = 0, 850 = +0.15
      const creditNorm = (credit - 650) / 200;  // -1 at 450, 0 at 650, +1 at 850
      if (creditNorm >= 0) {
        fundingMult += creditNorm * 0.15;  // Up to +0.15 for excellent credit
      } else {
        fundingMult += creditNorm * 0.10;  // Down to -0.10 for poor credit
      }
      
      // Clean bank bonus: smooth scale based on events and negative days
      // Perfect (0 events, 0 neg days) = +0.08
      // Each event costs 0.02, each negative day costs 0.005
      const eventPenalty = events * 0.025;
      const negDayPenalty = negDays * 0.006;
      const bankHealthBonus = Math.max(-0.15, 0.08 - eventPenalty - negDayPenalty);
      fundingMult += bankHealthBonus;
      
      // Revenue scaling: higher revenue = slightly higher multiplier
      // $5k = 0, $100k+ = +0.08
      const revenueBonus = Math.min(0.08, (revenue - 5000) / 95000 * 0.08);
      fundingMult += Math.max(0, revenueBonus);
      
      // Average Daily Balance bonus: reflects cash reserves and liquidity
      // Ratio of ADB to monthly revenue - higher = better cash management
      // 10% of revenue = 0, 25%+ of revenue = +0.10
      const adbRatio = balance / revenue;  // e.g., $8k ADB / $50k rev = 0.16
      const adbBonus = Math.min(0.10, Math.max(0, (adbRatio - 0.10) / 0.15 * 0.10));
      fundingMult += adbBonus;
      
      // Floor based on revenue tier (smooth)
      const fundingFloor = 0.35 + Math.min(0.15, revenue / 500000 * 0.15);
      fundingMult = Math.max(fundingMult, fundingFloor);
      
      // Apply +10% premium over RC
      fundingMult *= 1.04;
      
      let funding = Math.round(revenue * fundingMult);
      
      // Cap at configured max funding from settings
      funding = Math.min(funding, UNDERWRITING_CRITERIA.maxFunding);
      
      // =====================================================
      // EXISTING DEBT ADJUSTMENT
      // Cap funding so total debt service stays under 25% of revenue
      // =====================================================
      if (existingDebt > 0) {
        const maxDebtService = revenue * 0.25; // Max 25% of revenue for all debt
        const availableForNew = Math.max(0, maxDebtService - existingDebt);
        
        // Calculate what funding amount this supports
        // Use tier factor and term to estimate monthly payment
        const estFactor = tierData.factor;
        const estTerm = tierData.termMonths;
        const monthlyPaymentPerDollar = estFactor / estTerm;
        
        // Max funding = available monthly payment capacity / payment per dollar
        const maxFundingFromDebt = availableForNew / monthlyPaymentPerDollar;
        
        // Apply debt-based cap (but don't go below $10k if otherwise qualified)
        if (maxFundingFromDebt < funding) {
          funding = Math.max(10000, Math.round(maxFundingFromDebt));
        }
        
        // If existing debt already exceeds capacity, decline
        if (existingDebt >= maxDebtService && !declined) {
          declined = true;
          declineReason = 'Existing debt payments exceed available cash flow capacity';
        }
      }
      
      // Minimum $10k
      funding = Math.max(funding, 10000);
      
      if (funding < 10000 && !declined) {
        declined = true;
        declineReason = 'Qualified amount below minimum funding threshold ($10,000)';
      }

      const dailyRevenue = revenue / 22;

      // Update UI
      const approvedSection = document.getElementById('approvedSection');
      const declinedSection = document.getElementById('declinedSection');

      if (declined) {
        approvedSection.classList.add('hidden');
        declinedSection.classList.remove('hidden');
        document.getElementById('declineReason').textContent = declineReason;
        document.getElementById('resultCard').style.borderColor = '#ef4444';
        document.getElementById('calcRiskIndicators').style.display = 'none';
        // document.getElementById('calcSummaryCard').style.display = 'none'; // Removed - merged into credit engine card
      } else {
        approvedSection.classList.remove('hidden');
        declinedSection.classList.add('hidden');
        document.getElementById('resultCard').style.borderColor = tierColors.main;
        document.getElementById('calcRiskIndicators').style.display = 'grid';

        // Update result header
        document.getElementById('resultLabel').textContent = `ABLESAI Tier ${tier} - Approved`;

        // Calculate offer amounts first (needed for cash flow analysis)
        const payback = Math.round(funding * tierData.factor);
        const termDays = tierData.termMonths * 22;
        const dailyPayment = Math.round(payback / termDays);
        const weeklyPayment = Math.round(payback / (tierData.termMonths * 4.33));
        const holdback = ((dailyPayment / dailyRevenue) * 100).toFixed(1);

        // Calculate monthly payment amounts for DSCR
        const monthlyPaymentDaily = dailyPayment * 22;
        const monthlyPaymentWeekly = weeklyPayment * 4.33;

        // Cash flow analysis for payment frequency decision
        const cashBuffer = balance / revenue; // balance to revenue ratio
        const debtBurdenPct = (existingDebt / revenue) * 100; // existing debt as % of revenue
        const totalEventsCount = nsf + negDays;
        
        // DSCR with weekly payments (including existing debt)
        const availableCashForDebt = revenue * 0.25; // Max 25% of revenue for debt service
        const totalMonthlyDebtWeekly = monthlyPaymentWeekly + existingDebt;
        const dscrWeekly = availableCashForDebt / totalMonthlyDebtWeekly;

        // Model decides payment frequency based on cash flow capacity
        // Weekly offered when merchant has strong cash flow metrics
        let paymentFreq = 'daily'; // default - safer for lender
        
        if (
          dscrWeekly >= 1.5 &&           // Healthy DSCR even with weekly payments
          debtBurdenPct <= 15 &&         // Low existing debt burden
          cashBuffer >= 0.08 &&          // Good cash buffer (8%+ of revenue)
          totalEventsCount <= 3          // Stable cash flow (few NSF/neg days)
        ) {
          paymentFreq = 'weekly';
        }

        // Set payment based on frequency
        let payment, paymentLabel, periodsPerMonth, daily;
        if (paymentFreq === 'weekly') {
          periodsPerMonth = 4.33;
          payment = weeklyPayment;
          daily = dailyPayment;
          paymentLabel = 'Weekly Payment';
        } else {
          periodsPerMonth = 22;
          payment = dailyPayment;
          daily = dailyPayment;
          paymentLabel = 'Daily Payment';
        }

        // Calculate APR based on payment frequency
        const totalCost = payback - funding;
        const effectiveRate = totalCost / funding;
        const termYears = tierData.termMonths / 12;
        let apr;
        if (paymentFreq === 'weekly') {
          apr = (effectiveRate / termYears) * 100 * 1.05; // Weekly 5% higher
        } else {
          apr = (effectiveRate / termYears) * 100 * 1.0; // Daily has lowest APR
        }
        apr = apr.toFixed(1);

        // Closing fees
        const origFee = Math.round(funding * 0.03);
        const adminFee = 995;
        const wireFee = 50;
        const netWire = funding - origFee - adminFee - wireFee;

        // Update offer display
        document.getElementById('offerFunding').textContent = formatCurrency(funding);
        document.getElementById('offerFactor').textContent = tierData.factor.toFixed(2) + 'x';
        document.getElementById('offerTerm').textContent = tierData.termMonths + ' Months';
        document.getElementById('offerPayback').textContent = formatCurrency(payback);
        document.getElementById('offerPayment').textContent = formatCurrency(payment);
        document.getElementById('paymentFreqLabel').textContent = paymentLabel;
        document.getElementById('offerHoldback').textContent = holdback + '%';
        document.getElementById('offerAPR').textContent = apr + '%';

        // Update summary card (removed - merged into credit engine card)
        // document.getElementById('summaryTier').textContent = tier;
        // document.getElementById('summaryTier').style.color = tierColors.main;
        // document.getElementById('summaryScore').textContent = totalScore;
        // document.getElementById('summaryFunding').textContent = formatCurrency(funding);
        // document.getElementById('summaryFactor').textContent = tierData.factor.toFixed(2) + 'x';
        // document.getElementById('summaryTerm').textContent = tierData.termMonths + ' mo';
        // document.getElementById('calcSummaryCard').style.display = 'block';
        
        // Update Calculator summary row
        document.getElementById('calcTierDisplay').textContent = tier;
        document.getElementById('calcTierDisplay').style.color = tierColors.main;
        document.getElementById('calcScoreDisplay').textContent = totalScore;
        document.getElementById('calcSummaryFunding').textContent = formatCurrency(funding);
        document.getElementById('calcSummaryFactor').textContent = tierData.factor.toFixed(2) + 'x';
        document.getElementById('calcSummaryTerm').textContent = tierData.termMonths + ' mo';

        // Update summary score bar
        const scorePct = totalScore + '%';
        document.getElementById('calcScoreFill').style.width = scorePct;
        document.getElementById('calcScoreMarker').style.left = scorePct;
        document.getElementById('calcScoreMarker').setAttribute('data-score', totalScore);

        // Update closing breakdown
        document.getElementById('closingGross').textContent = formatCurrency(funding);
        document.getElementById('closingOrig').textContent = '-' + formatCurrency(origFee);
        document.getElementById('closingNet').textContent = formatCurrency(netWire);

        // Update decision
        document.getElementById('decisionSection').style.background = `rgba(${tierColors.rgb}, 0.1)`;
        document.getElementById('decisionLabel').style.color = tierColors.main;
        document.getElementById('decisionStatus').style.color = tierColors.main;

        // Calculate and update Risk Indicators
        const tierPD = { A: 3, B: 6, C: 10, D: 18, E: 28 };
        const basePD = (tierPD[tier] || 10) * (MODEL_WEIGHTS.pdMultiplier / 100);
        
        // Update PD gauge
        const pdPct = basePD / 40;
        const arcLength = 188 * pdPct;
        document.getElementById('calcPdGaugeFill').setAttribute('stroke-dasharray', `${arcLength} 188`);
        
        let pdColor = '#10b981';
        if (basePD > 25) pdColor = '#ef4444';
        else if (basePD > 15) pdColor = '#f97316';
        else if (basePD > 5) pdColor = '#eab308';
        document.getElementById('calcPdGaugeFill').setAttribute('stroke', pdColor);
        
        // Position marker along arc (semicircle from 180deg to 0deg)
        const markerAngle = Math.PI * (1 - pdPct); // 180deg at 0%, 0deg at 100%
        const markerCx = 90 + 60 * Math.cos(markerAngle);
        const markerCy = 80 - 60 * Math.sin(markerAngle);
        document.getElementById('calcPdNeedle').setAttribute('cx', markerCx);
        document.getElementById('calcPdNeedle').setAttribute('cy', markerCy);
        document.getElementById('calcPdDisplay').textContent = basePD.toFixed(1) + '%';
        document.getElementById('calcPdValue').textContent = basePD.toFixed(1) + '%';
        document.getElementById('calcPdValue').style.color = pdColor;
        updateIndicatorBox('calcPdValue', pdColor);

        // Calculate DSCR (including existing debt)
        const monthlyDebt = payback / tierData.termMonths;
        const totalMonthlyDebt = monthlyDebt + existingDebt;
        const dscr = revenue / totalMonthlyDebt;
        
        document.getElementById('calcDscrMonthlyRev').textContent = formatCurrency(revenue);
        document.getElementById('calcDscrMonthlyDebt').textContent = formatCurrency(Math.floor(totalMonthlyDebt)) + (existingDebt > 0 ? ' (incl. existing)' : '');
        document.getElementById('calcDscrRatio').textContent = dscr.toFixed(2) + 'x';
        document.getElementById('calcDscrBarValue').textContent = dscr.toFixed(2) + 'x';
        document.getElementById('calcDscrValue').textContent = dscr.toFixed(2) + 'x';

        // DSCR bar (scale 0-3x)
        const dscrPct = Math.min(100, (dscr / 3) * 100);
        document.getElementById('calcDscrBarFill').style.width = dscrPct + '%';
        
        let dscrColor = '#ef4444';
        if (dscr >= 2) dscrColor = '#10b981';
        else if (dscr >= 1.5) dscrColor = '#22c55e';
        else if (dscr >= 1.25) dscrColor = '#eab308';
        else if (dscr >= 1) dscrColor = '#f97316';
        
        document.getElementById('calcDscrBarFill').style.background = dscrColor;
        document.getElementById('calcDscrRatio').style.color = dscrColor;
        document.getElementById('calcDscrValue').style.color = dscrColor;
        updateIndicatorBox('calcDscrValue', dscrColor);

        // DSCR warning
        const dscrWarning = document.getElementById('calcDscrWarning');
        if (dscr < 1) {
          dscrWarning.style.display = 'block';
          dscrWarning.style.background = 'rgba(239, 68, 68, 0.1)';
          dscrWarning.style.color = '#ef4444';
          dscrWarning.innerHTML = '<strong>Critical:</strong> Cannot cover debt service from revenue.';
        } else if (dscr < 1.25) {
          dscrWarning.style.display = 'block';
          dscrWarning.style.background = 'rgba(249, 115, 22, 0.1)';
          dscrWarning.style.color = '#f97316';
          dscrWarning.innerHTML = '<strong>Warning:</strong> Minimal buffer for revenue fluctuations.';
        } else if (dscr >= 2) {
          dscrWarning.style.display = 'block';
          dscrWarning.style.background = 'rgba(16, 185, 129, 0.1)';
          dscrWarning.style.color = '#10b981';
          dscrWarning.innerHTML = '<strong>Healthy DSCR:</strong> Merchant has excellent revenue coverage for debt service.';
        } else {
          dscrWarning.style.display = 'none';
        }

        // Risk Level
        let riskLevel = 'Low';
        let riskColor = '#10b981';
        if (basePD > 20 || dscr < 1.25) {
          riskLevel = 'High';
          riskColor = '#ef4444';
        } else if (basePD > 12 || dscr < 1.5) {
          riskLevel = 'Medium';
          riskColor = '#eab308';
        }
        document.getElementById('calcRiskLevel').textContent = riskLevel;
        document.getElementById('calcRiskLevel').style.color = riskColor;
        updateIndicatorBox('calcRiskLevel', riskColor);

        // Store calculated values for override tab AND analytics
        window.calcOffer = {
          funding: funding,
          factor: tierData.factor,
          term: tierData.termMonths,
          payback: payback,
          daily: daily,
          payment: payment,
          paymentFreq: paymentFreq,
          holdback: parseFloat(holdback),
          revenue: revenue,
          existingDebt: existingDebt,
          existingDebtRaw: existingDebtRaw,
          existingDebtFreq: existingDebtFreq,
          industry: industry,
          isProhibited: isProhibited,
          fleetSize: fleetSize,
          isTruckingDecline: isTruckingDecline,
          tier: tier,
          score: totalScore,
          tierColors: tierColors,
          // Score components for analytics
          creditPts: creditPts,
          behavePts: behavePts,
          revPts: revPts,
          stabPts: stabPts,
          bufferPts: bufferPts,
          collectPts: collectPts,
          // Input values for sensitivity
          credit: credit,
          tib: tib,
          nsf: nsf,
          negDays: negDays,
          balance: balance,
          // Weights for reference
          weights: {
            credit: creditWeight,
            behavior: negDaysWeight,
            revenue: revenueWeight,
            stability: tibWeight,
            buffer: industryWeight,
            collectibility: collectWeight
          }
        };
        
        // Update alternative offers
        updateAlternativeOffers(funding, tier);
      }
      
      // Update analytics if on that tab
      if (document.getElementById('tab-analytics')?.classList.contains('active')) {
        updateAnalytics();
      }
    }

    // ============================================
    // OVERRIDE TAB FUNCTIONS
    // ============================================

    function calculateOverride() {
      if (!window.calcOffer) return;

      const calc = window.calcOffer;
      const overrideFunding = parseInt(document.getElementById('overrideFunding').value);
      const overrideFactor = parseFloat(document.getElementById('overrideFactor').value);
      const overrideTerm = parseInt(document.getElementById('overrideTerm').value);
      const paymentFreq = document.querySelector('input[name="overridePaymentFreq"]:checked').value;

      // Update displays
      document.getElementById('overrideFundingDisplay').textContent = formatCurrency(overrideFunding);
      document.getElementById('overrideFactorDisplay').textContent = overrideFactor.toFixed(2) + 'x';
      document.getElementById('overrideTermDisplay').textContent = overrideTerm + ' Months';

      // Calculate override offer
      const payback = Math.round(overrideFunding * overrideFactor);
      const termDays = overrideTerm * 22;
      const daily = Math.round(payback / termDays);
      const dailyRevenue = calc.revenue / 22;
      const holdback = ((daily / dailyRevenue) * 100).toFixed(1);

      // Calculate payment based on frequency
      let payment, paymentLabel, calcPayment;
      if (paymentFreq === 'weekly') {
        const periodsPerMonth = 4.33;
        payment = Math.round(payback / (overrideTerm * periodsPerMonth));
        calcPayment = Math.round(calc.payback / (calc.term * periodsPerMonth));
        paymentLabel = 'Weekly Payment';
      } else if (paymentFreq === 'semiweekly') {
        const periodsPerMonth = 2;
        payment = Math.round(payback / (overrideTerm * periodsPerMonth));
        calcPayment = Math.round(calc.payback / (calc.term * periodsPerMonth));
        paymentLabel = 'Semi-Weekly Payment';
      } else if (paymentFreq === 'monthly') {
        payment = Math.round(payback / overrideTerm);
        calcPayment = Math.round(calc.payback / calc.term);
        paymentLabel = 'Monthly Payment';
      } else {
        payment = daily;
        calcPayment = calc.daily;
        paymentLabel = 'Daily Payment';
      }

      // Calculate APR based on payment frequency
      const totalCost = payback - overrideFunding;
      const effectiveRate = totalCost / overrideFunding;
      const termYears = overrideTerm / 12;
      let apr;
      if (paymentFreq === 'daily') {
        apr = (effectiveRate / termYears) * 100 * 1.0;
      } else if (paymentFreq === 'weekly') {
        apr = (effectiveRate / termYears) * 100 * 1.05;
      } else if (paymentFreq === 'semiweekly') {
        apr = (effectiveRate / termYears) * 100 * 1.10;
      } else {
        apr = (effectiveRate / termYears) * 100 * 1.20;
      }
      apr = apr.toFixed(1);

      // Closing fees
      const origFee = Math.round(overrideFunding * 0.03);
      const adminFee = 995;
      const wireFee = 50;
      const netWire = overrideFunding - origFee - adminFee - wireFee;

      // Update override result card
      document.getElementById('overrideOfferFunding').textContent = formatCurrency(overrideFunding);
      document.getElementById('overrideOfferFactor').textContent = overrideFactor.toFixed(2) + 'x';
      document.getElementById('overrideOfferTerm').textContent = overrideTerm + ' Months';
      document.getElementById('overrideOfferPayback').textContent = formatCurrency(payback);
      document.getElementById('overrideOfferPayment').textContent = formatCurrency(payment);
      document.getElementById('overridePaymentFreqLabel').textContent = paymentLabel;
      document.getElementById('overrideOfferHoldback').textContent = holdback + '%';
      document.getElementById('overrideOfferAPR').textContent = apr + '%';

      // Update closing breakdown
      document.getElementById('overrideClosingGross').textContent = formatCurrency(overrideFunding);
      document.getElementById('overrideClosingOrig').textContent = '-' + formatCurrency(origFee);
      document.getElementById('overrideClosingNet').textContent = formatCurrency(netWire);

      // Calculate variances
      const fundingDiff = overrideFunding - calc.funding;
      const factorDiff = overrideFactor - calc.factor;
      const termDiff = overrideTerm - calc.term;
      const paybackDiff = payback - calc.payback;
      const paymentDiff = payment - calcPayment;

      // Update variance indicators
      updateVarianceIndicator('fundingVariance', fundingDiff, formatCurrency(Math.abs(fundingDiff)));
      updateVarianceIndicator('factorVariance', factorDiff, Math.abs(factorDiff).toFixed(2) + 'x');
      updateVarianceIndicator('termVariance', termDiff, Math.abs(termDiff) + ' mo');

      // Update comparison section
      document.getElementById('compFundingCalc').textContent = formatCurrency(calc.funding);
      document.getElementById('compFundingOverride').textContent = formatCurrency(overrideFunding);
      document.getElementById('compFundingDiff').textContent = (fundingDiff >= 0 ? '+' : '') + formatCurrency(fundingDiff);
      document.getElementById('compFundingDiff').style.color = fundingDiff > 0 ? '#10b981' : fundingDiff < 0 ? '#ef4444' : 'var(--text-muted)';

      document.getElementById('compPaybackCalc').textContent = formatCurrency(calc.payback);
      document.getElementById('compPaybackOverride').textContent = formatCurrency(payback);
      document.getElementById('compPaybackDiff').textContent = (paybackDiff >= 0 ? '+' : '') + formatCurrency(paybackDiff);
      document.getElementById('compPaybackDiff').style.color = paybackDiff > 0 ? '#ef4444' : paybackDiff < 0 ? '#10b981' : 'var(--text-muted)';

      document.getElementById('compPaymentLabel').textContent = paymentLabel;
      document.getElementById('compPaymentCalc').textContent = '$' + Math.round(calcPayment);
      document.getElementById('compPaymentOverride').textContent = '$' + Math.round(payment);
      document.getElementById('compPaymentDiff').textContent = (paymentDiff >= 0 ? '+' : '') + '$' + Math.round(paymentDiff);
      document.getElementById('compPaymentDiff').style.color = paymentDiff > 0 ? '#ef4444' : paymentDiff < 0 ? '#10b981' : 'var(--text-muted)';

      // Calculate Probability of Default (PD) - simplified model
      // Base PD from tier, adjusted by variance from calculated offer
      const tierPD = { A: 3, B: 6, C: 10, D: 18, E: 28 };
      let basePD = tierPD[calc.tier] || 10;
      
      // Adjust PD based on variance (higher funding = higher risk, higher factor = lower risk)
      const fundingRatio = overrideFunding / calc.funding;
      const factorRatio = overrideFactor / calc.factor;
      const termRatio = overrideTerm / calc.term;
      
      let pdAdjustment = 0;
      pdAdjustment += (fundingRatio - 1) * 15; // +15% PD per 100% increase in funding
      pdAdjustment -= (factorRatio - 1) * 8;   // -8% PD per factor increase (higher cost = lower risk to lender)
      pdAdjustment += (termRatio - 1) * 5;     // +5% PD per term extension
      
      const estimatedPD = Math.max(1, Math.min(40, basePD + pdAdjustment));
      
      // Update PD display
      document.getElementById('pdValue').textContent = estimatedPD.toFixed(1) + '%';
      document.getElementById('pdImpact').textContent = (pdAdjustment >= 0 ? '+' : '') + pdAdjustment.toFixed(1) + '%';
      const pdImpactColor = pdAdjustment > 2 ? '#ef4444' : pdAdjustment < -2 ? '#10b981' : '#eab308';
      document.getElementById('pdImpact').style.color = pdImpactColor;
      updateIndicatorBox('pdImpact', pdImpactColor);

      // Update PD gauge
      const pdPct = estimatedPD / 40; // 40% max
      const arcLength = 188 * pdPct;
      document.getElementById('pdGaugeFill').setAttribute('stroke-dasharray', `${arcLength} 188`);
      
      // Color based on PD level
      let pdColor = '#10b981';
      if (estimatedPD > 25) pdColor = '#ef4444';
      else if (estimatedPD > 15) pdColor = '#f97316';
      else if (estimatedPD > 5) pdColor = '#eab308';
      document.getElementById('pdGaugeFill').setAttribute('stroke', pdColor);
      
      // Position marker along arc (semicircle from 180deg to 0deg)
      const markerAngle = Math.PI * (1 - pdPct);
      const markerCx = 90 + 60 * Math.cos(markerAngle);
      const markerCy = 80 - 60 * Math.sin(markerAngle);
      document.getElementById('pdNeedle').setAttribute('cx', markerCx);
      document.getElementById('pdNeedle').setAttribute('cy', markerCy);

      // Calculate DSCR
      const monthlyDebt = payback / overrideTerm;
      const dscr = calc.revenue / monthlyDebt;
      
      document.getElementById('dscrMonthlyRev').textContent = formatCurrency(calc.revenue);
      document.getElementById('dscrMonthlyDebt').textContent = formatCurrency(Math.floor(monthlyDebt));
      document.getElementById('dscrRatio').textContent = dscr.toFixed(2) + 'x';
      document.getElementById('dscrBarValue').textContent = dscr.toFixed(2) + 'x';
      document.getElementById('dscrImpact').textContent = dscr.toFixed(2) + 'x';

      // DSCR bar (scale 0-3x)
      const dscrPct = Math.min(100, (dscr / 3) * 100);
      document.getElementById('dscrBarFill').style.width = dscrPct + '%';
      
      // DSCR color
      let dscrColor = '#ef4444';
      if (dscr >= 2) dscrColor = '#10b981';
      else if (dscr >= 1.5) dscrColor = '#22c55e';
      else if (dscr >= 1.25) dscrColor = '#eab308';
      else if (dscr >= 1) dscrColor = '#f97316';
      
      document.getElementById('dscrBarFill').style.background = dscrColor;
      document.getElementById('dscrRatio').style.color = dscrColor;
      document.getElementById('dscrImpact').style.color = dscrColor;
      updateIndicatorBox('dscrImpact', dscrColor);

      // Risk score
      let riskLevel = 'Low';
      let riskColor = '#10b981';
      if (estimatedPD > 20 || dscr < 1.25) { riskLevel = 'High'; riskColor = '#ef4444'; }
      else if (estimatedPD > 12 || dscr < 1.5) { riskLevel = 'Medium'; riskColor = '#eab308'; }
      
      document.getElementById('riskScore').textContent = riskLevel;
      document.getElementById('riskScore').style.color = riskColor;
      updateIndicatorBox('riskScore', riskColor);

      // DSCR warning
      const dscrWarning = document.getElementById('dscrWarning');
      if (dscr < 1) {
        dscrWarning.style.display = 'block';
        dscrWarning.style.background = 'rgba(239, 68, 68, 0.1)';
        dscrWarning.style.color = '#ef4444';
        dscrWarning.innerHTML = '<strong>Warning:</strong> DSCR below 1.0x indicates merchant cannot cover debt service from revenue.';
      } else if (dscr < 1.25) {
        dscrWarning.style.display = 'block';
        dscrWarning.style.background = 'rgba(249, 115, 22, 0.1)';
        dscrWarning.style.color = '#f97316';
        dscrWarning.innerHTML = '<strong>Caution:</strong> DSCR below 1.25x leaves minimal buffer for revenue fluctuations.';
      } else if (dscr >= 2) {
        dscrWarning.style.display = 'block';
        dscrWarning.style.background = 'rgba(16, 185, 129, 0.1)';
        dscrWarning.style.color = '#10b981';
        dscrWarning.innerHTML = '<strong>Healthy DSCR:</strong> Merchant has excellent revenue coverage for debt service.';
      } else {
        dscrWarning.style.display = 'none';
      }

      // Update override decision styling based on risk
      const tierColors = calc.tierColors;
      document.getElementById('overrideResultCard').style.borderColor = riskColor;
      document.getElementById('overrideDecisionSection').style.background = `rgba(${riskColor === '#10b981' ? '16, 185, 129' : riskColor === '#eab308' ? '234, 179, 8' : '239, 68, 68'}, 0.1)`;
      document.getElementById('overrideDecisionStatus').style.color = riskColor;
    }

    function updateVarianceIndicator(elementId, diff, formattedDiff) {
      const el = document.getElementById(elementId);
      if (Math.abs(diff) < 0.001) {
        el.className = 'variance-indicator neutral';
        el.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14"/></svg><span>No variance from calculated</span>`;
      } else if (diff > 0) {
        el.className = 'variance-indicator positive';
        el.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg><span>+${formattedDiff} above calculated</span>`;
      } else {
        el.className = 'variance-indicator negative';
        el.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg><span>-${formattedDiff} below calculated</span>`;
      }
    }

    function resetOverride() {
      if (!window.calcOffer) return;
      
      const calc = window.calcOffer;
      document.getElementById('overrideFunding').value = calc.funding;
      document.getElementById('overrideFactor').value = calc.factor;
      document.getElementById('overrideTerm').value = calc.term;
      
      // Reset payment frequency to daily (model default)
      document.querySelector('input[name="overridePaymentFreq"][value="daily"]').checked = true;
      
      calculateOverride();
    }

    function syncOverrideTab() {
      if (!window.calcOffer) return;
      
      const calc = window.calcOffer;
      
      // Update header displays
      document.getElementById('overrideTierDisplay').textContent = calc.tier;
      document.getElementById('overrideTierDisplay').style.color = calc.tierColors.main;
      document.getElementById('overrideScoreDisplay').textContent = calc.score;
      document.getElementById('calcFundingDisplay').textContent = formatCurrency(calc.funding);
      document.getElementById('calcFactorDisplay').textContent = calc.factor.toFixed(2) + 'x';
      document.getElementById('calcTermDisplay').textContent = calc.term + ' mo';
      
      // Update override score bar
      const scorePct = calc.score + '%';
      document.getElementById('overrideScoreFill').style.width = scorePct;
      document.getElementById('overrideScoreMarker').style.left = scorePct;
      document.getElementById('overrideScoreMarker').setAttribute('data-score', calc.score);

      // Update reference values
      document.getElementById('calcFundingRef').textContent = formatCurrency(calc.funding);
      document.getElementById('calcFactorRef').textContent = calc.factor.toFixed(2) + 'x';
      document.getElementById('calcTermRef').textContent = calc.term + ' mo';

      // Sync payment frequency - default to daily (model default)
      document.querySelector('input[name="overridePaymentFreq"][value="daily"]').checked = true;

      // Set slider ranges based on calculated values
      const fundingSlider = document.getElementById('overrideFunding');
      fundingSlider.min = Math.max(5000, calc.funding * 0.5);
      fundingSlider.max = Math.min(150000, calc.funding * 2);
      fundingSlider.value = calc.funding;

      document.getElementById('overrideFactor').value = calc.factor;
      document.getElementById('overrideTerm').value = calc.term;

      calculateOverride();
    }

    // Tab Switching
    function switchTab(tabName, evt) {
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('tab-' + tabName).classList.add('active');
      if (evt && evt.currentTarget) {
        evt.currentTarget.classList.add('active');
      } else {
        // Fallback: find the button by onclick attribute
        document.querySelector(`[onclick*="switchTab('${tabName}'"]`)?.classList.add('active');
      }
      
      // Hide/show FAB based on tab (hide on MODEL INFO and PRO tabs)
      const fab = document.getElementById('sliderFab');
      if (fab) {
        if (tabName === 'model' || tabName === 'analytics' || tabName === 'compare' || tabName === 'reports') {
          fab.style.display = 'none';
        } else {
          fab.style.display = '';
        }
      }
      
      if (tabName === 'calculator') {
        calculate();
      } else if (tabName === 'override') {
        syncOverrideTab();
      } else if (tabName === 'analytics') {
        updateAnalytics();
      } else if (tabName === 'reports') {
        updateReportPreview();
      }
    }

    // ============================================
    // ABLESAI PRO - PREMIUM FEATURES
    // ============================================

    // Global state for PRO features
    let compareDeals = [];
    let auditLog = [];
    let savedDeals = JSON.parse(localStorage.getItem('ablesai_pro_deals') || '[]');
    let debtPositions = [];

    // Quick Presets
    const presets = {
      'strong-retail': {
        name: 'Strong Retail',
        credit: 720,
        revenue: 85000,
        balance: 15000,
        tib: 48,
        nsf: 0,
        negDays: 0,
        existingDebt: 0
      },
      'new-business': {
        name: 'New Business',
        credit: 650,
        revenue: 35000,
        balance: 5000,
        tib: 6,
        nsf: 2,
        negDays: 1,
        existingDebt: 0
      },
      'established': {
        name: 'Established',
        credit: 700,
        revenue: 120000,
        balance: 25000,
        tib: 72,
        nsf: 1,
        negDays: 0,
        existingDebt: 2000
      },
      'risky-restaurant': {
        name: 'Risky Restaurant',
        credit: 580,
        revenue: 45000,
        balance: 4000,
        tib: 18,
        nsf: 5,
        negDays: 3,
        existingDebt: 1500
      },
      'high-volume': {
        name: 'High Volume',
        credit: 680,
        revenue: 250000,
        balance: 40000,
        tib: 36,
        nsf: 2,
        negDays: 0,
        existingDebt: 3000
      }
    };

    function loadPreset(presetKey) {
      const preset = presets[presetKey];
      if (!preset) return;
      
      document.getElementById('creditScore').value = preset.credit;
      document.getElementById('monthlyRevenue').value = preset.revenue;
      document.getElementById('avgDailyBalance').value = preset.balance;
      document.getElementById('timeInBusiness').value = preset.tib;
      document.getElementById('nsfCount').value = preset.nsf;
      document.getElementById('negativeDays').value = preset.negDays;
      document.getElementById('existingDebt').value = preset.existingDebt;
      
      logAudit(`Loaded preset: ${preset.name}`);
      calculate();
      
      // Show notification
      showNotification(`Loaded "${preset.name}" preset`);
    }

    // Save/Load Deals
    function saveDeal() {
      const dealName = prompt('Enter a name for this deal:', `Deal ${savedDeals.length + 1}`);
      if (!dealName) return;
      
      const deal = {
        id: Date.now(),
        name: dealName,
        timestamp: new Date().toISOString(),
        inputs: {
          credit: parseInt(document.getElementById('creditScore').value),
          revenue: parseInt(document.getElementById('monthlyRevenue').value),
          balance: parseInt(document.getElementById('avgDailyBalance').value),
          tib: parseInt(document.getElementById('timeInBusiness').value),
          nsf: parseInt(document.getElementById('nsfCount').value),
          negDays: parseInt(document.getElementById('negativeDays').value),
          existingDebt: parseInt(document.getElementById('existingDebt').value)
        },
        results: getCurrentResults(),
        notes: document.getElementById('dealNotes')?.value || ''
      };
      
      savedDeals.push(deal);
      localStorage.setItem('ablesai_pro_deals', JSON.stringify(savedDeals));
      
      logAudit(`Saved deal: ${dealName}`);
      showNotification(`Deal "${dealName}" saved successfully`);
    }

    function loadDeal() {
      if (savedDeals.length === 0) {
        showNotification('No saved deals found', 'warning');
        return;
      }
      
      const dealList = savedDeals.map((d, i) => `${i + 1}. ${d.name} (${new Date(d.timestamp).toLocaleDateString()})`).join('\n');
      const selection = prompt(`Select a deal to load:\n\n${dealList}\n\nEnter number:`);
      
      if (!selection) return;
      
      const index = parseInt(selection) - 1;
      if (index < 0 || index >= savedDeals.length) {
        showNotification('Invalid selection', 'error');
        return;
      }
      
      const deal = savedDeals[index];
      
      document.getElementById('creditScore').value = deal.inputs.credit;
      document.getElementById('monthlyRevenue').value = deal.inputs.revenue;
      document.getElementById('avgDailyBalance').value = deal.inputs.balance;
      document.getElementById('timeInBusiness').value = deal.inputs.tib;
      document.getElementById('nsfCount').value = deal.inputs.nsf;
      document.getElementById('negativeDays').value = deal.inputs.negDays;
      document.getElementById('existingDebt').value = deal.inputs.existingDebt;
      
      if (deal.notes && document.getElementById('dealNotes')) {
        document.getElementById('dealNotes').value = deal.notes;
      }
      
      logAudit(`Loaded deal: ${deal.name}`);
      calculate();
      showNotification(`Loaded "${deal.name}"`);
    }

    function getCurrentResults() {
      if (!window.calcOffer) return {};
      const d = window.calcOffer;
      return {
        score: d.score || 0,
        tier: d.tier || '--',
        funding: formatCurrency(d.funding),
        fundingRaw: d.funding,
        payback: formatCurrency(d.payback),
        paybackRaw: d.payback,
        term: (d.term || 0) + ' mo',
        termRaw: d.term,
        factor: (d.factor?.toFixed(2) || '--') + 'x',
        factorRaw: d.factor,
        daily: formatCurrency(d.daily),
        dailyRaw: d.daily,
        weekly: formatCurrency((d.daily || 0) * 5),
        weeklyRaw: (d.daily || 0) * 5,
        revenue: d.revenue,
        credit: d.credit
      };
    }

    // Compare Mode
    function addToCompare() {
      if (!window.calcOffer) {
        showNotification('Please calculate first', 'error');
        return;
      }
      
      const currentResults = getCurrentResults();
      const d = window.calcOffer;
      
      const inputs = {
        credit: d.credit,
        revenue: d.revenue,
        balance: d.balance,
        tib: d.tib,
        nsf: d.nsf,
        negDays: d.negDays,
        existingDebt: d.existingDebtRaw
      };
      
      const deal = {
        id: Date.now(),
        name: `Deal ${compareDeals.length + 1}`,
        inputs: inputs,
        results: currentResults
      };
      
      compareDeals.push(deal);
      updateCompareGrid();
      logAudit(`Added to compare: ${deal.name}`);
      showNotification(`Added to comparison (${compareDeals.length} deals)`);
    }

    function updateCompareGrid() {
      const grid = document.getElementById('compareGrid');
      const summary = document.getElementById('compareSummary');
      const countEl = document.getElementById('compareCount');
      
      countEl.textContent = compareDeals.length;
      
      if (compareDeals.length === 0) {
        grid.innerHTML = `
          <div class="card p-8 text-center" style="border: 2px dashed var(--border-primary);">
            <div class="text-4xl mb-4" style="opacity: 0.3;"></div>
            <div class="text-sm" style="color: var(--text-muted);">No deals added yet</div>
            <div class="text-xs mt-2" style="color: var(--text-muted);">Use "Add Current Deal" or press <kbd class="kbd">Ctrl+D</kbd></div>
          </div>
        `;
        summary.style.display = 'none';
        return;
      }
      
      grid.innerHTML = compareDeals.map((deal, index) => `
        <div class="compare-card">
          <div class="compare-card-header">
            <span class="compare-card-title">${deal.name}</span>
            <button onclick="removeFromCompare(${index})" style="color: var(--text-muted); background: none; border: none; cursor: pointer;"></button>
          </div>
          <div class="compare-card-body">
            <div class="text-center mb-4">
              <div class="text-3xl font-extrabold" style="color: var(--accent);">${deal.results.score}</div>
              <div class="text-xs uppercase" style="color: var(--text-muted);">ABLESCORE</div>
            </div>
            <div class="compare-row">
              <span class="compare-label">Funding</span>
              <span class="compare-value">${deal.results.funding}</span>
            </div>
            <div class="compare-row">
              <span class="compare-label">Tier</span>
              <span class="compare-value">${deal.results.tier}</span>
            </div>
            <div class="compare-row">
              <span class="compare-label">Term</span>
              <span class="compare-value">${deal.results.term}</span>
            </div>
            <div class="compare-row">
              <span class="compare-label">Factor</span>
              <span class="compare-value">${deal.results.factor}</span>
            </div>
            <div class="compare-row">
              <span class="compare-label">Daily</span>
              <span class="compare-value">${deal.results.daily}</span>
            </div>
            <div class="compare-row">
              <span class="compare-label">Revenue</span>
              <span class="compare-value">${formatCurrency(deal.inputs.revenue)}</span>
            </div>
            <div class="compare-row">
              <span class="compare-label">Credit</span>
              <span class="compare-value">${deal.inputs.credit}</span>
            </div>
          </div>
        </div>
      `).join('');
      
      // Update summary
      if (compareDeals.length > 1) {
        summary.style.display = 'block';
        
        const scores = compareDeals.map(d => d.results.score);
        const fundings = compareDeals.map(d => parseInt(d.results.funding.replace(/[$,]/g, '')) || 0);
        
        document.getElementById('summaryHighestFunding').textContent = formatCurrency(Math.max(...fundings));
        document.getElementById('summaryBestScore').textContent = Math.max(...scores);
        document.getElementById('summaryLowestRisk').textContent = compareDeals.reduce((best, d) => d.results.score > best.results.score ? d : best).name;
        document.getElementById('summaryBestROI').textContent = compareDeals.reduce((best, d) => {
          const funding = parseInt(d.results.funding.replace(/[$,]/g, '')) || 0;
          const payback = parseInt(d.results.payback.replace(/[$,]/g, '')) || 0;
          const roi = payback - funding;
          const bestFunding = parseInt(best.results.funding.replace(/[$,]/g, '')) || 0;
          const bestPayback = parseInt(best.results.payback.replace(/[$,]/g, '')) || 0;
          const bestRoi = bestPayback - bestFunding;
          return roi > bestRoi ? d : best;
        }).name;
      } else {
        summary.style.display = 'none';
      }
    }

    function removeFromCompare(index) {
      compareDeals.splice(index, 1);
      updateCompareGrid();
    }

    function clearCompare() {
      if (confirm('Clear all deals from comparison?')) {
        compareDeals = [];
        updateCompareGrid();
        showNotification('Comparison cleared');
      }
    }

    // Analytics Updates
    function updateAnalytics() {
      if (!window.calcOffer) {
        calculate(); // Ensure we have data
      }
      
      const data = window.calcOffer;
      if (!data) return;
      
      const score = data.score;
      const funding = data.funding;
      const tier = data.tier;
      
      // Update gauge
      updateGauge(score);
      
      // Update confidence
      const confidence = Math.min(95, 50 + score * 0.45);
      const confValueEl = document.getElementById('confidenceValue');
      const confFillEl = document.getElementById('confidenceFill');
      if (confValueEl) confValueEl.textContent = Math.round(confidence) + '%';
      if (confFillEl) confFillEl.style.width = confidence + '%';
      
      // Update risk breakdown
      updateRiskBreakdown();
      
      // Update AI recommendation
      updateAIRecommendation(score, tier, funding);
      
      // Update Analytics PRO section
      updateAnalyticsPRO();
      
      // Update analytics cards
      if (typeof updateAnalyticsCards === 'function') {
        updateAnalyticsCards();
      }
      
      // Update complete Analytics PRO dashboard
      if (typeof updateAnalyticsPROComplete === 'function') {
        updateAnalyticsPROComplete();
      }
      
      // Update sensitivity analysis
      updateSensitivityAnalysis();
      
      // Update alternative offers
      updateAlternativeOffers(funding, tier);
      
      // Update benchmarks
      updateBenchmarks(score, funding);
      
      // Update stacking analysis
      updateStackingAnalysis();
    }

    function updateGauge(score) {
      const gaugeScoreEl = document.getElementById('gaugeScoreValue');
      const gaugeFillEl = document.getElementById('gaugeFill');
      const gaugeNeedleEl = document.getElementById('gaugeNeedle');
      
      if (!gaugeScoreEl || !gaugeFillEl || !gaugeNeedleEl) return;
      
      gaugeScoreEl.textContent = score;
      
      // Arc calculation (180 degrees = score 0-100)
      const maxArc = 251.2; // Circumference of the arc
      const fillPercent = score / 100;
      const offset = maxArc * (1 - fillPercent);
      gaugeFillEl.style.strokeDashoffset = offset;
      
      // Color based on score
      let color = '#ef4444'; // Red
      if (score >= 70) color = '#22c55e'; // Green
      else if (score >= 50) color = '#eab308'; // Gold
      else if (score >= 30) color = '#f97316'; // Orange
      gaugeFillEl.style.stroke = color;
      
      // Needle rotation (-90 to 90 degrees for 0 to 100)
      const rotation = -90 + (score / 100) * 180;
      gaugeNeedleEl.style.transform = `rotate(${rotation}deg)`;
    }

    function updateRiskBreakdown() {
      if (!window.calcOffer) return;
      
      const data = window.calcOffer;
      const creditPts = data.creditPts || 0;
      const behavePts = data.behavePts || 0;
      const revPts = data.revPts || 0;
      const stabPts = data.stabPts || 0;
      const bufferPts = data.bufferPts || 0;
      
      // Get weights from calcOffer or use defaults
      const maxCredit = data.weights?.credit || 20;
      const maxBehavior = data.weights?.behavior || 15;
      const maxRevenue = data.weights?.revenue || 30;
      const maxStability = data.weights?.stability || 20;
      const maxBuffer = data.weights?.buffer || 15;
      
      // Update risk cards
      const riskCreditEl = document.getElementById('riskCredit');
      const riskCreditBarEl = document.getElementById('riskCreditBar');
      if (riskCreditEl) riskCreditEl.textContent = Math.round(creditPts);
      if (riskCreditBarEl) riskCreditBarEl.style.width = (creditPts / maxCredit * 100) + '%';
      
      const riskBehaviorEl = document.getElementById('riskBehavior');
      const riskBehaviorBarEl = document.getElementById('riskBehaviorBar');
      if (riskBehaviorEl) riskBehaviorEl.textContent = Math.round(behavePts);
      if (riskBehaviorBarEl) riskBehaviorBarEl.style.width = (behavePts / maxBehavior * 100) + '%';
      
      const riskRevenueEl = document.getElementById('riskRevenue');
      const riskRevenueBarEl = document.getElementById('riskRevenueBar');
      if (riskRevenueEl) riskRevenueEl.textContent = Math.round(revPts);
      if (riskRevenueBarEl) riskRevenueBarEl.style.width = (revPts / maxRevenue * 100) + '%';
      
      const riskStabilityEl = document.getElementById('riskStability');
      const riskStabilityBarEl = document.getElementById('riskStabilityBar');
      if (riskStabilityEl) riskStabilityEl.textContent = Math.round(stabPts);
      if (riskStabilityBarEl) riskStabilityBarEl.style.width = (stabPts / maxStability * 100) + '%';
      
      const riskBufferEl = document.getElementById('riskBuffer');
      const riskBufferBarEl = document.getElementById('riskBufferBar');
      if (riskBufferEl) riskBufferEl.textContent = Math.round(bufferPts);
      if (riskBufferBarEl) riskBufferBarEl.style.width = (bufferPts / maxBuffer * 100) + '%';
    }

    function updateAIRecommendation(score, tier, funding) {
      const riskLevelEl = document.getElementById('analyticsRiskLevel');
      const defaultProbEl = document.getElementById('analyticsDefaultProb');
      const roiEl = document.getElementById('analyticsROI');
      const recTextEl = document.getElementById('aiRecommendationText');
      
      if (!riskLevelEl || !defaultProbEl || !roiEl || !recTextEl) return;
      
      // Risk level
      let riskLevel = 'Very High';
      let riskColor = '#ef4444';
      if (score >= 70) { riskLevel = 'Low'; riskColor = '#22c55e'; }
      else if (score >= 55) { riskLevel = 'Moderate'; riskColor = '#eab308'; }
      else if (score >= 40) { riskLevel = 'Elevated'; riskColor = '#f97316'; }
      else if (score >= 25) { riskLevel = 'High'; riskColor = '#ef4444'; }
      
      riskLevelEl.textContent = riskLevel;
      riskLevelEl.style.color = riskColor;
      
      // Default probability estimate (rough heuristic)
      const defaultProb = Math.max(2, Math.min(35, 40 - score * 0.4));
      defaultProbEl.textContent = defaultProb.toFixed(1) + '%';
      defaultProbEl.style.color = defaultProb > 15 ? '#ef4444' : defaultProb > 8 ? '#f97316' : '#22c55e';
      
      // ROI estimate - use smooth tier data for continuous scoring
      const smoothTierData = getSmoothTierData(score);
      const factor = smoothTierData.factor;
      const roi = ((factor - 1) * 100 * (1 - defaultProb / 100)).toFixed(1);
      roiEl.textContent = roi + '%';
      roiEl.style.color = parseFloat(roi) > 15 ? '#22c55e' : parseFloat(roi) > 8 ? '#eab308' : '#ef4444';
      
      // AI recommendation text
      let recommendation = '';
      const isDecline = tier === 'DECLINE' || (window.calcOffer && (window.calcOffer.isProhibited || window.calcOffer.isTruckingDecline));
      
      if (isDecline) {
        recommendation = `This deal does not meet minimum underwriting criteria. The ABLESCORE of ${score} indicates significant risk factors that exceed acceptable thresholds. Recommend declining or requesting additional documentation to improve the risk profile.`;
      } else if (score >= 70) {
        recommendation = `Strong approval recommended. This merchant shows excellent fundamentals with a ${score} ABLESCORE. The ${tier} tier qualification suggests low default risk and healthy cash flow coverage. Consider this a priority deal with standard ${factor.toFixed(2)}x factor rate.`;
      } else if (score >= 55) {
        recommendation = `Conditional approval recommended. The ${score} ABLESCORE indicates moderate risk. Verify bank statements manually and consider a slightly lower funding amount or shorter term. The ${tier} tier is appropriate but monitor closely.`;
      } else if (score >= 40) {
        recommendation = `Caution advised. The ${score} ABLESCORE suggests elevated risk factors. If proceeding, recommend reduced funding amount (70-80% of calculated), shorter term, and enhanced monitoring. Verify all documentation thoroughly.`;
      } else {
        recommendation = `High risk profile. The ${score} ABLESCORE indicates multiple concerning factors. If considering approval, limit exposure significantly and require additional collateral or guarantees. Default probability is elevated.`;
      }
      
      recTextEl.textContent = recommendation;
    }

    function updateAnalyticsPRO() {
      if (!window.calcOffer) return;
      
      const data = window.calcOffer;
      const score = data.totalScore || 62;
      const tier = data.tier || 'C';
      const funding = data.funding || 0;
      const revenue = data.revenue || 50000;
      const payback = data.payback || 0;
      const term = data.term || 6;
      
      // Calculate PD based on tier
      const tierPD = { A: 3, B: 6, C: 10, D: 18, E: 28, DECLINE: 35 };
      let basePD = tierPD[tier] || 10;
      const estimatedPD = Math.max(2, Math.min(35, basePD + (100 - score) * 0.15));
      
      // Update PD displays
      const pdImpact = document.getElementById('analyticsPdImpact');
      const pdValue = document.getElementById('analyticsPdValue');
      const pdGaugeFill = document.getElementById('analyticsPdGaugeFill');
      
      if (pdImpact) pdImpact.textContent = estimatedPD.toFixed(1) + '%';
      if (pdValue) pdValue.textContent = estimatedPD.toFixed(1) + '%';
      
      // Update PD gauge
      const pdPct = estimatedPD / 40;
      const arcLength = 188 * pdPct;
      if (pdGaugeFill) pdGaugeFill.setAttribute('stroke-dasharray', `${arcLength} 188`);
      
      let pdColor = '#10b981';
      if (estimatedPD > 25) pdColor = '#ef4444';
      else if (estimatedPD > 15) pdColor = '#f97316';
      else if (estimatedPD > 5) pdColor = '#eab308';
      
      if (pdImpact) pdImpact.style.color = pdColor;
      if (pdGaugeFill) pdGaugeFill.setAttribute('stroke', pdColor);
      
      // Calculate DSCR
      const monthlyDebt = payback / term;
      const existingDebt = parseInt(document.getElementById('existingDebt')?.value) || 0;
      const totalMonthlyDebt = monthlyDebt + existingDebt;
      const dscr = totalMonthlyDebt > 0 ? revenue / totalMonthlyDebt : 99;
      
      // Update DSCR displays
      const dscrImpact = document.getElementById('analyticsDscrImpact');
      const dscrValue = document.getElementById('analyticsDscrValue');
      const monthlyRev = document.getElementById('analyticsMonthlyRev');
      const monthlyDebtEl = document.getElementById('analyticsMonthlyDebt');
      const holdback = document.getElementById('analyticsHoldback');
      
      if (dscrImpact) dscrImpact.textContent = dscr.toFixed(2) + 'x';
      if (dscrValue) dscrValue.textContent = dscr.toFixed(2) + 'x';
      if (monthlyRev) monthlyRev.textContent = formatCurrency(revenue);
      if (monthlyDebtEl) monthlyDebtEl.textContent = formatCurrency(Math.floor(totalMonthlyDebt));
      if (holdback) holdback.textContent = dscr.toFixed(2) + 'x';
      
      let dscrColor = '#ef4444';
      if (dscr >= 2) dscrColor = '#10b981';
      else if (dscr >= 1.5) dscrColor = '#22c55e';
      else if (dscr >= 1.25) dscrColor = '#eab308';
      else if (dscr >= 1) dscrColor = '#f97316';
      
      if (dscrImpact) dscrImpact.style.color = dscrColor;
      if (holdback) holdback.style.color = dscrColor;
      
      // Update Risk Score
      const riskScore = document.getElementById('analyticsRiskScore');
      if (riskScore) {
        let riskLevel = 'Very High';
        let riskColor = '#ef4444';
        if (score >= 70) { riskLevel = 'Low'; riskColor = '#10b981'; }
        else if (score >= 55) { riskLevel = 'Medium'; riskColor = '#eab308'; }
        else if (score >= 40) { riskLevel = 'Elevated'; riskColor = '#f97316'; }
        else if (score >= 25) { riskLevel = 'High'; riskColor = '#ef4444'; }
        
        riskScore.textContent = riskLevel;
        riskScore.style.color = riskColor;
      }
      
      // Update confidence gauge
      const confidence = Math.min(100, Math.max(20, score + 10 + (dscr > 1.5 ? 10 : 0)));
      const confidenceValue = document.getElementById('confidenceValue');
      const confidenceGaugeFill = document.getElementById('confidenceGaugeFill');
      
      if (confidenceValue) confidenceValue.textContent = Math.round(confidence) + '%';
      
      if (confidenceGaugeFill) {
        const confOffset = 251.2 * (1 - confidence / 100);
        confidenceGaugeFill.setAttribute('stroke-dashoffset', confOffset);
      }
    }

    function updateSensitivityAnalysis() {
      if (!window.calcOffer) return;
      
      const data = window.calcOffer;
      const credit = data.credit || 650;
      const revenue = data.revenue || 50000;
      const tib = data.tib || 12;
      const nsf = data.nsf || 0;
      const balance = data.balance || 5000;
      const currentFunding = data.funding || 0;
      
      // Calculate impact of changes (simplified estimates)
      const creditImpact = credit < 800 ? Math.round(currentFunding * 0.08) : 0;
      const revenueImpact = Math.round(currentFunding * 0.15);
      const tibImpact = tib < 108 ? Math.round(currentFunding * 0.05) : 0;
      const nsfImpact = nsf > 0 ? Math.round(currentFunding * 0.06) : 0;
      const balanceImpact = Math.round(currentFunding * 0.10);
      
      // Update display
      updateSensitivityRow('sensCredit', 'sensCreditImpact', creditImpact, currentFunding);
      updateSensitivityRow('sensRevenue', 'sensRevenueImpact', revenueImpact, currentFunding);
      updateSensitivityRow('sensTIB', 'sensTIBImpact', tibImpact, currentFunding);
      updateSensitivityRow('sensNSF', 'sensNSFImpact', nsfImpact, currentFunding);
      updateSensitivityRow('sensBalance', 'sensBalanceImpact', balanceImpact, currentFunding);
    }

    function updateSensitivityRow(barId, impactId, impact, baseline) {
      const barEl = document.getElementById(barId);
      const impactEl = document.getElementById(impactId);
      
      if (!barEl || !impactEl) return;
      
      const percent = Math.min(100, (impact / (baseline || 1)) * 100 * 3);
      barEl.style.width = percent + '%';
      
      impactEl.textContent = impact > 0 ? '+' + formatCurrency(impact) : '$0';
      impactEl.className = 'sensitivity-impact ' + (impact > 0 ? 'impact-positive' : 'impact-neutral');
    }

    function updateAlternativeOffers(funding, tier) {
      if (!window.calcOffer) return;
      
      const data = window.calcOffer;
      const score = data.score || 50;
      const tierData = getSmoothTierData(score);
      const revenue = data.revenue || 50000;
      const dailyRevenue = revenue / 22;
      
      const conservative = Math.round(funding * 0.7);
      const aggressive = Math.round(funding * 1.25);
      
      // Conservative offer
      const consTermMonths = Math.max(3, tierData.termMonths - 1);
      const consFactor = Math.max(1.15, tierData.factor - 0.03);
      const consDays = consTermMonths * 22;
      const consPayback = Math.round(conservative * consFactor);
      const consDaily = Math.round(consPayback / consDays);
      const consHoldback = ((consDaily / dailyRevenue) * 100).toFixed(1);
      
      const offerConsAmtEl = document.getElementById('offerConservativeAmt');
      const offerConsTermEl = document.getElementById('offerConservativeTerm');
      const offerConsPmtEl = document.getElementById('offerConservativePmt');
      if (offerConsAmtEl) offerConsAmtEl.textContent = formatCurrency(conservative);
      if (offerConsTermEl) offerConsTermEl.textContent = consTermMonths + ' months';
      if (offerConsPmtEl) offerConsPmtEl.textContent = formatCurrency(consDaily) + '/day';
      
      // Recommended (current)
      const offerRecAmtEl = document.getElementById('offerRecommendedAmt');
      const offerRecTermEl = document.getElementById('offerRecommendedTerm');
      const offerRecPmtEl = document.getElementById('offerRecommendedPmt');
      if (offerRecAmtEl) offerRecAmtEl.textContent = formatCurrency(funding);
      if (offerRecTermEl) offerRecTermEl.textContent = tierData.termMonths + ' months';
      if (offerRecPmtEl) offerRecPmtEl.textContent = formatCurrency(data.daily) + '/day';
      
      // Recommended expanded details
      const recPayback = Math.round(funding * tierData.factor);
      const recHoldback = ((data.daily / dailyRevenue) * 100).toFixed(1);
      
      // Aggressive offer
      const aggTermMonths = tierData.termMonths + 1;
      const aggFactor = tierData.factor + 0.05;
      const aggDays = aggTermMonths * 22;
      const aggPayback = Math.round(aggressive * aggFactor);
      const aggDaily = Math.round(aggPayback / aggDays);
      const aggHoldback = ((aggDaily / dailyRevenue) * 100).toFixed(1);
      
      const offerAggAmtEl = document.getElementById('offerAggressiveAmt');
      const offerAggTermEl = document.getElementById('offerAggressiveTerm');
      const offerAggPmtEl = document.getElementById('offerAggressivePmt');
      if (offerAggAmtEl) offerAggAmtEl.textContent = formatCurrency(aggressive);
      if (offerAggTermEl) offerAggTermEl.textContent = aggTermMonths + ' months';
      if (offerAggPmtEl) offerAggPmtEl.textContent = formatCurrency(aggDaily) + '/day';
      
      // Also update MODEL SCORE tab offers (calc prefix)
      const calcConsAmtEl = document.getElementById('calcOfferConservativeAmt');
      if (calcConsAmtEl) calcConsAmtEl.textContent = formatCurrency(conservative);
      const calcConsTermEl = document.getElementById('calcOfferConservativeTerm');
      if (calcConsTermEl) calcConsTermEl.textContent = consTermMonths + ' months';
      const calcConsPmtEl = document.getElementById('calcOfferConservativePmt');
      if (calcConsPmtEl) calcConsPmtEl.textContent = formatCurrency(consDaily) + '/day';
      const calcConsFactorEl = document.getElementById('calcOfferConservativeFactor');
      if (calcConsFactorEl) calcConsFactorEl.textContent = consFactor.toFixed(2) + 'x';
      const calcConsPaybackEl = document.getElementById('calcOfferConservativePayback');
      if (calcConsPaybackEl) calcConsPaybackEl.textContent = formatCurrency(consPayback);
      const calcConsHoldbackEl = document.getElementById('calcOfferConservativeHoldback');
      if (calcConsHoldbackEl) calcConsHoldbackEl.textContent = consHoldback + '%';
      
      const calcRecAmtEl = document.getElementById('calcOfferRecommendedAmt');
      if (calcRecAmtEl) calcRecAmtEl.textContent = formatCurrency(funding);
      const calcRecTermEl = document.getElementById('calcOfferRecommendedTerm');
      if (calcRecTermEl) calcRecTermEl.textContent = tierData.termMonths + ' months';
      const calcRecPmtEl = document.getElementById('calcOfferRecommendedPmt');
      if (calcRecPmtEl) calcRecPmtEl.textContent = formatCurrency(data.daily) + '/day';
      const calcRecFactorEl = document.getElementById('calcOfferRecommendedFactor');
      if (calcRecFactorEl) calcRecFactorEl.textContent = tierData.factor.toFixed(2) + 'x';
      const calcRecPaybackEl = document.getElementById('calcOfferRecommendedPayback');
      if (calcRecPaybackEl) calcRecPaybackEl.textContent = formatCurrency(recPayback);
      const calcRecHoldbackEl = document.getElementById('calcOfferRecommendedHoldback');
      if (calcRecHoldbackEl) calcRecHoldbackEl.textContent = recHoldback + '%';
      
      const calcAggAmtEl = document.getElementById('calcOfferAggressiveAmt');
      if (calcAggAmtEl) calcAggAmtEl.textContent = formatCurrency(aggressive);
      const calcAggTermEl = document.getElementById('calcOfferAggressiveTerm');
      if (calcAggTermEl) calcAggTermEl.textContent = aggTermMonths + ' months';
      const calcAggPmtEl = document.getElementById('calcOfferAggressivePmt');
      if (calcAggPmtEl) calcAggPmtEl.textContent = formatCurrency(aggDaily) + '/day';
      const calcAggFactorEl = document.getElementById('calcOfferAggressiveFactor');
      if (calcAggFactorEl) calcAggFactorEl.textContent = aggFactor.toFixed(2) + 'x';
      const calcAggPaybackEl = document.getElementById('calcOfferAggressivePayback');
      if (calcAggPaybackEl) calcAggPaybackEl.textContent = formatCurrency(aggPayback);
      const calcAggHoldbackEl = document.getElementById('calcOfferAggressiveHoldback');
      if (calcAggHoldbackEl) calcAggHoldbackEl.textContent = aggHoldback + '%';
      
      // Update Offer Builder tab expanded details
      const offerConsFactorEl = document.getElementById('offerConservativeFactor');
      if (offerConsFactorEl) offerConsFactorEl.textContent = consFactor.toFixed(2) + 'x';
      const offerConsPaybackEl = document.getElementById('offerConservativePayback');
      if (offerConsPaybackEl) offerConsPaybackEl.textContent = formatCurrency(consPayback);
      const offerConsHoldbackEl = document.getElementById('offerConservativeHoldback');
      if (offerConsHoldbackEl) offerConsHoldbackEl.textContent = consHoldback + '%';
      
      const offerRecFactorEl = document.getElementById('offerRecommendedFactor');
      if (offerRecFactorEl) offerRecFactorEl.textContent = tierData.factor.toFixed(2) + 'x';
      const offerRecPaybackEl = document.getElementById('offerRecommendedPayback');
      if (offerRecPaybackEl) offerRecPaybackEl.textContent = formatCurrency(recPayback);
      const offerRecHoldbackEl = document.getElementById('offerRecommendedHoldback');
      if (offerRecHoldbackEl) offerRecHoldbackEl.textContent = recHoldback + '%';
      
      const offerAggFactorEl = document.getElementById('offerAggressiveFactor');
      if (offerAggFactorEl) offerAggFactorEl.textContent = aggFactor.toFixed(2) + 'x';
      const offerAggPaybackEl = document.getElementById('offerAggressivePayback');
      if (offerAggPaybackEl) offerAggPaybackEl.textContent = formatCurrency(aggPayback);
      const offerAggHoldbackEl = document.getElementById('offerAggressiveHoldback');
      if (offerAggHoldbackEl) offerAggHoldbackEl.textContent = aggHoldback + '%';
      
      // Store scenario data for loading into override
      window.offerScenarios = {
        conservative: {
          funding: conservative,
          factor: consFactor,
          term: consTermMonths,
          payback: consPayback,
          daily: consDaily,
          holdback: parseFloat(consHoldback)
        },
        recommended: {
          funding: funding,
          factor: tierData.factor,
          term: tierData.termMonths,
          payback: recPayback,
          daily: data.daily,
          holdback: parseFloat(recHoldback)
        },
        aggressive: {
          funding: aggressive,
          factor: aggFactor,
          term: aggTermMonths,
          payback: aggPayback,
          daily: aggDaily,
          holdback: parseFloat(aggHoldback)
        }
      };
    }

    function applyOffer(type) {
      // Get all offer cards (both tabs)
      const cards = document.querySelectorAll('.offer-card');
      const cardMap = {
        conservative: document.getElementById('offerCardConservative'),
        recommended: document.getElementById('offerCardRecommended'),
        aggressive: document.getElementById('offerCardAggressive')
      };
      const calcCardMap = {
        conservative: document.getElementById('calcOfferCardConservative'),
        recommended: document.getElementById('calcOfferCardRecommended'),
        aggressive: document.getElementById('calcOfferCardAggressive')
      };
      
      const clickedCard = cardMap[type] || calcCardMap[type];
      if (!clickedCard) return;
      
      // Check if clicking the same card - toggle expansion
      const wasSelected = clickedCard.classList.contains('selected');
      
      // Remove selected/expanded from all cards
      cards.forEach(card => {
        card.classList.remove('selected', 'expanded', 'conservative-selected', 'aggressive-selected');
      });
      
      // If clicking new card (or re-clicking to toggle), select and expand it
      if (!wasSelected) {
        // Select both the clicked card and its counterpart in the other tab
        [cardMap[type], calcCardMap[type]].forEach(card => {
          if (card) {
            card.classList.add('selected', 'expanded');
            if (type === 'conservative') {
              card.classList.add('conservative-selected');
            } else if (type === 'aggressive') {
              card.classList.add('aggressive-selected');
            }
          }
        });
        
        // Store selected offer type
        window.selectedOfferType = type;
        
        logAudit(`Selected ${type} offer scenario`);
        showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} offer selected - Click "Load into Offer Builder" to apply`);
      } else {
        // Deselected
        window.selectedOfferType = null;
      }
    }
    
    // Store offer scenario data for loading
    window.offerScenarios = {};
    
    function loadOfferToOverride(type) {
      if (!window.offerScenarios || !window.offerScenarios[type]) {
        showNotification('Offer data not available. Please recalculate.', 'error');
        return;
      }
      
      const offer = window.offerScenarios[type];
      
      // Update override sliders
      const overrideFunding = document.getElementById('overrideFunding');
      const overrideFactor = document.getElementById('overrideFactor');
      const overrideTerm = document.getElementById('overrideTerm');
      
      if (overrideFunding) {
        overrideFunding.value = offer.funding;
        overrideFunding.dispatchEvent(new Event('input', { bubbles: true }));
      }
      if (overrideFactor) {
        overrideFactor.value = offer.factor;
        overrideFactor.dispatchEvent(new Event('input', { bubbles: true }));
      }
      if (overrideTerm) {
        overrideTerm.value = offer.term;
        overrideTerm.dispatchEvent(new Event('input', { bubbles: true }));
      }
      
      // Switch to override tab
      switchTab('override');
      
      // Recalculate override
      calculateOverride();
      
      logAudit(`Loaded ${type} offer into Offer Builder: $${offer.funding.toLocaleString()} @ ${offer.factor.toFixed(2)}x for ${offer.term} months`);
      showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} offer loaded into Offer Builder`);
    }
    
    function applyOfferToOverride(type) {
      if (!window.offerScenarios || !window.offerScenarios[type]) {
        showNotification('Offer data not available. Please recalculate.', 'error');
        return;
      }
      
      const offer = window.offerScenarios[type];
      
      // Update override sliders
      const overrideFunding = document.getElementById('overrideFunding');
      const overrideFactor = document.getElementById('overrideFactor');
      const overrideTerm = document.getElementById('overrideTerm');
      
      if (overrideFunding) {
        overrideFunding.value = offer.funding;
        overrideFunding.dispatchEvent(new Event('input', { bubbles: true }));
      }
      if (overrideFactor) {
        overrideFactor.value = offer.factor;
        overrideFactor.dispatchEvent(new Event('input', { bubbles: true }));
      }
      if (overrideTerm) {
        overrideTerm.value = offer.term;
        overrideTerm.dispatchEvent(new Event('input', { bubbles: true }));
      }
      
      // Switch to Override sub-tab within Offer Builder
      const overrideTab = document.querySelector('[data-offer-tab="override"]');
      if (overrideTab) overrideTab.click();
      
      // Recalculate override
      calculateOverride();
      
      logAudit(`Applied ${type} offer to Override: $${offer.funding.toLocaleString()} @ ${offer.factor.toFixed(2)}x for ${offer.term} months`);
      showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} offer applied to Override`);
    }

    function updateBenchmarks(score, funding) {
      // Funding benchmark
      const avgFunding = 45000;
      const fundingPercent = Math.min(100, (funding / 150000) * 100);
      const benchFundingFillEl = document.getElementById('benchFundingFill');
      const benchFundingValueEl = document.getElementById('benchFundingValue');
      if (benchFundingFillEl) benchFundingFillEl.style.width = fundingPercent + '%';
      if (benchFundingValueEl) benchFundingValueEl.textContent = 'Your: ' + formatCurrency(funding);
      
      // Score benchmark
      const avgScore = 55;
      const scorePercent = score;
      const benchScoreFillEl = document.getElementById('benchScoreFill');
      const benchScoreValueEl = document.getElementById('benchScoreValue');
      if (benchScoreFillEl) benchScoreFillEl.style.width = scorePercent + '%';
      if (benchScoreValueEl) benchScoreValueEl.textContent = 'Your: ' + score;
    }

    function updateStackingAnalysis() {
      if (!window.calcOffer) return;
      
      const data = window.calcOffer;
      const funding = data.funding || 0;
      const payback = data.payback || 0;
      const daily = data.daily || 0;
      const revenue = data.revenue || 50000;
      const term = data.term || 6;
      
      // Update your position
      const stackYourBalanceEl = document.getElementById('stackYourBalance');
      const stackYourDailyEl = document.getElementById('stackYourDaily');
      const stackYourPayoffEl = document.getElementById('stackYourPayoff');
      
      if (stackYourBalanceEl) stackYourBalanceEl.textContent = formatCurrency(payback);
      if (stackYourDailyEl) stackYourDailyEl.textContent = formatCurrency(daily);
      
      const payoffDate = new Date();
      payoffDate.setMonth(payoffDate.getMonth() + term);
      if (stackYourPayoffEl) stackYourPayoffEl.textContent = payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      
      // Calculate totals including any additional positions
      let totalDaily = daily;
      debtPositions.forEach(pos => {
        totalDaily += pos.daily;
      });
      
      const stackTotalDailyEl = document.getElementById('stackTotalDaily');
      if (stackTotalDailyEl) stackTotalDailyEl.textContent = formatCurrency(totalDaily);
      
      const dailyRevenue = revenue / 22;
      const burden = (totalDaily / dailyRevenue * 100);
      const stackBurdenEl = document.getElementById('stackBurden');
      if (stackBurdenEl) {
        stackBurdenEl.textContent = burden.toFixed(1) + '%';
        stackBurdenEl.style.color = burden > 25 ? '#ef4444' : burden > 15 ? '#f97316' : '#22c55e';
      }
      
      let stackRisk = 'Low';
      let stackRiskColor = '#22c55e';
      if (burden > 30) { stackRisk = 'Critical'; stackRiskColor = '#ef4444'; }
      else if (burden > 25) { stackRisk = 'High'; stackRiskColor = '#ef4444'; }
      else if (burden > 18) { stackRisk = 'Elevated'; stackRiskColor = '#f97316'; }
      else if (burden > 12) { stackRisk = 'Moderate'; stackRiskColor = '#eab308'; }
      
      const stackRiskEl = document.getElementById('stackRisk');
      if (stackRiskEl) {
        stackRiskEl.textContent = stackRisk;
        stackRiskEl.style.color = stackRiskColor;
      }
    }

    function addDebtPosition() {
      const funder = prompt('Enter funder name:');
      if (!funder) return;
      
      const balance = parseFloat(prompt('Enter remaining balance:', '10000'));
      const daily = parseFloat(prompt('Enter daily payment:', '500'));
      
      if (isNaN(balance) || isNaN(daily)) {
        showNotification('Invalid values', 'error');
        return;
      }
      
      const position = {
        id: Date.now(),
        funder: funder,
        balance: balance,
        daily: daily,
        position: debtPositions.length + 2 // +2 because position 1 is "Your Offer"
      };
      
      debtPositions.push(position);
      renderStackingTable();
      updateStackingAnalysis();
      logAudit(`Added debt position: ${funder} - ${formatCurrency(balance)}`);
    }

    function renderStackingTable() {
      const tbody = document.getElementById('stackingTableBody');
      if (!tbody) return;
      
      const yourOfferRow = `
        <tr>
          <td><span class="position-badge position-1st">1st</span></td>
          <td>Your Offer</td>
          <td id="stackYourBalance">$0</td>
          <td id="stackYourDaily">$0</td>
          <td id="stackYourPayoff">--</td>
          <td style="color: var(--accent);">Pending</td>
        </tr>
      `;
      
      const positionRows = debtPositions.map((pos, i) => {
        const posClass = pos.position === 2 ? 'position-2nd' : pos.position === 3 ? 'position-3rd' : 'position-4th';
        const daysRemaining = Math.ceil(pos.balance / pos.daily);
        const payoffDate = new Date();
        payoffDate.setDate(payoffDate.getDate() + daysRemaining);
        
        return `
          <tr>
            <td><span class="position-badge ${posClass}">${pos.position}${pos.position === 2 ? 'nd' : pos.position === 3 ? 'rd' : 'th'}</span></td>
            <td>${pos.funder}</td>
            <td>${formatCurrency(pos.balance)}</td>
            <td>${formatCurrency(pos.daily)}</td>
            <td>${payoffDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
            <td><button onclick="removeDebtPosition(${pos.id})" style="color: #ef4444; background: none; border: none; cursor: pointer;">Remove</button></td>
          </tr>
        `;
      }).join('');
      
      tbody.innerHTML = yourOfferRow + positionRows;
      updateStackingAnalysis();
    }

    function removeDebtPosition(id) {
      debtPositions = debtPositions.filter(p => p.id !== id);
      // Recalculate positions
      debtPositions.forEach((p, i) => p.position = i + 2);
      renderStackingTable();
    }

    // Reports
    function updateReportPreview() {
      if (!window.calcOffer) {
        calculate(); // Ensure we have data
      }
      
      const data = window.calcOffer;
      if (!data) return;
      
      const now = new Date();
      const reportDateEl = document.getElementById('reportDate');
      const reportDealIdEl = document.getElementById('reportDealId');
      
      if (reportDateEl) {
        reportDateEl.textContent = now.toLocaleDateString('en-US', { 
          year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }
      if (reportDealIdEl) {
        reportDealIdEl.textContent = 'PRO-' + Date.now().toString(36).toUpperCase();
      }
      
      // Pull values from calcOffer
      const reportScoreEl = document.getElementById('reportScore');
      const reportFundingEl = document.getElementById('reportFunding');
      const reportTermEl = document.getElementById('reportTerm');
      const reportFactorEl = document.getElementById('reportFactor');
      
      if (reportScoreEl) reportScoreEl.textContent = data.score || '--';
      if (reportFundingEl) reportFundingEl.textContent = formatCurrency(data.funding) || '--';
      if (reportTermEl) reportTermEl.textContent = data.term + ' mo' || '--';
      if (reportFactorEl) reportFactorEl.textContent = data.factor?.toFixed(2) + 'x' || '--';
      
      const tier = data.tier || '--';
      const isDecline = tier === 'DECLINE' || data.isProhibited || data.isTruckingDecline;
      const decision = isDecline ? 'DECLINED - Does not meet minimum criteria' : `APPROVED - ${tier} Tier Qualification`;
      const decisionEl = document.getElementById('reportDecision');
      if (decisionEl) {
        decisionEl.textContent = decision;
        decisionEl.style.background = isDecline ? '#fef2f2' : '#f0fdf4';
        decisionEl.style.borderLeftColor = isDecline ? '#ef4444' : '#22c55e';
      }
      
      const reportRevenueEl = document.getElementById('reportRevenue');
      const reportCreditScoreEl = document.getElementById('reportCreditScore');
      const reportTIBEl = document.getElementById('reportTIB');
      const reportADBEl = document.getElementById('reportADB');
      const reportNSFEl = document.getElementById('reportNSF');
      const reportNegDaysEl = document.getElementById('reportNegDays');
      
      if (reportRevenueEl) reportRevenueEl.textContent = formatCurrency(data.revenue);
      if (reportCreditScoreEl) reportCreditScoreEl.textContent = data.credit || '--';
      if (reportTIBEl) reportTIBEl.textContent = (data.tib || 0) + ' months';
      if (reportADBEl) reportADBEl.textContent = formatCurrency(data.balance);
      if (reportNSFEl) reportNSFEl.textContent = data.nsf || 0;
      if (reportNegDaysEl) reportNegDaysEl.textContent = data.negDays || 0;
      
      const reportPaybackEl = document.getElementById('reportPayback');
      const reportDailyPmtEl = document.getElementById('reportDailyPmt');
      const reportWeeklyPmtEl = document.getElementById('reportWeeklyPmt');
      
      if (reportPaybackEl) reportPaybackEl.textContent = formatCurrency(data.payback);
      if (reportDailyPmtEl) reportDailyPmtEl.textContent = formatCurrency(data.daily) + '/day';
      
      // Calculate weekly from daily
      const weeklyPayment = data.daily * 5;
      if (reportWeeklyPmtEl) reportWeeklyPmtEl.textContent = formatCurrency(weeklyPayment) + '/week';
    }

    function exportPDF() {
      updateReportPreview();
      
      // Create printable version
      const reportContent = document.getElementById('reportPreview').innerHTML;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>ABLESAI PRO - Underwriting Report</title>
          <style>
            body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 40px; }
            .report-preview { max-width: 800px; margin: 0 auto; }
            .report-header { border-bottom: 3px solid #eab308; padding-bottom: 20px; margin-bottom: 30px; }
            .report-logo { font-size: var(--text-4xl); font-weight: 800; }
            .report-title { font-size: var(--text-5xl); font-weight: 700; margin-top: 20px; }
            .report-section { margin-bottom: 30px; }
            .report-section-title { font-size: var(--text-lg); font-weight: 700; text-transform: uppercase; color: #666; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 16px; }
            .grid { display: grid; }
            .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
            .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .gap-4 { gap: 16px; }
            .gap-x-8 { column-gap: 32px; }
            .gap-y-2 { row-gap: 8px; }
            .text-center { text-align: center; }
            .flex { display: flex; }
            .justify-between { justify-content: space-between; }
            .py-2 { padding: 8px 0; }
            @media print { body { margin: 20px; } }
          </style>
        </head>
        <body>
          <div class="report-preview">${reportContent}</div>
          <scr` + `ipt>window.onload = function() { window.print(); }<\/scr` + `ipt>
        </body>
        </html>
      `);
      printWindow.document.close();
      
      logAudit('Exported PDF report');
      showNotification('PDF report generated');
    }

    function exportCSV() {
      if (!window.calcOffer) calculate();
      const d = window.calcOffer || {};
      
      const data = {
        'Deal ID': 'PRO-' + Date.now().toString(36).toUpperCase(),
        'Date': new Date().toISOString(),
        'Credit Score': d.credit || '',
        'Monthly Revenue': d.revenue || '',
        'Avg Daily Balance': d.balance || '',
        'Time in Business': d.tib || '',
        'NSF Count': d.nsf || '',
        'Negative Days': d.negDays || '',
        'Existing Debt': d.existingDebtRaw || '',
        'ABLESCORE': d.score || '',
        'Tier': d.tier || '',
        'Funding Amount': d.funding || '',
        'Payback Amount': d.payback || '',
        'Factor Rate': d.factor || '',
        'Term Months': d.term || '',
        'Daily Payment': d.daily || '',
        'Weekly Payment': (d.daily || 0) * 5
      };
      
      const csv = Object.keys(data).join(',') + '\n' + Object.values(data).map(v => `"${v}"`).join(',');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ABLESAI_PRO_Deal_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      logAudit('Exported CSV data');
      showNotification('CSV data exported');
    }

    function copyToClipboard() {
      if (!window.calcOffer) calculate();
      const d = window.calcOffer || {};
      
      const summary = `ABLESAI PRO Deal Summary
========================
ABLESCORE: ${d.score || '--'}
Tier: ${d.tier || '--'}
Funding: ${formatCurrency(d.funding)}
Payback: ${formatCurrency(d.payback)}
Factor: ${d.factor?.toFixed(2) || '--'}x
Term: ${d.term || '--'} mo
Daily: ${formatCurrency(d.daily)}
Weekly: ${formatCurrency((d.daily || 0) * 5)}

Merchant Profile:
- Revenue: ${formatCurrency(d.revenue)}
- Credit: ${d.credit || '--'}
- TIB: ${d.tib || '--'} months
- ADB: ${formatCurrency(d.balance)}
- NSF: ${d.nsf || 0}
- Neg Days: ${d.negDays || 0}

Generated by ABLESAI PRO | ${new Date().toLocaleString()}`;
      
      navigator.clipboard.writeText(summary).then(() => {
        showNotification('Copied to clipboard');
        logAudit('Copied deal summary to clipboard');
      });
    }

    function clearNotes() {
      if (document.getElementById('dealNotes')) {
        document.getElementById('dealNotes').value = '';
        showNotification('Notes cleared');
      }
    }

    // Audit Trail
    function logAudit(action) {
      const entry = {
        time: new Date(),
        action: action
      };
      auditLog.unshift(entry);
      
      // Keep only last 50 entries
      if (auditLog.length > 50) auditLog.pop();
      
      renderAuditTrail();
    }

    function renderAuditTrail() {
      const container = document.getElementById('auditTrail');
      if (!container) return;
      
      if (auditLog.length === 0) {
        container.innerHTML = `
          <div class="audit-entry">
            <div class="audit-time">--:--</div>
            <div class="audit-action" style="color: var(--text-muted);">No actions recorded yet</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = auditLog.map(entry => `
        <div class="audit-entry">
          <div class="audit-time">${entry.time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</div>
          <div class="audit-action">${entry.action}</div>
        </div>
      `).join('');
    }

    // Notifications
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 20px;
        background: ${type === 'success' ? 'var(--accent)' : type === 'error' ? '#ef4444' : '#f97316'};
        color: ${type === 'success' ? '#000' : '#fff'};
        border-radius: 8px;
        font-size: var(--text-md);
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Add CSS animations for notifications
    const notifStyles = document.createElement('style');
    notifStyles.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(notifStyles);

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+S = Save
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveDeal();
      }
      // Ctrl+O = Load
      if (e.ctrlKey && e.key === 'o') {
        e.preventDefault();
        loadDeal();
      }
      // Ctrl+D = Add to Compare
      if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        addToCompare();
      }
      // Ctrl+P = Export PDF
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        exportPDF();
      }
      // R = Recalculate
      if (e.key === 'r' && !e.ctrlKey && !e.target.matches('input, textarea')) {
        calculate();
        showNotification('Recalculated');
      }
      // 1-6 = Switch tabs
      if (['1','2','3','4','5','6'].includes(e.key) && !e.target.matches('input, textarea')) {
        const tabs = ['model', 'calculator', 'override', 'analytics', 'compare', 'reports'];
        const tabIndex = parseInt(e.key) - 1;
        if (tabs[tabIndex]) {
          document.querySelector(`[onclick*="switchTab('${tabs[tabIndex]}'"]`)?.click();
        }
      }
      // Escape = Close modal or exit focus mode
      if (e.key === 'Escape') {
        closeSliderModal();
        document.body.classList.remove('focus-mode');
      }
      // F = Focus mode
      if (e.key === 'f' && !e.target.matches('input, textarea')) {
        document.body.classList.toggle('focus-mode');
        showNotification(document.body.classList.contains('focus-mode') ? 'Focus mode ON' : 'Focus mode OFF');
      }
    });

    // Analytics Section Toggle Functions
    function toggleAnalyticsSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        section.classList.toggle('expanded');
      }
    }
    
    function expandAllAnalytics() {
      document.querySelectorAll('.analytics-section').forEach(section => {
        section.classList.add('expanded');
      });
      showNotification('All sections expanded');
    }
    
    function collapseAllAnalytics() {
      document.querySelectorAll('.analytics-section').forEach(section => {
        section.classList.remove('expanded');
      });
      showNotification('All sections collapsed');
    }
    
    function refreshAnalytics() {
      calculate();
      updateAnalyticsPROComplete();
      showNotification('Analytics refreshed');
    }
    
    function addStackPosition() {
      showNotification('Stack position modal - coming soon');
    }
    
    // Complete Analytics PRO Update Function
    function updateAnalyticsPROComplete() {
      if (!window.calcOffer) return;
      const data = window.calcOffer;
      const score = data.score || 62;
      const tier = data.tier || 'C';
      const funding = data.funding || 50000;
      const payback = data.payback || 65000;
      const term = data.term || 6;
      const revenue = data.revenue || 50000;
      const creditScore = data.credit || 650;
      const tib = data.tib || 24;
      const nsf = data.nsf || 2;
      const negDays = data.negDays || 5;
      const avgBalance = data.balance || 15000;
      
      // Update main metrics
      const el = id => document.getElementById(id);
      if (el('analyticsScoreMain')) el('analyticsScoreMain').textContent = score;
      if (el('analyticsScoreTier')) el('analyticsScoreTier').textContent = 'Tier ' + tier;
      
      // Calculate PD based on tier
      const pdMap = { 'A': 3, 'B': 6, 'C': 10, 'D': 18, 'E': 28 };
      let basePD = pdMap[tier] || 15;
      let pd = Math.max(1, Math.min(40, basePD + (100 - score) * 0.15));
      
      // LGD and EL calculations
      const lgd = Math.max(30, Math.min(70, 65 - score * 0.35));
      const el_pct = (pd / 100) * (lgd / 100) * 100;
      const dollarEL = funding * (el_pct / 100);
      
      // DSCR calculation
      const monthlyPayment = payback / term;
      const existingDebt = parseFloat(document.getElementById('existingDebt')?.value) || 0;
      const totalDebt = monthlyPayment + existingDebt;
      const dscr = revenue / totalDebt;
      const buffer = revenue - totalDebt;
      
      // ROI calculation
      const profit = payback - funding;
      const roi = (profit / funding) * 100;
      
      // Update key metrics
      if (el('analyticsMainPD')) {
        el('analyticsMainPD').textContent = pd.toFixed(1) + '%';
        el('analyticsMainPD').style.color = pd < 5 ? '#10b981' : pd < 10 ? '#eab308' : pd < 20 ? '#f97316' : '#ef4444';
      }
      if (el('analyticsMainLGD')) el('analyticsMainLGD').textContent = lgd.toFixed(0) + '%';
      if (el('analyticsMainEL')) el('analyticsMainEL').textContent = el_pct.toFixed(1) + '%';
      if (el('analyticsMainDSCR')) {
        el('analyticsMainDSCR').textContent = dscr.toFixed(2) + 'x';
        el('analyticsMainDSCR').style.color = dscr >= 1.5 ? '#10b981' : dscr >= 1.25 ? '#eab308' : dscr >= 1 ? '#f97316' : '#ef4444';
      }
      if (el('analyticsMainROI')) el('analyticsMainROI').textContent = roi.toFixed(1) + '%';
      
      // Update PD gauge
      if (el('analyticsPdGaugeValue')) el('analyticsPdGaugeValue').textContent = pd.toFixed(1) + '%';
      if (el('analyticsPdArc')) {
        const dashOffset = 157 - (157 * (pd / 40));
        el('analyticsPdArc').style.strokeDashoffset = dashOffset;
      }
      
      // Update Loss metrics
      if (el('analyticsLGDValue')) el('analyticsLGDValue').textContent = lgd.toFixed(0) + '%';
      if (el('analyticsLGDBar')) el('analyticsLGDBar').style.width = lgd + '%';
      if (el('analyticsELValue')) el('analyticsELValue').textContent = el_pct.toFixed(1) + '%';
      if (el('analyticsELBar')) el('analyticsELBar').style.width = (el_pct * 2.5) + '%';
      if (el('analyticsEADValue')) el('analyticsEADValue').textContent = '$' + funding.toLocaleString();
      if (el('analyticsDollarEL')) el('analyticsDollarEL').textContent = '$' + Math.round(dollarEL).toLocaleString();
      
      // Update DSCR section
      if (el('analyticsDSCRMain')) el('analyticsDSCRMain').textContent = dscr.toFixed(2) + 'x';
      if (el('analyticsDSCRRevenue')) el('analyticsDSCRRevenue').textContent = '$' + revenue.toLocaleString();
      if (el('analyticsDSCRDebt')) el('analyticsDSCRDebt').textContent = '$' + Math.round(totalDebt).toLocaleString();
      if (el('analyticsDSCRBuffer')) el('analyticsDSCRBuffer').textContent = '$' + Math.round(buffer).toLocaleString();
      
      const debtPct = Math.min(100, (totalDebt / revenue) * 100);
      if (el('analyticsDSCRDebtBar')) el('analyticsDSCRDebtBar').style.width = debtPct + '%';
      if (el('analyticsDSCRBufferBar')) el('analyticsDSCRBufferBar').style.width = (100 - debtPct) + '%';
      
      // Update Score Component bars
      const creditPct = Math.min(100, (creditScore - 300) / 5.5);
      const behaviorPct = Math.max(0, 100 - (nsf * 15) - (negDays * 3));
      const revenuePct = Math.min(100, (revenue / 1000));
      const stabilityPct = Math.min(100, tib * 4);
      const bufferPct = Math.min(100, (avgBalance / revenue) * 200);
      
      if (el('analyticsCreditBar')) el('analyticsCreditBar').style.width = creditPct + '%';
      if (el('analyticsCreditPts')) el('analyticsCreditPts').textContent = Math.round(creditPct * 0.2) + '/20';
      if (el('analyticsBehaviorBar')) el('analyticsBehaviorBar').style.width = behaviorPct + '%';
      if (el('analyticsBehaviorPts')) el('analyticsBehaviorPts').textContent = Math.round(behaviorPct * 0.15) + '/15';
      if (el('analyticsRevenueBar')) el('analyticsRevenueBar').style.width = revenuePct + '%';
      if (el('analyticsRevenuePts')) el('analyticsRevenuePts').textContent = Math.round(revenuePct * 0.3) + '/30';
      if (el('analyticsStabilityBar')) el('analyticsStabilityBar').style.width = stabilityPct + '%';
      if (el('analyticsStabilityPts')) el('analyticsStabilityPts').textContent = Math.round(stabilityPct * 0.2) + '/20';
      if (el('analyticsBufferBar')) el('analyticsBufferBar').style.width = bufferPct + '%';
      if (el('analyticsBufferPts')) el('analyticsBufferPts').textContent = Math.round(bufferPct * 0.15) + '/15';
      
      // Update Cash Flow table
      updateCashFlowTable(revenue, payback, term, funding);
      
      // Update Scenarios
      updateScenarioTable(funding, score, pd, roi);
      
      // Update Benchmarks
      updateBenchmarkCards(funding, score, pd);
      
      // Update Stacking
      updateStackingMetrics(funding, payback, term, revenue);
      
      // Update Risk Matrix position
      updateRiskMatrixPosition(pd, lgd);
      
      // Update Risk Factors
      updateRiskFactors(creditScore, nsf, revenue, tib, avgBalance);
    }
    
    function updateCashFlowTable(revenue, payback, term, funding) {
      const tbody = document.getElementById('cashFlowTableBody');
      if (!tbody) return;
      
      const monthlyPayment = payback / term;
      let balance = payback;
      let html = '';
      
      for (let m = 1; m <= term; m++) {
        const payment = m === term ? balance : monthlyPayment;
        balance = Math.max(0, balance - payment);
        const netCF = revenue - payment;
        
        html += '<tr style="border-bottom: 1px solid var(--border-subtle);">' +
          '<td class="p-2">Month ' + m + '</td>' +
          '<td class="p-2 text-right" style="color: #10b981;">$' + revenue.toLocaleString() + '</td>' +
          '<td class="p-2 text-right" style="color: #ef4444;">$' + Math.round(payment).toLocaleString() + '</td>' +
          '<td class="p-2 text-right">$' + Math.round(balance).toLocaleString() + '</td>' +
          '<td class="p-2 text-right" style="color: ' + (netCF >= 0 ? '#10b981' : '#ef4444') + ';">$' + Math.round(netCF).toLocaleString() + '</td>' +
          '</tr>';
      }
      tbody.innerHTML = html;
      
      const totalRev = revenue * term;
      const el = id => document.getElementById(id);
      if (el('analyticsTotalRevenue')) el('analyticsTotalRevenue').textContent = '$' + totalRev.toLocaleString();
      if (el('analyticsTotalPayments')) el('analyticsTotalPayments').textContent = '$' + Math.round(payback).toLocaleString();
      if (el('analyticsNetCashFlow')) el('analyticsNetCashFlow').textContent = '$' + Math.round(totalRev - payback).toLocaleString();
    }
    
    function updateScenarioTable(funding, score, pd, roi) {
      const el = id => document.getElementById(id);
      
      // Stress case
      if (el('scenarioStressFunding')) el('scenarioStressFunding').textContent = '$' + Math.round(funding * 0.7).toLocaleString();
      if (el('scenarioStressScore')) el('scenarioStressScore').textContent = Math.round(score * 0.77);
      if (el('scenarioStressPD')) el('scenarioStressPD').textContent = (pd * 2.25).toFixed(1) + '%';
      if (el('scenarioStressROI')) el('scenarioStressROI').textContent = (roi * 0.58).toFixed(1) + '%';
      
      // Conservative
      if (el('scenarioConservativeFunding')) el('scenarioConservativeFunding').textContent = '$' + Math.round(funding * 0.8).toLocaleString();
      if (el('scenarioConservativeScore')) el('scenarioConservativeScore').textContent = Math.round(score * 0.89);
      if (el('scenarioConservativePD')) el('scenarioConservativePD').textContent = (pd * 1.5).toFixed(1) + '%';
      if (el('scenarioConservativeROI')) el('scenarioConservativeROI').textContent = (roi * 0.82).toFixed(1) + '%';
      
      // Base case (current)
      if (el('scenarioBaseFunding')) el('scenarioBaseFunding').textContent = '$' + funding.toLocaleString();
      if (el('scenarioBaseScore')) el('scenarioBaseScore').textContent = score;
      if (el('scenarioBasePD')) el('scenarioBasePD').textContent = pd.toFixed(1) + '%';
      if (el('scenarioBaseROI')) el('scenarioBaseROI').textContent = roi.toFixed(1) + '%';
      
      // Optimistic
      if (el('scenarioOptimisticFunding')) el('scenarioOptimisticFunding').textContent = '$' + Math.round(funding * 1.2).toLocaleString();
      if (el('scenarioOptimisticScore')) el('scenarioOptimisticScore').textContent = Math.round(score * 1.1);
      if (el('scenarioOptimisticPD')) el('scenarioOptimisticPD').textContent = (pd * 0.7).toFixed(1) + '%';
      if (el('scenarioOptimisticROI')) el('scenarioOptimisticROI').textContent = (roi * 1.12).toFixed(1) + '%';
      
      // Best case
      if (el('scenarioBestFunding')) el('scenarioBestFunding').textContent = '$' + Math.round(funding * 1.5).toLocaleString();
      if (el('scenarioBestScore')) el('scenarioBestScore').textContent = Math.round(Math.min(100, score * 1.2));
      if (el('scenarioBestPD')) el('scenarioBestPD').textContent = (pd * 0.43).toFixed(1) + '%';
      if (el('scenarioBestROI')) el('scenarioBestROI').textContent = (roi * 1.27).toFixed(1) + '%';
    }
    
    function updateBenchmarkCards(funding, score, pd) {
      const el = id => document.getElementById(id);
      const avgFunding = 45000;
      const avgScore = 55;
      const avgDefault = 12;
      
      const fundingPct = ((funding - avgFunding) / avgFunding) * 100;
      const scorePct = ((score - avgScore) / avgScore) * 100;
      const defaultPct = ((avgDefault - pd) / avgDefault) * 100;
      const approvalLikelihood = Math.min(95, Math.max(20, score + 15));
      
      if (el('benchmarkFundingValue')) el('benchmarkFundingValue').textContent = '$' + funding.toLocaleString();
      if (el('benchmarkFundingBar')) el('benchmarkFundingBar').style.width = Math.min(100, (funding / 90000) * 100) + '%';
      if (el('benchmarkFundingPct')) {
        el('benchmarkFundingPct').textContent = (fundingPct >= 0 ? '+' : '') + fundingPct.toFixed(0) + '% ' + (fundingPct >= 0 ? 'above' : 'below') + ' avg';
        el('benchmarkFundingPct').style.color = fundingPct >= 0 ? '#10b981' : '#ef4444';
      }
      
      if (el('benchmarkScoreValue')) el('benchmarkScoreValue').textContent = score;
      if (el('benchmarkScoreBar')) el('benchmarkScoreBar').style.width = score + '%';
      if (el('benchmarkScorePct')) {
        el('benchmarkScorePct').textContent = (scorePct >= 0 ? '+' : '') + scorePct.toFixed(0) + '% ' + (scorePct >= 0 ? 'above' : 'below') + ' avg';
        el('benchmarkScorePct').style.color = scorePct >= 0 ? '#10b981' : '#ef4444';
      }
      
      if (el('benchmarkDefaultValue')) el('benchmarkDefaultValue').textContent = pd.toFixed(1) + '%';
      if (el('benchmarkDefaultBar')) el('benchmarkDefaultBar').style.width = (pd / 40) * 100 + '%';
      if (el('benchmarkDefaultPct')) {
        el('benchmarkDefaultPct').textContent = (defaultPct >= 0 ? '-' : '+') + Math.abs(defaultPct).toFixed(0) + '% ' + (defaultPct >= 0 ? 'below' : 'above') + ' avg';
        el('benchmarkDefaultPct').style.color = defaultPct >= 0 ? '#10b981' : '#ef4444';
      }
      
      if (el('benchmarkApprovalValue')) el('benchmarkApprovalValue').textContent = approvalLikelihood.toFixed(0) + '%';
      if (el('benchmarkApprovalBar')) el('benchmarkApprovalBar').style.width = approvalLikelihood + '%';
    }
    
    function updateStackingMetrics(funding, payback, term, revenue) {
      const el = id => document.getElementById(id);
      const dailyPayment = payback / (term * 21);
      const burden = (dailyPayment * 21 / revenue) * 100;
      const avgPayoff = term * 21;
      const capacity = Math.max(0, (revenue * 0.25 * term) - payback);
      
      if (el('stackOriginal')) el('stackOriginal').textContent = '$' + funding.toLocaleString();
      if (el('stackBalance')) el('stackBalance').textContent = '$' + Math.round(payback).toLocaleString();
      if (el('stackDaily')) el('stackDaily').textContent = '$' + Math.round(dailyPayment).toLocaleString();
      if (el('stackPayoff')) el('stackPayoff').textContent = term + ' months';
      
      if (el('stackTotalDailyMetric')) el('stackTotalDailyMetric').textContent = '$' + Math.round(dailyPayment).toLocaleString();
      if (el('stackDailyBar')) el('stackDailyBar').style.width = Math.min(100, burden * 2) + '%';
      
      if (el('stackBurdenMetric')) {
        el('stackBurdenMetric').textContent = burden.toFixed(1) + '%';
        el('stackBurdenMetric').style.color = burden < 20 ? '#10b981' : burden < 30 ? '#eab308' : '#ef4444';
      }
      if (el('stackBurdenBar')) {
        el('stackBurdenBar').style.width = Math.min(100, burden) + '%';
        el('stackBurdenBar').style.background = burden < 20 ? '#10b981' : burden < 30 ? '#eab308' : '#ef4444';
      }
      
      if (el('stackTotalOutstanding')) el('stackTotalOutstanding').textContent = '$' + Math.round(payback).toLocaleString();
      if (el('stackAvgPayoff')) el('stackAvgPayoff').textContent = avgPayoff + ' days';
      if (el('stackCapacity')) el('stackCapacity').textContent = '$' + Math.round(capacity).toLocaleString();
      
      // Update stacking risk badge
      const riskBadge = el('stackingRiskBadge');
      if (riskBadge) {
        if (burden < 20) {
          riskBadge.textContent = 'LOW STACK RISK';
          riskBadge.style.background = 'rgba(16,185,129,0.2)';
          riskBadge.style.color = '#10b981';
        } else if (burden < 30) {
          riskBadge.textContent = 'MEDIUM STACK RISK';
          riskBadge.style.background = 'rgba(234,179,8,0.2)';
          riskBadge.style.color = '#eab308';
        } else {
          riskBadge.textContent = 'HIGH STACK RISK';
          riskBadge.style.background = 'rgba(239,68,68,0.2)';
          riskBadge.style.color = '#ef4444';
        }
      }
    }
    
    function updateRiskMatrixPosition(pd, lgd) {
      const dot = document.getElementById('riskMatrixDot');
      if (!dot) return;
      
      // Map PD (0-40) to x position (50-210)
      const x = 50 + (pd / 40) * 160;
      // Map LGD (30-70) to y position (118-10) - inverted because SVG y is top-down
      const y = 118 - ((lgd - 30) / 40) * 108;
      
      dot.setAttribute('cx', x);
      dot.setAttribute('cy', Math.max(10, Math.min(145, y)));
      
      // Update matrix badge
      const badge = document.getElementById('riskMatrixBadge');
      if (badge) {
        let risk = 'LOW';
        let color = '#10b981';
        let bg = 'rgba(16,185,129,0.2)';
        
        if (pd > 20 || lgd > 60) {
          risk = 'HIGH RISK';
          color = '#ef4444';
          bg = 'rgba(239,68,68,0.2)';
        } else if (pd > 10 || lgd > 50) {
          risk = 'MEDIUM RISK';
          color = '#eab308';
          bg = 'rgba(234,179,8,0.2)';
        } else {
          risk = 'LOW RISK';
        }
        
        badge.textContent = risk;
        badge.style.color = color;
        badge.style.background = bg;
      }
    }
    
    function updateRiskFactors(creditScore, nsf, revenue, tib, avgBalance) {
      const el = id => document.getElementById(id);
      
      // Credit Risk
      const creditRisk = creditScore >= 680 ? 'LOW' : creditScore >= 600 ? 'MEDIUM' : creditScore >= 550 ? 'ELEVATED' : 'HIGH';
      updateRiskBadge(el('riskFactorCredit'), creditRisk);
      
      // Liquidity Risk
      const liquidityRisk = avgBalance / revenue >= 0.3 ? 'LOW' : avgBalance / revenue >= 0.15 ? 'MEDIUM' : 'ELEVATED';
      updateRiskBadge(el('riskFactorLiquidity'), liquidityRisk);
      
      // Industry Risk - default medium
      updateRiskBadge(el('riskFactorIndustry'), 'MEDIUM');
      
      // Concentration Risk
      updateRiskBadge(el('riskFactorConcentration'), 'LOW');
      
      // Operational Risk
      const opRisk = nsf > 3 ? 'HIGH' : nsf > 1 ? 'ELEVATED' : nsf > 0 ? 'MEDIUM' : 'LOW';
      updateRiskBadge(el('riskFactorOperational'), opRisk);
      
      // Market Risk
      updateRiskBadge(el('riskFactorMarket'), 'LOW');
    }
    
    function updateRiskBadge(element, level) {
      if (!element) return;
      element.textContent = level;
      
      const colors = {
        'LOW': { bg: 'rgba(16,185,129,0.2)', color: '#10b981' },
        'MEDIUM': { bg: 'rgba(234,179,8,0.2)', color: '#eab308' },
        'ELEVATED': { bg: 'rgba(249,115,22,0.2)', color: '#f97316' },
        'HIGH': { bg: 'rgba(239,68,68,0.2)', color: '#ef4444' }
      };
      
      const c = colors[level] || colors['MEDIUM'];
      element.style.background = c.bg;
      element.style.color = c.color;
    }

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle('light-theme');
      const isLight = document.body.classList.contains('light-theme');
      // Update toggle button icon
      const themeBtn = document.getElementById('themeToggleBtn');
      if (themeBtn) {
        themeBtn.innerHTML = isLight 
          ? '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
          : '<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="18"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
        themeBtn.title = isLight ? 'Switch to Dark Mode' : 'Switch to Light Mode';
      }
      showNotification(isLight ? 'Light theme' : 'Dark theme');
    }

    // Share ISO offer calculator link
    function shareOfferCalculator() {
      const isoLink = 'https://ables.ai/offer-calculator';
      navigator.clipboard.writeText(isoLink).then(() => {
        showNotification('Offer calculator link copied to clipboard');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = isoLink;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showNotification('Offer calculator link copied to clipboard');
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSavedSettings();
      calculate();
      logAudit('Session started');
    });
    
    // Explicitly attach key functions to window for onclick handlers
    window.switchTab = switchTab;
    window.loadPreset = loadPreset;
    window.saveDeal = saveDeal;
    window.loadDeal = loadDeal;
    window.addToCompare = addToCompare;
    window.exportPDF = exportPDF;
    window.clearCompare = clearCompare;
    window.exportCSV = exportCSV;
    window.copyToClipboard = copyToClipboard;
    window.clearNotes = clearNotes;
    window.toggleTheme = toggleTheme;
    
    // ============================================
    // SEND TAB FUNCTIONS
    // ============================================
    function updateSendTab() {
      const el_id = id => document.getElementById(id);
      // Get current values from the calculator
      const credit = parseInt(el_id('creditScore')?.value) || 650;
      const revenue = parseInt(el_id('monthlyRevenue')?.value) || 50000;
      const adb = parseInt(el_id('avgDailyBalance')?.value) || 8000;
      const tib = parseInt(el_id('timeInBusiness')?.value) || 24;
      const nsf = parseInt(el_id('nsfCount')?.value) || 2;
      const negDays = parseInt(el_id('negativeDays')?.value) || 5;
      
      // Get calculated offer values
      const funding = el_id('calcFundingDisplay')?.textContent || '--';
      const factor = el_id('calcFactorDisplay')?.textContent || '--';
      const payback = el_id('calcPaybackDisplay')?.textContent || '--';
      const term = el_id('calcTermDisplay')?.textContent || '--';
      const dailyPmt = el_id('calcDailyDisplay')?.textContent || '--';
      
      // Get score values
      const score = el_id('scoreValue')?.textContent || '--';
      const tierLetter = el_id('tierLetter')?.textContent || '--';
      const tierLabel = el_id('tierLabel')?.textContent || '--';
      
      // Update Merchant Profile
      if (el_id('sendCreditScore')) el_id('sendCreditScore').textContent = credit;
      if (el_id('sendRevenue')) el_id('sendRevenue').textContent = '$' + revenue.toLocaleString();
      if (el_id('sendADB')) el_id('sendADB').textContent = '$' + adb.toLocaleString();
      if (el_id('sendTIB')) el_id('sendTIB').textContent = tib + ' mo';
      if (el_id('sendNSF')) el_id('sendNSF').textContent = nsf;
      if (el_id('sendNegDays')) el_id('sendNegDays').textContent = negDays;
      
      // Update Offer Terms
      if (el_id('sendFunding')) el_id('sendFunding').textContent = funding;
      if (el_id('sendFactor')) el_id('sendFactor').textContent = factor;
      if (el_id('sendPayback')) el_id('sendPayback').textContent = payback;
      if (el_id('sendTerm')) el_id('sendTerm').textContent = term;
      if (el_id('sendDailyPayment')) el_id('sendDailyPayment').textContent = dailyPmt;
      
      // Update ABLESCORE
      if (el_id('sendScore')) el_id('sendScore').textContent = score;
      if (el_id('sendTierLetter')) el_id('sendTierLetter').textContent = tierLetter;
      if (el_id('sendTierBadge')) el_id('sendTierBadge').textContent = tierLabel;
      
      // Risk level
      const scoreNum = parseInt(score) || 0;
      let riskLevel = 'Low Risk';
      if (scoreNum < 50) riskLevel = 'High Risk';
      else if (scoreNum < 65) riskLevel = 'Medium Risk';
      else if (scoreNum < 80) riskLevel = 'Low-Medium Risk';
      if (el_id('sendRiskLevel')) el_id('sendRiskLevel').textContent = riskLevel;
      
      // Update Preview
      if (el_id('sendPreviewFunding')) el_id('sendPreviewFunding').textContent = funding;
      if (el_id('sendPreviewFactor')) el_id('sendPreviewFactor').textContent = factor;
      if (el_id('sendPreviewTerm')) el_id('sendPreviewTerm').textContent = term;
      if (el_id('sendPreviewPayback')) el_id('sendPreviewPayback').textContent = payback;
      if (el_id('sendPreviewDaily')) el_id('sendPreviewDaily').textContent = dailyPmt;
      
      // Update timestamp
      const now = new Date();
      const timestamp = now.toLocaleString('en-US', { 
        month: 'short', day: 'numeric', year: 'numeric', 
        hour: 'numeric', minute: '2-digit', hour12: true 
      });
      if (el_id('sendPackageTime')) el_id('sendPackageTime').textContent = timestamp;
      
      // Generate shareable link
      const dealId = 'ABL-' + Date.now().toString(36).toUpperCase();
      if (el_id('sendShareableLink')) {
        el_id('sendShareableLink').value = 'https://ables.ai/offer/' + dealId;
      }
    }
    
    function copySendLink() {
      const linkInput = document.getElementById('sendShareableLink');
      if (linkInput) {
        linkInput.select();
        document.execCommand('copy');
        
        // Visual feedback
        const btn = linkInput.nextElementSibling;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.style.background = '';
        }, 1500);
      }
    }
    
    function sendViaEmail() {
      const link = document.getElementById('sendShareableLink')?.value || '';
      const funding = document.getElementById('sendFunding')?.textContent || '--';
      const subject = encodeURIComponent('Your Pre-Approved Funding Offer - ' + funding);
      const body = encodeURIComponent('View your personalized funding offer:\n\n' + link);
      window.open('mailto:?subject=' + subject + '&body=' + body);
      logAudit('Offer shared via Email');
    }
    
    function sendViaSMS() {
      const link = document.getElementById('sendShareableLink')?.value || '';
      const funding = document.getElementById('sendFunding')?.textContent || '--';
      const body = encodeURIComponent('Your pre-approved funding offer (' + funding + '): ' + link);
      window.open('sms:?body=' + body);
      logAudit('Offer shared via SMS');
    }
    
    function showQRCode() {
      const link = document.getElementById('sendShareableLink')?.value || '';
      const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(link);
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;';
      modal.innerHTML = `
        <div style="background:var(--bg-card);padding:24px;border-radius:16px;text-align:center;">
          <h3 style="color:var(--text-primary);margin-bottom:16px;font-size:16px;">Scan to View Offer</h3>
          <img src="${qrUrl}" style="border-radius:8px;background:#fff;padding:8px;" />
          <p style="color:var(--text-muted);font-size:12px;margin-top:12px;">${link}</p>
          <button onclick="this.closest('div').parentElement.remove()" style="margin-top:16px;padding:8px 24px;background:var(--accent);color:var(--accent-text);border:none;border-radius:8px;font-weight:600;cursor:pointer;">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
      logAudit('QR Code generated');
    }
    
    function sendToISO() {
      updateSendTab();
      alert('Package ready to send to ISO/Broker.\n\nIn production, this would integrate with your CRM to send the offer package.');
      logAudit('Package sent to ISO/Broker');
    }
    
    function sendToMerchant() {
      updateSendTab();
      alert('Package ready to send to Merchant.\n\nIn production, this would send a client-facing offer to the merchant.');
      logAudit('Package sent to Merchant');
    }
    
    function downloadSendPDF() {
      exportPDF();
      logAudit('Send package PDF downloaded');
    }
    
    // Update SEND tab when switching to it
    const originalSwitchTab = switchTab;
    switchTab = function(tabName, evt) {
      originalSwitchTab(tabName, evt);
      if (tabName === 'send') {
        updateSendTab();
      }
    };
    window.switchTab = switchTab;
    
    // Export SEND functions
    window.updateSendTab = updateSendTab;
    window.copySendLink = copySendLink;
    window.sendViaEmail = sendViaEmail;
    window.sendViaSMS = sendViaSMS;
    window.showQRCode = showQRCode;
    window.sendToISO = sendToISO;
    window.sendToMerchant = sendToMerchant;
    window.downloadSendPDF = downloadSendPDF;
    
    // Analytics Side Navigation
    function scrollToAnalyticsSection(sectionId) {
        const section = document.getElementById('analytics-section-' + sectionId);
        const container = document.getElementById('analyticsMainContent');
        const navItems = document.querySelectorAll('.analytics-sidenav-item');
        
        // Update active state
        navItems.forEach(item => item.classList.remove('active'));
        const clickedItem = document.querySelector(`.analytics-sidenav-item[onclick*="${sectionId}"]`);
        if (clickedItem) clickedItem.classList.add('active');
        
        // Scroll to section
        if (section && container) {
            const offsetTop = section.offsetTop - container.offsetTop - 20;
            container.scrollTo({
                top: offsetTop,
                behavior: 'smooth'
            });
        }
    }
    window.scrollToAnalyticsSection = scrollToAnalyticsSection;
    
    // Update active nav item on scroll
    function updateAnalyticsNavOnScroll() {
        const container = document.getElementById('analyticsMainContent');
        if (!container) return;
        
        const sections = container.querySelectorAll('.analytics-section[id]');
        const navItems = document.querySelectorAll('.analytics-sidenav-item');
        
        let currentSection = '';
        sections.forEach(section => {
            const rect = section.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            if (rect.top <= containerRect.top + 100) {
                currentSection = section.id.replace('analytics-section-', '');
            }
        });
        
        navItems.forEach(item => {
            const onclick = item.getAttribute('onclick') || '';
            if (onclick.includes(currentSection)) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }
    
    // Attach scroll listener when analytics tab is shown
    const analyticsContent = document.getElementById('analyticsMainContent');
    if (analyticsContent) {
        analyticsContent.addEventListener('scroll', updateAnalyticsNavOnScroll);
    }
    
    window.shareOfferCalculator = shareOfferCalculator;
    window.applyOffer = applyOffer;
    window.loadOfferToOverride = loadOfferToOverride;
    window.applyOfferToOverride = applyOfferToOverride;
    window.addDebtPosition = addDebtPosition;
    window.removeDebtPosition = removeDebtPosition;
    // Analytics Sub-tab Switching
    function switchAnalyticsSubtab(tabName) {
      // Remove active from all subtabs and panels
      document.querySelectorAll('.analytics-subtab').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.analytics-subtab-panel').forEach(panel => panel.classList.remove('active'));
      
      // Activate selected subtab and panel
      const btn = document.querySelector(`.analytics-subtab[onclick*="${tabName}"]`);
      const panel = document.getElementById('subtab-' + tabName);
      if (btn) btn.classList.add('active');
      if (panel) panel.classList.add('active');
    }
    
    window.switchAnalyticsSubtab = switchAnalyticsSubtab;

    // Analytics Modal Functions
    function openAnalyticsModal(section) {
      const overlay = document.getElementById('analyticsModalOverlay');
      const title = document.getElementById('analyticsModalTitle');
      const body = document.getElementById('analyticsModalBody');
      
      const titles = {
        score: 'Score Component Analysis',
        risk: 'Risk Metrics & Indicators',
        cashflow: 'Cash Flow Projections',
        matrix: 'Risk Assessment Matrix',
        sensitivity: 'Sensitivity & Scenario Analysis',
        benchmarks: 'Industry Benchmarks',
        stacking: 'Stacking & Debt Position',
        historical: 'Historical Performance',
        payment: 'Payment Schedule Analysis',
        revenue: 'Revenue Quality Metrics',
        pricing: 'Pricing & Profitability',
        compliance: 'Compliance & Documentation'
      };
      
      if (title) title.textContent = titles[section] || 'Analytics Detail';
      if (body) body.innerHTML = getAnalyticsModalContent(section);
      if (overlay) overlay.classList.add('active');
      updateModalData(section);
    }
    
    function closeAnalyticsModal() {
      document.getElementById('analyticsModalOverlay')?.classList.remove('active');
    }
    
    function getAnalyticsModalContent(section) {
      const data = window.calcOffer || {};
      const score = data.score || 62;
      const funding = data.funding || 50000;
      const payback = data.payback || 65000;
      const term = data.term || 6;
      const revenue = data.revenue || 50000;
      const creditScore = data.credit || 650;
      const dailyPayment = (payback / (term * 21)).toFixed(2);
      const monthlyPayment = (payback / term).toFixed(2);
      const factor = (payback / funding).toFixed(2);
      
      const contents = {
        score: `
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">SCORE RADAR</div>
              <div class="p-3 rounded-lg flex items-center justify-center" style="background: var(--bg-input);">
                <svg viewBox="0 0 200 200" style="width: 100%; max-width: 180px;">
                  <polygon points="100,20 180,70 155,160 45,160 20,70" fill="none" stroke="var(--border-subtle)" stroke-width="1"/>
                  <polygon points="100,40 160,75 142,145 58,145 40,75" fill="none" stroke="var(--border-subtle)" stroke-width="1" opacity="0.5"/>
                  <polygon id="modalRadarPoly" points="100,35 165,72 148,150 52,150 35,72" fill="rgba(234,179,8,0.25)" stroke="var(--accent)" stroke-width="2"/>
                  <text x="100" y="12" text-anchor="middle" fill="var(--text-muted)" font-size="8">CREDIT</text>
                  <text x="190" y="72" text-anchor="start" fill="var(--text-muted)" font-size="8">BEHAVIOR</text>
                  <text x="160" y="172" text-anchor="start" fill="var(--text-muted)" font-size="8">REVENUE</text>
                  <text x="40" y="172" text-anchor="end" fill="var(--text-muted)" font-size="8">STABILITY</text>
                  <text x="10" y="72" text-anchor="end" fill="var(--text-muted)" font-size="8">BUFFER</text>
                  <text x="100" y="105" text-anchor="middle" fill="var(--accent)" font-size="24" font-weight="800">${score}</text>
                </svg>
              </div>
              <div class="mt-2 p-3 rounded-lg text-center" style="background: linear-gradient(135deg, rgba(234,179,8,0.15), rgba(234,179,8,0.05)); border: 1px solid rgba(234,179,8,0.3);">
                <div class="text-[9px]" style="color: var(--text-muted);">COMPOSITE ABLESCORE</div>
                <div class="text-2xl font-black" style="color: var(--accent);">${score}<span class="text-sm font-normal" style="color: var(--text-muted);">/100</span></div>
                <div class="text-[9px]" style="color: ${score >= 70 ? '#10b981' : score >= 50 ? '#eab308' : '#ef4444'};">${score >= 70 ? 'STRONG APPROVAL' : score >= 50 ? 'CONDITIONAL' : 'HIGH RISK'}</div>
              </div>
              <div class="mt-3 text-xs font-bold mb-2" style="color: var(--text-muted);">FACTORS</div>
              <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                <div class="space-y-1 text-[10px]">
                  <div class="flex items-center gap-2"><span style="color: #10b981;">+</span><span style="color: var(--text-secondary);">Strong revenue consistency</span></div>
                  <div class="flex items-center gap-2"><span style="color: #10b981;">+</span><span style="color: var(--text-secondary);">Established business history</span></div>
                  <div class="flex items-center gap-2"><span style="color: #eab308;">~</span><span style="color: var(--text-secondary);">Moderate NSF activity</span></div>
                  <div class="flex items-center gap-2"><span style="color: #ef4444;">-</span><span style="color: var(--text-secondary);">Limited cash reserves</span></div>
                </div>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">COMPONENT BREAKDOWN</div>
              <div class="space-y-2">
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center mb-1"><span class="text-[10px]" style="color: var(--text-secondary);">Credit Score</span><span class="text-sm font-bold" style="color: #3b82f6;">15/20</span></div>
                  <div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #3b82f6; width: 75%;"></div></div>
                  <div class="text-[9px] mt-1" style="color: var(--text-muted);">FICO: ${creditScore}</div>
                </div>
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center mb-1"><span class="text-[10px]" style="color: var(--text-secondary);">Behavior</span><span class="text-sm font-bold" style="color: #8b5cf6;">12/15</span></div>
                  <div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #8b5cf6; width: 80%;"></div></div>
                  <div class="text-[9px] mt-1" style="color: var(--text-muted);">NSF: 2</div>
                </div>
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center mb-1"><span class="text-[10px]" style="color: var(--text-secondary);">Revenue</span><span class="text-sm font-bold" style="color: #10b981;">21/30</span></div>
                  <div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #10b981; width: 70%;"></div></div>
                  <div class="text-[9px] mt-1" style="color: var(--text-muted);">Avg: $${revenue.toLocaleString()}</div>
                </div>
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center mb-1"><span class="text-[10px]" style="color: var(--text-secondary);">Stability</span><span class="text-sm font-bold" style="color: #f59e0b;">16/20</span></div>
                  <div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #f59e0b; width: 80%;"></div></div>
                  <div class="text-[9px] mt-1" style="color: var(--text-muted);">TIB: 3+ yrs</div>
                </div>
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center mb-1"><span class="text-[10px]" style="color: var(--text-secondary);">Cash Buffer</span><span class="text-sm font-bold" style="color: #06b6d4;">10/15</span></div>
                  <div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #06b6d4; width: 67%;"></div></div>
                  <div class="text-[9px] mt-1" style="color: var(--text-muted);">Buffer: 1.2x</div>
                </div>
              </div>
              <div class="mt-3 p-3 rounded-lg" style="background: var(--bg-input);">
                <div class="text-[9px] font-bold mb-2" style="color: var(--text-muted);">RECOMMENDATIONS</div>
                <div class="space-y-1 text-[9px]" style="color: var(--text-secondary);">
                  <p>Term: ${term} months optimal</p>
                  <p>Max funding: $${Math.round(revenue * 1.2).toLocaleString()}</p>
                  <p>Factor range: 1.25 - 1.45</p>
                </div>
              </div>
            </div>
          </div>`,
          
        risk: `
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">PROBABILITY OF DEFAULT</div>
              <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);">
                <svg viewBox="0 0 200 110" style="width: 100%; max-width: 200px; margin: 0 auto; display: block;">
                  <defs>
                    <linearGradient id="pdGradient2" x1="0%" y1="0%" x2="100%">
                      <stop offset="0%" stop-color="#10b981"/><stop offset="50%" stop-color="#eab308"/><stop offset="100%" stop-color="#ef4444"/>
                    </linearGradient>
                  </defs>
                  <path d="M 20 90 A 80 80 0 0 1 180 90" fill="none" stroke="var(--bg-card)" stroke-width="16" stroke-linecap="round"/>
                  <path d="M 20 90 A 80 80 0 0 1 180 90" fill="none" stroke="url(#pdGradient2)" stroke-width="16" stroke-linecap="round" stroke-dasharray="251" stroke-dashoffset="200"/>
                  <text x="100" y="75" text-anchor="middle" fill="var(--text-primary)" font-size="28" font-weight="800">8.2%</text>
                  <text x="100" y="95" text-anchor="middle" fill="var(--text-muted)" font-size="10">Default Probability</text>
                </svg>
              </div>
              <div class="mt-2 p-3 rounded-lg" style="background: var(--bg-input);">
                <div class="text-[9px] font-bold mb-2" style="color: var(--text-muted);">PD FACTORS</div>
                <div class="space-y-1 text-[10px]">
                  <div class="flex justify-between"><span style="color: var(--text-secondary);">Base PD (Industry)</span><span class="font-bold">12.5%</span></div>
                  <div class="flex justify-between"><span style="color: var(--text-secondary);">Credit Adj.</span><span class="font-bold" style="color: #10b981;">-2.1%</span></div>
                  <div class="flex justify-between"><span style="color: var(--text-secondary);">Revenue Adj.</span><span class="font-bold" style="color: #10b981;">-1.8%</span></div>
                  <div class="flex justify-between"><span style="color: var(--text-secondary);">Behavior Adj.</span><span class="font-bold" style="color: #ef4444;">+0.4%</span></div>
                  <div class="flex justify-between pt-1" style="border-top: 1px solid var(--border-subtle);"><span class="font-bold">Final PD</span><span class="font-bold" style="color: var(--accent);">8.2%</span></div>
                </div>
              </div>
              <div class="mt-3 text-xs font-bold mb-2" style="color: var(--text-muted);">LOSS METRICS</div>
              <div class="space-y-2">
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center"><span class="text-[10px]" style="color: var(--text-muted);">Loss Given Default</span><span class="text-lg font-bold" style="color: #f97316;">45%</span></div>
                  <div class="h-1.5 rounded-full mt-1" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #f97316; width: 45%;"></div></div>
                </div>
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center"><span class="text-[10px]" style="color: var(--text-muted);">Expected Loss</span><span class="text-lg font-bold" style="color: #ef4444;">3.7%</span></div>
                  <div class="text-[9px]" style="color: var(--text-muted);">Dollar EL: $${Math.round(funding * 0.037).toLocaleString()}</div>
                </div>
                <div class="p-2 rounded-lg" style="background: var(--bg-input);">
                  <div class="flex justify-between items-center"><span class="text-[10px]" style="color: var(--text-muted);">Risk-Adj Return</span><span class="text-lg font-bold" style="color: #10b981;">$${Math.round((payback - funding) - (funding * 0.037)).toLocaleString()}</span></div>
                </div>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">DEBT SERVICE COVERAGE</div>
              <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                <div class="grid grid-cols-2 gap-2 mb-2">
                  <div class="text-center p-2 rounded" style="background: var(--bg-card);">
                    <div class="text-[9px]" style="color: var(--text-muted);">Monthly Revenue</div>
                    <div class="text-lg font-bold">$${revenue.toLocaleString()}</div>
                  </div>
                  <div class="text-center p-2 rounded" style="background: var(--bg-card);">
                    <div class="text-[9px]" style="color: var(--text-muted);">Monthly Debt</div>
                    <div class="text-lg font-bold">$${parseInt(monthlyPayment).toLocaleString()}</div>
                  </div>
                </div>
                <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.3);">
                  <div class="text-[9px]" style="color: var(--text-muted);">DSCR RATIO</div>
                  <div class="text-2xl font-black" style="color: #10b981;">${(revenue / parseFloat(monthlyPayment)).toFixed(2)}x</div>
                  <div class="text-[9px]" style="color: #10b981;">Healthy Coverage</div>
                </div>
              </div>
              <div class="mt-3 text-xs font-bold mb-2" style="color: var(--text-muted);">RISK CLASSIFICATION</div>
              <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                <div class="space-y-2">
                  <div class="flex justify-between items-center p-2 rounded" style="background: var(--bg-card);"><span class="text-[10px]">Overall Risk</span><span class="px-2 py-0.5 rounded text-[9px] font-bold" style="background: rgba(234,179,8,0.2); color: #eab308;">MEDIUM</span></div>
                  <div class="flex justify-between items-center p-2 rounded" style="background: var(--bg-card);"><span class="text-[10px]">Payment Capacity</span><span class="px-2 py-0.5 rounded text-[9px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">STRONG</span></div>
                  <div class="flex justify-between items-center p-2 rounded" style="background: var(--bg-card);"><span class="text-[10px]">Default Likelihood</span><span class="px-2 py-0.5 rounded text-[9px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">LOW</span></div>
                  <div class="flex justify-between items-center p-2 rounded" style="background: var(--bg-card);"><span class="text-[10px]">Stress Tolerance</span><span class="px-2 py-0.5 rounded text-[9px] font-bold" style="background: rgba(234,179,8,0.2); color: #eab308;">MODERATE</span></div>
                </div>
              </div>
            </div>
          </div>`,
          
        cashflow: `
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">CASH FLOW PROJECTION</div>
              <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                <svg viewBox="0 0 280 120" style="width: 100%;">
                  <line x1="30" y1="100" x2="270" y2="100" stroke="var(--border-subtle)" stroke-width="1"/>
                  <polyline points="40,30 80,35 120,25 160,40 200,35 240,30" fill="none" stroke="#10b981" stroke-width="2"/>
                  <polyline points="40,60 80,55 120,65 160,50 200,55 240,60" fill="none" stroke="var(--accent)" stroke-width="2"/>
                  <polyline points="40,80 80,82 120,78 160,85 200,82 240,80" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4,2"/>
                  <text x="40" y="112" fill="var(--text-muted)" font-size="8">M1</text>
                  <text x="120" y="112" fill="var(--text-muted)" font-size="8">M3</text>
                  <text x="200" y="112" fill="var(--text-muted)" font-size="8">M5</text>
                  <text x="240" y="112" fill="var(--text-muted)" font-size="8">M6</text>
                </svg>
                <div class="flex justify-center gap-4 mt-2">
                  <div class="flex items-center gap-1"><div class="w-3 h-0.5" style="background: #10b981;"></div><span class="text-[9px]" style="color: var(--text-muted);">Revenue</span></div>
                  <div class="flex items-center gap-1"><div class="w-3 h-0.5" style="background: var(--accent);"></div><span class="text-[9px]" style="color: var(--text-muted);">Net CF</span></div>
                  <div class="flex items-center gap-1"><div class="w-3 h-0.5" style="background: #ef4444;"></div><span class="text-[9px]" style="color: var(--text-muted);">Payments</span></div>
                </div>
              </div>
              <div class="mt-3">
                <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">AMORTIZATION</div>
                <div class="rounded-lg overflow-hidden text-[10px]" style="background: var(--bg-input);">
                  <table class="w-full">
                    <thead><tr style="background: var(--bg-card);"><th class="p-2 text-left">Month</th><th class="p-2 text-right">Revenue</th><th class="p-2 text-right">Payment</th><th class="p-2 text-right">Balance</th></tr></thead>
                    <tbody>
                      <tr style="border-bottom: 1px solid var(--border-subtle);"><td class="p-2">1</td><td class="p-2 text-right">$${revenue.toLocaleString()}</td><td class="p-2 text-right" style="color: #ef4444;">-$${parseInt(monthlyPayment).toLocaleString()}</td><td class="p-2 text-right">$${Math.round(payback - parseFloat(monthlyPayment)).toLocaleString()}</td></tr>
                      <tr style="border-bottom: 1px solid var(--border-subtle);"><td class="p-2">2</td><td class="p-2 text-right">$${revenue.toLocaleString()}</td><td class="p-2 text-right" style="color: #ef4444;">-$${parseInt(monthlyPayment).toLocaleString()}</td><td class="p-2 text-right">$${Math.round(payback - parseFloat(monthlyPayment)*2).toLocaleString()}</td></tr>
                      <tr style="border-bottom: 1px solid var(--border-subtle);"><td class="p-2">3</td><td class="p-2 text-right">$${revenue.toLocaleString()}</td><td class="p-2 text-right" style="color: #ef4444;">-$${parseInt(monthlyPayment).toLocaleString()}</td><td class="p-2 text-right">$${Math.round(payback - parseFloat(monthlyPayment)*3).toLocaleString()}</td></tr>
                      <tr style="border-bottom: 1px solid var(--border-subtle);"><td class="p-2">4</td><td class="p-2 text-right">$${revenue.toLocaleString()}</td><td class="p-2 text-right" style="color: #ef4444;">-$${parseInt(monthlyPayment).toLocaleString()}</td><td class="p-2 text-right">$${Math.round(payback - parseFloat(monthlyPayment)*4).toLocaleString()}</td></tr>
                      <tr style="border-bottom: 1px solid var(--border-subtle);"><td class="p-2">5</td><td class="p-2 text-right">$${revenue.toLocaleString()}</td><td class="p-2 text-right" style="color: #ef4444;">-$${parseInt(monthlyPayment).toLocaleString()}</td><td class="p-2 text-right">$${Math.round(payback - parseFloat(monthlyPayment)*5).toLocaleString()}</td></tr>
                      <tr><td class="p-2 font-bold">6</td><td class="p-2 text-right">$${revenue.toLocaleString()}</td><td class="p-2 text-right" style="color: #ef4444;">-$${parseInt(monthlyPayment).toLocaleString()}</td><td class="p-2 text-right font-bold" style="color: #10b981;">$0</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-2" style="color: var(--text-muted);">SUMMARY</div>
              <div class="space-y-2">
                <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                  <div class="text-[9px]" style="color: var(--text-muted);">Total Revenue (${term} mo)</div>
                  <div class="text-xl font-bold" style="color: #10b981;">$${(revenue * term).toLocaleString()}</div>
                </div>
                <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                  <div class="text-[9px]" style="color: var(--text-muted);">Total Payback</div>
                  <div class="text-xl font-bold" style="color: #ef4444;">$${payback.toLocaleString()}</div>
                </div>
                <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                  <div class="text-[9px]" style="color: var(--text-muted);">Net Cash Retained</div>
                  <div class="text-xl font-bold" style="color: var(--accent);">$${Math.round((revenue * term) - payback).toLocaleString()}</div>
                </div>
                <div class="p-3 rounded-lg" style="background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.3);">
                  <div class="text-[9px]" style="color: var(--text-muted);">Payment to Revenue</div>
                  <div class="text-2xl font-black" style="color: #10b981;">${((parseFloat(monthlyPayment) / revenue) * 100).toFixed(1)}%</div>
                  <div class="text-[9px]" style="color: ${(parseFloat(monthlyPayment) / revenue) < 0.25 ? '#10b981' : '#eab308'};">${(parseFloat(monthlyPayment) / revenue) < 0.25 ? 'Healthy ratio' : 'Monitor closely'}</div>
                </div>
              </div>
              <div class="mt-3 text-xs font-bold mb-2" style="color: var(--text-muted);">BREAK-EVEN</div>
              <div class="p-3 rounded-lg" style="background: var(--bg-input);">
                <div class="space-y-2 text-[10px]">
                  <div class="flex justify-between"><span style="color: var(--text-muted);">Funding Received</span><span class="font-bold">$${funding.toLocaleString()}</span></div>
                  <div class="flex justify-between"><span style="color: var(--text-muted);">Cost of Capital</span><span class="font-bold">$${(payback - funding).toLocaleString()}</span></div>
                  <div class="flex justify-between"><span style="color: var(--text-muted);">Factor Rate</span><span class="font-bold">${factor}x</span></div>
                  <div class="flex justify-between"><span style="color: var(--text-muted);">Daily Payment</span><span class="font-bold">$${dailyPayment}</span></div>
                  <div class="flex justify-between pt-2" style="border-top: 1px solid var(--border-subtle);"><span style="color: var(--text-muted);">Days to Break-Even</span><span class="font-bold" style="color: var(--accent);">${Math.ceil(funding / parseFloat(dailyPayment))} days</span></div>
                </div>
              </div>
            </div>
          </div>`,
          
        matrix: `
          <div class="grid grid-cols-2 gap-6">
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">RISK MATRIX (IMPACT vs PROBABILITY)</div>
              <div class="p-4 rounded-lg" style="background: var(--bg-input);">
                <svg viewBox="0 0 220 220" class="w-full" style="max-height: 220px;">
                  <rect x="30" y="30" width="45" height="45" fill="rgba(234,179,8,0.3)"/><rect x="75" y="30" width="45" height="45" fill="rgba(249,115,22,0.4)"/><rect x="120" y="30" width="45" height="45" fill="rgba(239,68,68,0.5)"/><rect x="165" y="30" width="45" height="45" fill="rgba(239,68,68,0.6)"/>
                  <rect x="30" y="75" width="45" height="45" fill="rgba(16,185,129,0.3)"/><rect x="75" y="75" width="45" height="45" fill="rgba(234,179,8,0.3)"/><rect x="120" y="75" width="45" height="45" fill="rgba(249,115,22,0.4)"/><rect x="165" y="75" width="45" height="45" fill="rgba(239,68,68,0.5)"/>
                  <rect x="30" y="120" width="45" height="45" fill="rgba(16,185,129,0.4)"/><rect x="75" y="120" width="45" height="45" fill="rgba(16,185,129,0.3)"/><rect x="120" y="120" width="45" height="45" fill="rgba(234,179,8,0.3)"/><rect x="165" y="120" width="45" height="45" fill="rgba(249,115,22,0.4)"/>
                  <rect x="30" y="165" width="45" height="45" fill="rgba(16,185,129,0.5)"/><rect x="75" y="165" width="45" height="45" fill="rgba(16,185,129,0.4)"/><rect x="120" y="165" width="45" height="45" fill="rgba(16,185,129,0.3)"/><rect x="165" y="165" width="45" height="45" fill="rgba(234,179,8,0.3)"/>
                  <circle id="modalRiskDot" cx="97" cy="97" r="8" fill="var(--accent)" stroke="#fff" stroke-width="2"/>
                  <text x="15" y="55" fill="var(--text-muted)" font-size="8" text-anchor="end">High</text>
                  <text x="15" y="100" fill="var(--text-muted)" font-size="8" text-anchor="end">Med</text>
                  <text x="15" y="145" fill="var(--text-muted)" font-size="8" text-anchor="end">Low</text>
                  <text x="15" y="190" fill="var(--text-muted)" font-size="8" text-anchor="end">Min</text>
                  <text x="52" y="220" fill="var(--text-muted)" font-size="8" text-anchor="middle">Low</text>
                  <text x="97" y="220" fill="var(--text-muted)" font-size="8" text-anchor="middle">Med</text>
                  <text x="142" y="220" fill="var(--text-muted)" font-size="8" text-anchor="middle">High</text>
                  <text x="187" y="220" fill="var(--text-muted)" font-size="8" text-anchor="middle">Crit</text>
                  <text x="120" y="12" fill="var(--text-muted)" font-size="9" text-anchor="middle">PROBABILITY</text>
                  <text x="8" y="120" fill="var(--text-muted)" font-size="9" text-anchor="middle" transform="rotate(-90,8,120)">IMPACT</text>
                </svg>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">RISK FACTORS</div>
              <div class="space-y-2">
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Credit Risk</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(234,179,8,0.2); color: #eab308;">MEDIUM</span></div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Liquidity Risk</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">LOW</span></div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Industry Risk</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">LOW</span></div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Concentration Risk</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(234,179,8,0.2); color: #eab308;">MEDIUM</span></div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Operational Risk</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">LOW</span></div>
                <div class="flex justify-between items-center p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Market Risk</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(234,179,8,0.2); color: #eab308;">MEDIUM</span></div>
              </div>
            </div>
          </div>`,
          
        sensitivity: `
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">TORNADO CHART - FUNDING SENSITIVITY</div>
          <div class="p-4 rounded-lg mb-4" style="background: var(--bg-input);">
            <svg viewBox="0 0 600 200" class="w-full">
              <line x1="300" y1="20" x2="300" y2="180" stroke="var(--text-muted)" stroke-width="1" stroke-dasharray="4"/>
              <text x="300" y="15" fill="var(--text-muted)" font-size="9" text-anchor="middle">Base: $${funding.toLocaleString()}</text>
              <rect x="160" y="30" width="140" height="20" fill="#ef4444" rx="2"/><rect x="300" y="30" width="180" height="20" fill="#10b981" rx="2"/>
              <text x="155" y="44" fill="var(--text-secondary)" font-size="9" text-anchor="end">Credit Score</text>
              <rect x="180" y="60" width="120" height="20" fill="#ef4444" rx="2"/><rect x="300" y="60" width="150" height="20" fill="#10b981" rx="2"/>
              <text x="155" y="74" fill="var(--text-secondary)" font-size="9" text-anchor="end">Revenue</text>
              <rect x="200" y="90" width="100" height="20" fill="#ef4444" rx="2"/><rect x="300" y="90" width="120" height="20" fill="#10b981" rx="2"/>
              <text x="155" y="104" fill="var(--text-secondary)" font-size="9" text-anchor="end">Time in Business</text>
              <rect x="220" y="120" width="80" height="20" fill="#ef4444" rx="2"/><rect x="300" y="120" width="100" height="20" fill="#10b981" rx="2"/>
              <text x="155" y="134" fill="var(--text-secondary)" font-size="9" text-anchor="end">NSF Events</text>
              <rect x="240" y="150" width="60" height="20" fill="#ef4444" rx="2"/><rect x="300" y="150" width="70" height="20" fill="#10b981" rx="2"/>
              <text x="155" y="164" fill="var(--text-secondary)" font-size="9" text-anchor="end">Avg Balance</text>
            </svg>
          </div>
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">SCENARIO ANALYSIS</div>
          <table class="w-full text-[10px]">
            <thead><tr style="background: var(--bg-input);"><th class="p-2 text-left">Scenario</th><th class="p-2 text-right">Funding</th><th class="p-2 text-right">Score</th><th class="p-2 text-right">PD</th><th class="p-2 text-right">ROI</th></tr></thead>
            <tbody>
              <tr style="border-bottom: 1px solid var(--border-subtle); color: #ef4444;"><td class="p-2">Stress Case</td><td class="p-2 text-right">$${(funding*0.6).toLocaleString()}</td><td class="p-2 text-right">${score-15}</td><td class="p-2 text-right">18.5%</td><td class="p-2 text-right">12%</td></tr>
              <tr style="border-bottom: 1px solid var(--border-subtle); color: #f97316;"><td class="p-2">Conservative</td><td class="p-2 text-right">$${(funding*0.8).toLocaleString()}</td><td class="p-2 text-right">${score-8}</td><td class="p-2 text-right">12.1%</td><td class="p-2 text-right">22%</td></tr>
              <tr style="border-bottom: 1px solid var(--border-subtle); background: rgba(234,179,8,0.1);"><td class="p-2 font-bold">Base Case</td><td class="p-2 text-right font-bold">$${funding.toLocaleString()}</td><td class="p-2 text-right font-bold">${score}</td><td class="p-2 text-right font-bold">8.2%</td><td class="p-2 text-right font-bold">30%</td></tr>
              <tr style="border-bottom: 1px solid var(--border-subtle); color: #10b981;"><td class="p-2">Optimistic</td><td class="p-2 text-right">$${(funding*1.15).toLocaleString()}</td><td class="p-2 text-right">${score+5}</td><td class="p-2 text-right">5.8%</td><td class="p-2 text-right">35%</td></tr>
              <tr style="color: #10b981;"><td class="p-2">Best Case</td><td class="p-2 text-right">$${(funding*1.3).toLocaleString()}</td><td class="p-2 text-right">${score+12}</td><td class="p-2 text-right">3.2%</td><td class="p-2 text-right">42%</td></tr>
            </tbody>
          </table>`,
          
        benchmarks: `
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">INDUSTRY COMPARISON</div>
          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">FUNDING AMOUNT</div>
              <div class="flex justify-between items-end mb-2"><span class="text-2xl font-bold">$${funding.toLocaleString()}</span><span class="text-sm" style="color: #10b981;">+11% vs avg</span></div>
              <div class="h-3 rounded-full relative" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: var(--accent); width: 55%;"></div><div class="absolute top-0 w-0.5 h-full" style="background: var(--text-muted); left: 50%;"></div></div>
              <div class="flex justify-between text-[8px] mt-1" style="color: var(--text-muted);"><span>$0</span><span>Industry Avg: $45K</span><span>$100K</span></div>
            </div>
            <div class="p-4 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">CREDIT SCORE</div>
              <div class="flex justify-between items-end mb-2"><span class="text-2xl font-bold">${creditScore}</span><span class="text-sm" style="color: #10b981;">+8% vs avg</span></div>
              <div class="h-3 rounded-full relative" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: var(--accent); width: 62%;"></div><div class="absolute top-0 w-0.5 h-full" style="background: var(--text-muted); left: 55%;"></div></div>
              <div class="flex justify-between text-[8px] mt-1" style="color: var(--text-muted);"><span>300</span><span>Industry Avg: 605</span><span>850</span></div>
            </div>
            <div class="p-4 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">DEFAULT RATE</div>
              <div class="flex justify-between items-end mb-2"><span class="text-2xl font-bold">8.2%</span><span class="text-sm" style="color: #10b981;">-15% vs avg</span></div>
              <div class="h-3 rounded-full relative" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #f97316; width: 20%;"></div><div class="absolute top-0 w-0.5 h-full" style="background: var(--text-muted); left: 24%;"></div></div>
              <div class="flex justify-between text-[8px] mt-1" style="color: var(--text-muted);"><span>0%</span><span>Industry Avg: 9.6%</span><span>40%</span></div>
            </div>
            <div class="p-4 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">APPROVAL LIKELIHOOD</div>
              <div class="flex justify-between items-end mb-2"><span class="text-2xl font-bold">78%</span><span class="text-sm" style="color: #10b981;">+15% vs avg</span></div>
              <div class="h-3 rounded-full relative" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #10b981; width: 78%;"></div><div class="absolute top-0 w-0.5 h-full" style="background: var(--text-muted); left: 68%;"></div></div>
              <div class="flex justify-between text-[8px] mt-1" style="color: var(--text-muted);"><span>0%</span><span>Industry Avg: 68%</span><span>100%</span></div>
            </div>
          </div>`,
          
        stacking: `
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">DEBT WATERFALL</div>
          <table class="w-full text-[10px] mb-4">
            <thead><tr style="background: var(--bg-input);"><th class="p-2 text-left">Pos</th><th class="p-2 text-left">Funder</th><th class="p-2 text-right">Original</th><th class="p-2 text-right">Balance</th><th class="p-2 text-right">Daily</th><th class="p-2 text-right">Payoff</th><th class="p-2 text-center">Status</th></tr></thead>
            <tbody>
              <tr style="border-bottom: 1px solid var(--border-subtle);"><td class="p-2"><span class="px-1.5 py-0.5 rounded text-[8px] font-bold" style="background: rgba(234,179,8,0.2); color: var(--accent);">1ST</span></td><td class="p-2">This Deal</td><td class="p-2 text-right">$${funding.toLocaleString()}</td><td class="p-2 text-right">$${payback.toLocaleString()}</td><td class="p-2 text-right">$${dailyPayment}</td><td class="p-2 text-right">${term}mo</td><td class="p-2 text-center"><span class="px-1.5 py-0.5 rounded text-[8px]" style="background: rgba(16,185,129,0.2); color: #10b981;">PROPOSED</span></td></tr>
            </tbody>
          </table>
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">STACK METRICS</div>
          <div class="grid grid-cols-4 gap-3 mb-4">
            <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Total Daily</div><div class="text-lg font-bold">$${dailyPayment}</div></div>
            <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Revenue Burden</div><div class="text-lg font-bold" style="color: #10b981;">${((dailyPayment * 21 / revenue) * 100).toFixed(1)}%</div></div>
            <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Outstanding</div><div class="text-lg font-bold">$${payback.toLocaleString()}</div></div>
            <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Add'l Capacity</div><div class="text-lg font-bold" style="color: #10b981;">$${Math.max(0, Math.round(revenue * 0.25 * term - payback)).toLocaleString()}</div></div>
          </div>
          <div class="p-4 rounded-lg" style="background: var(--bg-input);">
            <div class="flex justify-between items-center"><span class="text-[10px]" style="color: var(--text-muted);">STACK RISK ASSESSMENT</span><span class="px-2 py-1 rounded text-[9px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">LOW RISK - FIRST POSITION</span></div>
          </div>`,
          
        historical: `
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div class="p-3 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">REVENUE TREND (12 MO)</div>
              <div class="h-12 flex items-end gap-0.5">
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 55%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 60%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 52%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 65%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 70%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 68%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 75%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 72%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 80%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 85%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 90%;"></div>
                <div class="flex-1 rounded-t" style="background: var(--accent); height: 100%;"></div>
              </div>
              <div class="flex justify-between mt-1 text-[8px]" style="color: var(--text-muted);"><span>Low: $38K</span><span>Avg: $${revenue.toLocaleString()}</span><span>High: $62K</span></div>
            </div>
            <div class="p-3 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">BALANCE TREND (12 MO)</div>
              <div class="h-12 flex items-end gap-0.5">
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 45%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 50%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 48%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 55%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 52%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 60%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 58%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 65%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 70%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 68%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 75%;"></div>
                <div class="flex-1 rounded-t" style="background: #3b82f6; height: 80%;"></div>
              </div>
              <div class="flex justify-between mt-1 text-[8px]" style="color: var(--text-muted);"><span>Low: $8K</span><span>Avg: $15K</span><span>High: $22K</span></div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mb-3">
            <div class="p-3 rounded-lg" style="background: var(--bg-input);">
              <div class="text-[9px] mb-2" style="color: var(--text-muted);">BEHAVIOR EVENTS (12 MO)</div>
              <div class="h-12 flex items-end gap-0.5">
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 20%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 15%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 10%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 5%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
                <div class="flex-1 rounded-t" style="background: #ef4444; height: 0%;"></div>
              </div>
              <div class="flex justify-between mt-1 text-[8px]" style="color: var(--text-muted);"><span>NSF: 2</span><span>Neg Days: 5</span><span>Trend: Improving</span></div>
            </div>
            <div class="p-3 rounded-lg flex items-center" style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);">
              <div class="flex items-center gap-2"><svg fill="none" height="16" stroke="#10b981" stroke-width="2" viewbox="0 0 24 24" width="16"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg><span class="text-[11px] font-bold" style="color: #10b981;">+12.4% YoY Revenue Growth</span></div>
            </div>
          </div>`,
          
        payment: `
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">AMORTIZATION SCHEDULE</div>
          <div class="p-4 rounded-lg mb-4" style="background: var(--bg-input);">
            <svg viewBox="0 0 600 150" class="w-full">
              <defs><linearGradient id="balGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="rgba(234,179,8,0.4)"/><stop offset="100%" stop-color="rgba(234,179,8,0.1)"/></linearGradient></defs>
              <path d="M50,20 Q300,40 550,130 L550,140 L50,140 Z" fill="url(#balGrad)"/>
              <path d="M50,20 Q300,40 550,130" fill="none" stroke="var(--accent)" stroke-width="2"/>
              <line x1="50" y1="140" x2="550" y2="140" stroke="var(--border-subtle)" stroke-width="1"/>
              <text x="50" y="155" fill="var(--text-muted)" font-size="9">Start</text>
              <text x="300" y="155" fill="var(--text-muted)" font-size="9" text-anchor="middle">Mid-Term</text>
              <text x="550" y="155" fill="var(--text-muted)" font-size="9" text-anchor="end">Payoff</text>
              <text x="30" y="25" fill="var(--text-muted)" font-size="8">$${payback.toLocaleString()}</text>
              <text x="30" y="140" fill="var(--text-muted)" font-size="8">$0</text>
            </svg>
          </div>
          <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">PAYMENT STRUCTURE</div>
          <div class="grid grid-cols-4 gap-3">
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Daily Payment</div><div class="text-xl font-bold" style="color: var(--accent);">$${dailyPayment}</div></div>
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Weekly Payment</div><div class="text-xl font-bold">$${(dailyPayment * 5).toFixed(2)}</div></div>
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Monthly Payment</div><div class="text-xl font-bold">$${parseInt(monthlyPayment).toLocaleString()}</div></div>
            <div class="p-4 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Total Payments</div><div class="text-xl font-bold">${term * 21}</div></div>
          </div>`,
          
        revenue: `
          <div class="grid grid-cols-2 gap-6">
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">QUALITY SCORE</div>
              <div class="p-6 rounded-lg text-center" style="background: var(--bg-input);">
                <svg viewBox="0 0 120 120" class="mx-auto" style="width: 150px; height: 150px;">
                  <circle cx="60" cy="60" r="50" fill="none" stroke="var(--bg-card)" stroke-width="10"/>
                  <circle cx="60" cy="60" r="50" fill="none" stroke="#10b981" stroke-width="10" stroke-dasharray="314" stroke-dashoffset="47" transform="rotate(-90 60 60)"/>
                  <text x="60" y="55" text-anchor="middle" fill="var(--text-primary)" font-size="28" font-weight="800">85</text>
                  <text x="60" y="72" text-anchor="middle" fill="var(--text-muted)" font-size="10">Quality Score</text>
                </svg>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">QUALITY INDICATORS</div>
              <div class="space-y-3">
                <div class="p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex justify-between text-[10px] mb-1"><span style="color: var(--text-muted);">Consistency</span><span class="font-bold" style="color: #10b981;">92%</span></div><div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #10b981; width: 92%;"></div></div></div>
                <div class="p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex justify-between text-[10px] mb-1"><span style="color: var(--text-muted);">Volatility</span><span class="font-bold" style="color: #eab308;">18%</span></div><div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #eab308; width: 18%;"></div></div></div>
                <div class="p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex justify-between text-[10px] mb-1"><span style="color: var(--text-muted);">Seasonality</span><span class="font-bold" style="color: #10b981;">Low</span></div></div>
                <div class="p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex justify-between text-[10px] mb-1"><span style="color: var(--text-muted);">Growth Rate</span><span class="font-bold" style="color: #10b981;">+8%</span></div><div class="h-1.5 rounded-full" style="background: var(--bg-card);"><div class="h-full rounded-full" style="background: #10b981; width: 58%;"></div></div></div>
                <div class="p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex justify-between text-[10px] mb-1"><span style="color: var(--text-muted);">Concentration</span><span class="font-bold" style="color: #10b981;">Low</span></div></div>
              </div>
            </div>
          </div>`,
          
        pricing: `
          <div class="grid grid-cols-2 gap-6">
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">PROFITABILITY BREAKDOWN</div>
              <div class="space-y-2">
                <div class="p-3 rounded-lg flex justify-between" style="background: var(--bg-input);"><span class="text-[10px]" style="color: var(--text-muted);">Gross Profit</span><span class="font-bold" style="color: #10b981;">$${(payback - funding).toLocaleString()}</span></div>
                <div class="p-3 rounded-lg flex justify-between" style="background: var(--bg-input);"><span class="text-[10px]" style="color: var(--text-muted);">Less: EL Reserve</span><span class="font-bold" style="color: #ef4444;">-$${Math.round(funding * 0.037).toLocaleString()}</span></div>
                <div class="p-3 rounded-lg flex justify-between" style="background: var(--bg-input);"><span class="text-[10px]" style="color: var(--text-muted);">Less: Op Cost (5%)</span><span class="font-bold" style="color: #ef4444;">-$${Math.round(funding * 0.05).toLocaleString()}</span></div>
                <div class="p-3 rounded-lg flex justify-between" style="background: var(--bg-input);"><span class="text-[10px]" style="color: var(--text-muted);">Less: Capital Cost (8%)</span><span class="font-bold" style="color: #ef4444;">-$${Math.round(funding * 0.08 * (term/12)).toLocaleString()}</span></div>
                <div class="p-4 rounded-lg flex justify-between" style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3);"><span class="text-sm font-bold">Net Profit</span><span class="text-xl font-bold" style="color: #10b981;">$${Math.round((payback - funding) - funding * 0.037 - funding * 0.05 - funding * 0.08 * (term/12)).toLocaleString()}</span></div>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">RATE METRICS</div>
              <div class="grid grid-cols-2 gap-2">
                <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Factor Rate</div><div class="text-lg font-bold" style="color: var(--accent);">${factor}</div></div>
                <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Buy Rate</div><div class="text-lg font-bold">${(factor * 0.94).toFixed(2)}</div></div>
                <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">APR Equiv</div><div class="text-lg font-bold">${((factor - 1) / (term / 12) * 100).toFixed(1)}%</div></div>
                <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">ROI</div><div class="text-lg font-bold" style="color: #10b981;">${((payback - funding) / funding * 100).toFixed(1)}%</div></div>
                <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">IRR</div><div class="text-lg font-bold">65.4%</div></div>
                <div class="p-3 rounded-lg text-center" style="background: var(--bg-input);"><div class="text-[9px]" style="color: var(--text-muted);">Risk-Adj Return</div><div class="text-lg font-bold" style="color: #10b981;">26.3%</div></div>
              </div>
            </div>
          </div>`,
          
        compliance: `
          <div class="grid grid-cols-2 gap-6">
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">REQUIRED DOCUMENTS</div>
              <div class="space-y-2">
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex items-center gap-2"><svg fill="none" height="14" stroke="#10b981" stroke-width="2" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span class="text-[10px]">Bank Statements (3 mo)</span></div><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">RECEIVED</span></div>
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex items-center gap-2"><svg fill="none" height="14" stroke="#10b981" stroke-width="2" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span class="text-[10px]">Application Form</span></div><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">RECEIVED</span></div>
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex items-center gap-2"><svg fill="none" height="14" stroke="#10b981" stroke-width="2" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span class="text-[10px]">Voided Check</span></div><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">RECEIVED</span></div>
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><div class="flex items-center gap-2"><svg fill="none" height="14" stroke="#10b981" stroke-width="2" viewbox="0 0 24 24" width="14"><polyline points="20 6 9 17 4 12"/></svg><span class="text-[10px]">Driver's License</span></div><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">RECEIVED</span></div>
              </div>
            </div>
            <div>
              <div class="text-xs font-bold mb-3" style="color: var(--text-muted);">VERIFICATION STATUS</div>
              <div class="space-y-2">
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Business Verification</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">VERIFIED</span></div>
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Identity Verification</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">VERIFIED</span></div>
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">Bank Account Verified</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(16,185,129,0.2); color: #10b981;">VERIFIED</span></div>
                <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-input);"><span class="text-[10px]">UCC Search</span><span class="px-2 py-0.5 rounded text-[8px] font-bold" style="background: rgba(234,179,8,0.2); color: #eab308;">PENDING</span></div>
              </div>
              <div class="text-xs font-bold mt-4 mb-3" style="color: var(--text-muted);">COMPLIANCE CHECKS</div>
              <div class="grid grid-cols-2 gap-2">
                <div class="p-2 rounded text-center text-[9px]" style="background: rgba(16,185,129,0.1); color: #10b981;">OFAC Clear</div>
                <div class="p-2 rounded text-center text-[9px]" style="background: rgba(16,185,129,0.1); color: #10b981;">Industry OK</div>
                <div class="p-2 rounded text-center text-[9px]" style="background: rgba(16,185,129,0.1); color: #10b981;">State OK</div>
                <div class="p-2 rounded text-center text-[9px]" style="background: rgba(16,185,129,0.1); color: #10b981;">Rate OK</div>
              </div>
            </div>
          </div>`
      };
      
      return contents[section] || '<p>Content not available</p>';
    }
    
    function updateModalData(section) {
      // Update modal data based on current inputs
      const data = window.calcOffer || {};
      const score = data.score || 62;
      const tier = data.tier || 'C';
      
      // PD calculation
      const basePD = {'A+': 1, 'A': 2, 'B+': 4, 'B': 6, 'C+': 9, 'C': 12, 'D+': 18, 'D': 25, 'F': 35}[tier] || 12;
      const pd = Math.min(40, Math.max(0, basePD + (100 - score) * 0.15)).toFixed(1);
      const lgd = Math.max(20, Math.min(80, 65 - score * 0.35)).toFixed(0);
      const el = (pd * lgd / 100).toFixed(1);
      
      // Update modal elements if they exist
      const modalPdValue = document.getElementById('modalPdValue');
      if (modalPdValue) modalPdValue.textContent = pd + '%';
      
      const modalLGD = document.getElementById('modalLGD');
      if (modalLGD) modalLGD.textContent = lgd + '%';
      
      const modalEL = document.getElementById('modalEL');
      if (modalEL) modalEL.textContent = el + '%';
    }
    
    function updateAnalyticsCards() {
      if (!window.calcOffer) return;
      const data = window.calcOffer;
      const score = data.score || 62;
      const tier = data.tier || 'C';
      const funding = data.funding || 50000;
      const payback = data.payback || 65000;
      const term = data.term || 6;
      const revenue = data.revenue || 50000;
      
      // Calculate metrics
      const basePD = {'A+': 1, 'A': 2, 'B+': 4, 'B': 6, 'C+': 9, 'C': 12, 'D+': 18, 'D': 25, 'F': 35}[tier] || 12;
      const pd = Math.min(40, Math.max(0, basePD + (100 - score) * 0.15));
      const lgd = Math.max(20, Math.min(80, 65 - score * 0.35));
      const el = pd * lgd / 100;
      const dailyPayment = payback / (term * 21);
      const monthlyPayment = payback / term;
      const dscr = revenue / monthlyPayment;
      const roi = ((payback - funding) / funding) * 100;
      const dollarEL = funding * el / 100;
      
      // Update header metrics
      const el_id = id => document.getElementById(id);
      if (el_id('analyticsHeaderScore')) el_id('analyticsHeaderScore').textContent = score;
      if (el_id('analyticsHeaderTier')) el_id('analyticsHeaderTier').textContent = 'Tier ' + tier;
      if (el_id('analyticsHeaderPD')) el_id('analyticsHeaderPD').textContent = pd.toFixed(1) + '%';
      if (el_id('analyticsHeaderLGD')) el_id('analyticsHeaderLGD').textContent = lgd.toFixed(0) + '%';
      if (el_id('analyticsHeaderEL')) el_id('analyticsHeaderEL').textContent = el.toFixed(1) + '%';
      if (el_id('analyticsHeaderDSCR')) el_id('analyticsHeaderDSCR').textContent = dscr.toFixed(2) + 'x';
      if (el_id('analyticsHeaderROI')) el_id('analyticsHeaderROI').textContent = roi.toFixed(1) + '%';
      
      // Update mini card values
      if (el_id('miniPdValue')) el_id('miniPdValue').textContent = pd.toFixed(1) + '%';
      if (el_id('miniLGD')) el_id('miniLGD').textContent = lgd.toFixed(0) + '%';
      if (el_id('miniEL')) el_id('miniEL').textContent = el.toFixed(1) + '%';
      if (el_id('miniDollarEL')) el_id('miniDollarEL').textContent = '$' + Math.round(dollarEL).toLocaleString();
      if (el_id('miniNetCF')) el_id('miniNetCF').textContent = '$' + Math.round((revenue - monthlyPayment) * term / 1000) + 'K';
      if (el_id('miniMonthlyPmt')) el_id('miniMonthlyPmt').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
      if (el_id('miniTerm')) el_id('miniTerm').textContent = term + ' mo';
      if (el_id('miniStackDaily')) el_id('miniStackDaily').textContent = '$' + dailyPayment.toFixed(0);
      if (el_id('miniStackBurden')) {
        const burden = (dailyPayment * 21 / revenue) * 100;
        el_id('miniStackBurden').textContent = burden.toFixed(1) + '%';
        el_id('miniStackBurden').style.color = burden < 20 ? '#10b981' : burden < 30 ? '#eab308' : '#ef4444';
      }
      if (el_id('miniPayDaily')) el_id('miniPayDaily').textContent = '$' + dailyPayment.toFixed(0);
      if (el_id('miniPayMonthly')) el_id('miniPayMonthly').textContent = '$' + Math.round(monthlyPayment).toLocaleString();
      if (el_id('miniPayTotal')) el_id('miniPayTotal').textContent = term * 21;
      if (el_id('miniPricingFactor')) el_id('miniPricingFactor').textContent = (payback / funding).toFixed(2);
      if (el_id('miniPricingROI')) el_id('miniPricingROI').textContent = roi.toFixed(0) + '%';
      
      // Update PD gauge arc
      const pdArc = document.getElementById('miniPdArc');
      if (pdArc) {
        const pdPercent = pd / 40;
        const offset = 110 - (110 * pdPercent);
        pdArc.setAttribute('stroke-dashoffset', offset);
      }
      
      // Risk level
      const riskLevel = pd < 5 ? 'Low Risk' : pd < 12 ? 'Medium Risk' : pd < 20 ? 'Elevated' : 'High Risk';
      const riskColor = pd < 5 ? '#10b981' : pd < 12 ? '#eab308' : pd < 20 ? '#f97316' : '#ef4444';
      if (el_id('miniRiskLevel')) {
        el_id('miniRiskLevel').textContent = riskLevel;
        el_id('miniRiskLevel').style.color = riskColor;
      }
    }

    window.openAnalyticsModal = openAnalyticsModal;
    window.closeAnalyticsModal = closeAnalyticsModal;
    window.updateAnalyticsCards = updateAnalyticsCards;
    window.removeFromCompare = removeFromCompare;
    window.openSettings = openSettings;
    window.closeSettings = closeSettings;
    window.updateModelWeights = updateModelWeights;
    window.resetModelWeights = resetModelWeights;
    window.updateUnderwritingCriteria = updateUnderwritingCriteria;
    window.resetUnderwritingCriteria = resetUnderwritingCriteria;
    window.toggleModelMode = toggleModelMode;
    window.applyModelPreset = applyModelPreset;
    window.updateAggressiveness = updateAggressiveness;
    window.updateRevenueEmphasis = updateRevenueEmphasis;
    window.updateCreditEmphasis = updateCreditEmphasis;
    window.UNDERWRITING_CRITERIA = UNDERWRITING_CRITERIA;
    window.calculate = calculate;
    window.calculateOverride = calculateOverride;
    window.openSliderModal = openSliderModal;
    window.closeSliderModal = closeSliderModal;
    window.togglePanel = togglePanel;
    window.syncSlider = syncSlider;
    window.syncRadio = syncRadio;
    window.syncIndustry = syncIndustry;
    window.syncOverrideSlider = syncOverrideSlider;
    window.syncOverrideRadio = syncOverrideRadio;
    window.updateFromInput = updateFromInput;
    window.updateFromModalInput = updateFromModalInput;
    window.updateExistingDebtFreq = updateExistingDebtFreq;
    window.syncExistingDebtFreq = syncExistingDebtFreq;
    
    window.ABLESAI_PRO_LOADED = true;
  </script>

<script>
(() => {
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  let lastFocusEl = null;

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function formatBubbleValue(input){
    const id = (input.id || '').toLowerCase();
    const raw = Number(input.value);
    const v = Number.isFinite(raw) ? raw : 0;

    const money = (n) => '$' + Math.round(n).toLocaleString();

    if (id.includes('factor')) return v.toFixed(2) + 'x';
    if (id.includes('term')) return Math.round(v) + ' mo';
    if (id.includes('timeinbusiness')) return Math.round(v) + ' mo';
    if (id.includes('credit')) return String(Math.round(v));
    if (id.includes('revenue') || id.includes('balance') || id.includes('funding') || id.includes('debt')) return money(v);
    if (id.includes('nsf') || id.includes('negative')) return String(Math.round(v));
    return String(v);
  }

  function paintRange(input){
    const min = Number(input.min ?? 0);
    const max = Number(input.max ?? 100);
    const val = Number(input.value ?? 0);
    const pct = (max === min) ? 0 : ((val - min) / (max - min)) * 100;
    const p = clamp(pct, 0, 100);
    input.style.background = `linear-gradient(to right, var(--accent) 0%, var(--accent) ${p}%, var(--slider-track) ${p}%, var(--slider-track) 100%)`;
    input.style.setProperty('--p', p + '%');
    return p;
  }

  function ensureWrap(input){
    if (input.closest('.slider-wrap')) return;

    const wrap = document.createElement('div');
    wrap.className = 'slider-wrap';

    const parent = input.parentNode;
    parent.insertBefore(wrap, input);
    wrap.appendChild(input);

    const bubble = document.createElement('output');
    bubble.className = 'slider-bubble';
    bubble.setAttribute('aria-hidden', 'true');
    wrap.appendChild(bubble);

    const update = () => {
      const p = paintRange(input);
      const bp = clamp(p, 4, 96);
      bubble.textContent = formatBubbleValue(input);
      bubble.style.left = bp + '%';
    };

    input.addEventListener('input', update, { passive: true });
    input.addEventListener('pointerdown', () => wrap.classList.add('dragging'));
    window.addEventListener('pointerup', () => wrap.classList.remove('dragging'));

    update();
  }

  function enhanceAllRanges(){
    $$('.slider[type="range"]').forEach(ensureWrap);
    $$('.slider[type="range"]').forEach(paintRange);
  }

  function syncTabsA11y(){
    const nav = $('nav.tab-nav');
    if (!nav) return;

    const tabs = $$('.tab-btn', nav);
    tabs.forEach(btn => {
      const isActive = btn.classList.contains('active');
      btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      btn.setAttribute('tabindex', isActive ? '0' : '-1');
    });

    const panels = $$('.tab-panel');
    panels.forEach(p => {
      const isActive = p.classList.contains('active');
      p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
    });
  }

  function enableTabKeyboardNav(){
    const nav = $('nav.tab-nav');
    if (!nav) return;

    nav.addEventListener('keydown', (e) => {
      const keys = ['ArrowLeft','ArrowRight','Home','End'];
      if (!keys.includes(e.key)) return;

      const tabs = $$('.tab-btn', nav);
      const activeIndex = Math.max(0, tabs.findIndex(t => t.classList.contains('active')));
      let nextIndex = activeIndex;

      if (e.key === 'ArrowLeft') nextIndex = (activeIndex - 1 + tabs.length) % tabs.length;
      if (e.key === 'ArrowRight') nextIndex = (activeIndex + 1) % tabs.length;
      if (e.key === 'Home') nextIndex = 0;
      if (e.key === 'End') nextIndex = tabs.length - 1;

      e.preventDefault();
      tabs[nextIndex]?.focus();
      tabs[nextIndex]?.click();
    });
  }

  function patchGlobals(){
    if (typeof window.switchTab === 'function'){
      const _switchTab = window.switchTab;
      window.switchTab = function(tabName, evt){
        const r = _switchTab.call(this, tabName, evt);
        syncTabsA11y();
        requestAnimationFrame(enhanceAllRanges);
        return r;
      };
    }

    if (typeof window.openSliderModal === 'function' && typeof window.closeSliderModal === 'function'){
      const _open = window.openSliderModal;
      const _close = window.closeSliderModal;

      window.openSliderModal = function(){
        lastFocusEl = document.activeElement;
        const r = _open.call(this);
        const overlay = $('#sliderModalOverlay');
        if (overlay){
          overlay.setAttribute('aria-hidden', 'false');
          $('.slider-modal-close', overlay)?.focus();
        }
        requestAnimationFrame(enhanceAllRanges);
        return r;
      };

      window.closeSliderModal = function(evt){
        const overlay = $('#sliderModalOverlay');
        const wasActive = overlay?.classList.contains('active');

        const r = _close.call(this, evt);

        const isActive = overlay?.classList.contains('active');
        if (overlay && wasActive && !isActive){
          overlay.setAttribute('aria-hidden', 'true');
          // Restore focus (best-effort)
          if (lastFocusEl && typeof lastFocusEl.focus === 'function') lastFocusEl.focus();
          lastFocusEl = null;
        }

        requestAnimationFrame(enhanceAllRanges);
        return r;
      };

      window.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        const overlay = $('#sliderModalOverlay');
        if (overlay && overlay.classList.contains('active')){
          e.preventDefault();
          window.closeSliderModal();
        }
      });
    }

    if (typeof window.calculate === 'function'){
      const _calc = window.calculate;
      window.calculate = function(...args){
        const r = _calc.apply(this, args);
        enhanceAllRanges();
        return r;
      };
    }

    if (typeof window.calculateOverride === 'function'){
      const _calcO = window.calculateOverride;
      window.calculateOverride = function(...args){
        const r = _calcO.apply(this, args);
        enhanceAllRanges();
        return r;
      };
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    enhanceAllRanges();
    syncTabsA11y();
    enableTabKeyboardNav();
    patchGlobals();
    requestAnimationFrame(enhanceAllRanges);
  });
})();
</script>
</body>
</html>
