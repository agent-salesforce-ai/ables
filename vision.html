<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCA Underwriting Analysis | ABLES.AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="importmap">
        {
            "imports": {
                "@google/genai": "https://esm.run/@anthropic-ai/sdk"
            }
        }
    </script>
    <style>
        :root {
            --primary: #0a0a0a;
            --accent: #eab308;
            --accent-hover: #facc15;
            --success: #059669;
            --success-light: #34d399;
            --success-bg: #ecfdf5;
            --danger: #dc2626;
            --danger-light: #f87171;
            --danger-bg: #fef2f2;
            --warning: #d97706;
            --warning-light: #fbbf24;
            --warning-bg: #fffbeb;
            --info: #0284c7;
            --info-bg: #e0f2fe;
            --purple: #7c3aed;
            --purple-bg: #f3e8ff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header - Light Theme */
        .header {
            background: #ffffff;
            color: var(--gray-800);
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 14px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand-logo {
            display: flex;
            align-items: center;
        }

        .brand-logo svg {
            width: 28px;
            height: 28px;
        }

        .brand-text {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1;
            display: flex;
            align-items: center;
            color: var(--gray-800);
        }

        .brand-text .gold { color: var(--accent); }
        .brand-text .muted { color: var(--gray-400); }
        .brand-text .bank-label { color: var(--gray-400); font-size: 0.55em; font-weight: 400; margin-right: 1px; }

        .header-info {
            text-align: right;
            font-size: 12px;
            color: var(--gray-500);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 32px;
        }

        /* Upload Section - Large Drop Zone */
        .upload-section {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .upload-drop-zone {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            margin: 16px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-drop-zone:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, #fffef5 0%, #fefce8 100%);
        }

        .upload-section.dragover .upload-drop-zone {
            border-color: var(--accent);
            background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%);
            transform: scale(1.01);
        }

        .upload-section.has-files .upload-drop-zone {
            padding: 30px 40px;
        }

        .upload-icon-wrapper {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 24px rgba(234, 179, 8, 0.35);
        }

        .upload-icon {
            width: 36px;
            height: 36px;
            color: #ffffff;
        }

        .upload-text {
            margin-bottom: 0;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: var(--gray-500);
        }

        .upload-input {
            display: none;
        }

        .file-list {
            padding: 16px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #ffffff;
            border-radius: 24px;
            border: 1px solid var(--gray-200);
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-icon {
            width: 20px;
            height: 20px;
            background: var(--success-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success);
        }

        .file-icon svg {
            width: 11px;
            height: 11px;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 11px;
            color: var(--gray-400);
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            margin-left: 4px;
            transition: color 0.2s;
        }

        .file-remove:hover {
            color: var(--danger);
        }

        .file-remove svg {
            width: 14px;
            height: 14px;
        }

        .upload-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .file-count {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .upload-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .upload-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* API Key Section - Orbit/Hubble Pro Style */
        .api-section {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-200);
            padding: 16px 20px;
            margin-bottom: 20px;
        }

        .api-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
        }

        .api-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            background: #ffffff;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .analyze-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
            color: var(--primary);
            padding: 10px 24px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(234, 179, 8, 0.3);
        }

        .analyze-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading Overlay - Full screen */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            max-width: 420px;
        }

        .loading-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 48px;
        }

        .loading-logo-icon {
            font-size: 32px;
        }

        .loading-logo-text {
            font-size: 24px;
            font-weight: 300;
            color: #f5f5f5;
        }

        .loading-logo-text span {
            font-weight: 700;
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid #262626;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 32px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 18px;
            font-weight: 500;
            color: #f5f5f5;
            margin-bottom: 8px;
        }

        .loading-subtitle {
            font-size: 14px;
            color: #666;
        }

        .loading-progress {
            margin-top: 32px;
            width: 200px;
            height: 3px;
            background: #262626;
            border-radius: 2px;
            overflow: hidden;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            animation: loadingPulse 2s ease-in-out infinite;
            width: 40%;
        }

        @keyframes loadingPulse {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(350%); }
        }

        /* Report Container (hidden until analysis complete) */
        .report-container {
            display: none;
        }

        .report-container.visible {
            display: block;
        }

        /* Summary Header - Unified - Orbit/Hubble Pro Style */
        .summary-header {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-200);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .summary-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .business-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .business-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .score-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .score-display {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .score-num {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }

        .score-label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--gray-400);
        }

        .status-pill {
            padding: 5px 12px;
            border-radius: 100px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-pill.review {
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-pill.approve {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-pill.decline {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Metrics Row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 0;
        }

        .metric {
            padding: 10px 8px;
            text-align: center;
            border-right: 1px solid var(--gray-100);
        }

        .metric:last-child {
            border-right: none;
        }

        .metric-label {
            font-size: 8px;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-800);
            font-variant-numeric: tabular-nums;
        }

        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-value.warning { color: var(--warning); }

        /* Sections - Orbit/Hubble Pro Style */
        .section {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .section-badge {
            font-size: 10px;
            background: var(--gray-100);
            color: var(--gray-500);
            padding: 4px 10px;
            border-radius: 100px;
        }

        .tier-badge {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .section-body { padding: 16px; }

        /* Two Column Layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .three-col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 200px;
        }

        .chart-container.tall { height: 260px; }
        .chart-container.short { height: 160px; }

        .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        /* Risk Indicators - Compact */
        .risk-strip {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-top: 12px;
        }

        .risk-chip {
            padding: 8px 6px;
            border-radius: 6px;
            text-align: center;
        }

        .risk-chip.good {
            background: var(--success-bg);
            border: 1px solid #a7f3d0;
        }

        .risk-chip.warn {
            background: var(--warning-bg);
            border: 1px solid #fde68a;
        }

        .risk-chip.bad {
            background: var(--danger-bg);
            border: 1px solid #fecaca;
        }

        .risk-chip.neutral {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
        }

        .risk-chip-value {
            font-size: 14px;
            font-weight: 700;
            line-height: 1;
        }

        .risk-chip.good .risk-chip-value { color: var(--success); }
        .risk-chip.warn .risk-chip-value { color: var(--warning); }
        .risk-chip.bad .risk-chip-value { color: var(--danger); }
        .risk-chip.neutral .risk-chip-value { color: var(--gray-600); }

        .risk-chip-label {
            font-size: 8px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-top: 2px;
            line-height: 1.1;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .data-table tr:hover td { background: var(--gray-50); }

        .data-table .col-group {
            text-align: center;
            border-bottom: 1px solid var(--gray-300);
        }

        .data-table .col-group.credits { background: #ecfdf5; color: var(--success); }
        .data-table .col-group.debits { background: #fef2f2; color: var(--danger); }
        .data-table .col-group.balances { background: #e0f2fe; color: var(--info); }

        .data-table tfoot td {
            font-weight: 700;
        }

        .data-table tfoot tr:first-child td {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .data-table tfoot tr:last-child td {
            background: linear-gradient(90deg, var(--accent) 0%, #d4b03a 100%);
            color: var(--primary);
        }

        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }

        /* Scorecard */
        .scorecard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .scorecard-item {
            background: var(--white);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scorecard-label {
            font-size: 12px;
            color: var(--gray-600);
        }

        .scorecard-value {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 100px;
        }

        .scorecard-value.pass {
            background: var(--success-bg);
            color: var(--success);
        }

        .scorecard-value.fail {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .scorecard-value.warn {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .scorecard-value.neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* Breakdown Items */
        .breakdown-list { margin-top: 12px; }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .breakdown-item:last-child { border-bottom: none; }

        .breakdown-name {
            font-size: 12px;
            color: var(--gray-700);
        }

        .breakdown-data {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breakdown-amt {
            font-size: 13px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .breakdown-pct {
            font-size: 11px;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: 100px;
            min-width: 50px;
            text-align: center;
        }

        /* Stacking Table */
        .stacking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .stacking-table th {
            text-align: left;
            padding: 10px 14px;
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .stacking-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.active { background: var(--success); }
        .status-dot.suspected { background: var(--warning); }
        .status-dot.none { background: var(--gray-300); }

        /* Position Card - Light Theme */
        .position-card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-200);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .position-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .position-amount {
            font-size: 42px;
            font-weight: 800;
            color: var(--success);
            margin-bottom: 4px;
        }

        .position-range {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .position-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .position-metric {
            text-align: center;
            padding: 16px 12px;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
        }

        .position-metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .position-metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--gray-500);
        }

        /* Settings Button & Menu */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-btn {
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 8px 12px;
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--gray-200);
            border-color: var(--gray-300);
            color: var(--gray-700);
        }

        .settings-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .settings-overlay.active {
            display: block;
        }

        .settings-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            z-index: 1000;
            overflow: hidden;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .settings-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .settings-body {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 14px;
            color: var(--gray-700);
        }

        .settings-label-desc {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .settings-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            margin-top: 8px;
            background: var(--white);
            color: var(--gray-900);
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .settings-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .settings-input-row .settings-input {
            margin-top: 0;
            flex: 1;
        }

        .settings-save-btn {
            padding: 10px 16px;
            background: var(--accent);
            color: var(--primary);
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .settings-save-btn:hover {
            background: var(--accent-hover);
        }

        .settings-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            background: white;
            color: var(--gray-800);
            cursor: pointer;
            margin-top: 8px;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .settings-select optgroup {
            font-weight: 600;
            color: var(--gray-700);
        }

        .settings-select option {
            padding: 8px;
        }

        .model-description {
            margin-top: 8px;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--gray-600);
            line-height: 1.4;
        }

        body.dark-theme .settings-select {
            background: #262626;
            border-color: #444;
            color: #e5e5e5;
        }

        body.dark-theme .settings-select optgroup {
            background: #1a1a1a;
            color: #ccc;
        }

        body.dark-theme .settings-select option {
            background: #262626;
            color: #e5e5e5;
        }

        body.dark-theme .model-description {
            background: #333;
            color: #aaa;
        }

        .settings-saved {
            color: var(--success);
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 4px;
        }

        .settings-saved.visible {
            display: flex;
        }

        .settings-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
        }

        .settings-done-btn {
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
            color: var(--primary);
            padding: 10px 24px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .settings-done-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
        }

        body.dark-theme .settings-footer {
            border-color: #333;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--gray-300);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .theme-toggle.dark {
            background: var(--accent);
        }

        .theme-toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #ffffff;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .theme-toggle.dark .theme-toggle-knob {
            transform: translateX(22px);
        }

        .theme-toggle-knob svg {
            width: 12px;
            height: 12px;
            color: var(--gray-500);
        }

        .theme-toggle.dark .theme-toggle-knob svg {
            color: var(--accent);
        }

        /* Dark Theme */
        body.dark-theme {
            background: #0a0a0a;
            color: #f5f5f5;
        }

        body.dark-theme .container {
            background: #0a0a0a;
        }

        body.dark-theme .summary-header,
        body.dark-theme .section,
        body.dark-theme .upload-section,
        body.dark-theme .api-section {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .upload-drop-zone {
            background: linear-gradient(135deg, #262626 0%, #1f1f1f 100%);
            border-color: #444;
        }

        body.dark-theme .upload-drop-zone:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, #2a2a1f 0%, #252520 100%);
        }

        body.dark-theme .upload-section.dragover .upload-drop-zone {
            border-color: var(--accent);
            background: linear-gradient(135deg, #3d3d1f 0%, #4a4a20 100%);
        }

        body.dark-theme .upload-title {
            color: #e5e5e5;
        }

        body.dark-theme .upload-subtitle {
            color: #888;
        }

        body.dark-theme .upload-icon-wrapper {
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
        }

        body.dark-theme .upload-icon {
            color: #1a1a1a;
        }

        body.dark-theme .settings-panel {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .settings-header {
            border-color: #333;
        }

        body.dark-theme .settings-title {
            color: #f5f5f5;
        }

        body.dark-theme .settings-section-title {
            color: #888;
        }

        body.dark-theme .settings-label {
            color: #ccc;
        }

        body.dark-theme .settings-label-desc {
            color: #888;
        }

        body.dark-theme .settings-row {
            border-color: #333;
        }

        body.dark-theme .settings-input {
            background: #262626;
            border-color: #444;
            color: #f5f5f5;
        }

        body.dark-theme .section-header {
            border-color: #333;
        }

        body.dark-theme .section-title {
            color: #e5e5e5;
        }

        body.dark-theme .metric-label {
            color: #888;
        }

        body.dark-theme .metric-value {
            color: #e5e5e5;
        }

        body.dark-theme .data-table th {
            background: #262626;
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .data-table td {
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .data-table tr:hover td {
            background: #262626;
        }

        body.dark-theme .data-table .col-group.credits { background: rgba(5, 150, 105, 0.2); }
        body.dark-theme .data-table .col-group.debits { background: rgba(220, 38, 38, 0.2); }
        body.dark-theme .data-table .col-group.balances { background: rgba(2, 132, 199, 0.2); }

        body.dark-theme .data-table tfoot tr:first-child td {
            background: #374151;
            color: #e5e7eb;
        }

        body.dark-theme .data-table tfoot tr:last-child td {
            background: linear-gradient(90deg, var(--accent) 0%, #d4b03a 100%);
            color: #0a0a0a;
        }

        body.dark-theme .loading-content {
            background: #1a1a1a;
        }

        body.dark-theme .loading-title {
            color: #f5f5f5;
        }

        body.dark-theme .loading-subtitle {
            color: #888;
        }

        body.dark-theme .chart-title {
            color: #ccc;
        }

        body.dark-theme .scorecard {
            background: #333;
        }

        body.dark-theme .scorecard-item {
            background: #1a1a1a;
        }

        body.dark-theme .scorecard-label {
            color: #aaa;
        }

        body.dark-theme .risk-chip.neutral {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .breakdown-item {
            border-color: #333;
        }

        body.dark-theme .breakdown-name {
            color: #ccc;
        }

        body.dark-theme .breakdown-pct {
            background: #333;
            color: #aaa;
        }

        body.dark-theme .stacking-table th {
            background: #262626;
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .stacking-table td {
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .upload-title,
        body.dark-theme .upload-subtitle {
            color: #ccc;
        }

        body.dark-theme .api-section-title {
            color: #e5e5e5;
        }

        body.dark-theme .api-input {
            background: #262626;
            border-color: #444;
            color: #f5f5f5;
        }

        body.dark-theme .file-item {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .file-name {
            color: #e5e5e5;
        }

        body.dark-theme .file-size {
            color: #888;
        }

        body.dark-theme .upload-footer {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .file-count {
            color: #ccc;
        }

        body.dark-theme .upload-status {
            color: #ccc;
        }

        body.dark-theme #uploadStatusText {
            color: #ccc;
        }

        body.dark-theme .upload-spinner {
            border-color: #444;
            border-top-color: var(--accent);
        }

        body.dark-theme .business-name {
            color: #f5f5f5;
        }

        body.dark-theme .business-meta {
            color: #888;
        }

        body.dark-theme .summary-top {
            border-color: #333;
        }

        body.dark-theme .metric {
            border-color: #333;
        }

        body.dark-theme .error-message {
            background: rgba(220, 38, 38, 0.15);
        }

        body.dark-theme .error-message-text {
            color: #ccc;
        }

        /* Dark theme - Position Card */
        body.dark-theme .position-card {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .position-title {
            color: #e5e5e5;
        }

        body.dark-theme .position-amount {
            color: #f5f5f5;
        }

        body.dark-theme .position-range {
            color: #888;
        }

        body.dark-theme .position-metrics .metric-box {
            background: #262626;
        }

        /* Dark theme - MCA Summary Cards */
        body.dark-theme #mcaSummaryCards > div {
            background: #262626 !important;
        }

        body.dark-theme #mcaSummaryCards > div > div:first-child {
            color: #e5e5e5 !important;
        }

        body.dark-theme #mcaTotalPositions {
            color: #e5e5e5 !important;
        }

        body.dark-theme #mcaDailyBurden {
            color: #f87171 !important;
        }

        body.dark-theme #mcaWeeklyBurden {
            color: #fbbf24 !important;
        }

        body.dark-theme #mcaEstBalance {
            color: #60a5fa !important;
        }

        /* Dark theme - MCA Status Box */
        body.dark-theme #mcaStatusBox {
            background: #262626 !important;
            border-color: #444 !important;
        }

        body.dark-theme #mcaStatusText {
            color: #aaa !important;
        }

        /* Dark theme - MCA Keywords */
        body.dark-theme #mcaKeywords > div {
            background: #262626 !important;
            border-color: #444 !important;
            color: #aaa !important;
        }

        /* Dark theme - Risk Indicators */
        body.dark-theme .risk-chip {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .risk-chip .risk-value {
            color: #e5e5e5;
        }

        body.dark-theme .risk-chip .risk-label {
            color: #888;
        }

        /* Dark theme - Heat Calendar */
        body.dark-theme .heat-day.level-0 {
            background: #262626;
            color: #666;
        }

        body.dark-theme .heat-calendar-header span {
            color: #888;
        }

        /* Dark theme - Underwriter Notes */
        body.dark-theme .notes-section .section-title {
            color: #e5e5e5;
        }

        /* Dark theme - Header light fix */
        body.dark-theme .header {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .brand-text {
            color: #f5f5f5;
        }

        body.dark-theme .header-info {
            color: #888;
        }

        body.dark-theme .settings-btn {
            background: #262626;
            color: #ccc;
            border-color: #444;
        }

        body.dark-theme .settings-btn:hover {
            background: #333;
            border-color: #555;
        }

        /* Dark theme - Section badges */
        body.dark-theme .section-badge {
            background: #262626;
            color: #ccc;
            border-color: #444;
        }

        /* Dark theme - Table foot */
        body.dark-theme .stacking-table tfoot {
            background: #262626 !important;
        }

        body.dark-theme .stacking-table tfoot td {
            color: #e5e5e5;
        }

        /* Dark theme - Charts text */
        body.dark-theme canvas {
            filter: none;
        }

        /* Dark theme - Scorecard values (PASS/FAIL/WARN boxes) */
        body.dark-theme .scorecard-value.pass {
            background: rgba(5, 150, 105, 0.2);
            color: #34d399;
            border: 1px solid rgba(5, 150, 105, 0.4);
        }

        body.dark-theme .scorecard-value.fail {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
            border: 1px solid rgba(220, 38, 38, 0.4);
        }

        body.dark-theme .scorecard-value.warn {
            background: rgba(217, 119, 6, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(217, 119, 6, 0.4);
        }

        body.dark-theme .scorecard-value.neutral {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        /* Dark theme - Risk chips with colored backgrounds */
        body.dark-theme .risk-chip.good {
            background: rgba(5, 150, 105, 0.15);
            border-color: rgba(5, 150, 105, 0.4);
        }

        body.dark-theme .risk-chip.good .risk-chip-value {
            color: #34d399;
        }

        body.dark-theme .risk-chip.warn {
            background: rgba(217, 119, 6, 0.15);
            border-color: rgba(217, 119, 6, 0.4);
        }

        body.dark-theme .risk-chip.warn .risk-chip-value {
            color: #fbbf24;
        }

        body.dark-theme .risk-chip.bad {
            background: rgba(220, 38, 38, 0.15);
            border-color: rgba(220, 38, 38, 0.4);
        }

        body.dark-theme .risk-chip.bad .risk-chip-value {
            color: #f87171;
        }

        body.dark-theme .risk-chip.neutral .risk-chip-value {
            color: #aaa;
        }

        body.dark-theme .risk-chip-label {
            color: #888;
        }

        /* Dark theme - Position metrics boxes */
        body.dark-theme .position-metric {
            background: linear-gradient(135deg, #262626 0%, #1f1f1f 100%);
            border-color: #444;
        }

        body.dark-theme .position-metric-value {
            color: #e5e5e5;
        }

        body.dark-theme .position-metric-label {
            color: #888;
        }

        /* Dark theme - Trend arrows */
        body.dark-theme .trend-arrow.up {
            background: rgba(5, 150, 105, 0.2);
            color: #34d399;
        }

        body.dark-theme .trend-arrow.down {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        body.dark-theme .trend-arrow.neutral {
            background: #333;
            color: #aaa;
        }

        /* Dark theme - Red flag alerts */
        body.dark-theme .red-flag-alert {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(220, 38, 38, 0.15) 100%);
            border-color: rgba(248, 113, 113, 0.4);
        }

        body.dark-theme .red-flag-list li {
            color: #ccc;
        }

        /* Dark theme - Breakdown items */
        body.dark-theme .breakdown-amt {
            color: #e5e5e5;
        }

        /* Dark theme - Status dots */
        body.dark-theme .status-dot.none {
            background: #555;
        }

        /* Dark theme - Text colors */
        body.dark-theme .text-success { color: #34d399; }
        body.dark-theme .text-danger { color: #f87171; }
        body.dark-theme .text-warning { color: #fbbf24; }
        body.dark-theme .text-info { color: #60a5fa; }

        /* Dark theme - Metric positive/negative/warning */
        body.dark-theme .metric-value.positive { color: #34d399; }
        body.dark-theme .metric-value.negative { color: #f87171; }
        body.dark-theme .metric-value.warning { color: #fbbf24; }

        /* Dark theme - Table cells with color coding */
        body.dark-theme td.text-success { color: #34d399; }
        body.dark-theme td.text-danger { color: #f87171; }

        /* Dark theme - Status pills (Manual Review, Approve, Decline) */
        body.dark-theme .status-pill.review {
            background: rgba(217, 119, 6, 0.15);
            color: #fbbf24;
            border-color: rgba(217, 119, 6, 0.5);
        }

        body.dark-theme .status-pill.approve {
            background: rgba(5, 150, 105, 0.15);
            color: #34d399;
            border-color: rgba(5, 150, 105, 0.5);
        }

        body.dark-theme .status-pill.decline {
            background: rgba(220, 38, 38, 0.15);
            color: #f87171;
            border-color: rgba(220, 38, 38, 0.5);
        }

        /* Dark theme - Tier badge */
        body.dark-theme .section-badge.tier-badge {
            background: rgba(5, 150, 105, 0.15) !important;
            color: #34d399 !important;
            border: 1px solid rgba(5, 150, 105, 0.5) !important;
        }

        /* Error Message */
        .error-message {
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .error-message-title {
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 4px;
        }

        .error-message-text {
            font-size: 13px;
            color: var(--gray-700);
        }

        /* Print Stylesheet */
        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .header { position: relative !important; box-shadow: none !important; border-bottom: 2px solid var(--gray-300) !important; }
            .settings-btn, .header-actions button { display: none !important; }
            .upload-section, .settings-overlay, .settings-panel { display: none !important; }
            .report-container { display: block !important; }
            .section { break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px !important; }
            .chart-container { height: 200px !important; }
            .position-card { break-inside: avoid; }
            .action-bar, .new-analysis-btn, .export-btn, .notes-section textarea { display: none !important; }
            .collapsible-header .collapse-icon { display: none !important; }
            .notes-section .notes-content { display: block !important; border: 1px solid var(--gray-300) !important; padding: 12px !important; min-height: auto !important; }
            .keyboard-hint { display: none !important; }
        }

        /* Collapsible Sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header .collapse-icon {
            transition: transform 0.2s ease;
            color: var(--gray-400);
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0 !important;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
        }

        .action-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
        }

        .action-btn.primary:hover {
            background: var(--accent-hover);
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Notes Section */
        .notes-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .notes-section textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-top: 12px;
        }

        .notes-section textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .notes-content {
            white-space: pre-wrap;
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.6;
        }

        /* Trend Arrows */
        .trend-arrow {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .trend-arrow.up {
            color: var(--success);
            background: var(--success-bg);
        }

        .trend-arrow.down {
            color: var(--danger);
            background: var(--danger-bg);
        }

        .trend-arrow.neutral {
            color: var(--gray-500);
            background: var(--gray-100);
        }

        .trend-arrow svg {
            width: 12px;
            height: 12px;
        }

        /* Red Flag Alerts */
        .red-flag-alert {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fca5a5;
            border-left: 4px solid var(--danger);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .red-flag-alert.visible {
            display: block;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .red-flag-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 8px;
        }

        .red-flag-title svg {
            width: 20px;
            height: 20px;
        }

        .red-flag-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .red-flag-list li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-700);
            padding: 4px 0;
        }

        .red-flag-list li::before {
            content: "!";
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Heat Calendar - Compact */
        .heat-calendar {
            display: grid;
            grid-template-columns: repeat(15, 18px);
            gap: 2px;
            margin-top: 8px;
        }

        .heat-calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 18px);
            gap: 2px;
            margin-bottom: 2px;
        }

        .heat-calendar-header span {
            text-align: center;
            font-size: 8px;
            font-weight: 600;
            color: var(--gray-500);
        }

        .heat-day {
            width: 18px;
            height: 18px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: var(--gray-600);
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .heat-day:hover {
            transform: scale(1.3);
            z-index: 1;
        }

        .heat-day.empty {
            background: transparent;
        }

        .heat-day.level-0 { background: var(--gray-100); }
        .heat-day.level-1 { background: #d1fae5; }
        .heat-day.level-2 { background: #6ee7b7; }
        .heat-day.level-3 { background: #34d399; }
        .heat-day.level-4 { background: #10b981; }
        .heat-day.level-5 { background: #059669; color: white; }

        .heat-day.negative { background: #fecaca; }
        .heat-day.very-negative { background: #f87171; color: white; }

        .heat-legend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .heat-legend-item {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .heat-stats {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 16px;
        }

        .heat-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .heat-stat-row:last-child {
            border-bottom: none;
        }

        .heat-stat-label {
            font-size: 13px;
            color: var(--gray-600);
        }

        .heat-stat-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
        }

        body.dark-theme .heat-stats {
            background: #262626;
        }

        body.dark-theme .heat-stat-row {
            border-color: #444;
        }

        body.dark-theme .heat-stat-label {
            color: #aaa;
        }

        body.dark-theme .heat-stat-value {
            color: #e5e5e5;
        }

        /* Math Verification Section */
        .verification-section {
            border: 2px dashed var(--gray-300);
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        }

        .verification-badge {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .verification-badge.verified {
            background: var(--success-bg);
            color: var(--success);
        }

        .verification-badge.error {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .verification-badge.checking {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .verify-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verify-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .verification-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--gray-500);
            font-size: 13px;
        }

        .verification-results {
            padding: 16px;
        }

        .verification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: var(--radius);
            margin-bottom: 8px;
            border: 1px solid var(--gray-200);
        }

        .verification-item:last-child {
            margin-bottom: 0;
        }

        .verification-item-label {
            font-size: 13px;
            color: var(--gray-700);
        }

        .verification-item-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .verification-item-status.pass {
            color: var(--success);
        }

        .verification-item-status.fail {
            color: var(--danger);
        }

        .verification-item-status.warn {
            color: var(--warning);
        }

        .verification-summary {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--gray-700);
            line-height: 1.5;
        }

        body.dark-theme .verification-section {
            background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
            border-color: #444;
        }

        body.dark-theme .verification-badge {
            background: #333;
            color: #aaa;
        }

        body.dark-theme .verification-placeholder {
            color: #888;
        }

        body.dark-theme .verification-item {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .verification-item-label {
            color: #ccc;
        }

        body.dark-theme .verification-summary {
            background: #262626;
            color: #ccc;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Keyboard Shortcuts */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 8px 12px;
            font-size: 12px;
            color: var(--gray-500);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyboard-hint kbd {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: inherit;
            font-size: 11px;
        }

        /* Saved Reports Dropdown */
        .saved-reports-dropdown {
            position: relative;
        }

        .saved-reports-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .saved-reports-menu.visible {
            display: block;
        }

        .saved-report-item {
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
        }

        .saved-report-item:hover {
            background: var(--gray-50);
        }

        .saved-report-item:last-child {
            border-bottom: none;
        }

        .saved-report-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-800);
        }

        .saved-report-date {
            font-size: 11px;
            color: var(--gray-500);
        }

        .saved-report-delete {
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
        }

        .saved-report-delete:hover {
            color: var(--danger);
        }

        /* Editable Fields */
        .editable-field {
            position: relative;
            cursor: pointer;
        }

        .editable-field:hover::after {
            content: "Click to edit";
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 10px;
            color: var(--gray-400);
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .editable-field input {
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: inherit;
            font-weight: inherit;
            font-family: inherit;
            background: #fffef0;
            width: 100%;
        }

        /* Custom Scoring */
        .scoring-weights {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .weight-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .weight-slider label {
            font-size: 12px;
            color: var(--gray-600);
            display: flex;
            justify-content: space-between;
        }

        .weight-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--gray-200);
            appearance: none;
            cursor: pointer;
        }

        .weight-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        /* Dark theme additions */
        body.dark-theme .action-btn {
            background: #262626;
            border-color: #333;
            color: #e5e7eb;
        }

        body.dark-theme .action-btn:hover {
            background: #333;
        }

        body.dark-theme .notes-section {
            background: #1a1a1a;
        }

        body.dark-theme .notes-section textarea {
            background: #262626;
            border-color: #333;
            color: #e5e7eb;
        }

        body.dark-theme .red-flag-alert {
            background: linear-gradient(135deg, #2d1f1f 0%, #3d2020 100%);
            border-color: #7f1d1d;
        }

        body.dark-theme .keyboard-hint {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .saved-reports-menu {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .saved-report-item {
            border-color: #333;
        }

        body.dark-theme .saved-report-item:hover {
            background: #262626;
        }

        /* Transaction Modal */
        .transaction-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .transaction-modal.visible {
            display: flex;
        }

        .transaction-modal-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 95%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .transaction-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .transaction-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .transaction-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-500);
            padding: 4px;
        }

        .transaction-modal-close:hover {
            color: var(--gray-700);
        }

        .transaction-modal-body {
            overflow-y: auto;
            max-height: 60vh;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .transaction-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
        }

        .transaction-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .transaction-table tr:hover td {
            background: var(--gray-50);
        }

        .transaction-table .amount-credit {
            color: var(--success);
            font-weight: 600;
        }

        .transaction-table .amount-debit {
            color: var(--danger);
            font-weight: 600;
        }

        body.dark-theme .transaction-modal-content {
            background: #1a1a1a;
        }

        body.dark-theme .transaction-modal-header {
            border-color: #333;
        }

        body.dark-theme .transaction-modal-title {
            color: #f5f5f5;
        }

        body.dark-theme .transaction-table th {
            background: #262626;
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .transaction-table td {
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .transaction-table tr:hover td {
            background: #262626;
        }

        body.dark-theme .transaction-table .amount-credit {
            color: #34d399;
        }

        body.dark-theme .transaction-table .amount-debit {
            color: #f87171;
        }

        /* Clickable table cells */
        .data-table td.clickable {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .data-table td.clickable:hover {
            background: var(--gray-100) !important;
            text-decoration: underline;
        }

        body.dark-theme .data-table td.clickable:hover {
            background: #333 !important;
        }

        /* Comparison Modal */
        .comparison-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .comparison-modal.visible {
            display: flex;
        }

        .comparison-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .comparison-title {
            font-size: 18px;
            font-weight: 700;
        }

        .comparison-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-500);
            padding: 8px;
        }

        .comparison-body {
            padding: 24px;
        }

        .comparison-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .comparison-selector select {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .comparison-card {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 20px;
        }

        .comparison-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-800);
        }

        .comparison-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .comparison-metric:last-child {
            border-bottom: none;
        }

        .comparison-metric-label {
            color: var(--gray-600);
            font-size: 13px;
        }

        .comparison-metric-value {
            font-weight: 600;
            font-size: 14px;
        }

        .comparison-better {
            color: var(--success);
        }

        .comparison-worse {
            color: var(--danger);
        }

        body.dark-theme .comparison-content {
            background: #1a1a1a;
        }

        body.dark-theme .comparison-card {
            background: #262626;
        }

        body.dark-theme .comparison-header {
            border-color: #333;
        }

        body.dark-theme .comparison-title {
            color: #f5f5f5;
        }

        body.dark-theme .comparison-card-title {
            color: #e5e5e5;
        }

        body.dark-theme .comparison-metric-label {
            color: #888;
        }

        body.dark-theme .comparison-metric-value {
            color: #e5e5e5;
        }

        body.dark-theme .comparison-better {
            color: #34d399;
        }

        body.dark-theme .comparison-worse {
            color: #f87171;
        }

        body.dark-theme .comparison-selector select {
            background: #262626;
            border-color: #444;
            color: #e5e5e5;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-row { grid-template-columns: repeat(5, 1fr); }
            .risk-strip { grid-template-columns: repeat(4, 1fr); }
            .position-metrics { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header-inner { flex-direction: column; gap: 12px; padding: 16px; }
            .two-col, .three-col { grid-template-columns: 1fr; }
            .metrics-row { grid-template-columns: repeat(2, 1fr); }
            .risk-strip { grid-template-columns: repeat(2, 1fr); }
            .scorecard { grid-template-columns: 1fr; }
            .api-input-group { flex-direction: column; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-inner">
        <div class="brand">
            <div class="brand-logo">
                <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="planetGrad" cx="35%" cy="35%" r="60%">
                            <stop offset="0%" stop-color="#fcd34d"/>
                            <stop offset="50%" stop-color="#eab308"/>
                            <stop offset="100%" stop-color="#ca8a04"/>
                        </radialGradient>
                        <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#ffab40"/>
                            <stop offset="50%" stop-color="#ff8c00"/>
                            <stop offset="100%" stop-color="#ff6d00"/>
                        </linearGradient>
                    </defs>
                    <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" opacity="0.6"/>
                    <circle cx="32" cy="32" r="12" fill="url(#planetGrad)"/>
                    <ellipse cx="28" cy="28" rx="4" ry="3" fill="#fef3c7" opacity="0.4"/>
                    <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
                    <circle cx="54" cy="26" r="3" fill="#a855f7"/>
                </svg>
            </div>
            <div class="brand-text"><span class="bank-label">bank</span>Ables<span class="muted">AI</span></div>
        </div>
        <div class="header-actions">
            <div class="header-info" id="reportDate">
                <!-- Date will be filled dynamically -->
            </div>
            <button class="settings-btn" onclick="openSettings()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Settings
            </button>
        </div>
    </div>
</header>

<!-- Settings Overlay -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>

<!-- Settings Panel -->
<div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
        <h3 class="settings-title">Settings</h3>
        <button class="settings-close" onclick="closeSettings()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    <div class="settings-body">
        <div class="settings-section">
            <div class="settings-section-title">Appearance</div>
            <div class="settings-row">
                <div>
                    <div class="settings-label">Dark Mode</div>
                    <div class="settings-label-desc">Switch between light and dark themes</div>
                </div>
                <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                    <div class="theme-toggle-knob">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">API Configuration</div>
            <div class="settings-label">Gemini API Key</div>
            <div class="settings-label-desc">Your API key is stored locally in your browser</div>
            <div class="settings-input-row">
                <input type="password" class="settings-input" id="settingsApiKey" placeholder="Enter your Gemini API key (AIza...)">
                <button class="settings-save-btn" onclick="saveApiKey()">Save</button>
            </div>
            <div class="settings-saved" id="apiKeySaved">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
                API key saved
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Model Selection</div>
            <div class="settings-label">Gemini Model</div>
            <div class="settings-label-desc">Choose the AI model for analysis</div>
            <select class="settings-select" id="modelSelect" onchange="saveModelSelection()">
                <optgroup label="Gemini 3 (Latest)">
                    <option value="gemini-3-pro-preview">Gemini 3 Pro (Recommended)</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash (Faster)</option>
                </optgroup>
                <optgroup label="Gemini 2.5">
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                </optgroup>
                <optgroup label="Agents (Interactions API)">
                    <option value="agent:deep-research-pro-preview-12-2025">Deep Research Agent</option>
                </optgroup>
            </select>
            <div class="model-description" id="modelDescription">
                Best for comprehensive bank statement analysis with high accuracy.
            </div>
        </div>
    </div>
    <div class="settings-footer">
        <button class="settings-done-btn" onclick="saveApiKey()">Save & Close</button>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-logo">
            <span class="loading-logo-icon"></span>
            <span class="loading-logo-text">Bank<span>Ables</span>AI</span>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-title">Analyzing Statements</div>
        <div class="loading-subtitle" id="loadingStatus">Preparing documents...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>
</div>

<main class="container">

    <!-- Error Message -->
    <div class="error-message" id="errorMessage">
        <div class="error-message-title">Analysis Error</div>
        <div class="error-message-text" id="errorText"></div>
    </div>

    <!-- Upload Section - Large Drop Zone -->
    <div class="upload-section" id="uploadSection">
        <input type="file" id="fileInput" class="upload-input" multiple accept=".pdf,.png,.jpg,.jpeg,.csv">
        <div class="upload-drop-zone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon-wrapper">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
            </div>
            <div class="upload-text">
                <div class="upload-title">Drop bank statements here</div>
                <div class="upload-subtitle">or click to browse. Supports PDF, PNG, JPG, CSV</div>
            </div>
        </div>
        <div class="file-list" id="fileList"></div>
        <div class="upload-footer" id="uploadFooter" style="display: none;">
            <div class="file-count" id="fileCount">0 files selected</div>
            <div class="upload-status" id="uploadStatus" style="display: none;">
                <div class="upload-spinner"></div>
                <span id="uploadStatusText">Analyzing statements...</span>
            </div>
        </div>
    </div>

    <!-- Hidden API Key Input (used by JS) -->
    <input type="hidden" id="apiKey">

    <!-- Report Container (hidden until analysis complete) -->
    <div class="report-container" id="reportContainer">

        <!-- Action Bar -->
        <div class="action-bar" id="actionBar">
            <button class="action-btn primary" onclick="newAnalysis()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                New Analysis
            </button>
            <button class="action-btn" onclick="exportToPDF()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                Export PDF
            </button>
            <button class="action-btn" onclick="saveReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                </svg>
                Save Report
            </button>
            <div class="saved-reports-dropdown">
                <button class="action-btn" onclick="toggleSavedReports()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                    </svg>
                    Load Report
                </button>
                <div class="saved-reports-menu" id="savedReportsMenu">
                    <!-- Saved reports will be populated dynamically -->
                </div>
            </div>
            <button class="action-btn" onclick="printReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0021 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 00-1.913-.247M6.34 18H5.25A2.25 2.25 0 013 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 011.913-.247m10.5 0a48.536 48.536 0 00-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5zm-3 0h.008v.008H15V10.5z" />
                </svg>
                Print
            </button>
            <button class="action-btn" onclick="openComparisonMode()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605" />
                </svg>
                Compare
            </button>
        </div>

        <!-- Red Flag Alerts -->
        <div class="red-flag-alert" id="redFlagAlert">
            <div class="red-flag-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                Critical Issues Detected
            </div>
            <ul class="red-flag-list" id="redFlagList">
                <!-- Red flags will be populated dynamically -->
            </ul>
        </div>

        <!-- Unified Summary Header -->
        <div class="summary-header">
            <div class="summary-top">
                <div>
                    <div class="business-name" id="businessName">--</div>
                    <div class="business-meta">
                        <span id="bankAccount">--</span>
                        <span id="statementPeriod">--</span>
                        <span id="industryType">--</span>
                    </div>
                </div>
                <div class="score-group">
                    <div class="score-display">
                        <span class="score-num" id="overallScore">--</span>
                        <span class="score-label">Score</span>
                    </div>
                    <span class="status-pill review" id="statusPill">--</span>
                </div>
            </div>
            <div class="metrics-row" id="metricsRow">
                <!-- Metrics will be populated dynamically -->
            </div>
        </div>

        <!-- Account Summary -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Account Summary</h2>
                <span class="section-badge" id="accountBadge">--</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align: bottom;">Month</th>
                                <th colspan="3" class="col-group credits">Credits</th>
                                <th colspan="3" class="col-group debits">Debits</th>
                                <th colspan="4" class="col-group balances">Balances</th>
                                <th colspan="2" class="col-group debits">Issues</th>
                            </tr>
                            <tr>
                                <th>Total</th>
                                <th>True</th>
                                <th>#</th>
                                <th>Total</th>
                                <th>True</th>
                                <th>#</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Avg</th>
                                <th>Min</th>
                                <th>NSF</th>
                                <th>OD</th>
                            </tr>
                        </thead>
                        <tbody id="accountTableBody">
                            <!-- Rows will be populated dynamically -->
                        </tbody>
                        <tfoot id="accountTableFoot">
                            <!-- Totals will be populated dynamically -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- Risk Indicators -->
        <div class="section" style="padding: 0;">
            <div class="section-body" style="padding: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px;">Risk Indicators</span>
                    <span style="flex: 1; height: 1px; background: var(--gray-200);"></span>
                </div>
                <div class="risk-strip" id="riskStrip">
                    <!-- Risk chips will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Payment Capacity Analysis -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Payment Capacity Analysis</h2>
                <span class="section-badge">Debt Service</span>
            </div>
            <div class="section-body">
                <div class="three-col">
                    <div>
                        <div class="chart-title">Holdback Scenarios</div>
                        <div class="chart-container">
                            <canvas id="holdbackChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Daily Payment Capacity</div>
                        <div class="chart-container">
                            <canvas id="capacityGauge"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Revenue vs Payment Load</div>
                        <div class="chart-container">
                            <canvas id="loadChart"></canvas>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <div class="scorecard" id="paymentScorecard">
                        <!-- Payment scorecard will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Underwriting Scorecard -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Underwriting Scorecard</h2>
                <span class="section-badge">Pass/Fail Criteria</span>
            </div>
            <div class="section-body">
                <div class="scorecard" id="underwritingScorecard">
                    <!-- Scorecard items will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Cash Flow Trends -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Daily Cash Flow Analysis</h2>
                <span class="section-badge" id="periodBadge">--</span>
            </div>
            <div class="section-body">
                <div class="two-col">
                    <div>
                        <div class="chart-title">Daily Balance Trend</div>
                        <div class="chart-container tall">
                            <canvas id="balanceChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Weekly Deposits vs Withdrawals</div>
                        <div class="chart-container tall">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Revenue Analysis -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Revenue Pattern Analysis</h2>
                <span class="section-badge">Deposit Behavior</span>
            </div>
            <div class="section-body">
                <div class="three-col">
                    <div>
                        <div class="chart-title">Revenue by Day of Week</div>
                        <div class="chart-container">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Deposit Size Distribution</div>
                        <div class="chart-container">
                            <canvas id="depositDistChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Revenue Sources</div>
                        <div class="chart-container">
                            <canvas id="revenueSourceChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="breakdown-list" style="margin-top: 24px;" id="revenueBreakdown">
                    <div class="chart-title">Revenue Source Breakdown</div>
                    <!-- Breakdown items will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Expense Analysis -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Expense Pattern Analysis</h2>
                <span class="section-badge">Outflow Behavior</span>
            </div>
            <div class="section-body">
                <div class="two-col">
                    <div>
                        <div class="chart-title">Expense Categories</div>
                        <div class="chart-container tall">
                            <canvas id="expenseCatChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Fixed vs Variable Expenses</div>
                        <div class="chart-container tall">
                            <canvas id="fixedVarChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="breakdown-list" style="margin-top: 24px;" id="expenseBreakdown">
                    <div class="chart-title">Expense Category Breakdown</div>
                    <!-- Breakdown items will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- MCA Stacking Detection - Enhanced -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">MCA / Loan Stacking Analysis</h2>
                <span class="section-badge" id="mcaBadge">0 Positions Detected</span>
            </div>
            <div class="section-body">
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;" id="mcaSummaryCards">
                    <div style="background: var(--gray-50); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-800);" id="mcaTotalPositions">0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Active Positions</div>
                    </div>
                    <div style="background: var(--danger-bg); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="mcaDailyBurden">$0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Est. Daily Burden</div>
                    </div>
                    <div style="background: var(--warning-bg); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="mcaWeeklyBurden">$0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Est. Weekly Burden</div>
                    </div>
                    <div style="background: var(--info-bg); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--info);" id="mcaEstBalance">$0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Est. Total Balance</div>
                    </div>
                </div>

                <!-- Detailed Positions Table -->
                <div class="chart-title">Detected MCA/Loan Positions</div>
                <table class="stacking-table" style="margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>Lender Name</th>
                            <th>Frequency</th>
                            <th>Payment Amount</th>
                            <th>Est. Remaining Balance</th>
                            <th>Est. Payoff Date</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="mcaTableBody">
                        <!-- MCA rows will be populated dynamically -->
                    </tbody>
                    <tfoot id="mcaTableFoot" style="background: var(--gray-100); font-weight: 600;">
                        <!-- Totals row -->
                    </tfoot>
                </table>

                <div class="two-col">
                    <div>
                        <div class="chart-title">Payment Timeline</div>
                        <div class="chart-container">
                            <canvas id="mcaTimelineChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Burden by Lender</div>
                        <div class="chart-container">
                            <canvas id="mcaBurdenChart"></canvas>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 16px; border-radius: var(--radius); border: 1px solid;" id="mcaStatusBox">
                    <div style="font-size: 13px; font-weight: 600;" id="mcaStatusTitle">--</div>
                    <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;" id="mcaStatusText">--</div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="chart-title">Known MCA Lender Patterns Scanned</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;" id="mcaKeywords">
                        <!-- MCA keywords will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Industry Benchmarks -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Industry Benchmarks Comparison</h2>
                <span class="section-badge" id="benchmarkIndustry">--</span>
            </div>
            <div class="section-body">
                <div class="two-col">
                    <div>
                        <div class="chart-title">This Business vs Industry Average</div>
                        <div class="chart-container tall">
                            <canvas id="benchmarkChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Performance Percentile</div>
                        <div class="chart-container tall">
                            <canvas id="percentileChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Heat Calendar Section -->
        <section class="section">
            <div class="section-header collapsible-header" onclick="toggleSection(this)">
                <h2 class="section-title">Daily Activity Heat Map</h2>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </div>
            <div class="section-body collapsible-content" id="heatCalendarSection">
                <div class="two-col" style="gap: 32px; align-items: start;">
                    <div>
                        <div class="chart-title">Balance Activity by Day</div>
                        <div class="heat-calendar-header">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div class="heat-calendar" id="heatCalendar">
                            <!-- Heat calendar will be populated dynamically -->
                        </div>
                        <div class="heat-legend">
                            <span>Less</span>
                            <div class="heat-legend-item level-0"></div>
                            <div class="heat-legend-item level-1"></div>
                            <div class="heat-legend-item level-2"></div>
                            <div class="heat-legend-item level-3"></div>
                            <div class="heat-legend-item level-4"></div>
                            <div class="heat-legend-item level-5"></div>
                            <span>More</span>
                            <span style="margin-left: 16px;">|</span>
                            <div class="heat-legend-item negative"></div>
                            <div class="heat-legend-item very-negative"></div>
                            <span>Negative</span>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Daily Balance Statistics</div>
                        <div class="heat-stats" id="heatStats">
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Highest Balance Day</span>
                                <span class="heat-stat-value text-success" id="highestBalanceDay">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Lowest Balance Day</span>
                                <span class="heat-stat-value text-danger" id="lowestBalanceDay">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Days with Negative Balance</span>
                                <span class="heat-stat-value" id="negativeDaysCount">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Days Below $500</span>
                                <span class="heat-stat-value" id="lowBalanceDaysCount">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Average Daily Balance</span>
                                <span class="heat-stat-value" id="avgDailyBalance">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Balance Volatility</span>
                                <span class="heat-stat-value" id="balanceVolatility">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recommended Position -->
        <div class="position-card">
            <div class="position-header">
                <div class="position-title">Recommended Position</div>
                <span class="section-badge tier-badge" id="tierBadge">--</span>
            </div>
            <div class="position-amount editable-field" id="recommendedAmount" onclick="makeEditable(this, 'amount')">$--</div>
            <div class="position-range" id="positionRange">--</div>
            <div class="position-metrics" id="positionMetrics">
                <!-- Position metrics will be populated dynamically -->
            </div>
        </div>

        <!-- Math Verification Section -->
        <div class="section verification-section" id="verificationSection">
            <div class="section-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h2 class="section-title">AI Math Verification</h2>
                    <span class="verification-badge" id="verificationBadge">Not Verified</span>
                </div>
                <button class="verify-btn" id="verifyBtn" onclick="runMathVerification()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Verify with AI
                </button>
            </div>
            <div class="section-body">
                <div class="verification-status" id="verificationStatus">
                    <div class="verification-placeholder">
                        Click "Verify with AI" to have an agentic model cross-check all calculations and totals.
                    </div>
                </div>
                <div class="verification-results" id="verificationResults" style="display: none;">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="section-header">
                <h2 class="section-title">Underwriter Notes</h2>
            </div>
            <textarea id="underwriterNotes" placeholder="Add your observations, concerns, or recommendations here..."></textarea>
            <div class="notes-content" id="notesContent" style="display: none;"></div>
        </div>

    </div><!-- End Report Container -->

    <!-- Keyboard Hints -->
    <div class="keyboard-hint" id="keyboardHint">
        <kbd>?</kbd> for shortcuts
    </div>

    <!-- Comparison Modal -->
    <div class="comparison-modal" id="comparisonModal" onclick="if(event.target === this) closeComparisonMode()">
        <div class="comparison-content">
            <div class="comparison-header">
                <h3 class="comparison-title">Compare Reports</h3>
                <button class="comparison-close" onclick="closeComparisonMode()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="comparison-body">
                <div class="comparison-selector">
                    <select id="compareSelect1" onchange="updateComparison()">
                        <option value="">Select first business...</option>
                    </select>
                    <select id="compareSelect2" onchange="updateComparison()">
                        <option value="">Select second business...</option>
                    </select>
                </div>
                <div class="comparison-grid" id="comparisonGrid">
                    <div style="text-align: center; color: var(--gray-500); padding: 40px; grid-column: span 2;">
                        Select two saved reports to compare
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="transaction-modal" id="transactionModal" onclick="if(event.target === this) closeTransactionModal()">
        <div class="transaction-modal-content">
            <div class="transaction-modal-header">
                <h3 class="transaction-modal-title" id="transactionModalTitle">Transactions</h3>
                <button class="transaction-modal-close" onclick="closeTransactionModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="transaction-modal-body">
                <table class="transaction-table" id="transactionTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</main>


<script>
    // Global state
    let uploadedFiles = [];
    let chartInstances = {};
    let analysisData = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric'
        });
        setupFileUpload();
        setupAPIKeyValidation();
        loadSettings();
    });

    // Settings Functions
    function openSettings() {
        document.getElementById('settingsOverlay').classList.add('active');
        document.getElementById('settingsPanel').classList.add('active');
        // Load current API key into settings
        const savedKey = localStorage.getItem('geminiApiKey') || '';
        document.getElementById('settingsApiKey').value = savedKey;
        // Load current model selection
        const savedModel = localStorage.getItem('geminiModel') || 'gemini-3-pro-preview';
        document.getElementById('modelSelect').value = savedModel;
        updateModelDescription(savedModel);
    }

    const modelDescriptions = {
        'gemini-3-pro-preview': 'Best for comprehensive bank statement analysis with high accuracy. Recommended for detailed underwriting.',
        'gemini-3-flash-preview': 'Faster processing with good accuracy. Best for quick preliminary analysis.',
        'gemini-2.5-pro': 'Powerful model with adaptive thinking. Great for complex analysis.',
        'gemini-2.5-flash': 'Fast and efficient for high-volume processing tasks.',
        'gemini-2.5-flash-lite': 'Ultra-fast and cost-effective for simple, high-frequency tasks.',
        'agent:deep-research-pro-preview-12-2025': 'Deep Research Agent - Long-running research with thorough investigation. Uses Interactions API.'
    };

    function updateModelDescription(model) {
        const desc = modelDescriptions[model] || 'Select a model for analysis.';
        document.getElementById('modelDescription').textContent = desc;
    }

    function saveModelSelection() {
        const model = document.getElementById('modelSelect').value;
        localStorage.setItem('geminiModel', model);
        updateModelDescription(model);
    }

    function getSelectedModel() {
        return localStorage.getItem('geminiModel') || 'gemini-3-pro-preview';
    }

    function closeSettings() {
        document.getElementById('settingsOverlay').classList.remove('active');
        document.getElementById('settingsPanel').classList.remove('active');
    }

    function saveApiKey() {
        try {
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            localStorage.setItem('geminiApiKey', apiKey);
            // Also update the main input
            const mainInput = document.getElementById('apiKey');
            if (mainInput) mainInput.value = apiKey;
            if (typeof updateAnalyzeButton === 'function') updateAnalyzeButton();
        } catch(e) {
            console.error('Save error:', e);
        }
        // Always close settings panel
        document.getElementById('settingsOverlay').classList.remove('active');
        document.getElementById('settingsPanel').classList.remove('active');
    }

    function toggleTheme() {
        const body = document.body;
        const toggle = document.getElementById('themeToggle');
        const isDark = body.classList.toggle('dark-theme');
        toggle.classList.toggle('dark', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        // Update theme icon
        const themeIcon = document.getElementById('themeIcon');
        if (isDark) {
            themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />';
        } else {
            themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />';
        }

        // Update chart colors for theme
        if (typeof updateChartColors === 'function') {
            updateChartColors();
        }
    }

    function loadSettings() {
        // Load theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('themeToggle').classList.add('dark');
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />';

            // Set chart defaults for dark mode
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#374151';
        }

        // Load API key
        const savedKey = localStorage.getItem('geminiApiKey');
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
            updateAnalyzeButton();
        }
    }

    // File Upload Setup
    function setupFileUpload() {
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
    }

    function handleFiles(files) {
        for (const file of files) {
            if (!uploadedFiles.find(f => f.name === file.name)) {
                uploadedFiles.push(file);
            }
        }
        renderFileList();

        // Auto-analyze after a short delay to let user see the files
        if (uploadedFiles.length > 0) {
            setTimeout(() => {
                autoAnalyze();
            }, 800);
        }
    }

    function autoAnalyze() {
        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            // Show message to configure API key
            document.getElementById('uploadStatus').style.display = 'flex';
            document.getElementById('uploadStatusText').textContent = 'Please configure your Gemini API key in Settings';
            document.getElementById('uploadStatus').querySelector('.upload-spinner').style.display = 'none';
            return;
        }

        // Start analysis automatically
        document.getElementById('apiKey').value = apiKey;
        analyzeDocuments();
    }

    function renderFileList() {
        const fileList = document.getElementById('fileList');
        const uploadSection = document.getElementById('uploadSection');
        const uploadFooter = document.getElementById('uploadFooter');
        const fileCount = document.getElementById('fileCount');

        if (uploadedFiles.length === 0) {
            fileList.innerHTML = '';
            uploadSection.classList.remove('has-files');
            uploadFooter.style.display = 'none';
            return;
        }

        uploadSection.classList.add('has-files');
        uploadFooter.style.display = 'flex';
        fileCount.textContent = `${uploadedFiles.length} file${uploadedFiles.length > 1 ? 's' : ''} selected`;

        fileList.innerHTML = uploadedFiles.map((file, index) => `
            <div class="file-item">
                <div class="file-info">
                    <div class="file-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </div>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                </div>
                <button class="file-remove" onclick="removeFile(${index})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        `).join('');
    }

    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        renderFileList();
        updateAnalyzeButton();
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // API Key Validation
    function setupAPIKeyValidation() {
        const apiKeyInput = document.getElementById('apiKey');
        apiKeyInput.addEventListener('input', updateAnalyzeButton);
    }

    function updateAnalyzeButton() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = !(uploadedFiles.length > 0 && apiKey.length > 10);
    }

    // Main Analysis Function
    async function analyzeDocuments() {
        const apiKey = document.getElementById('apiKey').value.trim();

        if (!apiKey || uploadedFiles.length === 0) {
            showUploadStatus('Please configure API key in Settings');
            return;
        }

        hideError();

        // Show inline loading status below upload box
        showUploadStatus('Preparing documents...');

        try {
            // Convert files to base64 with progress
            const totalFiles = uploadedFiles.length;
            const fileContents = [];

            for (let i = 0; i < uploadedFiles.length; i++) {
                showUploadStatus(`Processing document ${i + 1} of ${totalFiles}...`);
                const file = uploadedFiles[i];
                const base64 = await fileToBase64(file);
                fileContents.push({
                    name: file.name,
                    mimeType: file.type || 'application/pdf',
                    data: base64
                });
            }

            showUploadStatus(`Analyzing ${totalFiles} document${totalFiles > 1 ? 's' : ''} with Gemini AI...`);

            // Call Gemini API with retry logic
            let response;
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    response = await callGeminiAPI(apiKey, fileContents);
                    break; // Success, exit retry loop
                } catch (error) {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        showUploadStatus(`Retry ${retryCount}/${maxRetries}: ${error.message}`);
                        await new Promise(r => setTimeout(r, 2000 * retryCount));
                    } else {
                        throw error;
                    }
                }
            }

            showUploadStatus('Generating report...');

            // Parse and render the report
            analysisData = response;
            renderReport(analysisData);

            // Hide upload, show report
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('reportContainer').classList.add('visible');
            document.getElementById('uploadStatus').style.display = 'none';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (error) {
            // Show error in upload status
            showUploadStatus('Analysis failed: ' + error.message, true);
            console.error('Analysis error:', error);
        }
    }

    function showUploadStatus(message, isError = false) {
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadStatusText = document.getElementById('uploadStatusText');
        const spinner = uploadStatus.querySelector('.upload-spinner');

        uploadStatus.style.display = 'flex';
        uploadStatusText.textContent = message;

        if (isError) {
            spinner.style.display = 'none';
            uploadStatusText.style.color = 'var(--danger)';
        } else {
            spinner.style.display = 'block';
            uploadStatusText.style.color = 'var(--accent)';
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function callGeminiAPI(apiKey, files) {
        const prompt = `You are an expert MCA (Merchant Cash Advance) underwriter. Analyze ALL the bank statement documents provided and extract all relevant financial data. You may receive multiple bank statements covering different months - analyze ALL of them and combine the data.

Return a JSON object with EXACTLY this structure (no markdown, just pure JSON):

{
    "businessInfo": {
        "name": "Business Name from statements",
        "bankName": "Bank name",
        "accountNumber": "Last 4 digits like ****1234",
        "industry": "Best guess of industry type based on transaction descriptions",
        "statementPeriod": "e.g., Jul-Sep 2025 (show full range if multiple months)",
        "totalDays": 90
    },
    "monthlySummary": [
        {
            "month": "Jul 2025",
            "totalCredits": 8539,
            "trueCredits": 8539,
            "creditCount": 57,
            "totalDebits": 8901,
            "trueDebits": 8901,
            "debitCount": 48,
            "startBalance": 1329,
            "endBalance": 967,
            "avgBalance": 571,
            "minBalance": 116,
            "nsfCount": 2,
            "overdraftCount": 1,
            "credits": [
                {"date": "Jul 1", "description": "DEPOSIT ACH SQUARE INC", "amount": 1234.56},
                {"date": "Jul 3", "description": "DEPOSIT STRIPE TRANSFER", "amount": 567.89}
            ],
            "debits": [
                {"date": "Jul 2", "description": "ACH DEBIT RENT PAYMENT", "amount": 2500.00},
                {"date": "Jul 5", "description": "WIRE OUT VENDOR PYMT", "amount": 1200.00}
            ]
        }
    ],
    "riskIndicators": {
        "nsfCount": 0,
        "overdraftCount": 0,
        "negativeDays": 0,
        "lowBalanceDays": 5,
        "mcaFound": 0,
        "achReturns": 0,
        "ownerDrawRatio": 90.7,
        "netMargin": -4.2
    },
    "mcaAnalysis": {
        "positionsFound": [
            {
                "lenderName": "Example Lender Name (e.g., Libertas Funding, Credibly, etc.)",
                "name": "ACH description from statement",
                "frequency": "Daily or Weekly",
                "amount": 150,
                "estimatedBalance": 15000,
                "estimatedPayoffDate": "Mar 2026",
                "confidence": "High, Medium, or Low",
                "firstSeen": "Date first payment appeared",
                "totalPaymentsSeen": 22
            }
        ],
        "lendersScanned": ["Credibly", "Libertas", "Yellowstone", "Fora Financial", "OnDeck", "Kabbage", "BlueVine", "Rapid Finance", "Square Capital", "PayPal Working Capital", "Amazon Lending", "Fundbox", "Kapitus", "CAN Capital", "Forward Financing"],
        "totalMonthlyPayments": 0
    },
    "revenueSources": [
        {"name": "Card Processing", "amount": 4660, "percentage": 54.6},
        {"name": "Other Deposits", "amount": 3879, "percentage": 45.4}
    ],
    "expenseCategories": [
        {"name": "Owner Draws/Wire Transfers", "amount": 8075, "percentage": 90.7},
        {"name": "POS/Debit Purchases", "amount": 386, "percentage": 4.3},
        {"name": "Processing/Bank Fees", "amount": 265, "percentage": 3.0},
        {"name": "Vendor Payments", "amount": 175, "percentage": 2.0}
    ],
    "cashFlowData": {
        "dailyBalances": [1329, 1245, 980, 856, 723, 612, 534, 445, 389, 320, 567, 645, 578, 489, 423, 356, 298, 234, 189, 156, 134, 116, 245, 378, 456, 534, 623, 712, 834, 912, 967],
        "weeklyDeposits": [2134, 2256, 1987, 1823, 339],
        "weeklyWithdrawals": [2456, 2178, 2234, 1845, 188],
        "dayOfWeekRevenue": [1245, 1089, 1356, 1423, 1678, 1234, 514]
    },
    "depositDistribution": {
        "ranges": ["$0-50", "$51-100", "$101-200", "$201-500", "$500+"],
        "counts": [12, 18, 15, 8, 4]
    },
    "underwritingScore": {
        "overall": 72,
        "recommendation": "Manual Review",
        "tier": 2,
        "criteria": [
            {"name": "Minimum Monthly Revenue ($5,000)", "passed": true, "value": "$8,539"},
            {"name": "Minimum Average Balance ($250)", "passed": true, "value": "$571"},
            {"name": "Maximum NSF Count (3)", "passed": true, "value": "0"},
            {"name": "No Negative Balance Days", "passed": true, "value": "0 days"},
            {"name": "Deposit Consistency (Min 20/mo)", "passed": true, "value": "57"},
            {"name": "No Existing MCA Stacking", "passed": true, "value": "None Found"},
            {"name": "Positive Net Cash Flow", "passed": false, "value": "-$362"},
            {"name": "Owner Draw Ratio (<50%)", "passed": false, "value": "90.7%"}
        ]
    },
    "recommendedPosition": {
        "amount": 8500,
        "rangeMin": 5000,
        "rangeMax": 12000,
        "factorRate": 1.35,
        "paybackAmount": 11475,
        "dailyPayment": 76,
        "termDays": 150
    },
    "paymentCapacity": {
        "maxDaily10Pct": 28,
        "maxDaily15Pct": 42,
        "maxWeekly": 196,
        "recommendedHoldback": 12,
        "dailyRevenue": 276
    },
    "benchmarks": {
        "businessScores": [65, 85, 45, 35, 80, 92],
        "industryAvg": [70, 60, 60, 55, 70, 75],
        "percentiles": [42, 78, 35, 72, 58]
    }
}

IMPORTANT INSTRUCTIONS:
1. Analyze ALL uploaded documents - there may be multiple months of bank statements
2. Create a separate entry in monthlySummary for EACH month found
3. The cashFlowData.dailyBalances should contain ALL daily balances across all months (concatenated)
4. Sum up weeklyDeposits and weeklyWithdrawals across all statement periods
5. Calculate totalDays as the sum of all days covered
6. Fill in actual values from the statements. If you cannot determine a value, use reasonable estimates
7. Always return valid JSON with no markdown formatting

MCA/LOAN STACKING ANALYSIS - CRITICAL:
8. Look for recurring ACH debits with patterns matching known MCA lenders:
   - Daily payments of $50-$1000 (typical MCA pattern)
   - Weekly payments of $250-$5000
   - Keywords: Libertas, Yellowstone, Credibly, OnDeck, Kapitus, CAN Capital, Rapid Finance, Fundbox, BlueVine, PayPal WC, Square Capital, Amazon, Kabbage, Forward, Clearco, Fora, Reliant
9. For EACH detected MCA position, provide:
   - lenderName: Best guess of actual lender name based on ACH description
   - name: Exact ACH description from statement
   - frequency: "Daily" or "Weekly"
   - amount: Payment amount per occurrence
   - estimatedBalance: Estimate remaining balance (payment * estimated remaining payments, typically 3-6 months of daily payments)
   - estimatedPayoffDate: Estimate when position pays off based on first seen date and typical 6-12 month terms
   - confidence: "High" if clear lender match, "Medium" if pattern matches but lender unclear, "Low" if uncertain
10. If NO MCA positions are found, return an empty positionsFound array - do not make up positions
11. Be thorough - scan ALL recurring ACH debits for potential MCA patterns`;

        // Build the parts array for Gemini
        const parts = [{ text: prompt }];

        for (const file of files) {
            parts.push({
                inline_data: {
                    mime_type: file.mimeType,
                    data: file.data
                }
            });
        }

        const selectedModel = getSelectedModel();
        let response;

        // Check if using Interactions API (agents)
        if (selectedModel.startsWith('agent:')) {
            const agentId = selectedModel.replace('agent:', '');
            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/interactions?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    agent: agentId,
                    contents: [{
                        parts: parts
                    }]
                })
            });
        } else {
            // Standard generateContent API
            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: parts
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 16384
                    }
                })
            });
        }

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'API request failed');
        }

        const data = await response.json();

        // Extract text from response
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) {
            throw new Error('No response from Gemini API');
        }

        // Parse JSON from response (handle markdown code blocks)
        let jsonStr = text;
        if (text.includes('```json')) {
            jsonStr = text.split('```json')[1].split('```')[0];
        } else if (text.includes('```')) {
            jsonStr = text.split('```')[1].split('```')[0];
        }

        // Clean up common JSON issues
        jsonStr = jsonStr.trim();

        // Try to fix truncated JSON by finding the last complete object
        try {
            return JSON.parse(jsonStr);
        } catch (e) {
            console.log('Initial parse failed, attempting to fix JSON...');
            console.log('Raw response (first 500):', jsonStr.substring(0, 500));
            console.log('Raw response (last 200):', jsonStr.substring(jsonStr.length - 200));

            // Strategy 1: Try to find the last complete structure
            // Look for the last complete property by finding the last ": " followed by a value

            // Remove any incomplete trailing content
            // This handles cases like: ..."value  (truncated mid-string)

            // First, check if we're in the middle of a string
            let lastQuote = jsonStr.lastIndexOf('"');
            let secondLastQuote = jsonStr.lastIndexOf('"', lastQuote - 1);

            // Count quotes to see if we have an unclosed string
            let quoteCount = (jsonStr.match(/(?<!\\)"/g) || []).length;
            if (quoteCount % 2 !== 0) {
                // Odd number of quotes - we're in an unclosed string
                // Find the last opening quote and close it
                jsonStr = jsonStr.substring(0, lastQuote + 1);
                // Add a closing quote if we truncated mid-value
                if (!jsonStr.endsWith('"')) {
                    jsonStr += '"';
                }
            }

            // Remove trailing incomplete key-value pairs
            // Pattern: trailing comma followed by incomplete content
            jsonStr = jsonStr.replace(/,\s*"[^"]*"?\s*:?\s*[^,}\]]*$/g, '');

            // Remove trailing commas before ] or }
            jsonStr = jsonStr.replace(/,\s*([}\]])/g, '$1');

            // Remove trailing comma at end
            jsonStr = jsonStr.replace(/,\s*$/, '');

            // Try to find and close unclosed brackets
            let openBraces = (jsonStr.match(/{/g) || []).length;
            let closeBraces = (jsonStr.match(/}/g) || []).length;
            let openBrackets = (jsonStr.match(/\[/g) || []).length;
            let closeBrackets = (jsonStr.match(/\]/g) || []).length;

            // Add missing closing brackets/braces in correct order
            // We need to close in reverse order of opening
            let stack = [];
            for (let char of jsonStr) {
                if (char === '{') stack.push('}');
                else if (char === '[') stack.push(']');
                else if (char === '}' || char === ']') {
                    if (stack.length > 0 && stack[stack.length - 1] === char) {
                        stack.pop();
                    }
                }
            }

            // Add missing closers in reverse order
            while (stack.length > 0) {
                jsonStr += stack.pop();
            }

            try {
                return JSON.parse(jsonStr);
            } catch (e2) {
                console.error('JSON repair attempt 1 failed:', e2.message);

                // Strategy 2: Try to find the last valid JSON object boundary
                // Look for the last complete object (ends with })
                let lastValidEnd = -1;
                let depth = 0;
                let inString = false;
                let escaped = false;

                for (let i = 0; i < jsonStr.length; i++) {
                    const char = jsonStr[i];

                    if (escaped) {
                        escaped = false;
                        continue;
                    }

                    if (char === '\\') {
                        escaped = true;
                        continue;
                    }

                    if (char === '"') {
                        inString = !inString;
                        continue;
                    }

                    if (inString) continue;

                    if (char === '{' || char === '[') {
                        depth++;
                    } else if (char === '}' || char === ']') {
                        depth--;
                        if (depth === 0) {
                            lastValidEnd = i;
                        }
                    }
                }

                if (lastValidEnd > 0) {
                    try {
                        return JSON.parse(jsonStr.substring(0, lastValidEnd + 1));
                    } catch (e3) {
                        console.error('JSON repair attempt 2 failed:', e3.message);
                    }
                }

                console.log('Final attempted JSON (last 300):', jsonStr.substring(jsonStr.length - 300));
                throw new Error('Failed to parse API response. The response may have been truncated. Please try again.');
            }
        }
    }

    // Render Report Functions
    function renderReport(data) {
        // Ensure all required data structures exist with defaults
        data.businessInfo = data.businessInfo || {};
        data.monthlySummary = data.monthlySummary || [{}];
        data.riskIndicators = data.riskIndicators || {};
        data.mcaAnalysis = data.mcaAnalysis || { positionsFound: [], lendersScanned: [] };
        data.revenueSources = data.revenueSources || [];
        data.expenseCategories = data.expenseCategories || [];
        data.cashFlowData = data.cashFlowData || {};
        data.depositDistribution = data.depositDistribution || { ranges: [], counts: [] };
        data.underwritingScore = data.underwritingScore || { criteria: [] };
        data.recommendedPosition = data.recommendedPosition || {};
        data.paymentCapacity = data.paymentCapacity || {};
        data.benchmarks = data.benchmarks || { businessScores: [], industryAvg: [], percentiles: [] };

        // Ensure arrays have data
        if (!data.cashFlowData.dailyBalances || data.cashFlowData.dailyBalances.length === 0) {
            data.cashFlowData.dailyBalances = [0];
        }
        if (!data.cashFlowData.weeklyDeposits || data.cashFlowData.weeklyDeposits.length === 0) {
            data.cashFlowData.weeklyDeposits = [0];
        }
        if (!data.cashFlowData.weeklyWithdrawals || data.cashFlowData.weeklyWithdrawals.length === 0) {
            data.cashFlowData.weeklyWithdrawals = [0];
        }
        if (!data.cashFlowData.dayOfWeekRevenue || data.cashFlowData.dayOfWeekRevenue.length === 0) {
            data.cashFlowData.dayOfWeekRevenue = [0, 0, 0, 0, 0, 0, 0];
        }
        if (!data.depositDistribution.counts || data.depositDistribution.counts.length === 0) {
            data.depositDistribution.ranges = ['$0-100', '$100-500', '$500+'];
            data.depositDistribution.counts = [1, 1, 1];
        }
        if (!data.benchmarks.businessScores || data.benchmarks.businessScores.length === 0) {
            data.benchmarks.businessScores = [50, 50, 50, 50, 50, 50];
        }
        if (!data.benchmarks.industryAvg || data.benchmarks.industryAvg.length === 0) {
            data.benchmarks.industryAvg = [50, 50, 50, 50, 50, 50];
        }
        if (!data.benchmarks.percentiles || data.benchmarks.percentiles.length === 0) {
            data.benchmarks.percentiles = [50, 50, 50, 50, 50];
        }

        renderBusinessInfo(data);
        renderMetricsRow(data);
        renderAccountTable(data);
        renderRiskIndicators(data);
        renderPaymentCapacity(data);
        renderUnderwritingScorecard(data);
        renderCashFlowCharts(data);
        renderRevenueAnalysis(data);
        renderExpenseAnalysis(data);
        renderMCAAnalysis(data);
        renderBenchmarks(data);
        renderRecommendedPosition(data);
    }

    function renderBusinessInfo(data) {
        const info = data.businessInfo;
        document.getElementById('businessName').textContent = info.name || '--';
        document.getElementById('bankAccount').textContent = `${info.bankName} ${info.accountNumber}`;
        document.getElementById('statementPeriod').textContent = info.statementPeriod;
        document.getElementById('industryType').textContent = info.industry;
        document.getElementById('accountBadge').textContent = `${info.bankName} ${info.accountNumber}`;
        document.getElementById('periodBadge').textContent = `${info.totalDays} Days`;
        document.getElementById('benchmarkIndustry').textContent = info.industry;

        // Score and status
        const score = data.underwritingScore;
        document.getElementById('overallScore').textContent = score.overall;

        const statusPill = document.getElementById('statusPill');
        statusPill.textContent = score.recommendation;
        statusPill.className = 'status-pill';
        if (score.recommendation.toLowerCase().includes('approve')) {
            statusPill.classList.add('approve');
        } else if (score.recommendation.toLowerCase().includes('decline')) {
            statusPill.classList.add('decline');
        } else {
            statusPill.classList.add('review');
        }
    }

    function renderMetricsRow(data) {
        // Calculate totals across all months
        const totals = data.monthlySummary.reduce((acc, row) => ({
            totalCredits: (acc.totalCredits || 0) + (row.totalCredits || 0),
            totalDebits: (acc.totalDebits || 0) + (row.totalDebits || 0),
            creditCount: (acc.creditCount || 0) + (row.creditCount || 0),
            avgBalance: row.avgBalance || acc.avgBalance || 0,
            minBalance: Math.min(acc.minBalance || Infinity, row.minBalance || Infinity)
        }), {});

        const cashFlow = (totals.totalCredits || 0) - (totals.totalDebits || 0);
        const avgDeposit = totals.creditCount > 0 ? Math.round(totals.totalCredits / totals.creditCount) : 0;
        const totalDays = data.businessInfo.totalDays || 30;
        const consistency = totalDays > 0 ? Math.round((totals.creditCount / totalDays) * 100) : 0;
        const minBal = totals.minBalance === Infinity ? 0 : totals.minBalance;
        const avgBal = totals.avgBalance || 0;

        const metrics = [
            { label: 'Revenue', value: formatCurrency(totals.totalCredits || 0), class: 'positive' },
            { label: 'Expenses', value: formatCurrency(totals.totalDebits || 0), class: 'negative' },
            { label: 'Cash Flow', value: formatCurrency(cashFlow), class: cashFlow >= 0 ? 'positive' : 'warning' },
            { label: 'Avg Balance', value: formatCurrency(avgBal), class: '' },
            { label: 'Min Balance', value: formatCurrency(minBal), class: minBal < 250 ? 'warning' : '' },
            { label: 'Deposits', value: totals.creditCount || 0, class: '' },
            { label: 'Avg Deposit', value: formatCurrency(avgDeposit), class: '' },
            { label: 'Consistency', value: consistency + '%', class: consistency > 50 ? 'positive' : 'warning' },
            { label: 'Volatility', value: minBal < avgBal * 0.3 ? 'High' : 'Low', class: minBal < avgBal * 0.3 ? 'warning' : 'positive' },
            { label: 'Period', value: totalDays + ' days', class: '' }
        ];

        document.getElementById('metricsRow').innerHTML = metrics.map(m => `
            <div class="metric">
                <div class="metric-label">${m.label}</div>
                <div class="metric-value ${m.class}">${m.value}</div>
            </div>
        `).join('');
    }

    function renderAccountTable(data) {
        const tbody = document.getElementById('accountTableBody');
        const tfoot = document.getElementById('accountTableFoot');
        const numMonths = data.monthlySummary.length;

        tbody.innerHTML = data.monthlySummary.map((row, idx) => {
            const prev = idx > 0 ? data.monthlySummary[idx - 1] : null;
            const creditTrend = prev ? getTrendArrow(row.totalCredits, prev.totalCredits) : '';
            const debitTrend = prev ? getTrendArrow(row.totalDebits, prev.totalDebits) : '';
            const hasCredits = row.credits && row.credits.length > 0;
            const hasDebits = row.debits && row.debits.length > 0;

            const nsfCount = row.nsfCount || 0;
            const odCount = row.overdraftCount || 0;

            return `
            <tr>
                <td>${row.month || '--'}</td>
                <td class="text-success ${hasCredits ? 'clickable' : ''}" ${hasCredits ? `onclick="showTransactions(${idx}, 'credits')"` : ''}>${formatCurrency(row.totalCredits || 0)}${creditTrend}</td>
                <td class="text-success ${hasCredits ? 'clickable' : ''}" ${hasCredits ? `onclick="showTransactions(${idx}, 'credits')"` : ''}>${formatCurrency(row.trueCredits || 0)}</td>
                <td class="${hasCredits ? 'clickable' : ''}" ${hasCredits ? `onclick="showTransactions(${idx}, 'credits')"` : ''}>${row.creditCount || 0}</td>
                <td class="text-danger ${hasDebits ? 'clickable' : ''}" ${hasDebits ? `onclick="showTransactions(${idx}, 'debits')"` : ''}>${formatCurrency(row.totalDebits || 0)}${debitTrend}</td>
                <td class="text-danger ${hasDebits ? 'clickable' : ''}" ${hasDebits ? `onclick="showTransactions(${idx}, 'debits')"` : ''}>${formatCurrency(row.trueDebits || 0)}</td>
                <td class="${hasDebits ? 'clickable' : ''}" ${hasDebits ? `onclick="showTransactions(${idx}, 'debits')"` : ''}>${row.debitCount || 0}</td>
                <td>${formatCurrency(row.startBalance || 0)}</td>
                <td>${formatCurrency(row.endBalance || 0)}</td>
                <td>${formatCurrency(row.avgBalance || 0)}</td>
                <td class="${(row.minBalance || 0) < 250 ? 'text-warning' : ''}">${formatCurrency(row.minBalance || 0)}</td>
                <td class="${nsfCount > 0 ? 'text-danger' : ''}">${nsfCount}</td>
                <td class="${odCount > 0 ? 'text-danger' : ''}">${odCount}</td>
            </tr>
        `}).join('');

        // Calculate totals
        const totals = data.monthlySummary.reduce((acc, row) => ({
            totalCredits: acc.totalCredits + (row.totalCredits || 0),
            trueCredits: acc.trueCredits + (row.trueCredits || 0),
            creditCount: acc.creditCount + (row.creditCount || 0),
            totalDebits: acc.totalDebits + (row.totalDebits || 0),
            trueDebits: acc.trueDebits + (row.trueDebits || 0),
            debitCount: acc.debitCount + (row.debitCount || 0),
            avgBalanceSum: acc.avgBalanceSum + (row.avgBalance || 0),
            nsfCount: acc.nsfCount + (row.nsfCount || 0),
            overdraftCount: acc.overdraftCount + (row.overdraftCount || 0)
        }), { totalCredits: 0, trueCredits: 0, creditCount: 0, totalDebits: 0, trueDebits: 0, debitCount: 0, avgBalanceSum: 0, nsfCount: 0, overdraftCount: 0 });

        const first = data.monthlySummary[0] || {};
        const last = data.monthlySummary[data.monthlySummary.length - 1] || {};
        const minBalanceAll = Math.min(...data.monthlySummary.map(r => r.minBalance || 0));
        const avgBalanceAll = numMonths > 0 ? Math.round(totals.avgBalanceSum / numMonths) : 0;

        // Calculate averages
        const averages = {
            totalCredits: numMonths > 0 ? Math.round(totals.totalCredits / numMonths) : 0,
            trueCredits: numMonths > 0 ? Math.round(totals.trueCredits / numMonths) : 0,
            creditCount: numMonths > 0 ? Math.round(totals.creditCount / numMonths) : 0,
            totalDebits: numMonths > 0 ? Math.round(totals.totalDebits / numMonths) : 0,
            trueDebits: numMonths > 0 ? Math.round(totals.trueDebits / numMonths) : 0,
            debitCount: numMonths > 0 ? Math.round(totals.debitCount / numMonths) : 0
        };

        tfoot.innerHTML = `
            <tr>
                <td>TOTALS</td>
                <td>${formatCurrency(totals.totalCredits)}</td>
                <td>${formatCurrency(totals.trueCredits)}</td>
                <td>${totals.creditCount}</td>
                <td>${formatCurrency(totals.totalDebits)}</td>
                <td>${formatCurrency(totals.trueDebits)}</td>
                <td>${totals.debitCount}</td>
                <td>${formatCurrency(first.startBalance || 0)}</td>
                <td>${formatCurrency(last.endBalance || 0)}</td>
                <td>${formatCurrency(avgBalanceAll)}</td>
                <td>${formatCurrency(minBalanceAll)}</td>
                <td class="${totals.nsfCount > 0 ? 'text-danger' : ''}">${totals.nsfCount}</td>
                <td class="${totals.overdraftCount > 0 ? 'text-danger' : ''}">${totals.overdraftCount}</td>
            </tr>
            <tr>
                <td>AVERAGES</td>
                <td>${formatCurrency(averages.totalCredits)}</td>
                <td>${formatCurrency(averages.trueCredits)}</td>
                <td>${averages.creditCount}</td>
                <td>${formatCurrency(averages.totalDebits)}</td>
                <td>${formatCurrency(averages.trueDebits)}</td>
                <td>${averages.debitCount}</td>
                <td>--</td>
                <td>--</td>
                <td>${formatCurrency(avgBalanceAll)}</td>
                <td>${formatCurrency(minBalanceAll)}</td>
                <td>--</td>
                <td>--</td>
            </tr>
        `;
    }

    function renderRiskIndicators(data) {
        const risk = data.riskIndicators;

        const indicators = [
            { label: 'NSF Items', value: risk.nsfCount, good: risk.nsfCount === 0 },
            { label: 'Overdrafts', value: risk.overdraftCount, good: risk.overdraftCount === 0 },
            { label: 'Neg Days', value: risk.negativeDays, good: risk.negativeDays === 0 },
            { label: 'Low Bal Days', value: risk.lowBalanceDays, good: risk.lowBalanceDays <= 2, warn: risk.lowBalanceDays > 2 && risk.lowBalanceDays <= 5 },
            { label: 'MCA Found', value: risk.mcaFound, good: risk.mcaFound === 0 },
            { label: 'ACH Returns', value: risk.achReturns, good: risk.achReturns === 0 },
            { label: 'Owner Draw', value: risk.ownerDrawRatio + '%', good: risk.ownerDrawRatio < 50, neutral: true },
            { label: 'Net Margin', value: risk.netMargin + '%', good: risk.netMargin > 0, warn: risk.netMargin < 0 }
        ];

        document.getElementById('riskStrip').innerHTML = indicators.map(ind => {
            let chipClass = 'neutral';
            if (ind.good) chipClass = 'good';
            else if (ind.warn) chipClass = 'warn';
            else if (!ind.good && !ind.neutral) chipClass = 'bad';

            return `
                <div class="risk-chip ${chipClass}">
                    <div class="risk-chip-value">${ind.value}</div>
                    <div class="risk-chip-label">${ind.label}</div>
                </div>
            `;
        }).join('');
    }

    function renderPaymentCapacity(data) {
        const cap = data.paymentCapacity || {};

        // Calculate daily revenue if not provided
        if (!cap.dailyRevenue && data.monthlySummary && data.monthlySummary.length > 0) {
            const totalCredits = data.monthlySummary.reduce((sum, m) => sum + (m.totalCredits || 0), 0);
            const totalDays = data.businessInfo.totalDays || 30;
            cap.dailyRevenue = Math.round(totalCredits / totalDays);
        }
        cap.dailyRevenue = cap.dailyRevenue || 100;

        // Calculate payment capacity if not provided
        cap.maxDaily10Pct = cap.maxDaily10Pct || Math.round(cap.dailyRevenue * 0.10);
        cap.maxDaily15Pct = cap.maxDaily15Pct || Math.round(cap.dailyRevenue * 0.15);
        cap.maxWeekly = cap.maxWeekly || Math.round(cap.dailyRevenue * 0.10 * 7);
        cap.recommendedHoldback = cap.recommendedHoldback || 12;

        document.getElementById('paymentScorecard').innerHTML = `
            <div class="scorecard-item">
                <span class="scorecard-label">Max Daily Payment (10%)</span>
                <span class="scorecard-value pass">$${cap.maxDaily10Pct}</span>
            </div>
            <div class="scorecard-item">
                <span class="scorecard-label">Max Daily Payment (15%)</span>
                <span class="scorecard-value warn">$${cap.maxDaily15Pct}</span>
            </div>
            <div class="scorecard-item">
                <span class="scorecard-label">Max Weekly Payment</span>
                <span class="scorecard-value pass">$${cap.maxWeekly}</span>
            </div>
            <div class="scorecard-item">
                <span class="scorecard-label">Recommended Holdback</span>
                <span class="scorecard-value neutral">${cap.recommendedHoldback}%</span>
            </div>
        `;

        // Store calculated values back
        data.paymentCapacity = cap;

        // Render charts
        renderHoldbackChart(cap);
        renderCapacityGauge(data);
        renderLoadChart(data);
    }

    function renderUnderwritingScorecard(data) {
        document.getElementById('underwritingScorecard').innerHTML = data.underwritingScore.criteria.map(c => `
            <div class="scorecard-item">
                <span class="scorecard-label">${c.name}</span>
                <span class="scorecard-value ${c.passed ? 'pass' : 'fail'}">${c.passed ? 'PASS' : 'FAIL'} - ${c.value}</span>
            </div>
        `).join('');
    }

    function renderCashFlowCharts(data) {
        // Daily Balance Chart
        destroyChart('balanceChart');
        chartInstances['balanceChart'] = new Chart(document.getElementById('balanceChart'), {
            type: 'line',
            data: {
                labels: data.cashFlowData.dailyBalances.map((_, i) => i + 1),
                datasets: [{
                    label: 'Daily Balance',
                    data: data.cashFlowData.dailyBalances,
                    borderColor: '#0284c7',
                    backgroundColor: 'rgba(2, 132, 199, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }, {
                    label: 'Low Balance Threshold ($250)',
                    data: Array(data.cashFlowData.dailyBalances.length).fill(250),
                    borderColor: '#d97706',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } } },
                scales: {
                    x: { title: { display: true, text: 'Day of Month' }, grid: { display: false } },
                    y: { title: { display: true, text: 'Balance ($)' }, beginAtZero: true }
                }
            }
        });

        // Weekly Flow Chart
        destroyChart('flowChart');
        chartInstances['flowChart'] = new Chart(document.getElementById('flowChart'), {
            type: 'bar',
            data: {
                labels: data.cashFlowData.weeklyDeposits.map((_, i) => `Week ${i + 1}`),
                datasets: [{
                    label: 'Deposits',
                    data: data.cashFlowData.weeklyDeposits,
                    backgroundColor: '#059669'
                }, {
                    label: 'Withdrawals',
                    data: data.cashFlowData.weeklyWithdrawals,
                    backgroundColor: '#dc2626'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
            }
        });
    }

    function renderRevenueAnalysis(data) {
        // Day of Week Chart
        destroyChart('dayOfWeekChart');
        chartInstances['dayOfWeekChart'] = new Chart(document.getElementById('dayOfWeekChart'), {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Revenue',
                    data: data.cashFlowData.dayOfWeekRevenue,
                    backgroundColor: ['#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#059669', '#10b981']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
            }
        });

        // Deposit Distribution Chart
        destroyChart('depositDistChart');
        chartInstances['depositDistChart'] = new Chart(document.getElementById('depositDistChart'), {
            type: 'doughnut',
            data: {
                labels: data.depositDistribution.ranges,
                datasets: [{
                    data: data.depositDistribution.counts,
                    backgroundColor: ['#e0f2fe', '#7dd3fc', '#38bdf8', '#0284c7', '#0369a1'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } }
            }
        });

        // Revenue Sources Chart
        destroyChart('revenueSourceChart');
        chartInstances['revenueSourceChart'] = new Chart(document.getElementById('revenueSourceChart'), {
            type: 'doughnut',
            data: {
                labels: data.revenueSources.map(s => s.name),
                datasets: [{
                    data: data.revenueSources.map(s => s.amount),
                    backgroundColor: ['#059669', '#10b981', '#34d399', '#6ee7b7'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } }
            }
        });

        // Revenue Breakdown
        const breakdown = document.getElementById('revenueBreakdown');
        breakdown.innerHTML = '<div class="chart-title">Revenue Source Breakdown</div>' +
            data.revenueSources.map(s => `
                <div class="breakdown-item">
                    <span class="breakdown-name">${s.name}</span>
                    <div class="breakdown-data">
                        <span class="breakdown-amt text-success">${formatCurrency(s.amount)}</span>
                        <span class="breakdown-pct">${s.percentage}%</span>
                    </div>
                </div>
            `).join('');
    }

    function renderExpenseAnalysis(data) {
        // Expense Categories Chart
        destroyChart('expenseCatChart');
        chartInstances['expenseCatChart'] = new Chart(document.getElementById('expenseCatChart'), {
            type: 'bar',
            data: {
                labels: data.expenseCategories.map(e => e.name.split('/')[0]),
                datasets: [{
                    data: data.expenseCategories.map(e => e.amount),
                    backgroundColor: ['#dc2626', '#ef4444', '#f87171', '#fca5a5']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true }, y: { grid: { display: false } } }
            }
        });

        // Fixed vs Variable Chart
        destroyChart('fixedVarChart');
        const expenses = data.expenseCategories;
        const variableAmt = expenses.find(e => e.name.toLowerCase().includes('owner') || e.name.toLowerCase().includes('draw'))?.amount || 0;
        const fixedAmt = expenses.find(e => e.name.toLowerCase().includes('fee'))?.amount || 0;
        const operatingAmt = expenses.reduce((sum, e) => sum + e.amount, 0) - variableAmt - fixedAmt;

        chartInstances['fixedVarChart'] = new Chart(document.getElementById('fixedVarChart'), {
            type: 'doughnut',
            data: {
                labels: ['Variable (Owner Draws)', 'Fixed (Fees)', 'Operating'],
                datasets: [{
                    data: [variableAmt, fixedAmt, operatingAmt],
                    backgroundColor: ['#7c3aed', '#a78bfa', '#c4b5fd'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } }
            }
        });

        // Expense Breakdown
        const breakdown = document.getElementById('expenseBreakdown');
        breakdown.innerHTML = '<div class="chart-title">Expense Category Breakdown</div>' +
            data.expenseCategories.map(e => `
                <div class="breakdown-item">
                    <span class="breakdown-name">${e.name}</span>
                    <div class="breakdown-data">
                        <span class="breakdown-amt text-danger">${formatCurrency(e.amount)}</span>
                        <span class="breakdown-pct">${e.percentage}%</span>
                    </div>
                </div>
            `).join('');
    }

    function renderMCAAnalysis(data) {
        const mca = data.mcaAnalysis;
        const positions = mca.positionsFound || [];

        // Update badge
        document.getElementById('mcaBadge').textContent = `${positions.length} Positions Detected`;
        document.getElementById('mcaTotalPositions').textContent = positions.length;

        // Calculate totals
        let totalDailyBurden = 0;
        let totalWeeklyBurden = 0;
        let totalEstBalance = 0;

        positions.forEach(p => {
            const amount = parseFloat(p.amount) || 0;
            const balance = parseFloat(p.estimatedBalance) || 0;

            if (p.frequency === 'Daily') {
                totalDailyBurden += amount;
                totalWeeklyBurden += amount * 5;
            } else if (p.frequency === 'Weekly') {
                totalDailyBurden += amount / 5;
                totalWeeklyBurden += amount;
            } else if (p.frequency === 'Monthly') {
                totalDailyBurden += amount / 22;
                totalWeeklyBurden += amount / 4;
            }
            totalEstBalance += balance;
        });

        // Update summary cards
        document.getElementById('mcaDailyBurden').textContent = formatCurrency(totalDailyBurden);
        document.getElementById('mcaWeeklyBurden').textContent = formatCurrency(totalWeeklyBurden);
        document.getElementById('mcaEstBalance').textContent = formatCurrency(totalEstBalance);

        // Render table
        const tbody = document.getElementById('mcaTableBody');
        const tfoot = document.getElementById('mcaTableFoot');

        if (positions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 30px;">
                        <div style="font-size: 14px; font-weight: 500;">No MCA positions detected</div>
                        <div style="font-size: 12px; margin-top: 4px;">No recurring ACH debits matching known MCA payment patterns were identified.</div>
                    </td>
                </tr>
            `;
            tfoot.innerHTML = '';
        } else {
            tbody.innerHTML = positions.map(p => {
                const confidenceClass = p.confidence === 'High' ? 'text-success' : (p.confidence === 'Medium' ? 'text-warning' : 'text-danger');
                const confidenceIcon = p.confidence === 'High' ? '' : (p.confidence === 'Medium' ? '' : '');
                return `
                <tr>
                    <td style="font-weight: 500;">${p.lenderName || p.name || 'Unknown Lender'}</td>
                    <td>${p.frequency || 'Daily'}</td>
                    <td class="text-danger" style="font-weight: 600;">${formatCurrency(p.amount || 0)}</td>
                    <td>${formatCurrency(p.estimatedBalance || 0)}</td>
                    <td>${p.estimatedPayoffDate || 'Unknown'}</td>
                    <td class="${confidenceClass}">${confidenceIcon} ${p.confidence || 'Low'}</td>
                </tr>
            `}).join('');

            tfoot.innerHTML = `
                <tr>
                    <td>TOTAL (${positions.length} positions)</td>
                    <td>-</td>
                    <td class="text-danger">${formatCurrency(totalDailyBurden)}/day</td>
                    <td>${formatCurrency(totalEstBalance)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `;
        }

        // Status box
        const statusBox = document.getElementById('mcaStatusBox');
        const statusTitle = document.getElementById('mcaStatusTitle');
        const statusText = document.getElementById('mcaStatusText');

        if (positions.length === 0) {
            statusBox.style.background = 'var(--success-bg)';
            statusBox.style.borderColor = '#a7f3d0';
            statusTitle.style.color = 'var(--success)';
            statusTitle.textContent = 'No Stacking Detected';
            statusText.textContent = 'This business appears clear of existing MCA obligations. Low risk for stacking issues.';
        } else if (positions.length <= 2 && totalDailyBurden < 500) {
            statusBox.style.background = 'var(--warning-bg)';
            statusBox.style.borderColor = '#fde68a';
            statusTitle.style.color = 'var(--warning)';
            statusTitle.textContent = `${positions.length} Position(s) - Moderate Risk`;
            statusText.textContent = `Daily payment burden of ${formatCurrency(totalDailyBurden)} detected. Verify payoff dates and consider remaining runway before additional funding.`;
        } else {
            statusBox.style.background = 'var(--danger-bg)';
            statusBox.style.borderColor = '#fca5a5';
            statusTitle.style.color = 'var(--danger)';
            statusTitle.textContent = `${positions.length} Position(s) - High Risk`;
            statusText.textContent = `Heavy stacking detected with ${formatCurrency(totalDailyBurden)}/day burden. Est. total balance: ${formatCurrency(totalEstBalance)}. Exercise extreme caution.`;
        }

        // Render MCA charts
        renderMCACharts(positions);

        // Keywords - show which lenders were found vs scanned
        const lendersScanned = mca.lendersScanned || ['Libertas', 'Yellowstone', 'Credibly', 'OnDeck', 'Kapitus', 'BlueVine', 'Fundbox', 'PayPal WC', 'Square Capital', 'Amazon Lending', 'Kabbage', 'CAN Capital', 'Rapid Finance', 'Forward Financing', 'Clearco'];
        const foundLenders = positions.map(p => (p.lenderName || p.name || '').toLowerCase());

        document.getElementById('mcaKeywords').innerHTML = lendersScanned.map(lender => {
            const isFound = foundLenders.some(f => f.includes(lender.toLowerCase()) || lender.toLowerCase().includes(f));
            return `
                <div style="padding: 6px 10px; background: ${isFound ? 'var(--danger-bg)' : 'var(--gray-50)'}; border-radius: var(--radius); font-size: 11px; color: ${isFound ? 'var(--danger)' : 'var(--gray-600)'}; border: 1px solid ${isFound ? 'var(--danger)' : 'var(--gray-200)'};">
                    <span style="margin-right: 4px;">${isFound ? '' : ''}</span>${lender}${isFound ? ' - FOUND' : ''}
                </div>
            `;
        }).join('');
    }

    function renderMCACharts(positions) {
        // Timeline chart showing payment schedule
        destroyChart('mcaTimelineChart');
        destroyChart('mcaBurdenChart');

        if (positions.length === 0) {
            document.getElementById('mcaTimelineChart').parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--gray-400);">No positions to display</div>';
            document.getElementById('mcaBurdenChart').parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--gray-400);">No positions to display</div>';
            return;
        }

        // Ensure canvas elements exist
        const timelineCanvas = document.getElementById('mcaTimelineChart');
        const burdenCanvas = document.getElementById('mcaBurdenChart');

        if (!timelineCanvas || !burdenCanvas) return;

        // Create burden by lender pie chart
        const colors = ['#dc2626', '#ea580c', '#d97706', '#ca8a04', '#65a30d', '#16a34a', '#0d9488', '#0891b2'];

        chartInstances['mcaBurdenChart'] = new Chart(burdenCanvas, {
            type: 'doughnut',
            data: {
                labels: positions.map(p => p.lenderName || p.name || 'Unknown'),
                datasets: [{
                    data: positions.map(p => parseFloat(p.amount) || 0),
                    backgroundColor: colors.slice(0, positions.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 11 } }
                    }
                }
            }
        });

        // Create payment timeline bar chart
        const monthlyData = positions.map(p => {
            const amount = parseFloat(p.amount) || 0;
            if (p.frequency === 'Daily') return amount * 22;
            if (p.frequency === 'Weekly') return amount * 4;
            return amount;
        });

        chartInstances['mcaTimelineChart'] = new Chart(timelineCanvas, {
            type: 'bar',
            data: {
                labels: positions.map(p => p.lenderName || p.name || 'Unknown'),
                datasets: [{
                    label: 'Est. Monthly Payment',
                    data: monthlyData,
                    backgroundColor: '#dc2626',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '$' + value.toLocaleString()
                        }
                    }
                }
            }
        });
    }

    function renderBenchmarks(data) {
        const bench = data.benchmarks;

        // Radar Chart
        destroyChart('benchmarkChart');
        chartInstances['benchmarkChart'] = new Chart(document.getElementById('benchmarkChart'), {
            type: 'radar',
            data: {
                labels: ['Revenue', 'Deposit Freq', 'Avg Balance', 'Cash Flow', 'Risk Score', 'Consistency'],
                datasets: [{
                    label: 'This Business',
                    data: bench.businessScores,
                    borderColor: '#c9a227',
                    backgroundColor: 'rgba(201, 162, 39, 0.2)',
                    pointBackgroundColor: '#c9a227'
                }, {
                    label: 'Industry Avg',
                    data: bench.industryAvg,
                    borderColor: '#6b7280',
                    backgroundColor: 'rgba(107, 114, 128, 0.1)',
                    pointBackgroundColor: '#6b7280'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } } },
                scales: { r: { beginAtZero: true, max: 100 } }
            }
        });

        // Percentile Chart
        destroyChart('percentileChart');
        chartInstances['percentileChart'] = new Chart(document.getElementById('percentileChart'), {
            type: 'bar',
            data: {
                labels: ['Revenue', 'Deposits', 'Balance', 'Risk', 'Score'],
                datasets: [{
                    label: 'Percentile Rank',
                    data: bench.percentiles,
                    backgroundColor: ['#0284c7', '#059669', '#d97706', '#7c3aed', '#c9a227']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percentile' } } }
            }
        });
    }

    function renderRecommendedPosition(data) {
        const pos = data.recommendedPosition || {};

        // Calculate recommended position if not provided
        if (!pos.amount && data.monthlySummary && data.monthlySummary.length > 0) {
            const avgMonthlyRevenue = data.monthlySummary.reduce((sum, m) => sum + (m.totalCredits || 0), 0) / data.monthlySummary.length;
            pos.amount = Math.round(avgMonthlyRevenue);
            pos.rangeMin = Math.round(avgMonthlyRevenue * 0.5);
            pos.rangeMax = Math.round(avgMonthlyRevenue * 1.5);
        }

        pos.amount = pos.amount || 10000;
        pos.rangeMin = pos.rangeMin || Math.round(pos.amount * 0.5);
        pos.rangeMax = pos.rangeMax || Math.round(pos.amount * 1.5);
        pos.factorRate = pos.factorRate || 1.35;
        pos.paybackAmount = pos.paybackAmount || Math.round(pos.amount * pos.factorRate);
        pos.dailyPayment = pos.dailyPayment || Math.round(pos.paybackAmount / 150);
        pos.termDays = pos.termDays || 150;

        const tier = data.underwritingScore.tier || 2;

        document.getElementById('tierBadge').textContent = `Tier ${tier}`;
        document.getElementById('recommendedAmount').textContent = formatCurrency(pos.amount);
        document.getElementById('positionRange').textContent =
            `Approval Range: ${formatCurrency(pos.rangeMin)} - ${formatCurrency(pos.rangeMax)} | Based on 1x monthly revenue`;

        document.getElementById('positionMetrics').innerHTML = `
            <div class="position-metric">
                <div class="position-metric-value">${pos.factorRate}</div>
                <div class="position-metric-label">Factor Rate</div>
            </div>
            <div class="position-metric">
                <div class="position-metric-value">${formatCurrency(pos.paybackAmount)}</div>
                <div class="position-metric-label">Payback Amount</div>
            </div>
            <div class="position-metric">
                <div class="position-metric-value">$${pos.dailyPayment}/day</div>
                <div class="position-metric-label">Daily Payment</div>
            </div>
            <div class="position-metric">
                <div class="position-metric-value">${pos.termDays} days</div>
                <div class="position-metric-label">Term Length</div>
            </div>
        `;

        // Store back for other functions
        data.recommendedPosition = pos;
    }

    function renderHoldbackChart(cap) {
        const holdbackPcts = [10, 12, 15, 18, 20];
        const dailyPayments = holdbackPcts.map(pct => Math.round(cap.dailyRevenue * pct / 100));

        destroyChart('holdbackChart');
        chartInstances['holdbackChart'] = new Chart(document.getElementById('holdbackChart'), {
            type: 'bar',
            data: {
                labels: holdbackPcts.map(p => p + '%'),
                datasets: [{
                    label: 'Daily Payment',
                    data: dailyPayments,
                    backgroundColor: '#c9a227'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: 'Holdback %' }, grid: { display: false } },
                    y: { title: { display: true, text: 'Daily Payment ($)' }, beginAtZero: true }
                }
            }
        });
    }

    function renderCapacityGauge(data) {
        const proposed = data.recommendedPosition.dailyPayment;
        const available = data.paymentCapacity.dailyRevenue - proposed;

        destroyChart('capacityGauge');
        chartInstances['capacityGauge'] = new Chart(document.getElementById('capacityGauge'), {
            type: 'doughnut',
            data: {
                labels: ['Used Capacity', 'Available'],
                datasets: [{
                    data: [proposed, available],
                    backgroundColor: ['#c9a227', '#e5e7eb'],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });
    }

    function renderLoadChart(data) {
        const daily = data.paymentCapacity.dailyRevenue;
        const proposed = data.recommendedPosition.dailyPayment;

        destroyChart('loadChart');
        chartInstances['loadChart'] = new Chart(document.getElementById('loadChart'), {
            type: 'bar',
            data: {
                labels: ['Revenue', 'Current Load', 'Proposed', 'Remaining'],
                datasets: [{
                    data: [daily, 0, proposed, daily - proposed],
                    backgroundColor: ['#059669', '#6b7280', '#c9a227', '#e5e7eb']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { title: { display: true, text: 'Daily Amount ($)' }, beginAtZero: true }
                }
            }
        });
    }

    // Utility Functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
    }

    function destroyChart(id) {
        if (chartInstances[id]) {
            chartInstances[id].destroy();
            delete chartInstances[id];
        }
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    function updateLoadingStatus(text) {
        document.getElementById('loadingStatus').textContent = text;
    }

    function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = message;
        errorEl.classList.add('visible');
    }

    function hideError() {
        document.getElementById('errorMessage').classList.remove('visible');
    }

    // Initialize Chart.js defaults
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';

    // Update chart colors for dark mode
    function updateChartColors() {
        const isDark = document.body.classList.contains('dark-theme');
        Chart.defaults.color = isDark ? '#9ca3af' : '#6b7280';
        Chart.defaults.borderColor = isDark ? '#374151' : '#e5e7eb';

        // Update all existing charts
        Object.values(chartInstances).forEach(chart => {
            if (chart.options.scales) {
                if (chart.options.scales.x) {
                    chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
                    chart.options.scales.x.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                    chart.options.scales.x.grid = chart.options.scales.x.grid || {};
                    chart.options.scales.x.grid.color = isDark ? '#374151' : '#e5e7eb';
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
                    chart.options.scales.y.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                    chart.options.scales.y.grid = chart.options.scales.y.grid || {};
                    chart.options.scales.y.grid.color = isDark ? '#374151' : '#e5e7eb';
                }
                if (chart.options.scales.r) {
                    chart.options.scales.r.ticks = chart.options.scales.r.ticks || {};
                    chart.options.scales.r.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                    chart.options.scales.r.grid = chart.options.scales.r.grid || {};
                    chart.options.scales.r.grid.color = isDark ? '#374151' : '#e5e7eb';
                    chart.options.scales.r.pointLabels = chart.options.scales.r.pointLabels || {};
                    chart.options.scales.r.pointLabels.color = isDark ? '#9ca3af' : '#6b7280';
                }
            }
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                chart.options.plugins.legend.labels.color = isDark ? '#9ca3af' : '#6b7280';
            }
            chart.update();
        });
    }

    // ============================================
    // NEW FEATURES
    // ============================================

    // Retry Logic for API
    const MAX_RETRIES = 3;
    let retryCount = 0;

    async function callGeminiAPIWithRetry(apiKey, files) {
        retryCount = 0;
        while (retryCount < MAX_RETRIES) {
            try {
                return await callGeminiAPI(apiKey, files);
            } catch (error) {
                retryCount++;
                if (retryCount < MAX_RETRIES) {
                    showUploadStatus(`Retry ${retryCount}/${MAX_RETRIES}: ${error.message}`);
                    await new Promise(r => setTimeout(r, 2000 * retryCount));
                } else {
                    throw error;
                }
            }
        }
    }

    // Export to PDF
    function exportToPDF() {
        // Use browser print with PDF option
        const originalTitle = document.title;
        const businessName = document.getElementById('businessName').textContent;
        document.title = `MCA Report - ${businessName} - ${new Date().toLocaleDateString()}`;
        window.print();
        document.title = originalTitle;
    }

    // Print Report
    function printReport() {
        window.print();
    }

    // New Analysis
    function newAnalysis() {
        // Reset state
        uploadedFiles = [];
        analysisData = null;

        // Clear notes
        document.getElementById('underwriterNotes').value = '';

        // Hide report, show upload
        document.getElementById('reportContainer').classList.remove('visible');
        document.getElementById('uploadSection').style.display = 'block';

        // Clear file list
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('uploadFooter').style.display = 'none';
        document.getElementById('uploadStatus').style.display = 'none';

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Save Report to localStorage
    function saveReport() {
        if (!analysisData) {
            alert('No report to save. Please analyze a bank statement first.');
            return;
        }

        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
        const businessName = analysisData.businessInfo?.name || 'Unknown Business';
        const notes = document.getElementById('underwriterNotes').value;

        const report = {
            id: Date.now(),
            name: businessName,
            date: new Date().toISOString(),
            data: analysisData,
            notes: notes
        };

        reports.unshift(report);
        // Keep only last 20 reports
        if (reports.length > 20) reports.pop();

        localStorage.setItem('savedReports', JSON.stringify(reports));

        // Show confirmation
        alert(`Report saved for "${businessName}"`);
    }

    // Toggle Saved Reports Menu
    function toggleSavedReports() {
        const menu = document.getElementById('savedReportsMenu');
        menu.classList.toggle('visible');

        if (menu.classList.contains('visible')) {
            renderSavedReports();
        }
    }

    // Render Saved Reports List
    function renderSavedReports() {
        const menu = document.getElementById('savedReportsMenu');
        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        if (reports.length === 0) {
            menu.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray-500);">No saved reports</div>';
            return;
        }

        menu.innerHTML = reports.map(r => `
            <div class="saved-report-item" onclick="loadReport(${r.id})">
                <div>
                    <div class="saved-report-name">${r.name}</div>
                    <div class="saved-report-date">${new Date(r.date).toLocaleDateString()}</div>
                </div>
                <div class="saved-report-delete" onclick="event.stopPropagation(); deleteReport(${r.id})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
            </div>
        `).join('');
    }

    // Load Report from localStorage
    function loadReport(id) {
        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
        const report = reports.find(r => r.id === id);

        if (report) {
            analysisData = report.data;
            renderReport(analysisData);
            document.getElementById('underwriterNotes').value = report.notes || '';

            // Hide upload, show report
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('reportContainer').classList.add('visible');

            // Close menu
            document.getElementById('savedReportsMenu').classList.remove('visible');
        }
    }

    // Delete Report from localStorage
    function deleteReport(id) {
        let reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
        reports = reports.filter(r => r.id !== id);
        localStorage.setItem('savedReports', JSON.stringify(reports));
        renderSavedReports();
    }

    // Close saved reports menu when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.querySelector('.saved-reports-dropdown');
        const menu = document.getElementById('savedReportsMenu');
        if (dropdown && !dropdown.contains(e.target)) {
            menu.classList.remove('visible');
        }
    });

    // Collapsible Sections
    function toggleSection(header) {
        header.classList.toggle('collapsed');
        const content = header.nextElementSibling;
        content.classList.toggle('collapsed');
    }

    // Make Field Editable
    function makeEditable(element, field) {
        if (element.querySelector('input')) return; // Already editing

        const currentValue = element.textContent.replace(/[$,]/g, '');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentValue;

        input.onblur = () => {
            const newValue = parseFloat(input.value.replace(/[$,]/g, '')) || 0;
            element.textContent = formatCurrency(newValue);

            // Update analysisData
            if (field === 'amount' && analysisData) {
                analysisData.recommendedPosition.amount = newValue;
            }
        };

        input.onkeydown = (e) => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') {
                element.textContent = formatCurrency(parseFloat(currentValue) || 0);
            }
        };

        element.textContent = '';
        element.appendChild(input);
        input.focus();
        input.select();
    }

    // Math Verification with Agentic Model
    async function runMathVerification() {
        if (!analysisData) {
            alert('No report data to verify.');
            return;
        }

        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            alert('Please configure your API key in Settings.');
            return;
        }

        const btn = document.getElementById('verifyBtn');
        const badge = document.getElementById('verificationBadge');
        const status = document.getElementById('verificationStatus');
        const results = document.getElementById('verificationResults');

        // Update UI to show loading
        btn.disabled = true;
        btn.innerHTML = `<svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> Verifying...`;
        badge.className = 'verification-badge checking';
        badge.textContent = 'Checking...';
        status.innerHTML = '<div class="verification-placeholder">AI is verifying calculations...</div>';
        results.style.display = 'none';

        try {
            // Build verification prompt with the data
            const verifyPrompt = `You are a financial auditor AI. Verify the following bank statement analysis data for mathematical accuracy.

DATA TO VERIFY:
${JSON.stringify(analysisData, null, 2)}

VERIFICATION TASKS:
1. Check if monthly totals (totalCredits, totalDebits) are reasonable given the creditCount and debitCount
2. Verify avgBalance is between minBalance and a reasonable maximum
3. Check if endBalance - startBalance roughly equals totalCredits - totalDebits
4. Verify the underwriting score criteria add up correctly
5. Check if MCA payment calculations are reasonable (amount  frequency)
6. Verify expense category percentages sum to approximately 100%
7. Check revenue source percentages sum to approximately 100%

Return a JSON object with EXACTLY this structure:
{
    "overallStatus": "pass" or "fail" or "warning",
    "checks": [
        {"name": "Monthly Totals", "status": "pass/fail/warning", "note": "explanation"},
        {"name": "Balance Consistency", "status": "pass/fail/warning", "note": "explanation"},
        {"name": "Cash Flow Math", "status": "pass/fail/warning", "note": "explanation"},
        {"name": "Score Calculation", "status": "pass/fail/warning", "note": "explanation"},
        {"name": "MCA Calculations", "status": "pass/fail/warning", "note": "explanation"},
        {"name": "Expense Percentages", "status": "pass/fail/warning", "note": "explanation"},
        {"name": "Revenue Percentages", "status": "pass/fail/warning", "note": "explanation"}
    ],
    "summary": "Brief overall summary of verification results",
    "discrepancies": ["List any specific discrepancies found"]
}`;

            // Use Gemini 2.5 Flash for quick verification
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: verifyPrompt }] }],
                    generationConfig: { temperature: 0.1, maxOutputTokens: 4096 }
                })
            });

            if (!response.ok) {
                throw new Error('Verification API request failed');
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) throw new Error('No response from verification API');

            // Parse JSON
            let jsonStr = text;
            if (text.includes('```json')) {
                jsonStr = text.split('```json')[1].split('```')[0];
            } else if (text.includes('```')) {
                jsonStr = text.split('```')[1].split('```')[0];
            }

            const verificationData = JSON.parse(jsonStr.trim());

            // Update badge
            badge.className = `verification-badge ${verificationData.overallStatus === 'pass' ? 'verified' : verificationData.overallStatus === 'fail' ? 'error' : 'checking'}`;
            badge.textContent = verificationData.overallStatus === 'pass' ? 'Verified ' : verificationData.overallStatus === 'fail' ? 'Issues Found' : 'Warnings';

            // Render results
            status.style.display = 'none';
            results.style.display = 'block';
            results.innerHTML = `
                ${verificationData.checks.map(check => `
                    <div class="verification-item">
                        <span class="verification-item-label">${check.name}</span>
                        <span class="verification-item-status ${check.status}">
                            ${check.status === 'pass' ? ' Pass' : check.status === 'fail' ? ' Fail' : ' Warning'}
                        </span>
                    </div>
                `).join('')}
                <div class="verification-summary">
                    <strong>Summary:</strong> ${verificationData.summary}
                    ${verificationData.discrepancies && verificationData.discrepancies.length > 0 ? `
                        <br><br><strong>Discrepancies:</strong>
                        <ul style="margin: 8px 0 0 16px;">
                            ${verificationData.discrepancies.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
            `;

        } catch (error) {
            console.error('Verification error:', error);
            badge.className = 'verification-badge error';
            badge.textContent = 'Error';
            status.innerHTML = `<div class="verification-placeholder" style="color: var(--danger);">Verification failed: ${error.message}</div>`;
        }

        // Reset button
        btn.disabled = false;
        btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Verify with AI`;
    }

    // Red Flag Detection
    function detectRedFlags(data) {
        const flags = [];
        const risk = data.riskIndicators || {};

        if (risk.nsfCount > 3) flags.push(`High NSF count: ${risk.nsfCount} items found`);
        if (risk.overdraftCount > 5) flags.push(`Excessive overdrafts: ${risk.overdraftCount} occurrences`);
        if (risk.negativeDays > 10) flags.push(`Extended negative balance: ${risk.negativeDays} days`);
        if (risk.mcaFound > 3) flags.push(`Multiple MCA positions detected: ${risk.mcaFound} lenders`);
        if (risk.achReturns > 2) flags.push(`ACH return issues: ${risk.achReturns} returns`);
        if (risk.netMargin < -20) flags.push(`Severe negative cash flow: ${risk.netMargin}% margin`);

        // Check monthly trends
        const months = data.monthlySummary || [];
        if (months.length >= 2) {
            const last = months[months.length - 1];
            const prev = months[months.length - 2];
            const revenueChange = ((last.totalCredits - prev.totalCredits) / prev.totalCredits) * 100;
            if (revenueChange < -30) {
                flags.push(`Revenue declining: ${revenueChange.toFixed(0)}% drop month-over-month`);
            }
        }

        // Show/hide alert
        const alertEl = document.getElementById('redFlagAlert');
        const listEl = document.getElementById('redFlagList');

        if (flags.length > 0) {
            listEl.innerHTML = flags.map(f => `<li>${f}</li>`).join('');
            alertEl.classList.add('visible');
        } else {
            alertEl.classList.remove('visible');
        }
    }

    // Heat Calendar Rendering
    function renderHeatCalendar(data) {
        const calendar = document.getElementById('heatCalendar');
        const balances = data.cashFlowData?.dailyBalances || [];

        if (balances.length === 0) {
            calendar.innerHTML = '<div style="color: var(--gray-500); text-align: center; padding: 20px;">No daily data available</div>';
            return;
        }

        // Find min/max for scaling
        const positiveBalances = balances.filter(b => b > 0);
        const maxBalance = Math.max(...positiveBalances, 1);
        const minBalance = Math.min(...balances);

        // Create calendar grid (assume data starts from a date)
        // For simplicity, we'll just show the days we have
        let html = '';

        // Add empty cells for alignment (assume first day is Sunday for simplicity)
        const startDay = 0; // Can be made dynamic
        for (let i = 0; i < startDay; i++) {
            html += '<div class="heat-day empty"></div>';
        }

        balances.forEach((balance, idx) => {
            let levelClass = 'level-0';

            if (balance < 0) {
                levelClass = balance < -1000 ? 'very-negative' : 'negative';
            } else {
                const ratio = balance / maxBalance;
                if (ratio > 0.8) levelClass = 'level-5';
                else if (ratio > 0.6) levelClass = 'level-4';
                else if (ratio > 0.4) levelClass = 'level-3';
                else if (ratio > 0.2) levelClass = 'level-2';
                else if (ratio > 0) levelClass = 'level-1';
            }

            html += `<div class="heat-day ${levelClass}" title="Day ${idx + 1}: ${formatCurrency(balance)}">${idx + 1}</div>`;
        });

        calendar.innerHTML = html;

        // Calculate and display stats
        const negativeDays = balances.filter(b => b < 0).length;
        const lowBalanceDays = balances.filter(b => b >= 0 && b < 500).length;
        const avgBalance = balances.reduce((a, b) => a + b, 0) / balances.length;
        const maxBal = Math.max(...balances);
        const minBal = Math.min(...balances);
        const maxBalIdx = balances.indexOf(maxBal);
        const minBalIdx = balances.indexOf(minBal);

        // Calculate volatility (standard deviation / mean)
        const mean = avgBalance;
        const squaredDiffs = balances.map(b => Math.pow(b - mean, 2));
        const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length;
        const stdDev = Math.sqrt(avgSquaredDiff);
        const volatility = mean !== 0 ? (stdDev / Math.abs(mean)) * 100 : 0;

        document.getElementById('highestBalanceDay').textContent = `Day ${maxBalIdx + 1} (${formatCurrency(maxBal)})`;
        document.getElementById('lowestBalanceDay').textContent = `Day ${minBalIdx + 1} (${formatCurrency(minBal)})`;
        document.getElementById('negativeDaysCount').textContent = negativeDays;
        document.getElementById('negativeDaysCount').className = `heat-stat-value ${negativeDays > 0 ? 'text-danger' : 'text-success'}`;
        document.getElementById('lowBalanceDaysCount').textContent = lowBalanceDays;
        document.getElementById('lowBalanceDaysCount').className = `heat-stat-value ${lowBalanceDays > 5 ? 'text-warning' : ''}`;
        document.getElementById('avgDailyBalance').textContent = formatCurrency(avgBalance);
        document.getElementById('balanceVolatility').textContent = volatility.toFixed(0) + '%';
        document.getElementById('balanceVolatility').className = `heat-stat-value ${volatility > 100 ? 'text-danger' : volatility > 50 ? 'text-warning' : ''}`;
    }

    // Trend Arrows for Month-over-Month Changes
    function getTrendArrow(current, previous) {
        if (!previous || previous === 0) return '';

        const change = ((current - previous) / Math.abs(previous)) * 100;

        if (Math.abs(change) < 2) {
            return `<span class="trend-arrow neutral">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" />
                </svg>
                ${change.toFixed(0)}%
            </span>`;
        } else if (change > 0) {
            return `<span class="trend-arrow up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
                </svg>
                +${change.toFixed(0)}%
            </span>`;
        } else {
            return `<span class="trend-arrow down">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
                ${change.toFixed(0)}%
            </span>`;
        }
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        // Don't trigger when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch(e.key) {
            case '?':
                showKeyboardShortcuts();
                break;
            case 'n':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    newAnalysis();
                }
                break;
            case 'p':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    printReport();
                }
                break;
            case 's':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    saveReport();
                }
                break;
            case 'Escape':
                document.getElementById('savedReportsMenu').classList.remove('visible');
                closeSettings();
                break;
        }
    });

    function showKeyboardShortcuts() {
        alert(`Keyboard Shortcuts:

? - Show this help
Ctrl/Cmd + N - New Analysis
Ctrl/Cmd + P - Print Report
Ctrl/Cmd + S - Save Report
Esc - Close menus/dialogs`);
    }

    // Interactive Charts - Add click handlers
    function setupInteractiveCharts() {
        // This would be called after chart rendering
        // Add click listeners for chart data points
        Object.values(chartInstances).forEach(chart => {
            chart.options.onClick = (evt, elements) => {
                if (elements.length > 0) {
                    const element = elements[0];
                    const datasetIndex = element.datasetIndex;
                    const index = element.index;
                    const label = chart.data.labels[index];
                    const value = chart.data.datasets[datasetIndex].data[index];

                    // Show detail popup (simple alert for now)
                    console.log(`Chart clicked: ${label} = ${formatCurrency(value)}`);
                }
            };
        });
    }

    // Custom Scoring Weights (stored in localStorage)
    let scoringWeights = {
        revenue: 25,
        cashFlow: 20,
        nsfOd: 20,
        avgBalance: 15,
        mcaStacking: 20
    };

    function loadScoringWeights() {
        const saved = localStorage.getItem('scoringWeights');
        if (saved) {
            scoringWeights = JSON.parse(saved);
        }
    }

    function saveScoringWeights() {
        localStorage.setItem('scoringWeights', JSON.stringify(scoringWeights));
    }

    function recalculateScore(data) {
        // Custom score calculation based on weights
        let score = 0;
        const risk = data.riskIndicators || {};
        const months = data.monthlySummary || [];

        // Revenue stability
        const revenueScore = months.length > 0 ? Math.min(100, (months[0].totalCredits || 0) / 1000) : 50;
        score += (revenueScore * scoringWeights.revenue) / 100;

        // Cash flow health
        const marginScore = Math.max(0, Math.min(100, (risk.netMargin || 0) + 50));
        score += (marginScore * scoringWeights.cashFlow) / 100;

        // NSF/OD score
        const nsfScore = Math.max(0, 100 - ((risk.nsfCount || 0) + (risk.overdraftCount || 0)) * 10);
        score += (nsfScore * scoringWeights.nsfOd) / 100;

        // Average balance
        const avgBal = months.length > 0 ? months[0].avgBalance || 0 : 0;
        const balScore = Math.min(100, avgBal / 100);
        score += (balScore * scoringWeights.avgBalance) / 100;

        // MCA stacking
        const mcaScore = Math.max(0, 100 - (risk.mcaFound || 0) * 25);
        score += (mcaScore * scoringWeights.mcaStacking) / 100;

        return Math.round(score);
    }

    // Enhanced Stacking Analysis
    function renderEnhancedStackingAnalysis(data) {
        const mca = data.mcaAnalysis || {};
        const positions = mca.positionsFound || [];

        // Calculate total daily payment burden
        let totalDailyBurden = 0;
        positions.forEach(p => {
            if (p.frequency === 'Daily') {
                totalDailyBurden += parseFloat(p.amount) || 0;
            } else if (p.frequency === 'Weekly') {
                totalDailyBurden += (parseFloat(p.amount) || 0) / 5;
            }
        });

        // Update MCA status box with more detail
        const statusBox = document.getElementById('mcaStatusBox');
        const statusTitle = document.getElementById('mcaStatusTitle');
        const statusText = document.getElementById('mcaStatusText');

        if (positions.length === 0) {
            statusBox.style.borderColor = 'var(--success)';
            statusBox.style.background = 'var(--success-bg)';
            statusTitle.textContent = 'No Active MCA Positions Detected';
            statusTitle.style.color = 'var(--success)';
            statusText.textContent = 'This business appears to have no current merchant cash advance obligations.';
        } else {
            statusBox.style.borderColor = 'var(--warning)';
            statusBox.style.background = 'var(--warning-bg)';
            statusTitle.textContent = `${positions.length} Position(s) Detected - Est. ${formatCurrency(totalDailyBurden)}/day burden`;
            statusTitle.style.color = 'var(--warning)';
            statusText.textContent = `Review recurring ACH debits carefully. Total estimated daily payment: ${formatCurrency(totalDailyBurden)}. Consider stacking limits before approval.`;
        }
    }

    // Industry Benchmark Data (mock data - would come from API in production)
    const industryBenchmarks = {
        restaurant: { avgRevenue: 180000, avgMargin: 8, avgBalance: 12000 },
        retail: { avgRevenue: 150000, avgMargin: 12, avgBalance: 15000 },
        services: { avgRevenue: 120000, avgMargin: 15, avgBalance: 10000 },
        construction: { avgRevenue: 250000, avgMargin: 10, avgBalance: 20000 },
        default: { avgRevenue: 150000, avgMargin: 10, avgBalance: 12000 }
    };

    function getIndustryBenchmark(industry) {
        const key = (industry || '').toLowerCase();
        if (key.includes('restaurant') || key.includes('food')) return industryBenchmarks.restaurant;
        if (key.includes('retail') || key.includes('store')) return industryBenchmarks.retail;
        if (key.includes('construct')) return industryBenchmarks.construction;
        if (key.includes('service')) return industryBenchmarks.services;
        return industryBenchmarks.default;
    }

    // Update the original renderReport to call new functions
    const originalRenderReport = renderReport;
    renderReport = function(data) {
        originalRenderReport(data);

        // Call new feature functions
        detectRedFlags(data);
        renderHeatCalendar(data);
        renderEnhancedStackingAnalysis(data);
        setupInteractiveCharts();

        // Load scoring weights
        loadScoringWeights();
    };

    // Initialize on load
    loadScoringWeights();

    // Comparison Mode Functions
    function openComparisonMode() {
        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        // Add current analysis if available
        const options = [...reports];
        if (analysisData && analysisData.businessInfo?.name) {
            options.unshift({
                id: 'current',
                name: analysisData.businessInfo.name + ' (Current)',
                data: analysisData
            });
        }

        if (options.length < 2) {
            alert('You need at least 2 saved reports to compare. Save some reports first!');
            return;
        }

        // Populate dropdowns
        const select1 = document.getElementById('compareSelect1');
        const select2 = document.getElementById('compareSelect2');

        const optionsHtml = '<option value="">Select a business...</option>' +
            options.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

        select1.innerHTML = optionsHtml;
        select2.innerHTML = optionsHtml;

        // Show modal
        document.getElementById('comparisonModal').classList.add('visible');
    }

    function closeComparisonMode() {
        document.getElementById('comparisonModal').classList.remove('visible');
    }

    // Transaction Modal Functions
    function showTransactions(monthIdx, type) {
        if (!analysisData || !analysisData.monthlySummary) return;

        const month = analysisData.monthlySummary[monthIdx];
        if (!month) return;

        const transactions = type === 'credits' ? month.credits : month.debits;
        if (!transactions || transactions.length === 0) return;

        const title = type === 'credits' ? `Deposits - ${month.month}` : `Withdrawals - ${month.month}`;
        document.getElementById('transactionModalTitle').textContent = title;

        const tbody = document.getElementById('transactionTableBody');
        tbody.innerHTML = transactions.map(t => `
            <tr>
                <td>${t.date || '--'}</td>
                <td>${t.description || '--'}</td>
                <td class="${type === 'credits' ? 'amount-credit' : 'amount-debit'}">${type === 'credits' ? '+' : '-'}${formatCurrency(t.amount || 0)}</td>
            </tr>
        `).join('');

        document.getElementById('transactionModal').classList.add('visible');
    }

    function closeTransactionModal() {
        document.getElementById('transactionModal').classList.remove('visible');
    }

    function updateComparison() {
        const select1 = document.getElementById('compareSelect1');
        const select2 = document.getElementById('compareSelect2');
        const grid = document.getElementById('comparisonGrid');

        const id1 = select1.value;
        const id2 = select2.value;

        if (!id1 || !id2) {
            grid.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 40px; grid-column: span 2;">Select two saved reports to compare</div>';
            return;
        }

        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        let data1, data2;

        if (id1 === 'current') {
            data1 = analysisData;
        } else {
            const report1 = reports.find(r => r.id == id1);
            data1 = report1?.data;
        }

        if (id2 === 'current') {
            data2 = analysisData;
        } else {
            const report2 = reports.find(r => r.id == id2);
            data2 = report2?.data;
        }

        if (!data1 || !data2) {
            grid.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 40px; grid-column: span 2;">Error loading report data</div>';
            return;
        }

        // Generate comparison
        grid.innerHTML = renderComparisonCards(data1, data2);
    }

    function renderComparisonCards(data1, data2) {
        const getMonthlyAvg = (data, field) => {
            const months = data.monthlySummary || [];
            if (months.length === 0) return 0;
            return months.reduce((sum, m) => sum + (m[field] || 0), 0) / months.length;
        };

        const metrics = [
            { label: 'Avg Monthly Revenue', key: 'totalCredits', format: formatCurrency, higherBetter: true },
            { label: 'Avg Monthly Debits', key: 'totalDebits', format: formatCurrency, higherBetter: false },
            { label: 'Avg Balance', key: 'avgBalance', format: formatCurrency, higherBetter: true },
            { label: 'Min Balance', key: 'minBalance', format: formatCurrency, higherBetter: true },
            { label: 'NSF Count', key: 'nsfCount', source: 'risk', format: v => v, higherBetter: false },
            { label: 'Overdraft Count', key: 'overdraftCount', source: 'risk', format: v => v, higherBetter: false },
            { label: 'MCA Positions', key: 'mcaFound', source: 'risk', format: v => v, higherBetter: false },
            { label: 'Net Margin', key: 'netMargin', source: 'risk', format: v => v + '%', higherBetter: true }
        ];

        const getValue = (data, metric) => {
            if (metric.source === 'risk') {
                return data.riskIndicators?.[metric.key] || 0;
            }
            return getMonthlyAvg(data, metric.key);
        };

        const name1 = data1.businessInfo?.name || 'Business 1';
        const name2 = data2.businessInfo?.name || 'Business 2';

        let html = `
            <div class="comparison-card">
                <div class="comparison-card-title">${name1}</div>
                ${metrics.map(m => {
                    const val1 = getValue(data1, m);
                    const val2 = getValue(data2, m);
                    const isBetter = m.higherBetter ? val1 > val2 : val1 < val2;
                    const isWorse = m.higherBetter ? val1 < val2 : val1 > val2;
                    const className = val1 === val2 ? '' : (isBetter ? 'comparison-better' : 'comparison-worse');
                    return `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">${m.label}</span>
                            <span class="comparison-metric-value ${className}">${m.format(Math.round(val1))}</span>
                        </div>
                    `;
                }).join('')}
            </div>
            <div class="comparison-card">
                <div class="comparison-card-title">${name2}</div>
                ${metrics.map(m => {
                    const val1 = getValue(data1, m);
                    const val2 = getValue(data2, m);
                    const isBetter = m.higherBetter ? val2 > val1 : val2 < val1;
                    const isWorse = m.higherBetter ? val2 < val1 : val2 > val1;
                    const className = val1 === val2 ? '' : (isBetter ? 'comparison-better' : 'comparison-worse');
                    return `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">${m.label}</span>
                            <span class="comparison-metric-value ${className}">${m.format(Math.round(val2))}</span>
                        </div>
                    `;
                }).join('')}
            </div>
        `;

        return html;
    }
</script>

</body>
</html>
