<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision PRO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --border: #2a2a2a;
            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --gold: #eab308;
            --gold-bg: rgba(234, 179, 8, 0.1);
            --green: #22c55e;
            --green-bg: rgba(34, 197, 94, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --yellow: #f59e0b;
            --yellow-bg: rgba(245, 158, 11, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
            --purple: #a855f7;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Text selection */
        ::selection {
            background: rgba(234, 179, 8, 0.3);
            color: var(--text);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .brand:hover {
            transform: scale(1.02);
        }

        .brand svg {
            width: 28px;
            height: 28px;
            filter: drop-shadow(0 0 8px rgba(234, 179, 8, 0.4));
            transition: all 0.3s ease;
        }

        .brand:hover svg {
            filter: drop-shadow(0 0 12px rgba(234, 179, 8, 0.6));
            transform: rotate(5deg);
        }

        .brand-text {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: -0.3px;
            transition: all 0.3s ease;
        }

        .brand-text .gold { color: var(--gold); }

        .header-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--gold);
            border-color: var(--gold);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.15);
        }

        .icon-btn:active {
            transform: translateY(0) scale(0.95);
            box-shadow: none;
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }

        .icon-btn:hover svg {
            transform: scale(1.1);
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: var(--border);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            border-color: var(--text-muted);
        }

        .btn:active {
            transform: translateY(0) scale(0.97);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, #f59e0b 100%);
            border-color: var(--gold);
            color: #000;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(234, 179, 8, 0.3);
        }

        .btn-primary::before {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #facc15 0%, #fbbf24 100%);
            box-shadow: 0 8px 30px rgba(234, 179, 8, 0.5), 0 0 20px rgba(234, 179, 8, 0.3);
            transform: translateY(-3px);
            border-color: #facc15;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.97);
            box-shadow: 0 2px 12px rgba(234, 179, 8, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background: var(--gold);
        }

        .btn-primary:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: calc(100vh - 56px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 56px;
            height: calc(100vh - 56px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar > * {
            flex-shrink: 0;
        }

        .upload-zone {
            margin: 16px;
            padding: 40px 20px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--gold);
            background: var(--gold-bg);
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(234, 179, 8, 0.15);
        }

        .upload-zone:active {
            transform: scale(0.98);
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: var(--gold);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .upload-zone:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(234, 179, 8, 0.4);
        }

        .upload-icon svg { width: 24px; height: 24px; color: #000; transition: transform 0.3s; }

        .upload-zone:hover .upload-icon svg {
            transform: translateY(-2px);
        }

        .upload-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .upload-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-list {
            padding: 0 12px;
            max-height: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .file-item:hover {
            border-color: var(--gold);
            transform: translateX(4px);
            box-shadow: -4px 0 12px rgba(234, 179, 8, 0.1);
        }

        .file-item:active {
            transform: translateX(2px) scale(0.99);
        }

        .file-item.selected {
            border-color: var(--gold);
            background: var(--gold-bg);
            box-shadow: 0 0 0 1px var(--gold), 0 0 20px rgba(234, 179, 8, 0.15);
        }

        .file-item.selected .file-name {
            color: var(--gold);
        }

        .file-item.clean { border-left: 3px solid var(--green); }
        .file-item.warning { border-left: 3px solid var(--yellow); }
        .file-item.danger { border-left: 3px solid var(--red); }

        .file-thumb {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            background: var(--bg);
        }

        .file-info { flex: 1; min-width: 0; }

        .file-name {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .file-status {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .file-status.clean { background: var(--green-bg); color: var(--green); }
        .file-status.warning { background: var(--yellow-bg); color: var(--yellow); }
        .file-status.danger { background: var(--red-bg); color: var(--red); }

        .file-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
        }

        .file-remove:hover { color: var(--red); }

        .sidebar-footer {
            padding: 16px;
        }
        .sidebar-actions {
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Content Area */
        .content {
            overflow-y: auto;
            padding: 24px;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .step {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-muted);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
        }

        .step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .step.active {
            border-color: var(--gold);
            background: var(--gold-bg);
            color: var(--gold);
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.2), inset 0 0 20px rgba(234, 179, 8, 0.05);
        }

        .step.active .step-num {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(234, 179, 8, 0); }
        }

        .step.completed {
            border-color: var(--green);
            background: var(--green-bg);
            color: var(--green);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.15);
        }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .step.active .step-num { background: var(--gold); color: #000; }
        .step.completed .step-num { background: var(--green); color: #fff; }

        /* Section Cards */
        .section-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeSlideIn 0.5s ease-out;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-card:hover {
            border-color: rgba(234, 179, 8, 0.3);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(234, 179, 8, 0.1);
            transform: translateY(-2px);
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }

        .section-header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-logo {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .section-body {
            padding: 20px;
        }

        .card-export-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .card-export-btn:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
            color: var(--gold);
        }

        .card-export-btn svg {
            width: 14px;
            height: 14px;
        }

        .section-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Export Menu */
        .export-menu-container {
            position: relative;
            display: inline-block;
        }

        .export-menu-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--gold) 0%, #d4a106 100%);
            color: #000;
            border: none;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-menu-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
        }

        .export-menu-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-menu-btn svg {
            width: 16px;
            height: 16px;
        }

        .export-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease;
            z-index: 1000;
            min-width: 280px;
        }

        .export-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .export-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .export-dropdown-section {
            padding: 8px;
        }

        .export-dropdown-section-title {
            padding: 8px 12px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            color: var(--text);
        }

        .export-option:hover {
            background: var(--bg-tertiary);
        }

        .export-option-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .export-option-icon.png { background: rgba(34, 197, 94, 0.15); color: var(--green); }
        .export-option-icon.pdf { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .export-option-icon.print { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .export-option-icon.json { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .export-option-icon.csv { background: rgba(234, 179, 8, 0.15); color: var(--gold); }
        .export-option-icon.clipboard { background: rgba(99, 102, 241, 0.15); color: #6366f1; }

        .export-option-icon svg {
            width: 16px;
            height: 16px;
        }

        .export-option-info {
            flex: 1;
            min-width: 0;
        }

        .export-option-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }

        .export-option-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .export-option-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--gold-bg);
            color: var(--gold);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Print styles for clean export */
        @media print {
            body {
                background: #ffffff !important;
                color: #000000 !important;
            }
            .header, .sidebar, .export-menu-container, .card-export-btn,
            .expand-toggle, button, .loading, .empty-state, .modal-overlay {
                display: none !important;
            }
            .content {
                margin: 0 !important;
                padding: 20px !important;
            }
            .section-card {
                break-inside: avoid;
                page-break-inside: avoid;
                background: #ffffff !important;
                border: 1px solid #e0e0e0 !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
            }
            .section-header {
                background: #f5f5f5 !important;
                color: #000000 !important;
            }
            .hidden {
                display: block !important;
            }
            * {
                color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* Status Message */
        .status-message {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            animation: statusSlide 0.3s ease-out;
        }

        @keyframes statusSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message.show { display: block; }
        .status-message.info {
            background: var(--blue-bg);
            color: var(--blue);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
        }
        .status-message.success {
            background: var(--green-bg);
            color: var(--green);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.15);
        }
        .status-message.error {
            background: var(--red-bg);
            color: var(--red);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.15);
        }
        .status-message.warning {
            background: var(--yellow-bg);
            color: var(--yellow);
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.15);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading.show { display: block; }

        .loading-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .spinner-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 3px solid var(--border);
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .spinner-ring {
            width: 80px;
            height: 80px;
            border: 3px solid transparent;
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            position: absolute;
            top: 0;
            left: 0;
        }

        .spinner-ring-2 {
            width: 60px;
            height: 60px;
            border: 2px solid transparent;
            border-bottom-color: var(--gold);
            border-radius: 50%;
            animation: spin-reverse 1.5s linear infinite;
            position: absolute;
            top: 10px;
            left: 10px;
            opacity: 0.5;
        }

        .spinner-dot {
            width: 12px;
            height: 12px;
            background: var(--gold);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-dot 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px var(--gold), 0 0 40px rgba(234, 179, 8, 0.3);
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes spin-reverse { to { transform: rotate(-360deg); } }
        @keyframes pulse-dot {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.7; }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .loading-progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #f59e0b, var(--gold));
            background-size: 200% 100%;
            animation: shimmer-progress 2s ease-in-out infinite;
            border-radius: 8px;
            transition: width 0.5s ease-out;
        }

        @keyframes shimmer-progress {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .loading-step.active {
            color: var(--gold);
            background: rgba(234, 179, 8, 0.15);
            box-shadow: 0 0 12px rgba(234, 179, 8, 0.2);
        }

        .loading-step.done {
            color: var(--green);
            background: rgba(34, 197, 94, 0.15);
        }

        .loading-step-icon {
            width: 14px;
            height: 14px;
        }

        .loading-step.active .loading-step-icon {
            animation: pulse-icon 1s ease-in-out infinite;
        }

        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Skeleton shimmer placeholders */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        .skeleton-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .skeleton-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .skeleton-cell {
            flex: 1;
            height: 40px;
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .data-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .data-card.highlight { border-color: var(--gold); }

        .data-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .data-value {
            font-size: 20px;
            font-weight: 700;
        }

        .data-value.green { color: var(--green); }
        .data-value.red { color: var(--red); }
        .data-value.gold { color: var(--gold); }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            transition: all 0.15s ease;
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        tbody tr {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.08) 0%, var(--bg-tertiary) 100%);
            border-left: 3px solid var(--gold);
        }

        tbody tr:hover td {
            color: var(--text);
        }

        tbody tr:active {
            transform: scale(0.995);
        }

        tfoot tr {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            font-weight: 600;
        }

        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-gold { color: var(--gold); }

        /* Risk Chips */
        .risk-summary {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .risk-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            min-width: 80px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
        }

        .risk-chip:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .risk-chip.good {
            border-color: var(--green);
            background: var(--green-bg);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.1);
        }
        .risk-chip.warn {
            border-color: var(--yellow);
            background: var(--yellow-bg);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.1);
        }
        .risk-chip.bad {
            border-color: var(--red);
            background: var(--red-bg);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.1);
            animation: pulse-danger 3s ease-in-out infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.25); }
        }

        .risk-chip.good:hover {
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4), 0 0 20px rgba(34, 197, 94, 0.2);
        }
        .risk-chip.warn:hover {
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.4), 0 0 20px rgba(245, 158, 11, 0.2);
        }
        .risk-chip.bad:hover {
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4), 0 0 20px rgba(239, 68, 68, 0.2);
            animation: none;
        }

        .risk-chip-value {
            font-size: 24px;
            font-weight: 700;
            transition: transform 0.2s;
        }

        .risk-chip:hover .risk-chip-value {
            transform: scale(1.1);
        }

        .risk-chip.good .risk-chip-value { color: var(--green); }
        .risk-chip.warn .risk-chip-value { color: var(--yellow); }
        .risk-chip.bad .risk-chip-value { color: var(--red); }

        .risk-chip-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* MCA Section - Enhanced */
        .mca-section {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--red);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 16px;
            position: relative;
            overflow: hidden;
        }

        .mca-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--red) 0%, #f97316 50%, var(--red) 100%);
        }

        .mca-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .mca-icon {
            width: 40px;
            height: 40px;
            background: var(--red-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .mca-title {
            flex: 1;
        }

        .mca-title h3 {
            color: var(--red);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .mca-title p {
            color: var(--text-muted);
            font-size: 12px;
            margin: 2px 0 0 0;
        }

        .mca-count-badge {
            background: var(--red);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }

        .mca-lender-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mca-lender-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--red);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .mca-lender-card:hover {
            border-color: var(--red);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .mca-lender-icon {
            width: 36px;
            height: 36px;
            background: var(--red-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .mca-lender-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .mca-lender-status {
            font-size: 12px;
            color: var(--red);
            font-weight: 600;
        }

        /* Legacy MCA Alert for Red Flags */
        .mca-alert {
            background: var(--red-bg);
            border: 1px solid var(--red);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 16px;
        }

        .mca-alert-title {
            color: var(--red);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .mca-badge {
            display: inline-block;
            padding: 4px 10px;
            margin: 2px 4px 2px 0;
            background: var(--bg-secondary);
            border: 1px solid var(--red);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--red);
            transition: all 0.2s ease;
        }

        .mca-badge:hover {
            background: var(--red-bg);
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }

        /* Lender Cards */
        .lender-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .lender-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeSlideIn 0.4s ease-out;
        }

        .lender-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.2);
            border-color: var(--text-muted);
        }

        .lender-card.high { border-left: 4px solid var(--green); }
        .lender-card.medium { border-left: 4px solid var(--yellow); }
        .lender-card.low { border-left: 4px solid var(--text-muted); }

        .lender-card.high:hover {
            box-shadow: 0 12px 35px rgba(34, 197, 94, 0.15);
        }
        .lender-card.medium:hover {
            box-shadow: 0 12px 35px rgba(245, 158, 11, 0.15);
        }

        .lender-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .lender-name {
            font-size: 14px;
            font-weight: 600;
        }

        .lender-score {
            font-size: 18px;
            font-weight: 700;
        }

        .lender-card.high .lender-score { color: var(--green); }
        .lender-card.medium .lender-score { color: var(--yellow); }
        .lender-card.low .lender-score { color: var(--text-muted); }

        .lender-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .lender-tag {
            font-size: 10px;
            padding: 3px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .lender-submit {
            font-size: 11px;
            color: var(--text-muted);
        }

        .lender-submit a {
            color: var(--gold);
            text-decoration: none;
        }

        .lender-submit a:hover { text-decoration: underline; }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Debt Obligations */
        .debt-total-badge {
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
        }

        .debt-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .debt-stat {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .debt-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .debt-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .debt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .debt-table th,
        .debt-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .debt-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .debt-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .debt-type-mca { background: #dc262622; color: #dc2626; }
        .debt-type-loan { background: #f59e0b22; color: #f59e0b; }
        .debt-type-lease { background: #8b5cf622; color: #8b5cf6; }
        .debt-type-other { background: #64748b22; color: #64748b; }

        @media (max-width: 768px) {
            .debt-summary { grid-template-columns: repeat(2, 1fr); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body { padding: 20px; }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .form-input:hover {
            border-color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15), 0 0 20px rgba(234, 179, 8, 0.1);
        }

        /* Placeholder */
        .placeholder {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Hidden */
        .hidden { display: none !important; }

        /* Watermark Preview */
        .watermark-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            min-height: 150px;
            max-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
            border: 1px solid var(--border);
            margin: 12px 16px;
            cursor: pointer;
            transition: max-height 0.3s ease;
            flex-shrink: 0;
        }
        .watermark-preview.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 1200px;
            height: 85vh;
            max-height: 85vh;
            z-index: 1000;
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            margin: 0;
        }
        .watermark-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .watermark-preview-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .watermark-preview canvas {
            max-width: 100%;
            max-height: 260px;
            border-radius: var(--radius-sm);
            transition: max-height 0.3s ease;
        }
        .watermark-preview.expanded canvas {
            max-width: 95%;
            max-height: calc(85vh - 40px);
        }
        .expand-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }
        .expand-btn:hover {
            opacity: 1;
            background: var(--bg-tertiary);
            color: var(--gold);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        .expand-btn:active {
            transform: scale(0.95);
        }
        .watermark-preview.expanded .expand-btn {
            transform: rotate(180deg);
        }
        .watermark-preview.expanded .expand-btn:hover {
            transform: rotate(180deg) scale(1.05);
        }
        .download-file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .download-file-item:hover {
            border-color: var(--border);
            background: var(--bg-secondary);
            transform: translateX(4px);
        }
        .download-file-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .download-file-item input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .download-file-item input:hover {
            border-color: var(--text-muted);
        }
        .download-file-item input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15);
        }
        .download-file-item .file-ext {
            color: var(--text-muted);
            font-size: 12px;
        }
        .watermark-placeholder {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }
        .watermark-placeholder-icon {
            font-size: 48px;
            opacity: 0.25;
            margin-bottom: 16px;
        }
        .file-name-input {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 4px;
            width: 100%;
            font-family: inherit;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .file-name-input:hover {
            border-color: var(--border);
            background: rgba(255, 255, 255, 0.02);
        }
        .file-name-input:focus {
            outline: none;
            border-color: var(--gold);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        /* Watermark Controls */
        .watermark-controls {
            padding: 16px;
            border-top: 1px solid var(--border);
        }
        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
        }
        .control-group { margin-bottom: 0; }
        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .range-value { color: var(--gold); font-weight: 600; }

        .control-group input[type="range"] {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            transition: background 0.2s;
        }
        .control-group input[type="range"]:hover {
            background: var(--border);
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.5), 0 2px 8px rgba(0,0,0,0.3);
        }
        .control-group input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.6);
        }

        /* Business Info Section */
        .business-info-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            text-align: center;
        }

        .input-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .text-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .text-input:hover {
            border-color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15), 0 0 20px rgba(234, 179, 8, 0.1);
            background: var(--bg-secondary);
        }

        /* Research Summary Bar */
        .research-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .research-stat {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .research-stat:hover {
            transform: translateY(-2px);
            border-color: var(--border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .research-stat:hover .research-stat-value {
            transform: scale(1.05);
        }

        .research-stat-value {
            transition: transform 0.3s ease;
        }

        .research-stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .research-stat-value.green { color: var(--green); }
        .research-stat-value.yellow { color: var(--yellow); }
        .research-stat-value.red { color: var(--red); }

        .research-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Research Modules Grid */
        .research-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
        }

        .research-module {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .research-module:hover {
            border-color: var(--text-muted);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .research-module.expanded {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .research-module.risk-low { border-left: 3px solid var(--green); }
        .research-module.risk-medium { border-left: 3px solid var(--yellow); }
        .research-module.risk-high { border-left: 3px solid var(--red); }

        .research-module-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            user-select: none;
        }

        .research-module-header:hover {
            background: var(--bg-tertiary);
        }

        .research-module-header:active {
            background: var(--bg);
        }

        .research-module-icon {
            width: 38px;
            height: 38px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .research-module-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-muted);
        }

        .research-module.risk-low .research-module-icon { background: var(--green-bg); }
        .research-module.risk-low .research-module-icon svg { stroke: var(--green); }
        .research-module.risk-medium .research-module-icon { background: var(--yellow-bg); }
        .research-module.risk-medium .research-module-icon svg { stroke: var(--yellow); }
        .research-module.risk-high .research-module-icon { background: var(--red-bg); }
        .research-module.risk-high .research-module-icon svg { stroke: var(--red); }

        .research-module-info {
            flex: 1;
            min-width: 0;
        }

        .research-module-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-module-summary {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .research-module-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .risk-badge.pending {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .risk-badge.low {
            background: var(--green-bg);
            color: var(--green);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }
        .risk-badge.medium {
            background: var(--yellow-bg);
            color: var(--yellow);
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.2);
        }
        .risk-badge.high {
            background: var(--red-bg);
            color: var(--red);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
            animation: pulse-badge 2s ease-in-out infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.2); }
            50% { box-shadow: 0 0 18px rgba(239, 68, 68, 0.4); }
        }

        .risk-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .expand-icon {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .research-module:hover .expand-icon {
            color: var(--gold);
        }

        .research-module.expanded .expand-icon {
            transform: rotate(180deg);
            color: var(--gold);
        }

        .research-module-content {
            display: none;
            padding: 0 16px 16px;
            border-top: 1px solid var(--border);
            margin-top: 0;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .research-module.expanded .research-module-content {
            display: block;
        }

        .research-detail-section {
            padding-top: 14px;
        }

        .research-detail-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .research-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .research-detail-list li {
            position: relative;
            padding-left: 16px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 4px;
        }

        .research-detail-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 9px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.2s;
        }

        .research-detail-list li:hover {
            color: var(--text);
        }

        .research-detail-list li:hover::before {
            background: var(--gold);
            box-shadow: 0 0 8px rgba(234, 179, 8, 0.5);
        }

        .research-flags {
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--red-bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--red);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .research-flags-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--red);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .research-flags-list {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Loading spinner for modules */
        .module-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .research-module.loading .research-module-icon {
            background: transparent;
        }

        /* Fraud Analysis Modules */
        .fraud-modules-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .fraud-module {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .fraud-module:hover {
            border-color: var(--text-muted);
        }

        .fraud-module.risk-low { border-left: 3px solid var(--green); }
        .fraud-module.risk-medium { border-left: 3px solid var(--yellow); }
        .fraud-module.risk-high { border-left: 3px solid var(--red); }

        .fraud-module-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            cursor: pointer;
            user-select: none;
        }

        .fraud-module-header:hover {
            background: var(--bg-tertiary);
        }

        .fraud-module-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .fraud-module-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-muted);
        }

        .fraud-module.risk-low .fraud-module-icon { background: var(--green-bg); }
        .fraud-module.risk-low .fraud-module-icon svg { stroke: var(--green); }
        .fraud-module.risk-medium .fraud-module-icon { background: var(--yellow-bg); }
        .fraud-module.risk-medium .fraud-module-icon svg { stroke: var(--yellow); }
        .fraud-module.risk-high .fraud-module-icon { background: var(--red-bg); }
        .fraud-module.risk-high .fraud-module-icon svg { stroke: var(--red); }

        .fraud-module-info {
            flex: 1;
            min-width: 0;
        }

        .fraud-module-name {
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fraud-module-summary {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .fraud-module-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .fraud-module.risk-low .fraud-module-status { background: var(--green-bg); color: var(--green); }
        .fraud-module.risk-medium .fraud-module-status { background: var(--yellow-bg); color: var(--yellow); }
        .fraud-module.risk-high .fraud-module-status { background: var(--red-bg); color: var(--red); }

        .fraud-module .expand-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .fraud-module .expand-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--text-muted);
        }

        .fraud-module.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .fraud-module-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 14px;
        }

        .fraud-module.expanded .fraud-module-content {
            max-height: 200px;
            padding: 0 14px 14px 14px;
        }

        /* Research Progress */
        .research-progress {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .research-progress-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .research-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .research-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, #f59e0b 100%);
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }

        .research-progress-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--gold);
            white-space: nowrap;
            min-width: 80px;
            text-align: right;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .research-grid {
                grid-template-columns: 1fr;
            }
            .research-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .research-module-header {
                flex-wrap: wrap;
                gap: 8px;
            }
            .research-module-status {
                width: 100%;
                justify-content: space-between;
                margin-top: 8px;
            }
        }

        /* Print Styles */
        @media print {
            .header, .sidebar, .progress-steps { display: none; }
            .main-container { display: block; }
            .content { padding: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <svg viewBox="0 0 64 64" fill="none">
                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
            </svg>
            <span class="brand-text"><span style="color: var(--text);">Vision</span> <span style="color: var(--text-muted);">Pro</span></span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle" title="Toggle Theme">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
            <button class="icon-btn" id="settingsBtn" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <button class="icon-btn" id="exportBtn" title="Export PDF">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Business Info Section (auto-extracted from bank statements) -->
            <div class="business-info-section" id="businessInfoSection" style="display: none;">
                <label class="input-label">Extracted Business Info</label>
                <div id="extractedBusinessDisplay" style="font-size: 13px; color: var(--text-secondary); padding: 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                    <div><strong id="displayBusinessName">-</strong></div>
                    <div id="displayOwnerName" style="margin-top: 4px;"></div>
                    <div id="displayBusinessAddress" style="margin-top: 4px;"></div>
                </div>
            </div>

            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                </div>
                <div class="upload-title">Drop Bank Statements</div>
                <div class="upload-subtitle">PDF or images  Multiple files OK</div>
            </div>
            <input type="file" id="fileInput" accept=".pdf,image/*" multiple hidden>

            <div class="file-list" id="fileList"></div>

            <!-- Action Buttons -->
            <div class="sidebar-actions">
                <div class="file-count" id="fileCount">0 files</div>
                <button class="btn btn-secondary" id="downloadAllBtn" style="width: 100%; display: none;">
                    Download Watermarked
                </button>
                <button class="btn btn-primary" id="processBtn" style="width: 100%;" disabled>
                    Analyze Documents
                </button>
                <div class="export-menu-container" style="width: 100%;">
                    <button class="export-menu-btn" id="exportMenuBtn" style="width: 100%;" disabled onclick="toggleExportMenu()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export Report
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                            <polyline points="18 15 12 9 6 15"/>
                        </svg>
                    </button>
                    <div class="export-dropdown" id="exportDropdown">
                        <div class="export-dropdown-header">Export Options</div>
                        <div class="export-dropdown-section">
                            <div class="export-dropdown-section-title">Images</div>
                            <button class="export-option" onclick="exportMethod('png-clean')">
                                <div class="export-option-icon png">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PNG (Light Theme)</div>
                                    <div class="export-option-desc">Clean white background, DOM clone method</div>
                                </div>
                                <span class="export-option-badge">Best</span>
                            </button>
                            <button class="export-option" onclick="exportMethod('png-iframe')">
                                <div class="export-option-icon png">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PNG (Iframe Render)</div>
                                    <div class="export-option-desc">Isolated render, avoids style conflicts</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('png-native')">
                                <div class="export-option-icon png">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PNG (Current Theme)</div>
                                    <div class="export-option-desc">Exports as-is with current dark/light theme</div>
                                </div>
                            </button>
                        </div>
                        <div class="export-dropdown-section">
                            <div class="export-dropdown-section-title">Documents</div>
                            <button class="export-option" onclick="exportMethod('pdf')">
                                <div class="export-option-icon pdf">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PDF Document</div>
                                    <div class="export-option-desc">Multi-page PDF with light theme</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('print')">
                                <div class="export-option-icon print">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">Print / Save as PDF</div>
                                    <div class="export-option-desc">Uses browser print dialog, best quality</div>
                                </div>
                            </button>
                        </div>
                        <div class="export-dropdown-section">
                            <div class="export-dropdown-section-title">Data</div>
                            <button class="export-option" onclick="exportMethod('json')">
                                <div class="export-option-icon json">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M8 13h2M8 17h2M12 13h4M12 17h4"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">JSON Data</div>
                                    <div class="export-option-desc">Raw analysis data for integration</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('csv')">
                                <div class="export-option-icon csv">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M8 13h8M8 17h8M8 9h1"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">CSV Spreadsheet</div>
                                    <div class="export-option-desc">Monthly data for Excel/Sheets</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('clipboard')">
                                <div class="export-option-icon clipboard">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">Copy to Clipboard</div>
                                    <div class="export-option-desc">Formatted summary text</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watermark Preview Overlay -->
            <div class="watermark-preview-overlay" id="previewOverlay" onclick="togglePreviewSize()"></div>

            <!-- Watermark Preview -->
            <div class="watermark-preview" id="previewContainer">
                <div class="watermark-placeholder" id="watermarkPlaceholder">
                    <div class="watermark-placeholder-icon">+</div>
                    <div>Select a file to preview watermark</div>
                </div>
                <canvas id="previewCanvas" style="display:none;"></canvas>
                <button class="expand-btn" id="expandBtn" onclick="togglePreviewSize()"></button>
            </div>

            <!-- Watermark Controls -->
            <div class="watermark-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>Opacity <span class="range-value" id="opacityVal">25%</span></label>
                        <input type="range" id="opacitySlider" min="5" max="50" value="25">
                    </div>
                    <div class="control-group">
                        <label>Size <span class="range-value" id="sizeVal">15%</span></label>
                        <input type="range" id="sizeSlider" min="5" max="40" value="15">
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label>Density <span class="range-value" id="densityVal">50%</span></label>
                        <input type="range" id="densitySlider" min="20" max="80" value="50">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="rotationVal">45</span></label>
                        <input type="range" id="rotationSlider" min="0" max="90" value="45">
                    </div>
                </div>
                <button class="btn" style="width: 100%; margin-top: 12px;" onclick="saveWatermarkDefaults()">
                    Save as Defaults
                </button>
            </div>

        </aside>

        <!-- Content -->
        <main class="content">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <span class="step-num">1</span>
                    <span>Upload</span>
                </div>
                <div class="step" id="step2">
                    <span class="step-num">2</span>
                    <span>Fraud Scan</span>
                </div>
                <div class="step" id="step3">
                    <span class="step-num">3</span>
                    <span>Extract Data</span>
                </div>
                <div class="step" id="step4">
                    <span class="step-num">4</span>
                    <span>Research</span>
                </div>
                <div class="step" id="step5">
                    <span class="step-num">5</span>
                    <span>Match Lenders</span>
                </div>
            </div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage"></div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-container">
                    <div class="spinner-wrapper">
                        <div class="spinner"></div>
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring-2"></div>
                        <div class="spinner-dot"></div>
                    </div>
                    <div class="loading-text" id="loadingText">Processing...</div>
                    <div class="loading-subtext" id="loadingSubtext">This may take a moment</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="loading-steps" id="loadingSteps">
                        <div class="loading-step" data-step="scan">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span>Scanning</span>
                        </div>
                        <div class="loading-step" data-step="extract">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/></svg>
                            <span>Extracting</span>
                        </div>
                        <div class="loading-step" data-step="analyze">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <span>Analyzing</span>
                        </div>
                        <div class="loading-step" data-step="match">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>
                            <span>Matching</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Area for Export -->
            <div id="resultsArea">

            <!-- Fraud Results -->
            <div class="section-card hidden" id="fraudSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Fraud Analysis</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('fraudSection', 'Fraud_Analysis')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" id="fraudResults"></div>
            </div>

            <!-- Extracted Data -->
            <div class="section-card hidden" id="dataSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Bank Analysis Worksheet</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('dataSection', 'Bank_Analysis')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" id="extractedData"></div>
            </div>

            <!-- Charts Section -->
            <div class="section-card hidden" id="chartsSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Cash Flow Analysis</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('chartsSection', 'Cash_Flow')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body">
                    <div class="chart-row">
                        <div class="chart-container">
                            <canvas id="balanceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Existing Debt Obligations -->
            <div class="section-card hidden" id="debtSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Existing Debt Obligations</span></div>
                    <div class="section-header-actions">
                        <span class="debt-total-badge" id="debtTotalBadge">$0/mo</span>
                        <button class="card-export-btn" onclick="exportCardAsPng('debtSection', 'Debt_Obligations')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="debt-summary" id="debtSummary">
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtTotalMonthly">$0</div>
                            <div class="debt-stat-label">Monthly Obligation</div>
                        </div>
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtPositionCount">0</div>
                            <div class="debt-stat-label">Active Positions</div>
                        </div>
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtEstBalance">$0</div>
                            <div class="debt-stat-label">Est. Total Balance</div>
                        </div>
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtToRevenue">0%</div>
                            <div class="debt-stat-label">Debt-to-Revenue</div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 200px; margin: 16px 0;">
                        <canvas id="debtChart"></canvas>
                    </div>
                    <div class="debt-table-container" id="debtTableContainer"></div>
                </div>
            </div>

            <!-- Background Research -->
            <div class="section-card hidden" id="researchSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Background Research: <span id="researchBusinessName">-</span></span></div>
                    <div class="section-header-actions">
                        <button class="btn" id="expandAllBtn" onclick="toggleAllModules()" style="font-size: 12px; padding: 6px 12px;">Expand All</button>
                        <button class="card-export-btn" onclick="exportCardAsPng('researchSection', 'Background_Research')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <!-- Progress Bar -->
                    <div class="research-progress" id="researchProgress">
                        <div class="research-progress-label">Research Progress</div>
                        <div class="research-progress-bar">
                            <div class="research-progress-fill" id="researchProgressFill" style="width: 0%"></div>
                        </div>
                        <div class="research-progress-text" id="researchProgressText">0 / 12</div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="research-summary" id="researchSummary" style="display: none;">
                        <div class="research-stat">
                            <div class="research-stat-value green" id="summaryLow">0</div>
                            <div class="research-stat-label">Low Risk</div>
                        </div>
                        <div class="research-stat">
                            <div class="research-stat-value yellow" id="summaryMedium">0</div>
                            <div class="research-stat-label">Medium Risk</div>
                        </div>
                        <div class="research-stat">
                            <div class="research-stat-value red" id="summaryHigh">0</div>
                            <div class="research-stat-label">High Risk</div>
                        </div>
                        <div class="research-stat">
                            <div class="research-stat-value" id="summaryFlags">0</div>
                            <div class="research-stat-label">Red Flags</div>
                        </div>
                    </div>

                    <!-- Module Grid -->
                    <div class="research-grid" id="researchResults"></div>
                </div>
            </div>

            <!-- Lender Results -->
            <div class="section-card hidden" id="lenderSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Lender Matches</span></div>
                    <div class="section-header-actions">
                        <span class="file-count" id="lenderCount"></span>
                        <button class="card-export-btn" onclick="exportCardAsPng('lenderSection', 'Lender_Matches')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="lender-grid" id="lenderResults"></div>
                </div>
            </div>

            <!-- Submit Instructions -->
            <div class="section-card hidden" id="submitSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Submission Instructions</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('submitSection', 'Submit_Instructions')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" id="submitInstructions"></div>
            </div>

            </div><!-- End resultsArea -->

            <!-- Empty State -->
            <div class="placeholder" id="emptyState">
                <div class="placeholder-icon"></div>
                <div>Drop bank statements in the sidebar to begin analysis</div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Settings</span>
                <button class="modal-close" onclick="closeModal('settingsModal')"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Gemini API Key</label>
                    <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your Gemini API key">
                </div>
                <div class="form-group">
                    <label class="form-label">Model</label>
                    <select class="form-input" id="modelSelect">
                        <option value="gemini-3-pro-preview">Gemini 3 Pro (Best)</option>
                        <option value="gemini-3-flash-preview">Gemini 3 Flash (Recommended)</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Watermark Image URL</label>
                    <input type="url" class="form-input" id="watermarkUrlInput" placeholder="https://example.com/logo.png">
                    <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">PNG with transparency recommended</small>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Fraud Detail Modal -->
    <div class="modal-overlay" id="fraudDetailModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Fraud Analysis Details</span>
                <button class="modal-close" onclick="closeModal('fraudDetailModal')"></button>
            </div>
            <div class="modal-body" id="fraudDetailContent"></div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal-overlay" id="downloadModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <span class="modal-title">Download Watermarked Files</span>
                <button class="modal-close" onclick="closeModal('downloadModal')"></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">Edit filenames before downloading:</p>
                <div id="downloadFileList" style="max-height: 300px; overflow-y: auto;"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="executeDownload()">
                    Download All
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title">Export Report</span>
                <button class="modal-close" onclick="closeModal('exportModal')"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Export Settings Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Export Settings</div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Scale (DPI)</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportScaleSlider" min="1" max="4" step="0.5" value="2" style="flex: 1;">
                                <span id="exportScaleVal" style="font-size: 13px; color: var(--text); min-width: 30px;">2x</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">Higher = better quality, larger file</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Padding (px)</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportPaddingSlider" min="0" max="48" step="4" value="24" style="flex: 1;">
                                <span id="exportPaddingVal" style="font-size: 13px; color: var(--text); min-width: 30px;">24px</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">Whitespace around content</small>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Image Quality</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportQualitySlider" min="0.5" max="1" step="0.1" value="1" style="flex: 1;">
                                <span id="exportQualityVal" style="font-size: 13px; color: var(--text); min-width: 40px;">100%</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">JPEG/PNG compression</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Max Width (px)</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportWidthSlider" min="800" max="1920" step="80" value="1200" style="flex: 1;">
                                <span id="exportWidthVal" style="font-size: 13px; color: var(--text); min-width: 50px;">1200</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">Content area width</small>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Background</label>
                            <select class="form-input" id="exportBgSelect" style="padding: 8px 12px;">
                                <option value="#ffffff">White</option>
                                <option value="#f8fafc">Light Gray</option>
                                <option value="#f3f4f6">Gray</option>
                                <option value="transparent">Transparent (PNG only)</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Theme</label>
                            <select class="form-input" id="exportThemeSelect" style="padding: 8px 12px;">
                                <option value="light">Light (Recommended)</option>
                                <option value="dark">Dark</option>
                                <option value="current">Current Theme</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Export Buttons -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Quick Export</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="btn" onclick="exportMethod('png-clean'); closeModal('exportModal');" style="padding: 12px 8px; font-size: 12px;">
                            <div style="font-size: 18px; margin-bottom: 4px;"></div>
                            PNG Light
                        </button>
                        <button class="btn" onclick="exportMethod('png-native'); closeModal('exportModal');" style="padding: 12px 8px; font-size: 12px;">
                            <div style="font-size: 18px; margin-bottom: 4px;"></div>
                            PNG Native
                        </button>
                        <button class="btn" onclick="exportMethod('pdf'); closeModal('exportModal');" style="padding: 12px 8px; font-size: 12px;">
                            <div style="font-size: 18px; margin-bottom: 4px;"></div>
                            PDF
                        </button>
                    </div>
                </div>

                <!-- Sections to Export -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Sections to Include</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportFraud" checked style="accent-color: var(--gold);">
                            Fraud Analysis
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportData" checked style="accent-color: var(--gold);">
                            Bank Analysis
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportCharts" checked style="accent-color: var(--gold);">
                            Cash Flow Charts
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportDebt" checked style="accent-color: var(--gold);">
                            Debt Obligations
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportResearch" checked style="accent-color: var(--gold);">
                            Background Research
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportLenders" checked style="accent-color: var(--gold);">
                            Lender Matches
                        </label>
                    </div>
                </div>

                <!-- Export All Sections -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="exportWithSettings('png'); closeModal('exportModal');" style="padding: 14px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 8px; display: inline;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        Export as PNG
                    </button>
                    <button class="btn btn-primary" onclick="exportWithSettings('pdf'); closeModal('exportModal');" style="padding: 14px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 8px; display: inline;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                        Export as PDF
                    </button>
                </div>

                <!-- Other Export Options -->
                <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Other Formats</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <button class="btn" onclick="exportMethod('print'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             Print
                        </button>
                        <button class="btn" onclick="exportMethod('json'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             JSON
                        </button>
                        <button class="btn" onclick="exportMethod('csv'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             CSV
                        </button>
                        <button class="btn" onclick="exportMethod('clipboard'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Lender Profiles
        const lenderProfiles = [
            {name:"Trust Capital Funding",id:"TCF",min_credit:550,min_tib:6,min_deposits:20000,min_num_deps:10,min_adb:2500,max_nsf:3,method:"email",email:"submissions@trustcapitalfunding.com",min_rate:1.28,max_rate:1.42,min_term:6,max_term:12,max_amount:480000,frequency:"Daily"},
            {name:"Wide Merchant Group",id:"WMG",min_credit:480,min_tib:6,min_deposits:8000,min_num_deps:2,min_adb:750,max_nsf:0,max_position:6,method:"email",email:"deals@widemerchantgroup.com",min_rate:1.46,max_rate:1.49,min_term:3,max_term:9,max_amount:25000,frequency:"Daily"},
            {name:"Kapitus",id:"KAP",method:"portal",portal:"https://partner.kapitus.com",min_rate:1.15,max_rate:1.35,min_term:6,max_term:24,max_amount:200000,frequency:"Weekly"},
            {name:"Kalamata Capital",id:"KAL",min_credit:600,min_tib:12,min_deposits:40000,min_num_deps:5,min_adb:5000,max_nsf:3,max_position:3,method:"email",email:"submissions@kalamatacapital.com",min_rate:1.18,max_rate:1.45,min_term:6,max_term:15,max_amount:275000,frequency:"Weekly"},
            {name:"Rapid Finance",id:"RAF",min_credit:620,min_tib:36,min_deposits:10000,method:"portal",portal:"https://portal.rapidfinance.com",min_rate:1.28,max_rate:1.48,min_term:3,max_term:12,max_amount:400000,frequency:"Weekly"},
            {name:"Alternative Funding Group",id:"AFG",min_credit:550,min_tib:12,min_deposits:20000,min_num_deps:4,min_adb:1000,max_nsf:4,max_position:4,method:"email",email:"deals@altfundinggroup.com",min_rate:1.37,max_rate:1.46,min_term:4,max_term:10,max_amount:150000,frequency:"Weekly"},
            {name:"Fundfi",id:"FMF",min_tib:12,min_deposits:35000,min_num_deps:6,max_nsf:5,max_position:5,method:"email",email:"submit@fundfi.com",min_rate:1.45,max_rate:1.46,min_term:6,max_term:12,max_amount:85000,frequency:"Daily"},
            {name:"Bitty Advance",id:"BIT",min_credit:500,min_tib:12,min_deposits:5000,max_nsf:7,max_position:3,method:"email",email:"submissions@bittyadvance.com",min_rate:1.55,max_rate:1.59,min_term:2,max_term:6,max_amount:35000,frequency:"Daily"},
            {name:"JRG Funding",id:"JRG",min_credit:500,min_tib:12,min_deposits:15000,min_num_deps:4,min_adb:1000,max_nsf:4,max_position:8,method:"email",email:"deals@jrgfunding.com",min_rate:1.29,max_rate:1.40,min_term:3,max_term:12,max_amount:200000,frequency:"Weekly"},
            {name:"eFinancial Tree",id:"EFT",min_credit:500,min_tib:6,min_deposits:15000,min_num_deps:2,min_adb:1000,max_nsf:3,max_position:3,method:"email",email:"submit@efinancialtree.com",min_rate:1.30,max_rate:1.45,min_term:3,max_term:10,max_amount:105000,frequency:"Weekly"},
            {name:"Silverline Funding",id:"SLF",min_credit:500,min_tib:5,min_deposits:25000,min_adb:1000,max_nsf:3,max_position:6,method:"email",email:"submissions@silverlinefunding.com",min_rate:1.40,max_rate:1.48,min_term:3,max_term:12,max_amount:15000,frequency:"Weekly"},
            {name:"Smart Step Funding",id:"SSF",min_credit:600,min_tib:24,min_deposits:10000,min_num_deps:6,method:"email",email:"deals@smartstepfunding.com",min_rate:1.25,max_rate:1.35,min_term:9,max_term:17,max_amount:110000,frequency:"Weekly"},
            {name:"Reliable Capital",id:"REL",min_credit:525,min_tib:12,min_deposits:25000,max_nsf:3,method:"email",email:"submit@reliablecapital.com",min_rate:1.35,max_rate:1.42,min_term:6,max_term:12,max_amount:45000,frequency:"Weekly"},
            {name:"Ondeck",id:"OND",method:"portal",portal:"https://partner.ondeck.com",min_rate:1.20,max_rate:1.35,min_term:6,max_term:24,max_amount:250000,frequency:"Weekly"},
            {name:"1DC Funding",id:"1DC",method:"email",email:"submissions@1dcfunding.com",min_rate:1.45,max_rate:1.60,min_term:3,max_term:12,max_amount:260000,frequency:"Daily"},
            {name:"Forward Financing",id:"FF",method:"portal",portal:"https://broker.forwardfinancing.com",min_rate:1.37,max_rate:1.51,min_term:4,max_term:15,max_amount:65000,frequency:"Weekly"},
            {name:"Credibly",id:"CRE",method:"portal",portal:"https://portal.credibly.com",min_rate:1.40,max_rate:1.49,min_term:6,max_term:18,max_amount:116200,frequency:"Weekly"}
        ];

        // State
        let files = [];
        let extractedData = null;
        let matchedLenders = [];
        let charts = {};
        let activeFileIndex = -1;
        let logoImage = null;
        let canvas = null;
        let ctx = null;
        const settings = { opacity: 0.25, size: 0.15, density: 0.50, rotation: 45 };

        // Export settings
        const exportSettings = {
            scale: 2,
            padding: 24,
            quality: 1,
            width: 1200,
            background: '#ffffff',
            theme: 'light'
        };

        // Initialize
        function init() {
            // Initialize canvas
            canvas = document.getElementById('previewCanvas');
            ctx = canvas ? canvas.getContext('2d') : null;

            // Load settings
            document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_key') || '';
            document.getElementById('modelSelect').value = localStorage.getItem('gemini_model') || 'gemini-3-flash-preview';
            document.getElementById('watermarkUrlInput').value = localStorage.getItem('watermark_url') || 'https://i.imgur.com/MXMqYLc.png';
            loadWatermark(localStorage.getItem('watermark_url') || 'https://i.imgur.com/MXMqYLc.png');

            // Load theme
            const theme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);

            // Event listeners
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('click', () => document.getElementById('fileInput').click());
            uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
            uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
            uploadZone.addEventListener('drop', e => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));
            document.getElementById('processBtn').addEventListener('click', processDocuments);
            document.getElementById('downloadAllBtn').addEventListener('click', downloadAll);
            document.getElementById('settingsBtn').addEventListener('click', () => openModal('settingsModal'));
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('exportBtn').addEventListener('click', () => openModal('exportModal'));

            // Watermark slider controls
            ['opacity', 'size', 'density', 'rotation'].forEach(key => {
                const slider = document.getElementById(key + 'Slider');
                if (slider) {
                    slider.addEventListener('input', () => {
                        const val = parseInt(slider.value);
                        document.getElementById(key + 'Val').textContent = key === 'rotation' ? val + '' : val + '%';
                        settings[key] = key === 'rotation' ? val : val / 100;
                        if (activeFileIndex >= 0) renderPreview();
                    });
                }
            });

            // Export slider controls
            const exportScaleSlider = document.getElementById('exportScaleSlider');
            if (exportScaleSlider) {
                exportScaleSlider.addEventListener('input', () => {
                    exportSettings.scale = parseFloat(exportScaleSlider.value);
                    document.getElementById('exportScaleVal').textContent = exportSettings.scale + 'x';
                });
            }

            const exportPaddingSlider = document.getElementById('exportPaddingSlider');
            if (exportPaddingSlider) {
                exportPaddingSlider.addEventListener('input', () => {
                    exportSettings.padding = parseInt(exportPaddingSlider.value);
                    document.getElementById('exportPaddingVal').textContent = exportSettings.padding + 'px';
                });
            }

            const exportQualitySlider = document.getElementById('exportQualitySlider');
            if (exportQualitySlider) {
                exportQualitySlider.addEventListener('input', () => {
                    exportSettings.quality = parseFloat(exportQualitySlider.value);
                    document.getElementById('exportQualityVal').textContent = Math.round(exportSettings.quality * 100) + '%';
                });
            }

            const exportWidthSlider = document.getElementById('exportWidthSlider');
            if (exportWidthSlider) {
                exportWidthSlider.addEventListener('input', () => {
                    exportSettings.width = parseInt(exportWidthSlider.value);
                    document.getElementById('exportWidthVal').textContent = exportSettings.width;
                });
            }

            const exportBgSelect = document.getElementById('exportBgSelect');
            if (exportBgSelect) {
                exportBgSelect.addEventListener('change', () => {
                    exportSettings.background = exportBgSelect.value;
                });
            }

            const exportThemeSelect = document.getElementById('exportThemeSelect');
            if (exportThemeSelect) {
                exportThemeSelect.addEventListener('change', () => {
                    exportSettings.theme = exportThemeSelect.value;
                });
            }

            // Load saved PDF compression preset
            loadPdfPreset();

            // Load saved watermark defaults
            const savedWatermark = JSON.parse(localStorage.getItem('watermark_defaults') || 'null');
            if (savedWatermark) {
                if (savedWatermark.opacity) {
                    document.getElementById('opacitySlider').value = savedWatermark.opacity * 100;
                    document.getElementById('opacityVal').textContent = Math.round(savedWatermark.opacity * 100) + '%';
                    settings.opacity = savedWatermark.opacity;
                }
                if (savedWatermark.size) {
                    document.getElementById('sizeSlider').value = savedWatermark.size * 100;
                    document.getElementById('sizeVal').textContent = Math.round(savedWatermark.size * 100) + '%';
                    settings.size = savedWatermark.size;
                }
                if (savedWatermark.density) {
                    document.getElementById('densitySlider').value = savedWatermark.density * 100;
                    document.getElementById('densityVal').textContent = Math.round(savedWatermark.density * 100) + '%';
                    settings.density = savedWatermark.density;
                }
                if (savedWatermark.rotation !== undefined) {
                    document.getElementById('rotationSlider').value = savedWatermark.rotation;
                    document.getElementById('rotationVal').textContent = savedWatermark.rotation + '';
                    settings.rotation = savedWatermark.rotation;
                }
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function saveSettings() {
            localStorage.setItem('gemini_key', document.getElementById('apiKeyInput').value);
            localStorage.setItem('gemini_model', document.getElementById('modelSelect').value);
            localStorage.setItem('watermark_url', document.getElementById('watermarkUrlInput').value);
            loadWatermark(document.getElementById('watermarkUrlInput').value);
            closeModal('settingsModal');
            showStatus('Settings saved!', 'success');
        }

        function saveWatermarkDefaults() {
            // Save watermark settings
            const defaults = {
                opacity: settings.opacity,
                size: settings.size,
                density: settings.density,
                rotation: settings.rotation
            };
            localStorage.setItem('watermark_defaults', JSON.stringify(defaults));

            showStatus('Defaults saved!', 'success');
        }

        function setPdfPreset(btn) {
            // No longer used - PDFs export at full quality
        }

        function loadPdfPreset() {
            // No longer used - PDFs export at full quality
        }

        function loadWatermark(url) {
            logoImage = new Image();
            logoImage.crossOrigin = 'anonymous';
            logoImage.onload = () => { if (activeFileIndex >= 0) renderPreview(); };
            logoImage.onerror = () => { console.warn('Failed to load watermark image'); };
            logoImage.src = url;
        }

        function renderPreview() {
            if (activeFileIndex < 0 || !canvas || !ctx) return;
            const file = files[activeFileIndex];
            if (!file || !file.pages || !file.pages[file.currentPage]) return;

            const img = file.pages[file.currentPage];
            if (!img || !img.width || !img.height) return;

            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // Only add watermark if logo is loaded
            if (logoImage && logoImage.complete && logoImage.naturalWidth > 0) {
                ctx.globalAlpha = settings.opacity;
                const logoW = img.width * settings.size * 1.5;
                const logoH = (logoImage.height / logoImage.width) * logoW;
                const gap = 1.5 - settings.density;
                const spaceX = logoW * gap + 80;
                const spaceY = logoH * gap + 80;
                const rad = settings.rotation * Math.PI / 180;

                for (let y = -logoH; y < img.height + logoH; y += spaceY) {
                    for (let x = -logoW; x < img.width + logoW; x += spaceX) {
                        ctx.save();
                        ctx.translate(x + logoW/2, y + logoH/2);
                        ctx.rotate(rad);
                        ctx.drawImage(logoImage, -logoW/2, -logoH/2, logoW, logoH);
                        ctx.restore();
                    }
                }
                ctx.globalAlpha = 1;
            }
        }

        function togglePreviewSize() {
            const container = document.getElementById('previewContainer');
            const overlay = document.getElementById('previewOverlay');
            container.classList.toggle('expanded');
            overlay.classList.toggle('visible');
        }

        function selectFile(idx) {
            activeFileIndex = idx;
            const file = files[idx];
            if (!file) return;
            if (file.currentPage === undefined) file.currentPage = 0;
            document.getElementById('watermarkPlaceholder').style.display = 'none';
            canvas.style.display = 'block';
            updateFileList();
            renderPreview();
        }

        function downloadAll() {
            if (files.length === 0) return;
            if (!logoImage || !logoImage.complete) {
                showStatus('Watermark image not loaded. Check settings.', 'error');
                return;
            }

            // Build download list
            const list = document.getElementById('downloadFileList');
            list.innerHTML = files.map((f, i) => {
                const baseName = f.outputName || f.name.replace(/\.[^.]+$/, '');
                const ext = f.pages.length === 1 ? '.png' : '.pdf';
                return `
                    <div class="download-file-item">
                        <img src="${f.thumb}" alt="">
                        <input type="text" id="downloadName_${i}" value="${baseName}_watermarked">
                        <span class="file-ext">${ext}</span>
                    </div>
                `;
            }).join('');

            openModal('downloadModal');
        }

        async function executeDownload() {
            closeModal('downloadModal');
            showStatus('Preparing watermarked downloads...', 'info');

            // Get watermark image as PNG bytes for pdf-lib
            let watermarkPngBytes = null;
            if (logoImage && logoImage.complete && logoImage.naturalWidth > 0) {
                try {
                    const wmCanvas = document.createElement('canvas');
                    wmCanvas.width = logoImage.naturalWidth;
                    wmCanvas.height = logoImage.naturalHeight;
                    const wmCtx = wmCanvas.getContext('2d');
                    wmCtx.drawImage(logoImage, 0, 0);
                    const dataUrl = wmCanvas.toDataURL('image/png');
                    const base64 = dataUrl.split(',')[1];
                    watermarkPngBytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                } catch (e) {
                    console.error('Error creating watermark bytes:', e);
                }
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const nameInput = document.getElementById(`downloadName_${i}`);
                const safeLabel = (nameInput?.value || file.name.replace(/\.[^.]+$/, '')).replace(/[^a-z0-9_\-\s]/gi, '_');

                if (file.isPdf && file.originalPdfBytes && watermarkPngBytes) {
                    // Use pdf-lib to overlay watermark on original PDF (preserves vector content)
                    try {
                        const { PDFDocument } = PDFLib;
                        const pdfDoc = await PDFDocument.load(file.originalPdfBytes.slice(0));
                        const watermarkImage = await pdfDoc.embedPng(watermarkPngBytes);
                        const pages = pdfDoc.getPages();

                        for (const page of pages) {
                            const { width, height } = page.getSize();
                            const wmWidth = watermarkImage.width;
                            const wmHeight = watermarkImage.height;

                            // Calculate watermark size based on settings
                            const baseSize = Math.min(width, height) * (settings.size / 100) * 0.5;
                            const wmScale = baseSize / Math.max(wmWidth, wmHeight);
                            const drawWidth = wmWidth * wmScale;
                            const drawHeight = wmHeight * wmScale;

                            // Calculate spacing based on density - ensure minimum spacing
                            const spacing = Math.max(50, Math.max(drawWidth, drawHeight) * (2.5 - settings.density / 50));

                            // Draw tiled watermarks
                            for (let y = 0; y < height; y += spacing) {
                                for (let x = 0; x < width; x += spacing) {
                                    page.drawImage(watermarkImage, {
                                        x: x,
                                        y: y,
                                        width: drawWidth,
                                        height: drawHeight,
                                        opacity: settings.opacity / 100,
                                        rotate: PDFLib.degrees(-settings.rotation)
                                    });
                                }
                            }
                        }

                        const pdfBytes = await pdfDoc.save();
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `${safeLabel}.pdf`;
                        link.click();
                        URL.revokeObjectURL(link.href);
                        showStatus('Download complete!', 'success');
                    } catch (err) {
                        console.error('pdf-lib error:', err);
                        showStatus('Error processing PDF: ' + err.message, 'error');
                    }
                } else if (file.pages.length === 1) {
                    // Single image - download as PNG with watermark
                    activeFileIndex = i;
                    file.currentPage = 0;
                    renderPreview();
                    await new Promise(r => setTimeout(r, 150));

                    const link = document.createElement('a');
                    link.download = `${safeLabel}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } else {
                    // Multi-page non-PDF (shouldn't happen, but fallback to jsPDF)
                    const { jsPDF } = window.jspdf;
                    file.currentPage = 0;
                    activeFileIndex = i;
                    renderPreview();
                    await new Promise(r => setTimeout(r, 150));

                    const pdf = new jsPDF({ orientation: canvas.width > canvas.height ? 'landscape' : 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(canvas.toDataURL('image/jpeg', 0.85), 'JPEG', 0, 0, canvas.width, canvas.height);

                    for (let p = 1; p < file.pages.length; p++) {
                        file.currentPage = p;
                        renderPreview();
                        await new Promise(r => setTimeout(r, 150));
                        pdf.addPage([canvas.width, canvas.height]);
                        pdf.addImage(canvas.toDataURL('image/jpeg', 0.85), 'JPEG', 0, 0, canvas.width, canvas.height);
                    }
                    pdf.save(`${safeLabel}.pdf`);
                }
                await new Promise(r => setTimeout(r, 300));
            }
            showStatus('Downloads complete!', 'success');
        }

        // Export Menu Functions
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.export-menu-container');
            const dropdown = document.getElementById('exportDropdown');
            if (container && dropdown && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        async function exportMethod(method) {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.remove('show');

            if (!extractedData.full_analysis) {
                showStatus('No analysis data to export', 'error');
                return;
            }

            switch(method) {
                case 'png-clean':
                    await exportPngClean();
                    break;
                case 'png-iframe':
                    await exportPngIframe();
                    break;
                case 'png-native':
                    await exportPngNative();
                    break;
                case 'pdf':
                    await exportPdf();
                    break;
                case 'print':
                    exportPrint();
                    break;
                case 'json':
                    exportJson();
                    break;
                case 'csv':
                    exportCsv();
                    break;
                case 'clipboard':
                    await exportClipboard();
                    break;
            }
        }

        // Create branded export header
        function createExportHeader(isDark = false) {
            const businessName = extractedBusinessInfo.name || 'Business Analysis';
            const ownerName = extractedBusinessInfo.owner || '';
            const exportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 24px;
                margin-bottom: 20px;
                background: ${isDark ? '#1a1a1a' : '#f8fafc'};
                border: 1px solid ${isDark ? '#333' : '#e2e8f0'};
                border-radius: 12px;
            `;

            header.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; position: relative;">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <ellipse cx="50" cy="50" rx="35" ry="12" fill="none" stroke="#eab308" stroke-width="4" transform="rotate(-20 50 50)"/>
                            <circle cx="50" cy="50" r="18" fill="#f97316"/>
                            <ellipse cx="50" cy="50" rx="42" ry="8" fill="none" stroke="#eab308" stroke-width="2" transform="rotate(-20 50 50)" opacity="0.5"/>
                        </svg>
                    </div>
                    <div>
                        <div style="font-size: 18px; font-weight: 700; color: ${isDark ? '#ffffff' : '#111827'};">Vision Pro</div>
                        <div style="font-size: 11px; color: ${isDark ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">Bank Statement Analysis</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 16px; font-weight: 600; color: ${isDark ? '#ffffff' : '#111827'};">${businessName}</div>
                    ${ownerName ? `<div style="font-size: 13px; color: ${isDark ? '#9ca3af' : '#6b7280'};">${ownerName}</div>` : ''}
                    <div style="font-size: 12px; color: ${isDark ? '#6b7280' : '#9ca3af'}; margin-top: 4px;">${exportDate}</div>
                </div>
            `;

            return header;
        }

        // Create export footer
        function createExportFooter(isDark = false) {
            const footer = document.createElement('div');
            footer.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 24px;
                margin-top: 20px;
                background: ${isDark ? '#1a1a1a' : '#f8fafc'};
                border: 1px solid ${isDark ? '#333' : '#e2e8f0'};
                border-radius: 12px;
                font-size: 11px;
                color: ${isDark ? '#6b7280' : '#9ca3af'};
            `;

            footer.innerHTML = `
                <div>Generated by Vision Pro  ables.ai</div>
                <div>Confidential - For Internal Use Only</div>
            `;

            return footer;
        }

        // Export with custom settings from modal
        async function exportWithSettings(format = 'png') {
            if (!extractedData.full_analysis) {
                showStatus('No analysis data to export', 'error');
                return;
            }

            showStatus(`Generating ${format.toUpperCase()} with custom settings...`, 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Get selected sections
                const includeFraud = document.getElementById('exportFraud')?.checked ?? true;
                const includeData = document.getElementById('exportData')?.checked ?? true;
                const includeCharts = document.getElementById('exportCharts')?.checked ?? true;
                const includeDebt = document.getElementById('exportDebt')?.checked ?? true;
                const includeResearch = document.getElementById('exportResearch')?.checked ?? true;
                const includeLenders = document.getElementById('exportLenders')?.checked ?? true;

                const isDark = exportSettings.theme === 'dark' || (exportSettings.theme === 'current' && document.documentElement.getAttribute('data-theme') !== 'light');
                const useLight = exportSettings.theme !== 'dark';

                // TEMPORARILY switch to light theme before cloning
                const originalTheme = document.documentElement.getAttribute('data-theme');
                if (useLight) {
                    document.documentElement.setAttribute('data-theme', 'light');
                }

                // Small delay to let CSS recompute
                await new Promise(r => setTimeout(r, 100));

                // Create wrapper with settings
                const wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    background: ${exportSettings.background};
                    padding: ${exportSettings.padding}px;
                    width: ${exportSettings.width}px;
                `;

                // Add branded header
                wrapper.appendChild(createExportHeader(isDark));

                // Clone the results AFTER theme switch
                const clone = resultsArea.cloneNode(true);

                // Remove hidden class from all elements
                clone.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));

                // Remove all buttons
                clone.querySelectorAll('button, .card-export-btn, .expand-toggle').forEach(el => el.remove());

                // Hide/show sections based on checkboxes
                if (!includeFraud) clone.querySelector('#fraudSection')?.remove();
                if (!includeData) clone.querySelector('#dataSection')?.remove();
                if (!includeCharts) clone.querySelector('#chartsSection')?.remove();
                if (!includeDebt) clone.querySelector('#debtSection')?.remove();
                if (!includeResearch) clone.querySelector('#researchSection')?.remove();
                if (!includeLenders) clone.querySelector('#lenderSection')?.remove();

                wrapper.appendChild(clone);

                // Add footer
                wrapper.appendChild(createExportFooter(isDark));

                // IMPORTANT: Append to DOM FIRST so computed styles work
                document.body.appendChild(wrapper);

                // Now force all light styles AFTER it's in the DOM
                if (useLight) {
                    forceAllLightStyles(clone);
                }

                await new Promise(r => setTimeout(r, 300));

                const canvas = await html2canvas(wrapper, {
                    scale: exportSettings.scale,
                    useCORS: true,
                    backgroundColor: exportSettings.background === 'transparent' ? null : exportSettings.background,
                    logging: false,
                    allowTaint: true
                });

                document.body.removeChild(wrapper);

                // Restore original theme
                if (originalTheme) {
                    document.documentElement.setAttribute('data-theme', originalTheme);
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }

                if (format === 'pdf') {
                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const pdfWidth = 612;
                    const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
                    const maxPageHeight = 792;

                    if (pdfHeight <= maxPageHeight) {
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] });
                        pdf.addImage(canvas.toDataURL('image/png', exportSettings.quality), 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(getFilename('pdf'));
                    } else {
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                        const pageHeightInCanvasPixels = (maxPageHeight * imgWidth) / pdfWidth;
                        let position = 0;
                        let pageNum = 0;

                        while (position < imgHeight) {
                            if (pageNum > 0) pdf.addPage();

                            const pageCanvas = document.createElement('canvas');
                            pageCanvas.width = imgWidth;
                            pageCanvas.height = Math.min(pageHeightInCanvasPixels, imgHeight - position);
                            const ctx = pageCanvas.getContext('2d');
                            ctx.drawImage(canvas, 0, position, imgWidth, pageCanvas.height, 0, 0, imgWidth, pageCanvas.height);

                            const scaledHeight = (pageCanvas.height * pdfWidth) / imgWidth;
                            pdf.addImage(pageCanvas.toDataURL('image/png', exportSettings.quality), 'PNG', 0, 0, pdfWidth, scaledHeight);

                            position += pageHeightInCanvasPixels;
                            pageNum++;
                        }

                        pdf.save(getFilename('pdf'));
                    }
                    showStatus('PDF exported!', 'success');
                } else {
                    // PNG download
                    const link = document.createElement('a');
                    link.download = getFilename('png');
                    link.href = canvas.toDataURL('image/png', exportSettings.quality);
                    link.click();
                    showStatus('PNG exported!', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Nuclear option - force ALL elements to light styles
        function forceAllLightStyles(clone) {
            // Set wrapper background explicitly
            clone.style.background = '#ffffff';
            clone.style.backgroundColor = '#ffffff';

            // First, iterate through ALL elements and force light colors
            clone.querySelectorAll('*').forEach(el => {
                const style = el.style;
                const computed = window.getComputedStyle(el);

                // Force background colors - check actual computed value
                const bg = computed.backgroundColor;
                if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') {
                    const rgb = bg.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        // If dark background (r,g,b all below threshold), make it white/light
                        if (r < 50 && g < 50 && b < 50) {
                            style.setProperty('background-color', '#ffffff', 'important');
                            style.setProperty('background', '#ffffff', 'important');
                        } else if (r < 100 && g < 100 && b < 100) {
                            style.setProperty('background-color', '#f9fafb', 'important');
                            style.setProperty('background', '#f9fafb', 'important');
                        }
                    }
                }

                // Force text colors
                const color = computed.color;
                if (color) {
                    const rgb = color.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        // If light text (white/gray), make it dark
                        if (r > 180 && g > 180 && b > 180) {
                            style.setProperty('color', '#111827', 'important');
                        } else if (r > 140 && g > 140 && b > 140) {
                            style.setProperty('color', '#374151', 'important');
                        }
                    }
                }

                // Force border colors
                const borderColor = computed.borderColor;
                if (borderColor && borderColor.includes('rgb')) {
                    const rgb = borderColor.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        if (r < 80 && g < 80 && b < 80) {
                            style.setProperty('border-color', '#d1d5db', 'important');
                        }
                    }
                }
            });

            // Now apply specific component styles
            applyExportLightStyles(clone);
        }

        // Helper function to apply light styles
        function applyExportLightStyles(clone) {
            // Style section cards
            clone.querySelectorAll('.section-card').forEach(card => {
                card.style.cssText = 'background: #ffffff !important; border: 1px solid #d1d5db !important; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
            });

            clone.querySelectorAll('.section-header').forEach(header => {
                header.style.cssText = 'background: #f3f4f6 !important; color: #111827 !important; padding: 16px 20px; border-bottom: 1px solid #d1d5db !important; font-weight: 600; font-size: 14px;';
            });

            clone.querySelectorAll('.section-body').forEach(body => {
                body.style.cssText = 'background: #ffffff !important; padding: 20px; color: #111827 !important;';
            });

            // Data cards
            clone.querySelectorAll('.data-card').forEach(card => {
                const borderStyle = card.getAttribute('style') || '';
                let borderColor = '#d1d5db', bgColor = '#f9fafb';
                if (borderStyle.includes('green')) { borderColor = '#22c55e'; bgColor = '#dcfce7'; }
                else if (borderStyle.includes('yellow')) { borderColor = '#eab308'; bgColor = '#fef9c3'; }
                else if (borderStyle.includes('red')) { borderColor = '#ef4444'; bgColor = '#fee2e2'; }
                card.style.cssText = `background: ${bgColor} !important; border: 2px solid ${borderColor} !important; border-radius: 8px; padding: 16px; text-align: center;`;
            });

            // Data values
            clone.querySelectorAll('.data-label').forEach(l => l.style.cssText = 'font-size: 11px; color: #6b7280 !important;');
            clone.querySelectorAll('.data-value').forEach(val => {
                let color = '#111827';
                if (val.classList.contains('green')) color = '#16a34a';
                if (val.classList.contains('red')) color = '#dc2626';
                if (val.classList.contains('gold')) color = '#ca8a04';
                val.style.cssText = `font-size: 24px; font-weight: 700; color: ${color} !important;`;
            });

            // Fraud items - compact box layout
            clone.querySelectorAll('.fraud-item').forEach(item => {
                const s = item.getAttribute('style') || '';
                let borderColor = '#d1d5db', bgColor = '#f9fafb';
                if (s.includes('green') || s.includes('#22c55e')) { borderColor = '#22c55e'; bgColor = '#dcfce7'; }
                else if (s.includes('yellow') || s.includes('#eab308')) { borderColor = '#eab308'; bgColor = '#fef9c3'; }
                else if (s.includes('red') || s.includes('#ef4444')) { borderColor = '#ef4444'; bgColor = '#fee2e2'; }
                item.style.cssText = `background: ${bgColor} !important; border: 1px solid ${borderColor} !important; border-radius: 8px; padding: 10px 12px; display: flex; align-items: center; gap: 8px;`;
            });

            // Fraud details grid
            clone.querySelectorAll('.fraud-details').forEach(grid => {
                grid.style.cssText = 'display: grid !important; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; gap: 8px !important;';
            });

            // Risk chips
            clone.querySelectorAll('.risk-chip').forEach(chip => {
                const isGood = chip.classList.contains('good');
                const isWarn = chip.classList.contains('warn');
                const isBad = chip.classList.contains('bad');
                let bg = '#f3f4f6', border = '#d1d5db';
                if (isGood) { bg = '#dcfce7'; border = '#22c55e'; }
                if (isWarn) { bg = '#fef9c3'; border = '#eab308'; }
                if (isBad) { bg = '#fee2e2'; border = '#ef4444'; }
                chip.style.cssText = `background: ${bg} !important; border: 2px solid ${border} !important; padding: 12px; border-radius: 8px; text-align: center;`;
            });

            clone.querySelectorAll('.risk-chip-value').forEach(val => {
                const parent = val.closest('.risk-chip');
                let color = '#111827';
                if (parent?.classList.contains('good')) color = '#166534';
                if (parent?.classList.contains('warn')) color = '#854d0e';
                if (parent?.classList.contains('bad')) color = '#991b1b';
                val.style.cssText = `font-size: 28px; font-weight: 700; color: ${color} !important;`;
            });
            clone.querySelectorAll('.risk-chip-label').forEach(l => l.style.cssText = 'font-size: 11px; color: #6b7280 !important;');

            // Tables
            clone.querySelectorAll('table').forEach(t => t.style.cssText = 'background: #ffffff !important; border-collapse: collapse; width: 100%; border: 1px solid #e5e7eb;');
            clone.querySelectorAll('th').forEach(th => th.style.cssText = 'background: #f3f4f6 !important; color: #111827 !important; padding: 12px; border: 1px solid #e5e7eb !important;');
            clone.querySelectorAll('td').forEach(td => td.style.cssText = 'background: #ffffff !important; color: #111827 !important; padding: 12px; border: 1px solid #e5e7eb !important;');

            // Stats
            clone.querySelectorAll('.debt-stat, .research-stat').forEach(s => s.style.cssText = 'background: #f3f4f6 !important; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;');
            clone.querySelectorAll('.debt-stat-value, .research-stat-value').forEach(v => v.style.cssText = 'color: #111827 !important; font-size: 24px; font-weight: 700;');
            clone.querySelectorAll('.debt-stat-label, .research-stat-label').forEach(l => l.style.cssText = 'color: #6b7280 !important; font-size: 12px;');

            // MCA sections
            clone.querySelectorAll('.mca-section, .mca-alert').forEach(m => m.style.cssText = 'background: #fee2e2 !important; border: 2px solid #ef4444 !important; border-radius: 8px; padding: 16px; color: #991b1b !important;');

            // Charts
            clone.querySelectorAll('.chart-container').forEach(c => c.style.cssText = 'background: #ffffff !important; border-radius: 8px; border: 1px solid #e5e7eb; padding: 12px;');

            // Research modules
            clone.querySelectorAll('.research-module').forEach(m => {
                const hasLow = m.classList.contains('risk-low');
                const hasMed = m.classList.contains('risk-medium');
                const hasHigh = m.classList.contains('risk-high');
                let borderColor = '#e5e7eb';
                if (hasLow) borderColor = '#22c55e';
                if (hasMed) borderColor = '#eab308';
                if (hasHigh) borderColor = '#ef4444';
                m.style.cssText = `background: #ffffff !important; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 3px solid ${borderColor}; overflow: hidden; margin-bottom: 12px;`;
            });
            clone.querySelectorAll('.research-module-header').forEach(h => h.style.cssText = 'display: flex !important; align-items: center !important; gap: 12px !important; background: #f9fafb !important; color: #111827 !important; padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #e5e7eb; cursor: pointer;');
            clone.querySelectorAll('.research-module-icon').forEach(icon => {
                const parent = icon.closest('.research-module');
                let bg = '#f3f4f6', color = '#6b7280';
                if (parent?.classList.contains('risk-low')) { bg = '#dcfce7'; color = '#22c55e'; }
                else if (parent?.classList.contains('risk-medium')) { bg = '#fef9c3'; color = '#eab308'; }
                else if (parent?.classList.contains('risk-high')) { bg = '#fee2e2'; color = '#ef4444'; }
                icon.style.cssText = `width: 40px !important; height: 40px !important; min-width: 40px !important; border-radius: 8px !important; background: ${bg} !important; display: flex !important; align-items: center !important; justify-content: center !important;`;
                const svg = icon.querySelector('svg');
                if (svg) svg.style.cssText = `stroke: ${color} !important; width: 20px !important; height: 20px !important;`;
            });
            clone.querySelectorAll('.research-module-info').forEach(info => info.style.cssText = 'flex: 1 !important; min-width: 0 !important;');
            clone.querySelectorAll('.research-module-name').forEach(name => name.style.cssText = 'font-size: 14px !important; font-weight: 600 !important; color: #111827 !important;');
            clone.querySelectorAll('.research-module-summary').forEach(sum => sum.style.cssText = 'font-size: 12px !important; color: #6b7280 !important; margin-top: 2px !important;');
            clone.querySelectorAll('.research-module-status').forEach(status => {
                const text = status.textContent?.toLowerCase() || '';
                let bg = '#f3f4f6', color = '#6b7280';
                if (text.includes('low')) { bg = '#dcfce7'; color = '#166534'; }
                else if (text.includes('medium')) { bg = '#fef9c3'; color = '#854d0e'; }
                else if (text.includes('high')) { bg = '#fee2e2'; color = '#991b1b'; }
                else if (text.includes('complete') || text.includes('done')) { bg = '#dcfce7'; color = '#166534'; }
                status.style.cssText = `background: ${bg} !important; color: ${color} !important; padding: 4px 10px !important; border-radius: 12px !important; font-size: 11px !important; font-weight: 600 !important; white-space: nowrap !important;`;
            });
            clone.querySelectorAll('.research-module-body').forEach(b => b.style.cssText = 'background: #ffffff !important; color: #111827 !important; padding: 16px;');
            clone.querySelectorAll('.research-module-content').forEach(c => c.style.cssText = 'background: #ffffff !important; color: #374151 !important; padding: 16px !important;');

            // Research grid
            clone.querySelectorAll('.research-grid').forEach(g => g.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;');

            // Research risk badges
            clone.querySelectorAll('.risk-badge, .research-risk').forEach(badge => {
                const text = badge.textContent?.toLowerCase() || '';
                let bg = '#f3f4f6', color = '#374151';
                if (text.includes('low')) { bg = '#dcfce7'; color = '#166534'; }
                else if (text.includes('medium')) { bg = '#fef9c3'; color = '#854d0e'; }
                else if (text.includes('high')) { bg = '#fee2e2'; color = '#991b1b'; }
                badge.style.cssText = `background: ${bg} !important; color: ${color} !important; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;`;
            });

            // Lender cards
            clone.querySelectorAll('.lender-card').forEach(card => {
                card.style.cssText = 'background: #f9fafb !important; border: 1px solid #e5e7eb !important; border-radius: 8px; padding: 16px;';
            });
            clone.querySelectorAll('.lender-name').forEach(n => n.style.cssText = 'color: #111827 !important; font-weight: 600;');
            clone.querySelectorAll('.lender-detail').forEach(d => d.style.cssText = 'color: #6b7280 !important; font-size: 12px;');

            // Debt table
            clone.querySelectorAll('.debt-table-container').forEach(c => c.style.cssText = 'background: #ffffff !important;');

            // Summary sections
            clone.querySelectorAll('.risk-summary, .debt-summary, .research-summary, .data-grid').forEach(s => {
                s.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;';
            });

            // Chart row
            clone.querySelectorAll('.chart-row').forEach(r => r.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 16px;');

            // Progress bars
            clone.querySelectorAll('.research-progress').forEach(p => p.style.cssText = 'background: #f3f4f6 !important; border-radius: 8px; padding: 12px; margin-bottom: 16px;');
            clone.querySelectorAll('.research-progress-bar').forEach(b => b.style.cssText = 'background: #e5e7eb !important; border-radius: 4px; height: 8px; overflow: hidden;');
            clone.querySelectorAll('.research-progress-fill').forEach(f => f.style.cssText = 'background: #22c55e !important; height: 100%;');

            // Apply to ALL elements - nuclear option for any remaining var() references
            clone.querySelectorAll('*').forEach(el => {
                const computed = window.getComputedStyle(el);
                const bgColor = computed.backgroundColor;
                const textColor = computed.color;

                // Parse RGB values to check if dark
                const rgbMatch = bgColor?.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (rgbMatch) {
                    const [_, r, g, b] = rgbMatch.map(Number);
                    // If background is dark (all RGB components below 50), make it white
                    if (r < 50 && g < 50 && b < 50) {
                        el.style.backgroundColor = '#ffffff';
                    }
                    // If it's a dark gray (all components between 50-80), make it light gray
                    else if (r < 80 && g < 80 && b < 80) {
                        el.style.backgroundColor = '#f3f4f6';
                    }
                }

                // If text is white/light, make it dark
                const textRgbMatch = textColor?.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (textRgbMatch) {
                    const [_, r, g, b] = textRgbMatch.map(Number);
                    if (r > 200 && g > 200 && b > 200) {
                        el.style.color = '#111827';
                    }
                }
            });

            // Final pass - ensure all text is readable
            clone.querySelectorAll('span, div, p, h1, h2, h3, h4, h5, h6, strong, em, label, td, th').forEach(el => {
                const c = el.style.color;
                if (!c || c === '' || c.includes('var(') || c.includes('rgba(255') || c.includes('rgb(255')) {
                    el.style.color = '#111827';
                }
            });
        }

        // Method 1: PNG Clean - DOM Clone with forced light styles
        async function exportPngClean() {
            showStatus('Generating PNG (Clean)...', 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Create a wrapper div with explicit light styles
                const wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    background: #ffffff;
                    padding: 24px;
                    width: ${resultsArea.offsetWidth}px;
                `;

                // Add branded header
                wrapper.appendChild(createExportHeader(false));

                // Clone the results
                const clone = resultsArea.cloneNode(true);

                // Remove hidden class from all elements
                clone.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));

                // Remove all buttons
                clone.querySelectorAll('button, .card-export-btn, .expand-toggle').forEach(el => el.remove());

                // Apply comprehensive light styling
                applyExportLightStyles(clone);

                wrapper.appendChild(clone);

                // Add footer
                wrapper.appendChild(createExportFooter(false));

                document.body.appendChild(wrapper);

                // Wait for any images/charts to render
                await new Promise(r => setTimeout(r, 200));

                const canvas = await html2canvas(wrapper, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true
                });

                document.body.removeChild(wrapper);

                downloadCanvas(canvas, 'png');
                showStatus('PNG exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 2: PNG Iframe - Render in isolated iframe
        async function exportPngIframe() {
            showStatus('Generating PNG (Iframe)...', 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Create iframe
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 900px; height: 5000px; border: none;';
                document.body.appendChild(iframe);

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Write complete HTML with light theme - SOLID COLORS
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: 'Inter', sans-serif;
                                background: #ffffff;
                                color: #111827;
                                padding: 24px;
                                line-height: 1.5;
                            }
                            .section-card {
                                background: #ffffff;
                                border: 1px solid #d1d5db;
                                border-radius: 12px;
                                margin-bottom: 20px;
                                overflow: hidden;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            }
                            .section-header {
                                background: #f3f4f6;
                                padding: 16px 20px;
                                font-weight: 600;
                                border-bottom: 1px solid #d1d5db;
                                color: #111827;
                            }
                            .section-body { padding: 20px; background: #ffffff; }
                            table { width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; }
                            th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border: 1px solid #e5e7eb; color: #111827; }
                            td { padding: 12px; border: 1px solid #e5e7eb; color: #111827; background: #ffffff; }

                            /* Data grid for fraud summary */
                            .data-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
                            .data-card { background: #f9fafb; padding: 16px; border-radius: 8px; text-align: center; border: 2px solid #d1d5db; }
                            .data-card[style*="green"] { background: #dcfce7 !important; border-color: #22c55e !important; }
                            .data-card[style*="yellow"] { background: #fef9c3 !important; border-color: #eab308 !important; }
                            .data-card[style*="red"] { background: #fee2e2 !important; border-color: #ef4444 !important; }
                            .data-label { font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
                            .data-value { font-size: 24px; font-weight: 700; color: #111827; }
                            .data-value.green { color: #16a34a !important; }
                            .data-value.red { color: #dc2626 !important; }
                            .data-value.gold { color: #ca8a04 !important; }

                            /* Fraud items */
                            .fraud-item { padding: 12px 16px; border-radius: 8px; background: #f9fafb; margin-bottom: 8px; border-left: 4px solid #d1d5db; }
                            .fraud-item[style*="green"] { background: #f0fdf4 !important; border-left-color: #22c55e !important; }
                            .fraud-item[style*="yellow"] { background: #fefce8 !important; border-left-color: #eab308 !important; }
                            .fraud-item[style*="red"] { background: #fef2f2 !important; border-left-color: #ef4444 !important; }

                            /* Risk chips */
                            .risk-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
                            .risk-chip { background: #f3f4f6; padding: 16px; border-radius: 8px; text-align: center; border: 2px solid #d1d5db; }
                            .risk-chip.good { background: #dcfce7 !important; border-color: #22c55e !important; }
                            .risk-chip.warn { background: #fef9c3 !important; border-color: #eab308 !important; }
                            .risk-chip.bad { background: #fee2e2 !important; border-color: #ef4444 !important; }
                            .risk-chip-value { font-size: 28px; font-weight: 700; color: #111827; }
                            .risk-chip.good .risk-chip-value { color: #166534 !important; }
                            .risk-chip.warn .risk-chip-value { color: #854d0e !important; }
                            .risk-chip.bad .risk-chip-value { color: #991b1b !important; }
                            .risk-chip-label { font-size: 11px; color: #6b7280; text-transform: uppercase; margin-top: 4px; }

                            /* Debt stats */
                            .debt-summary, .research-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
                            .debt-stat, .research-stat { background: #f3f4f6; padding: 16px; border-radius: 8px; text-align: center; border: 1px solid #e5e7eb; }
                            .debt-stat-value, .research-stat-value { font-size: 24px; font-weight: 700; color: #111827; }
                            .debt-stat-label, .research-stat-label { font-size: 12px; color: #6b7280; margin-top: 4px; }

                            /* MCA alert sections */
                            .mca-section, .mca-alert { background: #fee2e2 !important; border: 2px solid #ef4444 !important; border-radius: 8px; padding: 16px; margin: 16px 0; color: #991b1b !important; }

                            /* Charts */
                            .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
                            .chart-container { background: #ffffff; border-radius: 8px; padding: 16px; border: 1px solid #e5e7eb; }

                            /* Misc */
                            .hidden { display: block !important; }
                            button, .card-export-btn, .expand-toggle { display: none !important; }
                            .lender-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
                            .lender-card { background: #f3f4f6; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; }
                            .research-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
                            .research-module { background: #f3f4f6; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
                            .research-module-header { padding: 12px 16px; background: #e5e7eb; font-weight: 600; color: #111827; }
                            .research-module-body { padding: 16px; background: #ffffff; }
                        </style>
                    </head>
                    <body>${resultsArea.innerHTML}</body>
                    </html>
                `);
                iframeDoc.close();

                // Wait for fonts and content to load
                await new Promise(r => setTimeout(r, 500));

                const canvas = await html2canvas(iframeDoc.body, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                document.body.removeChild(iframe);

                downloadCanvas(canvas, 'png');
                showStatus('PNG exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 3: PNG Native - Export current theme as-is
        async function exportPngNative() {
            showStatus('Generating PNG (Native)...', 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Hide buttons
                const buttons = resultsArea.querySelectorAll('button, .card-export-btn');
                buttons.forEach(b => b.style.display = 'none');

                // Expand hidden sections
                const hiddenEls = resultsArea.querySelectorAll('.hidden');
                hiddenEls.forEach(el => el.classList.remove('hidden'));

                const canvas = await html2canvas(resultsArea, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });

                // Restore
                buttons.forEach(b => b.style.display = '');
                hiddenEls.forEach(el => el.classList.add('hidden'));

                downloadCanvas(canvas, 'png');
                showStatus('PNG exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 4: PDF Export
        async function exportPdf() {
            showStatus('Generating PDF...', 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Use the clean method for capturing
                const wrapper = document.createElement('div');
                wrapper.style.cssText = `position: absolute; left: -9999px; top: 0; background: #ffffff; padding: 24px; width: ${resultsArea.offsetWidth}px;`;

                const clone = resultsArea.cloneNode(true);
                clone.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));
                clone.querySelectorAll('button, .card-export-btn').forEach(el => el.remove());

                // Apply light styles (same as exportPngClean)
                clone.querySelectorAll('.section-card').forEach(card => {
                    card.style.cssText = 'background: #ffffff !important; border: 1px solid #e2e8f0 !important; border-radius: 12px; margin-bottom: 20px; overflow: hidden;';
                });
                clone.querySelectorAll('.section-header').forEach(h => {
                    h.style.cssText = 'background: #f8fafc !important; color: #1e293b !important; padding: 16px 20px; border-bottom: 1px solid #e2e8f0 !important;';
                });
                clone.querySelectorAll('.section-body').forEach(b => {
                    b.style.cssText = 'background: #ffffff !important; padding: 20px; color: #1e293b !important;';
                });
                clone.querySelectorAll('th').forEach(th => {
                    th.style.cssText = 'background: #f8fafc !important; color: #1e293b !important; padding: 12px;';
                });
                clone.querySelectorAll('td').forEach(td => {
                    td.style.cssText = 'background: #ffffff !important; color: #1e293b !important; padding: 12px;';
                });

                wrapper.appendChild(clone);
                document.body.appendChild(wrapper);
                await new Promise(r => setTimeout(r, 100));

                const canvas = await html2canvas(wrapper, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                document.body.removeChild(wrapper);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const pdfWidth = 612;
                const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
                const maxPageHeight = 792;

                if (pdfHeight <= maxPageHeight) {
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] });
                    pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(getFilename('pdf'));
                } else {
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                    const pageHeightInCanvasPixels = (maxPageHeight * imgWidth) / pdfWidth;
                    let position = 0;
                    let pageNum = 0;

                    while (position < imgHeight) {
                        if (pageNum > 0) pdf.addPage();

                        const pageCanvas = document.createElement('canvas');
                        pageCanvas.width = imgWidth;
                        pageCanvas.height = Math.min(pageHeightInCanvasPixels, imgHeight - position);
                        const ctx = pageCanvas.getContext('2d');
                        ctx.drawImage(canvas, 0, position, imgWidth, pageCanvas.height, 0, 0, imgWidth, pageCanvas.height);

                        const scaledHeight = (pageCanvas.height * pdfWidth) / imgWidth;
                        pdf.addImage(pageCanvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, scaledHeight);

                        position += pageHeightInCanvasPixels;
                        pageNum++;
                    }

                    pdf.save(getFilename('pdf'));
                }

                showStatus('PDF exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 5: Print - Use browser print
        function exportPrint() {
            window.print();
        }

        // Method 6: JSON Export
        function exportJson() {
            const data = {
                business: extractedBusinessInfo,
                analysis: extractedData.full_analysis,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = getFilename('json');
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);

            showStatus('JSON exported!', 'success');
        }

        // Method 7: CSV Export
        function exportCsv() {
            const analysis = extractedData.full_analysis;
            if (!analysis || !analysis.monthly_data) {
                showStatus('No monthly data to export', 'error');
                return;
            }

            const rows = [
                ['Month', 'Total Deposits', 'True Revenue', 'Deposit Count', 'Total Withdrawals', 'Avg Balance', 'Low Balance', 'NSF Items', 'Negative Days']
            ];

            analysis.monthly_data.forEach(month => {
                rows.push([
                    month.month || '',
                    month.total_deposits || 0,
                    month.true_revenue || month.total_deposits || 0,
                    month.deposit_count || 0,
                    month.total_withdrawals || 0,
                    month.average_balance || 0,
                    month.low_balance || 0,
                    month.nsf_items || 0,
                    month.negative_days || 0
                ]);
            });

            // Add summary row
            if (analysis.summary) {
                rows.push([]);
                rows.push(['Summary']);
                rows.push(['Average Monthly Deposits', analysis.summary.avg_monthly_deposits || 0]);
                rows.push(['Average True Revenue', analysis.summary.avg_true_revenue || analysis.summary.avg_monthly_deposits || 0]);
                rows.push(['Total NSF Items', analysis.summary.total_nsf || 0]);
                rows.push(['Total Negative Days', analysis.summary.total_negative_days || 0]);
            }

            const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = getFilename('csv');
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);

            showStatus('CSV exported!', 'success');
        }

        // Method 8: Clipboard - Copy summary text
        async function exportClipboard() {
            const analysis = extractedData.full_analysis;
            const business = extractedBusinessInfo;

            let text = `VISION Analysis Report\n`;
            text += `========================\n\n`;
            text += `Business: ${business.name || 'Unknown'}\n`;
            text += `Export Date: ${new Date().toLocaleDateString()}\n\n`;

            if (analysis.summary) {
                text += `SUMMARY\n`;
                text += `-------\n`;
                text += `Avg Monthly Deposits: $${(analysis.summary.avg_monthly_deposits || 0).toLocaleString()}\n`;
                text += `Avg True Revenue: $${(analysis.summary.avg_true_revenue || analysis.summary.avg_monthly_deposits || 0).toLocaleString()}\n`;
                text += `Total NSF Items: ${analysis.summary.total_nsf || 0}\n`;
                text += `Total Negative Days: ${analysis.summary.total_negative_days || 0}\n`;
                text += `MCA Positions Found: ${analysis.summary.mca_lenders_found || 0}\n\n`;
            }

            if (analysis.monthly_data && analysis.monthly_data.length > 0) {
                text += `MONTHLY DATA\n`;
                text += `------------\n`;
                analysis.monthly_data.forEach(m => {
                    text += `${m.month}: Deposits $${(m.total_deposits || 0).toLocaleString()}, True Rev $${(m.true_revenue || m.total_deposits || 0).toLocaleString()}, NSF ${m.nsf_items || 0}, Neg Days ${m.negative_days || 0}\n`;
                });
                text += `\n`;
            }

            if (analysis.red_flags && analysis.red_flags.length > 0) {
                text += `RED FLAGS\n`;
                text += `---------\n`;
                analysis.red_flags.forEach(flag => {
                    text += ` ${flag}\n`;
                });
            }

            try {
                await navigator.clipboard.writeText(text);
                showStatus('Copied to clipboard!', 'success');
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showStatus('Copied to clipboard!', 'success');
            }
        }

        // Helper: Download canvas as file
        function downloadCanvas(canvas, format) {
            const link = document.createElement('a');
            link.download = getFilename(format);
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        // Helper: Generate filename
        function getFilename(extension) {
            const businessName = extractedBusinessInfo.name || 'Report';
            const safeName = businessName.replace(/[^a-z0-9]/gi, '_');
            const date = new Date().toISOString().split('T')[0];
            return `${safeName}_Analysis_${date}.${extension}`;
        }

        async function exportReport() {
            await exportPdf();
        }

        async function exportReportAsPng() {
            await exportPngClean();
        }

        async function exportCardAsPng(cardId, cardName) {
            const card = document.getElementById(cardId);
            if (!card) {
                showStatus('Card not found', 'error');
                return;
            }

            showStatus('Generating PNG...', 'info');

            try {
                // Hide the export button during capture
                const exportBtn = card.querySelector('.card-export-btn');
                if (exportBtn) exportBtn.style.display = 'none';

                // Expand any hidden content within the card
                const hiddenEls = card.querySelectorAll('.hidden');
                hiddenEls.forEach(el => el.classList.remove('hidden'));

                const canvas = await html2canvas(card, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    onclone: (clonedDoc) => {
                        const clonedCard = clonedDoc.getElementById(cardId);
                        if (!clonedCard) return;

                        // Hide export button in clone
                        const clonedBtn = clonedCard.querySelector('.card-export-btn');
                        if (clonedBtn) clonedBtn.style.display = 'none';

                        // Inject SOLID COLOR light theme CSS
                        const style = clonedDoc.createElement('style');
                        style.textContent = `
                            :root, html, body, * {
                                --bg: #f3f4f6 !important;
                                --bg-secondary: #ffffff !important;
                                --bg-tertiary: #f3f4f6 !important;
                                --text: #111827 !important;
                                --text-secondary: #374151 !important;
                                --text-muted: #6b7280 !important;
                                --border: #d1d5db !important;
                                --green: #22c55e !important;
                                --red: #ef4444 !important;
                                --yellow: #eab308 !important;
                                --gold: #ca8a04 !important;
                            }
                            .section-card {
                                background: #ffffff !important;
                                border: 1px solid #d1d5db !important;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
                            }
                            .section-header {
                                background: #f3f4f6 !important;
                                color: #111827 !important;
                                border-bottom: 1px solid #d1d5db !important;
                            }
                            .section-body {
                                background: #ffffff !important;
                                color: #111827 !important;
                            }
                            /* Data cards with SOLID backgrounds */
                            .data-card {
                                background: #f9fafb !important;
                                border: 2px solid #d1d5db !important;
                            }
                            .data-card[style*="green"] { background: #dcfce7 !important; border-color: #22c55e !important; }
                            .data-card[style*="yellow"] { background: #fef9c3 !important; border-color: #eab308 !important; }
                            .data-card[style*="red"] { background: #fee2e2 !important; border-color: #ef4444 !important; }
                            .data-label { color: #6b7280 !important; }
                            .data-value { color: #111827 !important; }
                            .data-value.green { color: #16a34a !important; }
                            .data-value.red { color: #dc2626 !important; }
                            .data-value.gold { color: #ca8a04 !important; }
                            /* Fraud items with SOLID left borders */
                            .fraud-item { background: #f9fafb !important; border-left: 4px solid #d1d5db !important; }
                            .fraud-item[style*="green"] { background: #f0fdf4 !important; border-left-color: #22c55e !important; }
                            .fraud-item[style*="yellow"] { background: #fefce8 !important; border-left-color: #eab308 !important; }
                            .fraud-item[style*="red"] { background: #fef2f2 !important; border-left-color: #ef4444 !important; }
                            /* Risk chips with SOLID colors */
                            .risk-chip { background: #f3f4f6 !important; border: 2px solid #d1d5db !important; }
                            .risk-chip.good { background: #dcfce7 !important; border-color: #22c55e !important; }
                            .risk-chip.warn { background: #fef9c3 !important; border-color: #eab308 !important; }
                            .risk-chip.bad { background: #fee2e2 !important; border-color: #ef4444 !important; }
                            .risk-chip-value { color: #111827 !important; }
                            .risk-chip.good .risk-chip-value { color: #166534 !important; }
                            .risk-chip.warn .risk-chip-value { color: #854d0e !important; }
                            .risk-chip.bad .risk-chip-value { color: #991b1b !important; }
                            .risk-chip-label { color: #6b7280 !important; }
                            /* Tables */
                            table { background: #ffffff !important; border: 1px solid #e5e7eb !important; }
                            th { background: #f3f4f6 !important; color: #111827 !important; border: 1px solid #e5e7eb !important; }
                            td { color: #111827 !important; border: 1px solid #e5e7eb !important; background: #ffffff !important; }
                            /* MCA sections */
                            .mca-section, .mca-alert { background: #fee2e2 !important; border: 2px solid #ef4444 !important; color: #991b1b !important; }
                            /* Stats */
                            .debt-stat, .research-stat { background: #f3f4f6 !important; border: 1px solid #e5e7eb !important; }
                            .debt-stat-value, .research-stat-value { color: #111827 !important; }
                            .debt-stat-label, .research-stat-label { color: #6b7280 !important; }
                            .chart-container { background: #ffffff !important; border: 1px solid #e5e7eb !important; }
                        `;
                        clonedDoc.head.appendChild(style);
                        clonedDoc.documentElement.setAttribute('data-theme', 'light');
                    }
                });

                // Restore button visibility
                if (exportBtn) exportBtn.style.display = '';

                // Restore hidden elements
                hiddenEls.forEach(el => el.classList.add('hidden'));

                const businessName = extractedBusinessInfo.name || 'Report';
                const filename = `${businessName.replace(/[^a-z0-9]/gi, '_')}_${cardName}_${new Date().toISOString().split('T')[0]}.png`;

                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();

                showStatus(`${cardName.replace(/_/g, ' ')} exported!`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error exporting PNG: ' + error.message, 'error');
            }
        }

        async function exportReportAs(format = 'png') {
            if (!extractedData.full_analysis) {
                showStatus('No analysis data to export', 'error');
                return;
            }

            showStatus(`Generating ${format.toUpperCase()}...`, 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');
                if (!resultsArea) {
                    showStatus('Results area not found', 'error');
                    return;
                }

                // Hide buttons before capture
                const buttons = resultsArea.querySelectorAll('button, .expand-toggle');
                buttons.forEach(b => b.style.display = 'none');

                // Expand hidden sections
                const hiddenEls = resultsArea.querySelectorAll('.hidden');
                hiddenEls.forEach(el => el.classList.remove('hidden'));

                // Use html2canvas onclone callback - this modifies the INTERNAL clone
                // that html2canvas creates, which is what actually gets rendered
                const canvas = await html2canvas(resultsArea, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    onclone: (clonedDoc) => {
                        // This runs on html2canvas's internal clone BEFORE rendering
                        const clonedResults = clonedDoc.getElementById('resultsArea');
                        if (!clonedResults) return;

                        // Inject light theme CSS variables into the cloned document
                        const style = clonedDoc.createElement('style');
                        style.textContent = `
                            :root, html, body, * {
                                --bg: #f8fafc !important;
                                --bg-secondary: #ffffff !important;
                                --bg-tertiary: #f1f5f9 !important;
                                --bg-hover: #e2e8f0 !important;
                                --text: #0f172a !important;
                                --text-secondary: #475569 !important;
                                --text-tertiary: #64748b !important;
                                --border: #e2e8f0 !important;
                                --border-secondary: #cbd5e1 !important;
                            }
                        `;
                        clonedDoc.head.appendChild(style);

                        // Set data-theme on cloned document
                        clonedDoc.documentElement.setAttribute('data-theme', 'light');

                        // Force white background on body
                        clonedDoc.body.style.backgroundColor = '#ffffff';

                        // Walk ALL elements and force light styles via inline CSS
                        const allElements = clonedResults.querySelectorAll('*');
                        allElements.forEach(el => {
                            // Clear ANY background (including gradients, images)
                            el.style.setProperty('background', '#ffffff', 'important');
                            el.style.setProperty('background-color', '#ffffff', 'important');
                            el.style.setProperty('background-image', 'none', 'important');
                            // Force dark text
                            el.style.setProperty('color', '#0f172a', 'important');
                        });

                        // Force white on body, html, and all parent containers
                        clonedDoc.body.style.setProperty('background', '#ffffff', 'important');
                        clonedDoc.body.style.setProperty('background-color', '#ffffff', 'important');
                        clonedDoc.documentElement.style.setProperty('background', '#ffffff', 'important');

                        const content = clonedDoc.querySelector('.content');
                        if (content) {
                            content.style.setProperty('background', '#ffffff', 'important');
                        }

                        // Set explicit background on the results container
                        clonedResults.style.setProperty('background', '#ffffff', 'important');
                        clonedResults.style.setProperty('background-color', '#ffffff', 'important');
                        clonedResults.style.setProperty('background-image', 'none', 'important');
                    }
                });

                // Restore buttons
                buttons.forEach(b => b.style.display = '');

                // Restore hidden elements
                hiddenEls.forEach(el => el.classList.add('hidden'));

                const businessName = extractedBusinessInfo.name || 'Report';
                const filename = `${businessName.replace(/[^a-z0-9]/gi, '_')}_Analysis_${new Date().toISOString().split('T')[0]}`;

                if (format === 'png') {
                    // Direct PNG download
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    showStatus('PNG exported!', 'success');
                } else {
                    // Convert to PDF with proper page sizing
                    const { jsPDF } = window.jspdf;

                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;

                    // Use the image dimensions to set PDF size, scaled to letter width
                    const pdfWidth = 612; // Letter width in points
                    const pdfHeight = (imgHeight * pdfWidth) / imgWidth;

                    // If content is too tall for one page, create multi-page PDF
                    const maxPageHeight = 792; // Letter height in points

                    if (pdfHeight <= maxPageHeight) {
                        // Single page
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] });
                        pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(filename + '.pdf');
                    } else {
                        // Multi-page - split the canvas
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                        const pageHeightInCanvasPixels = (maxPageHeight * imgWidth) / pdfWidth;
                        let position = 0;
                        let pageNum = 0;

                        while (position < imgHeight) {
                            if (pageNum > 0) pdf.addPage();

                            // Create a temporary canvas for this page slice
                            const pageCanvas = document.createElement('canvas');
                            pageCanvas.width = imgWidth;
                            pageCanvas.height = Math.min(pageHeightInCanvasPixels, imgHeight - position);
                            const ctx = pageCanvas.getContext('2d');

                            ctx.drawImage(canvas, 0, position, imgWidth, pageCanvas.height, 0, 0, imgWidth, pageCanvas.height);

                            const scaledHeight = (pageCanvas.height * pdfWidth) / imgWidth;
                            pdf.addImage(pageCanvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, scaledHeight);

                            position += pageHeightInCanvasPixels;
                            pageNum++;
                        }

                        pdf.save(filename + '.pdf');
                    }
                    showStatus('PDF exported!', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showStatus(`Error exporting ${format.toUpperCase()}: ` + error.message, 'error');
            }
        }

        function getSelectedModel() {
            return localStorage.getItem('gemini_model') || 'gemini-3-flash-preview';
        }

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message show ${type}`;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function showLoading(show, text = 'Processing...', options = {}) {
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.toggle('show', show);
            document.getElementById('loadingText').textContent = text;
            document.getElementById('emptyState').classList.toggle('hidden', show || files.length > 0);

            // Handle subtext
            const subtextEl = document.getElementById('loadingSubtext');
            subtextEl.textContent = options.subtext || 'This may take a moment';

            // Handle progress bar
            const progressBar = document.getElementById('loadingProgressBar');
            if (options.progress !== undefined) {
                progressBar.style.width = options.progress + '%';
            } else if (show) {
                progressBar.style.width = '0%';
            }

            // Handle step indicators
            const steps = document.querySelectorAll('.loading-step');
            steps.forEach(step => {
                step.classList.remove('active', 'done');
            });

            if (options.step) {
                const stepOrder = ['scan', 'extract', 'analyze', 'match'];
                const currentIdx = stepOrder.indexOf(options.step);
                steps.forEach((step, idx) => {
                    const stepName = step.dataset.step;
                    const stepIdx = stepOrder.indexOf(stepName);
                    if (stepIdx < currentIdx) {
                        step.classList.add('done');
                    } else if (stepIdx === currentIdx) {
                        step.classList.add('active');
                    }
                });
            }

            // Reset if hiding
            if (!show) {
                progressBar.style.width = '0%';
            }
        }

        // File Handling
        async function handleFiles(fileList) {
            for (const file of fileList) {
                if (file.type === 'application/pdf') {
                    await loadPDF(file);
                } else if (file.type.startsWith('image/')) {
                    await loadImage(file);
                }
            }
            updateFileList();
            document.getElementById('processBtn').disabled = files.length === 0;
            document.getElementById('downloadAllBtn').style.display = files.length > 0 ? 'block' : 'none';
            document.getElementById('emptyState').classList.toggle('hidden', files.length > 0);

            // Auto-select first file for preview
            if (files.length > 0 && activeFileIndex === -1) {
                selectFile(0);
            }
        }

        async function loadPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                // Make two separate copies - one for pdf.js, one to store for pdf-lib later
                const bytesForPdfJs = new Uint8Array(arrayBuffer.slice(0));
                const bytesForStorage = new Uint8Array(arrayBuffer.slice(0));

                const pdf = await pdfjsLib.getDocument({ data: bytesForPdfJs }).promise;
                const pages = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const pdfCanvas = document.createElement('canvas');
                    pdfCanvas.width = viewport.width;
                    pdfCanvas.height = viewport.height;
                    await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;
                    const img = new Image();
                    img.src = pdfCanvas.toDataURL();
                    await new Promise(r => img.onload = r);
                    pages.push(img);
                }

                files.push({
                    name: file.name,
                    pages,
                    thumb: pages[0].src,
                    status: null,
                    fraudAnalysis: null,
                    originalPdfBytes: bytesForStorage,
                    isPdf: true
                });
            } catch (err) {
                console.error('Error loading PDF:', err);
                showStatus('Error loading PDF: ' + err.message, 'error');
            }
        }

        async function loadImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        files.push({
                            name: file.name,
                            pages: [img],
                            thumb: img.src,
                            status: null,
                            fraudAnalysis: null,
                            isPdf: false
                        });
                        resolve();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = files.map((f, i) => `
                <div class="file-item ${f.status || ''} ${i === activeFileIndex ? 'selected' : ''}" onclick="selectFile(${i})">
                    <img class="file-thumb" src="${f.thumb}">
                    <div class="file-info">
                        <input type="text" class="file-name-input" value="${f.outputName || f.name.replace(/\.[^.]+$/, '')}"
                            onclick="event.stopPropagation()"
                            onchange="updateFileName(${i}, this.value)"
                            onkeydown="if(event.key==='Enter')this.blur()">
                        <div class="file-meta">${f.pages.length} page(s)</div>
                    </div>
                    ${f.status ? `<span class="file-status ${f.status}" onclick="event.stopPropagation();showFraudDetails(${i})">${f.status === 'clean' ? 'Clean' : f.status === 'warning' ? 'Review' : 'Risk'}</span>` : ''}
                    <button class="file-remove" onclick="event.stopPropagation();removeFile(${i})"></button>
                </div>
            `).join('');
            document.getElementById('fileCount').textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
            document.getElementById('downloadAllBtn').style.display = files.length > 0 ? 'block' : 'none';
        }

        function updateFileName(idx, newName) {
            if (files[idx]) {
                files[idx].outputName = newName.replace(/[^a-z0-9_\-\s]/gi, '_');
            }
        }

        function removeFile(idx) {
            files.splice(idx, 1);
            if (activeFileIndex >= files.length) activeFileIndex = files.length - 1;
            updateFileList();
            document.getElementById('processBtn').disabled = files.length === 0;
            document.getElementById('downloadAllBtn').style.display = files.length > 0 ? 'block' : 'none';
            document.getElementById('emptyState').classList.toggle('hidden', files.length > 0);
            if (files.length === 0) {
                document.getElementById('watermarkPlaceholder').style.display = 'block';
                canvas.style.display = 'none';
            } else if (activeFileIndex >= 0) {
                selectFile(activeFileIndex);
            }
        }

        function showFraudDetails(idx) {
            const file = files[idx];
            if (!file || !file.fraudAnalysis) return;

            const statusLabel = file.status === 'clean' ? 'CLEAN' : file.status === 'warning' ? 'REVIEW NEEDED' : 'HIGH RISK';
            const statusClass = file.status === 'clean' ? 'green' : file.status === 'warning' ? 'gold' : 'red';

            document.getElementById('fraudDetailContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div class="data-label">Document</div>
                    <div style="font-weight: 600;">${file.name}</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div class="data-label">Risk Assessment</div>
                    <span class="file-status ${file.status}" style="font-size: 12px;">${statusLabel}</span>
                </div>
                <div>
                    <div class="data-label">Analysis</div>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-sm); font-size: 13px; line-height: 1.6;">
                        ${file.fraudAnalysis}
                    </div>
                </div>
            `;
            openModal('fraudDetailModal');
        }

        // Processing
        function setStep(num) {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (!step) continue;
                step.classList.remove('active', 'completed');
                if (i < num) step.classList.add('completed');
                if (i === num) step.classList.add('active');
            }
        }

        // Business info extracted from bank statements
        let extractedBusinessInfo = { name: '', owner: '', address: '' };

        async function processDocuments() {
            const apiKey = localStorage.getItem('gemini_key');
            if (!apiKey) {
                showStatus('Please set your Gemini API key in Settings', 'error');
                openModal('settingsModal');
                return;
            }

            try {
                // Step 2: Fraud Scan
                setStep(2);
                showLoading(true, 'Scanning for fraud indicators...', {
                    step: 'scan',
                    progress: 5,
                    subtext: `Analyzing ${files.length} document${files.length > 1 ? 's' : ''} for manipulation`
                });
                document.getElementById('fraudSection').classList.remove('hidden');

                for (let i = 0; i < files.length; i++) {
                    const scanProgress = 5 + Math.round((i / files.length) * 20);
                    showLoading(true, `Scanning document ${i + 1} of ${files.length}...`, {
                        step: 'scan',
                        progress: scanProgress,
                        subtext: `Checking for digital alterations and inconsistencies`
                    });
                    files[i].status = await scanForFraud(files[i], apiKey);
                }
                updateFileList();
                renderFraudResults();

                // Step 3: Extract Data
                setStep(3);
                showLoading(true, 'Extracting bank data...', {
                    step: 'extract',
                    progress: 30,
                    subtext: 'Reading transaction data and account details'
                });
                document.getElementById('dataSection').classList.remove('hidden');

                extractedData = await extractBankData(apiKey);
                renderExtractedData();
                renderCharts();

                // Display extracted business info
                if (extractedBusinessInfo.name) {
                    document.getElementById('businessInfoSection').style.display = 'block';
                    document.getElementById('displayBusinessName').textContent = extractedBusinessInfo.name;
                    document.getElementById('displayOwnerName').textContent = extractedBusinessInfo.owner ? `Owner: ${extractedBusinessInfo.owner}` : '';
                    document.getElementById('displayBusinessAddress').textContent = extractedBusinessInfo.address || '';
                }

                // Step 4: Background Research
                setStep(4);
                if (extractedBusinessInfo.name) {
                    showLoading(true, `Researching ${extractedBusinessInfo.name}...`, {
                        step: 'analyze',
                        progress: 55,
                        subtext: 'Running comprehensive background checks'
                    });
                    document.getElementById('researchSection').classList.remove('hidden');
                    document.getElementById('researchBusinessName').textContent = extractedBusinessInfo.name;
                    await runBackgroundResearch(apiKey);
                }

                // Step 5: Match Lenders
                setStep(5);
                showLoading(true, 'Finding best lender matches...', {
                    step: 'match',
                    progress: 90,
                    subtext: 'Comparing against lender criteria'
                });
                document.getElementById('lenderSection').classList.remove('hidden');
                document.getElementById('submitSection').classList.remove('hidden');

                matchedLenders = matchLenders(extractedData);
                renderLenderResults();
                renderSubmitInstructions();

                showLoading(false);
                showStatus('Analysis complete!', 'success');
                document.getElementById('exportMenuBtn').disabled = false;

            } catch (error) {
                console.error(error);
                showLoading(false);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function scanForFraud(file, apiKey) {
            try {
                const canvas = document.createElement('canvas');
                const img = file.pages[0];
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                const model = getSelectedModel();
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: `Analyze this bank statement image for signs of ALTERATION or TAMPERING only.

ONLY flag as DANGER or WARNING if you see clear evidence of:
1. DIGITAL EDITING - visible editing artifacts, cut/paste lines, mismatched pixels, blur around numbers
2. FONT TAMPERING - numbers or text with different fonts/sizes than surrounding content
3. WHITEOUT/CORRECTION - visible white boxes or correction tape marks covering original text
4. MATHEMATICAL ERRORS - running balance doesn't add up correctly with transactions shown

DO NOT flag documents for:
- Future dates (these are fine)
- Low resolution or poor scan quality
- Normal banking format variations
- Standard PDF rendering artifacts

Only flag DANGER if there is CLEAR visual evidence of alteration.
Only flag WARNING if there are suspicious but uncertain indicators.
Flag CLEAN if the document appears unaltered and authentic.

Provide a brief 1-2 sentence explanation of what you found (or that no alterations were detected).
End with exactly one: RISK_LEVEL:CLEAN or RISK_LEVEL:WARNING or RISK_LEVEL:DANGER` },
                                { inlineData: { mimeType: 'image/jpeg', data: base64 } }
                            ]
                        }]
                    })
                });

                const data = await resp.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                file.fraudAnalysis = text.replace(/RISK_LEVEL:(CLEAN|WARNING|DANGER)/g, '').trim();

                if (text.includes('RISK_LEVEL:DANGER')) return 'danger';
                if (text.includes('RISK_LEVEL:WARNING')) return 'warning';
                return 'clean';
            } catch (e) {
                file.fraudAnalysis = 'Analysis failed - API error';
                return 'warning';
            }
        }

        function renderFraudResults() {
            const clean = files.filter(f => f.status === 'clean').length;
            const warning = files.filter(f => f.status === 'warning').length;
            const danger = files.filter(f => f.status === 'danger').length;

            // Build expandable document modules (like research modules)
            const documentModules = files.map((f, i) => {
                const statusText = f.status === 'danger' ? 'HIGH RISK' : f.status === 'warning' ? 'REVIEW' : 'CLEAN';
                const riskClass = f.status === 'danger' ? 'risk-high' : f.status === 'warning' ? 'risk-medium' : 'risk-low';
                const statusIcon = f.status === 'danger'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                    : f.status === 'warning'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';

                const shortName = f.name.length > 35 ? f.name.substring(0, 32) + '...' : f.name;
                const analysis = f.fraudAnalysis || 'No analysis details available.';

                return `
                    <div class="fraud-module ${riskClass}" id="fraud-module-${i}">
                        <div class="fraud-module-header" onclick="toggleFraudModule(${i})">
                            <div class="fraud-module-icon">${statusIcon}</div>
                            <div class="fraud-module-info">
                                <div class="fraud-module-name">${shortName}</div>
                                <div class="fraud-module-summary">${f.pages?.length || 0} page(s) analyzed</div>
                            </div>
                            <div class="fraud-module-status">${statusText}</div>
                            <div class="expand-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="fraud-module-content" id="fraud-content-${i}">
                            <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.6; margin: 0;">${analysis}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Overall status - minimal badge
            const overallColor = danger > 0 ? 'var(--red)' : warning > 0 ? 'var(--yellow)' : 'var(--green)';
            const overallText = danger > 0 ? 'Issues Detected' : warning > 0 ? 'Review Required' : 'All Clear';

            document.getElementById('fraudResults').innerHTML = `
                <!-- Summary Stats Row -->
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--green);">${clean}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Clean</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--yellow);">${warning}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Review</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--red);">${danger}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Risk</span>
                    </div>
                    <div style="flex: 1;"></div>
                    <div style="padding: 6px 12px; background: ${overallColor}15; border-radius: 20px; font-size: 12px; font-weight: 600; color: ${overallColor};">${overallText}</div>
                </div>

                <!-- Document Modules Grid -->
                <div class="fraud-modules-grid">
                    ${documentModules}
                </div>
            `;
        }

        function toggleFraudModule(index) {
            const module = document.getElementById('fraud-module-' + index);
            module.classList.toggle('expanded');
        }

        // Extract data from a single bank statement file
        async function extractSingleStatement(file, apiKey, fileIndex) {
            const images = [];
            for (const page of file.pages) {
                const canvas = document.createElement('canvas');
                canvas.width = page.width;
                canvas.height = page.height;
                canvas.getContext('2d').drawImage(page, 0, 0);
                images.push(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
            }

            const parts = [
                { text: `You are analyzing a SINGLE bank statement for MCA underwriting. This is statement ${fileIndex + 1}.

Extract the data for THIS ONE MONTH only:
- month: Month name and year (e.g., "January 2024")
- total_deposits: Sum of all credits/deposits
- true_revenue: Deposits minus internal transfers, loans, owner deposits
- total_withdrawals: Sum of all debits/withdrawals
- average_daily_balance: Average daily balance
- opening_balance: Balance at the start of the month (first day's beginning balance)
- ending_balance: Balance at the end of the month (last day's ending balance)
- lowest_daily_balance: Minimum/lowest balance during the month
- num_deposits: Count of deposit transactions
- nsf_count: Number of NSF/overdraft fees
- days_negative: Days with negative balance

Also extract:
- business_name: Business name on the account
- owner_name: Owner/account holder name
- bank_name: Name of the bank
- account_number_last4: Last 4 digits of account

Detect any MCA/debt payments - look for recurring debits to: LIBERTAS, YELLOWSTONE, CREDIBLY, ONDECK, KAPITUS, FUNDFI, BITTY, CLEARFUND, etc.

Return ONLY valid JSON:
{
  "month": "Month Year",
  "total_deposits": 0,
  "true_revenue": 0,
  "total_withdrawals": 0,
  "average_daily_balance": 0,
  "opening_balance": 0,
  "ending_balance": 0,
  "lowest_daily_balance": 0,
  "num_deposits": 0,
  "nsf_count": 0,
  "days_negative": 0,
  "business_name": "",
  "owner_name": "",
  "bank_name": "",
  "account_number_last4": "",
  "detected_mca_payments": [],
  "existing_debt": [],
  "red_flags": []
}` },
                ...images.map(d => ({ inlineData: { mimeType: 'image/jpeg', data: d } }))
            ];

            try {
                const model = getSelectedModel();
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: { temperature: 0.1, maxOutputTokens: 8192 }
                    })
                });

                const data = await resp.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                return JSON.parse(text);
            } catch (e) {
                console.error(`Extract error for file ${fileIndex}:`, e);
                return null;
            }
        }

        async function extractBankData(apiKey) {
            // Process all statements in PARALLEL
            showLoading(true, `Extracting data from ${files.length} statements...`, {
                step: 'extract',
                progress: 35,
                subtext: `Processing ${files.length} document${files.length > 1 ? 's' : ''} simultaneously`
            });

            // Extract each statement with retry logic
            const extractWithRetry = async (file, index, maxRetries = 2) => {
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        const result = await extractSingleStatement(file, apiKey, index);
                        if (result && result.month) {
                            console.log(` Statement ${index + 1} extracted: ${result.month}`);
                            return result;
                        }
                        console.warn(`Statement ${index + 1} attempt ${attempt + 1}: Invalid response, retrying...`);
                    } catch (e) {
                        console.error(`Statement ${index + 1} attempt ${attempt + 1} failed:`, e);
                    }
                    if (attempt < maxRetries) {
                        await new Promise(r => setTimeout(r, 1000)); // Wait 1s before retry
                    }
                }
                console.error(` Statement ${index + 1} failed after ${maxRetries + 1} attempts`);
                return null;
            };

            const extractionPromises = files.map((file, index) =>
                extractWithRetry(file, index)
            );

            const results = await Promise.all(extractionPromises);

            // Log extraction summary
            const successCount = results.filter(r => r !== null).length;
            console.log(`Extraction complete: ${successCount}/${files.length} statements successful`);

            if (successCount < files.length) {
                showStatus(`Warning: Only ${successCount} of ${files.length} statements were extracted. Check console for details.`, 'info');
            }

            // Filter out failed extractions and build months array
            const months = results.filter(r => r !== null).map(r => ({
                month: r.month || 'Unknown',
                total_deposits: r.total_deposits || 0,
                true_revenue: r.true_revenue || 0,
                total_withdrawals: r.total_withdrawals || 0,
                average_daily_balance: r.average_daily_balance || 0,
                opening_balance: r.opening_balance || 0,
                ending_balance: r.ending_balance || 0,
                lowest_daily_balance: r.lowest_daily_balance || 0,
                num_deposits: r.num_deposits || 0,
                nsf_count: r.nsf_count || 0,
                days_negative: r.days_negative || 0
            }));

            // Sort months chronologically
            months.sort((a, b) => {
                const dateA = new Date(a.month);
                const dateB = new Date(b.month);
                return dateA - dateB;
            });

            // Collect all MCA lenders and debt from all statements
            const mcaLenderMap = new Map(); // Use Map to dedupe by lender name
            const allDebt = [];
            const allRedFlags = [];
            let businessInfo = { business_name: '', owner_name: '', business_address: '' };
            let accountInfo = { bank_name: '', account_holder: '', account_number_last4: '' };

            results.filter(r => r !== null).forEach(r => {
                if (r.detected_mca_payments) {
                    r.detected_mca_payments.forEach(m => {
                        // Extract lender name from various formats
                        let lenderName = '';
                        let amount = 0;
                        let date = '';

                        if (typeof m === 'string') {
                            lenderName = m;
                        } else if (typeof m === 'object') {
                            lenderName = m.name || m.lender || m.payee || '';
                            amount = m.amount || m.payment_amount || 0;
                            date = m.date || '';
                        }

                        // Skip if no valid lender name
                        if (!lenderName || lenderName === 'Unknown') return;

                        // Clean lender name - remove amounts, dates, and extra info
                        // Pattern: "Lender Name: $X,XXX.XX (MM/DD)" or "Lender Name - $X,XXX.XX"
                        let cleanName = lenderName
                            .replace(/:\s*\$[\d,]+\.?\d*\s*(\(\d{2}\/\d{2}\))?/gi, '') // Remove ": $X,XXX.XX (MM/DD)"
                            .replace(/-\s*\$[\d,]+\.?\d*/gi, '') // Remove "- $X,XXX.XX"
                            .replace(/\s*\(\d{2}\/\d{2}(\/\d{2,4})?\)/gi, '') // Remove standalone dates like (05/06)
                            .replace(/\s*\$[\d,]+\.?\d*/gi, '') // Remove any remaining dollar amounts
                            .replace(/\s+/g, ' ') // Normalize whitespace
                            .trim();

                        // If we stripped everything, use original
                        if (!cleanName) cleanName = lenderName.trim();

                        // Extract amount from name if not already set
                        if (!amount) {
                            const amountMatch = lenderName.match(/\$[\d,]+\.?\d*/);
                            if (amountMatch) {
                                amount = parseFloat(amountMatch[0].replace(/[$,]/g, '')) || 0;
                            }
                        }

                        // Normalize for deduplication - aggressive cleaning
                        const normalizedName = cleanName
                            .toUpperCase()
                            .replace(/[^A-Z0-9]/g, '') // Remove ALL non-alphanumeric chars (spaces, dashes, etc)
                            .trim();

                        // Add or update in map (keep highest amount, count occurrences)
                        if (!mcaLenderMap.has(normalizedName)) {
                            mcaLenderMap.set(normalizedName, { name: cleanName, amount, count: 1 });
                        } else {
                            const existing = mcaLenderMap.get(normalizedName);
                            existing.count = (existing.count || 1) + 1;
                            if (amount && amount > (existing.amount || 0)) {
                                existing.amount = amount;
                            }
                        }
                    });
                }
                if (r.existing_debt) {
                    allDebt.push(...r.existing_debt);
                }
                if (r.red_flags) {
                    allRedFlags.push(...r.red_flags);
                }
                if (r.business_name && !businessInfo.business_name) {
                    businessInfo.business_name = r.business_name;
                }
                if (r.owner_name && !businessInfo.owner_name) {
                    businessInfo.owner_name = r.owner_name;
                }
                if (r.bank_name && !accountInfo.bank_name) {
                    accountInfo.bank_name = r.bank_name;
                }
                if (r.account_number_last4 && !accountInfo.account_number_last4) {
                    accountInfo.account_number_last4 = r.account_number_last4;
                }
            });

            // Calculate our own aggregates from the extracted month data
            const numMonths = months.length || 1;
            const totals = months.reduce((acc, m) => ({
                deposits: acc.deposits + m.total_deposits,
                trueRevenue: acc.trueRevenue + m.true_revenue,
                withdrawals: acc.withdrawals + m.total_withdrawals,
                avgBal: acc.avgBal + m.average_daily_balance,
                numDeps: acc.numDeps + m.num_deposits,
                nsf: acc.nsf + m.nsf_count,
                negDays: acc.negDays + m.days_negative
            }), { deposits: 0, trueRevenue: 0, withdrawals: 0, avgBal: 0, numDeps: 0, nsf: 0, negDays: 0 });

            // Store extracted business info for research
            extractedBusinessInfo = {
                name: businessInfo.business_name || accountInfo.account_holder || '',
                owner: businessInfo.owner_name || '',
                address: businessInfo.business_address || ''
            };

            // Build the full analysis object with OUR calculated aggregates
            const parsed = {
                business_info: businessInfo,
                account_info: accountInfo,
                months: months,
                aggregated: {
                    avg_monthly_deposits: Math.round(totals.deposits / numMonths),
                    avg_monthly_true_revenue: Math.round(totals.trueRevenue / numMonths),
                    avg_monthly_balance: Math.round(totals.avgBal / numMonths),
                    total_nsf_fees: totals.nsf,
                    total_negative_days: totals.negDays,
                    avg_num_deposits: Math.round(totals.numDeps / numMonths),
                    months_analyzed: numMonths,
                    detected_mca_lenders: Array.from(mcaLenderMap.values())
                },
                existing_debt: allDebt,
                red_flags: [...new Set(allRedFlags)]
            };

            return {
                monthly_deposits: parsed.aggregated.avg_monthly_deposits,
                average_daily_balance: parsed.aggregated.avg_monthly_balance,
                nsf_negative_days: parsed.aggregated.total_negative_days,
                num_deposits_monthly: parsed.aggregated.avg_num_deposits,
                full_analysis: parsed
            };
        }

        function renderExtractedData() {
            if (!extractedData.full_analysis) {
                document.getElementById('extractedData').innerHTML = '<div class="placeholder">No data extracted</div>';
                return;
            }

            const analysis = extractedData.full_analysis;
            const agg = analysis.aggregated || {};
            const months = analysis.months || [];
            const mcaLenders = agg.detected_mca_lenders || [];
            const flags = analysis.red_flags || [];

            // Calculate totals
            const totals = months.reduce((acc, m) => ({
                deposits: acc.deposits + (m.total_deposits || 0),
                trueRevenue: acc.trueRevenue + (m.true_revenue || m.total_deposits * 0.92 || 0),
                withdrawals: acc.withdrawals + (m.total_withdrawals || 0),
                numDeps: acc.numDeps + (m.num_deposits || 0),
                nsf: acc.nsf + (m.nsf_count || 0),
                negDays: acc.negDays + (m.days_negative || 0),
                avgBalSum: acc.avgBalSum + (m.average_daily_balance || 0)
            }), { deposits: 0, trueRevenue: 0, withdrawals: 0, numDeps: 0, nsf: 0, negDays: 0, avgBalSum: 0 });

            const numMonths = months.length || 1;
            const avgBalance = Math.round(totals.avgBalSum / numMonths);

            document.getElementById('extractedData').innerHTML = `
                <!-- Risk Summary -->
                <div class="risk-summary">
                    <div class="risk-chip ${totals.nsf === 0 ? 'good' : totals.nsf <= 3 ? 'warn' : 'bad'}">
                        <div class="risk-chip-value">${totals.nsf}</div>
                        <div class="risk-chip-label">NSF Items</div>
                    </div>
                    <div class="risk-chip ${totals.negDays === 0 ? 'good' : totals.negDays <= 5 ? 'warn' : 'bad'}">
                        <div class="risk-chip-value">${totals.negDays}</div>
                        <div class="risk-chip-label">Neg Days</div>
                    </div>
                    <div class="risk-chip ${mcaLenders.length === 0 ? 'good' : mcaLenders.length <= 2 ? 'warn' : 'bad'}">
                        <div class="risk-chip-value">${mcaLenders.length}</div>
                        <div class="risk-chip-label">MCA Found</div>
                    </div>
                    <div class="risk-chip">
                        <div class="risk-chip-value">${Math.round(totals.numDeps / numMonths)}</div>
                        <div class="risk-chip-label">Deps/Month</div>
                    </div>
                </div>

                <!-- Monthly Table -->
                ${months.length > 0 ? `
                <div style="overflow-x: auto;"><table><thead><tr><th>Month</th><th>Deposits</th><th>True Rev</th><th>#</th><th>Withdrawals</th><th>Avg Bal</th><th>Open Bal</th><th>End Bal</th><th>NSF</th><th>Neg</th></tr></thead><tbody>${months.map(m => `<tr><td style="font-weight: 500;">${m.month || 'N/A'}</td><td class="text-green">$${(m.total_deposits || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td class="text-gold">$${(m.true_revenue || (m.total_deposits || 0) * 0.92).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>${m.num_deposits || 0}</td><td class="text-red">$${(m.total_withdrawals || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>$${(m.average_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td class="${(m.opening_balance || 0) < 0 ? 'text-red' : ''}">$${(m.opening_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td class="${(m.ending_balance || 0) < 0 ? 'text-red' : ''}">$${(m.ending_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td class="${(m.nsf_count || 0) > 0 ? 'text-red' : ''}">${m.nsf_count || 0}</td><td class="${(m.days_negative || 0) > 0 ? 'text-red' : ''}">${m.days_negative || 0}</td></tr>`).join('')}</tbody><tfoot><tr><td><strong>AVERAGE</strong></td><td>$${(totals.deposits / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>$${(totals.trueRevenue / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>${Math.round(totals.numDeps / numMonths)}</td><td>$${(totals.withdrawals / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>$${avgBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td><td>-</td><td>-</td><td>${(totals.nsf / numMonths).toFixed(2)}</td><td>${(totals.negDays / numMonths).toFixed(2)}</td></tr></tfoot></table></div>
                ` : '<p style="color: var(--text-muted); text-align: center;">No monthly data extracted</p>'}

                ${mcaLenders.length > 0 ? `
                <div class="mca-section">
                    <div class="mca-header">
                        <div class="mca-icon">!</div>
                        <div class="mca-title">
                            <h3>Existing MCA Positions Detected</h3>
                            <p>Active merchant cash advance obligations identified</p>
                        </div>
                        <div class="mca-count-badge">${mcaLenders.length} Lender${mcaLenders.length > 1 ? 's' : ''}</div>
                    </div>
                    <div class="mca-lender-list">
                        ${mcaLenders.map((l, idx) => {
                            const name = typeof l === 'object' ? (l.name || 'Unknown Lender') : l;
                            const amount = typeof l === 'object' && l.amount ? l.amount : 0;
                            const count = typeof l === 'object' && l.count ? l.count : 1;
                            return `
                            <div class="mca-lender-card">
                                <div class="mca-lender-icon">$</div>
                                <div>
                                    <div class="mca-lender-name">${name}</div>
                                    <div class="mca-lender-status">${count > 1 ? count + ' payments detected' : (amount ? '$' + amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '/week' : 'Active Position')}</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}

                ${flags.length > 0 ? `
                <div class="mca-alert" style="margin-top: 12px;">
                    <div class="mca-alert-title">Red Flags</div>
                    <ul style="margin: 8px 0 0 16px; font-size: 12px; color: var(--text-secondary);">
                        ${flags.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${analysis.underwriting_notes ? `
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                    <div class="data-label">Underwriting Notes</div>
                    <p style="font-size: 13px; line-height: 1.6;">${analysis.underwriting_notes}</p>
                </div>
                ` : ''}
            `;
        }

        function renderCharts() {
            if (!extractedData.full_analysis) return;

            document.getElementById('chartsSection').classList.remove('hidden');
            const months = extractedData.full_analysis.months || [];

            // Destroy existing charts
            if (charts.balance) charts.balance.destroy();
            if (charts.flow) charts.flow.destroy();

            const labels = months.map(m => m.month || '');
            const deposits = months.map(m => m.total_deposits || 0);
            const withdrawals = months.map(m => m.total_withdrawals || 0);
            const balances = months.map(m => m.average_daily_balance || 0);

            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#a1a1aa' : '#64748b';

            // Balance Chart
            charts.balance = new Chart(document.getElementById('balanceChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Avg Daily Balance',
                        data: balances,
                        borderColor: '#eab308',
                        backgroundColor: 'rgba(234, 179, 8, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textColor } } },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor } }
                    }
                }
            });

            // Flow Chart
            charts.flow = new Chart(document.getElementById('flowChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Deposits', data: deposits, backgroundColor: '#22c55e' },
                        { label: 'Withdrawals', data: withdrawals, backgroundColor: '#ef4444' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: textColor } } },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor } }
                    }
                }
            });

            // Render debt obligations
            renderDebtObligations();
        }

        function renderDebtObligations() {
            const analysis = extractedData.full_analysis;
            const existingDebt = analysis?.existing_debt || [];
            const avgRevenue = analysis?.aggregated?.avg_monthly_deposits || 0;

            // Filter out empty entries
            const debts = existingDebt.filter(d => d.creditor_name && d.payment_amount > 0);

            if (debts.length === 0) {
                document.getElementById('debtSection').classList.add('hidden');
                return;
            }

            document.getElementById('debtSection').classList.remove('hidden');

            // Calculate monthly obligation for each debt
            const calculateMonthly = (debt) => {
                const amt = debt.payment_amount || 0;
                switch(debt.payment_frequency?.toLowerCase()) {
                    case 'daily': return amt * 22; // ~22 business days
                    case 'weekly': return amt * 4.33;
                    case 'bi-weekly': return amt * 2.17;
                    default: return amt;
                }
            };

            const totalMonthly = debts.reduce((sum, d) => sum + calculateMonthly(d), 0);
            const totalBalance = debts.reduce((sum, d) => sum + (d.estimated_balance || 0), 0);
            const debtToRevenue = avgRevenue > 0 ? (totalMonthly / avgRevenue * 100) : 0;

            // Update summary stats
            document.getElementById('debtTotalMonthly').textContent = '$' + Math.round(totalMonthly).toLocaleString();
            document.getElementById('debtPositionCount').textContent = debts.length;
            document.getElementById('debtEstBalance').textContent = '$' + Math.round(totalBalance).toLocaleString();
            document.getElementById('debtToRevenue').textContent = debtToRevenue.toFixed(1) + '%';
            document.getElementById('debtTotalBadge').textContent = '$' + Math.round(totalMonthly).toLocaleString() + '/mo';

            // Build debt table
            const tableHtml = `
                <table class="debt-table">
                    <thead>
                        <tr>
                            <th>Creditor</th>
                            <th>Type</th>
                            <th>Payment</th>
                            <th>Frequency</th>
                            <th>Monthly</th>
                            <th>Est. Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${debts.map(d => {
                            const typeClass = d.payment_type?.toLowerCase().includes('mca') ? 'mca' :
                                             d.payment_type?.toLowerCase().includes('loan') ? 'loan' :
                                             d.payment_type?.toLowerCase().includes('lease') ? 'lease' : 'other';
                            return `
                            <tr>
                                <td><strong>${d.creditor_name}</strong></td>
                                <td><span class="debt-type-badge debt-type-${typeClass}">${d.payment_type || 'Unknown'}</span></td>
                                <td>$${(d.payment_amount || 0).toLocaleString()}</td>
                                <td>${d.payment_frequency || '-'}</td>
                                <td><strong>$${Math.round(calculateMonthly(d)).toLocaleString()}</strong></td>
                                <td>${d.estimated_balance ? '$' + d.estimated_balance.toLocaleString() : '-'}</td>
                            </tr>`;
                        }).join('')}
                        <tr style="background: var(--bg-tertiary); font-weight: 600;">
                            <td colspan="4">TOTAL OBLIGATIONS</td>
                            <td>$${Math.round(totalMonthly).toLocaleString()}</td>
                            <td>${totalBalance > 0 ? '$' + Math.round(totalBalance).toLocaleString() : '-'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
            document.getElementById('debtTableContainer').innerHTML = tableHtml;

            // Create pie chart for debt breakdown
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#a1a1aa' : '#64748b';

            if (charts.debt) charts.debt.destroy();

            const colors = ['#dc2626', '#f59e0b', '#8b5cf6', '#06b6d4', '#22c55e', '#ec4899', '#84cc16'];
            charts.debt = new Chart(document.getElementById('debtChart'), {
                type: 'doughnut',
                data: {
                    labels: debts.map(d => d.creditor_name),
                    datasets: [{
                        data: debts.map(d => calculateMonthly(d)),
                        backgroundColor: colors.slice(0, debts.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: textColor, font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // Background Research Functions
        const researchModules = [
            { id: 'sos', name: 'Secretary of State', desc: 'Business registration and standing', icon: 'building' },
            { id: 'ucc', name: 'UCC Filings', desc: 'Liens and secured interests', icon: 'file-text' },
            { id: 'tax', name: 'Tax Liens', desc: 'Federal and state tax issues', icon: 'dollar' },
            { id: 'judgment', name: 'Judgments', desc: 'Court judgments and legal actions', icon: 'gavel' },
            { id: 'bankruptcy', name: 'Bankruptcy', desc: 'Business and owner bankruptcy history', icon: 'alert-triangle' },
            { id: 'bbb', name: 'BBB Profile', desc: 'Better Business Bureau rating', icon: 'award' },
            { id: 'reviews', name: 'Online Reviews', desc: 'Google, Yelp, customer sentiment', icon: 'star' },
            { id: 'news', name: 'News & Press', desc: 'Recent news mentions', icon: 'newspaper' },
            { id: 'social', name: 'Social Media', desc: 'Online presence and activity', icon: 'share' },
            { id: 'industry', name: 'Industry Analysis', desc: 'Market position and trends', icon: 'trending' },
            { id: 'owner', name: 'Owner Background', desc: 'Owner history and experience', icon: 'user' },
            { id: 'location', name: 'Location Analysis', desc: 'Market area and competition', icon: 'map' }
        ];

        const moduleIcons = {
            building: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4M9 9v.01M9 12v.01M9 15v.01M9 18v.01"/></svg>',
            'file-text': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>',
            dollar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
            gavel: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2l6 6-1.5 1.5-6-6zM9 7l6 6-7 7-6-6zM2 22l3-3"/></svg>',
            'alert-triangle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>',
            award: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><path d="M8.21 13.89L7 23l5-3 5 3-1.21-9.12"/></svg>',
            star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
            newspaper: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2M18 14h-8M15 18h-5M10 6h8v4h-8z"/></svg>',
            share: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/></svg>',
            trending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>',
            user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            map: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'
        };

        let researchResults = {};

        function toggleModule(moduleId) {
            const module = document.getElementById(`module-${moduleId}`);
            if (module) {
                module.classList.toggle('expanded');
            }
        }

        function toggleAllModules() {
            const modules = document.querySelectorAll('.research-module');
            const btn = document.getElementById('expandAllBtn');
            const anyExpanded = document.querySelector('.research-module.expanded');

            modules.forEach(m => {
                if (anyExpanded) {
                    m.classList.remove('expanded');
                } else {
                    m.classList.add('expanded');
                }
            });
            btn.textContent = anyExpanded ? 'Expand All' : 'Collapse All';
        }

        function updateResearchSummary() {
            let low = 0, medium = 0, high = 0, flags = 0;
            Object.values(researchResults).forEach(r => {
                if (r.risk === 'low') low++;
                else if (r.risk === 'medium') medium++;
                else if (r.risk === 'high') high++;
                flags += (r.flags || []).length;
            });

            document.getElementById('summaryLow').textContent = low;
            document.getElementById('summaryMedium').textContent = medium;
            document.getElementById('summaryHigh').textContent = high;
            document.getElementById('summaryFlags').textContent = flags;
            document.getElementById('researchSummary').style.display = 'grid';
        }

        async function runBackgroundResearch(apiKey) {
            const businessName = extractedBusinessInfo.name;
            const ownerName = extractedBusinessInfo.owner;
            const location = extractedBusinessInfo.address;

            researchResults = {};
            const resultsGrid = document.getElementById('researchResults');
            resultsGrid.innerHTML = researchModules.map(m => `
                <div class="research-module loading" id="module-${m.id}">
                    <div class="research-module-header" onclick="toggleModule('${m.id}')">
                        <div class="research-module-icon">
                            <div class="module-spinner"></div>
                        </div>
                        <div class="research-module-info">
                            <div class="research-module-name">${m.name}</div>
                            <div class="research-module-summary" id="summary-${m.id}">${m.desc}</div>
                        </div>
                        <div class="research-module-status">
                            <span class="risk-badge pending" id="badge-${m.id}">Analyzing</span>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="research-module-content" id="content-${m.id}"></div>
                </div>
            `).join('');

            let completed = 0;
            const updateProgress = () => {
                completed++;
                const pct = Math.round((completed / researchModules.length) * 100);
                document.getElementById('researchProgressFill').style.width = pct + '%';
                document.getElementById('researchProgressText').textContent = `${completed} / ${researchModules.length}`;

                if (completed === researchModules.length) {
                    updateResearchSummary();
                    // Update button text since all modules are now expanded
                    document.getElementById('expandAllBtn').textContent = 'Collapse All';
                }
            };

            // Run research in parallel batches of 3
            const batchSize = 3;
            for (let i = 0; i < researchModules.length; i += batchSize) {
                const batch = researchModules.slice(i, i + batchSize);
                await Promise.all(batch.map(async (module) => {
                    try {
                        const result = await runSingleResearch(apiKey, module, businessName, ownerName, location);
                        researchResults[module.id] = result;
                        renderResearchModule(module, result);
                    } catch (e) {
                        researchResults[module.id] = { risk: 'unknown', summary: 'Research failed - please retry', details: [], flags: [] };
                        renderResearchModule(module, researchResults[module.id]);
                    }
                    updateProgress();
                }));
            }
        }

        async function runSingleResearch(apiKey, module, businessName, ownerName, location) {
            const prompts = {
                sos: `Research the Secretary of State registration for "${businessName}" ${location ? `in ${location}` : ''}. Determine: Is the business in good standing? When was it formed? Any name changes or mergers?`,
                ucc: `Research UCC filings for "${businessName}". Look for: Existing liens, secured creditors, MCA positions, equipment financing.`,
                tax: `Research tax lien status for "${businessName}" ${ownerName ? `and owner ${ownerName}` : ''}. Look for: Federal tax liens, state tax liens, payment plans.`,
                judgment: `Research court judgments and legal actions involving "${businessName}" ${ownerName ? `or ${ownerName}` : ''}. Look for: Civil judgments, lawsuits, collections.`,
                bankruptcy: `Research bankruptcy history for "${businessName}" ${ownerName ? `and owner ${ownerName}` : ''}. Check: Chapter 7, 11, or 13 filings, discharge status.`,
                bbb: `Research the Better Business Bureau profile for "${businessName}". Determine: BBB rating, complaint history, years accredited.`,
                reviews: `Research online reviews for "${businessName}". Analyze: Google rating, Yelp rating, common complaints, customer sentiment.`,
                news: `Research recent news and press mentions for "${businessName}". Look for: Positive coverage, negative incidents, industry recognition.`,
                social: `Research social media presence for "${businessName}". Analyze: Active accounts, follower counts, engagement, content quality.`,
                industry: `Research the industry and market position for "${businessName}". Analyze: Industry trends, competition level, market outlook.`,
                owner: `Research owner background for ${ownerName || businessName}. Look for: Business experience, other ventures, professional history.`,
                location: `Research the business location for "${businessName}" ${location ? `at ${location}` : ''}. Analyze: Area demographics, local competition, foot traffic potential.`
            };

            const model = getSelectedModel();
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: `${prompts[module.id]}

Based on typical patterns for this type of business, provide a simulated research report. Format as JSON:
{
  "risk": "low" | "medium" | "high" | "unknown",
  "summary": "One sentence summary",
  "details": ["Key finding 1", "Key finding 2", "Key finding 3"],
  "flags": ["Any red flags or concerns"]
}

Return ONLY valid JSON.`
                        }]
                    }],
                    generationConfig: { temperature: 0.3, maxOutputTokens: 1024 }
                })
            });

            const data = await resp.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
            text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            return JSON.parse(text);
        }

        function renderResearchModule(module, result) {
            const moduleEl = document.getElementById(`module-${module.id}`);
            const badge = document.getElementById(`badge-${module.id}`);
            const summary = document.getElementById(`summary-${module.id}`);
            const content = document.getElementById(`content-${module.id}`);
            const iconEl = moduleEl.querySelector('.research-module-icon');

            // Remove loading state
            moduleEl.classList.remove('loading');

            // Auto-expand the module to show content
            moduleEl.classList.add('expanded');

            // Set risk class on module
            moduleEl.classList.add(`risk-${result.risk || 'unknown'}`);

            // Update icon
            iconEl.innerHTML = moduleIcons[module.icon] || moduleIcons.building;

            // Update badge
            const riskLabels = { low: 'Low Risk', medium: 'Medium', high: 'High Risk', unknown: 'Unknown' };
            badge.className = `risk-badge ${result.risk || ''}`;
            badge.innerHTML = `<span class="risk-badge-dot"></span>${riskLabels[result.risk] || 'N/A'}`;

            // Update summary line
            summary.textContent = result.summary || 'No data available';

            const details = result.details || [];
            const flags = result.flags || [];

            content.innerHTML = `
                ${details.length > 0 ? `
                    <div class="research-detail-section">
                        <div class="research-detail-label">Key Findings</div>
                        <ul class="research-detail-list">
                            ${details.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${flags.length > 0 ? `
                    <div class="research-flags">
                        <div class="research-flags-title">Red Flags Identified</div>
                        <div class="research-flags-list">${flags.join(' | ')}</div>
                    </div>
                ` : ''}
                ${details.length === 0 && flags.length === 0 ? `
                    <div class="research-detail-section">
                        <p style="color: var(--text-muted); font-size: 13px;">No significant findings for this category.</p>
                    </div>
                ` : ''}
            `;
        }

        function matchLenders(data) {
            return lenderProfiles.map(lender => {
                let totalWeight = 0;
                let earnedWeight = 0;
                const checks = [];

                function check(name, required, actual, isMax = false, weight = 1) {
                    if (required == null) return;
                    totalWeight += weight;
                    if (actual == null) {
                        checks.push({ name, status: 'unknown' });
                        return;
                    }
                    const passed = isMax ? actual <= required : actual >= required;
                    if (passed) {
                        earnedWeight += weight;
                        checks.push({ name, status: 'pass' });
                    } else {
                        const ratio = isMax ? required / Math.max(actual, 1) : actual / Math.max(required, 1);
                        if (ratio >= 0.7) {
                            earnedWeight += weight * 0.5;
                            checks.push({ name, status: 'partial' });
                        } else {
                            checks.push({ name, status: 'fail' });
                        }
                    }
                }

                check('Deposits', lender.min_deposits, data.monthly_deposits, false, 3);
                check('ADB', lender.min_adb, data.average_daily_balance, false, 2);
                check('NSF', lender.max_nsf, data.nsf_negative_days, true, 2);
                check('# Deps', lender.min_num_deps, data.num_deposits_monthly, false, 1);

                const score = totalWeight === 0 ? 50 : Math.round((earnedWeight / totalWeight) * 100);
                const hasHardFail = checks.some(c => c.status === 'fail');

                let level = 'low';
                if (score >= 85 && !hasHardFail) level = 'high';
                else if (score >= 60) level = 'medium';

                return { ...lender, score, level, checks };
            }).sort((a, b) => b.score - a.score);
        }

        function renderLenderResults() {
            const high = matchedLenders.filter(l => l.level === 'high');
            const medium = matchedLenders.filter(l => l.level === 'medium');
            const low = matchedLenders.filter(l => l.level === 'low');

            document.getElementById('lenderCount').textContent = `${high.length} high, ${medium.length} medium matches`;

            document.getElementById('lenderResults').innerHTML = matchedLenders.map(l => `
                <div class="lender-card ${l.level}">
                    <div class="lender-header">
                        <div class="lender-name">${l.name}</div>
                        <div class="lender-score">${l.score}%</div>
                    </div>
                    <div class="lender-meta">
                        <span class="lender-tag">${l.frequency}</span>
                        <span class="lender-tag">${l.min_rate?.toFixed(2) || '?'} - ${l.max_rate?.toFixed(2) || '?'}</span>
                        <span class="lender-tag">Up to $${(l.max_amount || 0).toLocaleString()}</span>
                    </div>
                    <div class="lender-submit">
                        ${l.method === 'email' ? `<a href="mailto:${l.email}">${l.email}</a>` :
                          l.method === 'portal' ? `<a href="${l.portal}" target="_blank">Submit via Portal</a>` :
                          'Contact lender'}
                    </div>
                </div>
            `).join('');
        }

        function renderSubmitInstructions() {
            const topLenders = matchedLenders.filter(l => l.level === 'high').slice(0, 5);

            document.getElementById('submitInstructions').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Based on the analysis, here are your recommended submission targets:
                    </p>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Lender</th>
                            <th>Match</th>
                            <th>Method</th>
                            <th>Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topLenders.map(l => `
                            <tr>
                                <td style="font-weight: 500;">${l.name}</td>
                                <td class="${l.score >= 85 ? 'text-green' : l.score >= 60 ? 'text-gold' : ''}">${l.score}%</td>
                                <td>${l.method === 'email' ? 'Email' : 'Portal'}</td>
                                <td>
                                    ${l.method === 'email' ?
                                        `<a href="mailto:${l.email}" style="color: var(--gold);">${l.email}</a>` :
                                        `<a href="${l.portal}" target="_blank" style="color: var(--gold);">Open Portal </a>`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 16px; background: var(--gold-bg); border-radius: var(--radius-md); border: 1px solid var(--gold);">
                    <div style="font-size: 12px; font-weight: 600; color: var(--gold); margin-bottom: 8px;">Submission Checklist</div>
                    <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8;">
                        <li>Bank statements (you have ${files.length} files ready)</li>
                        <li>Completed application</li>
                        <li>Valid ID (driver's license or passport)</li>
                        <li>Voided check</li>
                        <li>Business documentation (if available)</li>
                    </ul>
                </div>
            `;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
