<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision PRO</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --border: #2a2a2a;
            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --gold: #eab308;
            --gold-bg: rgba(234, 179, 8, 0.1);
            --green: #22c55e;
            --green-bg: rgba(34, 197, 94, 0.1);
            --red: #ef4444;
            --red-bg: rgba(239, 68, 68, 0.1);
            --yellow: #f59e0b;
            --yellow-bg: rgba(245, 158, 11, 0.1);
            --blue: #3b82f6;
            --blue-bg: rgba(59, 130, 246, 0.1);
            --purple: #a855f7;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        [data-theme="light"] {
            --bg: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Smooth scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Text selection */
        ::selection {
            background: rgba(234, 179, 8, 0.3);
            color: var(--text);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .brand:hover {
            transform: scale(1.02);
        }

        .brand svg {
            width: 28px;
            height: 28px;
            filter: drop-shadow(0 0 8px rgba(234, 179, 8, 0.4));
            transition: all 0.3s ease;
        }

        .brand:hover svg {
            filter: drop-shadow(0 0 12px rgba(234, 179, 8, 0.6));
            transform: rotate(5deg);
        }

        .brand-text {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: -0.3px;
            transition: all 0.3s ease;
        }

        .brand-text .gold { color: var(--gold); }

        .header-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 38px;
            height: 38px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            color: var(--gold);
            border-color: var(--gold);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.15);
        }

        .icon-btn:active {
            transform: translateY(0) scale(0.95);
            box-shadow: none;
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }

        .icon-btn:hover svg {
            transform: scale(1.1);
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            background: var(--border);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            border-color: var(--text-muted);
        }

        .btn:active {
            transform: translateY(0) scale(0.97);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
        }

        .btn-primary {
            background: #000000;
            border: none;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary::before {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        }

        .btn-primary:hover {
            background: #222222;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background: #64748b;
        }

        .btn-primary:disabled:hover {
            transform: none;
            box-shadow: none;
            background: #64748b;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: calc(100vh - 56px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 56px;
            height: calc(100vh - 56px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar > * {
            flex-shrink: 0;
        }

        .upload-zone {
            margin: 16px;
            padding: 40px 20px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--gold);
            background: var(--gold-bg);
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(234, 179, 8, 0.15);
        }

        .upload-zone:active {
            transform: scale(0.98);
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: var(--gold);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .upload-zone:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(234, 179, 8, 0.4);
        }

        .upload-icon svg { width: 24px; height: 24px; color: #000; transition: transform 0.3s; }

        .upload-zone:hover .upload-icon svg {
            transform: translateY(-2px);
        }

        .upload-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .upload-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .file-list {
            padding: 0 12px;
            max-height: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .file-item:hover {
            border-color: var(--gold);
            transform: translateX(4px);
            box-shadow: -4px 0 12px rgba(234, 179, 8, 0.1);
        }

        .file-item:active {
            transform: translateX(2px) scale(0.99);
        }

        .file-item.selected {
            border-color: var(--gold);
            background: var(--gold-bg);
            box-shadow: 0 0 0 1px var(--gold), 0 0 20px rgba(234, 179, 8, 0.15);
        }

        .file-item.selected .file-name {
            color: var(--gold);
        }

        .file-item.clean { border-left: 3px solid var(--green); }
        .file-item.warning { border-left: 3px solid var(--yellow); }
        .file-item.danger { border-left: 3px solid var(--red); }

        .file-thumb {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            background: var(--bg);
        }

        .file-info { flex: 1; min-width: 0; }

        .file-name {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .file-status {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
        }

        .file-status.clean { background: var(--green-bg); color: var(--green); }
        .file-status.warning { background: var(--yellow-bg); color: var(--yellow); }
        .file-status.danger { background: var(--red-bg); color: var(--red); }

        .file-remove {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px 8px;
        }

        .file-remove:hover { color: var(--red); }

        .sidebar-footer {
            padding: 16px;
        }
        .sidebar-actions {
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Content Area */
        .content {
            overflow-y: auto;
            padding: 24px;
        }

        /* Progress Steps */
        .progress-steps {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .step {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--text-muted);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
        }

        .step:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .step.active {
            border-color: var(--gold);
            background: var(--gold-bg);
            color: var(--gold);
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.2), inset 0 0 20px rgba(234, 179, 8, 0.05);
        }

        .step.active .step-num {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(234, 179, 8, 0); }
        }

        .step.completed {
            border-color: var(--green);
            background: var(--green-bg);
            color: var(--green);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.15);
        }

        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .step.active .step-num { background: var(--gold); color: #000; }
        .step.completed .step-num { background: var(--green); color: #fff; }

        /* Section Cards */
        .section-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeSlideIn 0.5s ease-out;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-card:hover {
            border-color: rgba(234, 179, 8, 0.3);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(234, 179, 8, 0.1);
            transform: translateY(-2px);
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }

        .section-header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-logo {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .section-body {
            padding: 20px;
        }

        .card-export-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .card-export-btn:hover {
            background: var(--bg-hover);
            border-color: var(--gold);
            color: var(--gold);
        }

        .card-export-btn svg {
            width: 14px;
            height: 14px;
        }

        .section-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Export Menu */
        .export-menu-container {
            position: relative;
            display: inline-block;
        }

        .export-menu-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-menu-btn:hover {
            transform: translateY(-1px);
            background: var(--bg-tertiary);
            border-color: var(--text-muted);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .export-menu-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-menu-btn svg {
            width: 16px;
            height: 16px;
        }

        .export-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease;
            z-index: 1000;
            min-width: 280px;
        }

        .export-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .export-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .export-dropdown-section {
            padding: 8px;
        }

        .export-dropdown-section-title {
            padding: 8px 12px 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            color: var(--text);
        }

        .export-option:hover {
            background: var(--bg-tertiary);
        }

        .export-option-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .export-option-icon.png { background: rgba(34, 197, 94, 0.15); color: var(--green); }
        .export-option-icon.pdf { background: rgba(239, 68, 68, 0.15); color: var(--red); }
        .export-option-icon.print { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
        .export-option-icon.json { background: rgba(168, 85, 247, 0.15); color: var(--purple); }
        .export-option-icon.csv { background: rgba(234, 179, 8, 0.15); color: var(--gold); }
        .export-option-icon.clipboard { background: rgba(99, 102, 241, 0.15); color: #6366f1; }

        .export-option-icon svg {
            width: 16px;
            height: 16px;
        }

        .export-option-info {
            flex: 1;
            min-width: 0;
        }

        .export-option-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }

        .export-option-desc {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .export-option-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--gold-bg);
            color: var(--gold);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Print styles for clean export */
        @media print {
            body {
                background: #ffffff !important;
                color: #000000 !important;
            }
            .header, .sidebar, .export-menu-container, .card-export-btn,
            .expand-toggle, button, .loading, .empty-state, .modal-overlay {
                display: none !important;
            }
            .content {
                margin: 0 !important;
                padding: 20px !important;
            }
            .section-card {
                break-inside: avoid;
                page-break-inside: avoid;
                background: #ffffff !important;
                border: 1px solid #e0e0e0 !important;
                box-shadow: none !important;
                margin-bottom: 20px !important;
            }
            .section-header {
                background: #f5f5f5 !important;
                color: #000000 !important;
            }
            .hidden {
                display: block !important;
            }
            * {
                color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }

        /* Status Message */
        .status-message {
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
            animation: statusSlide 0.3s ease-out;
        }

        @keyframes statusSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message.show { display: block; }
        .status-message.info {
            background: var(--blue-bg);
            color: var(--blue);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
        }
        .status-message.success {
            background: var(--green-bg);
            color: var(--green);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.15);
        }
        .status-message.error {
            background: var(--red-bg);
            color: var(--red);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.15);
        }
        .status-message.warning {
            background: var(--yellow-bg);
            color: var(--yellow);
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.15);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading.show { display: block; }

        .loading-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .spinner-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 3px solid var(--border);
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .spinner-ring {
            width: 80px;
            height: 80px;
            border: 3px solid transparent;
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            position: absolute;
            top: 0;
            left: 0;
        }

        .spinner-ring-2 {
            width: 60px;
            height: 60px;
            border: 2px solid transparent;
            border-bottom-color: var(--gold);
            border-radius: 50%;
            animation: spin-reverse 1.5s linear infinite;
            position: absolute;
            top: 10px;
            left: 10px;
            opacity: 0.5;
        }

        .spinner-dot {
            width: 12px;
            height: 12px;
            background: var(--gold);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: pulse-dot 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px var(--gold), 0 0 40px rgba(234, 179, 8, 0.3);
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes spin-reverse { to { transform: rotate(-360deg); } }
        @keyframes pulse-dot {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.7; }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .loading-progress {
            background: var(--bg-tertiary);
            border-radius: 8px;
            height: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), #f59e0b, var(--gold));
            background-size: 200% 100%;
            animation: shimmer-progress 2s ease-in-out infinite;
            border-radius: 8px;
            transition: width 0.5s ease-out;
        }

        @keyframes shimmer-progress {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .loading-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .loading-step.active {
            color: var(--gold);
            background: rgba(234, 179, 8, 0.15);
            box-shadow: 0 0 12px rgba(234, 179, 8, 0.2);
        }

        .loading-step.done {
            color: var(--green);
            background: rgba(34, 197, 94, 0.15);
        }

        .loading-step-icon {
            width: 14px;
            height: 14px;
        }

        .loading-step.active .loading-step-icon {
            animation: pulse-icon 1s ease-in-out infinite;
        }

        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Skeleton shimmer placeholders */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        .skeleton-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .skeleton-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .skeleton-cell {
            flex: 1;
            height: 40px;
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .data-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
        }

        .data-card.highlight { border-color: var(--gold); }

        .data-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .data-value {
            font-size: 20px;
            font-weight: 700;
        }

        .data-value.green { color: var(--green); }
        .data-value.red { color: var(--red); }
        .data-value.gold { color: var(--gold); }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            transition: all 0.15s ease;
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        tbody tr {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, rgba(234, 179, 8, 0.08) 0%, var(--bg-tertiary) 100%);
            border-left: 3px solid var(--gold);
        }

        tbody tr:hover td {
            color: var(--text);
        }

        tbody tr:active {
            transform: scale(0.995);
        }

        tfoot tr {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            font-weight: 600;
        }

        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-gold { color: var(--gold); }

        /* Risk Chips */
        .risk-summary {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .risk-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            min-width: 80px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
        }

        .risk-chip:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .risk-chip.good {
            border-color: var(--green);
            background: var(--green-bg);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.1);
        }
        .risk-chip.warn {
            border-color: var(--yellow);
            background: var(--yellow-bg);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.1);
        }
        .risk-chip.bad {
            border-color: var(--red);
            background: var(--red-bg);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.1);
            animation: pulse-danger 3s ease-in-out infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.25); }
        }

        .risk-chip.good:hover {
            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4), 0 0 20px rgba(34, 197, 94, 0.2);
        }
        .risk-chip.warn:hover {
            box-shadow: 0 8px 30px rgba(245, 158, 11, 0.4), 0 0 20px rgba(245, 158, 11, 0.2);
        }
        .risk-chip.bad:hover {
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.4), 0 0 20px rgba(239, 68, 68, 0.2);
            animation: none;
        }

        .risk-chip-value {
            font-size: 24px;
            font-weight: 700;
            transition: transform 0.2s;
        }

        .risk-chip:hover .risk-chip-value {
            transform: scale(1.1);
        }

        .risk-chip.good .risk-chip-value { color: var(--green); }
        .risk-chip.warn .risk-chip-value { color: var(--yellow); }
        .risk-chip.bad .risk-chip-value { color: var(--red); }

        .risk-chip-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* MCA Section - Enhanced */
        .mca-section {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--red);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 16px;
            position: relative;
            overflow: hidden;
        }

        .mca-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--red) 0%, #f97316 50%, var(--red) 100%);
        }

        .mca-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .mca-icon {
            width: 40px;
            height: 40px;
            background: var(--red-bg);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .mca-title {
            flex: 1;
        }

        .mca-title h3 {
            color: var(--red);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .mca-title p {
            color: var(--text-muted);
            font-size: 12px;
            margin: 2px 0 0 0;
        }

        .mca-count-badge {
            background: var(--red);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }

        .mca-lender-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mca-lender-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--red);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .mca-lender-card:hover {
            border-color: var(--red);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.15);
        }

        .mca-lender-icon {
            width: 36px;
            height: 36px;
            background: var(--red-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .mca-lender-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }

        .mca-lender-status {
            font-size: 12px;
            color: var(--red);
            font-weight: 600;
        }

        /* Legacy MCA Alert for Red Flags */
        .mca-alert {
            background: var(--red-bg);
            border: 1px solid var(--red);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-top: 16px;
        }

        .mca-alert-title {
            color: var(--red);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .mca-badge {
            display: inline-block;
            padding: 4px 10px;
            margin: 2px 4px 2px 0;
            background: var(--bg-secondary);
            border: 1px solid var(--red);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: var(--red);
            transition: all 0.2s ease;
        }

        .mca-badge:hover {
            background: var(--red-bg);
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }

        /* Lender Cards */
        .lender-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .lender-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            transition: all 0.2s ease;
        }

        .lender-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: var(--text-muted);
        }

        .lender-card.high { border-left: 3px solid var(--green); }
        .lender-card.medium { border-left: 3px solid var(--yellow); }
        .lender-card.low { border-left: 3px solid var(--text-muted); }

        .lender-card.high:hover {
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.15);
        }
        .lender-card.medium:hover {
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.15);
        }

        .lender-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .lender-name {
            font-size: 12px;
            font-weight: 600;
        }

        .lender-score {
            font-size: 14px;
            font-weight: 700;
        }

        .lender-card.high .lender-score { color: var(--green); }
        .lender-card.medium .lender-score { color: var(--yellow); }
        .lender-card.low .lender-score { color: var(--text-muted); }

        .lender-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 6px;
        }

        .lender-tag {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        .lender-submit {
            font-size: 10px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lender-submit a {
            color: var(--gold);
            text-decoration: none;
        }

        .lender-submit a:hover { text-decoration: underline; }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        /* Debt Obligations */
        .debt-total-badge {
            background: var(--danger);
            color: white;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
        }

        .debt-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .debt-stat {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: var(--radius-md);
            text-align: center;
        }

        .debt-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .debt-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .debt-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .debt-table th,
        .debt-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .debt-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .debt-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .debt-type-mca { background: #dc262622; color: #dc2626; }
        .debt-type-loan { background: #f59e0b22; color: #f59e0b; }
        .debt-type-lease { background: #8b5cf622; color: #8b5cf6; }
        .debt-type-other { background: #64748b22; color: #64748b; }

        @media (max-width: 768px) {
            .debt-summary { grid-template-columns: repeat(2, 1fr); }
        }

        /* Credit Engine Scoring Card */
        .credit-engine-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .credit-engine-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .credit-engine-title {
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .credit-engine-version {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .credit-engine-body {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 0;
        }

        .credit-engine-score-panel {
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border);
            position: relative;
        }

        .credit-engine-score-bg {
            position: absolute;
            inset: 0;
            opacity: 0.08;
            transition: background 0.3s;
        }

        .credit-engine-score-value {
            font-size: 56px;
            font-weight: 800;
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        .credit-engine-score-max {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .credit-engine-grade {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            position: relative;
            z-index: 1;
        }

        .credit-engine-grade-letter {
            font-size: 28px;
            font-weight: 800;
        }

        .credit-engine-grade-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .credit-engine-breakdown {
            padding: 24px;
        }

        .credit-engine-breakdown-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .credit-engine-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .credit-engine-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .credit-engine-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
        }

        .credit-engine-bar-track {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .credit-engine-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.3s;
        }

        .credit-engine-points {
            font-size: 13px;
            font-weight: 700;
            min-width: 48px;
            text-align: right;
        }

        .credit-engine-scale {
            display: flex;
            gap: 4px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .credit-engine-scale-item {
            flex: 1;
            padding: 8px 4px;
            border-radius: 4px;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
        }

        .credit-engine-scale-item.active {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* FICO Slider styling for dark mode */
        #ficoSlider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }
        #ficoSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            border: 2px solid var(--bg-secondary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #ficoSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            border: 2px solid var(--bg-secondary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        #ficoSlider::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #ef4444, #f97316, #eab308, #22c55e);
            height: 6px;
            border-radius: 3px;
        }

        /* Dark mode scale items */
        [data-theme="dark"] .credit-engine-scale-item,
        :root:not([data-theme="light"]) .credit-engine-scale-item {
            opacity: 0.9;
        }

        @media (max-width: 640px) {
            .credit-engine-body {
                grid-template-columns: 1fr;
            }
            .credit-engine-score-panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body { padding: 20px; }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .form-input:hover {
            border-color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15), 0 0 20px rgba(234, 179, 8, 0.1);
        }

        /* Placeholder */
        .placeholder {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .placeholder-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* Hidden */
        .hidden { display: none !important; }

        /* Watermark Preview */
        .watermark-preview {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            min-height: 150px;
            max-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
            border: 1px solid var(--border);
            margin: 12px 16px;
            cursor: pointer;
            transition: max-height 0.3s ease;
            flex-shrink: 0;
        }
        .watermark-preview.expanded {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vw;
            max-width: 1200px;
            height: 85vh;
            max-height: 85vh;
            z-index: 1000;
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            margin: 0;
        }
        .watermark-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .watermark-preview-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .watermark-preview canvas {
            max-width: 100%;
            max-height: 260px;
            border-radius: var(--radius-sm);
            transition: max-height 0.3s ease;
        }
        .watermark-preview.expanded canvas {
            max-width: 95%;
            max-height: calc(85vh - 40px);
        }
        .expand-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 16px;
            color: var(--text-secondary);
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }
        .expand-btn:hover {
            opacity: 1;
            background: var(--bg-tertiary);
            color: var(--gold);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        .expand-btn:active {
            transform: scale(0.95);
        }
        .watermark-preview.expanded .expand-btn {
            transform: rotate(180deg);
        }
        .watermark-preview.expanded .expand-btn:hover {
            transform: rotate(180deg) scale(1.05);
        }
        .download-file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .download-file-item:hover {
            border-color: var(--border);
            background: var(--bg-secondary);
            transform: translateX(4px);
        }
        .download-file-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .download-file-item input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 13px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .download-file-item input:hover {
            border-color: var(--text-muted);
        }
        .download-file-item input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15);
        }
        .download-file-item .file-ext {
            color: var(--text-muted);
            font-size: 12px;
        }
        .watermark-placeholder {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }
        .watermark-placeholder-icon {
            font-size: 48px;
            opacity: 0.25;
            margin-bottom: 16px;
        }
        .file-name-input {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            padding: 2px 4px;
            border-radius: 4px;
            width: 100%;
            font-family: inherit;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .file-name-input:hover {
            border-color: var(--border);
            background: rgba(255, 255, 255, 0.02);
        }
        .file-name-input:focus {
            outline: none;
            border-color: var(--gold);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        /* Watermark Controls */
        .watermark-controls {
            padding: 16px;
            border-top: 1px solid var(--border);
        }
        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 12px;
        }
        .control-group { margin-bottom: 0; }
        .control-group label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        .range-value { color: var(--gold); font-weight: 600; }

        .control-group input[type="range"] {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
            transition: background 0.2s;
        }
        .control-group input[type="range"]:hover {
            background: var(--border);
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .control-group input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.5), 0 2px 8px rgba(0,0,0,0.3);
        }
        .control-group input[type="range"]:active::-webkit-slider-thumb {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.6);
        }

        /* Business Info Section */
        .business-info-section {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
            text-align: center;
        }

        .input-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .text-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .text-input:hover {
            border-color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.15), 0 0 20px rgba(234, 179, 8, 0.1);
            background: var(--bg-secondary);
        }

        /* Research Summary Bar */
        .research-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .research-stat {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .research-stat:hover {
            transform: translateY(-2px);
            border-color: var(--border);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .research-stat:hover .research-stat-value {
            transform: scale(1.05);
        }

        .research-stat-value {
            transition: transform 0.3s ease;
        }

        .research-stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .research-stat-value.green { color: var(--green); }
        .research-stat-value.yellow { color: var(--yellow); }
        .research-stat-value.red { color: var(--red); }

        .research-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Research Modules Grid */
        .research-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
        }

        .research-module {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .research-module:hover {
            border-color: var(--text-muted);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .research-module.expanded {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .research-module.risk-low { border-left: 3px solid var(--green); }
        .research-module.risk-medium { border-left: 3px solid var(--yellow); }
        .research-module.risk-high { border-left: 3px solid var(--red); }

        .research-module-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            user-select: none;
        }

        .research-module-header:hover {
            background: var(--bg-tertiary);
        }

        .research-module-header:active {
            background: var(--bg);
        }

        .research-module-icon {
            width: 38px;
            height: 38px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .research-module-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-muted);
        }

        .research-module.risk-low .research-module-icon { background: var(--green-bg); }
        .research-module.risk-low .research-module-icon svg { stroke: var(--green); }
        .research-module.risk-medium .research-module-icon { background: var(--yellow-bg); }
        .research-module.risk-medium .research-module-icon svg { stroke: var(--yellow); }
        .research-module.risk-high .research-module-icon { background: var(--red-bg); }
        .research-module.risk-high .research-module-icon svg { stroke: var(--red); }

        .research-module-info {
            flex: 1;
            min-width: 0;
        }

        .research-module-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-module-summary {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .research-module-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .risk-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .risk-badge.pending {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .risk-badge.low {
            background: var(--green-bg);
            color: var(--green);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }
        .risk-badge.medium {
            background: var(--yellow-bg);
            color: var(--yellow);
            box-shadow: 0 0 10px rgba(234, 179, 8, 0.2);
        }
        .risk-badge.high {
            background: var(--red-bg);
            color: var(--red);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
            animation: pulse-badge 2s ease-in-out infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.2); }
            50% { box-shadow: 0 0 18px rgba(239, 68, 68, 0.4); }
        }

        .risk-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .expand-icon {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .research-module:hover .expand-icon {
            color: var(--gold);
        }

        .research-module.expanded .expand-icon {
            transform: rotate(180deg);
            color: var(--gold);
        }

        .research-module-content {
            display: none;
            padding: 0 16px 16px;
            border-top: 1px solid var(--border);
            margin-top: 0;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInFadeIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes shimmer {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Clickable cell styles */
        .clickable-cell {
            transition: background 0.15s ease, transform 0.1s ease;
        }
        .clickable-cell:hover {
            background: var(--bg-tertiary) !important;
            cursor: pointer;
        }
        .clickable-cell:active {
            transform: scale(0.98);
        }

        /* Skeleton row styles */
        .skeleton-row .skeleton-bar {
            position: relative;
            overflow: hidden;
        }

        .data-row.loaded td {
            animation: cellLoad 0.3s ease-out;
        }

        @keyframes cellLoad {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .research-module.expanded .research-module-content {
            display: block;
        }

        .research-detail-section {
            padding-top: 14px;
        }

        .research-detail-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .research-detail-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .research-detail-list li {
            position: relative;
            padding-left: 16px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 4px;
        }

        .research-detail-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 9px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.2s;
        }

        .research-detail-list li:hover {
            color: var(--text);
        }

        .research-detail-list li:hover::before {
            background: var(--gold);
            box-shadow: 0 0 8px rgba(234, 179, 8, 0.5);
        }

        .research-flags {
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--red-bg);
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--red);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .research-flags-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--red);
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .research-flags-list {
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* Loading spinner for modules */
        .module-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .research-module.loading .research-module-icon {
            background: transparent;
        }

        /* Fraud Analysis Modules */
        .fraud-modules-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 8px;
        }

        .fraud-module {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .fraud-module:hover {
            border-color: var(--text-muted);
            transform: translateY(-1px);
        }

        .fraud-module.risk-low { border-left: 4px solid var(--green); }
        .fraud-module.risk-medium { border-left: 4px solid var(--yellow); }
        .fraud-module.risk-high { border-left: 4px solid var(--red); }

        .fraud-module-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 18px;
            cursor: pointer;
            user-select: none;
        }

        .fraud-module-header:hover {
            background: var(--bg-secondary);
        }

        .fraud-module-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .fraud-module-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-muted);
        }

        .fraud-module.risk-low .fraud-module-icon { background: var(--green-bg); }
        .fraud-module.risk-low .fraud-module-icon svg { stroke: var(--green); }
        .fraud-module.risk-medium .fraud-module-icon { background: var(--yellow-bg); }
        .fraud-module.risk-medium .fraud-module-icon svg { stroke: var(--yellow); }
        .fraud-module.risk-high .fraud-module-icon { background: var(--red-bg); }
        .fraud-module.risk-high .fraud-module-icon svg { stroke: var(--red); }

        .fraud-module-info {
            flex: 1;
            min-width: 0;
        }

        .fraud-module-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
        }

        .fraud-module-summary {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .fraud-module-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
            color: var(--text-muted);
        }

        .fraud-module.risk-low .fraud-module-status { background: var(--green-bg); color: var(--green); }
        .fraud-module.risk-medium .fraud-module-status { background: var(--yellow-bg); color: var(--yellow); }
        .fraud-module.risk-high .fraud-module-status { background: var(--red-bg); color: var(--red); }
        .fraud-module.risk-pending { border-left: 4px solid var(--border); }
        .fraud-module.risk-pending .fraud-module-icon { animation: pulse 1.5s ease-in-out infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1); }
        }

        .fraud-module .expand-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .fraud-module .expand-icon svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-muted);
        }

        .fraud-module.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .fraud-module-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 14px;
        }

        .fraud-module.expanded .fraud-module-content {
            max-height: 200px;
            padding: 0 14px 14px 14px;
        }

        /* Research Progress */
        .research-progress {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .research-progress-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .research-progress-bar {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .research-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold) 0%, #f59e0b 100%);
            border-radius: 4px;
            transition: width 0.3s ease-out;
        }

        .research-progress-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--gold);
            white-space: nowrap;
            min-width: 80px;
            text-align: right;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .research-grid {
                grid-template-columns: 1fr;
            }
            .research-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            .research-module-header {
                flex-wrap: wrap;
                gap: 8px;
            }
            .research-module-status {
                width: 100%;
                justify-content: space-between;
                margin-top: 8px;
            }
        }

        /* Print Styles */
        @media print {
            .header, .sidebar, .progress-steps { display: none; }
            .main-container { display: block; }
            .content { padding: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <svg viewBox="0 0 64 64" fill="none">
                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
            </svg>
            <span class="brand-text"><span style="color: var(--text);">Vision</span> <span style="color: var(--text-muted);">Pro</span></span>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle" title="Toggle Theme">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
            </button>
            <button class="icon-btn" id="settingsBtn" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <button class="icon-btn" id="exportBtn" title="Export PDF">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Business Info Section (auto-extracted from bank statements) -->
            <div class="business-info-section" id="businessInfoSection" style="display: none;">
                <label class="input-label">Extracted Business Info</label>
                <div id="extractedBusinessDisplay" style="font-size: 13px; color: var(--text-secondary); padding: 8px; background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                    <div><strong id="displayBusinessName">-</strong></div>
                    <div id="displayOwnerName" style="margin-top: 4px;"></div>
                    <div id="displayBusinessAddress" style="margin-top: 4px;"></div>
                </div>
            </div>

            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                    </svg>
                </div>
                <div class="upload-title">Drop Bank Statements</div>
                <div class="upload-subtitle">PDF or images  Multiple files OK</div>
            </div>
            <input type="file" id="fileInput" accept=".pdf,image/*" multiple hidden>

            <div class="file-list" id="fileList"></div>

            <!-- Action Buttons -->
            <div class="sidebar-actions">
                <div class="file-count" id="fileCount">0 files</div>
                <button class="btn btn-secondary" id="downloadAllBtn" style="width: 100%; display: none;">
                    Download Watermarked
                </button>
                <button class="btn btn-primary" id="processBtn" style="width: 100%;" disabled>
                    Analyze Documents
                </button>
                <div class="export-menu-container" style="width: 100%;">
                    <button class="export-menu-btn" id="exportMenuBtn" style="width: 100%;" disabled onclick="toggleExportMenu()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export Report
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                            <polyline points="18 15 12 9 6 15"/>
                        </svg>
                    </button>
                    <div class="export-dropdown" id="exportDropdown">
                        <div class="export-dropdown-header">Export Options</div>
                        <div class="export-dropdown-section">
                            <div class="export-dropdown-section-title">Images</div>
                            <button class="export-option" onclick="exportMethod('png-clean')">
                                <div class="export-option-icon png">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PNG (Light Theme)</div>
                                    <div class="export-option-desc">Clean white background, DOM clone method</div>
                                </div>
                                <span class="export-option-badge">Best</span>
                            </button>
                            <button class="export-option" onclick="exportMethod('png-iframe')">
                                <div class="export-option-icon png">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PNG (Iframe Render)</div>
                                    <div class="export-option-desc">Isolated render, avoids style conflicts</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('png-native')">
                                <div class="export-option-icon png">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PNG (Current Theme)</div>
                                    <div class="export-option-desc">Exports as-is with current dark/light theme</div>
                                </div>
                            </button>
                        </div>
                        <div class="export-dropdown-section">
                            <div class="export-dropdown-section-title">Documents</div>
                            <button class="export-option" onclick="exportMethod('pdf')">
                                <div class="export-option-icon pdf">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">PDF Document</div>
                                    <div class="export-option-desc">Multi-page PDF with light theme</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('print')">
                                <div class="export-option-icon print">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">Print / Save as PDF</div>
                                    <div class="export-option-desc">Uses browser print dialog, best quality</div>
                                </div>
                            </button>
                        </div>
                        <div class="export-dropdown-section">
                            <div class="export-dropdown-section-title">Data</div>
                            <button class="export-option" onclick="exportMethod('json')">
                                <div class="export-option-icon json">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M8 13h2M8 17h2M12 13h4M12 17h4"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">JSON Data</div>
                                    <div class="export-option-desc">Raw analysis data for integration</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('csv')">
                                <div class="export-option-icon csv">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M8 13h8M8 17h8M8 9h1"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">CSV Spreadsheet</div>
                                    <div class="export-option-desc">Monthly data for Excel/Sheets</div>
                                </div>
                            </button>
                            <button class="export-option" onclick="exportMethod('clipboard')">
                                <div class="export-option-icon clipboard">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
                                </div>
                                <div class="export-option-info">
                                    <div class="export-option-title">Copy to Clipboard</div>
                                    <div class="export-option-desc">Formatted summary text</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watermark Preview Overlay -->
            <div class="watermark-preview-overlay" id="previewOverlay" onclick="togglePreviewSize()"></div>

            <!-- Watermark Preview -->
            <div class="watermark-preview" id="previewContainer">
                <div class="watermark-placeholder" id="watermarkPlaceholder">
                    <div class="watermark-placeholder-icon">+</div>
                    <div>Select a file to preview watermark</div>
                </div>
                <canvas id="previewCanvas" style="display:none;"></canvas>
                <button class="expand-btn" id="expandBtn" onclick="togglePreviewSize()"></button>
            </div>

            <!-- Watermark Controls -->
            <div class="watermark-controls">
                <div class="control-row">
                    <div class="control-group">
                        <label>Opacity <span class="range-value" id="opacityVal">25%</span></label>
                        <input type="range" id="opacitySlider" min="5" max="50" value="25">
                    </div>
                    <div class="control-group">
                        <label>Size <span class="range-value" id="sizeVal">15%</span></label>
                        <input type="range" id="sizeSlider" min="5" max="40" value="15">
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label>Density <span class="range-value" id="densityVal">50%</span></label>
                        <input type="range" id="densitySlider" min="20" max="80" value="50">
                    </div>
                    <div class="control-group">
                        <label>Rotation <span class="range-value" id="rotationVal">45</span></label>
                        <input type="range" id="rotationSlider" min="0" max="90" value="45">
                    </div>
                </div>
                <button class="btn" style="width: 100%; margin-top: 12px;" onclick="saveWatermarkDefaults()">
                    Save as Defaults
                </button>
            </div>

        </aside>

        <!-- Content -->
        <main class="content">
            <!-- Progress Steps -->
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <span class="step-num">1</span>
                    <span>Upload</span>
                </div>
                <div class="step" id="step2">
                    <span class="step-num">2</span>
                    <span>Fraud Scan</span>
                </div>
                <div class="step" id="step3">
                    <span class="step-num">3</span>
                    <span>Extract Data</span>
                </div>
                <div class="step" id="step4">
                    <span class="step-num">4</span>
                    <span>Research</span>
                </div>
                <div class="step" id="step5">
                    <span class="step-num">5</span>
                    <span>Match Lenders</span>
                </div>
            </div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage"></div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="loading-container">
                    <div class="spinner-wrapper">
                        <div class="spinner"></div>
                        <div class="spinner-ring"></div>
                        <div class="spinner-ring-2"></div>
                        <div class="spinner-dot"></div>
                    </div>
                    <div class="loading-text" id="loadingText">Processing...</div>
                    <div class="loading-subtext" id="loadingSubtext">This may take a moment</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="loading-steps" id="loadingSteps">
                        <div class="loading-step" data-step="scan">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <span>Scanning</span>
                        </div>
                        <div class="loading-step" data-step="extract">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/></svg>
                            <span>Extracting</span>
                        </div>
                        <div class="loading-step" data-step="analyze">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            <span>Analyzing</span>
                        </div>
                        <div class="loading-step" data-step="match">
                            <svg class="loading-step-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><path d="M22 4L12 14.01l-3-3"/></svg>
                            <span>Matching</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Area for Export -->
            <div id="resultsArea">

            <!-- Credit Engine Scoring -->
            <div class="section-card hidden" id="scoreSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Credit Engine</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('scoreSection', 'Credit_Score')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" style="padding: 0;">
                    <div class="credit-engine-card">
                        <div class="credit-engine-header">
                            <div>
                                <div class="credit-engine-title">ABLESAI CREDIT ENGINE</div>
                                <div class="credit-engine-version">V4.2</div>
                            </div>
                        </div>
                        <div class="credit-engine-body">
                            <div class="credit-engine-score-panel">
                                <div class="credit-engine-score-bg" id="scoreHeaderBg"></div>
                                <div class="credit-engine-score-value" id="scoreValue">--<span class="credit-engine-score-max">/100</span></div>
                                <div class="credit-engine-grade">
                                    <span class="credit-engine-grade-letter" id="scoreGradeLetter">-</span>
                                    <span class="credit-engine-grade-label" id="scoreGradeLabel">Calculating...</span>
                                </div>
                            </div>
                            <div class="credit-engine-breakdown">
                                <div class="credit-engine-breakdown-title">Score Breakdown</div>
                                <!-- Credit Score with FICO input -->
                                <div class="credit-engine-row" style="flex-wrap: wrap; gap: 8px;">
                                    <div class="credit-engine-dot" id="dotCredit" style="background: #6b7280;"></div>
                                    <span class="credit-engine-label">Credit Score</span>
                                    <div class="credit-engine-bar-track"><div class="credit-engine-bar-fill" id="barCredit" style="width: 0%;"></div></div>
                                    <span class="credit-engine-points" id="scoreCredit">--</span>
                                    <div style="width: 100%; display: flex; align-items: center; gap: 8px; margin-top: 4px; padding-left: 20px;">
                                        <input type="range" id="ficoSlider" min="450" max="850" value="650" style="flex: 1; accent-color: var(--gold);" oninput="updateFicoFromSlider(this.value)">
                                        <input type="number" id="ficoInput" min="450" max="850" value="650" style="width: 60px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-tertiary); color: var(--text); font-size: 12px; text-align: center;" onchange="updateFicoFromInput(this.value)">
                                        <label style="font-size: 10px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                            <input type="file" id="creditReportUpload" accept=".pdf" style="display: none;" onchange="handleCreditReportUpload(this)">
                                            <span style="padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; white-space: nowrap;">Upload Report</span>
                                        </label>
                                    </div>
                                </div>
                                <!-- Behavior -->
                                <div class="credit-engine-row">
                                    <div class="credit-engine-dot" id="dotBehavior" style="background: #6b7280;"></div>
                                    <span class="credit-engine-label">Behavior (<span id="eventsLabel">0</span>)</span>
                                    <div class="credit-engine-bar-track"><div class="credit-engine-bar-fill" id="barBehavior" style="width: 0%;"></div></div>
                                    <span class="credit-engine-points" id="scoreBehavior">0/15</span>
                                </div>
                                <!-- Revenue -->
                                <div class="credit-engine-row">
                                    <div class="credit-engine-dot" id="dotRevenue" style="background: #6b7280;"></div>
                                    <span class="credit-engine-label">Revenue</span>
                                    <div class="credit-engine-bar-track"><div class="credit-engine-bar-fill" id="barRevenue" style="width: 0%;"></div></div>
                                    <span class="credit-engine-points" id="scoreRevenue">0/30</span>
                                </div>
                                <!-- Stability -->
                                <div class="credit-engine-row">
                                    <div class="credit-engine-dot" id="dotStability" style="background: #6b7280;"></div>
                                    <span class="credit-engine-label">Stability</span>
                                    <div class="credit-engine-bar-track"><div class="credit-engine-bar-fill" id="barStability" style="width: 0%;"></div></div>
                                    <span class="credit-engine-points" id="scoreStability">0/20</span>
                                </div>
                                <!-- Buffer -->
                                <div class="credit-engine-row">
                                    <div class="credit-engine-dot" id="dotBuffer" style="background: #6b7280;"></div>
                                    <span class="credit-engine-label">Buffer (<span id="bufferPct">0</span>%)</span>
                                    <div class="credit-engine-bar-track"><div class="credit-engine-bar-fill" id="barBuffer" style="width: 0%;"></div></div>
                                    <span class="credit-engine-points" id="scoreBuffer">0/15</span>
                                </div>
                                <!-- Grade Scale -->
                                <div class="credit-engine-scale">
                                    <div class="credit-engine-scale-item" id="scaleE" style="background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);">E &lt;35</div>
                                    <div class="credit-engine-scale-item" id="scaleD" style="background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3);">D 35+</div>
                                    <div class="credit-engine-scale-item" id="scaleC" style="background: rgba(234, 179, 8, 0.2); color: #facc15; border: 1px solid rgba(234, 179, 8, 0.3);">C 50+</div>
                                    <div class="credit-engine-scale-item" id="scaleB" style="background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3);">B 65+</div>
                                    <div class="credit-engine-scale-item" id="scaleA" style="background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3);">A 80+</div>
                                </div>
                                <!-- Suggested Approval -->
                                <div class="credit-engine-approval" id="approvalSection" style="margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 10px; border: 2px solid var(--border);">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Suggested Approval</div>
                                        <div id="approvalBadge" style="padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; background: #fee2e2; color: #dc2626;">CALCULATING...</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                                        <div>
                                            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Max Advance</div>
                                            <div id="suggestedAmount" style="font-size: 20px; font-weight: 700; color: var(--text);">$--</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Factor Rate</div>
                                            <div id="suggestedRate" style="font-size: 20px; font-weight: 700; color: var(--text);">--</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Daily Payment</div>
                                            <div id="suggestedPayment" style="font-size: 20px; font-weight: 700; color: var(--text);">$--</div>
                                        </div>
                                    </div>
                                    <div id="approvalNote" style="margin-top: 12px; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 11px; color: var(--text-muted); text-align: center;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fraud Results -->
            <div class="section-card hidden" id="fraudSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Fraud Analysis</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('fraudSection', 'Fraud_Analysis')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" id="fraudResults"></div>
            </div>

            <!-- Extracted Data -->
            <div class="section-card hidden" id="dataSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Bank Analysis Worksheet</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('dataSection', 'Bank_Analysis')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" id="extractedData"></div>
            </div>

            <!-- Charts Section -->
            <div class="section-card hidden" id="chartsSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Cash Flow Analysis</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('chartsSection', 'Cash_Flow')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body">
                    <div class="chart-row">
                        <div class="chart-container">
                            <canvas id="balanceChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Existing Debt Obligations -->
            <div class="section-card hidden" id="debtSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Existing Debt Obligations</span></div>
                    <div class="section-header-actions">
                        <span class="debt-total-badge" id="debtTotalBadge">$0/mo</span>
                        <button class="card-export-btn" onclick="exportCardAsPng('debtSection', 'Debt_Obligations')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="debt-summary" id="debtSummary">
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtTotalMonthly">$0</div>
                            <div class="debt-stat-label">Monthly Obligation</div>
                        </div>
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtPositionCount">0</div>
                            <div class="debt-stat-label">Active Positions</div>
                        </div>
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtEstBalance">$0</div>
                            <div class="debt-stat-label">Est. Total Balance</div>
                        </div>
                        <div class="debt-stat">
                            <div class="debt-stat-value" id="debtToRevenue">0%</div>
                            <div class="debt-stat-label">Debt-to-Revenue</div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 200px; margin: 16px 0;">
                        <canvas id="debtChart"></canvas>
                    </div>
                    <div class="debt-table-container" id="debtTableContainer"></div>
                </div>
            </div>

            <!-- Background Research -->
            <div class="section-card hidden" id="researchSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Background Research: <span id="researchBusinessName">-</span></span></div>
                    <div class="section-header-actions">
                        <button class="btn" id="expandAllBtn" onclick="toggleAllModules()" style="font-size: 12px; padding: 6px 12px;">Expand All</button>
                        <button class="card-export-btn" onclick="exportCardAsPng('researchSection', 'Background_Research')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <!-- Progress Bar -->
                    <div class="research-progress" id="researchProgress">
                        <div class="research-progress-label">Research Progress</div>
                        <div class="research-progress-bar">
                            <div class="research-progress-fill" id="researchProgressFill" style="width: 0%"></div>
                        </div>
                        <div class="research-progress-text" id="researchProgressText">0 / 12</div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="research-summary" id="researchSummary" style="display: none;">
                        <div class="research-stat">
                            <div class="research-stat-value green" id="summaryLow">0</div>
                            <div class="research-stat-label">Low Risk</div>
                        </div>
                        <div class="research-stat">
                            <div class="research-stat-value yellow" id="summaryMedium">0</div>
                            <div class="research-stat-label">Medium Risk</div>
                        </div>
                        <div class="research-stat">
                            <div class="research-stat-value red" id="summaryHigh">0</div>
                            <div class="research-stat-label">High Risk</div>
                        </div>
                        <div class="research-stat">
                            <div class="research-stat-value" id="summaryFlags">0</div>
                            <div class="research-stat-label">Red Flags</div>
                        </div>
                    </div>

                    <!-- Module Grid -->
                    <div class="research-grid" id="researchResults"></div>
                </div>
            </div>

            <!-- Lender Results -->
            <div class="section-card hidden" id="lenderSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Lender Matches</span></div>
                    <div class="section-header-actions">
                        <span class="file-count" id="lenderCount"></span>
                        <button class="card-export-btn" onclick="exportCardAsPng('lenderSection', 'Lender_Matches')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            PNG
                        </button>
                    </div>
                </div>
                <div class="section-body">
                    <div class="lender-grid" id="lenderResults"></div>
                </div>
            </div>

            <!-- Submit Instructions -->
            <div class="section-card hidden" id="submitSection">
                <div class="section-header">
                    <div class="section-header-title"><svg class="section-logo" viewBox="0 0 64 64" fill="none"><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/><circle cx="32" cy="32" r="12" fill="#eab308"/><ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/></svg><span>Submission Instructions</span></div>
                    <button class="card-export-btn" onclick="exportCardAsPng('submitSection', 'Submit_Instructions')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        PNG
                    </button>
                </div>
                <div class="section-body" id="submitInstructions"></div>
            </div>

            </div><!-- End resultsArea -->

            <!-- Empty State -->
            <div class="placeholder" id="emptyState">
                <div class="placeholder-icon"></div>
                <div>Drop bank statements in the sidebar to begin analysis</div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Settings</span>
                <button class="modal-close" onclick="closeModal('settingsModal')"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Gemini API Key</label>
                    <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your Gemini API key">
                </div>
                <div class="form-group">
                    <label class="form-label">Model</label>
                    <select class="form-input" id="modelSelect">
                        <option value="gemini-3-pro-preview">Gemini 3 Pro (Best)</option>
                        <option value="gemini-3-flash-preview">Gemini 3 Flash (Recommended)</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Watermark Image URL</label>
                    <input type="url" class="form-input" id="watermarkUrlInput" placeholder="https://example.com/logo.png">
                    <small style="color: var(--text-muted); font-size: 11px; margin-top: 4px; display: block;">PNG with transparency recommended</small>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Fraud Detail Modal -->
    <div class="modal-overlay" id="fraudDetailModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Fraud Analysis Details</span>
                <button class="modal-close" onclick="closeModal('fraudDetailModal')"></button>
            </div>
            <div class="modal-body" id="fraudDetailContent"></div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal-overlay" id="downloadModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <span class="modal-title">Download Watermarked Files</span>
                <button class="modal-close" onclick="closeModal('downloadModal')"></button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">Edit filenames before downloading:</p>
                <div id="downloadFileList" style="max-height: 300px; overflow-y: auto;"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="executeDownload()">
                    Download All
                </button>
            </div>
        </div>
    </div>

    <!-- Statement Viewer Modal -->
    <div class="modal-overlay" id="statementViewerModal">
        <div class="modal" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span class="modal-title" id="statementViewerTitle">Bank Statement</span>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn btn-secondary" id="prevPageBtn" onclick="navigateStatementPage(-1)" style="padding: 6px 12px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                    </button>
                    <span id="pageIndicator" style="font-size: 13px; color: var(--text-secondary);">Page 1 of 1</span>
                    <button class="btn btn-secondary" id="nextPageBtn" onclick="navigateStatementPage(1)" style="padding: 6px 12px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    </button>
                    <button class="modal-close" onclick="closeModal('statementViewerModal')"></button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; overflow: auto; max-height: calc(90vh - 60px); background: var(--bg-tertiary);">
                <div id="statementViewerContent" style="display: flex; justify-content: center; align-items: flex-start; min-height: 400px;">
                    <!-- Statement pages will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title">Export Report</span>
                <button class="modal-close" onclick="closeModal('exportModal')"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Export Settings Section -->
                <div style="margin-bottom: 24px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Export Settings</div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Scale (DPI)</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportScaleSlider" min="1" max="4" step="0.5" value="2" style="flex: 1;">
                                <span id="exportScaleVal" style="font-size: 13px; color: var(--text); min-width: 30px;">2x</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">Higher = better quality, larger file</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Padding (px)</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportPaddingSlider" min="0" max="48" step="4" value="24" style="flex: 1;">
                                <span id="exportPaddingVal" style="font-size: 13px; color: var(--text); min-width: 30px;">24px</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">Whitespace around content</small>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Image Quality</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportQualitySlider" min="0.5" max="1" step="0.1" value="1" style="flex: 1;">
                                <span id="exportQualityVal" style="font-size: 13px; color: var(--text); min-width: 40px;">100%</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">JPEG/PNG compression</small>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Max Width (px)</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="exportWidthSlider" min="800" max="1920" step="80" value="1200" style="flex: 1;">
                                <span id="exportWidthVal" style="font-size: 13px; color: var(--text); min-width: 50px;">1200</span>
                            </div>
                            <small style="color: var(--text-muted); font-size: 10px;">Content area width</small>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Background</label>
                            <select class="form-input" id="exportBgSelect" style="padding: 8px 12px;">
                                <option value="#ffffff">White</option>
                                <option value="#f8fafc">Light Gray</option>
                                <option value="#f3f4f6">Gray</option>
                                <option value="transparent">Transparent (PNG only)</option>
                            </select>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Theme</label>
                            <select class="form-input" id="exportThemeSelect" style="padding: 8px 12px;">
                                <option value="light">Light (Recommended)</option>
                                <option value="dark">Dark</option>
                                <option value="current">Current Theme</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Quick Export Buttons -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Quick Export</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="btn" onclick="exportMethod('png-clean'); closeModal('exportModal');" style="padding: 12px 8px; font-size: 12px;">
                            <div style="font-size: 18px; margin-bottom: 4px;"></div>
                            PNG Light
                        </button>
                        <button class="btn" onclick="exportMethod('png-native'); closeModal('exportModal');" style="padding: 12px 8px; font-size: 12px;">
                            <div style="font-size: 18px; margin-bottom: 4px;"></div>
                            PNG Native
                        </button>
                        <button class="btn" onclick="exportMethod('pdf'); closeModal('exportModal');" style="padding: 12px 8px; font-size: 12px;">
                            <div style="font-size: 18px; margin-bottom: 4px;"></div>
                            PDF
                        </button>
                    </div>
                </div>

                <!-- Sections to Export -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Sections to Include</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportFraud" checked style="accent-color: var(--gold);">
                            Fraud Analysis
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportData" checked style="accent-color: var(--gold);">
                            Bank Analysis
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportCharts" checked style="accent-color: var(--gold);">
                            Cash Flow Charts
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportDebt" checked style="accent-color: var(--gold);">
                            Debt Obligations
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportResearch" checked style="accent-color: var(--gold);">
                            Background Research
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="exportLenders" checked style="accent-color: var(--gold);">
                            Lender Matches
                        </label>
                    </div>
                </div>

                <!-- Export All Sections -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="exportWithSettings('png'); closeModal('exportModal');" style="padding: 14px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 8px; display: inline;"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                        Export as PNG
                    </button>
                    <button class="btn btn-primary" onclick="exportWithSettings('pdf'); closeModal('exportModal');" style="padding: 14px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; margin-right: 8px; display: inline;"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>
                        Export as PDF
                    </button>
                </div>

                <!-- Other Export Options -->
                <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                    <div style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 12px;">Other Formats</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <button class="btn" onclick="exportMethod('print'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             Print
                        </button>
                        <button class="btn" onclick="exportMethod('json'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             JSON
                        </button>
                        <button class="btn" onclick="exportMethod('csv'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             CSV
                        </button>
                        <button class="btn" onclick="exportMethod('clipboard'); closeModal('exportModal');" style="padding: 10px 8px; font-size: 11px;">
                             Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Lender Profiles
        const lenderProfiles = [
            {name:"Trust Capital Funding",id:"TCF",min_credit:550,min_tib:6,min_deposits:20000,min_num_deps:10,min_adb:2500,max_nsf:3,method:"email",email:"submissions@trustcapitalfunding.com",min_rate:1.28,max_rate:1.42,min_term:6,max_term:12,max_amount:480000,frequency:"Daily"},
            {name:"Wide Merchant Group",id:"WMG",min_credit:480,min_tib:6,min_deposits:8000,min_num_deps:2,min_adb:750,max_nsf:0,max_position:6,method:"email",email:"deals@widemerchantgroup.com",min_rate:1.46,max_rate:1.49,min_term:3,max_term:9,max_amount:25000,frequency:"Daily"},
            {name:"Kapitus",id:"KAP",method:"portal",portal:"https://partner.kapitus.com",min_rate:1.15,max_rate:1.35,min_term:6,max_term:24,max_amount:200000,frequency:"Weekly"},
            {name:"Kalamata Capital",id:"KAL",min_credit:600,min_tib:12,min_deposits:40000,min_num_deps:5,min_adb:5000,max_nsf:3,max_position:3,method:"email",email:"submissions@kalamatacapital.com",min_rate:1.18,max_rate:1.45,min_term:6,max_term:15,max_amount:275000,frequency:"Weekly"},
            {name:"Rapid Finance",id:"RAF",min_credit:620,min_tib:36,min_deposits:10000,method:"portal",portal:"https://portal.rapidfinance.com",min_rate:1.28,max_rate:1.48,min_term:3,max_term:12,max_amount:400000,frequency:"Weekly"},
            {name:"Alternative Funding Group",id:"AFG",min_credit:550,min_tib:12,min_deposits:20000,min_num_deps:4,min_adb:1000,max_nsf:4,max_position:4,method:"email",email:"deals@altfundinggroup.com",min_rate:1.37,max_rate:1.46,min_term:4,max_term:10,max_amount:150000,frequency:"Weekly"},
            {name:"Fundfi",id:"FMF",min_tib:12,min_deposits:35000,min_num_deps:6,max_nsf:5,max_position:5,method:"email",email:"submit@fundfi.com",min_rate:1.45,max_rate:1.46,min_term:6,max_term:12,max_amount:85000,frequency:"Daily"},
            {name:"Bitty Advance",id:"BIT",min_credit:500,min_tib:12,min_deposits:5000,max_nsf:7,max_position:3,method:"email",email:"submissions@bittyadvance.com",min_rate:1.55,max_rate:1.59,min_term:2,max_term:6,max_amount:35000,frequency:"Daily"},
            {name:"JRG Funding",id:"JRG",min_credit:500,min_tib:12,min_deposits:15000,min_num_deps:4,min_adb:1000,max_nsf:4,max_position:8,method:"email",email:"deals@jrgfunding.com",min_rate:1.29,max_rate:1.40,min_term:3,max_term:12,max_amount:200000,frequency:"Weekly"},
            {name:"eFinancial Tree",id:"EFT",min_credit:500,min_tib:6,min_deposits:15000,min_num_deps:2,min_adb:1000,max_nsf:3,max_position:3,method:"email",email:"submit@efinancialtree.com",min_rate:1.30,max_rate:1.45,min_term:3,max_term:10,max_amount:105000,frequency:"Weekly"},
            {name:"Silverline Funding",id:"SLF",min_credit:500,min_tib:5,min_deposits:25000,min_adb:1000,max_nsf:3,max_position:6,method:"email",email:"submissions@silverlinefunding.com",min_rate:1.40,max_rate:1.48,min_term:3,max_term:12,max_amount:15000,frequency:"Weekly"},
            {name:"Smart Step Funding",id:"SSF",min_credit:600,min_tib:24,min_deposits:10000,min_num_deps:6,method:"email",email:"deals@smartstepfunding.com",min_rate:1.25,max_rate:1.35,min_term:9,max_term:17,max_amount:110000,frequency:"Weekly"},
            {name:"Reliable Capital",id:"REL",min_credit:525,min_tib:12,min_deposits:25000,max_nsf:3,method:"email",email:"submit@reliablecapital.com",min_rate:1.35,max_rate:1.42,min_term:6,max_term:12,max_amount:45000,frequency:"Weekly"},
            {name:"Ondeck",id:"OND",method:"portal",portal:"https://partner.ondeck.com",min_rate:1.20,max_rate:1.35,min_term:6,max_term:24,max_amount:250000,frequency:"Weekly"},
            {name:"1DC Funding",id:"1DC",method:"email",email:"submissions@1dcfunding.com",min_rate:1.45,max_rate:1.60,min_term:3,max_term:12,max_amount:260000,frequency:"Daily"},
            {name:"Forward Financing",id:"FF",method:"portal",portal:"https://broker.forwardfinancing.com",min_rate:1.37,max_rate:1.51,min_term:4,max_term:15,max_amount:65000,frequency:"Weekly"},
            {name:"Credibly",id:"CRE",method:"portal",portal:"https://portal.credibly.com",min_rate:1.40,max_rate:1.49,min_term:6,max_term:18,max_amount:116200,frequency:"Weekly"}
        ];

        // State
        let files = [];
        let extractedData = null;
        let matchedLenders = [];
        let charts = {};
        let activeFileIndex = -1;
        let logoImage = null;
        let canvas = null;
        let ctx = null;
        const settings = { opacity: 0.25, size: 0.15, density: 0.50, rotation: 45 };

        // Export settings
        const exportSettings = {
            scale: 2,
            padding: 24,
            quality: 1,
            width: 1200,
            background: '#ffffff',
            theme: 'light'
        };

        // Initialize
        function init() {
            // Initialize canvas
            canvas = document.getElementById('previewCanvas');
            ctx = canvas ? canvas.getContext('2d') : null;

            // Load settings
            document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_key') || '';
            document.getElementById('modelSelect').value = localStorage.getItem('gemini_model') || 'gemini-3-flash-preview';
            document.getElementById('watermarkUrlInput').value = localStorage.getItem('watermark_url') || 'https://i.imgur.com/MXMqYLc.png';
            loadWatermark(localStorage.getItem('watermark_url') || 'https://i.imgur.com/MXMqYLc.png');

            // Load theme - default to light, save preference
            const theme = localStorage.getItem('vision_theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);

            // Event listeners
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('click', () => document.getElementById('fileInput').click());
            uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
            uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
            uploadZone.addEventListener('drop', e => {
                e.preventDefault();
                uploadZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            document.getElementById('fileInput').addEventListener('change', e => handleFiles(e.target.files));
            document.getElementById('processBtn').addEventListener('click', processDocuments);
            document.getElementById('downloadAllBtn').addEventListener('click', downloadAll);
            document.getElementById('settingsBtn').addEventListener('click', () => openModal('settingsModal'));
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('exportBtn').addEventListener('click', () => openModal('exportModal'));

            // Watermark slider controls
            ['opacity', 'size', 'density', 'rotation'].forEach(key => {
                const slider = document.getElementById(key + 'Slider');
                if (slider) {
                    slider.addEventListener('input', () => {
                        const val = parseInt(slider.value);
                        document.getElementById(key + 'Val').textContent = key === 'rotation' ? val + '' : val + '%';
                        settings[key] = key === 'rotation' ? val : val / 100;
                        if (activeFileIndex >= 0) renderPreview();
                    });
                }
            });

            // Export slider controls
            const exportScaleSlider = document.getElementById('exportScaleSlider');
            if (exportScaleSlider) {
                exportScaleSlider.addEventListener('input', () => {
                    exportSettings.scale = parseFloat(exportScaleSlider.value);
                    document.getElementById('exportScaleVal').textContent = exportSettings.scale + 'x';
                });
            }

            const exportPaddingSlider = document.getElementById('exportPaddingSlider');
            if (exportPaddingSlider) {
                exportPaddingSlider.addEventListener('input', () => {
                    exportSettings.padding = parseInt(exportPaddingSlider.value);
                    document.getElementById('exportPaddingVal').textContent = exportSettings.padding + 'px';
                });
            }

            const exportQualitySlider = document.getElementById('exportQualitySlider');
            if (exportQualitySlider) {
                exportQualitySlider.addEventListener('input', () => {
                    exportSettings.quality = parseFloat(exportQualitySlider.value);
                    document.getElementById('exportQualityVal').textContent = Math.round(exportSettings.quality * 100) + '%';
                });
            }

            const exportWidthSlider = document.getElementById('exportWidthSlider');
            if (exportWidthSlider) {
                exportWidthSlider.addEventListener('input', () => {
                    exportSettings.width = parseInt(exportWidthSlider.value);
                    document.getElementById('exportWidthVal').textContent = exportSettings.width;
                });
            }

            const exportBgSelect = document.getElementById('exportBgSelect');
            if (exportBgSelect) {
                exportBgSelect.addEventListener('change', () => {
                    exportSettings.background = exportBgSelect.value;
                });
            }

            const exportThemeSelect = document.getElementById('exportThemeSelect');
            if (exportThemeSelect) {
                exportThemeSelect.addEventListener('change', () => {
                    exportSettings.theme = exportThemeSelect.value;
                });
            }

            // Load saved PDF compression preset
            loadPdfPreset();

            // Load saved watermark defaults
            const savedWatermark = JSON.parse(localStorage.getItem('watermark_defaults') || 'null');
            if (savedWatermark) {
                if (savedWatermark.opacity) {
                    document.getElementById('opacitySlider').value = savedWatermark.opacity * 100;
                    document.getElementById('opacityVal').textContent = Math.round(savedWatermark.opacity * 100) + '%';
                    settings.opacity = savedWatermark.opacity;
                }
                if (savedWatermark.size) {
                    document.getElementById('sizeSlider').value = savedWatermark.size * 100;
                    document.getElementById('sizeVal').textContent = Math.round(savedWatermark.size * 100) + '%';
                    settings.size = savedWatermark.size;
                }
                if (savedWatermark.density) {
                    document.getElementById('densitySlider').value = savedWatermark.density * 100;
                    document.getElementById('densityVal').textContent = Math.round(savedWatermark.density * 100) + '%';
                    settings.density = savedWatermark.density;
                }
                if (savedWatermark.rotation !== undefined) {
                    document.getElementById('rotationSlider').value = savedWatermark.rotation;
                    document.getElementById('rotationVal').textContent = savedWatermark.rotation + '';
                    settings.rotation = savedWatermark.rotation;
                }
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('vision_theme', next);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function saveSettings() {
            localStorage.setItem('gemini_key', document.getElementById('apiKeyInput').value);
            localStorage.setItem('gemini_model', document.getElementById('modelSelect').value);
            localStorage.setItem('watermark_url', document.getElementById('watermarkUrlInput').value);
            loadWatermark(document.getElementById('watermarkUrlInput').value);
            closeModal('settingsModal');
            showStatus('Settings saved!', 'success');
        }

        function saveWatermarkDefaults() {
            // Save watermark settings
            const defaults = {
                opacity: settings.opacity,
                size: settings.size,
                density: settings.density,
                rotation: settings.rotation
            };
            localStorage.setItem('watermark_defaults', JSON.stringify(defaults));

            showStatus('Defaults saved!', 'success');
        }

        function setPdfPreset(btn) {
            // No longer used - PDFs export at full quality
        }

        function loadPdfPreset() {
            // No longer used - PDFs export at full quality
        }

        function loadWatermark(url) {
            logoImage = new Image();
            logoImage.crossOrigin = 'anonymous';
            logoImage.onload = () => { if (activeFileIndex >= 0) renderPreview(); };
            logoImage.onerror = () => { console.warn('Failed to load watermark image'); };
            logoImage.src = url;
        }

        function renderPreview() {
            if (activeFileIndex < 0 || !canvas || !ctx) return;
            const file = files[activeFileIndex];
            if (!file || !file.pages || !file.pages[file.currentPage]) return;

            const img = file.pages[file.currentPage];
            if (!img || !img.width || !img.height) return;

            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // Only add watermark if logo is loaded
            if (logoImage && logoImage.complete && logoImage.naturalWidth > 0) {
                ctx.globalAlpha = settings.opacity;
                const logoW = img.width * settings.size * 1.5;
                const logoH = (logoImage.height / logoImage.width) * logoW;
                const gap = 1.5 - settings.density;
                const spaceX = logoW * gap + 80;
                const spaceY = logoH * gap + 80;
                const rad = settings.rotation * Math.PI / 180;

                for (let y = -logoH; y < img.height + logoH; y += spaceY) {
                    for (let x = -logoW; x < img.width + logoW; x += spaceX) {
                        ctx.save();
                        ctx.translate(x + logoW/2, y + logoH/2);
                        ctx.rotate(rad);
                        ctx.drawImage(logoImage, -logoW/2, -logoH/2, logoW, logoH);
                        ctx.restore();
                    }
                }
                ctx.globalAlpha = 1;
            }
        }

        function togglePreviewSize() {
            const container = document.getElementById('previewContainer');
            const overlay = document.getElementById('previewOverlay');
            container.classList.toggle('expanded');
            overlay.classList.toggle('visible');
        }

        function selectFile(idx) {
            activeFileIndex = idx;
            const file = files[idx];
            if (!file) return;
            if (file.currentPage === undefined) file.currentPage = 0;
            document.getElementById('watermarkPlaceholder').style.display = 'none';
            canvas.style.display = 'block';
            updateFileList();
            renderPreview();
        }

        function downloadAll() {
            if (files.length === 0) return;
            if (!logoImage || !logoImage.complete) {
                showStatus('Watermark image not loaded. Check settings.', 'error');
                return;
            }

            // Build download list
            const list = document.getElementById('downloadFileList');
            list.innerHTML = files.map((f, i) => {
                const baseName = f.outputName || f.name.replace(/\.[^.]+$/, '');
                const ext = f.pages.length === 1 ? '.png' : '.pdf';
                return `
                    <div class="download-file-item">
                        <img src="${f.thumb}" alt="">
                        <input type="text" id="downloadName_${i}" value="${baseName}_watermarked">
                        <span class="file-ext">${ext}</span>
                    </div>
                `;
            }).join('');

            openModal('downloadModal');
        }

        async function executeDownload() {
            closeModal('downloadModal');
            showStatus('Preparing watermarked downloads...', 'info');

            // Get watermark image as PNG bytes for pdf-lib
            let watermarkPngBytes = null;
            if (logoImage && logoImage.complete && logoImage.naturalWidth > 0) {
                try {
                    const wmCanvas = document.createElement('canvas');
                    wmCanvas.width = logoImage.naturalWidth;
                    wmCanvas.height = logoImage.naturalHeight;
                    const wmCtx = wmCanvas.getContext('2d');
                    wmCtx.drawImage(logoImage, 0, 0);
                    const dataUrl = wmCanvas.toDataURL('image/png');
                    const base64 = dataUrl.split(',')[1];
                    watermarkPngBytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                } catch (e) {
                    console.error('Error creating watermark bytes:', e);
                }
            }

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const nameInput = document.getElementById(`downloadName_${i}`);
                const safeLabel = (nameInput?.value || file.name.replace(/\.[^.]+$/, '')).replace(/[^a-z0-9_\-\s]/gi, '_');

                if (file.isPdf && file.originalPdfBytes && watermarkPngBytes) {
                    // Use pdf-lib to overlay watermark on original PDF (preserves vector content)
                    try {
                        const { PDFDocument } = PDFLib;
                        const pdfDoc = await PDFDocument.load(file.originalPdfBytes.slice(0));
                        const watermarkImage = await pdfDoc.embedPng(watermarkPngBytes);
                        const pages = pdfDoc.getPages();

                        for (const page of pages) {
                            const { width, height } = page.getSize();
                            const wmWidth = watermarkImage.width;
                            const wmHeight = watermarkImage.height;

                            // Calculate watermark size based on settings
                            const baseSize = Math.min(width, height) * (settings.size / 100) * 0.5;
                            const wmScale = baseSize / Math.max(wmWidth, wmHeight);
                            const drawWidth = wmWidth * wmScale;
                            const drawHeight = wmHeight * wmScale;

                            // Calculate spacing based on density - ensure minimum spacing
                            const spacing = Math.max(50, Math.max(drawWidth, drawHeight) * (2.5 - settings.density / 50));

                            // Draw tiled watermarks
                            for (let y = 0; y < height; y += spacing) {
                                for (let x = 0; x < width; x += spacing) {
                                    page.drawImage(watermarkImage, {
                                        x: x,
                                        y: y,
                                        width: drawWidth,
                                        height: drawHeight,
                                        opacity: settings.opacity / 100,
                                        rotate: PDFLib.degrees(-settings.rotation)
                                    });
                                }
                            }
                        }

                        const pdfBytes = await pdfDoc.save();
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `${safeLabel}.pdf`;
                        link.click();
                        URL.revokeObjectURL(link.href);
                        showStatus('Download complete!', 'success');
                    } catch (err) {
                        console.error('pdf-lib error:', err);
                        showStatus('Error processing PDF: ' + err.message, 'error');
                    }
                } else if (file.pages.length === 1) {
                    // Single image - download as PNG with watermark
                    activeFileIndex = i;
                    file.currentPage = 0;
                    renderPreview();
                    await new Promise(r => setTimeout(r, 150));

                    const link = document.createElement('a');
                    link.download = `${safeLabel}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } else {
                    // Multi-page non-PDF (shouldn't happen, but fallback to jsPDF)
                    const { jsPDF } = window.jspdf;
                    file.currentPage = 0;
                    activeFileIndex = i;
                    renderPreview();
                    await new Promise(r => setTimeout(r, 150));

                    const pdf = new jsPDF({ orientation: canvas.width > canvas.height ? 'landscape' : 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(canvas.toDataURL('image/jpeg', 0.85), 'JPEG', 0, 0, canvas.width, canvas.height);

                    for (let p = 1; p < file.pages.length; p++) {
                        file.currentPage = p;
                        renderPreview();
                        await new Promise(r => setTimeout(r, 150));
                        pdf.addPage([canvas.width, canvas.height]);
                        pdf.addImage(canvas.toDataURL('image/jpeg', 0.85), 'JPEG', 0, 0, canvas.width, canvas.height);
                    }
                    pdf.save(`${safeLabel}.pdf`);
                }
                await new Promise(r => setTimeout(r, 300));
            }
            showStatus('Downloads complete!', 'success');
        }

        // Export Menu Functions
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.export-menu-container');
            const dropdown = document.getElementById('exportDropdown');
            if (container && dropdown && !container.contains(e.target)) {
                dropdown.classList.remove('show');
            }

            // Handle clickable cells in the data table
            const cell = e.target.closest('.clickable-cell');
            if (cell) {
                const monthIndex = parseInt(cell.dataset.month);
                const field = cell.dataset.field;
                if (!isNaN(monthIndex) && field) {
                    showCellDetail(monthIndex, field);
                }
            }
        });

        async function exportMethod(method) {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.remove('show');

            if (!extractedData.full_analysis) {
                showStatus('No analysis data to export', 'error');
                return;
            }

            switch(method) {
                case 'png-clean':
                    await exportPngIframe(); // Use iframe for consistent light theme rendering
                    break;
                case 'png-iframe':
                    await exportPngIframe();
                    break;
                case 'png-native':
                    await exportPngNative();
                    break;
                case 'pdf':
                    await exportPdf();
                    break;
                case 'print':
                    exportPrint();
                    break;
                case 'json':
                    exportJson();
                    break;
                case 'csv':
                    exportCsv();
                    break;
                case 'clipboard':
                    await exportClipboard();
                    break;
            }
        }

        // Create branded export header
        function createExportHeader(isDark = false) {
            const businessName = extractedBusinessInfo.name || 'Business Analysis';
            const ownerName = extractedBusinessInfo.owner || '';
            const exportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px 24px;
                margin-bottom: 20px;
                background: ${isDark ? '#1a1a1a' : '#f8fafc'};
                border: 1px solid ${isDark ? '#333' : '#e2e8f0'};
                border-radius: 12px;
            `;

            header.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; position: relative;">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <ellipse cx="50" cy="50" rx="35" ry="12" fill="none" stroke="#eab308" stroke-width="4" transform="rotate(-20 50 50)"/>
                            <circle cx="50" cy="50" r="18" fill="#f97316"/>
                            <ellipse cx="50" cy="50" rx="42" ry="8" fill="none" stroke="#eab308" stroke-width="2" transform="rotate(-20 50 50)" opacity="0.5"/>
                        </svg>
                    </div>
                    <div>
                        <div style="font-size: 18px; font-weight: 700; color: ${isDark ? '#ffffff' : '#111827'};">Vision Pro</div>
                        <div style="font-size: 11px; color: ${isDark ? '#9ca3af' : '#6b7280'}; text-transform: uppercase; letter-spacing: 0.5px;">Bank Statement Analysis</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 16px; font-weight: 600; color: ${isDark ? '#ffffff' : '#111827'};">${businessName}</div>
                    ${ownerName ? `<div style="font-size: 13px; color: ${isDark ? '#9ca3af' : '#6b7280'};">${ownerName}</div>` : ''}
                    <div style="font-size: 12px; color: ${isDark ? '#6b7280' : '#9ca3af'}; margin-top: 4px;">${exportDate}</div>
                </div>
            `;

            return header;
        }

        // Create export footer
        function createExportFooter(isDark = false) {
            const footer = document.createElement('div');
            footer.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 24px;
                margin-top: 20px;
                background: ${isDark ? '#1a1a1a' : '#f8fafc'};
                border: 1px solid ${isDark ? '#333' : '#e2e8f0'};
                border-radius: 12px;
                font-size: 11px;
                color: ${isDark ? '#6b7280' : '#9ca3af'};
            `;

            footer.innerHTML = `
                <div>Generated by Vision Pro  ables.ai</div>
                <div>Confidential - For Internal Use Only</div>
            `;

            return footer;
        }

        // Generate completely fresh export HTML with hardcoded light styles
        function generateExportHTML(options) {
            const analysis = extractedData.full_analysis;
            const agg = analysis.aggregated || {};
            const months = analysis.months || [];
            const mcaLenders = agg.detected_mca_lenders || [];
            const flags = analysis.red_flags || [];

            // Calculate totals
            const totals = months.reduce((acc, m) => ({
                deposits: acc.deposits + (m.total_deposits || 0),
                trueRevenue: acc.trueRevenue + (m.true_revenue || m.total_deposits * 0.92 || 0),
                withdrawals: acc.withdrawals + (m.total_withdrawals || 0),
                numDeps: acc.numDeps + (m.num_deposits || 0),
                nsf: acc.nsf + (m.nsf_count || 0),
                negDays: acc.negDays + (m.days_negative || 0),
                avgBalSum: acc.avgBalSum + (m.average_daily_balance || 0)
            }), { deposits: 0, trueRevenue: 0, withdrawals: 0, numDeps: 0, nsf: 0, negDays: 0, avgBalSum: 0 });

            const numMonths = months.length || 1;
            const avgBalance = Math.round(totals.avgBalSum / numMonths);

            const businessName = extractedBusinessInfo.name || 'Bank Analysis';
            const dateStr = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

            let html = `
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; background: #000000; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <svg viewBox="0 0 64 64" fill="none" style="width: 40px; height: 40px;">
                            <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                            <circle cx="32" cy="32" r="12" fill="#eab308"/>
                            <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
                        </svg>
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: #ffffff;">Vision PRO</div>
                            <div style="font-size: 12px; color: #94a3b8;">Bank Statement Analysis</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 14px; font-weight: 600; color: #ffffff;">${businessName}</div>
                        <div style="font-size: 12px; color: #94a3b8;">${dateStr}</div>
                    </div>
                </div>
            `;

            // Fraud Analysis Section
            if (options.includeFraud && files.length > 0) {
                const clean = files.filter(f => f.status === 'clean').length;
                const warning = files.filter(f => f.status === 'warning').length;
                const danger = files.filter(f => f.status === 'danger').length;
                const overallColor = danger > 0 ? '#ef4444' : warning > 0 ? '#f59e0b' : '#22c55e';
                const overallText = danger > 0 ? 'Issues Detected' : warning > 0 ? 'Review Required' : 'All Clear';

                html += `
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 64 64" fill="none" style="width: 24px; height: 24px;">
                                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                            </svg>
                            <span style="font-weight: 600; font-size: 14px; color: #111827;">Fraud Analysis</span>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 20px; font-weight: 700; color: #22c55e;">${clean}</span>
                                    <span style="font-size: 12px; color: #6b7280;">Clean</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 20px; font-weight: 700; color: #f59e0b;">${warning}</span>
                                    <span style="font-size: 12px; color: #6b7280;">Review</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <span style="font-size: 20px; font-weight: 700; color: #ef4444;">${danger}</span>
                                    <span style="font-size: 12px; color: #6b7280;">Risk</span>
                                </div>
                                <div style="flex: 1;"></div>
                                <div style="padding: 6px 12px; background: ${overallColor}15; border-radius: 20px; font-size: 12px; font-weight: 600; color: ${overallColor};">${overallText}</div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; max-width: 700px; margin: 0 auto;">
                                ${files.map(f => {
                                    const statusText = f.status === 'danger' ? 'HIGH RISK' : f.status === 'warning' ? 'REVIEW' : 'CLEAN';
                                    const borderColor = f.status === 'danger' ? '#ef4444' : f.status === 'warning' ? '#f59e0b' : '#22c55e';
                                    const bgColor = f.status === 'danger' ? '#fef2f2' : f.status === 'warning' ? '#fffbeb' : '#f0fdf4';
                                    const textColor = f.status === 'danger' ? '#991b1b' : f.status === 'warning' ? '#92400e' : '#166534';
                                    const shortName = f.name.length > 30 ? f.name.substring(0, 27) + '...' : f.name;
                                    return `
                                        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-left: 3px solid ${borderColor}; border-radius: 8px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="font-size: 13px; font-weight: 600; color: #111827;">${shortName}</div>
                                                <div style="padding: 3px 8px; background: ${bgColor}; color: ${textColor}; border-radius: 10px; font-size: 10px; font-weight: 600;">${statusText}</div>
                                            </div>
                                            <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${f.pages?.length || 0} page(s) analyzed</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Bank Analysis Section
            if (options.includeData) {
                html += `
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 64 64" fill="none" style="width: 24px; height: 24px;">
                                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                            </svg>
                            <span style="font-weight: 600; font-size: 14px; color: #111827;">Bank Analysis Worksheet</span>
                        </div>
                        <div style="padding: 20px;">
                            <!-- Risk Summary -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                                <div style="background: ${totals.nsf === 0 ? '#f0fdf4' : totals.nsf <= 3 ? '#fffbeb' : '#fef2f2'}; border: 2px solid ${totals.nsf === 0 ? '#22c55e' : totals.nsf <= 3 ? '#f59e0b' : '#ef4444'}; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: ${totals.nsf === 0 ? '#166534' : totals.nsf <= 3 ? '#92400e' : '#991b1b'};">${totals.nsf}</div>
                                    <div style="font-size: 11px; color: #6b7280;">NSF ITEMS</div>
                                </div>
                                <div style="background: ${totals.negDays === 0 ? '#f0fdf4' : totals.negDays <= 5 ? '#fffbeb' : '#fef2f2'}; border: 2px solid ${totals.negDays === 0 ? '#22c55e' : totals.negDays <= 5 ? '#f59e0b' : '#ef4444'}; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: ${totals.negDays === 0 ? '#166534' : totals.negDays <= 5 ? '#92400e' : '#991b1b'};">${totals.negDays}</div>
                                    <div style="font-size: 11px; color: #6b7280;">NEG DAYS</div>
                                </div>
                                <div style="background: ${mcaLenders.length === 0 ? '#f0fdf4' : mcaLenders.length <= 2 ? '#fffbeb' : '#fef2f2'}; border: 2px solid ${mcaLenders.length === 0 ? '#22c55e' : mcaLenders.length <= 2 ? '#f59e0b' : '#ef4444'}; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: ${mcaLenders.length === 0 ? '#166534' : mcaLenders.length <= 2 ? '#92400e' : '#991b1b'};">${mcaLenders.length}</div>
                                    <div style="font-size: 11px; color: #6b7280;">MCA FOUND</div>
                                </div>
                                <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 700; color: #111827;">${Math.round(totals.numDeps / numMonths)}</div>
                                    <div style="font-size: 11px; color: #6b7280;">DEPS/MONTH</div>
                                </div>
                            </div>

                            <!-- Monthly Table -->
                            ${months.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Month</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Deposits</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">True Rev</th>
                                        <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">#</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Withdrawals</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Avg Bal</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Open Bal</th>
                                        <th style="padding: 12px; text-align: right; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">End Bal</th>
                                        <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">NSF</th>
                                        <th style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Neg</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${months.map(m => `
                                        <tr>
                                            <td style="padding: 12px; font-size: 13px; font-weight: 500; color: #111827; border-bottom: 1px solid #f3f4f6;">${m.month || 'N/A'}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #16a34a; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(m.total_deposits || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #ca8a04; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(m.true_revenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #374151; text-align: center; border-bottom: 1px solid #f3f4f6;">${m.num_deposits || 0}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #dc2626; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(m.total_withdrawals || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 12px; font-size: 13px; color: #374151; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(m.average_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 12px; font-size: 13px; color: ${(m.opening_balance || 0) < 0 ? '#dc2626' : '#374151'}; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(m.opening_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 12px; font-size: 13px; color: ${(m.ending_balance || 0) < 0 ? '#dc2626' : '#374151'}; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(m.ending_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 12px; font-size: 13px; color: ${(m.nsf_count || 0) > 0 ? '#dc2626' : '#374151'}; text-align: center; border-bottom: 1px solid #f3f4f6;">${m.nsf_count || 0}</td>
                                            <td style="padding: 12px; font-size: 13px; color: ${(m.days_negative || 0) > 0 ? '#dc2626' : '#374151'}; text-align: center; border-bottom: 1px solid #f3f4f6;">${m.days_negative || 0}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f8fafc;">
                                        <td style="padding: 12px; font-size: 13px; font-weight: 700; color: #111827;">AVERAGE</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #16a34a; text-align: right;">$${(totals.deposits / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #ca8a04; text-align: right;">$${(totals.trueRevenue / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #374151; text-align: center;">${Math.round(totals.numDeps / numMonths)}</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #dc2626; text-align: right;">$${(totals.withdrawals / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #374151; text-align: right;">$${avgBalance.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td style="padding: 12px; font-size: 13px; color: #6b7280; text-align: right;">-</td>
                                        <td style="padding: 12px; font-size: 13px; color: #6b7280; text-align: right;">-</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #374151; text-align: center;">${totals.nsf}</td>
                                        <td style="padding: 12px; font-size: 13px; font-weight: 600; color: #374151; text-align: center;">${totals.negDays}</td>
                                    </tr>
                                </tfoot>
                            </table>
                            ` : ''}

                            ${mcaLenders.length > 0 ? `
                            <div style="margin-top: 20px; background: #fef2f2; border: 2px solid #ef4444; border-radius: 8px; padding: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="width: 32px; height: 32px; background: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">!</div>
                                    <div>
                                        <div style="font-size: 14px; font-weight: 700; color: #991b1b;">EXISTING MCA POSITIONS DETECTED</div>
                                        <div style="font-size: 12px; color: #b91c1c;">Active merchant cash advance obligations identified</div>
                                    </div>
                                    <div style="margin-left: auto; background: #ef4444; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${mcaLenders.length} Lender${mcaLenders.length > 1 ? 's' : ''}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    ${mcaLenders.map(l => {
                                        const name = typeof l === 'object' ? (l.name || 'Unknown Lender') : l;
                                        return `<div style="background: #ffffff; border: 1px solid #fecaca; border-radius: 6px; padding: 10px 12px; font-size: 13px; font-weight: 500; color: #991b1b;">${name}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Cash Flow Analysis Section (charts are not exportable to static HTML, show summary instead)
            if (options.includeCharts && months.length > 0) {
                const avgDeposits = totals.deposits / numMonths;
                const avgWithdrawals = totals.withdrawals / numMonths;
                const cashFlow = avgDeposits - avgWithdrawals;

                html += `
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 64 64" fill="none" style="width: 24px; height: 24px;">
                                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                            </svg>
                            <span style="font-weight: 600; font-size: 14px; color: #111827;">Cash Flow Analysis</span>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #16a34a;">$${avgDeposits.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">AVG MONTHLY DEPOSITS</div>
                                </div>
                                <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #dc2626;">$${avgWithdrawals.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">AVG MONTHLY WITHDRAWALS</div>
                                </div>
                                <div style="background: ${cashFlow >= 0 ? '#f0fdf4' : '#fef2f2'}; border: 1px solid ${cashFlow >= 0 ? '#22c55e' : '#ef4444'}; border-radius: 8px; padding: 16px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: ${cashFlow >= 0 ? '#16a34a' : '#dc2626'};">${cashFlow >= 0 ? '+' : ''}$${cashFlow.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">NET CASH FLOW</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Credit Engine Section
            if (options.includeScore && extractedData.credit_score) {
                const cs = extractedData.credit_score;
                const tierColors = {
                    A: '#10b981', B: '#22c55e', C: '#eab308', D: '#f97316', E: '#ef4444'
                };
                const tierBg = {
                    A: '#d1fae5', B: '#dcfce7', C: '#fef9c3', D: '#ffedd5', E: '#fee2e2'
                };
                const color = tierColors[cs.tier] || '#6b7280';

                const getScoreBarColor = (pct) => {
                    if (pct >= 70) return '#10b981';
                    if (pct >= 40) return '#eab308';
                    return '#ef4444';
                };

                html += `
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="background: #f8fafc; padding: 12px 20px; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-size: 10px; font-weight: 800; letter-spacing: 0.15em; color: #6b7280;">ABLESAI CREDIT ENGINE</div>
                            <div style="font-size: 9px; color: #9ca3af;">V4.2</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 180px 1fr;">
                            <div style="padding: 24px; border-right: 1px solid #e5e7eb; text-align: center; background: ${color}10;">
                                <div style="font-size: 48px; font-weight: 800; color: ${color}; line-height: 1;">${cs.total}<span style="font-size: 18px; color: #6b7280;">/100</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px;">
                                    <span style="font-size: 24px; font-weight: 800; color: ${color};">${cs.tier}</span>
                                    <span style="font-size: 11px; font-weight: 600; color: #374151; text-transform: uppercase;">${cs.label}</span>
                                </div>
                            </div>
                            <div style="padding: 20px;">
                                <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; margin-bottom: 12px;">Score Breakdown</div>
                                ${[
                                    { label: 'Credit Score', pts: cs.components.credit, max: 20 },
                                    { label: `Behavior (${cs.inputs.avgNsf + cs.inputs.avgNegDays})`, pts: cs.components.behavior, max: 15 },
                                    { label: 'Revenue', pts: cs.components.revenue, max: 30 },
                                    { label: 'Stability', pts: cs.components.stability, max: 20 },
                                    { label: `Buffer (${cs.inputs.bufferRatio}%)`, pts: cs.components.buffer, max: 15 }
                                ].map(item => {
                                    const pct = (item.pts / item.max) * 100;
                                    const barColor = getScoreBarColor(pct);
                                    return `
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${barColor};"></div>
                                            <span style="font-size: 12px; font-weight: 600; color: #374151; min-width: 90px;">${item.label}</span>
                                            <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                                <div style="width: ${pct}%; height: 100%; background: ${barColor}; border-radius: 3px;"></div>
                                            </div>
                                            <span style="font-size: 12px; font-weight: 700; min-width: 40px; text-align: right;">${item.pts}/${item.max}</span>
                                        </div>
                                    `;
                                }).join('')}
                                <div style="display: flex; gap: 4px; margin-top: 16px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="flex: 1; padding: 6px; background: #fee2e2; color: #dc2626; text-align: center; border-radius: 4px; font-size: 9px; font-weight: 700; ${cs.tier === 'E' ? 'box-shadow: 0 2px 6px rgba(0,0,0,0.15);' : ''}">E &lt;35</div>
                                    <div style="flex: 1; padding: 6px; background: #ffedd5; color: #ea580c; text-align: center; border-radius: 4px; font-size: 9px; font-weight: 700; ${cs.tier === 'D' ? 'box-shadow: 0 2px 6px rgba(0,0,0,0.15);' : ''}">D 35+</div>
                                    <div style="flex: 1; padding: 6px; background: #fef9c3; color: #ca8a04; text-align: center; border-radius: 4px; font-size: 9px; font-weight: 700; ${cs.tier === 'C' ? 'box-shadow: 0 2px 6px rgba(0,0,0,0.15);' : ''}">C 50+</div>
                                    <div style="flex: 1; padding: 6px; background: #dcfce7; color: #16a34a; text-align: center; border-radius: 4px; font-size: 9px; font-weight: 700; ${cs.tier === 'B' ? 'box-shadow: 0 2px 6px rgba(0,0,0,0.15);' : ''}">B 65+</div>
                                    <div style="flex: 1; padding: 6px; background: #d1fae5; color: #059669; text-align: center; border-radius: 4px; font-size: 9px; font-weight: 700; ${cs.tier === 'A' ? 'box-shadow: 0 2px 6px rgba(0,0,0,0.15);' : ''}">A 80+</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Existing Debt Section
            if (options.includeDebt && existingDebt && existingDebt.length > 0) {
                const debts = existingDebt.filter(d => d.creditor_name && d.payment_amount > 0);
                if (debts.length > 0) {
                    const totalMonthly = debts.reduce((sum, d) => sum + (d.payment_amount || 0), 0);

                    html += `
                        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <svg viewBox="0 0 64 64" fill="none" style="width: 24px; height: 24px;">
                                        <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                                        <circle cx="32" cy="32" r="12" fill="#eab308"/>
                                    </svg>
                                    <span style="font-weight: 600; font-size: 14px; color: #111827;">Existing Debt Obligations</span>
                                </div>
                                <div style="background: #fef2f2; color: #dc2626; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">$${totalMonthly.toLocaleString()}/mo</div>
                            </div>
                            <div style="padding: 20px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc;">
                                            <th style="padding: 10px; text-align: left; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb;">CREDITOR</th>
                                            <th style="padding: 10px; text-align: center; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb;">TYPE</th>
                                            <th style="padding: 10px; text-align: right; font-size: 11px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb;">PAYMENT</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${debts.map(d => `
                                            <tr>
                                                <td style="padding: 10px; font-size: 13px; color: #111827; border-bottom: 1px solid #f3f4f6;">${d.creditor_name}</td>
                                                <td style="padding: 10px; font-size: 12px; color: #6b7280; text-align: center; border-bottom: 1px solid #f3f4f6;">${d.debt_type || 'MCA'}</td>
                                                <td style="padding: 10px; font-size: 13px; font-weight: 600; color: #dc2626; text-align: right; border-bottom: 1px solid #f3f4f6;">$${(d.payment_amount || 0).toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }

            // Background Research Section
            if (options.includeResearch && Object.keys(researchResults).length > 0) {
                const lowRisk = Object.values(researchResults).filter(r => r.risk === 'low').length;
                const medRisk = Object.values(researchResults).filter(r => r.risk === 'medium').length;
                const highRisk = Object.values(researchResults).filter(r => r.risk === 'high').length;
                const totalFlags = Object.values(researchResults).reduce((sum, r) => sum + (r.flags?.length || 0), 0);

                html += `
                    <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 10px;">
                            <svg viewBox="0 0 64 64" fill="none" style="width: 24px; height: 24px;">
                                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                            </svg>
                            <span style="font-weight: 600; font-size: 14px; color: #111827;">Background Research: ${businessName}</span>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                                <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 12px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #16a34a;">${lowRisk}</div>
                                    <div style="font-size: 10px; color: #6b7280;">LOW RISK</div>
                                </div>
                                <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #d97706;">${medRisk}</div>
                                    <div style="font-size: 10px; color: #6b7280;">MEDIUM RISK</div>
                                </div>
                                <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 12px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #dc2626;">${highRisk}</div>
                                    <div style="font-size: 10px; color: #6b7280;">HIGH RISK</div>
                                </div>
                                <div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; text-align: center;">
                                    <div style="font-size: 24px; font-weight: 700; color: #111827;">${totalFlags}</div>
                                    <div style="font-size: 10px; color: #6b7280;">RED FLAGS</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                ${Object.entries(researchResults).map(([id, result]) => {
                                    const moduleNames = {
                                        sos: 'Secretary of State', ucc: 'UCC Filings', tax: 'Tax Liens',
                                        judgment: 'Judgments', bankruptcy: 'Bankruptcy', bbb: 'BBB Profile',
                                        reviews: 'Online Reviews', news: 'News & Press', social: 'Social Media',
                                        industry: 'Industry Analysis', owner: 'Owner Background', location: 'Location Analysis'
                                    };
                                    const riskColors = { low: '#22c55e', medium: '#f59e0b', high: '#ef4444', unknown: '#6b7280' };
                                    const riskBg = { low: '#f0fdf4', medium: '#fffbeb', high: '#fef2f2', unknown: '#f8fafc' };
                                    return `
                                        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-left: 3px solid ${riskColors[result.risk] || '#6b7280'}; border-radius: 6px; padding: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                                <span style="font-size: 12px; font-weight: 600; color: #111827;">${moduleNames[id] || id}</span>
                                                <span style="font-size: 10px; padding: 2px 8px; background: ${riskBg[result.risk] || '#f8fafc'}; color: ${riskColors[result.risk] || '#6b7280'}; border-radius: 10px; font-weight: 500;">${(result.risk || 'unknown').toUpperCase()}</span>
                                            </div>
                                            <div style="font-size: 11px; color: #6b7280; line-height: 1.4;">${result.summary || 'No data'}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Lender Matching Section
            if (options.includeLenders && matchedLenders && matchedLenders.length > 0) {
                const topLenders = matchedLenders.filter(l => l.score >= 50).slice(0, 6);
                if (topLenders.length > 0) {
                    html += `
                        <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="background: #f8fafc; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 10px;">
                                <svg viewBox="0 0 64 64" fill="none" style="width: 24px; height: 24px;">
                                    <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                                    <circle cx="32" cy="32" r="12" fill="#eab308"/>
                                </svg>
                                <span style="font-weight: 600; font-size: 14px; color: #111827;">Lender Matching</span>
                            </div>
                            <div style="padding: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    ${topLenders.map(l => {
                                        const scoreColor = l.score >= 80 ? '#22c55e' : l.score >= 60 ? '#f59e0b' : '#ef4444';
                                        return `
                                            <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                    <span style="font-size: 14px; font-weight: 600; color: #111827;">${l.name}</span>
                                                    <span style="font-size: 16px; font-weight: 700; color: ${scoreColor};">${l.score}%</span>
                                                </div>
                                                <div style="height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                                    <div style="width: ${l.score}%; height: 100%; background: ${scoreColor};"></div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Footer
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 11px; color: #6b7280;">
                    <div>Generated by Vision PRO  ables.ai</div>
                    <div>Confidential - For Internal Use Only</div>
                </div>
            `;

            return html;
        }

        // Export with custom settings from modal - IFRAME approach for proper isolation
        async function exportWithSettings(format = 'png') {
            if (!extractedData.full_analysis) {
                showStatus('No analysis data to export', 'error');
                return;
            }

            showStatus(`Generating ${format.toUpperCase()}...`, 'info');

            try {
                // Get selected sections
                const includeFraud = document.getElementById('exportFraud')?.checked ?? true;
                const includeData = document.getElementById('exportData')?.checked ?? true;
                const includeCharts = document.getElementById('exportCharts')?.checked ?? true;
                const includeScore = document.getElementById('exportScore')?.checked ?? true;
                const includeDebt = document.getElementById('exportDebt')?.checked ?? true;
                const includeResearch = document.getElementById('exportResearch')?.checked ?? true;
                const includeLenders = document.getElementById('exportLenders')?.checked ?? true;

                // Generate completely fresh HTML with hardcoded light styles
                const exportHTML = generateExportHTML({
                    includeFraud, includeData, includeCharts, includeScore, includeDebt, includeResearch, includeLenders
                });

                // Create overlay to hide from user
                const overlay = document.createElement('div');
                overlay.id = 'exportSettingsOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.9);
                    z-index: 99998;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    font-family: 'Inter', sans-serif;
                `;
                overlay.innerHTML = '<div style="text-align: center;"><div style="margin-bottom: 12px;">Generating export...</div><div style="font-size: 14px; opacity: 0.7;">Please wait</div></div>';

                // Create iframe for complete style isolation
                const iframe = document.createElement('iframe');
                iframe.id = 'exportSettingsIframe';
                iframe.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: ${exportSettings.width + exportSettings.padding * 2}px;
                    height: 100vh;
                    border: none;
                    z-index: 99999;
                    background: white;
                `;

                document.body.appendChild(overlay);
                document.body.appendChild(iframe);

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Write complete self-contained HTML - NO CSS VARIABLES
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                                background: #ffffff;
                                color: #111827;
                                padding: ${exportSettings.padding}px;
                                line-height: 1.5;
                            }
                        </style>
                    </head>
                    <body>${exportHTML}</body>
                    </html>
                `);
                iframeDoc.close();

                // Wait for fonts and content to load
                await new Promise(r => setTimeout(r, 800));

                const canvas = await html2canvas(iframeDoc.body, {
                    scale: exportSettings.scale,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    width: exportSettings.width,
                    windowWidth: exportSettings.width + exportSettings.padding * 2
                });

                document.body.removeChild(iframe);
                document.body.removeChild(overlay);

                if (format === 'pdf') {
                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const pdfWidth = 612;
                    const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
                    const maxPageHeight = 792;

                    if (pdfHeight <= maxPageHeight) {
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] });
                        pdf.addImage(canvas.toDataURL('image/png', exportSettings.quality), 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(getFilename('pdf'));
                    } else {
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                        const pageHeightInCanvasPixels = (maxPageHeight * imgWidth) / pdfWidth;
                        let position = 0;
                        let pageNum = 0;

                        while (position < imgHeight) {
                            if (pageNum > 0) pdf.addPage();

                            const pageCanvas = document.createElement('canvas');
                            pageCanvas.width = imgWidth;
                            pageCanvas.height = Math.min(pageHeightInCanvasPixels, imgHeight - position);
                            const ctx = pageCanvas.getContext('2d');
                            ctx.drawImage(canvas, 0, position, imgWidth, pageCanvas.height, 0, 0, imgWidth, pageCanvas.height);

                            const scaledHeight = (pageCanvas.height * pdfWidth) / imgWidth;
                            pdf.addImage(pageCanvas.toDataURL('image/png', exportSettings.quality), 'PNG', 0, 0, pdfWidth, scaledHeight);

                            position += pageHeightInCanvasPixels;
                            pageNum++;
                        }

                        pdf.save(getFilename('pdf'));
                    }
                    showStatus('PDF exported!', 'success');
                } else {
                    // PNG download
                    const link = document.createElement('a');
                    link.download = getFilename('png');
                    link.href = canvas.toDataURL('image/png', exportSettings.quality);
                    link.click();
                    showStatus('PNG exported!', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Nuclear option - force ALL elements to light styles
        function forceAllLightStyles(clone) {
            // Set wrapper background explicitly
            clone.style.background = '#ffffff';
            clone.style.backgroundColor = '#ffffff';
            clone.style.color = '#111827';

            // First, iterate through ALL elements and force light colors
            clone.querySelectorAll('*').forEach(el => {
                const style = el.style;
                const computed = window.getComputedStyle(el);
                const tagName = el.tagName.toLowerCase();

                // Force background colors - check actual computed value
                const bg = computed.backgroundColor;
                if (bg && bg !== 'rgba(0, 0, 0, 0)' && bg !== 'transparent') {
                    const rgb = bg.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        // If dark background (r,g,b all below threshold), make it white/light
                        if (r < 50 && g < 50 && b < 50) {
                            style.setProperty('background-color', '#ffffff', 'important');
                            style.setProperty('background', '#ffffff', 'important');
                        } else if (r < 100 && g < 100 && b < 100) {
                            style.setProperty('background-color', '#f9fafb', 'important');
                            style.setProperty('background', '#f9fafb', 'important');
                        }
                    }
                }

                // Force text colors - be very aggressive
                const color = computed.color;
                if (color) {
                    const rgb = color.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        // Any gray text above 100 becomes dark
                        // This catches light grays like #a1a1aa (161, 161, 170)
                        if (r > 100 && g > 100 && b > 100 && r < 200 && g < 200 && b < 200) {
                            // Gray text - make it medium gray for contrast
                            style.setProperty('color', '#4b5563', 'important');
                        } else if (r > 200 && g > 200 && b > 200) {
                            // White/near-white text - make it dark
                            style.setProperty('color', '#111827', 'important');
                        }
                    }
                }

                // Force ALL text elements to have dark text
                if (['span', 'p', 'div', 'td', 'th', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'label', 'li'].includes(tagName)) {
                    const currentColor = computed.color;
                    const rgb = currentColor?.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        // If not already dark (less than 100), force dark
                        if (r > 80 || g > 80 || b > 80) {
                            // Check if it's a colored text (green, red, etc) - preserve those
                            const isGray = Math.abs(r - g) < 30 && Math.abs(g - b) < 30;
                            if (isGray && r > 100) {
                                style.setProperty('color', '#374151', 'important');
                            }
                        }
                    }
                }

                // Force border colors
                const borderColor = computed.borderColor;
                if (borderColor && borderColor.includes('rgb')) {
                    const rgb = borderColor.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        const [r, g, b] = rgb.map(Number);
                        if (r < 80 && g < 80 && b < 80) {
                            style.setProperty('border-color', '#d1d5db', 'important');
                        }
                    }
                }
            });

            // Now apply specific component styles
            applyExportLightStyles(clone);
        }

        // Helper function to apply light styles
        function applyExportLightStyles(clone) {
            // Style section cards
            clone.querySelectorAll('.section-card').forEach(card => {
                card.style.cssText = 'background: #ffffff !important; border: 1px solid #d1d5db !important; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);';
            });

            clone.querySelectorAll('.section-header').forEach(header => {
                header.style.cssText = 'background: #f3f4f6 !important; color: #111827 !important; padding: 16px 20px; border-bottom: 1px solid #d1d5db !important; font-weight: 600; font-size: 14px;';
            });

            clone.querySelectorAll('.section-body').forEach(body => {
                body.style.cssText = 'background: #ffffff !important; padding: 20px; color: #111827 !important;';
            });

            // Data cards
            clone.querySelectorAll('.data-card').forEach(card => {
                const borderStyle = card.getAttribute('style') || '';
                let borderColor = '#d1d5db', bgColor = '#f9fafb';
                if (borderStyle.includes('green')) { borderColor = '#22c55e'; bgColor = '#dcfce7'; }
                else if (borderStyle.includes('yellow')) { borderColor = '#eab308'; bgColor = '#fef9c3'; }
                else if (borderStyle.includes('red')) { borderColor = '#ef4444'; bgColor = '#fee2e2'; }
                card.style.cssText = `background: ${bgColor} !important; border: 2px solid ${borderColor} !important; border-radius: 8px; padding: 16px; text-align: center;`;
            });

            // Data values
            clone.querySelectorAll('.data-label').forEach(l => l.style.cssText = 'font-size: 11px; color: #6b7280 !important;');
            clone.querySelectorAll('.data-value').forEach(val => {
                let color = '#111827';
                if (val.classList.contains('green')) color = '#16a34a';
                if (val.classList.contains('red')) color = '#dc2626';
                if (val.classList.contains('gold')) color = '#ca8a04';
                val.style.cssText = `font-size: 24px; font-weight: 700; color: ${color} !important;`;
            });

            // Fraud items - compact box layout
            clone.querySelectorAll('.fraud-item').forEach(item => {
                const s = item.getAttribute('style') || '';
                let borderColor = '#d1d5db', bgColor = '#f9fafb';
                if (s.includes('green') || s.includes('#22c55e')) { borderColor = '#22c55e'; bgColor = '#dcfce7'; }
                else if (s.includes('yellow') || s.includes('#eab308')) { borderColor = '#eab308'; bgColor = '#fef9c3'; }
                else if (s.includes('red') || s.includes('#ef4444')) { borderColor = '#ef4444'; bgColor = '#fee2e2'; }
                item.style.cssText = `background: ${bgColor} !important; border: 1px solid ${borderColor} !important; border-radius: 8px; padding: 10px 12px; display: flex; align-items: center; gap: 8px;`;
            });

            // Fraud details grid
            clone.querySelectorAll('.fraud-details').forEach(grid => {
                grid.style.cssText = 'display: grid !important; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important; gap: 8px !important;';
            });

            // Risk chips
            clone.querySelectorAll('.risk-chip').forEach(chip => {
                const isGood = chip.classList.contains('good');
                const isWarn = chip.classList.contains('warn');
                const isBad = chip.classList.contains('bad');
                let bg = '#f3f4f6', border = '#d1d5db';
                if (isGood) { bg = '#dcfce7'; border = '#22c55e'; }
                if (isWarn) { bg = '#fef9c3'; border = '#eab308'; }
                if (isBad) { bg = '#fee2e2'; border = '#ef4444'; }
                chip.style.cssText = `background: ${bg} !important; border: 2px solid ${border} !important; padding: 12px; border-radius: 8px; text-align: center;`;
            });

            clone.querySelectorAll('.risk-chip-value').forEach(val => {
                const parent = val.closest('.risk-chip');
                let color = '#111827';
                if (parent?.classList.contains('good')) color = '#166534';
                if (parent?.classList.contains('warn')) color = '#854d0e';
                if (parent?.classList.contains('bad')) color = '#991b1b';
                val.style.cssText = `font-size: 28px; font-weight: 700; color: ${color} !important;`;
            });
            clone.querySelectorAll('.risk-chip-label').forEach(l => l.style.cssText = 'font-size: 11px; color: #6b7280 !important;');

            // Tables
            clone.querySelectorAll('table').forEach(t => t.style.cssText = 'background: #ffffff !important; border-collapse: collapse; width: 100%; border: 1px solid #e5e7eb;');
            clone.querySelectorAll('th').forEach(th => th.style.cssText = 'background: #f3f4f6 !important; color: #111827 !important; padding: 12px; border: 1px solid #e5e7eb !important;');
            clone.querySelectorAll('td').forEach(td => td.style.cssText = 'background: #ffffff !important; color: #111827 !important; padding: 12px; border: 1px solid #e5e7eb !important;');

            // Stats
            clone.querySelectorAll('.debt-stat, .research-stat').forEach(s => s.style.cssText = 'background: #f3f4f6 !important; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;');
            clone.querySelectorAll('.debt-stat-value, .research-stat-value').forEach(v => v.style.cssText = 'color: #111827 !important; font-size: 24px; font-weight: 700;');
            clone.querySelectorAll('.debt-stat-label, .research-stat-label').forEach(l => l.style.cssText = 'color: #6b7280 !important; font-size: 12px;');

            // MCA sections
            clone.querySelectorAll('.mca-section, .mca-alert').forEach(m => m.style.cssText = 'background: #fee2e2 !important; border: 2px solid #ef4444 !important; border-radius: 8px; padding: 16px; color: #991b1b !important;');

            // Charts
            clone.querySelectorAll('.chart-container').forEach(c => c.style.cssText = 'background: #ffffff !important; border-radius: 8px; border: 1px solid #e5e7eb; padding: 12px;');

            // Research modules
            clone.querySelectorAll('.research-module').forEach(m => {
                const hasLow = m.classList.contains('risk-low');
                const hasMed = m.classList.contains('risk-medium');
                const hasHigh = m.classList.contains('risk-high');
                let borderColor = '#e5e7eb';
                if (hasLow) borderColor = '#22c55e';
                if (hasMed) borderColor = '#eab308';
                if (hasHigh) borderColor = '#ef4444';
                m.style.cssText = `background: #ffffff !important; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 3px solid ${borderColor}; overflow: hidden; margin-bottom: 12px;`;
            });
            clone.querySelectorAll('.research-module-header').forEach(h => h.style.cssText = 'display: flex !important; align-items: center !important; gap: 12px !important; background: #f9fafb !important; color: #111827 !important; padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #e5e7eb; cursor: pointer;');
            clone.querySelectorAll('.research-module-icon').forEach(icon => {
                const parent = icon.closest('.research-module');
                let bg = '#f3f4f6', color = '#6b7280';
                if (parent?.classList.contains('risk-low')) { bg = '#dcfce7'; color = '#22c55e'; }
                else if (parent?.classList.contains('risk-medium')) { bg = '#fef9c3'; color = '#eab308'; }
                else if (parent?.classList.contains('risk-high')) { bg = '#fee2e2'; color = '#ef4444'; }
                icon.style.cssText = `width: 40px !important; height: 40px !important; min-width: 40px !important; border-radius: 8px !important; background: ${bg} !important; display: flex !important; align-items: center !important; justify-content: center !important;`;
                const svg = icon.querySelector('svg');
                if (svg) svg.style.cssText = `stroke: ${color} !important; width: 20px !important; height: 20px !important;`;
            });
            clone.querySelectorAll('.research-module-info').forEach(info => info.style.cssText = 'flex: 1 !important; min-width: 0 !important;');
            clone.querySelectorAll('.research-module-name').forEach(name => name.style.cssText = 'font-size: 14px !important; font-weight: 600 !important; color: #111827 !important;');
            clone.querySelectorAll('.research-module-summary').forEach(sum => sum.style.cssText = 'font-size: 12px !important; color: #6b7280 !important; margin-top: 2px !important;');
            clone.querySelectorAll('.research-module-status').forEach(status => {
                const text = status.textContent?.toLowerCase() || '';
                let bg = '#f3f4f6', color = '#6b7280';
                if (text.includes('low')) { bg = '#dcfce7'; color = '#166534'; }
                else if (text.includes('medium')) { bg = '#fef9c3'; color = '#854d0e'; }
                else if (text.includes('high')) { bg = '#fee2e2'; color = '#991b1b'; }
                else if (text.includes('complete') || text.includes('done')) { bg = '#dcfce7'; color = '#166534'; }
                status.style.cssText = `background: ${bg} !important; color: ${color} !important; padding: 4px 10px !important; border-radius: 12px !important; font-size: 11px !important; font-weight: 600 !important; white-space: nowrap !important;`;
            });
            clone.querySelectorAll('.research-module-body').forEach(b => b.style.cssText = 'background: #ffffff !important; color: #111827 !important; padding: 16px;');
            clone.querySelectorAll('.research-module-content').forEach(c => c.style.cssText = 'background: #ffffff !important; color: #374151 !important; padding: 16px !important;');

            // Research grid
            clone.querySelectorAll('.research-grid').forEach(g => g.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;');

            // Research risk badges
            clone.querySelectorAll('.risk-badge, .research-risk').forEach(badge => {
                const text = badge.textContent?.toLowerCase() || '';
                let bg = '#f3f4f6', color = '#374151';
                if (text.includes('low')) { bg = '#dcfce7'; color = '#166534'; }
                else if (text.includes('medium')) { bg = '#fef9c3'; color = '#854d0e'; }
                else if (text.includes('high')) { bg = '#fee2e2'; color = '#991b1b'; }
                badge.style.cssText = `background: ${bg} !important; color: ${color} !important; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;`;
            });

            // Lender cards
            clone.querySelectorAll('.lender-card').forEach(card => {
                card.style.cssText = 'background: #f9fafb !important; border: 1px solid #e5e7eb !important; border-radius: 8px; padding: 16px;';
            });
            clone.querySelectorAll('.lender-name').forEach(n => n.style.cssText = 'color: #111827 !important; font-weight: 600;');
            clone.querySelectorAll('.lender-detail').forEach(d => d.style.cssText = 'color: #6b7280 !important; font-size: 12px;');

            // Debt table
            clone.querySelectorAll('.debt-table-container').forEach(c => c.style.cssText = 'background: #ffffff !important;');

            // Summary sections
            clone.querySelectorAll('.risk-summary, .debt-summary, .research-summary, .data-grid').forEach(s => {
                s.style.cssText = 'display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px;';
            });

            // Chart row
            clone.querySelectorAll('.chart-row').forEach(r => r.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 16px;');

            // Progress bars
            clone.querySelectorAll('.research-progress').forEach(p => p.style.cssText = 'background: #f3f4f6 !important; border-radius: 8px; padding: 12px; margin-bottom: 16px;');
            clone.querySelectorAll('.research-progress-bar').forEach(b => b.style.cssText = 'background: #e5e7eb !important; border-radius: 4px; height: 8px; overflow: hidden;');
            clone.querySelectorAll('.research-progress-fill').forEach(f => f.style.cssText = 'background: #22c55e !important; height: 100%;');

            // Fraud modules (new design)
            clone.querySelectorAll('.fraud-modules-grid').forEach(g => g.style.cssText = 'display: grid !important; grid-template-columns: repeat(2, 1fr) !important; gap: 12px !important; max-width: 800px !important; margin: 0 auto !important;');
            clone.querySelectorAll('.fraud-module').forEach(m => {
                const hasLow = m.classList.contains('risk-low');
                const hasMed = m.classList.contains('risk-medium');
                const hasHigh = m.classList.contains('risk-high');
                let borderColor = '#e5e7eb';
                if (hasLow) borderColor = '#22c55e';
                if (hasMed) borderColor = '#eab308';
                if (hasHigh) borderColor = '#ef4444';
                m.style.cssText = `background: #ffffff !important; border-radius: 10px !important; border: 1px solid #e5e7eb !important; border-left: 3px solid ${borderColor} !important; overflow: hidden !important;`;
            });
            clone.querySelectorAll('.fraud-module-header').forEach(h => h.style.cssText = 'display: flex !important; align-items: center !important; gap: 10px !important; padding: 12px 14px !important; background: #f9fafb !important;');
            clone.querySelectorAll('.fraud-module-icon').forEach(icon => {
                const parent = icon.closest('.fraud-module');
                let bg = '#f3f4f6', color = '#6b7280';
                if (parent?.classList.contains('risk-low')) { bg = '#dcfce7'; color = '#22c55e'; }
                else if (parent?.classList.contains('risk-medium')) { bg = '#fef9c3'; color = '#eab308'; }
                else if (parent?.classList.contains('risk-high')) { bg = '#fee2e2'; color = '#ef4444'; }
                icon.style.cssText = `width: 32px !important; height: 32px !important; border-radius: 6px !important; background: ${bg} !important; display: flex !important; align-items: center !important; justify-content: center !important;`;
                const svg = icon.querySelector('svg');
                if (svg) svg.style.cssText = `stroke: ${color} !important; width: 16px !important; height: 16px !important;`;
            });
            clone.querySelectorAll('.fraud-module-info').forEach(i => i.style.cssText = 'flex: 1 !important; min-width: 0 !important;');
            clone.querySelectorAll('.fraud-module-name').forEach(n => n.style.cssText = 'font-size: 13px !important; font-weight: 600 !important; color: #111827 !important;');
            clone.querySelectorAll('.fraud-module-summary').forEach(s => s.style.cssText = 'font-size: 11px !important; color: #6b7280 !important;');
            clone.querySelectorAll('.fraud-module-status').forEach(status => {
                const parent = status.closest('.fraud-module');
                let bg = '#f3f4f6', color = '#374151';
                if (parent?.classList.contains('risk-low')) { bg = '#dcfce7'; color = '#166534'; }
                else if (parent?.classList.contains('risk-medium')) { bg = '#fef9c3'; color = '#854d0e'; }
                else if (parent?.classList.contains('risk-high')) { bg = '#fee2e2'; color = '#991b1b'; }
                status.style.cssText = `background: ${bg} !important; color: ${color} !important; padding: 4px 10px !important; border-radius: 12px !important; font-size: 11px !important; font-weight: 600 !important;`;
            });
            clone.querySelectorAll('.fraud-module-content').forEach(c => c.style.cssText = 'background: #ffffff !important; padding: 0 14px 14px 14px !important;');
            clone.querySelectorAll('.fraud-module-content p').forEach(p => p.style.cssText = 'color: #374151 !important; font-size: 13px !important; line-height: 1.6 !important; margin: 0 !important;');

            // Apply to ALL elements - nuclear option for any remaining var() references
            clone.querySelectorAll('*').forEach(el => {
                const computed = window.getComputedStyle(el);
                const bgColor = computed.backgroundColor;
                const textColor = computed.color;

                // Parse RGB values to check if dark
                const rgbMatch = bgColor?.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (rgbMatch) {
                    const [_, r, g, b] = rgbMatch.map(Number);
                    // If background is dark (all RGB components below 50), make it white
                    if (r < 50 && g < 50 && b < 50) {
                        el.style.backgroundColor = '#ffffff';
                    }
                    // If it's a dark gray (all components between 50-80), make it light gray
                    else if (r < 80 && g < 80 && b < 80) {
                        el.style.backgroundColor = '#f3f4f6';
                    }
                }

                // If text is white/light, make it dark
                const textRgbMatch = textColor?.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (textRgbMatch) {
                    const [_, r, g, b] = textRgbMatch.map(Number);
                    if (r > 200 && g > 200 && b > 200) {
                        el.style.color = '#111827';
                    }
                }
            });

            // Final pass - ensure all text is readable
            clone.querySelectorAll('span, div, p, h1, h2, h3, h4, h5, h6, strong, em, label, td, th, li, a').forEach(el => {
                const computed = window.getComputedStyle(el);
                const c = computed.color;
                const rgb = c?.match(/\d+/g);
                if (rgb && rgb.length >= 3) {
                    const [r, g, b] = rgb.map(Number);
                    // If text is gray (not a distinct color like green/red/yellow)
                    const isGray = Math.abs(r - g) < 40 && Math.abs(g - b) < 40;
                    // If it's a light gray (above 100 brightness), make it darker
                    if (isGray && r > 100) {
                        el.style.setProperty('color', '#374151', 'important');
                    }
                    // If it's white/near-white, make it dark
                    if (r > 200 && g > 200 && b > 200) {
                        el.style.setProperty('color', '#111827', 'important');
                    }
                }
                // Also check if style has var() references
                const inlineColor = el.style.color;
                if (inlineColor && inlineColor.includes('var(')) {
                    el.style.setProperty('color', '#111827', 'important');
                }
            });
        }

        // Method 1: PNG Clean - DOM Clone with forced light styles
        async function exportPngClean() {
            showStatus('Generating PNG (Clean)...', 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Create a wrapper div with explicit light styles
                const wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    background: #ffffff;
                    padding: 24px;
                    width: ${resultsArea.offsetWidth}px;
                `;

                // Add branded header
                wrapper.appendChild(createExportHeader(false));

                // Clone the results
                const clone = resultsArea.cloneNode(true);

                // Remove hidden class from all elements
                clone.querySelectorAll('.hidden').forEach(el => el.classList.remove('hidden'));

                // Remove all buttons
                clone.querySelectorAll('button, .card-export-btn, .expand-toggle').forEach(el => el.remove());

                // Apply comprehensive light styling
                applyExportLightStyles(clone);

                wrapper.appendChild(clone);

                // Add footer
                wrapper.appendChild(createExportFooter(false));

                document.body.appendChild(wrapper);

                // Wait for any images/charts to render
                await new Promise(r => setTimeout(r, 200));

                const canvas = await html2canvas(wrapper, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true
                });

                document.body.removeChild(wrapper);

                downloadCanvas(canvas, 'png');
                showStatus('PNG exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 2: PNG Iframe - Render in isolated iframe with FRESH HTML (no CSS variables)
        async function exportPngIframe() {
            showStatus('Generating PNG (Iframe)...', 'info');

            try {
                // Generate completely fresh HTML with hardcoded light colors
                const exportHTML = generateExportHTML({
                    includeFraud: true,
                    includeData: true,
                    includeCharts: false,
                    includeScore: true,
                    includeDebt: true,
                    includeResearch: true,
                    includeLenders: true
                });

                // Create iframe - must be visible for html2canvas to work properly
                const iframe = document.createElement('iframe');
                iframe.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 900px;
                    height: 100vh;
                    border: none;
                    z-index: 99999;
                    background: white;
                `;

                // Create overlay to hide from user
                const overlay = document.createElement('div');
                overlay.id = 'exportOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.9);
                    z-index: 99998;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    font-family: 'Inter', sans-serif;
                `;
                overlay.innerHTML = '<div style="text-align: center;"><div style="margin-bottom: 12px;">Generating export...</div><div style="font-size: 14px; opacity: 0.7;">Please wait</div></div>';

                document.body.appendChild(overlay);
                document.body.appendChild(iframe);

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Write complete self-contained HTML - NO CSS VARIABLES
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                                background: #ffffff;
                                color: #111827;
                                padding: 24px;
                                line-height: 1.5;
                            }
                        </style>
                    </head>
                    <body>${exportHTML}</body>
                    </html>
                `);
                iframeDoc.close();

                // Wait for fonts and content to load
                await new Promise(r => setTimeout(r, 800));

                const canvas = await html2canvas(iframeDoc.body, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    width: 900,
                    windowWidth: 900
                });

                document.body.removeChild(iframe);
                document.body.removeChild(overlay);

                downloadCanvas(canvas, 'png');
                showStatus('PNG exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                // Clean up
                document.getElementById('exportOverlay')?.remove();
                document.querySelectorAll('iframe').forEach(f => {
                    if (f.style.zIndex === '99999') f.remove();
                });
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 3: PNG Native - Export current theme as-is
        async function exportPngNative() {
            showStatus('Generating PNG (Native)...', 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');

                // Hide buttons
                const buttons = resultsArea.querySelectorAll('button, .card-export-btn');
                buttons.forEach(b => b.style.display = 'none');

                // Expand hidden sections
                const hiddenEls = resultsArea.querySelectorAll('.hidden');
                hiddenEls.forEach(el => el.classList.remove('hidden'));

                const canvas = await html2canvas(resultsArea, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });

                // Restore
                buttons.forEach(b => b.style.display = '');
                hiddenEls.forEach(el => el.classList.add('hidden'));

                downloadCanvas(canvas, 'png');
                showStatus('PNG exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 4: PDF Export
        async function exportPdf() {
            showStatus('Generating PDF...', 'info');

            try {
                // Use iframe method for proper color rendering
                const exportHTML = generateExportHTML({
                    includeFraud: true,
                    includeData: true,
                    includeCharts: false,
                    includeScore: true,
                    includeDebt: true,
                    includeResearch: true,
                    includeLenders: true
                });

                // Create iframe - must be visible for html2canvas to work properly
                const iframe = document.createElement('iframe');
                iframe.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 900px;
                    height: 100vh;
                    border: none;
                    z-index: 99999;
                    background: white;
                `;

                // Create overlay to hide from user
                const overlay = document.createElement('div');
                overlay.id = 'exportOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.9);
                    z-index: 99998;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    font-family: 'Inter', sans-serif;
                `;
                overlay.innerHTML = '<div style="text-align: center;"><div style="margin-bottom: 12px;">Generating PDF...</div><div style="font-size: 14px; opacity: 0.7;">Please wait</div></div>';

                document.body.appendChild(overlay);
                document.body.appendChild(iframe);

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Write complete self-contained HTML - NO CSS VARIABLES
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                                background: #ffffff;
                                color: #111827;
                                padding: 24px;
                                line-height: 1.5;
                            }
                        </style>
                    </head>
                    <body>${exportHTML}</body>
                    </html>
                `);
                iframeDoc.close();

                // Wait for fonts and content to load
                await new Promise(r => setTimeout(r, 800));

                const canvas = await html2canvas(iframeDoc.body, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    width: 900,
                    windowWidth: 900
                });

                document.body.removeChild(iframe);
                document.body.removeChild(overlay);

                // Create PDF from canvas
                const { jsPDF } = window.jspdf;
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const pdfWidth = 612;
                const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
                const maxPageHeight = 792;

                if (pdfHeight <= maxPageHeight) {
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] });
                    pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(getFilename('pdf'));
                } else {
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                    const pageHeightInCanvasPixels = (maxPageHeight * imgWidth) / pdfWidth;
                    let position = 0;
                    let pageNum = 0;

                    while (position < imgHeight) {
                        if (pageNum > 0) pdf.addPage();

                        const pageCanvas = document.createElement('canvas');
                        pageCanvas.width = imgWidth;
                        pageCanvas.height = Math.min(pageHeightInCanvasPixels, imgHeight - position);
                        const ctx = pageCanvas.getContext('2d');
                        ctx.drawImage(canvas, 0, position, imgWidth, pageCanvas.height, 0, 0, imgWidth, pageCanvas.height);

                        const scaledHeight = (pageCanvas.height * pdfWidth) / imgWidth;
                        pdf.addImage(pageCanvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, scaledHeight);

                        position += pageHeightInCanvasPixels;
                        pageNum++;
                    }

                    pdf.save(getFilename('pdf'));
                }

                showStatus('PDF exported!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                // Clean up
                document.getElementById('exportOverlay')?.remove();
                document.querySelectorAll('iframe').forEach(f => {
                    if (f.style.zIndex === '99999') f.remove();
                });
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Method 5: Print - Use browser print
        function exportPrint() {
            window.print();
        }

        // Method 6: JSON Export
        function exportJson() {
            const data = {
                business: extractedBusinessInfo,
                analysis: extractedData.full_analysis,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = getFilename('json');
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);

            showStatus('JSON exported!', 'success');
        }

        // Method 7: CSV Export
        function exportCsv() {
            const analysis = extractedData.full_analysis;
            if (!analysis || !analysis.monthly_data) {
                showStatus('No monthly data to export', 'error');
                return;
            }

            const rows = [
                ['Month', 'Total Deposits', 'True Revenue', 'Deposit Count', 'Total Withdrawals', 'Avg Balance', 'Low Balance', 'NSF Items', 'Negative Days']
            ];

            analysis.monthly_data.forEach(month => {
                rows.push([
                    month.month || '',
                    month.total_deposits || 0,
                    month.true_revenue || month.total_deposits || 0,
                    month.deposit_count || 0,
                    month.total_withdrawals || 0,
                    month.average_balance || 0,
                    month.low_balance || 0,
                    month.nsf_items || 0,
                    month.negative_days || 0
                ]);
            });

            // Add summary row
            if (analysis.summary) {
                rows.push([]);
                rows.push(['Summary']);
                rows.push(['Average Monthly Deposits', analysis.summary.avg_monthly_deposits || 0]);
                rows.push(['Average True Revenue', analysis.summary.avg_true_revenue || analysis.summary.avg_monthly_deposits || 0]);
                rows.push(['Total NSF Items', analysis.summary.total_nsf || 0]);
                rows.push(['Total Negative Days', analysis.summary.total_negative_days || 0]);
            }

            const csv = rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = getFilename('csv');
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);

            showStatus('CSV exported!', 'success');
        }

        // Method 8: Clipboard - Copy summary text
        async function exportClipboard() {
            const analysis = extractedData.full_analysis;
            const business = extractedBusinessInfo;

            let text = `VISION Analysis Report\n`;
            text += `========================\n\n`;
            text += `Business: ${business.name || 'Unknown'}\n`;
            text += `Export Date: ${new Date().toLocaleDateString()}\n\n`;

            if (analysis.summary) {
                text += `SUMMARY\n`;
                text += `-------\n`;
                text += `Avg Monthly Deposits: $${(analysis.summary.avg_monthly_deposits || 0).toLocaleString()}\n`;
                text += `Avg True Revenue: $${(analysis.summary.avg_true_revenue || analysis.summary.avg_monthly_deposits || 0).toLocaleString()}\n`;
                text += `Total NSF Items: ${analysis.summary.total_nsf || 0}\n`;
                text += `Total Negative Days: ${analysis.summary.total_negative_days || 0}\n`;
                text += `MCA Positions Found: ${analysis.summary.mca_lenders_found || 0}\n\n`;
            }

            if (analysis.monthly_data && analysis.monthly_data.length > 0) {
                text += `MONTHLY DATA\n`;
                text += `------------\n`;
                analysis.monthly_data.forEach(m => {
                    text += `${m.month}: Deposits $${(m.total_deposits || 0).toLocaleString()}, True Rev $${(m.true_revenue || m.total_deposits || 0).toLocaleString()}, NSF ${m.nsf_items || 0}, Neg Days ${m.negative_days || 0}\n`;
                });
                text += `\n`;
            }

            if (analysis.red_flags && analysis.red_flags.length > 0) {
                text += `RED FLAGS\n`;
                text += `---------\n`;
                analysis.red_flags.forEach(flag => {
                    text += ` ${flag}\n`;
                });
            }

            try {
                await navigator.clipboard.writeText(text);
                showStatus('Copied to clipboard!', 'success');
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showStatus('Copied to clipboard!', 'success');
            }
        }

        // Helper: Download canvas as file
        function downloadCanvas(canvas, format) {
            const link = document.createElement('a');
            link.download = getFilename(format);
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        // Helper: Generate filename
        function getFilename(extension) {
            const businessName = extractedBusinessInfo.name || 'Report';
            const safeName = businessName.replace(/[^a-z0-9]/gi, '_');
            const date = new Date().toISOString().split('T')[0];
            return `${safeName}_Analysis_${date}.${extension}`;
        }

        async function exportReport() {
            await exportPdf();
        }

        async function exportReportAsPng() {
            await exportPngIframe();
        }

        async function exportCardAsPng(cardId, cardName) {
            showStatus('Generating PNG...', 'info');

            try {
                // Map card IDs to export options
                const sectionMap = {
                    'fraudSection': { includeFraud: true },
                    'dataSection': { includeData: true },
                    'chartsSection': { includeCharts: true },
                    'debtSection': { includeDebt: true },
                    'researchSection': { includeResearch: true },
                    'lenderSection': { includeLenders: true },
                    'creditEngineSection': { includeScore: true },
                    'submitSection': { includeSubmit: true }
                };

                const options = sectionMap[cardId] || {};

                // Generate HTML for just this section with branding
                const exportHTML = generateExportHTML(options);

                // Create iframe for isolated rendering
                const iframe = document.createElement('iframe');
                iframe.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 900px;
                    height: 100vh;
                    border: none;
                    z-index: 99999;
                    background: white;
                `;

                // Create overlay
                const overlay = document.createElement('div');
                overlay.id = 'exportOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.9);
                    z-index: 99998;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    font-family: 'Inter', sans-serif;
                `;
                overlay.innerHTML = '<div style="text-align: center;"><div style="margin-bottom: 12px;">Generating export...</div><div style="font-size: 14px; opacity: 0.7;">Please wait</div></div>';

                document.body.appendChild(overlay);
                document.body.appendChild(iframe);

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                // Write complete self-contained HTML with Ables branding
                iframeDoc.open();
                iframeDoc.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body {
                                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                                background: #ffffff;
                                color: #111827;
                                padding: 24px;
                                line-height: 1.5;
                            }
                        </style>
                    </head>
                    <body>${exportHTML}</body>
                    </html>
                `);
                iframeDoc.close();

                // Wait for fonts and content to load
                await new Promise(r => setTimeout(r, 800));

                const canvas = await html2canvas(iframeDoc.body, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    width: 900,
                    windowWidth: 900
                });

                document.body.removeChild(iframe);
                document.body.removeChild(overlay);

                const businessName = extractedBusinessInfo.name || 'Report';
                const filename = `${businessName.replace(/[^a-z0-9]/gi, '_')}_${cardName}_${new Date().toISOString().split('T')[0]}.png`;

                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();

                showStatus(`${cardName.replace(/_/g, ' ')} exported!`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                // Clean up
                document.getElementById('exportOverlay')?.remove();
                document.querySelectorAll('iframe').forEach(f => {
                    if (f.style.zIndex === '99999') f.remove();
                });
                showStatus('Error exporting PNG: ' + error.message, 'error');
            }
        }

        async function exportReportAs(format = 'png') {
            if (!extractedData.full_analysis) {
                showStatus('No analysis data to export', 'error');
                return;
            }

            showStatus(`Generating ${format.toUpperCase()}...`, 'info');

            try {
                const resultsArea = document.getElementById('resultsArea');
                if (!resultsArea) {
                    showStatus('Results area not found', 'error');
                    return;
                }

                // Hide buttons before capture
                const buttons = resultsArea.querySelectorAll('button, .expand-toggle');
                buttons.forEach(b => b.style.display = 'none');

                // Expand hidden sections
                const hiddenEls = resultsArea.querySelectorAll('.hidden');
                hiddenEls.forEach(el => el.classList.remove('hidden'));

                // Use html2canvas onclone callback - this modifies the INTERNAL clone
                // that html2canvas creates, which is what actually gets rendered
                const canvas = await html2canvas(resultsArea, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true,
                    onclone: (clonedDoc) => {
                        // This runs on html2canvas's internal clone BEFORE rendering
                        const clonedResults = clonedDoc.getElementById('resultsArea');
                        if (!clonedResults) return;

                        // Inject light theme CSS variables into the cloned document
                        const style = clonedDoc.createElement('style');
                        style.textContent = `
                            :root, html, body, * {
                                --bg: #f8fafc !important;
                                --bg-secondary: #ffffff !important;
                                --bg-tertiary: #f1f5f9 !important;
                                --bg-hover: #e2e8f0 !important;
                                --text: #0f172a !important;
                                --text-secondary: #475569 !important;
                                --text-tertiary: #64748b !important;
                                --border: #e2e8f0 !important;
                                --border-secondary: #cbd5e1 !important;
                            }
                        `;
                        clonedDoc.head.appendChild(style);

                        // Set data-theme on cloned document
                        clonedDoc.documentElement.setAttribute('data-theme', 'light');

                        // Force white background on body
                        clonedDoc.body.style.backgroundColor = '#ffffff';

                        // Walk ALL elements and force light styles via inline CSS
                        const allElements = clonedResults.querySelectorAll('*');
                        allElements.forEach(el => {
                            // Clear ANY background (including gradients, images)
                            el.style.setProperty('background', '#ffffff', 'important');
                            el.style.setProperty('background-color', '#ffffff', 'important');
                            el.style.setProperty('background-image', 'none', 'important');
                            // Force dark text
                            el.style.setProperty('color', '#0f172a', 'important');
                        });

                        // Force white on body, html, and all parent containers
                        clonedDoc.body.style.setProperty('background', '#ffffff', 'important');
                        clonedDoc.body.style.setProperty('background-color', '#ffffff', 'important');
                        clonedDoc.documentElement.style.setProperty('background', '#ffffff', 'important');

                        const content = clonedDoc.querySelector('.content');
                        if (content) {
                            content.style.setProperty('background', '#ffffff', 'important');
                        }

                        // Set explicit background on the results container
                        clonedResults.style.setProperty('background', '#ffffff', 'important');
                        clonedResults.style.setProperty('background-color', '#ffffff', 'important');
                        clonedResults.style.setProperty('background-image', 'none', 'important');
                    }
                });

                // Restore buttons
                buttons.forEach(b => b.style.display = '');

                // Restore hidden elements
                hiddenEls.forEach(el => el.classList.add('hidden'));

                const businessName = extractedBusinessInfo.name || 'Report';
                const filename = `${businessName.replace(/[^a-z0-9]/gi, '_')}_Analysis_${new Date().toISOString().split('T')[0]}`;

                if (format === 'png') {
                    // Direct PNG download
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    showStatus('PNG exported!', 'success');
                } else {
                    // Convert to PDF with proper page sizing
                    const { jsPDF } = window.jspdf;

                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;

                    // Use the image dimensions to set PDF size, scaled to letter width
                    const pdfWidth = 612; // Letter width in points
                    const pdfHeight = (imgHeight * pdfWidth) / imgWidth;

                    // If content is too tall for one page, create multi-page PDF
                    const maxPageHeight = 792; // Letter height in points

                    if (pdfHeight <= maxPageHeight) {
                        // Single page
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [pdfWidth, pdfHeight] });
                        pdf.addImage(canvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(filename + '.pdf');
                    } else {
                        // Multi-page - split the canvas
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
                        const pageHeightInCanvasPixels = (maxPageHeight * imgWidth) / pdfWidth;
                        let position = 0;
                        let pageNum = 0;

                        while (position < imgHeight) {
                            if (pageNum > 0) pdf.addPage();

                            // Create a temporary canvas for this page slice
                            const pageCanvas = document.createElement('canvas');
                            pageCanvas.width = imgWidth;
                            pageCanvas.height = Math.min(pageHeightInCanvasPixels, imgHeight - position);
                            const ctx = pageCanvas.getContext('2d');

                            ctx.drawImage(canvas, 0, position, imgWidth, pageCanvas.height, 0, 0, imgWidth, pageCanvas.height);

                            const scaledHeight = (pageCanvas.height * pdfWidth) / imgWidth;
                            pdf.addImage(pageCanvas.toDataURL('image/png', 1.0), 'PNG', 0, 0, pdfWidth, scaledHeight);

                            position += pageHeightInCanvasPixels;
                            pageNum++;
                        }

                        pdf.save(filename + '.pdf');
                    }
                    showStatus('PDF exported!', 'success');
                }
            } catch (error) {
                console.error('Export error:', error);
                showStatus(`Error exporting ${format.toUpperCase()}: ` + error.message, 'error');
            }
        }

        function getSelectedModel() {
            return localStorage.getItem('gemini_model') || 'gemini-3-flash-preview';
        }

        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = `status-message show ${type}`;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function showLoading(show, text = 'Processing...', options = {}) {
            const loadingEl = document.getElementById('loading');
            loadingEl.classList.toggle('show', show);
            document.getElementById('loadingText').textContent = text;
            document.getElementById('emptyState').classList.toggle('hidden', show || files.length > 0);

            // Handle subtext
            const subtextEl = document.getElementById('loadingSubtext');
            subtextEl.textContent = options.subtext || 'This may take a moment';

            // Handle progress bar
            const progressBar = document.getElementById('loadingProgressBar');
            if (options.progress !== undefined) {
                progressBar.style.width = options.progress + '%';
            } else if (show) {
                progressBar.style.width = '0%';
            }

            // Handle step indicators
            const steps = document.querySelectorAll('.loading-step');
            steps.forEach(step => {
                step.classList.remove('active', 'done');
            });

            if (options.step) {
                const stepOrder = ['scan', 'extract', 'analyze', 'match'];
                const currentIdx = stepOrder.indexOf(options.step);
                steps.forEach((step, idx) => {
                    const stepName = step.dataset.step;
                    const stepIdx = stepOrder.indexOf(stepName);
                    if (stepIdx < currentIdx) {
                        step.classList.add('done');
                    } else if (stepIdx === currentIdx) {
                        step.classList.add('active');
                    }
                });
            }

            // Reset if hiding
            if (!show) {
                progressBar.style.width = '0%';
            }
        }

        // File Handling
        async function handleFiles(fileList) {
            for (const file of fileList) {
                if (file.type === 'application/pdf') {
                    await loadPDF(file);
                } else if (file.type.startsWith('image/')) {
                    await loadImage(file);
                }
            }
            updateFileList();
            document.getElementById('processBtn').disabled = files.length === 0;
            document.getElementById('downloadAllBtn').style.display = files.length > 0 ? 'block' : 'none';
            document.getElementById('emptyState').classList.toggle('hidden', files.length > 0);

            // Auto-select first file for preview
            if (files.length > 0 && activeFileIndex === -1) {
                selectFile(0);
            }
        }

        async function loadPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                // Make two separate copies - one for pdf.js, one to store for pdf-lib later
                const bytesForPdfJs = new Uint8Array(arrayBuffer.slice(0));
                const bytesForStorage = new Uint8Array(arrayBuffer.slice(0));

                const pdf = await pdfjsLib.getDocument({ data: bytesForPdfJs }).promise;
                const pages = [];

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const pdfCanvas = document.createElement('canvas');
                    pdfCanvas.width = viewport.width;
                    pdfCanvas.height = viewport.height;
                    await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;
                    const img = new Image();
                    img.src = pdfCanvas.toDataURL();
                    await new Promise(r => img.onload = r);
                    pages.push(img);
                }

                files.push({
                    name: file.name,
                    pages,
                    thumb: pages[0].src,
                    status: null,
                    fraudAnalysis: null,
                    originalPdfBytes: bytesForStorage,
                    isPdf: true
                });
            } catch (err) {
                console.error('Error loading PDF:', err);
                showStatus('Error loading PDF: ' + err.message, 'error');
            }
        }

        async function loadImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        files.push({
                            name: file.name,
                            pages: [img],
                            thumb: img.src,
                            status: null,
                            fraudAnalysis: null,
                            isPdf: false
                        });
                        resolve();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = files.map((f, i) => `
                <div class="file-item ${f.status || ''} ${i === activeFileIndex ? 'selected' : ''}" onclick="selectFile(${i})">
                    <img class="file-thumb" src="${f.thumb}">
                    <div class="file-info">
                        <input type="text" class="file-name-input" value="${f.outputName || f.name.replace(/\.[^.]+$/, '')}"
                            onclick="event.stopPropagation()"
                            onchange="updateFileName(${i}, this.value)"
                            onkeydown="if(event.key==='Enter')this.blur()">
                        <div class="file-meta">${f.pages.length} page(s)</div>
                    </div>
                    ${f.status ? `<span class="file-status ${f.status}" onclick="event.stopPropagation();showFraudDetails(${i})">${f.status === 'clean' ? 'Clean' : f.status === 'warning' ? 'Review' : 'Risk'}</span>` : ''}
                    <button class="file-remove" onclick="event.stopPropagation();removeFile(${i})"></button>
                </div>
            `).join('');
            document.getElementById('fileCount').textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
            document.getElementById('downloadAllBtn').style.display = files.length > 0 ? 'block' : 'none';
        }

        function updateFileName(idx, newName) {
            if (files[idx]) {
                files[idx].outputName = newName.replace(/[^a-z0-9_\-\s]/gi, '_');
            }
        }

        function removeFile(idx) {
            files.splice(idx, 1);
            if (activeFileIndex >= files.length) activeFileIndex = files.length - 1;
            updateFileList();
            document.getElementById('processBtn').disabled = files.length === 0;
            document.getElementById('downloadAllBtn').style.display = files.length > 0 ? 'block' : 'none';
            document.getElementById('emptyState').classList.toggle('hidden', files.length > 0);
            if (files.length === 0) {
                document.getElementById('watermarkPlaceholder').style.display = 'block';
                canvas.style.display = 'none';
            } else if (activeFileIndex >= 0) {
                selectFile(activeFileIndex);
            }
        }

        function showFraudDetails(idx) {
            const file = files[idx];
            if (!file || !file.fraudAnalysis) return;

            const statusLabel = file.status === 'clean' ? 'CLEAN' : file.status === 'warning' ? 'REVIEW NEEDED' : 'HIGH RISK';
            const statusClass = file.status === 'clean' ? 'green' : file.status === 'warning' ? 'gold' : 'red';

            document.getElementById('fraudDetailContent').innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div class="data-label">Document</div>
                    <div style="font-weight: 600;">${file.name}</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <div class="data-label">Risk Assessment</div>
                    <span class="file-status ${file.status}" style="font-size: 12px;">${statusLabel}</span>
                </div>
                <div>
                    <div class="data-label">Analysis</div>
                    <div style="background: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-sm); font-size: 13px; line-height: 1.6;">
                        ${file.fraudAnalysis}
                    </div>
                </div>
            `;
            openModal('fraudDetailModal');
        }

        // Processing
        function setStep(num) {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (!step) continue;
                step.classList.remove('active', 'completed');
                if (i < num) step.classList.add('completed');
                if (i === num) step.classList.add('active');
            }
        }

        // Business info extracted from bank statements
        let extractedBusinessInfo = { name: '', owner: '', address: '' };

        async function processDocuments() {
            const apiKey = localStorage.getItem('gemini_key');
            if (!apiKey) {
                showStatus('Please set your Gemini API key in Settings', 'error');
                openModal('settingsModal');
                return;
            }

            try {
                document.getElementById('emptyState').style.display = 'none';

                // ===== SHOW ALL SECTIONS WITH SKELETONS IMMEDIATELY =====
                document.getElementById('fraudSection').classList.remove('hidden');
                document.getElementById('dataSection').classList.remove('hidden');
                document.getElementById('chartsSection').classList.remove('hidden');
                document.getElementById('debtSection').classList.remove('hidden');
                document.getElementById('researchSection').classList.remove('hidden');
                document.getElementById('scoreSection').classList.remove('hidden');
                document.getElementById('lenderSection').classList.remove('hidden');

                // Initialize all skeletons
                renderFraudSkeleton();
                renderBankDataSkeleton();
                renderChartsSkeleton();
                renderDebtSkeleton();
                renderResearchSkeleton();
                renderScoreSkeleton();
                renderLenderSkeleton();

                // ===== STEP 2: FRAUD SCAN (parallel) =====
                setStep(2);
                showLoading(true, `Scanning ${files.length} documents for fraud in parallel...`, {
                    step: 'scan',
                    progress: 10,
                    subtext: `Analyzing all documents simultaneously for manipulation`
                });

                let fraudScanned = 0;
                await Promise.all(files.map(async (file, i) => {
                    file.status = await scanForFraud(file, apiKey);
                    fraudScanned++;
                    showLoading(true, `Scanned ${fraudScanned} of ${files.length} documents...`, {
                        step: 'scan',
                        progress: 5 + Math.round((fraudScanned / files.length) * 25),
                        subtext: `${files.length - fraudScanned} remaining`
                    });
                    updateFileList();
                }));

                // Fraud complete - render results
                renderFraudResults();

                // ===== STEP 3: EXTRACT BANK DATA =====
                setStep(3);
                showLoading(true, 'Extracting bank data...', {
                    step: 'extract',
                    progress: 30,
                    subtext: 'Reading transaction data and account details'
                });

                extractedData = await extractBankDataSimple(apiKey);

                // Store months data for clickable cell popups
                liveExtractionResults = extractedData?.full_analysis?.months || [];

                // Bank data complete - render results
                renderExtractedData();
                renderCharts();
                // Note: renderDebtObligations() is called inside renderExtractedData()

                // Display extracted business info
                if (extractedBusinessInfo.name) {
                    document.getElementById('businessInfoSection').style.display = 'block';
                    document.getElementById('displayBusinessName').textContent = extractedBusinessInfo.name;
                    document.getElementById('displayOwnerName').textContent = extractedBusinessInfo.owner ? `Owner: ${extractedBusinessInfo.owner}` : '';
                    document.getElementById('displayBusinessAddress').textContent = extractedBusinessInfo.address || '';
                }

                // ===== STEP 4: RESEARCH =====
                setStep(4);
                if (extractedBusinessInfo.name) {
                    showLoading(true, `Researching ${extractedBusinessInfo.name}...`, {
                        step: 'analyze',
                        progress: 60,
                        subtext: 'Running comprehensive background checks'
                    });
                    document.getElementById('researchBusinessName').textContent = extractedBusinessInfo.name;
                    await runBackgroundResearch(apiKey);
                }

                // ===== ABLES CREDIT SCORE =====
                calculateCreditScore();

                // ===== STEP 5: MATCH LENDERS =====
                setStep(5);
                document.getElementById('submitSection').classList.remove('hidden');

                showLoading(true, 'Finding best lender matches...', {
                    step: 'match',
                    progress: 90,
                    subtext: 'Comparing against lender criteria'
                });

                matchedLenders = matchLenders(extractedData);
                renderLenderResults();
                renderSubmitInstructions();

                showLoading(false);
                showStatus('Analysis complete!', 'success');
                document.getElementById('exportMenuBtn').disabled = false;

            } catch (error) {
                console.error(error);
                showLoading(false);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function scanForFraud(file, apiKey) {
            try {
                const canvas = document.createElement('canvas');
                const img = file.pages[0];
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                const model = getSelectedModel();
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: `Analyze this bank statement image for signs of ALTERATION or TAMPERING only.

ONLY flag as DANGER or WARNING if you see clear evidence of:
1. DIGITAL EDITING - visible editing artifacts, cut/paste lines, mismatched pixels, blur around numbers
2. FONT TAMPERING - numbers or text with different fonts/sizes than surrounding content
3. WHITEOUT/CORRECTION - visible white boxes or correction tape marks covering original text
4. MATHEMATICAL ERRORS - running balance doesn't add up correctly with transactions shown

DO NOT flag documents for:
- Future dates (these are fine)
- Low resolution or poor scan quality
- Normal banking format variations
- Standard PDF rendering artifacts

Only flag DANGER if there is CLEAR visual evidence of alteration.
Only flag WARNING if there are suspicious but uncertain indicators.
Flag CLEAN if the document appears unaltered and authentic.

Provide a brief 1-2 sentence explanation of what you found (or that no alterations were detected).
End with exactly one: RISK_LEVEL:CLEAN or RISK_LEVEL:WARNING or RISK_LEVEL:DANGER` },
                                { inlineData: { mimeType: 'image/jpeg', data: base64 } }
                            ]
                        }]
                    })
                });

                const data = await resp.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                file.fraudAnalysis = text.replace(/RISK_LEVEL:(CLEAN|WARNING|DANGER)/g, '').trim();

                if (text.includes('RISK_LEVEL:DANGER')) return 'danger';
                if (text.includes('RISK_LEVEL:WARNING')) return 'warning';
                return 'clean';
            } catch (e) {
                file.fraudAnalysis = 'Analysis failed - API error';
                return 'warning';
            }
        }

        function renderFraudResults() {
            const clean = files.filter(f => f.status === 'clean').length;
            const warning = files.filter(f => f.status === 'warning').length;
            const danger = files.filter(f => f.status === 'danger').length;

            // Build expandable document modules (like research modules)
            const documentModules = files.map((f, i) => {
                const statusText = f.status === 'danger' ? 'HIGH RISK' : f.status === 'warning' ? 'REVIEW' : 'CLEAN';
                const riskClass = f.status === 'danger' ? 'risk-high' : f.status === 'warning' ? 'risk-medium' : 'risk-low';
                const statusIcon = f.status === 'danger'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                    : f.status === 'warning'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';

                const shortName = f.name.length > 35 ? f.name.substring(0, 32) + '...' : f.name;
                const analysis = f.fraudAnalysis || 'No analysis details available.';

                return `
                    <div class="fraud-module ${riskClass}" id="fraud-module-${i}">
                        <div class="fraud-module-header" onclick="toggleFraudModule(${i})">
                            <div class="fraud-module-icon">${statusIcon}</div>
                            <div class="fraud-module-info">
                                <div class="fraud-module-name">${shortName}</div>
                                <div class="fraud-module-summary">${f.pages?.length || 0} page(s) analyzed</div>
                            </div>
                            <div class="fraud-module-status">${statusText}</div>
                            <div class="expand-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="fraud-module-content" id="fraud-content-${i}">
                            <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.6; margin: 0;">${analysis}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Overall status - minimal badge
            const overallColor = danger > 0 ? 'var(--red)' : warning > 0 ? 'var(--yellow)' : 'var(--green)';
            const overallText = danger > 0 ? 'Issues Detected' : warning > 0 ? 'Review Required' : 'All Clear';

            document.getElementById('fraudResults').innerHTML = `
                <!-- Summary Stats Row -->
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--green);">${clean}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Clean</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--yellow);">${warning}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Review</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--red);">${danger}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Risk</span>
                    </div>
                    <div style="flex: 1;"></div>
                    <div style="padding: 6px 12px; background: ${overallColor}15; border-radius: 20px; font-size: 12px; font-weight: 600; color: ${overallColor};">${overallText}</div>
                </div>

                <!-- Document Modules Grid -->
                <div class="fraud-modules-grid">
                    ${documentModules}
                </div>
            `;
        }

        function toggleFraudModule(index) {
            const module = document.getElementById('fraud-module-' + index);
            module.classList.toggle('expanded');
        }

        // Live rendering - shows each document as it's processed
        function renderFraudResultsLive() {
            const scanned = files.filter(f => f.status);
            const pending = files.filter(f => !f.status);
            const clean = scanned.filter(f => f.status === 'clean').length;
            const warning = scanned.filter(f => f.status === 'warning').length;
            const danger = scanned.filter(f => f.status === 'danger').length;

            // Build modules for all files - show status or spinner
            const documentModules = files.map((f, i) => {
                if (!f.status) {
                    // Not yet scanned - show pending state
                    const shortName = f.name.length > 35 ? f.name.substring(0, 32) + '...' : f.name;
                    return `
                        <div class="fraud-module risk-pending" id="fraud-module-${i}">
                            <div class="fraud-module-header">
                                <div class="fraud-module-icon" style="animation: pulse 1.5s ease-in-out infinite;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                </div>
                                <div class="fraud-module-info">
                                    <div class="fraud-module-name">${shortName}</div>
                                    <div class="fraud-module-summary" style="color: var(--text-muted);">Waiting to scan...</div>
                                </div>
                                <div class="fraud-module-status" style="background: var(--bg-tertiary); color: var(--text-muted);">PENDING</div>
                            </div>
                        </div>
                    `;
                }

                // Already scanned - show full module
                const statusText = f.status === 'danger' ? 'HIGH RISK' : f.status === 'warning' ? 'REVIEW' : 'CLEAN';
                const riskClass = f.status === 'danger' ? 'risk-high' : f.status === 'warning' ? 'risk-medium' : 'risk-low';
                const statusIcon = f.status === 'danger'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                    : f.status === 'warning'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
                    : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';

                const shortName = f.name.length > 35 ? f.name.substring(0, 32) + '...' : f.name;
                const analysis = f.fraudAnalysis || 'No analysis details available.';

                return `
                    <div class="fraud-module ${riskClass}" id="fraud-module-${i}" style="animation: fadeIn 0.3s ease-out;">
                        <div class="fraud-module-header" onclick="toggleFraudModule(${i})">
                            <div class="fraud-module-icon">${statusIcon}</div>
                            <div class="fraud-module-info">
                                <div class="fraud-module-name">${shortName}</div>
                                <div class="fraud-module-summary">${f.pages?.length || 0} page(s) analyzed</div>
                            </div>
                            <div class="fraud-module-status">${statusText}</div>
                            <div class="expand-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </div>
                        </div>
                        <div class="fraud-module-content" id="fraud-content-${i}">
                            <p style="color: var(--text-secondary); font-size: 13px; line-height: 1.6; margin: 0;">${analysis}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // Status text changes based on progress
            const statusText = pending.length > 0
                ? `Scanning ${scanned.length}/${files.length}...`
                : danger > 0 ? 'Issues Detected' : warning > 0 ? 'Review Required' : 'All Clear';
            const statusColor = pending.length > 0
                ? 'var(--blue)'
                : danger > 0 ? 'var(--red)' : warning > 0 ? 'var(--yellow)' : 'var(--green)';

            document.getElementById('fraudResults').innerHTML = `
                <!-- Summary Stats Row -->
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--green);">${clean}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Clean</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--yellow);">${warning}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Review</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 20px; font-weight: 700; color: var(--red);">${danger}</span>
                        <span style="font-size: 12px; color: var(--text-muted);">Risk</span>
                    </div>
                    <div style="flex: 1;"></div>
                    <div style="padding: 6px 12px; background: ${statusColor}15; border-radius: 20px; font-size: 12px; font-weight: 600; color: ${statusColor};">${statusText}</div>
                </div>

                <!-- Document Modules Grid -->
                <div class="fraud-modules-grid">
                    ${documentModules}
                </div>
            `;
        }

        // Extract data from a single bank statement file
        async function extractSingleStatement(file, apiKey, fileIndex) {
            const images = [];
            for (const page of file.pages) {
                const canvas = document.createElement('canvas');
                canvas.width = page.width;
                canvas.height = page.height;
                canvas.getContext('2d').drawImage(page, 0, 0);
                images.push(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
            }

            const parts = [
                { text: `You are analyzing a SINGLE bank statement for MCA underwriting. This is statement ${fileIndex + 1}.

Extract the data for THIS ONE MONTH only:
- month: Month name and year (e.g., "January 2024")
- total_deposits: Sum of all credits/deposits
- true_revenue: Deposits minus internal transfers, loans, owner deposits
- total_withdrawals: Sum of all debits/withdrawals
- average_daily_balance: Average daily balance
- opening_balance: Balance at the start of the month (first day's beginning balance)
- ending_balance: Balance at the end of the month (last day's ending balance)
- lowest_daily_balance: Minimum/lowest balance during the month
- num_deposits: Count of deposit transactions
- nsf_count: Number of NSF/overdraft fees
- days_negative: Days with negative balance

IMPORTANT - Extract ALL individual transactions:
- deposit_list: Array of ALL deposit/credit transactions with date, description, and amount
- exclusion_list: Array of deposits that were EXCLUDED from true revenue (internal transfers, loan proceeds, owner contributions) with date, description, amount, and reason for exclusion
- withdrawal_list: Array of significant withdrawals (over $500) with date, description, and amount

Also extract:
- business_name: Business name on the account
- business_address: Business address if visible
- owner_name: Owner/account holder name
- bank_name: Name of the bank
- account_number_last4: Last 4 digits of account

Detect any MCA/debt payments - look for recurring debits to: LIBERTAS, YELLOWSTONE, CREDIBLY, ONDECK, KAPITUS, FUNDFI, BITTY, CLEARFUND, BLUEVINE, FUNDBOX, KABBAGE, CAN CAPITAL, FORWARD FINANCING, etc.

Return ONLY valid JSON:
{
  "month": "Month Year",
  "total_deposits": 0,
  "true_revenue": 0,
  "total_withdrawals": 0,
  "average_daily_balance": 0,
  "opening_balance": 0,
  "ending_balance": 0,
  "lowest_daily_balance": 0,
  "num_deposits": 0,
  "nsf_count": 0,
  "days_negative": 0,
  "deposit_list": [{"date": "MM/DD", "description": "DEPOSIT DESC", "amount": 0}],
  "exclusion_list": [{"date": "MM/DD", "description": "TRANSFER DESC", "amount": 0, "reason": "internal transfer"}],
  "withdrawal_list": [{"date": "MM/DD", "description": "WITHDRAWAL DESC", "amount": 0}],
  "business_name": "",
  "business_address": "",
  "owner_name": "",
  "bank_name": "",
  "account_number_last4": "",
  "detected_mca_payments": [{"name": "LENDER NAME", "amount": 0}],
  "existing_debt": [],
  "red_flags": []
}` },
                ...images.map(d => ({ inlineData: { mimeType: 'image/jpeg', data: d } }))
            ];

            try {
                const model = getSelectedModel();
                console.log(`Extracting statement ${fileIndex + 1} with model: ${model}, pages: ${images.length}`);

                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts }],
                        generationConfig: { temperature: 0.1, maxOutputTokens: 65536 }
                    })
                });

                const data = await resp.json();

                // Check for API errors
                if (data.error) {
                    console.error(`API error for statement ${fileIndex + 1}:`, data.error);
                    return null;
                }

                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                if (!text) {
                    console.error(`Empty response for statement ${fileIndex + 1}:`, data);
                    return null;
                }

                // Log finish reason to check for truncation
                const finishReason = data.candidates?.[0]?.finishReason;
                console.log(`Statement ${fileIndex + 1} finish reason: ${finishReason}, response length: ${text.length}`);

                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                // Try to fix truncated JSON by closing brackets
                if (!text.endsWith('}')) {
                    console.warn(`Statement ${fileIndex + 1} JSON appears truncated, attempting to fix...`);
                    // Count open brackets and close them
                    const openBraces = (text.match(/\{/g) || []).length;
                    const closeBraces = (text.match(/\}/g) || []).length;
                    const openBrackets = (text.match(/\[/g) || []).length;
                    const closeBrackets = (text.match(/\]/g) || []).length;

                    // Close any open arrays first, then objects
                    for (let i = 0; i < openBrackets - closeBrackets; i++) text += ']';
                    for (let i = 0; i < openBraces - closeBraces; i++) text += '}';
                }

                const result = JSON.parse(text);
                console.log(`Statement ${fileIndex + 1} parsed successfully:`, result.month);
                return result;
            } catch (e) {
                console.error(`Extract error for file ${fileIndex}:`, e);
                return null;
            }
        }

        // Simple extraction function - no live updates, just loading animation
        async function extractBankDataSimple(apiKey) {
            // Timeout wrapper to prevent stuck requests from blocking others
            const withTimeout = (promise, ms, label) => {
                return Promise.race([
                    promise,
                    new Promise((_, reject) =>
                        setTimeout(() => reject(new Error(`${label} timed out after ${ms/1000}s`)), ms)
                    )
                ]);
            };

            const extractWithRetry = async (file, index, maxRetries = 2) => {
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    try {
                        // 90 second timeout per extraction attempt
                        const result = await withTimeout(
                            extractSingleStatement(file, apiKey, index),
                            90000,
                            `Statement ${index + 1}`
                        );
                        if (result && result.month) {
                            console.log(` Statement ${index + 1} extracted: ${result.month}`);
                            return result;
                        }
                        console.warn(`Statement ${index + 1} attempt ${attempt + 1}: Invalid response, retrying...`);
                    } catch (e) {
                        console.error(`Statement ${index + 1} attempt ${attempt + 1} failed:`, e);
                    }
                    if (attempt < maxRetries) {
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
                console.error(` Statement ${index + 1} failed after ${maxRetries + 1} attempts`);
                return null;
            };

            // Extract all statements in parallel for speed
            showLoading(true, `Extracting ${files.length} statements in parallel...`, {
                step: 'extract',
                progress: 35,
                subtext: `Processing all documents simultaneously`
            });

            let completedCount = 0;
            const updateExtractionProgress = () => {
                completedCount++;
                const progress = 30 + Math.round((completedCount / files.length) * 25);
                showLoading(true, `Extracted ${completedCount} of ${files.length} statements...`, {
                    step: 'extract',
                    progress: progress,
                    subtext: `${files.length - completedCount} remaining`
                });
            };

            const results = await Promise.all(
                files.map(async (file, i) => {
                    const result = await extractWithRetry(file, i);
                    updateExtractionProgress();

                    // Store business info from first successful result
                    if (result && !extractedBusinessInfo.name) {
                        const businessName = result.business_name || result.account_holder || '';
                        if (businessName) {
                            extractedBusinessInfo.name = businessName;
                            extractedBusinessInfo.owner = result.owner_name || '';
                            extractedBusinessInfo.address = result.business_address || '';
                        }
                    }
                    return result;
                })
            );

            const successCount = results.filter(r => r !== null).length;
            console.log(`Extraction complete: ${successCount}/${files.length} statements successful`);

            // Build months array from successful extractions (include itemized lists for popups)
            const months = results.filter(r => r !== null).map(r => ({
                month: r.month || 'Unknown',
                total_deposits: r.total_deposits || 0,
                true_revenue: r.true_revenue || 0,
                total_withdrawals: r.total_withdrawals || 0,
                average_daily_balance: r.average_daily_balance || 0,
                opening_balance: r.opening_balance || 0,
                ending_balance: r.ending_balance || 0,
                lowest_daily_balance: r.lowest_daily_balance || 0,
                num_deposits: r.num_deposits || 0,
                nsf_count: r.nsf_count || 0,
                days_negative: r.days_negative || 0,
                // Include itemized transaction lists for popup detail views
                deposit_list: r.deposit_list || [],
                exclusion_list: r.exclusion_list || [],
                withdrawal_list: r.withdrawal_list || [],
                mca_payments: r.detected_mca_payments || []
            }));

            // Sort chronologically
            months.sort((a, b) => new Date(a.month) - new Date(b.month));

            // Collect MCA/debt info
            const mcaLenderMap = new Map();
            const allDebt = [];
            const allRedFlags = [];
            let businessInfo = { business_name: '', owner_name: '', business_address: '' };
            let accountInfo = { bank_name: '', account_holder: '', account_number_last4: '' };

            results.filter(r => r !== null).forEach(r => {
                if (r.detected_mca_payments) {
                    r.detected_mca_payments.forEach(m => {
                        let lenderName = typeof m === 'string' ? m : (m.name || m.lender || m.payee || '');
                        let amount = typeof m === 'object' ? (m.amount || m.payment_amount || 0) : 0;
                        if (lenderName) {
                            const key = lenderName.toLowerCase().trim();
                            if (!mcaLenderMap.has(key)) {
                                mcaLenderMap.set(key, { name: lenderName, payments: [], totalAmount: 0 });
                            }
                            const entry = mcaLenderMap.get(key);
                            entry.payments.push({ amount, month: r.month });
                            entry.totalAmount += amount;
                        }
                    });
                }
                if (r.identified_debt) allDebt.push(...(Array.isArray(r.identified_debt) ? r.identified_debt : [r.identified_debt]));
                if (r.red_flags) allRedFlags.push(...(Array.isArray(r.red_flags) ? r.red_flags : [r.red_flags]));
                if (r.business_name && !businessInfo.business_name) businessInfo.business_name = r.business_name;
                if (r.owner_name && !businessInfo.owner_name) businessInfo.owner_name = r.owner_name;
                if (r.business_address && !businessInfo.business_address) businessInfo.business_address = r.business_address;
                if (r.bank_name && !accountInfo.bank_name) accountInfo.bank_name = r.bank_name;
                if (r.account_holder && !accountInfo.account_holder) accountInfo.account_holder = r.account_holder;
                if (r.account_number_last4 && !accountInfo.account_number_last4) accountInfo.account_number_last4 = r.account_number_last4;
            });

            // Calculate aggregates for credit scoring
            const numMonths = months.length || 1;
            const totals = months.reduce((acc, m) => ({
                deposits: acc.deposits + (m.total_deposits || 0),
                trueRevenue: acc.trueRevenue + (m.true_revenue || 0),
                withdrawals: acc.withdrawals + (m.total_withdrawals || 0),
                avgBal: acc.avgBal + (m.average_daily_balance || 0),
                endBal: acc.endBal + (m.ending_balance || 0),
                numDeps: acc.numDeps + (m.num_deposits || 0),
                nsf: acc.nsf + (m.nsf_count || 0),
                negDays: acc.negDays + (m.days_negative || 0)
            }), { deposits: 0, trueRevenue: 0, withdrawals: 0, avgBal: 0, endBal: 0, numDeps: 0, nsf: 0, negDays: 0 });

            const aggregated = {
                avg_monthly_deposits: Math.round(totals.deposits / numMonths),
                avg_monthly_true_revenue: Math.round(totals.trueRevenue / numMonths),
                avg_monthly_balance: Math.round(totals.avgBal / numMonths),
                avg_ending_balance: Math.round(totals.endBal / numMonths),
                total_nsf_fees: totals.nsf,
                total_negative_days: totals.negDays,
                avg_num_deposits: Math.round(totals.numDeps / numMonths),
                months_analyzed: numMonths,
                detected_mca_lenders: Array.from(mcaLenderMap.values())
            };

            return {
                months,
                mca_positions: Array.from(mcaLenderMap.values()),
                identified_debt: allDebt,
                red_flags: [...new Set(allRedFlags)],
                business_info: businessInfo,
                account_info: accountInfo,
                // For credit score compatibility
                full_analysis: {
                    months,
                    aggregated,
                    business_info: businessInfo,
                    account_info: accountInfo,
                    existing_debt: allDebt,
                    red_flags: [...new Set(allRedFlags)]
                },
                // Direct access for lender matching
                monthly_deposits: aggregated.avg_monthly_deposits,
                average_daily_balance: aggregated.avg_monthly_balance,
                nsf_negative_days: aggregated.total_negative_days,
                num_deposits_monthly: aggregated.avg_num_deposits
            };
        }

        // Store live extraction results globally for click handlers
        let liveExtractionResults = [];

        // Statement viewer state
        let currentViewerFileIndex = -1;
        let currentViewerPage = 0;

        // Open statement PDF/image viewer for a specific month
        function openStatementViewer(monthIndex) {
            // The files array index should correspond to the extraction order
            // but we need to match by month data since extractions happen in parallel
            const monthData = liveExtractionResults[monthIndex];
            if (!monthData) return;

            // Find the corresponding file by index (files are processed in order)
            // Note: After parallel extraction, results maintain file order
            const fileIndex = monthIndex;
            const file = files[fileIndex];

            if (!file) {
                showStatus('Statement file not found', 'error');
                return;
            }

            currentViewerFileIndex = fileIndex;
            currentViewerPage = 0;

            // Update modal title
            document.getElementById('statementViewerTitle').textContent =
                `${monthData.month || 'Bank Statement'} - ${file.name}`;

            // Render the page
            renderStatementPage();

            // Open the modal
            openModal('statementViewerModal');
        }

        function renderStatementPage() {
            const file = files[currentViewerFileIndex];
            if (!file || !file.pages || file.pages.length === 0) return;

            const content = document.getElementById('statementViewerContent');
            const page = file.pages[currentViewerPage];

            // Update page indicator
            document.getElementById('pageIndicator').textContent =
                `Page ${currentViewerPage + 1} of ${file.pages.length}`;

            // Enable/disable navigation buttons
            document.getElementById('prevPageBtn').disabled = currentViewerPage === 0;
            document.getElementById('nextPageBtn').disabled = currentViewerPage >= file.pages.length - 1;

            // Render the page image
            content.innerHTML = `
                <img src="${page.src}" alt="Statement page ${currentViewerPage + 1}"
                     style="max-width: 100%; height: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            `;
        }

        function navigateStatementPage(direction) {
            const file = files[currentViewerFileIndex];
            if (!file || !file.pages) return;

            const newPage = currentViewerPage + direction;
            if (newPage >= 0 && newPage < file.pages.length) {
                currentViewerPage = newPage;
                renderStatementPage();
            }
        }

        // Show cell detail popup with transaction breakdown
        function showCellDetail(monthIndex, field) {
            const data = liveExtractionResults[monthIndex];
            if (!data) return;

            // If clicking on month, open the PDF viewer for that statement
            if (field === 'month') {
                openStatementViewer(monthIndex);
                return;
            }

            const fieldLabels = {
                month: 'Statement Period',
                deposits: 'Total Deposits',
                true_revenue: 'True Revenue',
                num_deposits: 'Number of Deposits',
                withdrawals: 'Total Withdrawals',
                avg_balance: 'Average Daily Balance',
                open_balance: 'Opening Balance',
                end_balance: 'Ending Balance',
                nsf: 'NSF/Overdraft Items',
                neg_days: 'Days Negative'
            };

            const fieldValues = {
                month: data.month || 'Unknown',
                deposits: `$${(data.total_deposits || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                true_revenue: `$${(data.true_revenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                num_deposits: data.num_deposits || 0,
                withdrawals: `$${(data.total_withdrawals || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                avg_balance: `$${(data.average_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                open_balance: `$${(data.opening_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                end_balance: `$${(data.ending_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`,
                nsf: data.nsf_count || 0,
                neg_days: data.days_negative || 0
            };

            const fieldDetails = {
                month: 'Bank statement period analyzed.',
                deposits: 'Sum of all credits and deposits for this statement period.',
                true_revenue: 'Deposits minus internal transfers, loan proceeds, and owner contributions.',
                num_deposits: 'Total count of individual deposit transactions.',
                withdrawals: 'Sum of all debits and withdrawals for this statement period.',
                avg_balance: 'Average of all daily ending balances throughout the month.',
                open_balance: 'Account balance at the start of the statement period.',
                end_balance: 'Account balance at the end of the statement period.',
                nsf: 'Non-sufficient funds fees and overdraft charges detected.',
                neg_days: 'Number of days the account had a negative balance.'
            };

            // Build additional context based on field type
            let additionalContent = '';

            // Show withdrawals with itemized list and MCA payments
            if (field === 'withdrawals') {
                const withdrawals = data.withdrawal_list || [];
                const mcaPayments = data.detected_mca_payments || [];

                // Build itemized withdrawal list (show top 15)
                const withdrawalItems = withdrawals.slice(0, 15).map(w => `
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <span style="color: var(--text-muted); margin-right: 8px;">${w.date || ''}</span>
                            <span style="color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(w.description || '').substring(0, 30)}</span>
                        </div>
                        <span style="color: var(--red); font-weight: 500; margin-left: 8px;">$${(w.amount || 0).toLocaleString()}</span>
                    </div>
                `).join('');

                // Build MCA payment items
                const mcaItems = mcaPayments.map(m => {
                    const name = typeof m === 'object' ? (m.name || m.lender || 'Unknown') : m;
                    const amt = typeof m === 'object' && m.amount ? `$${m.amount.toLocaleString()}` : '';
                    return `<div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(239, 68, 68, 0.15); border-left: 3px solid var(--red); border-radius: 4px; margin-bottom: 6px;">
                        <span style="color: var(--red); font-weight: 600;">${name}</span>
                        ${amt ? `<span style="color: var(--text);">${amt}</span>` : ''}
                    </div>`;
                }).join('');

                additionalContent = `
                    ${mcaPayments.length > 0 ? `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600;"> MCA Payments Detected (${mcaPayments.length})</div>
                            ${mcaItems}
                        </div>
                    ` : ''}
                    ${withdrawals.length > 0 ? `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Significant Withdrawals (${withdrawals.length})</div>
                            <div style="max-height: 250px; overflow-y: auto;">
                                ${withdrawalItems}
                                ${withdrawals.length > 15 ? `<div style="text-align: center; color: var(--text-muted); font-size: 11px; padding: 8px;">... and ${withdrawals.length - 15} more</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
            }

            // Show breakdown for deposits with itemized lists
            if (field === 'deposits' || field === 'true_revenue') {
                const trueRev = data.true_revenue || 0;
                const totalDep = data.total_deposits || 0;
                const excluded = totalDep - trueRev;
                const deposits = data.deposit_list || [];
                const exclusions = data.exclusion_list || [];

                // Build itemized deposit list (show top 10)
                const depositItems = deposits.slice(0, 10).map(d => `
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <span style="color: var(--text-muted); margin-right: 8px;">${d.date || ''}</span>
                            <span style="color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(d.description || '').substring(0, 30)}</span>
                        </div>
                        <span style="color: var(--green); font-weight: 500; margin-left: 8px;">$${(d.amount || 0).toLocaleString()}</span>
                    </div>
                `).join('');

                // Build exclusion list
                const exclusionItems = exclusions.map(e => `
                    <div style="display: flex; justify-content: space-between; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; margin-bottom: 4px; font-size: 12px;">
                        <div style="flex: 1; min-width: 0;">
                            <span style="color: var(--text-muted); margin-right: 8px;">${e.date || ''}</span>
                            <span style="color: var(--text-secondary);">${(e.description || '').substring(0, 25)}</span>
                            <span style="color: var(--gold); font-size: 10px; margin-left: 4px;">(${e.reason || 'excluded'})</span>
                        </div>
                        <span style="color: var(--red); font-weight: 500; margin-left: 8px;">-$${(e.amount || 0).toLocaleString()}</span>
                    </div>
                `).join('');

                additionalContent = `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Summary</div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">Gross Deposits (${deposits.length} items)</span>
                            <span style="color: var(--green); font-weight: 500;">$${totalDep.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">Excluded (${exclusions.length} items)</span>
                            <span style="color: var(--red);">-$${excluded.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; font-weight: 600;">
                            <span style="color: var(--text);">True Revenue</span>
                            <span style="color: var(--gold);">$${trueRev.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>
                    ${deposits.length > 0 ? `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="font-size: 11px; color: var(--green); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600;">Deposits (${deposits.length} transactions)</div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${depositItems}
                                ${deposits.length > 10 ? `<div style="text-align: center; color: var(--text-muted); font-size: 11px; padding: 8px;">... and ${deposits.length - 10} more</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    ${exclusions.length > 0 ? `
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="font-size: 11px; color: var(--red); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600;">Excluded from True Revenue (${exclusions.length})</div>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${exclusionItems}
                            </div>
                        </div>
                    ` : ''}
                `;
            }

            // Show balance analysis
            if (field === 'avg_balance' || field === 'open_balance' || field === 'end_balance') {
                additionalContent = `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Balance Summary</div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">Opening Balance</span>
                            <span style="color: var(--text);">$${(data.opening_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">Lowest Balance</span>
                            <span style="color: ${(data.lowest_daily_balance || 0) < 0 ? 'var(--red)' : 'var(--text)'};">$${(data.lowest_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">Average Balance</span>
                            <span style="color: var(--text); font-weight: 500;">$${(data.average_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span style="color: var(--text-secondary);">Ending Balance</span>
                            <span style="color: ${(data.ending_balance || 0) < 0 ? 'var(--red)' : 'var(--text)'};">$${(data.ending_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>
                `;
            }

            // Show risk info for NSF/Neg days
            if (field === 'nsf' || field === 'neg_days') {
                const nsfCount = data.nsf_count || 0;
                const negDays = data.days_negative || 0;
                const riskLevel = (nsfCount > 3 || negDays > 5) ? 'High' : (nsfCount > 0 || negDays > 0) ? 'Medium' : 'Low';
                const riskColor = riskLevel === 'High' ? 'var(--red)' : riskLevel === 'Medium' ? 'var(--gold)' : 'var(--green)';
                additionalContent = `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">Risk Assessment</div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">NSF/Overdraft Items</span>
                            <span style="color: ${nsfCount > 0 ? 'var(--red)' : 'var(--green)'}; font-weight: 500;">${nsfCount}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="color: var(--text-secondary);">Days Negative</span>
                            <span style="color: ${negDays > 0 ? 'var(--red)' : 'var(--green)'}; font-weight: 500;">${negDays}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                            <span style="color: var(--text-secondary);">Risk Level</span>
                            <span style="color: ${riskColor}; font-weight: 600;">${riskLevel}</span>
                        </div>
                    </div>
                `;
            }

            // Saturn logo SVG
            const saturnLogo = `<svg viewBox="0 0 64 64" fill="none" style="width: 32px; height: 32px;">
                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                <circle cx="32" cy="32" r="12" fill="#eab308"/>
                <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
            </svg>`;

            // Create popup
            const popup = document.createElement('div');
            popup.id = 'cellDetailPopup';
            popup.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 24px; z-index: 10000; min-width: 420px; max-width: 520px; max-height: 85vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.4);';
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        ${saturnLogo}
                        <div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--text);">Ables AI</div>
                            <div style="font-size: 12px; color: var(--gold); font-weight: 500;">${data.month}</div>
                        </div>
                    </div>
                    <button onclick="document.getElementById('cellDetailPopup').remove(); document.getElementById('cellDetailOverlay').remove();" style="background: var(--bg-tertiary); border: none; color: var(--text-muted); cursor: pointer; font-size: 18px; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>
                <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">${fieldLabels[field]}</div>
                <div style="font-size: 32px; font-weight: 700; color: var(--text); margin-bottom: 8px;">${fieldValues[field]}</div>
                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">${fieldDetails[field]}</div>
                ${additionalContent}
            `;

            const overlay = document.createElement('div');
            overlay.id = 'cellDetailOverlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(4px);';
            overlay.onclick = () => { popup.remove(); overlay.remove(); };

            document.body.appendChild(overlay);
            document.body.appendChild(popup);
        }

        // Live rendering - shows each statement as horizontal table rows with clickable cells
        function renderExtractedDataLive(extractedResults) {
            liveExtractionResults = extractedResults;
            const container = document.getElementById('extractedData');

            // Determine which row is currently being processed
            // extractedResults.length tells us how many have been processed (including failures)
            // The currently processing index is extractedResults.length (next one to be added)
            const numProcessed = extractedResults.length;
            const currentlyProcessingIndex = numProcessed; // The one we're working on next

            // Build rows for each statement - show skeleton for all rows upfront
            const statementRows = files.map((f, i) => {
                // Check if this row has been processed yet
                const hasBeenProcessed = i < numProcessed;
                const data = hasBeenProcessed ? extractedResults[i] : undefined;
                const isCurrentlyProcessing = (i === currentlyProcessingIndex);
                const isFailed = hasBeenProcessed && data === null;
                const isWaiting = !hasBeenProcessed && !isCurrentlyProcessing;
                const hasData = hasBeenProcessed && data !== null;

                if (isFailed) {
                    // Show error row for failed extraction
                    const fileName = f.name.length > 25 ? f.name.substring(0, 22) + '...' : f.name;
                    return `
                        <tr style="opacity: 0.6; background: rgba(239, 68, 68, 0.05);">
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); border-left: 3px solid var(--red); white-space: nowrap;">
                                <span style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span style="color: var(--red);"></span>
                                    <span style="color: var(--red); font-size: 12px;">${fileName}</span>
                                </span>
                            </td>
                            <td colspan="9" style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center; color: var(--text-muted); font-size: 12px;">
                                Extraction failed - check console for details
                            </td>
                        </tr>
                    `;
                }

                if (!hasData) {
                    // Show skeleton row - animated if currently processing, dimmed if waiting
                    const rowOpacity = isCurrentlyProcessing ? '1' : '0.5';
                    const fileName = f.name.length > 20 ? f.name.substring(0, 17) + '...' : f.name;
                    const shimmerStyle = isCurrentlyProcessing ? 'animation: shimmer 1.5s ease-in-out infinite;' : '';

                    return `
                        <tr style="opacity: ${rowOpacity}; transition: opacity 0.3s ease;">
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); white-space: nowrap;">
                                ${isCurrentlyProcessing ? `
                                    <span style="display: inline-flex; align-items: center; gap: 8px;">
                                        <span style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--blue); border-top-color: transparent; animation: spin 0.8s linear infinite; display: inline-block;"></span>
                                        <span style="color: var(--blue); font-weight: 500;">Processing...</span>
                                    </span>
                                ` : `
                                    <span style="color: var(--text-muted); font-size: 12px;">${fileName}</span>
                                `}
                            </td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 80px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 80px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;"><div style="width: 30px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 80px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 70px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 70px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 70px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;"><div style="width: 30px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto; ${shimmerStyle}"></div></td>
                            <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;"><div style="width: 30px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto; ${shimmerStyle}"></div></td>
                        </tr>
                    `;
                }

                // Has data - show full row with clickable cells
                const hasNSF = (data.nsf_count || 0) > 0;
                const hasNeg = (data.days_negative || 0) > 0;

                return `
                    <tr style="animation: slideInFadeIn 0.3s ease-out;">
                        <td class="clickable-cell" data-month="${i}" data-field="month" style="padding: 12px; border-bottom: 1px solid var(--border); border-left: 3px solid ${hasNSF || hasNeg ? 'var(--red)' : 'var(--green)'}; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            <span style="color: var(--text);">${data.month || 'Unknown'}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="deposits" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: right; white-space: nowrap;">
                            <span style="color: var(--green); font-weight: 500;">$${(data.total_deposits || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="true_revenue" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: right; white-space: nowrap;">
                            <span style="color: var(--gold); font-weight: 500;">$${(data.true_revenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="num_deposits" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: center;">
                            <span style="color: var(--text-secondary);">${data.num_deposits || 0}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="withdrawals" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: right; white-space: nowrap;">
                            <span style="color: var(--red); font-weight: 500;">$${(data.total_withdrawals || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="avg_balance" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: right; white-space: nowrap;">
                            <span style="color: var(--text);">$${(data.average_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="open_balance" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: right; white-space: nowrap;">
                            <span style="color: var(--text-secondary);">$${(data.opening_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="end_balance" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: right; white-space: nowrap;">
                            <span style="color: ${(data.ending_balance || 0) < 0 ? 'var(--red)' : 'var(--text)'};">$${(data.ending_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="nsf" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: center;">
                            <span style="color: ${hasNSF ? 'var(--red)' : 'var(--text-muted)'}; font-weight: ${hasNSF ? '700' : '400'};">${data.nsf_count || 0}</span>
                        </td>
                        <td class="clickable-cell" data-month="${i}" data-field="neg_days" style="padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; text-align: center;">
                            <span style="color: ${hasNeg ? 'var(--red)' : 'var(--text-muted)'}; font-weight: ${hasNeg ? '700' : '400'};">${data.days_negative || 0}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Calculate running totals (filter out nulls first)
            const validResults = extractedResults.filter(r => r !== null);
            const extractedCount = validResults.length;
            const totals = validResults.reduce((acc, m) => ({
                deposits: acc.deposits + (m.total_deposits || 0),
                trueRevenue: acc.trueRevenue + (m.true_revenue || 0),
                withdrawals: acc.withdrawals + (m.total_withdrawals || 0),
                avgBalSum: acc.avgBalSum + (m.average_daily_balance || 0),
                numDeps: acc.numDeps + (m.num_deposits || 0),
                nsf: acc.nsf + (m.nsf_count || 0),
                negDays: acc.negDays + (m.days_negative || 0)
            }), { deposits: 0, trueRevenue: 0, withdrawals: 0, avgBalSum: 0, numDeps: 0, nsf: 0, negDays: 0 });

            // Averages row - must have 10 columns to match headers and data rows
            const avgRow = extractedCount > 0 ? `
                <tr style="background: var(--bg-tertiary); font-weight: 600;">
                    <td style="padding: 14px 16px;"><span style="color: var(--text); text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px;">AVERAGE</span></td>
                    <td style="padding: 14px 12px; text-align: right;"><span style="color: var(--green);">$${(totals.deposits / extractedCount).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></td>
                    <td style="padding: 14px 12px; text-align: right;"><span style="color: var(--gold);">$${(totals.trueRevenue / extractedCount).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></td>
                    <td style="padding: 14px 12px; text-align: center;"><span style="color: var(--text-secondary);">${Math.round(totals.numDeps / extractedCount)}</span></td>
                    <td style="padding: 14px 12px; text-align: right;"><span style="color: var(--red);">$${(totals.withdrawals / extractedCount).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></td>
                    <td style="padding: 14px 12px; text-align: right;"><span style="color: var(--text);">$${(totals.avgBalSum / extractedCount).toLocaleString('en-US', {minimumFractionDigits: 2})}</span></td>
                    <td style="padding: 14px 12px; text-align: right;"><span style="color: var(--text-muted);">-</span></td>
                    <td style="padding: 14px 12px; text-align: right;"><span style="color: var(--text-muted);">-</span></td>
                    <td style="padding: 14px 12px; text-align: center;"><span style="color: ${totals.nsf > 0 ? 'var(--red)' : 'var(--text-muted)'};">${totals.nsf}</span></td>
                    <td style="padding: 14px 12px; text-align: center;"><span style="color: ${totals.negDays > 0 ? 'var(--red)' : 'var(--text-muted)'};">${totals.negDays}</span></td>
                </tr>
            ` : '';

            container.innerHTML = `
                <!-- Progress indicator -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 14px 18px; background: var(--bg-tertiary); border-radius: 10px; border: 1px solid var(--border);">
                    <div style="font-size: 14px; font-weight: 600; color: var(--text);">
                        ${extractedCount < files.length ? 'Extracting' : 'Extracted'} ${extractedCount} of ${files.length} statements
                    </div>
                    <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${(extractedCount / files.length) * 100}%; height: 100%; background: ${extractedCount === files.length ? 'var(--green)' : 'var(--blue)'}; transition: width 0.3s ease;"></div>
                    </div>
                    ${extractedCount === files.length ? '<div style="color: var(--green); font-size: 12px; font-weight: 600;"> Complete</div>' : ''}
                </div>

                <!-- Data Table -->
                <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 10px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 1000px;">
                        <thead>
                            <tr style="background: var(--bg-tertiary);">
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Month</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Deposits</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">True Rev</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">#</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Withdrawals</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Avg Bal</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Open Bal</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">End Bal</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">NSF</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Neg</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${statementRows}
                        </tbody>
                        <tfoot>
                            ${avgRow}
                        </tfoot>
                    </table>
                </div>

                <div style="margin-top: 12px; font-size: 11px; color: var(--text-muted); text-align: center;">
                    Click any cell to view details
                </div>
            `;
        }

        function renderExtractedData() {
            if (!extractedData || !extractedData.full_analysis) {
                console.error('renderExtractedData: No extracted data available', extractedData);
                document.getElementById('extractedData').innerHTML = '<div class="placeholder" style="text-align: center; padding: 40px; color: var(--text-muted);">No data extracted. Check console for errors.</div>';
                return;
            }

            const analysis = extractedData.full_analysis;
            const agg = analysis.aggregated || {};
            const months = analysis.months || [];
            const mcaLenders = agg.detected_mca_lenders || [];
            const flags = analysis.red_flags || [];

            // Calculate totals
            const totals = months.reduce((acc, m) => ({
                deposits: acc.deposits + (m.total_deposits || 0),
                trueRevenue: acc.trueRevenue + (m.true_revenue || m.total_deposits * 0.92 || 0),
                withdrawals: acc.withdrawals + (m.total_withdrawals || 0),
                numDeps: acc.numDeps + (m.num_deposits || 0),
                nsf: acc.nsf + (m.nsf_count || 0),
                negDays: acc.negDays + (m.days_negative || 0),
                avgBalSum: acc.avgBalSum + (m.average_daily_balance || 0)
            }), { deposits: 0, trueRevenue: 0, withdrawals: 0, numDeps: 0, nsf: 0, negDays: 0, avgBalSum: 0 });

            const numMonths = months.length || 1;
            const avgBalance = Math.round(totals.avgBalSum / numMonths);

            document.getElementById('extractedData').innerHTML = `
                <!-- Risk Summary -->
                <div class="risk-summary">
                    <div class="risk-chip ${totals.nsf === 0 ? 'good' : totals.nsf <= 3 ? 'warn' : 'bad'}">
                        <div class="risk-chip-value">${totals.nsf}</div>
                        <div class="risk-chip-label">NSF Items</div>
                    </div>
                    <div class="risk-chip ${totals.negDays === 0 ? 'good' : totals.negDays <= 5 ? 'warn' : 'bad'}">
                        <div class="risk-chip-value">${totals.negDays}</div>
                        <div class="risk-chip-label">Neg Days</div>
                    </div>
                    <div class="risk-chip ${mcaLenders.length === 0 ? 'good' : mcaLenders.length <= 2 ? 'warn' : 'bad'}">
                        <div class="risk-chip-value">${mcaLenders.length}</div>
                        <div class="risk-chip-label">MCA Found</div>
                    </div>
                    <div class="risk-chip">
                        <div class="risk-chip-value">${Math.round(totals.numDeps / numMonths)}</div>
                        <div class="risk-chip-label">Deps/Month</div>
                    </div>
                </div>

                <!-- Monthly Table with Clickable Cells -->
                ${months.length > 0 ? `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Deposits</th>
                                <th>True Rev</th>
                                <th>#</th>
                                <th>Withdrawals</th>
                                <th>Avg Bal</th>
                                <th>Open Bal</th>
                                <th>End Bal</th>
                                <th>NSF</th>
                                <th>Neg</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${months.map((m, idx) => `
                                <tr>
                                    <td class="clickable-cell" data-month="${idx}" data-field="month" style="font-weight: 500; cursor: pointer;">${m.month || 'N/A'}</td>
                                    <td class="clickable-cell text-green" data-month="${idx}" data-field="deposits" style="cursor: pointer;">$${(m.total_deposits || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="clickable-cell text-gold" data-month="${idx}" data-field="true_revenue" style="cursor: pointer;">$${(m.true_revenue || (m.total_deposits || 0) * 0.92).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="clickable-cell" data-month="${idx}" data-field="num_deposits" style="cursor: pointer;">${m.num_deposits || 0}</td>
                                    <td class="clickable-cell text-red" data-month="${idx}" data-field="withdrawals" style="cursor: pointer;">$${(m.total_withdrawals || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="clickable-cell" data-month="${idx}" data-field="avg_balance" style="cursor: pointer;">$${(m.average_daily_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="clickable-cell ${(m.opening_balance || 0) < 0 ? 'text-red' : ''}" data-month="${idx}" data-field="open_balance" style="cursor: pointer;">$${(m.opening_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="clickable-cell ${(m.ending_balance || 0) < 0 ? 'text-red' : ''}" data-month="${idx}" data-field="end_balance" style="cursor: pointer;">$${(m.ending_balance || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                    <td class="clickable-cell ${(m.nsf_count || 0) > 0 ? 'text-red' : ''}" data-month="${idx}" data-field="nsf" style="cursor: pointer;">${m.nsf_count || 0}</td>
                                    <td class="clickable-cell ${(m.days_negative || 0) > 0 ? 'text-red' : ''}" data-month="${idx}" data-field="neg_days" style="cursor: pointer;">${m.days_negative || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>AVERAGE</strong></td>
                                <td>$${(totals.deposits / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>$${(totals.trueRevenue / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>${Math.round(totals.numDeps / numMonths)}</td>
                                <td>$${(totals.withdrawals / numMonths).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>$${avgBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                <td>-</td>
                                <td>-</td>
                                <td>${(totals.nsf / numMonths).toFixed(2)}</td>
                                <td>${(totals.negDays / numMonths).toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                ` : '<p style="color: var(--text-muted); text-align: center;">No monthly data extracted</p>'}

                ${mcaLenders.length > 0 ? `
                <div class="mca-section">
                    <div class="mca-header">
                        <div class="mca-icon">!</div>
                        <div class="mca-title">
                            <h3>Existing MCA Positions Detected</h3>
                            <p>Active merchant cash advance obligations identified</p>
                        </div>
                        <div class="mca-count-badge">${mcaLenders.length} Lender${mcaLenders.length > 1 ? 's' : ''}</div>
                    </div>
                    <div class="mca-lender-list">
                        ${mcaLenders.map((l, idx) => {
                            const name = typeof l === 'object' ? (l.name || 'Unknown Lender') : l;
                            const amount = typeof l === 'object' && l.amount ? l.amount : 0;
                            const count = typeof l === 'object' && l.count ? l.count : 1;
                            return `
                            <div class="mca-lender-card">
                                <div class="mca-lender-icon">$</div>
                                <div>
                                    <div class="mca-lender-name">${name}</div>
                                    <div class="mca-lender-status">${count > 1 ? count + ' payments detected' : (amount ? '$' + amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '/week' : 'Active Position')}</div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}

                ${flags.length > 0 ? `
                <div class="mca-alert" style="margin-top: 12px;">
                    <div class="mca-alert-title">Red Flags</div>
                    <ul style="margin: 8px 0 0 16px; font-size: 12px; color: var(--text-secondary);">
                        ${flags.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                ${analysis.underwriting_notes ? `
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                    <div class="data-label">Underwriting Notes</div>
                    <p style="font-size: 13px; line-height: 1.6;">${analysis.underwriting_notes}</p>
                </div>
                ` : ''}
            `;
        }

        function renderCharts() {
            if (!extractedData.full_analysis) return;

            document.getElementById('chartsSection').classList.remove('hidden');
            const months = extractedData.full_analysis.months || [];

            // Destroy existing charts
            if (charts.balance) charts.balance.destroy();
            if (charts.flow) charts.flow.destroy();

            // Recreate the chart container HTML (skeleton may have replaced it)
            const chartsContainer = document.querySelector('#chartsSection .section-body');
            if (chartsContainer) {
                chartsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="balanceChart"></canvas>
                        </div>
                        <div class="chart-container" style="position: relative; height: 250px;">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                `;
            }

            const labels = months.map(m => m.month || '');
            const deposits = months.map(m => m.total_deposits || 0);
            const trueRevenue = months.map(m => m.true_revenue || 0);
            const withdrawals = months.map(m => m.total_withdrawals || 0);
            const balances = months.map(m => m.average_daily_balance || 0);
            const endingBalances = months.map(m => m.ending_balance || 0);
            const openingBalances = months.map(m => m.opening_balance || 0);

            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#a1a1aa' : '#64748b';

            // Shared tooltip configuration
            const tooltipConfig = {
                backgroundColor: isDark ? 'rgba(30, 30, 30, 0.95)' : 'rgba(255, 255, 255, 0.95)',
                titleColor: isDark ? '#fff' : '#1f2937',
                bodyColor: isDark ? '#d1d5db' : '#4b5563',
                borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                borderWidth: 1,
                padding: 12,
                displayColors: true,
                titleFont: { size: 13, weight: 'bold' },
                bodyFont: { size: 12 },
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) label += ': ';
                        if (context.parsed.y !== null) {
                            label += '$' + context.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        }
                        return label;
                    }
                }
            };

            // Balance Chart - Multi-line with avg, opening, ending
            charts.balance = new Chart(document.getElementById('balanceChart'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Avg Daily Balance',
                            data: balances,
                            borderColor: '#eab308',
                            backgroundColor: 'rgba(234, 179, 8, 0.15)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 9,
                            pointBackgroundColor: '#eab308',
                            pointBorderColor: isDark ? '#1f1f1f' : '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Ending Balance',
                            data: endingBalances,
                            borderColor: '#22c55e',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 4,
                            pointHoverRadius: 7,
                            pointBackgroundColor: '#22c55e',
                            pointBorderColor: isDark ? '#1f1f1f' : '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            labels: { color: textColor, usePointStyle: true, pointStyle: 'circle' },
                            onClick: (e, legendItem, legend) => {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                ci.getDatasetMeta(index).hidden = !ci.getDatasetMeta(index).hidden;
                                ci.update();
                            }
                        },
                        tooltip: tooltipConfig
                    },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor } },
                        y: {
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: (value) => '$' + value.toLocaleString()
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const monthIndex = elements[0].index;
                            showCellDetail(monthIndex, 'avg_balance');
                        }
                    }
                }
            });

            // Flow Chart - Stacked bar with deposits, true revenue, withdrawals
            charts.flow = new Chart(document.getElementById('flowChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Total Deposits',
                            data: deposits,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderRadius: 4,
                            hoverBackgroundColor: '#22c55e'
                        },
                        {
                            label: 'True Revenue',
                            data: trueRevenue,
                            backgroundColor: 'rgba(234, 179, 8, 0.7)',
                            borderColor: '#eab308',
                            borderWidth: 2,
                            borderRadius: 4,
                            hoverBackgroundColor: '#eab308'
                        },
                        {
                            label: 'Withdrawals',
                            data: withdrawals,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderRadius: 4,
                            hoverBackgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            labels: { color: textColor, usePointStyle: true, pointStyle: 'rect' },
                            onClick: (e, legendItem, legend) => {
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                ci.getDatasetMeta(index).hidden = !ci.getDatasetMeta(index).hidden;
                                ci.update();
                            }
                        },
                        tooltip: {
                            ...tooltipConfig,
                            callbacks: {
                                ...tooltipConfig.callbacks,
                                afterBody: function(context) {
                                    const idx = context[0].dataIndex;
                                    const dep = deposits[idx];
                                    const rev = trueRevenue[idx];
                                    const diff = dep - rev;
                                    return diff > 0 ? `\nExcluded: $${diff.toLocaleString('en-US', { minimumFractionDigits: 2 })}` : '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor } },
                        y: {
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: (value) => '$' + (value / 1000).toFixed(0) + 'k'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const monthIndex = elements[0].index;
                            const datasetIndex = elements[0].datasetIndex;
                            const field = datasetIndex === 0 ? 'deposits' : datasetIndex === 1 ? 'true_revenue' : 'withdrawals';
                            showCellDetail(monthIndex, field);
                        }
                    }
                }
            });

            // Render debt obligations
            renderDebtObligations();

            // Calculate and render credit score
            calculateCreditScore();
        }

        // Credit Engine V4.2 Scoring Model
        const SCORE_WEIGHTS = {
            credit: 20,      // FICO score weight
            behavior: 15,    // NSF + negative days
            revenue: 30,     // Monthly revenue
            stability: 20,   // Time in business
            buffer: 15       // Avg balance / revenue ratio
        };

        const TIER_CONFIG = {
            A: { min: 80, color: '#10b981', label: 'Prime' },
            B: { min: 65, color: '#22c55e', label: 'Near-Prime' },
            C: { min: 50, color: '#eab308', label: 'Mid-Prime' },
            D: { min: 35, color: '#f97316', label: 'Sub-Prime' },
            E: { min: 0, color: '#ef4444', label: 'High-Risk' }
        };

        // Manual FICO score (user can override via slider or credit report)
        let manualFicoScore = null;

        function getBarColor(pct) {
            if (pct >= 70) return '#10b981';
            if (pct >= 40) return '#eab308';
            return '#ef4444';
        }

        function updateFicoFromSlider(value) {
            const fico = parseInt(value);
            document.getElementById('ficoInput').value = fico;
            manualFicoScore = fico;
            if (extractedData?.full_analysis) {
                calculateCreditScore();
            }
        }

        function updateFicoFromInput(value) {
            let fico = parseInt(value);
            fico = Math.max(450, Math.min(850, fico));
            document.getElementById('ficoSlider').value = fico;
            document.getElementById('ficoInput').value = fico;
            manualFicoScore = fico;
            if (extractedData?.full_analysis) {
                calculateCreditScore();
            }
        }

        async function handleCreditReportUpload(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];

            // Show loading state
            const btn = input.parentElement.querySelector('span');
            const originalText = btn.textContent;
            btn.textContent = 'Extracting...';
            btn.style.background = 'var(--gold)';
            btn.style.color = '#000';

            try {
                const apiKey = document.getElementById('apiKey').value;
                if (!apiKey) {
                    alert('Please enter your Gemini API key first');
                    return;
                }

                // Convert PDF to base64
                const arrayBuffer = await file.arrayBuffer();
                const base64 = btoa(new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), ''));

                // Use Gemini to extract credit score from the report
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { inline_data: { mime_type: 'application/pdf', data: base64 } },
                                { text: 'Extract the credit score from this credit report. Return ONLY a JSON object with: {"score": NUMBER, "bureau": "Experian/Equifax/TransUnion"}. If multiple scores, use the middle one. If no score found, return {"score": null, "bureau": null}.' }
                            ]
                        }],
                        generationConfig: { temperature: 0.1, maxOutputTokens: 256 }
                    })
                });

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                const jsonMatch = text.match(/\{[\s\S]*\}/);

                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    if (result.score && result.score >= 300 && result.score <= 850) {
                        manualFicoScore = result.score;
                        document.getElementById('ficoSlider').value = result.score;
                        document.getElementById('ficoInput').value = result.score;
                        btn.textContent = `${result.bureau || 'Score'}: ${result.score}`;
                        btn.style.background = '#10b981';
                        btn.style.color = '#fff';
                        if (extractedData?.full_analysis) {
                            calculateCreditScore();
                        }
                    } else {
                        btn.textContent = 'No Score Found';
                        btn.style.background = '#ef4444';
                        btn.style.color = '#fff';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '';
                            btn.style.color = '';
                        }, 2000);
                    }
                }
            } catch (e) {
                console.error('Credit report extraction error:', e);
                btn.textContent = 'Error';
                btn.style.background = '#ef4444';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }
        }

        function calculateSuggestedApproval(totalScore, tier, avgRevenue, estimatedFico) {
            // Calculate advance multiplier based on Ables score (1.25x to 1.55x)
            // Score 0 = 1.25x, Score 100 = 1.55x (linear interpolation)
            const advanceMultiplier = 1.25 + (totalScore / 100) * 0.30;

            // Determine approval status and factor rate based on tier
            const tierConfig = {
                A: { rate: 1.15, approval: 'APPROVED' },
                B: { rate: 1.25, approval: 'APPROVED' },
                C: { rate: 1.35, approval: 'CONDITIONAL' },
                D: { rate: 1.45, approval: 'CONDITIONAL' },
                E: { rate: 0, approval: 'DECLINED' }
            };

            const config = tierConfig[tier] || tierConfig.E;

            // Calculate max advance (based on monthly revenue * score-based multiplier)
            let maxAdvance = tier === 'E' ? 0 : Math.round(avgRevenue * advanceMultiplier / 1000) * 1000;
            maxAdvance = Math.min(maxAdvance, 500000); // Cap at 500K
            maxAdvance = Math.max(maxAdvance, 0);

            // Factor rate based on tier
            const factorRate = config.rate;

            // Daily payment (assuming 6-month term, 22 business days/month)
            const totalPayback = maxAdvance * factorRate;
            const dailyPayment = maxAdvance > 0 ? Math.round(totalPayback / (6 * 22)) : 0;

            // Update UI
            const approvalBadge = document.getElementById('approvalBadge');
            const approvalColors = {
                'APPROVED': { bg: '#dcfce7', color: '#16a34a' },
                'CONDITIONAL': { bg: '#fef9c3', color: '#ca8a04' },
                'DECLINED': { bg: '#fee2e2', color: '#dc2626' }
            };
            const colors = approvalColors[config.approval];
            approvalBadge.textContent = config.approval;
            approvalBadge.style.background = colors.bg;
            approvalBadge.style.color = colors.color;

            document.getElementById('suggestedAmount').textContent = maxAdvance > 0 ? '$' + maxAdvance.toLocaleString() : '$0';
            document.getElementById('suggestedRate').textContent = factorRate > 0 ? factorRate.toFixed(2) : '--';
            document.getElementById('suggestedPayment').textContent = dailyPayment > 0 ? '$' + dailyPayment.toLocaleString() : '$0';

            // Approval note with multiplier info
            const noteEl = document.getElementById('approvalNote');
            if (config.approval === 'APPROVED') {
                noteEl.textContent = `Strong profile. FICO ${estimatedFico}, Ables Score ${totalScore}/100 (${advanceMultiplier.toFixed(2)}x multiplier). Recommended for standard terms.`;
                noteEl.style.background = '#dcfce7';
            } else if (config.approval === 'CONDITIONAL') {
                noteEl.textContent = `Review required. FICO ${estimatedFico}, Ables Score ${totalScore}/100 (${advanceMultiplier.toFixed(2)}x multiplier). Consider reduced advance or higher factor.`;
                noteEl.style.background = '#fef9c3';
            } else {
                noteEl.textContent = `Does not meet minimum criteria. FICO ${estimatedFico}, Ables Score ${totalScore}/100. Recommend decline or stip for additional collateral.`;
                noteEl.style.background = '#fee2e2';
            }
        }

        function calculateCreditScore() {
            const analysis = extractedData.full_analysis;
            if (!analysis) return;

            // Get input values from analysis
            const avgRevenue = analysis.aggregated?.avg_monthly_deposits || 0;
            const avgBalance = analysis.aggregated?.avg_ending_balance || 0;

            // Sum up NSF and negative days across all months
            const months = analysis.months || [];
            let totalNsf = 0;
            let totalNegDays = 0;
            months.forEach(m => {
                totalNsf += m.nsf_count || 0;
                totalNegDays += m.negative_days || 0;
            });
            const avgNsf = months.length > 0 ? totalNsf / months.length : 0;
            const avgNegDays = months.length > 0 ? totalNegDays / months.length : 0;

            // Get time in business (use months of statements as proxy, assume 12+ months)
            const tibMonths = Math.max(12, months.length * 3); // Estimate TIB

            // Use manual FICO if set, otherwise estimate from bank behavior
            let estimatedFico;
            if (manualFicoScore !== null) {
                estimatedFico = manualFicoScore;
            } else {
                // Estimate FICO from bank behavior (650 default, adjust for NSF/neg days)
                estimatedFico = 650;
                estimatedFico -= Math.min(100, totalNsf * 15);
                estimatedFico -= Math.min(50, totalNegDays * 5);
                estimatedFico = Math.max(450, Math.min(850, estimatedFico));
                // Update slider/input to show estimated value
                document.getElementById('ficoSlider').value = estimatedFico;
                document.getElementById('ficoInput').value = estimatedFico;
            }

            // Calculate score components using SCORE_WEIGHTS
            // Credit score component (smooth linear scale 450-850)
            const creditPts = estimatedFico < 450 ? 0 : Math.min(SCORE_WEIGHTS.credit, ((estimatedFico - 450) / 400) * SCORE_WEIGHTS.credit);

            // Behavior component (NSF + negative days) - smooth decay
            const events = avgNsf + avgNegDays;
            const behavePts = Math.max(0, SCORE_WEIGHTS.behavior * Math.pow(0.85, events));

            // Revenue component (smooth log scale)
            const revNorm = Math.min(1, Math.log10(Math.max(avgRevenue, 5000) / 5000) / Math.log10(100));
            const revPts = revNorm * SCORE_WEIGHTS.revenue;

            // Stability component (time in business)
            const tibNorm = Math.min(1, tibMonths / 120);
            const stabPts = tibNorm * SCORE_WEIGHTS.stability;

            // Buffer component (avg balance / revenue ratio)
            const bufferRatio = avgRevenue > 0 ? avgBalance / avgRevenue : 0;
            const bufferNorm = Math.min(1, bufferRatio / 0.20);
            const bufferPts = bufferNorm * SCORE_WEIGHTS.buffer;

            // Total score
            let totalScore = Math.round(creditPts + behavePts + revPts + stabPts + bufferPts);
            totalScore = Math.max(0, Math.min(100, totalScore));

            // Determine tier with safety valves
            let tier = 'E';
            if (totalScore >= 80) tier = 'A';
            else if (totalScore >= 65) tier = 'B';
            else if (totalScore >= 50) tier = 'C';
            else if (totalScore >= 35) tier = 'D';

            // Credit score safety valves
            if (estimatedFico < 520) tier = 'E';
            else if (estimatedFico < 550 && ['A', 'B', 'C'].includes(tier)) tier = 'D';
            else if (estimatedFico < 600 && ['A', 'B'].includes(tier)) tier = 'C';

            const tierConfig = TIER_CONFIG[tier];

            // Show section
            document.getElementById('scoreSection').classList.remove('hidden');

            // Update main score display
            document.getElementById('scoreValue').innerHTML = `${totalScore}<span class="credit-engine-score-max">/100</span>`;
            document.getElementById('scoreValue').style.color = tierConfig.color;
            document.getElementById('scoreGradeLetter').textContent = tier;
            document.getElementById('scoreGradeLetter').style.color = tierConfig.color;
            document.getElementById('scoreGradeLabel').textContent = tierConfig.label.toUpperCase();
            document.getElementById('scoreHeaderBg').style.background = tierConfig.color;

            // Update breakdown bars
            document.getElementById('eventsLabel').textContent = Math.round(events * 10) / 10;
            document.getElementById('bufferPct').textContent = Math.round(bufferRatio * 100);

            // Credit bar - show FICO score instead of points
            const creditPct = (creditPts / SCORE_WEIGHTS.credit) * 100;
            document.getElementById('barCredit').style.width = creditPct + '%';
            document.getElementById('barCredit').style.background = getBarColor(creditPct);
            document.getElementById('dotCredit').style.background = getBarColor(creditPct);
            document.getElementById('scoreCredit').textContent = estimatedFico;

            // Behavior bar
            const behavePct = (behavePts / SCORE_WEIGHTS.behavior) * 100;
            document.getElementById('barBehavior').style.width = behavePct + '%';
            document.getElementById('barBehavior').style.background = getBarColor(behavePct);
            document.getElementById('dotBehavior').style.background = getBarColor(behavePct);
            document.getElementById('scoreBehavior').textContent = Math.round(behavePts) + '/' + SCORE_WEIGHTS.behavior;

            // Revenue bar
            const revPct = (revPts / SCORE_WEIGHTS.revenue) * 100;
            document.getElementById('barRevenue').style.width = revPct + '%';
            document.getElementById('barRevenue').style.background = getBarColor(revPct);
            document.getElementById('dotRevenue').style.background = getBarColor(revPct);
            document.getElementById('scoreRevenue').textContent = Math.round(revPts) + '/' + SCORE_WEIGHTS.revenue;

            // Stability bar
            const stabPct = (stabPts / SCORE_WEIGHTS.stability) * 100;
            document.getElementById('barStability').style.width = stabPct + '%';
            document.getElementById('barStability').style.background = getBarColor(stabPct);
            document.getElementById('dotStability').style.background = getBarColor(stabPct);
            document.getElementById('scoreStability').textContent = Math.round(stabPts) + '/' + SCORE_WEIGHTS.stability;

            // Buffer bar
            const bufferPctBar = (bufferPts / SCORE_WEIGHTS.buffer) * 100;
            document.getElementById('barBuffer').style.width = bufferPctBar + '%';
            document.getElementById('barBuffer').style.background = getBarColor(bufferPctBar);
            document.getElementById('dotBuffer').style.background = getBarColor(bufferPctBar);
            document.getElementById('scoreBuffer').textContent = Math.round(bufferPts) + '/' + SCORE_WEIGHTS.buffer;

            // Highlight active tier on scale
            ['E', 'D', 'C', 'B', 'A'].forEach(t => {
                const el = document.getElementById('scale' + t);
                el.classList.toggle('active', t === tier);
            });

            // Store score data
            extractedData.credit_score = {
                total: totalScore,
                tier: tier,
                label: tierConfig.label,
                components: {
                    credit: Math.round(creditPts),
                    behavior: Math.round(behavePts),
                    revenue: Math.round(revPts),
                    stability: Math.round(stabPts),
                    buffer: Math.round(bufferPts)
                },
                inputs: {
                    estimatedFico,
                    avgRevenue,
                    avgBalance,
                    avgNsf,
                    avgNegDays,
                    tibMonths,
                    bufferRatio: Math.round(bufferRatio * 100)
                }
            };

            // Calculate and display suggested approval
            calculateSuggestedApproval(totalScore, tier, avgRevenue, estimatedFico);
        }

        function renderDebtObligations() {
            const analysis = extractedData.full_analysis;
            const existingDebt = analysis?.existing_debt || [];
            const avgRevenue = analysis?.aggregated?.avg_monthly_deposits || 0;

            // Filter out empty entries
            const debts = existingDebt.filter(d => d.creditor_name && d.payment_amount > 0);

            if (debts.length === 0) {
                document.getElementById('debtSection').classList.add('hidden');
                return;
            }

            document.getElementById('debtSection').classList.remove('hidden');

            // Calculate monthly obligation for each debt
            const calculateMonthly = (debt) => {
                const amt = debt.payment_amount || 0;
                switch(debt.payment_frequency?.toLowerCase()) {
                    case 'daily': return amt * 22; // ~22 business days
                    case 'weekly': return amt * 4.33;
                    case 'bi-weekly': return amt * 2.17;
                    default: return amt;
                }
            };

            const totalMonthly = debts.reduce((sum, d) => sum + calculateMonthly(d), 0);
            const totalBalance = debts.reduce((sum, d) => sum + (d.estimated_balance || 0), 0);
            const debtToRevenue = avgRevenue > 0 ? (totalMonthly / avgRevenue * 100) : 0;

            // Update summary stats
            document.getElementById('debtTotalMonthly').textContent = '$' + Math.round(totalMonthly).toLocaleString();
            document.getElementById('debtPositionCount').textContent = debts.length;
            document.getElementById('debtEstBalance').textContent = '$' + Math.round(totalBalance).toLocaleString();
            document.getElementById('debtToRevenue').textContent = debtToRevenue.toFixed(1) + '%';
            document.getElementById('debtTotalBadge').textContent = '$' + Math.round(totalMonthly).toLocaleString() + '/mo';

            // Build debt table
            const tableHtml = `
                <table class="debt-table">
                    <thead>
                        <tr>
                            <th>Creditor</th>
                            <th>Type</th>
                            <th>Payment</th>
                            <th>Frequency</th>
                            <th>Monthly</th>
                            <th>Est. Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${debts.map(d => {
                            const typeClass = d.payment_type?.toLowerCase().includes('mca') ? 'mca' :
                                             d.payment_type?.toLowerCase().includes('loan') ? 'loan' :
                                             d.payment_type?.toLowerCase().includes('lease') ? 'lease' : 'other';
                            return `
                            <tr>
                                <td><strong>${d.creditor_name}</strong></td>
                                <td><span class="debt-type-badge debt-type-${typeClass}">${d.payment_type || 'Unknown'}</span></td>
                                <td>$${(d.payment_amount || 0).toLocaleString()}</td>
                                <td>${d.payment_frequency || '-'}</td>
                                <td><strong>$${Math.round(calculateMonthly(d)).toLocaleString()}</strong></td>
                                <td>${d.estimated_balance ? '$' + d.estimated_balance.toLocaleString() : '-'}</td>
                            </tr>`;
                        }).join('')}
                        <tr style="background: var(--bg-tertiary); font-weight: 600;">
                            <td colspan="4">TOTAL OBLIGATIONS</td>
                            <td>$${Math.round(totalMonthly).toLocaleString()}</td>
                            <td>${totalBalance > 0 ? '$' + Math.round(totalBalance).toLocaleString() : '-'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
            document.getElementById('debtTableContainer').innerHTML = tableHtml;

            // Create pie chart for debt breakdown
            const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            const textColor = isDark ? '#a1a1aa' : '#64748b';

            if (charts.debt) charts.debt.destroy();

            const colors = ['#dc2626', '#f59e0b', '#8b5cf6', '#06b6d4', '#22c55e', '#ec4899', '#84cc16'];
            charts.debt = new Chart(document.getElementById('debtChart'), {
                type: 'doughnut',
                data: {
                    labels: debts.map(d => d.creditor_name),
                    datasets: [{
                        data: debts.map(d => calculateMonthly(d)),
                        backgroundColor: colors.slice(0, debts.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: textColor, font: { size: 11 } }
                        }
                    }
                }
            });
        }

        // Background Research Functions
        const researchModules = [
            { id: 'sos', name: 'Secretary of State', desc: 'Business registration and standing', icon: 'building' },
            { id: 'ucc', name: 'UCC Filings', desc: 'Liens and secured interests', icon: 'file-text' },
            { id: 'tax', name: 'Tax Liens', desc: 'Federal and state tax issues', icon: 'dollar' },
            { id: 'judgment', name: 'Judgments', desc: 'Court judgments and legal actions', icon: 'gavel' },
            { id: 'bankruptcy', name: 'Bankruptcy', desc: 'Business and owner bankruptcy history', icon: 'alert-triangle' },
            { id: 'bbb', name: 'BBB Profile', desc: 'Better Business Bureau rating', icon: 'award' },
            { id: 'reviews', name: 'Online Reviews', desc: 'Google, Yelp, customer sentiment', icon: 'star' },
            { id: 'news', name: 'News & Press', desc: 'Recent news mentions', icon: 'newspaper' },
            { id: 'social', name: 'Social Media', desc: 'Online presence and activity', icon: 'share' },
            { id: 'industry', name: 'Industry Analysis', desc: 'Market position and trends', icon: 'trending' },
            { id: 'owner', name: 'Owner Background', desc: 'Owner history and experience', icon: 'user' },
            { id: 'location', name: 'Location Analysis', desc: 'Market area and competition', icon: 'map' }
        ];

        const moduleIcons = {
            building: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4M9 9v.01M9 12v.01M9 15v.01M9 18v.01"/></svg>',
            'file-text': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>',
            dollar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
            gavel: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2l6 6-1.5 1.5-6-6zM9 7l6 6-7 7-6-6zM2 22l3-3"/></svg>',
            'alert-triangle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01"/></svg>',
            award: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><path d="M8.21 13.89L7 23l5-3 5 3-1.21-9.12"/></svg>',
            star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
            newspaper: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2M18 14h-8M15 18h-5M10 6h8v4h-8z"/></svg>',
            share: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/></svg>',
            trending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>',
            user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            map: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>'
        };

        let researchResults = {};

        // Render skeleton state for research section
        function renderResearchSkeleton() {
            const resultsGrid = document.getElementById('researchResults');
            document.getElementById('researchBusinessName').textContent = 'Loading...';
            document.getElementById('researchProgressFill').style.width = '0%';
            document.getElementById('researchProgressText').textContent = '0 / 12';

            resultsGrid.innerHTML = researchModules.map(m => `
                <div class="research-module loading" id="module-${m.id}">
                    <div class="research-module-header">
                        <div class="research-module-icon">
                            <div class="skeleton-bar" style="width: 40px; height: 40px; background: var(--border); border-radius: 8px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                        </div>
                        <div class="research-module-info">
                            <div class="research-module-name" style="color: var(--text-muted);">${m.name}</div>
                            <div class="research-module-summary" style="color: var(--text-muted); opacity: 0.5;">Waiting to start...</div>
                        </div>
                        <div class="research-module-status">
                            <span class="risk-badge pending">Pending</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render skeleton state for credit score section
        function renderScoreSkeleton() {
            const scoreValue = document.getElementById('scoreValue');
            const gradeLetter = document.getElementById('scoreGradeLetter');
            const gradeLabel = document.getElementById('scoreGradeLabel');

            if (scoreValue) scoreValue.innerHTML = '<span style="color: var(--text-muted);">--</span>';
            if (gradeLetter) {
                gradeLetter.textContent = '-';
                gradeLetter.style.color = 'var(--text-muted)';
            }
            if (gradeLabel) gradeLabel.textContent = 'CALCULATING';

            // Set bars to skeleton state
            ['Credit', 'Behavior', 'Revenue', 'Stability', 'Buffer'].forEach(name => {
                const bar = document.getElementById('bar' + name);
                const score = document.getElementById('score' + name);
                if (bar) {
                    bar.style.width = '0%';
                    bar.style.background = 'var(--border)';
                }
                if (score) score.textContent = '--';
            });
        }

        // Render skeleton state for lender section
        function renderLenderSkeleton() {
            const grid = document.getElementById('lenderGrid');
            if (!grid) return;

            // Create 6 skeleton lender cards
            grid.innerHTML = Array(6).fill(0).map(() => `
                <div class="lender-card" style="opacity: 0.5;">
                    <div class="lender-header">
                        <div class="skeleton-bar" style="width: 100px; height: 20px; background: var(--border); border-radius: 4px;"></div>
                        <div class="skeleton-bar" style="width: 60px; height: 24px; background: var(--border); border-radius: 12px;"></div>
                    </div>
                    <div class="lender-criteria" style="margin-top: 12px;">
                        <div class="skeleton-bar" style="width: 100%; height: 12px; background: var(--border); border-radius: 4px; margin-bottom: 8px;"></div>
                        <div class="skeleton-bar" style="width: 80%; height: 12px; background: var(--border); border-radius: 4px; margin-bottom: 8px;"></div>
                        <div class="skeleton-bar" style="width: 90%; height: 12px; background: var(--border); border-radius: 4px;"></div>
                    </div>
                </div>
            `).join('');
        }

        // Render skeleton state for charts/cash flow section
        function renderChartsSkeleton() {
            const chartsContainer = document.querySelector('#chartsSection .section-body');
            if (!chartsContainer) return;

            chartsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="chart-container" style="position: relative; height: 250px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div class="skeleton-bar" style="width: 150px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto 12px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                            <div style="color: var(--text-muted); font-size: 12px;">Loading balance chart...</div>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height: 250px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <div class="skeleton-bar" style="width: 150px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto 12px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                            <div style="color: var(--text-muted); font-size: 12px;">Loading flow chart...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render skeleton state for debt section
        function renderDebtSkeleton() {
            const debtContainer = document.querySelector('#debtSection .section-body');
            if (!debtContainer) return;

            document.getElementById('debtTotalBadge').textContent = 'Calculating...';

            debtContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                    ${Array(4).fill(0).map(() => `
                        <div class="debt-stat" style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div class="skeleton-bar" style="width: 60px; height: 28px; background: var(--border); border-radius: 4px; margin: 0 auto 8px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                            <div class="skeleton-bar" style="width: 80px; height: 12px; background: var(--border); border-radius: 4px; margin: 0 auto;"></div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 2;">
                        <div class="skeleton-bar" style="width: 100%; height: 200px; background: var(--bg-tertiary); border-radius: 8px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div class="skeleton-bar" style="width: 100%; height: 200px; background: var(--bg-tertiary); border-radius: 8px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                    </div>
                </div>
            `;
        }

        // Render actual debt/MCA results
        function renderDebtResults() {
            const container = document.querySelector('#debtSection .section-body');
            if (!container || !extractedData) return;

            const mcaPositions = extractedData.mca_positions || [];
            const identifiedDebt = extractedData.identified_debt || [];
            const totalMCACount = mcaPositions.length;
            const totalDebtAmount = mcaPositions.reduce((sum, p) => sum + (p.totalAmount || p.amount || 0), 0);

            document.getElementById('debtTotalBadge').textContent = totalMCACount > 0 ? `${totalMCACount} Position${totalMCACount > 1 ? 's' : ''}` : 'None Detected';

            if (totalMCACount === 0 && identifiedDebt.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <div style="font-size: 16px; font-weight: 500; color: var(--green);">No MCA Positions Detected</div>
                        <div style="font-size: 13px; margin-top: 8px;">No evidence of existing merchant cash advance payments found in the bank statements.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="font-size: 28px; font-weight: 700; color: ${totalMCACount > 0 ? 'var(--red)' : 'var(--green)'};">${totalMCACount}</div>
                        <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">MCA Positions</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="font-size: 28px; font-weight: 700; color: var(--text);">$${totalDebtAmount.toLocaleString()}</div>
                        <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Est. Monthly Debt</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: var(--bg-tertiary); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="font-size: 28px; font-weight: 700; color: var(--text);">${identifiedDebt.length}</div>
                        <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Other Debt Items</div>
                    </div>
                </div>
                ${mcaPositions.length > 0 ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 12px;">Detected MCA Lenders</div>
                        <div style="display: grid; gap: 8px;">
                            ${mcaPositions.map(p => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--red);">
                                    <div style="font-weight: 500; color: var(--text);">${p.name}</div>
                                    <div style="display: flex; align-items: center; gap: 16px;">
                                        ${p.payments ? `<span style="font-size: 12px; color: var(--text-muted);">${p.payments.length} payment${p.payments.length > 1 ? 's' : ''}</span>` : ''}
                                        <span style="font-weight: 600; color: var(--red);">$${(p.totalAmount || p.amount || 0).toLocaleString()}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // Render skeleton state for fraud section
        function renderFraudSkeleton() {
            const container = document.getElementById('fraudResults');
            if (!container) return;

            container.innerHTML = `
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="skeleton-bar" style="width: 24px; height: 24px; background: var(--border); border-radius: 50%; animation: shimmer 1.5s ease-in-out infinite;"></div>
                        <div class="skeleton-bar" style="width: 60px; height: 16px; background: var(--border); border-radius: 4px;"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="skeleton-bar" style="width: 24px; height: 24px; background: var(--border); border-radius: 50%;"></div>
                        <div class="skeleton-bar" style="width: 60px; height: 16px; background: var(--border); border-radius: 4px;"></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="skeleton-bar" style="width: 24px; height: 24px; background: var(--border); border-radius: 50%;"></div>
                        <div class="skeleton-bar" style="width: 60px; height: 16px; background: var(--border); border-radius: 4px;"></div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px;">
                    ${files.map(() => `
                        <div class="fraud-card" style="opacity: 0.6;">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 16px;">
                                <div class="skeleton-bar" style="width: 40px; height: 40px; background: var(--border); border-radius: 8px; animation: shimmer 1.5s ease-in-out infinite;"></div>
                                <div style="flex: 1;">
                                    <div class="skeleton-bar" style="width: 80%; height: 14px; background: var(--border); border-radius: 4px; margin-bottom: 8px;"></div>
                                    <div class="skeleton-bar" style="width: 50%; height: 12px; background: var(--border); border-radius: 4px;"></div>
                                </div>
                                <div class="skeleton-bar" style="width: 60px; height: 24px; background: var(--border); border-radius: 12px;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render skeleton state for bank data section
        function renderBankDataSkeleton() {
            const container = document.getElementById('extractedData');
            if (!container) return;

            container.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 14px 18px; background: var(--bg-tertiary); border-radius: 10px; border: 1px solid var(--border);">
                    <div style="font-size: 14px; font-weight: 600; color: var(--text-muted);">
                        Extracting ${files.length} statements...
                    </div>
                    <div style="flex: 1; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div style="width: 0%; height: 100%; background: var(--blue); animation: shimmer 1.5s ease-in-out infinite;"></div>
                    </div>
                </div>
                <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 10px;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 1000px;">
                        <thead>
                            <tr style="background: var(--bg-tertiary);">
                                <th style="padding: 14px 16px; text-align: left; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Month</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Deposits</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">True Rev</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">#</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Withdrawals</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Avg Bal</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Open Bal</th>
                                <th style="padding: 14px 12px; text-align: right; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">End Bal</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">NSF</th>
                                <th style="padding: 14px 12px; text-align: center; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Neg</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${files.map((f, i) => `
                                <tr style="opacity: ${i === 0 ? '1' : '0.5'};">
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border);">
                                        ${i === 0 ? `
                                            <span style="display: inline-flex; align-items: center; gap: 8px;">
                                                <span style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--blue); border-top-color: transparent; animation: spin 0.8s linear infinite; display: inline-block;"></span>
                                                <span style="color: var(--blue); font-weight: 500;">Processing...</span>
                                            </span>
                                        ` : `
                                            <span style="color: var(--text-muted); font-size: 12px;">${f.name.substring(0, 20)}...</span>
                                        `}
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 80px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto; ${i === 0 ? 'animation: shimmer 1.5s ease-in-out infinite;' : ''}"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 80px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;"><div style="width: 30px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 80px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 70px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 70px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: right;"><div style="width: 70px; height: 16px; background: var(--border); border-radius: 4px; margin-left: auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;"><div style="width: 30px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto;"></div></td>
                                    <td style="padding: 12px; border-bottom: 1px solid var(--border); text-align: center;"><div style="width: 30px; height: 16px; background: var(--border); border-radius: 4px; margin: 0 auto;"></div></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function toggleModule(moduleId) {
            const module = document.getElementById(`module-${moduleId}`);
            if (module) {
                module.classList.toggle('expanded');
            }
        }

        function toggleAllModules() {
            const modules = document.querySelectorAll('.research-module');
            const btn = document.getElementById('expandAllBtn');
            const anyExpanded = document.querySelector('.research-module.expanded');

            modules.forEach(m => {
                if (anyExpanded) {
                    m.classList.remove('expanded');
                } else {
                    m.classList.add('expanded');
                }
            });
            btn.textContent = anyExpanded ? 'Expand All' : 'Collapse All';
        }

        function updateResearchSummary() {
            let low = 0, medium = 0, high = 0, flags = 0;
            Object.values(researchResults).forEach(r => {
                if (r.risk === 'low') low++;
                else if (r.risk === 'medium') medium++;
                else if (r.risk === 'high') high++;
                flags += (r.flags || []).length;
            });

            document.getElementById('summaryLow').textContent = low;
            document.getElementById('summaryMedium').textContent = medium;
            document.getElementById('summaryHigh').textContent = high;
            document.getElementById('summaryFlags').textContent = flags;
            document.getElementById('researchSummary').style.display = 'grid';
        }

        async function runBackgroundResearch(apiKey) {
            const businessName = extractedBusinessInfo.name;
            const ownerName = extractedBusinessInfo.owner;
            const location = extractedBusinessInfo.address;

            researchResults = {};
            const resultsGrid = document.getElementById('researchResults');
            resultsGrid.innerHTML = researchModules.map(m => `
                <div class="research-module loading" id="module-${m.id}">
                    <div class="research-module-header" onclick="toggleModule('${m.id}')">
                        <div class="research-module-icon">
                            <div class="module-spinner"></div>
                        </div>
                        <div class="research-module-info">
                            <div class="research-module-name">${m.name}</div>
                            <div class="research-module-summary" id="summary-${m.id}">${m.desc}</div>
                        </div>
                        <div class="research-module-status">
                            <span class="risk-badge pending" id="badge-${m.id}">Analyzing</span>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9l6 6 6-6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="research-module-content" id="content-${m.id}"></div>
                </div>
            `).join('');

            let completed = 0;
            const updateProgress = () => {
                completed++;
                const pct = Math.round((completed / researchModules.length) * 100);
                document.getElementById('researchProgressFill').style.width = pct + '%';
                document.getElementById('researchProgressText').textContent = `${completed} / ${researchModules.length}`;

                if (completed === researchModules.length) {
                    updateResearchSummary();
                    // Update button text since all modules are now expanded
                    document.getElementById('expandAllBtn').textContent = 'Collapse All';
                }
            };

            // Run SOS module FIRST to get verified entity info, then pass to other modules
            const sosModule = researchModules.find(m => m.id === 'sos');
            const otherModules = researchModules.filter(m => m.id !== 'sos');

            let verifiedEntity = null;

            // Step 1: Run SOS first to identify the correct entity
            if (sosModule) {
                try {
                    const sosResult = await runSingleResearch(apiKey, sosModule, businessName, ownerName, location, 0, null);
                    researchResults[sosModule.id] = sosResult;
                    renderResearchModule(sosModule, sosResult);

                    // Extract verified entity info to pass to other modules
                    if (sosResult.entity_number || sosResult.formation_date || sosResult.status) {
                        verifiedEntity = {
                            entity_number: sosResult.entity_number,
                            formation_date: sosResult.formation_date,
                            status: sosResult.status,
                            verified_name: businessName
                        };
                        console.log('Verified entity from SOS:', verifiedEntity);
                    }
                } catch (e) {
                    researchResults[sosModule.id] = { risk: 'unknown', summary: 'Research failed - please retry', details: [], flags: [] };
                    renderResearchModule(sosModule, researchResults[sosModule.id]);
                }
                updateProgress();
            }

            // Step 2: Run remaining modules in parallel batches, passing verified entity context
            const batchSize = 3;
            for (let i = 0; i < otherModules.length; i += batchSize) {
                const batch = otherModules.slice(i, i + batchSize);
                await Promise.all(batch.map(async (module) => {
                    try {
                        const result = await runSingleResearch(apiKey, module, businessName, ownerName, location, 0, verifiedEntity);
                        researchResults[module.id] = result;
                        renderResearchModule(module, result);
                    } catch (e) {
                        researchResults[module.id] = { risk: 'unknown', summary: 'Research failed - please retry', details: [], flags: [] };
                        renderResearchModule(module, researchResults[module.id]);
                    }
                    updateProgress();
                }));
            }
        }

        async function runSingleResearch(apiKey, module, businessName, ownerName, location, retryCount = 0, verifiedEntity = null) {
            // Detect if this is a formal registered entity
            const entityPatterns = /\b(inc\.?|corp\.?|llc|l\.l\.c\.?|ltd\.?|lp|l\.p\.?|llp|l\.l\.p\.?|pllc|pc|p\.c\.?|incorporated|corporation|company|co\.?)\b/i;
            const isRegisteredEntity = entityPatterns.test(businessName);

            // Extract state from location if available
            const stateMatch = location?.match(/\b([A-Z]{2})\b|\b(California|Texas|Florida|New York|Illinois|Pennsylvania|Ohio|Georgia|North Carolina|Michigan|New Jersey|Virginia|Washington|Arizona|Massachusetts|Tennessee|Indiana|Missouri|Maryland|Wisconsin|Colorado|Minnesota|South Carolina|Alabama|Louisiana|Kentucky|Oregon|Oklahoma|Connecticut|Utah|Iowa|Nevada|Arkansas|Mississippi|Kansas|New Mexico|Nebraska|Idaho|West Virginia|Hawaii|New Hampshire|Maine|Montana|Rhode Island|Delaware|South Dakota|North Dakota|Alaska|Vermont|Wyoming)\b/i);
            const state = stateMatch ? stateMatch[0] : '';

            // Build entity context string for modules that need it (UCC, Tax, Judgment, Bankruptcy)
            const entityContext = verifiedEntity
                ? `IMPORTANT: Search for the SAME entity verified from Secretary of State: "${businessName}"${verifiedEntity.entity_number ? `, Entity/File Number: ${verifiedEntity.entity_number}` : ''}${verifiedEntity.formation_date ? `, formed ${verifiedEntity.formation_date}` : ''}${verifiedEntity.status ? ` (${verifiedEntity.status})` : ''}.`
                : '';

            const prompts = {
                sos: isRegisteredEntity
                    ? `Search for the Secretary of State business registration for "${businessName}" ${state ? `in ${state}` : location ? `in ${location}` : ''}. This is a registered business entity. Find: Entity number, formation date, current status (Active/Inactive/Dissolved), registered agent, principal address, and any amendments or name changes. Search state corporation databases.`
                    : `Research the Secretary of State registration for "${businessName}" ${location ? `in ${location}` : ''}. Determine: Is the business in good standing? When was it formed? Any name changes or mergers?`,
                ucc: `${entityContext} Search for UCC filings against "${businessName}". Look for: Existing liens, secured creditors, MCA lenders like Credibly, Bluevine, OnDeck, Fundbox, Kabbage, equipment financing, factoring companies. Only return results for this specific entity.`,
                tax: `${entityContext} Research tax lien status for "${businessName}" ${ownerName ? `and owner ${ownerName}` : ''}. Look for: Federal tax liens, state tax liens, payment plans. Only return results for this specific entity.`,
                judgment: `${entityContext} Research court judgments and legal actions involving "${businessName}" ${ownerName ? `or ${ownerName}` : ''}. Look for: Civil judgments, lawsuits, collections. Only return results for this specific entity.`,
                bankruptcy: `${entityContext} Research bankruptcy history for "${businessName}" ${ownerName ? `and owner ${ownerName}` : ''}. Check federal bankruptcy court PACER records for Chapter 7, 11, or 13 filings, discharge status. Only return results for this specific entity.`,
                bbb: `Research the Better Business Bureau profile for "${businessName}". Determine: BBB rating, complaint history, years accredited.`,
                reviews: `Research online reviews for "${businessName}". Analyze: Google rating, Yelp rating, common complaints, customer sentiment.`,
                news: `Research recent news and press mentions for "${businessName}". Look for: Positive coverage, negative incidents, industry recognition.`,
                social: `Research social media presence for "${businessName}". Analyze: Active accounts, follower counts, engagement, content quality.`,
                industry: `Research the industry and market position for "${businessName}". Analyze: Industry trends, competition level, market outlook.`,
                owner: `Research owner background for ${ownerName || businessName}. Look for: Business experience, other ventures, professional history.`,
                location: `Research the business location for "${businessName}" ${location ? `at ${location}` : ''}. Analyze: Area demographics, local competition, foot traffic potential.`
            };

            // Use grounded search for key modules that need real data
            const groundedModules = ['sos', 'ucc', 'tax', 'judgment', 'bankruptcy', 'bbb'];
            const useGrounding = groundedModules.includes(module.id) && retryCount < 2;

            // Use Gemini 3 Flash for all research (supports google_search grounding)
            const model = 'gemini-3-flash-preview';

            // Only include entity fields for SOS module (other modules don't have entity registrations)
            const includeEntityFields = module.id === 'sos';

            const jsonSchema = includeEntityFields ? `{
  "risk": "low" | "medium" | "high" | "unknown",
  "summary": "One sentence summary",
  "details": ["Finding 1", "Finding 2", "Finding 3"],
  "flags": ["Red flags if any"],
  "entity_number": "Entity/File number from Secretary of State",
  "formation_date": "Date business was formed/incorporated",
  "status": "Active/Inactive/Dissolved status"
}` : `{
  "risk": "low" | "medium" | "high" | "unknown",
  "summary": "One sentence summary",
  "details": ["Finding 1", "Finding 2", "Finding 3"],
  "flags": ["Red flags if any"]
}`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: `${prompts[module.id]}

${useGrounding ? 'Search the web for current information.' : 'Provide assessment based on typical patterns.'} Format as JSON:
${jsonSchema}

Return ONLY valid JSON.`
                    }]
                }],
                generationConfig: { temperature: 0.3, maxOutputTokens: 2048 }
            };

            // Add search grounding for key research modules
            if (useGrounding) {
                requestBody.tools = [{
                    google_search: {}
                }];
            }

            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await resp.json();

                // Check for API errors
                if (data.error) {
                    console.warn(`Research API error for ${module.id}:`, data.error);
                    if (retryCount < 2) {
                        await new Promise(r => setTimeout(r, 1000 * (retryCount + 1)));
                        return runSingleResearch(apiKey, module, businessName, ownerName, location, retryCount + 1, verifiedEntity);
                    }
                    throw new Error(data.error.message);
                }

                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // If no text response, retry
                if (!text || text.trim() === '{}' || text.trim() === '') {
                    console.warn(`Empty response for ${module.id}, retry ${retryCount + 1}`);
                    if (retryCount < 2) {
                        await new Promise(r => setTimeout(r, 1000 * (retryCount + 1)));
                        return runSingleResearch(apiKey, module, businessName, ownerName, location, retryCount + 1, verifiedEntity);
                    }
                }

                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const result = JSON.parse(text);

                // Validate result has meaningful content
                if (!result.summary || result.summary === 'No data available' || result.summary.toLowerCase().includes('no data')) {
                    if (retryCount < 2) {
                        console.warn(`Invalid response for ${module.id}, retry ${retryCount + 1}`);
                        await new Promise(r => setTimeout(r, 1000 * (retryCount + 1)));
                        return runSingleResearch(apiKey, module, businessName, ownerName, location, retryCount + 1, verifiedEntity);
                    }
                }

                return result;
            } catch (e) {
                console.error(`Research error for ${module.id}:`, e);
                if (retryCount < 2) {
                    await new Promise(r => setTimeout(r, 1000 * (retryCount + 1)));
                    return runSingleResearch(apiKey, module, businessName, ownerName, location, retryCount + 1, verifiedEntity);
                }
                // Return a default assessment on final failure
                return {
                    risk: 'unknown',
                    summary: `Unable to verify ${module.name} - manual review recommended`,
                    details: [`Automated search did not return results for "${businessName}"`, 'Consider checking state databases directly', 'This may indicate a new business or DBA not yet registered'],
                    flags: []
                };
            }
        }

        function renderResearchModule(module, result) {
            const moduleEl = document.getElementById(`module-${module.id}`);
            const badge = document.getElementById(`badge-${module.id}`);
            const summary = document.getElementById(`summary-${module.id}`);
            const content = document.getElementById(`content-${module.id}`);
            const iconEl = moduleEl.querySelector('.research-module-icon');

            // Remove loading state
            moduleEl.classList.remove('loading');

            // Auto-expand the module to show content
            moduleEl.classList.add('expanded');

            // Set risk class on module
            moduleEl.classList.add(`risk-${result.risk || 'unknown'}`);

            // Update icon
            iconEl.innerHTML = moduleIcons[module.icon] || moduleIcons.building;

            // Update badge
            const riskLabels = { low: 'Low Risk', medium: 'Medium', high: 'High Risk', unknown: 'Unknown' };
            badge.className = `risk-badge ${result.risk || ''}`;
            badge.innerHTML = `<span class="risk-badge-dot"></span>${riskLabels[result.risk] || 'N/A'}`;

            // Update summary line
            summary.textContent = result.summary || 'No data available';

            const details = result.details || [];
            const flags = result.flags || [];

            // Build entity info section ONLY for SOS module (Secretary of State has entity registrations)
            const entityInfo = (module.id === 'sos' && (result.entity_number || result.formation_date || result.status)) ? `
                <div class="research-detail-section" style="margin-bottom: 12px;">
                    <div class="research-detail-label">Entity Information</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 8px;">
                        ${result.entity_number ? `<div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Entity Number</div><div style="font-weight: 600; color: var(--text);">${result.entity_number}</div></div>` : ''}
                        ${result.formation_date ? `<div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Formed</div><div style="font-weight: 600; color: var(--text);">${result.formation_date}</div></div>` : ''}
                        ${result.status ? `<div style="background: var(--bg-tertiary); padding: 8px 12px; border-radius: 6px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Status</div><div style="font-weight: 600; color: ${result.status.toLowerCase().includes('active') ? 'var(--green)' : result.status.toLowerCase().includes('dissolv') ? 'var(--red)' : 'var(--gold)'};">${result.status}</div></div>` : ''}
                    </div>
                </div>
            ` : '';

            content.innerHTML = `
                ${entityInfo}
                ${details.length > 0 ? `
                    <div class="research-detail-section">
                        <div class="research-detail-label">Key Findings</div>
                        <ul class="research-detail-list">
                            ${details.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${flags.length > 0 ? `
                    <div class="research-flags">
                        <div class="research-flags-title">Red Flags Identified</div>
                        <div class="research-flags-list">${flags.join(' | ')}</div>
                    </div>
                ` : ''}
                ${details.length === 0 && flags.length === 0 && !entityInfo ? `
                    <div class="research-detail-section">
                        <p style="color: var(--text-muted); font-size: 13px;">No significant findings for this category.</p>
                    </div>
                ` : ''}
            `;
        }

        function matchLenders(data) {
            return lenderProfiles.map(lender => {
                let totalWeight = 0;
                let earnedWeight = 0;
                const checks = [];

                function check(name, required, actual, isMax = false, weight = 1) {
                    if (required == null) return;
                    totalWeight += weight;
                    if (actual == null) {
                        checks.push({ name, status: 'unknown' });
                        return;
                    }
                    const passed = isMax ? actual <= required : actual >= required;
                    if (passed) {
                        earnedWeight += weight;
                        checks.push({ name, status: 'pass' });
                    } else {
                        const ratio = isMax ? required / Math.max(actual, 1) : actual / Math.max(required, 1);
                        if (ratio >= 0.7) {
                            earnedWeight += weight * 0.5;
                            checks.push({ name, status: 'partial' });
                        } else {
                            checks.push({ name, status: 'fail' });
                        }
                    }
                }

                check('Deposits', lender.min_deposits, data.monthly_deposits, false, 3);
                check('ADB', lender.min_adb, data.average_daily_balance, false, 2);
                check('NSF', lender.max_nsf, data.nsf_negative_days, true, 2);
                check('# Deps', lender.min_num_deps, data.num_deposits_monthly, false, 1);

                const score = totalWeight === 0 ? 50 : Math.round((earnedWeight / totalWeight) * 100);
                const hasHardFail = checks.some(c => c.status === 'fail');

                let level = 'low';
                if (score >= 85 && !hasHardFail) level = 'high';
                else if (score >= 60) level = 'medium';

                return { ...lender, score, level, checks };
            }).sort((a, b) => b.score - a.score);
        }

        function renderLenderResults() {
            const high = matchedLenders.filter(l => l.level === 'high');
            const medium = matchedLenders.filter(l => l.level === 'medium');
            const low = matchedLenders.filter(l => l.level === 'low');

            document.getElementById('lenderCount').textContent = `${high.length} high, ${medium.length} medium matches`;

            document.getElementById('lenderResults').innerHTML = matchedLenders.map(l => `
                <div class="lender-card ${l.level}">
                    <div class="lender-header">
                        <div class="lender-name">${l.name}</div>
                        <div class="lender-score">${l.score}%</div>
                    </div>
                    <div class="lender-meta">
                        <span class="lender-tag">${l.frequency}</span>
                        <span class="lender-tag">${l.min_rate?.toFixed(2) || '?'} - ${l.max_rate?.toFixed(2) || '?'}</span>
                        <span class="lender-tag">Up to $${(l.max_amount || 0).toLocaleString()}</span>
                    </div>
                    <div class="lender-submit">
                        ${l.method === 'email' ? `<a href="mailto:${l.email}">${l.email}</a>` :
                          l.method === 'portal' ? `<a href="${l.portal}" target="_blank">Submit via Portal</a>` :
                          'Contact lender'}
                    </div>
                </div>
            `).join('');
        }

        function renderSubmitInstructions() {
            const topLenders = matchedLenders.filter(l => l.level === 'high').slice(0, 5);

            document.getElementById('submitInstructions').innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                        Based on the analysis, here are your recommended submission targets:
                    </p>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>Lender</th>
                            <th>Match</th>
                            <th>Method</th>
                            <th>Contact</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${topLenders.map(l => `
                            <tr>
                                <td style="font-weight: 500;">${l.name}</td>
                                <td class="${l.score >= 85 ? 'text-green' : l.score >= 60 ? 'text-gold' : ''}">${l.score}%</td>
                                <td>${l.method === 'email' ? 'Email' : 'Portal'}</td>
                                <td>
                                    ${l.method === 'email' ?
                                        `<a href="mailto:${l.email}" style="color: var(--gold);">${l.email}</a>` :
                                        `<a href="${l.portal}" target="_blank" style="color: var(--gold);">Open Portal </a>`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <div style="margin-top: 20px; padding: 16px; background: var(--gold-bg); border-radius: var(--radius-md); border: 1px solid var(--gold);">
                    <div style="font-size: 12px; font-weight: 600; color: var(--gold); margin-bottom: 8px;">Submission Checklist</div>
                    <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8;">
                        <li>Bank statements (you have ${files.length} files ready)</li>
                        <li>Completed application</li>
                        <li>Valid ID (driver's license or passport)</li>
                        <li>Voided check</li>
                        <li>Business documentation (if available)</li>
                    </ul>
                </div>
            `;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
