<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCA Underwriting Analysis | ABLES.AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="importmap">
        {
            "imports": {
                "@google/genai": "https://esm.run/@anthropic-ai/sdk"
            }
        }
    </script>
    <style>
        :root {
            --primary: #0a0a0a;
            --accent: #eab308;
            --accent-hover: #facc15;
            --success: #059669;
            --success-light: #34d399;
            --success-bg: #ecfdf5;
            --danger: #dc2626;
            --danger-light: #f87171;
            --danger-bg: #fef2f2;
            --warning: #d97706;
            --warning-light: #fbbf24;
            --warning-bg: #fffbeb;
            --info: #0284c7;
            --info-bg: #e0f2fe;
            --purple: #7c3aed;
            --purple-bg: #f3e8ff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* Header - Light Theme */
        .header {
            background: #ffffff;
            color: var(--gray-800);
            border-bottom: 1px solid var(--gray-200);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 14px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand-logo {
            display: flex;
            align-items: center;
        }

        .brand-logo svg {
            width: 28px;
            height: 28px;
        }

        .brand-text {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1;
            display: flex;
            align-items: center;
            color: var(--gray-800);
        }

        .brand-text .gold { color: var(--accent); }
        .brand-text .muted { color: var(--gray-400); }
        .brand-text .bank-label { color: var(--gray-400); font-size: 0.55em; font-weight: 400; margin-right: 1px; }

        .header-info {
            text-align: right;
            font-size: 12px;
            color: var(--gray-500);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 32px;
        }

        /* Upload Section - Large Drop Zone */
        .upload-section {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .upload-drop-zone {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            margin: 16px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-drop-zone:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, #fffef5 0%, #fefce8 100%);
        }

        .upload-section.dragover .upload-drop-zone {
            border-color: var(--accent);
            background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%);
            transform: scale(1.01);
        }

        .upload-section.has-files .upload-drop-zone {
            padding: 30px 40px;
        }

        .upload-icon-wrapper {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 24px rgba(234, 179, 8, 0.35);
        }

        .upload-icon {
            width: 36px;
            height: 36px;
            color: #ffffff;
        }

        .upload-text {
            margin-bottom: 0;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 8px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: var(--gray-500);
        }

        .upload-input {
            display: none;
        }

        .file-list {
            padding: 16px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: #ffffff;
            border-radius: 24px;
            border: 1px solid var(--gray-200);
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-icon {
            width: 20px;
            height: 20px;
            background: var(--success-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success);
        }

        .file-icon svg {
            width: 11px;
            height: 11px;
        }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 11px;
            color: var(--gray-400);
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            margin-left: 4px;
            transition: color 0.2s;
        }

        .file-remove:hover {
            color: var(--danger);
        }

        .file-remove svg {
            width: 14px;
            height: 14px;
        }

        .upload-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .file-count {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .upload-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .upload-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--gray-300);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* API Key Section - Orbit/Hubble Pro Style */
        .api-section {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-200);
            padding: 16px 20px;
            margin-bottom: 20px;
        }

        .api-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
        }

        .api-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 13px;
            font-family: inherit;
            background: #ffffff;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .analyze-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
            color: var(--primary);
            padding: 10px 24px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(234, 179, 8, 0.3);
        }

        .analyze-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading Overlay - Full screen */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            max-width: 420px;
        }

        .loading-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 48px;
        }

        .loading-logo-icon {
            font-size: 32px;
        }

        .loading-logo-text {
            font-size: 24px;
            font-weight: 300;
            color: #f5f5f5;
        }

        .loading-logo-text span {
            font-weight: 700;
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid #262626;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 32px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: 18px;
            font-weight: 500;
            color: #f5f5f5;
            margin-bottom: 8px;
        }

        .loading-subtitle {
            font-size: 14px;
            color: #666;
        }

        .loading-progress {
            margin-top: 32px;
            width: 200px;
            height: 3px;
            background: #262626;
            border-radius: 2px;
            overflow: hidden;
            margin-left: auto;
            margin-right: auto;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            animation: loadingPulse 2s ease-in-out infinite;
            width: 40%;
        }

        @keyframes loadingPulse {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(350%); }
        }

        /* Snood Game Styles */
        .snood-game-wrapper {
            margin-top: 24px;
            display: flex;
            justify-content: center;
        }

        .snood-container {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #333;
        }

        .snood-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        #snoodCanvas {
            background: linear-gradient(180deg, #1e1e2e 0%, #0d0d15 100%);
            border-radius: 8px;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }

        .snood-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 11px;
            color: #666;
        }

        #snoodScore {
            color: var(--accent);
            font-weight: 600;
        }

        body.dark-theme .snood-container {
            background: #1a1a1a;
            border-color: #333;
        }

        body:not(.dark-theme) .snood-container {
            background: #f5f5f5;
            border-color: #ddd;
        }

        body:not(.dark-theme) #snoodCanvas {
            background: linear-gradient(180deg, #e8e8f0 0%, #d0d0e0 100%);
        }

        body:not(.dark-theme) .snood-label,
        body:not(.dark-theme) .snood-controls {
            color: #666;
        }

        /* Game Button in Header - Hank Bank Theme */
        .game-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .game-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
            background: linear-gradient(135deg, #2d5a87 0%, #3d6a97 100%);
        }

        /* Hank Bank Snood Modal */
        .snood-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .snood-modal-overlay.active {
            display: block;
        }

        .snood-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #1e3a5f 0%, #0f1d2f 100%);
            border-radius: 16px;
            padding: 0;
            z-index: 2001;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 60px rgba(212, 175, 55, 0.2);
            border: 3px solid #d4af37;
            overflow: hidden;
        }

        .snood-modal.active {
            display: block;
            animation: modalPop 0.3s ease-out;
        }

        @keyframes modalPop {
            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .snood-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(90deg, #1e3a5f 0%, #2d5a87 100%);
            color: #d4af37;
            border-bottom: 2px solid #d4af37;
        }

        .snood-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .snood-modal-stats {
            display: flex;
            gap: 16px;
            font-size: 14px;
            font-weight: 700;
        }

        .snood-modal-stats span {
            background: rgba(212, 175, 55, 0.2);
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid #d4af37;
        }

        .snood-modal-close {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            color: #d4af37;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .snood-modal-close:hover {
            background: rgba(212, 175, 55, 0.4);
        }

        .snood-modal-body {
            padding: 20px;
            display: flex;
            justify-content: center;
            background: #0a1520;
        }

        #snoodModalCanvas {
            background: linear-gradient(180deg, #152535 0%, #0a1520 100%);
            border-radius: 12px;
            cursor: crosshair;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.6), 0 0 20px rgba(212, 175, 55, 0.1);
            border: 2px solid #2d5a87;
        }

        .snood-modal-footer {
            padding: 16px 20px;
            background: #0f1d2f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #d4af37;
        }

        .snood-modal-controls {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: #7a9cc6;
            font-weight: 500;
        }

        .snood-restart-btn {
            background: linear-gradient(135deg, #d4af37 0%, #b8962e 100%);
            color: #1e3a5f;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .snood-restart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.4);
        }

        /* Report Container (hidden until analysis complete) */
        .report-container {
            display: none;
        }

        .report-container.visible {
            display: block;
        }

        /* Summary Header - Unified - Orbit/Hubble Pro Style */
        .summary-header {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-200);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .summary-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-100);
        }

        .business-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .business-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .score-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .score-display {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .score-num {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }

        .score-label {
            font-size: 9px;
            text-transform: uppercase;
            color: var(--gray-400);
        }

        .status-pill {
            padding: 5px 12px;
            border-radius: 100px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-pill.review {
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-pill.approve {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-pill.decline {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Metrics Row */
        .metrics-row {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 0;
        }

        .metric {
            padding: 10px 8px;
            text-align: center;
            border-right: 1px solid var(--gray-100);
        }

        .metric:last-child {
            border-right: none;
        }

        .metric-label {
            font-size: 8px;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-800);
            font-variant-numeric: tabular-nums;
        }

        .metric-value.positive { color: var(--success); }
        .metric-value.negative { color: var(--danger); }
        .metric-value.warning { color: var(--warning); }

        /* Sections - Orbit/Hubble Pro Style */
        .section {
            background: #ffffff;
            border-radius: var(--radius-lg);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            margin-bottom: 16px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .section-badge {
            font-size: 10px;
            background: var(--gray-100);
            color: var(--gray-500);
            padding: 4px 10px;
            border-radius: 100px;
        }

        .tier-badge {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .section-body { padding: 16px; }

        /* Two Column Layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .three-col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 200px;
        }

        .chart-container.tall { height: 260px; }
        .chart-container.short { height: 160px; }

        .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        /* Risk Indicators - Compact */
        .risk-strip {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-top: 12px;
        }

        .risk-chip {
            padding: 8px 6px;
            border-radius: 6px;
            text-align: center;
        }

        .risk-chip.good {
            background: var(--success-bg);
            border: 1px solid #a7f3d0;
        }

        .risk-chip.warn {
            background: var(--warning-bg);
            border: 1px solid #fde68a;
        }

        .risk-chip.bad {
            background: var(--danger-bg);
            border: 1px solid #fecaca;
        }

        .risk-chip.neutral {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
        }

        .risk-chip-value {
            font-size: 14px;
            font-weight: 700;
            line-height: 1;
        }

        .risk-chip.good .risk-chip-value { color: var(--success); }
        .risk-chip.warn .risk-chip-value { color: var(--warning); }
        .risk-chip.bad .risk-chip-value { color: var(--danger); }
        .risk-chip.neutral .risk-chip-value { color: var(--gray-600); }

        .risk-chip-label {
            font-size: 8px;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-top: 2px;
            line-height: 1.1;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .table-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .data-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            font-variant-numeric: tabular-nums;
            white-space: nowrap;
        }

        .data-table tr:hover td { background: var(--gray-50); }

        .data-table .col-group {
            text-align: center;
            border-bottom: 1px solid var(--gray-300);
        }

        .data-table .col-group.credits { background: #ecfdf5; color: var(--success); }
        .data-table .col-group.debits { background: #fef2f2; color: var(--danger); }
        .data-table .col-group.balances { background: #e0f2fe; color: var(--info); }

        .data-table tfoot td {
            font-weight: 700;
        }

        .data-table tfoot tr:first-child td {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .data-table tfoot tr:last-child td {
            background: linear-gradient(90deg, var(--accent) 0%, #d4b03a 100%);
            color: var(--primary);
        }

        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-info { color: var(--info); }

        /* Scorecard */
        .scorecard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .scorecard-item {
            background: var(--white);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scorecard-label {
            font-size: 12px;
            color: var(--gray-600);
        }

        .scorecard-value {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 100px;
        }

        .scorecard-value.pass {
            background: var(--success-bg);
            color: var(--success);
        }

        .scorecard-value.fail {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .scorecard-value.warn {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .scorecard-value.neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* Breakdown Items */
        .breakdown-list { margin-top: 12px; }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .breakdown-item:last-child { border-bottom: none; }

        .breakdown-name {
            font-size: 12px;
            color: var(--gray-700);
        }

        .breakdown-data {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breakdown-amt {
            font-size: 13px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .breakdown-pct {
            font-size: 11px;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 2px 8px;
            border-radius: 100px;
            min-width: 50px;
            text-align: center;
        }

        /* Stacking Table */
        .stacking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .stacking-table th {
            text-align: left;
            padding: 10px 14px;
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .stacking-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-dot.active { background: var(--success); }
        .status-dot.suspected { background: var(--warning); }
        .status-dot.none { background: var(--gray-300); }

        /* Position Card - Light Theme */
        .position-card {
            background: #ffffff;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
            border: 1px solid var(--gray-200);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .position-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .position-amount {
            font-size: 42px;
            font-weight: 800;
            color: var(--success);
            margin-bottom: 4px;
        }

        .position-range {
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .position-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .position-metric {
            text-align: center;
            padding: 16px 12px;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-radius: var(--radius);
            border: 1px solid var(--gray-200);
        }

        .position-metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .position-metric-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--gray-500);
        }

        /* Settings Button & Menu */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-btn {
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 8px 12px;
            color: var(--gray-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--gray-200);
            border-color: var(--gray-300);
            color: var(--gray-700);
        }

        .settings-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .settings-overlay.active {
            display: block;
        }

        .settings-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            z-index: 1000;
            overflow: hidden;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .settings-close:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .settings-body {
            padding: 20px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 14px;
            color: var(--gray-700);
        }

        .settings-label-desc {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .settings-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            margin-top: 8px;
            background: var(--white);
            color: var(--gray-900);
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .settings-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .settings-input-row .settings-input {
            margin-top: 0;
            flex: 1;
        }

        .settings-save-btn {
            padding: 10px 16px;
            background: var(--accent);
            color: var(--primary);
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .settings-save-btn:hover {
            background: var(--accent-hover);
        }

        .settings-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
            background: white;
            color: var(--gray-800);
            cursor: pointer;
            margin-top: 8px;
        }

        .settings-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .settings-select optgroup {
            font-weight: 600;
            color: var(--gray-700);
        }

        .settings-select option {
            padding: 8px;
        }

        .model-description {
            margin-top: 8px;
            padding: 10px 12px;
            background: var(--gray-50);
            border-radius: var(--radius);
            font-size: 12px;
            color: var(--gray-600);
            line-height: 1.4;
        }

        body.dark-theme .settings-select {
            background: #262626;
            border-color: #444;
            color: #e5e5e5;
        }

        body.dark-theme .settings-select optgroup {
            background: #1a1a1a;
            color: #ccc;
        }

        body.dark-theme .settings-select option {
            background: #262626;
            color: #e5e5e5;
        }

        body.dark-theme .model-description {
            background: #333;
            color: #aaa;
        }

        .settings-saved {
            color: var(--success);
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 4px;
        }

        .settings-saved.visible {
            display: flex;
        }

        .settings-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
        }

        .settings-done-btn {
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
            color: var(--primary);
            padding: 10px 24px;
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .settings-done-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.4);
        }

        body.dark-theme .settings-footer {
            border-color: #333;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--gray-300);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .theme-toggle.dark {
            background: var(--accent);
        }

        .theme-toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #ffffff;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .theme-toggle.dark .theme-toggle-knob {
            transform: translateX(22px);
        }

        .theme-toggle-knob svg {
            width: 12px;
            height: 12px;
            color: var(--gray-500);
        }

        .theme-toggle.dark .theme-toggle-knob svg {
            color: var(--accent);
        }

        /* Dark Theme */
        body.dark-theme {
            background: #0a0a0a;
            color: #f5f5f5;
        }

        body.dark-theme .container {
            background: #0a0a0a;
        }

        body.dark-theme .summary-header,
        body.dark-theme .section,
        body.dark-theme .upload-section,
        body.dark-theme .api-section {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .upload-drop-zone {
            background: linear-gradient(135deg, #262626 0%, #1f1f1f 100%);
            border-color: #444;
        }

        body.dark-theme .upload-drop-zone:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, #2a2a1f 0%, #252520 100%);
        }

        body.dark-theme .upload-section.dragover .upload-drop-zone {
            border-color: var(--accent);
            background: linear-gradient(135deg, #3d3d1f 0%, #4a4a20 100%);
        }

        body.dark-theme .upload-title {
            color: #e5e5e5;
        }

        body.dark-theme .upload-subtitle {
            color: #888;
        }

        body.dark-theme .upload-icon-wrapper {
            background: linear-gradient(135deg, var(--accent) 0%, #d4a520 100%);
        }

        body.dark-theme .upload-icon {
            color: #1a1a1a;
        }

        body.dark-theme .settings-panel {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .settings-header {
            border-color: #333;
        }

        body.dark-theme .settings-title {
            color: #f5f5f5;
        }

        body.dark-theme .settings-section-title {
            color: #888;
        }

        body.dark-theme .settings-label {
            color: #ccc;
        }

        body.dark-theme .settings-label-desc {
            color: #888;
        }

        body.dark-theme .settings-row {
            border-color: #333;
        }

        body.dark-theme .settings-input {
            background: #262626;
            border-color: #444;
            color: #f5f5f5;
        }

        body.dark-theme .section-header {
            border-color: #333;
        }

        body.dark-theme .section-title {
            color: #e5e5e5;
        }

        body.dark-theme .metric-label {
            color: #888;
        }

        body.dark-theme .metric-value {
            color: #e5e5e5;
        }

        body.dark-theme .data-table th {
            background: #262626;
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .data-table td {
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .data-table tr:hover td {
            background: #262626;
        }

        body.dark-theme .data-table .col-group.credits { background: rgba(5, 150, 105, 0.2); }
        body.dark-theme .data-table .col-group.debits { background: rgba(220, 38, 38, 0.2); }
        body.dark-theme .data-table .col-group.balances { background: rgba(2, 132, 199, 0.2); }

        body.dark-theme .data-table tfoot tr:first-child td {
            background: #374151;
            color: #e5e7eb;
        }

        body.dark-theme .data-table tfoot tr:last-child td {
            background: linear-gradient(90deg, var(--accent) 0%, #d4b03a 100%);
            color: #0a0a0a;
        }

        body.dark-theme .loading-content {
            background: #1a1a1a;
        }

        body.dark-theme .loading-title {
            color: #f5f5f5;
        }

        body.dark-theme .loading-subtitle {
            color: #888;
        }

        body.dark-theme .chart-title {
            color: #ccc;
        }

        body.dark-theme .scorecard {
            background: #333;
        }

        body.dark-theme .scorecard-item {
            background: #1a1a1a;
        }

        body.dark-theme .scorecard-label {
            color: #aaa;
        }

        body.dark-theme .risk-chip.neutral {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .breakdown-item {
            border-color: #333;
        }

        body.dark-theme .breakdown-name {
            color: #ccc;
        }

        body.dark-theme .breakdown-pct {
            background: #333;
            color: #aaa;
        }

        body.dark-theme .stacking-table th {
            background: #262626;
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .stacking-table td {
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .upload-title,
        body.dark-theme .upload-subtitle {
            color: #ccc;
        }

        body.dark-theme .api-section-title {
            color: #e5e5e5;
        }

        body.dark-theme .api-input {
            background: #262626;
            border-color: #444;
            color: #f5f5f5;
        }

        body.dark-theme .file-item {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .file-name {
            color: #e5e5e5;
        }

        body.dark-theme .file-size {
            color: #888;
        }

        body.dark-theme .upload-footer {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .file-count {
            color: #ccc;
        }

        body.dark-theme .upload-status {
            color: #ccc;
        }

        body.dark-theme #uploadStatusText {
            color: #ccc;
        }

        body.dark-theme .upload-spinner {
            border-color: #444;
            border-top-color: var(--accent);
        }

        body.dark-theme .business-name {
            color: #f5f5f5;
        }

        body.dark-theme .business-meta {
            color: #888;
        }

        body.dark-theme .summary-top {
            border-color: #333;
        }

        body.dark-theme .metric {
            border-color: #333;
        }

        body.dark-theme .error-message {
            background: rgba(220, 38, 38, 0.15);
        }

        body.dark-theme .error-message-text {
            color: #ccc;
        }

        /* Dark theme - Position Card */
        body.dark-theme .position-card {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .position-title {
            color: #e5e5e5;
        }

        body.dark-theme .position-amount {
            color: #f5f5f5;
        }

        body.dark-theme .position-range {
            color: #888;
        }

        body.dark-theme .position-metrics .metric-box {
            background: #262626;
        }

        /* Dark theme - MCA Summary Cards */
        body.dark-theme #mcaSummaryCards > div {
            background: #262626 !important;
        }

        body.dark-theme #mcaSummaryCards > div > div:first-child {
            color: #e5e5e5 !important;
        }

        body.dark-theme #mcaTotalPositions {
            color: #e5e5e5 !important;
        }

        body.dark-theme #mcaDailyBurden {
            color: #f87171 !important;
        }

        body.dark-theme #mcaWeeklyBurden {
            color: #fbbf24 !important;
        }

        body.dark-theme #mcaEstBalance {
            color: #60a5fa !important;
        }

        /* Dark theme - MCA Status Box */
        body.dark-theme #mcaStatusBox {
            background: #262626 !important;
            border-color: #444 !important;
        }

        body.dark-theme #mcaStatusText {
            color: #aaa !important;
        }

        /* Dark theme - MCA Keywords */
        body.dark-theme #mcaKeywords > div {
            background: #262626 !important;
            border-color: #444 !important;
            color: #aaa !important;
        }

        /* Dark theme - Risk Indicators */
        body.dark-theme .risk-chip {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .risk-chip .risk-value {
            color: #e5e5e5;
        }

        body.dark-theme .risk-chip .risk-label {
            color: #888;
        }

        /* Dark theme - Heat Calendar */
        body.dark-theme .heat-day.level-0 {
            background: #262626;
            color: #666;
        }

        body.dark-theme .heat-calendar-header span {
            color: #888;
        }

        /* Dark theme - Underwriter Notes */
        body.dark-theme .notes-section .section-title {
            color: #e5e5e5;
        }

        /* Dark theme - Header light fix */
        body.dark-theme .header {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .brand-text {
            color: #f5f5f5;
        }

        body.dark-theme .header-info {
            color: #888;
        }

        body.dark-theme .settings-btn {
            background: #262626;
            color: #ccc;
            border-color: #444;
        }

        body.dark-theme .settings-btn:hover {
            background: #333;
            border-color: #555;
        }

        /* Dark theme - Section badges */
        body.dark-theme .section-badge {
            background: #262626;
            color: #ccc;
            border-color: #444;
        }

        /* Dark theme - Table foot */
        body.dark-theme .stacking-table tfoot {
            background: #262626 !important;
        }

        body.dark-theme .stacking-table tfoot td {
            color: #e5e5e5;
        }

        /* Dark theme - Charts text */
        body.dark-theme canvas {
            filter: none;
        }

        /* Dark theme - Scorecard values (PASS/FAIL/WARN boxes) */
        body.dark-theme .scorecard-value.pass {
            background: rgba(5, 150, 105, 0.2);
            color: #34d399;
            border: 1px solid rgba(5, 150, 105, 0.4);
        }

        body.dark-theme .scorecard-value.fail {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
            border: 1px solid rgba(220, 38, 38, 0.4);
        }

        body.dark-theme .scorecard-value.warn {
            background: rgba(217, 119, 6, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(217, 119, 6, 0.4);
        }

        body.dark-theme .scorecard-value.neutral {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
        }

        /* Dark theme - Risk chips with colored backgrounds */
        body.dark-theme .risk-chip.good {
            background: rgba(5, 150, 105, 0.15);
            border-color: rgba(5, 150, 105, 0.4);
        }

        body.dark-theme .risk-chip.good .risk-chip-value {
            color: #34d399;
        }

        body.dark-theme .risk-chip.warn {
            background: rgba(217, 119, 6, 0.15);
            border-color: rgba(217, 119, 6, 0.4);
        }

        body.dark-theme .risk-chip.warn .risk-chip-value {
            color: #fbbf24;
        }

        body.dark-theme .risk-chip.bad {
            background: rgba(220, 38, 38, 0.15);
            border-color: rgba(220, 38, 38, 0.4);
        }

        body.dark-theme .risk-chip.bad .risk-chip-value {
            color: #f87171;
        }

        body.dark-theme .risk-chip.neutral .risk-chip-value {
            color: #aaa;
        }

        body.dark-theme .risk-chip-label {
            color: #888;
        }

        /* Dark theme - Position metrics boxes */
        body.dark-theme .position-metric {
            background: linear-gradient(135deg, #262626 0%, #1f1f1f 100%);
            border-color: #444;
        }

        body.dark-theme .position-metric-value {
            color: #e5e5e5;
        }

        body.dark-theme .position-metric-label {
            color: #888;
        }

        /* Dark theme - Trend arrows */
        body.dark-theme .trend-arrow.up {
            background: rgba(5, 150, 105, 0.2);
            color: #34d399;
        }

        body.dark-theme .trend-arrow.down {
            background: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        body.dark-theme .trend-arrow.neutral {
            background: #333;
            color: #aaa;
        }

        /* Dark theme - Red flag alerts */
        body.dark-theme .red-flag-alert {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(220, 38, 38, 0.15) 100%);
            border-color: rgba(248, 113, 113, 0.4);
        }

        body.dark-theme .red-flag-list li {
            color: #ccc;
        }

        /* Dark theme - Breakdown items */
        body.dark-theme .breakdown-amt {
            color: #e5e5e5;
        }

        /* Dark theme - Status dots */
        body.dark-theme .status-dot.none {
            background: #555;
        }

        /* Dark theme - Text colors */
        body.dark-theme .text-success { color: #34d399; }
        body.dark-theme .text-danger { color: #f87171; }
        body.dark-theme .text-warning { color: #fbbf24; }
        body.dark-theme .text-info { color: #60a5fa; }

        /* Dark theme - Metric positive/negative/warning */
        body.dark-theme .metric-value.positive { color: #34d399; }
        body.dark-theme .metric-value.negative { color: #f87171; }
        body.dark-theme .metric-value.warning { color: #fbbf24; }

        /* Dark theme - Table cells with color coding */
        body.dark-theme td.text-success { color: #34d399; }
        body.dark-theme td.text-danger { color: #f87171; }

        /* Dark theme - Status pills (Manual Review, Approve, Decline) */
        body.dark-theme .status-pill.review {
            background: rgba(217, 119, 6, 0.15);
            color: #fbbf24;
            border-color: rgba(217, 119, 6, 0.5);
        }

        body.dark-theme .status-pill.approve {
            background: rgba(5, 150, 105, 0.15);
            color: #34d399;
            border-color: rgba(5, 150, 105, 0.5);
        }

        body.dark-theme .status-pill.decline {
            background: rgba(220, 38, 38, 0.15);
            color: #f87171;
            border-color: rgba(220, 38, 38, 0.5);
        }

        /* Dark theme - Tier badge */
        body.dark-theme .section-badge.tier-badge {
            background: rgba(5, 150, 105, 0.15) !important;
            color: #34d399 !important;
            border: 1px solid rgba(5, 150, 105, 0.5) !important;
        }

        /* Error Message */
        .error-message {
            background: var(--danger-bg);
            border: 1px solid var(--danger);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .error-message-title {
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 4px;
        }

        .error-message-text {
            font-size: 13px;
            color: var(--gray-700);
        }

        /* Print Stylesheet */
        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .header { position: relative !important; box-shadow: none !important; border-bottom: 2px solid var(--gray-300) !important; }
            .settings-btn, .header-actions button { display: none !important; }
            .upload-section, .settings-overlay, .settings-panel { display: none !important; }
            .report-container { display: block !important; }
            .section { break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px !important; }
            .chart-container { height: 200px !important; }
            .position-card { break-inside: avoid; }
            .action-bar, .new-analysis-btn, .export-btn, .notes-section textarea { display: none !important; }
            .collapsible-header .collapse-icon { display: none !important; }
            .notes-section .notes-content { display: block !important; border: 1px solid var(--gray-300) !important; padding: 12px !important; min-height: auto !important; }
            .keyboard-hint { display: none !important; }
        }

        /* Collapsible Sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header .collapse-icon {
            transition: transform 0.2s ease;
            color: var(--gray-400);
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0 !important;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid var(--gray-300);
            background: white;
            color: var(--gray-700);
        }

        .action-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--primary);
            border-color: var(--accent);
        }

        .action-btn.primary:hover {
            background: var(--accent-hover);
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
        }

        .action-btn.verify-action-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-color: #7c3aed;
        }

        .action-btn.verify-action-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* Notes Section */
        .notes-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .notes-section textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-top: 12px;
        }

        .notes-section textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }

        .notes-content {
            white-space: pre-wrap;
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.6;
        }

        /* Trend Arrows */
        .trend-arrow {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .trend-arrow.up {
            color: var(--success);
            background: var(--success-bg);
        }

        .trend-arrow.down {
            color: var(--danger);
            background: var(--danger-bg);
        }

        .trend-arrow.neutral {
            color: var(--gray-500);
            background: var(--gray-100);
        }

        .trend-arrow svg {
            width: 12px;
            height: 12px;
        }

        /* Red Flag Alerts */
        .red-flag-alert {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 1px solid #fca5a5;
            border-left: 4px solid var(--danger);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .red-flag-alert.visible {
            display: block;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .red-flag-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 8px;
        }

        .red-flag-title svg {
            width: 20px;
            height: 20px;
        }

        .red-flag-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .red-flag-list li {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-700);
            padding: 4px 0;
        }

        .red-flag-list li::before {
            content: "!";
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            font-size: 10px;
            font-weight: 700;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Heat Calendar - Compact */
        .heat-calendar {
            display: grid;
            grid-template-columns: repeat(15, 18px);
            gap: 2px;
            margin-top: 8px;
        }

        .heat-calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 18px);
            gap: 2px;
            margin-bottom: 2px;
        }

        .heat-calendar-header span {
            text-align: center;
            font-size: 8px;
            font-weight: 600;
            color: var(--gray-500);
        }

        .heat-day {
            width: 18px;
            height: 18px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: var(--gray-600);
            cursor: pointer;
            transition: transform 0.1s ease;
        }

        .heat-day:hover {
            transform: scale(1.3);
            z-index: 1;
        }

        .heat-day.empty {
            background: transparent;
        }

        .heat-day.level-0 { background: var(--gray-100); }
        .heat-day.level-1 { background: #d1fae5; }
        .heat-day.level-2 { background: #6ee7b7; }
        .heat-day.level-3 { background: #34d399; }
        .heat-day.level-4 { background: #10b981; }
        .heat-day.level-5 { background: #059669; color: white; }

        .heat-day.negative { background: #fecaca; }
        .heat-day.very-negative { background: #f87171; color: white; }

        .heat-legend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--gray-500);
        }

        .heat-legend-item {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .heat-stats {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 16px;
        }

        .heat-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .heat-stat-row:last-child {
            border-bottom: none;
        }

        .heat-stat-label {
            font-size: 13px;
            color: var(--gray-600);
        }

        .heat-stat-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
        }

        body.dark-theme .heat-stats {
            background: #262626;
        }

        body.dark-theme .heat-stat-row {
            border-color: #444;
        }

        body.dark-theme .heat-stat-label {
            color: #aaa;
        }

        body.dark-theme .heat-stat-value {
            color: #e5e5e5;
        }

        /* Math Verification Section */
        .verification-section {
            border: 2px dashed var(--gray-300);
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        }

        .verification-badge {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .verification-badge.verified {
            background: var(--success-bg);
            color: var(--success);
        }

        .verification-badge.error {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .verification-badge.checking {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .verify-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verify-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .verify-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .verification-placeholder {
            text-align: center;
            padding: 20px;
            color: var(--gray-500);
            font-size: 13px;
        }

        .verification-results {
            padding: 16px;
        }

        .verification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: var(--radius);
            margin-bottom: 8px;
            border: 1px solid var(--gray-200);
        }

        .verification-item:last-child {
            margin-bottom: 0;
        }

        .verification-item-label {
            font-size: 13px;
            color: var(--gray-700);
        }

        .verification-item-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .verification-item-status.pass {
            color: var(--success);
        }

        .verification-item-status.fail {
            color: var(--danger);
        }

        .verification-item-status.warn {
            color: var(--warning);
        }

        .verification-summary {
            margin-top: 16px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius);
            font-size: 13px;
            color: var(--gray-700);
            line-height: 1.5;
        }

        body.dark-theme .verification-section {
            background: linear-gradient(135deg, #1f1f1f 0%, #1a1a1a 100%);
            border-color: #444;
        }

        body.dark-theme .verification-badge {
            background: #333;
            color: #aaa;
        }

        body.dark-theme .verification-placeholder {
            color: #888;
        }

        body.dark-theme .verification-item {
            background: #262626;
            border-color: #444;
        }

        body.dark-theme .verification-item-label {
            color: #ccc;
        }

        body.dark-theme .verification-summary {
            background: #262626;
            color: #ccc;
        }

        /* Verification Bar (above Account Summary) */
        .verification-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
            border: 2px solid #c4b5fd;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }

        .verification-bar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .verification-bar-left svg {
            color: #7c3aed;
        }

        .verification-bar-label {
            font-size: 14px;
            font-weight: 600;
            color: #5b21b6;
        }

        .verification-bar-status {
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            background: #e5e7eb;
            color: #6b7280;
        }

        .verification-bar-status.verified {
            background: #d1fae5;
            color: #059669;
        }

        .verification-bar-status.error {
            background: #fee2e2;
            color: #dc2626;
        }

        .verification-bar-status.checking {
            background: #fef3c7;
            color: #d97706;
        }

        .verification-bar-btn {
            padding: 8px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verification-bar-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .verification-bar-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        body.dark-theme .verification-bar {
            background: linear-gradient(135deg, #2e1065 0%, #1e1b4b 100%);
            border-color: #6d28d9;
        }

        body.dark-theme .verification-bar-label {
            color: #c4b5fd;
        }

        body.dark-theme .verification-bar-left svg {
            color: #a78bfa;
        }

        body.dark-theme .verification-bar-status {
            background: #374151;
            color: #9ca3af;
        }

        body.dark-theme .verification-bar-status.verified {
            background: #064e3b;
            color: #34d399;
        }

        body.dark-theme .verification-bar-status.error {
            background: #7f1d1d;
            color: #fca5a5;
        }

        body.dark-theme .verification-bar-status.checking {
            background: #78350f;
            color: #fcd34d;
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Keyboard Shortcuts */
        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 8px 12px;
            font-size: 12px;
            color: var(--gray-500);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .keyboard-hint kbd {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: inherit;
            font-size: 11px;
        }

        /* Saved Reports Dropdown */
        .saved-reports-dropdown {
            position: relative;
        }

        .saved-reports-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            min-width: 250px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .saved-reports-menu.visible {
            display: block;
        }

        .saved-report-item {
            padding: 10px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
        }

        .saved-report-item:hover {
            background: var(--gray-50);
        }

        .saved-report-item:last-child {
            border-bottom: none;
        }

        .saved-report-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-800);
        }

        .saved-report-date {
            font-size: 11px;
            color: var(--gray-500);
        }

        .saved-report-delete {
            color: var(--gray-400);
            cursor: pointer;
            padding: 4px;
        }

        .saved-report-delete:hover {
            color: var(--danger);
        }

        /* Editable Fields */
        .editable-field {
            position: relative;
            cursor: pointer;
        }

        .editable-field:hover::after {
            content: "Click to edit";
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 10px;
            color: var(--gray-400);
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .editable-field input {
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: inherit;
            font-weight: inherit;
            font-family: inherit;
            background: #fffef0;
            width: 100%;
        }

        /* Custom Scoring */
        .scoring-weights {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .weight-slider {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .weight-slider label {
            font-size: 12px;
            color: var(--gray-600);
            display: flex;
            justify-content: space-between;
        }

        .weight-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--gray-200);
            appearance: none;
            cursor: pointer;
        }

        .weight-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        /* Dark theme additions */
        body.dark-theme .action-btn {
            background: #262626;
            border-color: #333;
            color: #e5e7eb;
        }

        body.dark-theme .action-btn:hover {
            background: #333;
        }

        body.dark-theme .notes-section {
            background: #1a1a1a;
        }

        body.dark-theme .notes-section textarea {
            background: #262626;
            border-color: #333;
            color: #e5e7eb;
        }

        body.dark-theme .red-flag-alert {
            background: linear-gradient(135deg, #2d1f1f 0%, #3d2020 100%);
            border-color: #7f1d1d;
        }

        body.dark-theme .keyboard-hint {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .saved-reports-menu {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-theme .saved-report-item {
            border-color: #333;
        }

        body.dark-theme .saved-report-item:hover {
            background: #262626;
        }

        /* Transaction Modal */
        .transaction-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .transaction-modal.visible {
            display: flex;
        }

        .transaction-modal-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 95%;
            max-width: 700px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .transaction-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .transaction-modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .transaction-modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-500);
            padding: 4px;
        }

        .transaction-modal-close:hover {
            color: var(--gray-700);
        }

        .transaction-modal-body {
            overflow-y: auto;
            max-height: 60vh;
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .transaction-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
        }

        .transaction-table td {
            padding: 10px 16px;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .transaction-table tr:hover td {
            background: var(--gray-50);
        }

        .transaction-table .amount-credit {
            color: var(--success);
            font-weight: 600;
        }

        .transaction-table .amount-debit {
            color: var(--danger);
            font-weight: 600;
        }

        body.dark-theme .transaction-modal-content {
            background: #1a1a1a;
        }

        body.dark-theme .transaction-modal-header {
            border-color: #333;
        }

        body.dark-theme .transaction-modal-title {
            color: #f5f5f5;
        }

        body.dark-theme .transaction-table th {
            background: #262626;
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .transaction-table td {
            color: #ccc;
            border-color: #333;
        }

        body.dark-theme .transaction-table tr:hover td {
            background: #262626;
        }

        body.dark-theme .transaction-table .amount-credit {
            color: #34d399;
        }

        body.dark-theme .transaction-table .amount-debit {
            color: #f87171;
        }

        /* Clickable table cells */
        .data-table td.clickable {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .data-table td.clickable:hover {
            background: var(--gray-100) !important;
            text-decoration: underline;
        }

        body.dark-theme .data-table td.clickable:hover {
            background: #333 !important;
        }

        /* Comparison Modal */
        .comparison-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .comparison-modal.visible {
            display: flex;
        }

        .comparison-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .comparison-title {
            font-size: 18px;
            font-weight: 700;
        }

        .comparison-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-500);
            padding: 8px;
        }

        .comparison-body {
            padding: 24px;
        }

        .comparison-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .comparison-selector select {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 14px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .comparison-card {
            background: var(--gray-50);
            border-radius: var(--radius);
            padding: 20px;
        }

        .comparison-card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--gray-800);
        }

        .comparison-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .comparison-metric:last-child {
            border-bottom: none;
        }

        .comparison-metric-label {
            color: var(--gray-600);
            font-size: 13px;
        }

        .comparison-metric-value {
            font-weight: 600;
            font-size: 14px;
        }

        .comparison-better {
            color: var(--success);
        }

        .comparison-worse {
            color: var(--danger);
        }

        body.dark-theme .comparison-content {
            background: #1a1a1a;
        }

        body.dark-theme .comparison-card {
            background: #262626;
        }

        body.dark-theme .comparison-header {
            border-color: #333;
        }

        body.dark-theme .comparison-title {
            color: #f5f5f5;
        }

        body.dark-theme .comparison-card-title {
            color: #e5e5e5;
        }

        body.dark-theme .comparison-metric-label {
            color: #888;
        }

        body.dark-theme .comparison-metric-value {
            color: #e5e5e5;
        }

        body.dark-theme .comparison-better {
            color: #34d399;
        }

        body.dark-theme .comparison-worse {
            color: #f87171;
        }

        body.dark-theme .comparison-selector select {
            background: #262626;
            border-color: #444;
            color: #e5e5e5;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .metrics-row { grid-template-columns: repeat(5, 1fr); }
            .risk-strip { grid-template-columns: repeat(4, 1fr); }
            .position-metrics { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header-inner { flex-direction: column; gap: 12px; padding: 16px; }
            .two-col, .three-col { grid-template-columns: 1fr; }
            .metrics-row { grid-template-columns: repeat(2, 1fr); }
            .risk-strip { grid-template-columns: repeat(2, 1fr); }
            .scorecard { grid-template-columns: 1fr; }
            .api-input-group { flex-direction: column; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-inner">
        <div class="brand">
            <div class="brand-logo">
                <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="planetGrad" cx="35%" cy="35%" r="60%">
                            <stop offset="0%" stop-color="#fcd34d"/>
                            <stop offset="50%" stop-color="#eab308"/>
                            <stop offset="100%" stop-color="#ca8a04"/>
                        </radialGradient>
                        <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#ffab40"/>
                            <stop offset="50%" stop-color="#ff8c00"/>
                            <stop offset="100%" stop-color="#ff6d00"/>
                        </linearGradient>
                    </defs>
                    <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" opacity="0.6"/>
                    <circle cx="32" cy="32" r="12" fill="url(#planetGrad)"/>
                    <ellipse cx="28" cy="28" rx="4" ry="3" fill="#fef3c7" opacity="0.4"/>
                    <ellipse cx="32" cy="32" rx="28" ry="8" stroke="url(#ringGrad)" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
                    <circle cx="54" cy="26" r="3" fill="#a855f7"/>
                </svg>
            </div>
            <div class="brand-text"><span class="bank-label">bank</span>Ables<span class="muted">AI</span></div>
        </div>
        <div class="header-actions">
            <div class="header-info" id="reportDate">
                <!-- Date will be filled dynamically -->
            </div>
            <button class="game-btn" onclick="toggleSnoodModal()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="8" r="5"/>
                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                </svg>
                Bank with Hank
            </button>
            <button class="settings-btn" onclick="openSettings()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Settings
            </button>
        </div>
    </div>
</header>

<!-- Settings Overlay -->
<div class="settings-overlay" id="settingsOverlay" onclick="closeSettings()"></div>

<!-- Settings Panel -->
<div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
        <h3 class="settings-title">Settings</h3>
        <button class="settings-close" onclick="closeSettings()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>
    <div class="settings-body">
        <div class="settings-section">
            <div class="settings-section-title">Appearance</div>
            <div class="settings-row">
                <div>
                    <div class="settings-label">Dark Mode</div>
                    <div class="settings-label-desc">Switch between light and dark themes</div>
                </div>
                <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()">
                    <div class="theme-toggle-knob">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">API Configuration</div>
            <div class="settings-label">Gemini API Key</div>
            <div class="settings-label-desc">Your API key is stored locally in your browser</div>
            <div class="settings-input-row">
                <input type="password" class="settings-input" id="settingsApiKey" placeholder="Enter your Gemini API key (AIza...)">
                <button class="settings-save-btn" onclick="saveApiKey()">Save</button>
            </div>
            <div class="settings-saved" id="apiKeySaved">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
                API key saved
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Model Selection</div>
            <div class="settings-label">Gemini Model</div>
            <div class="settings-label-desc">Choose the AI model for analysis</div>
            <select class="settings-select" id="modelSelect" onchange="saveModelSelection()">
                <optgroup label="Gemini 3 (Latest)">
                    <option value="gemini-3-pro-preview">Gemini 3 Pro (Recommended)</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash (Faster)</option>
                </optgroup>
                <optgroup label="Gemini 2.5">
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                </optgroup>
                <optgroup label="Agents (Interactions API)">
                    <option value="agent:deep-research-pro-preview-12-2025">Deep Research Agent</option>
                </optgroup>
            </select>
            <div class="model-description" id="modelDescription">
                Best for comprehensive bank statement analysis with high accuracy.
            </div>
        </div>
    </div>
    <div class="settings-footer">
        <button class="settings-done-btn" onclick="saveApiKey()">Save & Close</button>
    </div>
</div>

<!-- Hank Bank Snood Game Modal -->
<div class="snood-modal-overlay" id="snoodModalOverlay" onclick="closeSnoodModal()"></div>
<div class="snood-modal" id="snoodModal">
    <div class="snood-modal-header">
        <h3>Bank with Hank</h3>
        <div class="snood-modal-stats">
            <span id="snoodModalScore">$0</span>
            <span id="snoodModalLevel">Level: 1</span>
        </div>
        <button class="snood-modal-close" onclick="closeSnoodModal()"></button>
    </div>
    <div class="snood-modal-body">
        <canvas id="snoodModalCanvas" width="400" height="500"></canvas>
    </div>
    <div class="snood-modal-footer">
        <div class="snood-modal-controls">
            <span>Aim with mouse</span>
            <span>Click to shoot</span>
            <span>Match 3+ Hanks!</span>
        </div>
        <button class="snood-restart-btn" onclick="restartSnoodGame()">Cash Out</button>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-logo">
            <span class="loading-logo-icon"></span>
            <span class="loading-logo-text">Bank<span>Ables</span>AI</span>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-title">Analyzing Statements</div>
        <div class="loading-subtitle" id="loadingStatus">Preparing documents...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>
</div>

<main class="container">

    <!-- Error Message -->
    <div class="error-message" id="errorMessage">
        <div class="error-message-title">Analysis Error</div>
        <div class="error-message-text" id="errorText"></div>
    </div>

    <!-- Upload Section - Large Drop Zone -->
    <div class="upload-section" id="uploadSection">
        <input type="file" id="fileInput" class="upload-input" multiple accept=".pdf,.png,.jpg,.jpeg,.csv">
        <div class="upload-drop-zone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon-wrapper">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                </svg>
            </div>
            <div class="upload-text">
                <div class="upload-title">Drop bank statements here</div>
                <div class="upload-subtitle">or click to browse. Supports PDF, PNG, JPG, CSV</div>
            </div>
        </div>
        <div class="file-list" id="fileList"></div>
        <div class="upload-footer" id="uploadFooter" style="display: none;">
            <div class="file-count" id="fileCount">0 files selected</div>
            <div class="upload-status" id="uploadStatus" style="display: none;">
                <div class="upload-spinner"></div>
                <span id="uploadStatusText">Analyzing statements...</span>
            </div>
        </div>
        <!-- Snood Game Container (shows during analysis) -->
        <div class="snood-game-wrapper" id="snoodGameWrapper" style="display: none;">
            <div class="snood-container">
                <div class="snood-label">Play while you wait!</div>
                <canvas id="snoodCanvas" width="280" height="320"></canvas>
                <div class="snood-controls">
                    <span>Move mouse to aim, click to shoot</span>
                    <span id="snoodScore">Score: 0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden API Key Input (used by JS) -->
    <input type="hidden" id="apiKey">

    <!-- Report Container (hidden until analysis complete) -->
    <div class="report-container" id="reportContainer">

        <!-- Action Bar -->
        <div class="action-bar" id="actionBar">
            <button class="action-btn primary" onclick="newAnalysis()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                New Analysis
            </button>
            <button class="action-btn" onclick="exportToPDF()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                Export PDF
            </button>
            <button class="action-btn" onclick="saveReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                </svg>
                Save Report
            </button>
            <div class="saved-reports-dropdown">
                <button class="action-btn" onclick="toggleSavedReports()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                    </svg>
                    Load Report
                </button>
                <div class="saved-reports-menu" id="savedReportsMenu">
                    <!-- Saved reports will be populated dynamically -->
                </div>
            </div>
            <button class="action-btn" onclick="printReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0l.229 2.523a1.125 1.125 0 01-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0021 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 00-1.913-.247M6.34 18H5.25A2.25 2.25 0 013 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 011.913-.247m10.5 0a48.536 48.536 0 00-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5zm-3 0h.008v.008H15V10.5z" />
                </svg>
                Print
            </button>
            <button class="action-btn" onclick="openComparisonMode()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5m.75-9l3-3 2.148 2.148A12.061 12.061 0 0116.5 7.605" />
                </svg>
                Compare
            </button>
            <button class="action-btn verify-action-btn" onclick="runMathVerification()" id="verifyActionBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Verify Math
            </button>
        </div>

        <!-- Red Flag Alerts -->
        <div class="red-flag-alert" id="redFlagAlert">
            <div class="red-flag-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                Critical Issues Detected
            </div>
            <ul class="red-flag-list" id="redFlagList">
                <!-- Red flags will be populated dynamically -->
            </ul>
        </div>

        <!-- Unified Summary Header -->
        <div class="summary-header">
            <div class="summary-top">
                <div>
                    <div class="business-name" id="businessName">--</div>
                    <div class="business-meta">
                        <span id="bankAccount">--</span>
                        <span id="statementPeriod">--</span>
                        <span id="industryType">--</span>
                    </div>
                </div>
                <div class="score-group">
                    <div class="score-display">
                        <span class="score-num" id="overallScore">--</span>
                        <span class="score-label">Score</span>
                    </div>
                    <span class="status-pill review" id="statusPill">--</span>
                </div>
            </div>
            <div class="metrics-row" id="metricsRow">
                <!-- Metrics will be populated dynamically -->
            </div>
        </div>

        <!-- Math Verification Bar -->
        <div class="verification-bar" id="verificationBar">
            <div class="verification-bar-left">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="verification-bar-label">AI Math Verification</span>
                <span class="verification-bar-status" id="verificationBarStatus">Not Verified</span>
            </div>
            <button class="verification-bar-btn" id="verificationBarBtn" onclick="runMathVerification()">
                Verify Calculations
            </button>
        </div>

        <!-- Account Summary -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Account Summary</h2>
                <span class="section-badge" id="accountBadge">--</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-scroll">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align: bottom;">Month</th>
                                <th colspan="4" class="col-group credits">Credits</th>
                                <th colspan="3" class="col-group debits">Debits</th>
                                <th colspan="4" class="col-group balances">Balances</th>
                                <th colspan="2" class="col-group debits">Issues</th>
                            </tr>
                            <tr>
                                <th>Bank Total</th>
                                <th>Calculated</th>
                                <th style="color: var(--success); font-weight: 600;">True Rev</th>
                                <th>#</th>
                                <th>Bank Total</th>
                                <th>Calculated</th>
                                <th>#</th>
                                <th>Start</th>
                                <th>End</th>
                                <th>Avg</th>
                                <th>Min</th>
                                <th>NSF</th>
                                <th>OD</th>
                            </tr>
                        </thead>
                        <tbody id="accountTableBody">
                            <!-- Rows will be populated dynamically -->
                        </tbody>
                        <tfoot id="accountTableFoot">
                            <!-- Totals will be populated dynamically -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- Risk Indicators -->
        <div class="section" style="padding: 0;">
            <div class="section-body" style="padding: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <span style="font-size: 11px; font-weight: 600; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.3px;">Risk Indicators</span>
                    <span style="flex: 1; height: 1px; background: var(--gray-200);"></span>
                </div>
                <div class="risk-strip" id="riskStrip">
                    <!-- Risk chips will be populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Payment Capacity Analysis -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Payment Capacity Analysis</h2>
                <span class="section-badge">Debt Service</span>
            </div>
            <div class="section-body">
                <div class="three-col">
                    <div>
                        <div class="chart-title">Holdback Scenarios</div>
                        <div class="chart-container">
                            <canvas id="holdbackChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Daily Payment Capacity</div>
                        <div class="chart-container">
                            <canvas id="capacityGauge"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Revenue vs Payment Load</div>
                        <div class="chart-container">
                            <canvas id="loadChart"></canvas>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <div class="scorecard" id="paymentScorecard">
                        <!-- Payment scorecard will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Underwriting Scorecard -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Underwriting Scorecard</h2>
                <span class="section-badge">Pass/Fail Criteria</span>
            </div>
            <div class="section-body">
                <div class="scorecard" id="underwritingScorecard">
                    <!-- Scorecard items will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Cash Flow Trends -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Daily Cash Flow Analysis</h2>
                <span class="section-badge" id="periodBadge">--</span>
            </div>
            <div class="section-body">
                <div class="two-col">
                    <div>
                        <div class="chart-title">Daily Balance Trend</div>
                        <div class="chart-container tall">
                            <canvas id="balanceChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Weekly Deposits vs Withdrawals</div>
                        <div class="chart-container tall">
                            <canvas id="flowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Revenue Analysis -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Revenue Pattern Analysis</h2>
                <span class="section-badge">Deposit Behavior</span>
            </div>
            <div class="section-body">
                <div class="three-col">
                    <div>
                        <div class="chart-title">Revenue by Day of Week</div>
                        <div class="chart-container">
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Deposit Size Distribution</div>
                        <div class="chart-container">
                            <canvas id="depositDistChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Revenue Sources</div>
                        <div class="chart-container">
                            <canvas id="revenueSourceChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="breakdown-list" style="margin-top: 24px;" id="revenueBreakdown">
                    <div class="chart-title">Revenue Source Breakdown</div>
                    <!-- Breakdown items will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Expense Analysis -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Expense Pattern Analysis</h2>
                <span class="section-badge">Outflow Behavior</span>
            </div>
            <div class="section-body">
                <div class="two-col">
                    <div>
                        <div class="chart-title">Expense Categories</div>
                        <div class="chart-container tall">
                            <canvas id="expenseCatChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Fixed vs Variable Expenses</div>
                        <div class="chart-container tall">
                            <canvas id="fixedVarChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="breakdown-list" style="margin-top: 24px;" id="expenseBreakdown">
                    <div class="chart-title">Expense Category Breakdown</div>
                    <!-- Breakdown items will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- MCA Stacking Detection - Enhanced -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">MCA / Loan Stacking Analysis</h2>
                <span class="section-badge" id="mcaBadge">0 Positions Detected</span>
            </div>
            <div class="section-body">
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;" id="mcaSummaryCards">
                    <div style="background: var(--gray-50); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-800);" id="mcaTotalPositions">0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Active Positions</div>
                    </div>
                    <div style="background: var(--danger-bg); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--danger);" id="mcaDailyBurden">$0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Est. Daily Burden</div>
                    </div>
                    <div style="background: var(--warning-bg); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="mcaWeeklyBurden">$0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Est. Weekly Burden</div>
                    </div>
                    <div style="background: var(--info-bg); padding: 16px; border-radius: var(--radius); text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--info);" id="mcaEstBalance">$0</div>
                        <div style="font-size: 11px; color: var(--gray-500); text-transform: uppercase;">Est. Total Balance</div>
                    </div>
                </div>

                <!-- Detailed Positions Table -->
                <div class="chart-title">Detected MCA/Loan Positions</div>
                <table class="stacking-table" style="margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th>Lender Name</th>
                            <th>Frequency</th>
                            <th>Payment Amount</th>
                            <th>Est. Remaining Balance</th>
                            <th>Est. Payoff Date</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody id="mcaTableBody">
                        <!-- MCA rows will be populated dynamically -->
                    </tbody>
                    <tfoot id="mcaTableFoot" style="background: var(--gray-100); font-weight: 600;">
                        <!-- Totals row -->
                    </tfoot>
                </table>

                <div class="two-col">
                    <div>
                        <div class="chart-title">Payment Timeline</div>
                        <div class="chart-container">
                            <canvas id="mcaTimelineChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Burden by Lender</div>
                        <div class="chart-container">
                            <canvas id="mcaBurdenChart"></canvas>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 16px; border-radius: var(--radius); border: 1px solid;" id="mcaStatusBox">
                    <div style="font-size: 13px; font-weight: 600;" id="mcaStatusTitle">--</div>
                    <div style="font-size: 12px; color: var(--gray-600); margin-top: 4px;" id="mcaStatusText">--</div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="chart-title">Known MCA Lender Patterns Scanned</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;" id="mcaKeywords">
                        <!-- MCA keywords will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Industry Benchmarks -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Industry Benchmarks Comparison</h2>
                <span class="section-badge" id="benchmarkIndustry">--</span>
            </div>
            <div class="section-body">
                <div class="two-col">
                    <div>
                        <div class="chart-title">This Business vs Industry Average</div>
                        <div class="chart-container tall">
                            <canvas id="benchmarkChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Performance Percentile</div>
                        <div class="chart-container tall">
                            <canvas id="percentileChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Heat Calendar Section -->
        <section class="section">
            <div class="section-header collapsible-header" onclick="toggleSection(this)">
                <h2 class="section-title">Daily Activity Heat Map</h2>
                <svg class="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
            </div>
            <div class="section-body collapsible-content" id="heatCalendarSection">
                <div class="two-col" style="gap: 32px; align-items: start;">
                    <div>
                        <div class="chart-title">Balance Activity by Day</div>
                        <div class="heat-calendar-header">
                            <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                        </div>
                        <div class="heat-calendar" id="heatCalendar">
                            <!-- Heat calendar will be populated dynamically -->
                        </div>
                        <div class="heat-legend">
                            <span>Less</span>
                            <div class="heat-legend-item level-0"></div>
                            <div class="heat-legend-item level-1"></div>
                            <div class="heat-legend-item level-2"></div>
                            <div class="heat-legend-item level-3"></div>
                            <div class="heat-legend-item level-4"></div>
                            <div class="heat-legend-item level-5"></div>
                            <span>More</span>
                            <span style="margin-left: 16px;">|</span>
                            <div class="heat-legend-item negative"></div>
                            <div class="heat-legend-item very-negative"></div>
                            <span>Negative</span>
                        </div>
                    </div>
                    <div>
                        <div class="chart-title">Daily Balance Statistics</div>
                        <div class="heat-stats" id="heatStats">
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Highest Balance Day</span>
                                <span class="heat-stat-value text-success" id="highestBalanceDay">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Lowest Balance Day</span>
                                <span class="heat-stat-value text-danger" id="lowestBalanceDay">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Days with Negative Balance</span>
                                <span class="heat-stat-value" id="negativeDaysCount">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Days Below $500</span>
                                <span class="heat-stat-value" id="lowBalanceDaysCount">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Average Daily Balance</span>
                                <span class="heat-stat-value" id="avgDailyBalance">--</span>
                            </div>
                            <div class="heat-stat-row">
                                <span class="heat-stat-label">Balance Volatility</span>
                                <span class="heat-stat-value" id="balanceVolatility">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Recommended Position -->
        <div class="position-card">
            <div class="position-header">
                <div class="position-title">Recommended Position</div>
                <span class="section-badge tier-badge" id="tierBadge">--</span>
            </div>
            <div class="position-amount editable-field" id="recommendedAmount" onclick="makeEditable(this, 'amount')">$--</div>
            <div class="position-range" id="positionRange">--</div>
            <div class="position-metrics" id="positionMetrics">
                <!-- Position metrics will be populated dynamically -->
            </div>
        </div>

        <!-- Math Verification Section -->
        <div class="section verification-section" id="verificationSection">
            <div class="section-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h2 class="section-title">AI Math Verification</h2>
                    <span class="verification-badge" id="verificationBadge">Not Verified</span>
                </div>
                <button class="verify-btn" id="verifyBtn" onclick="runMathVerification()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Verify with AI
                </button>
            </div>
            <div class="section-body">
                <div class="verification-status" id="verificationStatus">
                    <div class="verification-placeholder">
                        Click "Verify with AI" to have an agentic model cross-check all calculations and totals.
                    </div>
                </div>
                <div class="verification-results" id="verificationResults" style="display: none;">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="section-header">
                <h2 class="section-title">Underwriter Notes</h2>
            </div>
            <textarea id="underwriterNotes" placeholder="Add your observations, concerns, or recommendations here..."></textarea>
            <div class="notes-content" id="notesContent" style="display: none;"></div>
        </div>

    </div><!-- End Report Container -->

    <!-- Keyboard Hints -->
    <div class="keyboard-hint" id="keyboardHint">
        <kbd>?</kbd> for shortcuts
    </div>

    <!-- Comparison Modal -->
    <div class="comparison-modal" id="comparisonModal" onclick="if(event.target === this) closeComparisonMode()">
        <div class="comparison-content">
            <div class="comparison-header">
                <h3 class="comparison-title">Compare Reports</h3>
                <button class="comparison-close" onclick="closeComparisonMode()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="comparison-body">
                <div class="comparison-selector">
                    <select id="compareSelect1" onchange="updateComparison()">
                        <option value="">Select first business...</option>
                    </select>
                    <select id="compareSelect2" onchange="updateComparison()">
                        <option value="">Select second business...</option>
                    </select>
                </div>
                <div class="comparison-grid" id="comparisonGrid">
                    <div style="text-align: center; color: var(--gray-500); padding: 40px; grid-column: span 2;">
                        Select two saved reports to compare
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="transaction-modal" id="transactionModal" onclick="if(event.target === this) closeTransactionModal()">
        <div class="transaction-modal-content">
            <div class="transaction-modal-header">
                <h3 class="transaction-modal-title" id="transactionModalTitle">Transactions</h3>
                <button class="transaction-modal-close" onclick="closeTransactionModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="transaction-modal-body">
                <table class="transaction-table" id="transactionTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</main>


<script>
    // Global state
    let uploadedFiles = [];
    let chartInstances = {};
    let analysisData = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric', month: 'short', day: 'numeric'
        });
        setupFileUpload();
        setupAPIKeyValidation();
        loadSettings();
    });

    // Settings Functions
    function openSettings() {
        document.getElementById('settingsOverlay').classList.add('active');
        document.getElementById('settingsPanel').classList.add('active');
        // Load current API key into settings
        const savedKey = localStorage.getItem('geminiApiKey') || '';
        document.getElementById('settingsApiKey').value = savedKey;
        // Load current model selection
        const savedModel = localStorage.getItem('geminiModel') || 'gemini-3-pro-preview';
        document.getElementById('modelSelect').value = savedModel;
        updateModelDescription(savedModel);
    }

    const modelDescriptions = {
        'gemini-3-pro-preview': 'Best for comprehensive bank statement analysis with high accuracy. Recommended for detailed underwriting.',
        'gemini-3-flash-preview': 'Faster processing with good accuracy. Best for quick preliminary analysis.',
        'gemini-2.5-pro': 'Powerful model with adaptive thinking. Great for complex analysis.',
        'gemini-2.5-flash': 'Fast and efficient for high-volume processing tasks.',
        'gemini-2.5-flash-lite': 'Ultra-fast and cost-effective for simple, high-frequency tasks.',
        'agent:deep-research-pro-preview-12-2025': 'Deep Research Agent - Long-running research with thorough investigation. Uses Interactions API.'
    };

    function updateModelDescription(model) {
        const desc = modelDescriptions[model] || 'Select a model for analysis.';
        document.getElementById('modelDescription').textContent = desc;
    }

    function saveModelSelection() {
        const model = document.getElementById('modelSelect').value;
        localStorage.setItem('geminiModel', model);
        updateModelDescription(model);
    }

    function getSelectedModel() {
        return localStorage.getItem('geminiModel') || 'gemini-3-pro-preview';
    }

    function closeSettings() {
        document.getElementById('settingsOverlay').classList.remove('active');
        document.getElementById('settingsPanel').classList.remove('active');
    }

    function saveApiKey() {
        try {
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            localStorage.setItem('geminiApiKey', apiKey);
            // Also update the main input
            const mainInput = document.getElementById('apiKey');
            if (mainInput) mainInput.value = apiKey;
            if (typeof updateAnalyzeButton === 'function') updateAnalyzeButton();
        } catch(e) {
            console.error('Save error:', e);
        }
        // Always close settings panel
        document.getElementById('settingsOverlay').classList.remove('active');
        document.getElementById('settingsPanel').classList.remove('active');
    }

    function toggleTheme() {
        const body = document.body;
        const toggle = document.getElementById('themeToggle');
        const isDark = body.classList.toggle('dark-theme');
        toggle.classList.toggle('dark', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');

        // Update theme icon
        const themeIcon = document.getElementById('themeIcon');
        if (isDark) {
            themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />';
        } else {
            themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />';
        }

        // Update chart colors for theme
        if (typeof updateChartColors === 'function') {
            updateChartColors();
        }
    }

    function loadSettings() {
        // Load theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            document.getElementById('themeToggle').classList.add('dark');
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />';

            // Set chart defaults for dark mode
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#374151';
        }

        // Load API key
        const savedKey = localStorage.getItem('geminiApiKey');
        if (savedKey) {
            document.getElementById('apiKey').value = savedKey;
            updateAnalyzeButton();
        }
    }

    // File Upload Setup
    function setupFileUpload() {
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
    }

    function handleFiles(files) {
        for (const file of files) {
            if (!uploadedFiles.find(f => f.name === file.name)) {
                uploadedFiles.push(file);
            }
        }
        renderFileList();

        // Auto-analyze after a short delay to let user see the files
        if (uploadedFiles.length > 0) {
            setTimeout(() => {
                autoAnalyze();
            }, 800);
        }
    }

    function autoAnalyze() {
        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            // Show message to configure API key
            document.getElementById('uploadStatus').style.display = 'flex';
            document.getElementById('uploadStatusText').textContent = 'Please configure your Gemini API key in Settings';
            document.getElementById('uploadStatus').querySelector('.upload-spinner').style.display = 'none';
            return;
        }

        // Start analysis automatically
        document.getElementById('apiKey').value = apiKey;
        analyzeDocuments();
    }

    function renderFileList() {
        const fileList = document.getElementById('fileList');
        const uploadSection = document.getElementById('uploadSection');
        const uploadFooter = document.getElementById('uploadFooter');
        const fileCount = document.getElementById('fileCount');

        if (uploadedFiles.length === 0) {
            fileList.innerHTML = '';
            uploadSection.classList.remove('has-files');
            uploadFooter.style.display = 'none';
            return;
        }

        uploadSection.classList.add('has-files');
        uploadFooter.style.display = 'flex';
        fileCount.textContent = `${uploadedFiles.length} file${uploadedFiles.length > 1 ? 's' : ''} selected`;

        fileList.innerHTML = uploadedFiles.map((file, index) => `
            <div class="file-item">
                <div class="file-info">
                    <div class="file-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    </div>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${formatFileSize(file.size)}</span>
                </div>
                <button class="file-remove" onclick="removeFile(${index})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        `).join('');
    }

    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        renderFileList();
        updateAnalyzeButton();
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // API Key Validation
    function setupAPIKeyValidation() {
        const apiKeyInput = document.getElementById('apiKey');
        apiKeyInput.addEventListener('input', updateAnalyzeButton);
    }

    function updateAnalyzeButton() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = !(uploadedFiles.length > 0 && apiKey.length > 10);
    }

    // Main Analysis Function
    async function analyzeDocuments() {
        const apiKey = document.getElementById('apiKey').value.trim();

        if (!apiKey || uploadedFiles.length === 0) {
            showUploadStatus('Please configure API key in Settings');
            return;
        }

        hideError();

        // Show inline loading status below upload box
        showUploadStatus('Preparing documents...');

        try {
            // Convert files to base64 with progress
            const totalFiles = uploadedFiles.length;
            const fileContents = [];

            for (let i = 0; i < uploadedFiles.length; i++) {
                showUploadStatus(`Processing document ${i + 1} of ${totalFiles}...`);
                const file = uploadedFiles[i];
                const base64 = await fileToBase64(file);
                fileContents.push({
                    name: file.name,
                    mimeType: file.type || 'application/pdf',
                    data: base64
                });
            }

            // Process each document INDIVIDUALLY for maximum accuracy
            let response;

            if (fileContents.length === 1) {
                // Single document - process normally
                showUploadStatus('Analyzing document with Gemini Vision OCR...');
                try {
                    response = await callGeminiAPISingle(apiKey, fileContents[0]);
                    if (!response || !response.monthlySummary) {
                        throw new Error('Invalid response from API - missing monthlySummary');
                    }
                } catch (singleDocError) {
                    console.error('Single document processing failed:', singleDocError);
                    throw new Error(`Document processing failed: ${singleDocError.message}`);
                }
            } else {
                // Multiple documents - process each separately then merge
                showUploadStatus(`Analyzing ${totalFiles} documents individually for accuracy...`);
                const allResults = [];

                for (let i = 0; i < fileContents.length; i++) {
                    showUploadStatus(`OCR Extracting document ${i + 1} of ${totalFiles}: ${fileContents[i].name}...`);

                    let retryCount = 0;
                    const maxRetries = 2;
                    let success = false;

                    while (retryCount <= maxRetries && !success) {
                        try {
                            const docResult = await callGeminiAPISingle(apiKey, fileContents[i]);
                            if (docResult && docResult.monthlySummary) {
                                allResults.push(docResult);
                                success = true;
                                console.log(`Document ${i + 1} processed successfully`);
                            } else {
                                throw new Error('Invalid response structure');
                            }
                        } catch (error) {
                            retryCount++;
                            console.error(`Document ${i + 1} attempt ${retryCount} failed:`, error.message);
                            if (retryCount <= maxRetries) {
                                const waitTime = 2000 * retryCount;
                                showUploadStatus(`Retry ${retryCount}/${maxRetries} for document ${i + 1}... (waiting ${waitTime/1000}s)`);
                                await new Promise(r => setTimeout(r, waitTime));
                            } else {
                                console.error(`Failed to process document ${i + 1} after ${maxRetries} retries:`, error);
                                // Continue with other documents
                            }
                        }
                    }

                    // Add delay between documents to avoid rate limiting
                    if (i < fileContents.length - 1 && success) {
                        showUploadStatus(`Document ${i + 1} complete. Preparing next document...`);
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }

                if (allResults.length === 0) {
                    throw new Error('Failed to process any documents');
                }

                showUploadStatus('Merging results from all documents...');
                response = mergeDocumentResults(allResults);
            }

            showUploadStatus('Generating report...');

            // Parse and render the report
            analysisData = response;
            renderReport(analysisData);

            // Hide upload, show report
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('reportContainer').classList.add('visible');
            hideUploadStatus();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (error) {
            // Show error in upload status
            showUploadStatus('Analysis failed: ' + error.message, true);
            console.error('Analysis error:', error);
        }
    }

    function showUploadStatus(message, isError = false) {
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadStatusText = document.getElementById('uploadStatusText');
        const spinner = uploadStatus.querySelector('.upload-spinner');
        const snoodWrapper = document.getElementById('snoodGameWrapper');

        uploadStatus.style.display = 'flex';
        uploadStatusText.textContent = message;

        if (isError) {
            spinner.style.display = 'none';
            uploadStatusText.style.color = 'var(--danger)';
            // Hide game on error
            if (snoodWrapper) {
                snoodWrapper.style.display = 'none';
                stopSnoodGame();
            }
        } else {
            spinner.style.display = 'block';
            uploadStatusText.style.color = 'var(--accent)';
            // Show and start the game
            if (snoodWrapper && snoodWrapper.style.display === 'none') {
                snoodWrapper.style.display = 'flex';
                initSnoodGame();
            }
        }
    }

    function hideUploadStatus() {
        const uploadStatus = document.getElementById('uploadStatus');
        const snoodWrapper = document.getElementById('snoodGameWrapper');
        uploadStatus.style.display = 'none';
        if (snoodWrapper) {
            snoodWrapper.style.display = 'none';
            stopSnoodGame();
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function callGeminiAPI(apiKey, files) {
        const prompt = `Extract ALL data from these bank statement images.

## STEP 1: SUMMARY TOTALS (from Account Summary section)

Copy the bank's printed numbers EXACTLY:
- Beginning Balance  startBalance
- Ending Balance  endBalance
- Total Deposits  totalCredits
- Total Withdrawals  totalDebits
- Number of Deposits  creditCount
- Number of Withdrawals  debitCount
- Average Daily Balance  avgBalance
- Minimum Balance  minBalance

## STEP 2: EXTRACT EVERY TRANSACTION (CRITICAL)

Read the transaction table and extract EVERY ROW into the appropriate array.

For deposits/credits (add to "credits" array):
{"date": "12/01", "description": "ACH DEPOSIT SQUARE INC", "amount": 5000.00}

For withdrawals/debits (add to "debits" array):
{"date": "12/02", "description": "ACH DEBIT PAYROLL", "amount": 3000.00}

IMPORTANT: The sum of all amounts in credits array should equal totalCredits. Extract ALL transactions.

## STEP 3: RISK DETECTION

- NSF: Count transactions with NSF, RETURNED, INSUFFICIENT
- MCA: Look for recurring daily ACH debits ($50-1000) to: LIBERTAS, YELLOWSTONE, CREDIBLY, ONDECK, KAPITUS, RAPID, FUNDBOX, BLUEVINE, FORWARD, FORA
- Owner Draws: Count WIRE OUT, OWNER DRAW, DISTRIBUTION transactions

## OUTPUT (JSON only, no markdown):

{
    "businessInfo": {
        "name": "Business Name",
        "bankName": "Bank Name",
        "accountNumber": "****1234",
        "industry": "Retail/Restaurant/etc",
        "statementPeriod": "Dec 2025",
        "totalDays": 31
    },
    "monthlySummary": [{
        "month": "Dec 2025",
        "totalCredits": 150000,
        "creditCount": 25,
        "totalDebits": 140000,
        "debitCount": 85,
        "startBalance": 15000,
        "endBalance": 25000,
        "avgBalance": 18000,
        "minBalance": 8000,
        "nsfCount": 0,
        "overdraftCount": 0,
        "credits": [
            {"date": "12/01", "description": "ACH CREDIT SQUARE", "amount": 8500},
            {"date": "12/02", "description": "MOBILE DEPOSIT", "amount": 2000}
        ],
        "debits": [
            {"date": "12/01", "description": "ACH DEBIT RENT", "amount": 5000},
            {"date": "12/02", "description": "WIRE OUT", "amount": 10000}
        ]
    }],
    "riskIndicators": {
        "nsfCount": 0,
        "overdraftCount": 0,
        "negativeDays": 0,
        "lowBalanceDays": 0,
        "mcaFound": 0,
        "achReturns": 0,
        "ownerDrawRatio": 15,
        "netMargin": 7
    },
    "mcaAnalysis": {
        "positionsFound": [],
        "totalMonthlyPayments": 0
    }
}

VERIFY: Sum of credits array amounts  totalCredits. Sum of debits array amounts  totalDebits.
CRITICAL: Extract EVERY transaction. Return valid JSON only (no markdown).`;

        // Build the parts array for Gemini
        const parts = [{ text: prompt }];

        for (const file of files) {
            parts.push({
                inline_data: {
                    mime_type: file.mimeType,
                    data: file.data
                }
            });
        }

        const selectedModel = getSelectedModel();
        let response;

        // Check if using Interactions API (agents)
        if (selectedModel.startsWith('agent:')) {
            const agentId = selectedModel.replace('agent:', '');
            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/interactions?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    agent: agentId,
                    contents: [{
                        parts: parts
                    }]
                })
            });
        } else {
            // Standard generateContent API
            response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: parts
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 16384
                    }
                })
            });
        }

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMsg = errorData.error?.message || `API request failed with status ${response.status}`;
            console.error('Gemini API Error:', {
                status: response.status,
                statusText: response.statusText,
                error: errorData,
                model: selectedModel,
                isAgent: selectedModel.startsWith('agent:')
            });
            throw new Error(`Gemini API Error (${response.status}): ${errorMsg}`);
        }

        const data = await response.json();

        // Check for safety/content blocking
        if (data.promptFeedback?.blockReason) {
            throw new Error(`Content blocked by Gemini: ${data.promptFeedback.blockReason}`);
        }

        // Extract text from response
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!text) {
            console.error('Empty Gemini response:', data);
            const finishReason = data.candidates?.[0]?.finishReason;
            if (finishReason && finishReason !== 'STOP') {
                throw new Error(`Gemini returned no text. Reason: ${finishReason}`);
            }
            throw new Error('No response from Gemini API - empty content returned');
        }

        // Parse JSON from response (handle markdown code blocks)
        let jsonStr = text;
        if (text.includes('```json')) {
            jsonStr = text.split('```json')[1].split('```')[0];
        } else if (text.includes('```')) {
            jsonStr = text.split('```')[1].split('```')[0];
        }

        // Clean up common JSON issues
        jsonStr = jsonStr.trim();

        // Try to fix truncated JSON by finding the last complete object
        try {
            return JSON.parse(jsonStr);
        } catch (e) {
            console.log('Initial parse failed, attempting to fix JSON...');
            console.log('Raw response (first 500):', jsonStr.substring(0, 500));
            console.log('Raw response (last 200):', jsonStr.substring(jsonStr.length - 200));

            // Strategy 1: Try to find the last complete structure
            // Look for the last complete property by finding the last ": " followed by a value

            // Remove any incomplete trailing content
            // This handles cases like: ..."value  (truncated mid-string)

            // First, check if we're in the middle of a string
            let lastQuote = jsonStr.lastIndexOf('"');
            let secondLastQuote = jsonStr.lastIndexOf('"', lastQuote - 1);

            // Count quotes to see if we have an unclosed string
            let quoteCount = (jsonStr.match(/(?<!\\)"/g) || []).length;
            if (quoteCount % 2 !== 0) {
                // Odd number of quotes - we're in an unclosed string
                // Find the last opening quote and close it
                jsonStr = jsonStr.substring(0, lastQuote + 1);
                // Add a closing quote if we truncated mid-value
                if (!jsonStr.endsWith('"')) {
                    jsonStr += '"';
                }
            }

            // Remove trailing incomplete key-value pairs
            // Pattern: trailing comma followed by incomplete content
            jsonStr = jsonStr.replace(/,\s*"[^"]*"?\s*:?\s*[^,}\]]*$/g, '');

            // Remove trailing commas before ] or }
            jsonStr = jsonStr.replace(/,\s*([}\]])/g, '$1');

            // Remove trailing comma at end
            jsonStr = jsonStr.replace(/,\s*$/, '');

            // Try to find and close unclosed brackets
            let openBraces = (jsonStr.match(/{/g) || []).length;
            let closeBraces = (jsonStr.match(/}/g) || []).length;
            let openBrackets = (jsonStr.match(/\[/g) || []).length;
            let closeBrackets = (jsonStr.match(/\]/g) || []).length;

            // Add missing closing brackets/braces in correct order
            // We need to close in reverse order of opening
            let stack = [];
            for (let char of jsonStr) {
                if (char === '{') stack.push('}');
                else if (char === '[') stack.push(']');
                else if (char === '}' || char === ']') {
                    if (stack.length > 0 && stack[stack.length - 1] === char) {
                        stack.pop();
                    }
                }
            }

            // Add missing closers in reverse order
            while (stack.length > 0) {
                jsonStr += stack.pop();
            }

            try {
                return JSON.parse(jsonStr);
            } catch (e2) {
                console.error('JSON repair attempt 1 failed:', e2.message);

                // Strategy 2: Try to find the last valid JSON object boundary
                // Look for the last complete object (ends with })
                let lastValidEnd = -1;
                let depth = 0;
                let inString = false;
                let escaped = false;

                for (let i = 0; i < jsonStr.length; i++) {
                    const char = jsonStr[i];

                    if (escaped) {
                        escaped = false;
                        continue;
                    }

                    if (char === '\\') {
                        escaped = true;
                        continue;
                    }

                    if (char === '"') {
                        inString = !inString;
                        continue;
                    }

                    if (inString) continue;

                    if (char === '{' || char === '[') {
                        depth++;
                    } else if (char === '}' || char === ']') {
                        depth--;
                        if (depth === 0) {
                            lastValidEnd = i;
                        }
                    }
                }

                if (lastValidEnd > 0) {
                    try {
                        return JSON.parse(jsonStr.substring(0, lastValidEnd + 1));
                    } catch (e3) {
                        console.error('JSON repair attempt 2 failed:', e3.message);
                    }
                }

                console.log('Final attempted JSON (last 300):', jsonStr.substring(jsonStr.length - 300));
                throw new Error('Failed to parse API response. The response may have been truncated. Please try again.');
            }
        }
    }

    // ========================================
    // TWO-STAGE PIPELINE
    // Stage 1: OCR - Convert image to markdown (pure extraction)
    // Stage 2: Analysis - Parse markdown, categorize, calculate True Revenue
    // ========================================

    // Stage 1: OCR Prompt - Create a "Digital Twin" of the bank statement
    const STAGE1_OCR_PROMPT = `You are a specialized OCR engine for financial documents. Create a faithful text representation of this bank statement.

**Instructions:**
1. **Transcribe All Text:** Extract every piece of text visible, including headers, footers, account info.
2. **Preserve Structure:**
   - Use Markdown tables for transaction listings: | Date | Description | Amount | Balance |
   - Preserve the exact order of transactions as they appear
   - Do NOT merge, summarize, or skip any rows
3. **Account Summary Section:** Copy all printed totals exactly as shown:
   - Beginning Balance, Ending Balance
   - Total Deposits, Total Withdrawals
   - Number of Deposits, Number of Withdrawals
   - Average Daily Balance, Minimum Balance
4. **No Interpretation:** Do not calculate, reformat dates, or correct spelling. Pure extraction only.

**Output Format:**
Return ONLY Markdown text. No JSON. No introductory text. Start with the account information.

Example output structure:
\`\`\`
## Account Information
- Account Holder: BUSINESS NAME LLC
- Bank: CHASE BANK
- Account: ****1234
- Statement Period: December 1 - December 31, 2025

## Account Summary
- Beginning Balance: $15,234.56
- Ending Balance: $18,456.78
- Total Deposits: $52,345.00 (25 items)
- Total Withdrawals: $49,122.78 (87 items)
- Average Daily Balance: $16,500.00
- Minimum Balance: $8,234.00

## Transaction Detail

| Date | Description | Withdrawals | Deposits | Balance |
|------|-------------|-------------|----------|---------|
| 12/01 | Beginning Balance | | | 15,234.56 |
| 12/01 | ACH CREDIT STRIPE | | 3,456.78 | 18,691.34 |
| 12/01 | ACH DEBIT RENT PAYMENT | 5,000.00 | | 13,691.34 |
| 12/02 | WIRE TRANSFER IN CLIENT ABC | | 8,500.00 | 22,191.34 |
...continue for ALL transactions...
\`\`\``;

    // Stage 2: Analysis Prompt - Parse markdown and extract structured data
    const STAGE2_ANALYSIS_PROMPT = `You are a Senior MCA Underwriter analyzing a digitized bank statement to determine True Revenue and risk profile.

**Input:** Markdown transcription of a bank statement.

**Core Objective:** Generate JSON with reconciled monthly summary and risk assessment. Distinguish "Total Deposits" (gross) from "True Revenue" (operational income).

**True Revenue Logic - EXCLUDE these from True Revenue:**
- Internal transfers (TRANSFER FROM SAVINGS, TRANSFER BETWEEN ACCOUNTS)
- Loan proceeds (LOAN DEPOSIT, SBA LOAN, LINE OF CREDIT)
- MCA/Lender funding (ONDECK, KABBAGE, CREDIBLY, BLUEVINE, FUNDBOX funding)
- Tax refunds (IRS TREAS, TAX REFUND)
- Reversed fees, owner injections, NSF reversals

**True Revenue Logic - INCLUDE:**
- Customer payments, merchant processor settlements (STRIPE, SQUARE, CLOVER, TOAST)
- Wire transfers from clients, check deposits from customers
- ACH credits from customers/vendors

**Reconciliation (CRITICAL):**
1. Extract bank's printed "Total Deposits" and "Total Withdrawals" from summary
2. Sum the individual transactions you categorize
3. Compare: If calculated_total != bank_printed_total, set reconciliation_status to "MISMATCH"

**MCA Detection - Look for recurring daily/weekly ACH debits to:**
LIBERTAS, YELLOWSTONE, CREDIBLY, ONDECK, KAPITUS, RAPID, FUNDBOX, BLUEVINE, FORWARD, FORA, CAN CAPITAL, MERCHANT CASH, DAILY ACH

**Owner Draw Detection:**
WIRE OUT, OWNER DRAW, DISTRIBUTION, SHAREHOLDER, PERSONAL TRANSFER

**JSON Output (strict schema, no markdown wrapper):**
{
    "businessInfo": {
        "name": "Business Name",
        "bankName": "Bank Name",
        "accountNumber": "****1234",
        "statementPeriod": "Dec 2025"
    },
    "monthlySummary": [{
        "month": "Dec 2025",
        "bankTotals": {
            "totalDeposits": 52345.00,
            "totalWithdrawals": 49122.78,
            "depositCount": 25,
            "withdrawalCount": 87
        },
        "calculatedTotals": {
            "totalCredits": 52345.00,
            "totalDebits": 49122.78,
            "trueRevenue": 48500.00,
            "excludedDeposits": 3845.00
        },
        "reconciliationStatus": "MATCH",
        "discrepancyAmount": 0,
        "startBalance": 15234.56,
        "endBalance": 18456.78,
        "avgBalance": 16500.00,
        "minBalance": 8234.00,
        "nsfCount": 0,
        "overdraftCount": 0,
        "credits": [
            {"date": "12/01", "description": "ACH CREDIT STRIPE", "amount": 3456.78, "isTrueRevenue": true, "category": "Merchant Processing"},
            {"date": "12/02", "description": "TRANSFER FROM SAVINGS", "amount": 2000.00, "isTrueRevenue": false, "category": "Internal Transfer"}
        ],
        "debits": [
            {"date": "12/01", "description": "ACH DEBIT RENT", "amount": 5000.00, "category": "Rent"},
            {"date": "12/01", "description": "ACH DEBIT LIBERTAS FUNDING", "amount": 450.00, "category": "MCA Payment"}
        ]
    }],
    "riskIndicators": {
        "nsfCount": 0,
        "overdraftCount": 0,
        "negativeDays": 0,
        "lowBalanceDays": 0,
        "mcaFound": 1,
        "achReturns": 0,
        "ownerDrawRatio": 15,
        "netMargin": 7
    },
    "mcaAnalysis": {
        "positionsFound": [
            {"lender": "Libertas", "dailyPayment": 450, "frequency": "daily", "estimatedBalance": 13500}
        ],
        "totalMonthlyPayments": 9900
    },
    "trueRevenueBreakdown": {
        "merchantProcessing": 35000,
        "wireTransfers": 8500,
        "checkDeposits": 5000,
        "excludedTransfers": 2000,
        "excludedLoans": 1845
    }
}

CRITICAL: Extract EVERY transaction. Calculate True Revenue by excluding non-operational deposits. Return valid JSON only.`;

    // Single document extraction using three-stage pipeline
    async function callGeminiAPISingle(apiKey, file) {
        const selectedModel = getSelectedModel();
        // Don't use agent models for OCR - use standard Gemini
        const model = selectedModel.startsWith('agent:') ? 'gemini-3-pro-preview' : selectedModel;

        // Reset correction attempts for new analysis
        correctionAttempts = 0;

        console.log('=== STAGE 1: OCR (Image  Markdown) ===');
        updateUploadStatus('Stage 1: Extracting text from image...', false);

        // Stage 1: OCR - Convert image to markdown
        const markdownResult = await callGeminiStage1OCR(apiKey, model, file);
        console.log('Stage 1 complete. Markdown length:', markdownResult.length);
        console.log('Stage 1 output preview:', markdownResult.substring(0, 500));

        console.log('=== STAGE 2: Analysis (Markdown  JSON) ===');
        updateUploadStatus('Stage 2: Analyzing transactions & True Revenue...', false);

        // Stage 2: Analysis - Parse markdown and extract structured data
        const analysisResult = await callGeminiStage2Analysis(apiKey, model, markdownResult);
        console.log('Stage 2 complete. Result:', analysisResult);

        // Transform new schema to existing schema for compatibility
        const transformed = transformToLegacySchema(analysisResult, markdownResult);

        // Stage 3: Verification and Self-Correction
        const verified = await runStage3Verification(apiKey, model, transformed, markdownResult);

        console.log('=== PIPELINE COMPLETE ===');
        console.log('Reconciliation status:', verified._reconciliationStatus || 'UNKNOWN');

        return verified;
    }

    // Stage 1: OCR - Pure text extraction
    async function callGeminiStage1OCR(apiKey, model, file) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: STAGE1_OCR_PROMPT },
                            { inline_data: { mime_type: file.mimeType, data: file.data } }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.0,  // Zero temperature for consistent OCR
                        maxOutputTokens: 32768  // Large output for full transaction list
                    }
                })
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Stage 1 OCR Error (${response.status}): ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();

            if (data.promptFeedback?.blockReason) {
                throw new Error(`Content blocked in Stage 1: ${data.promptFeedback.blockReason}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                const finishReason = data.candidates?.[0]?.finishReason;
                throw new Error(`Stage 1 returned no text. Reason: ${finishReason || 'unknown'}`);
            }

            return text;
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error('Stage 1 OCR timed out after 2 minutes');
            }
            throw error;
        }
    }

    // Stage 2: Analysis - Parse markdown and extract structured JSON
    async function callGeminiStage2Analysis(apiKey, model, markdownText) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);

        const fullPrompt = STAGE2_ANALYSIS_PROMPT + '\n\n--- BANK STATEMENT TEXT ---\n\n' + markdownText;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: fullPrompt }]
                    }],
                    generationConfig: {
                        temperature: 0.1,  // Low temperature for consistent analysis
                        maxOutputTokens: 32768
                    }
                })
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Stage 2 Analysis Error (${response.status}): ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();

            if (data.promptFeedback?.blockReason) {
                throw new Error(`Content blocked in Stage 2: ${data.promptFeedback.blockReason}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                const finishReason = data.candidates?.[0]?.finishReason;
                throw new Error(`Stage 2 returned no text. Reason: ${finishReason || 'unknown'}`);
            }

            // Parse JSON from response
            let jsonStr = text;
            if (text.includes('```json')) {
                jsonStr = text.split('```json')[1].split('```')[0];
            } else if (text.includes('```')) {
                jsonStr = text.split('```')[1].split('```')[0];
            }

            return JSON.parse(jsonStr.trim());
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error('Stage 2 Analysis timed out after 2 minutes');
            }
            throw error;
        }
    }

    // Direct API call for self-correction (no prepended system prompt)
    async function callGeminiDirectPrompt(apiKey, model, prompt) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000);

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 32768
                    }
                })
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API Error (${response.status}): ${errorData.error?.message || response.statusText}`);
            }

            const data = await response.json();

            if (data.promptFeedback?.blockReason) {
                throw new Error(`Content blocked: ${data.promptFeedback.blockReason}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                throw new Error('Empty response from API');
            }

            // Parse JSON from response
            let jsonStr = text;
            if (text.includes('```json')) {
                jsonStr = text.split('```json')[1].split('```')[0];
            } else if (text.includes('```')) {
                jsonStr = text.split('```')[1].split('```')[0];
            }

            return JSON.parse(jsonStr.trim());
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error('Request timed out');
            }
            throw error;
        }
    }

    // Stage 3: Self-correction prompt for reconciliation errors
    function getSelfCorrectionPrompt(discrepancy, markdownText, previousAnalysis) {
        return `RECONCILIATION ERROR DETECTED

The calculated total credits ($${previousAnalysis.monthlySummary?.[0]?.trueCredits?.toFixed(2) || '0.00'}) do not match the bank's printed total deposits ($${previousAnalysis.monthlySummary?.[0]?.totalCredits?.toFixed(2) || '0.00'}).

Discrepancy: $${Math.abs(discrepancy).toFixed(2)}

TASK: Review the original Markdown transcription below and find the missing or misread transaction(s).

Common causes:
1. Missed a transaction near a page break
2. Misread a digit (OCR error: 0/O, 1/l, 5/S)
3. Incorrectly classified a credit as a debit
4. Missed a deposit that spans multiple lines

ORIGINAL MARKDOWN:
${markdownText}

PREVIOUS ANALYSIS (first 2000 chars):
${JSON.stringify(previousAnalysis, null, 2).substring(0, 2000)}

INSTRUCTIONS:
1. Find the missing/incorrect $${Math.abs(discrepancy).toFixed(2)}
2. Update the transactions array with the correction
3. Recalculate all totals
4. Return the corrected JSON using the same schema as before

Return ONLY the corrected JSON object - no explanations.`;
    }

    // Stage 3: Verification and Self-Correction
    const MAX_CORRECTIONS = 3;
    let correctionAttempts = 0;

    async function runStage3Verification(apiKey, model, analysisResult, markdownText) {
        console.log('=== STAGE 3: Verification ===');
        updateUploadStatus('Stage 3: Verifying reconciliation...', false);

        const months = analysisResult.monthlySummary || [];
        if (months.length === 0) return analysisResult;

        // Calculate total discrepancy
        let totalBankDeposits = 0;
        let totalCalcCredits = 0;

        for (const month of months) {
            const bankDep = month.bankTotals?.totalDeposits || month.totalCredits || 0;
            const calcCred = month.calculatedTotals?.totalCredits || month.trueCredits || 0;
            totalBankDeposits += bankDep;
            totalCalcCredits += calcCred;
        }

        const discrepancy = totalBankDeposits - totalCalcCredits;
        console.log(`Reconciliation check: Bank=$${totalBankDeposits.toFixed(2)}, Calc=$${totalCalcCredits.toFixed(2)}, Diff=$${discrepancy.toFixed(2)}`);

        // If discrepancy is small (<$1), we're good
        if (Math.abs(discrepancy) <= 1.00) {
            console.log('Reconciliation VERIFIED');
            analysisResult._reconciliationStatus = 'VERIFIED';
            return analysisResult;
        }

        // If discrepancy exists and we haven't exceeded correction attempts
        if (correctionAttempts < MAX_CORRECTIONS) {
            correctionAttempts++;
            console.log(`Reconciliation MISMATCH: $${discrepancy.toFixed(2)} - attempting correction (${correctionAttempts}/${MAX_CORRECTIONS})`);
            updateUploadStatus(`Stage 3: Correcting discrepancy ($${Math.abs(discrepancy).toFixed(2)}) - attempt ${correctionAttempts}/${MAX_CORRECTIONS}...`, false);

            try {
                const correctionPrompt = getSelfCorrectionPrompt(discrepancy, markdownText, analysisResult);
                const correctedResponse = await callGeminiDirectPrompt(apiKey, model, correctionPrompt);

                if (correctedResponse) {
                    // Transform and recursively verify
                    const transformed = transformToLegacySchema(correctedResponse, markdownText);
                    return await runStage3Verification(apiKey, model, transformed, markdownText);
                }
            } catch (error) {
                console.error('Self-correction failed:', error.message);
            }
        }

        // If we've exceeded attempts or correction failed
        console.log(`Reconciliation FAILED after ${correctionAttempts} attempts`);
        analysisResult._reconciliationStatus = 'MISMATCH';
        analysisResult._reconciliationDiscrepancy = discrepancy;
        return analysisResult;
    }

    // Transform new two-stage schema to legacy schema for UI compatibility
    function transformToLegacySchema(analysisResult, markdownText) {
        // Store the raw markdown for debugging/display
        analysisResult._rawMarkdown = markdownText;

        // Transform monthlySummary to legacy format
        if (analysisResult.monthlySummary) {
            for (const month of analysisResult.monthlySummary) {
                // Map new bankTotals/calculatedTotals to legacy flat structure
                if (month.bankTotals) {
                    month.totalCredits = month.bankTotals.totalDeposits || month.totalCredits || 0;
                    month.totalDebits = month.bankTotals.totalWithdrawals || month.totalDebits || 0;
                    month.creditCount = month.bankTotals.depositCount || month.creditCount || 0;
                    month.debitCount = month.bankTotals.withdrawalCount || month.debitCount || 0;
                }

                if (month.calculatedTotals) {
                    month.trueCredits = month.calculatedTotals.totalCredits || 0;
                    month.trueDebits = month.calculatedTotals.totalDebits || 0;
                    month.trueRevenue = month.calculatedTotals.trueRevenue || 0;
                    month.excludedDeposits = month.calculatedTotals.excludedDeposits || 0;
                }

                // Calculate trueCredits/trueDebits from transaction arrays if not provided
                if (!month.trueCredits || month.trueCredits === 0) {
                    month.trueCredits = (month.credits || []).reduce((sum, t) => sum + (t.amount || 0), 0);
                }
                if (!month.trueDebits || month.trueDebits === 0) {
                    month.trueDebits = (month.debits || []).reduce((sum, t) => sum + (t.amount || 0), 0);
                }

                // Calculate trueRevenue if not provided (sum of credits where isTrueRevenue === true)
                if (!month.trueRevenue || month.trueRevenue === 0) {
                    month.trueRevenue = (month.credits || [])
                        .filter(t => t.isTrueRevenue !== false)
                        .reduce((sum, t) => sum + (t.amount || 0), 0);
                }
            }
        }

        return analysisResult;
    }

    // Legacy single-stage function (kept for fallback)
    async function callGeminiAPISingleLegacy(apiKey, file) {
        const prompt = `Extract ALL data from this bank statement image.

## STEP 1: SUMMARY SECTION (from Account Summary box)

Copy the bank's printed totals EXACTLY:
- Beginning Balance  startBalance
- Ending Balance  endBalance
- Total Deposits  totalCredits
- Total Withdrawals  totalDebits
- Number of Deposits  creditCount
- Number of Withdrawals  debitCount
- Average Daily Balance  avgBalance
- Minimum Balance  minBalance

## STEP 2: EXTRACT EVERY TRANSACTION (CRITICAL)

Read the transaction table and extract EVERY SINGLE ROW. This is critical for verification.

For EACH deposit/credit transaction, add to "credits" array:
{"date": "12/01", "description": "ACH DEPOSIT SQUARE INC", "amount": 1234.56}

For EACH withdrawal/debit transaction, add to "debits" array:
{"date": "12/01", "description": "ACH DEBIT INSURANCE", "amount": 500.00}

IMPORTANT: Extract ALL transactions, not just a sample. The sum of credits array should approximately equal totalCredits.

## STEP 3: NSF/OVERDRAFT DETECTION

Count any transactions with: NSF, OVERDRAFT, OD FEE, RETURNED ITEM, INSUFFICIENT FUNDS

## OUTPUT FORMAT (JSON only, no markdown):

{
    "businessInfo": {
        "name": "Business Name from statement",
        "bankName": "Bank Name",
        "accountNumber": "****1234",
        "statementPeriod": "Dec 2025"
    },
    "monthlySummary": [{
        "month": "Dec 2025",
        "totalCredits": 50000,
        "creditCount": 15,
        "totalDebits": 45000,
        "debitCount": 80,
        "startBalance": 10000,
        "endBalance": 15000,
        "avgBalance": 12000,
        "minBalance": 5000,
        "nsfCount": 0,
        "overdraftCount": 0,
        "credits": [
            {"date": "12/01", "description": "DEPOSIT", "amount": 5000},
            {"date": "12/05", "description": "ACH CREDIT", "amount": 3000}
        ],
        "debits": [
            {"date": "12/02", "description": "CHECK 1234", "amount": 1000},
            {"date": "12/03", "description": "ACH DEBIT", "amount": 500}
        ]
    }],
    "riskIndicators": {
        "nsfCount": 0,
        "overdraftCount": 0,
        "negativeDays": 0,
        "lowBalanceDays": 0,
        "mcaFound": 0,
        "achReturns": 0
    },
    "mcaAnalysis": {
        "positionsFound": [],
        "totalMonthlyPayments": 0
    }
}

CRITICAL: Include EVERY transaction from the statement in credits/debits arrays. All numbers must be numeric (not strings).`;

        const selectedModel = getSelectedModel();

        // Don't use agent models for OCR - use standard Gemini
        const model = selectedModel.startsWith('agent:') ? 'gemini-3-pro-preview' : selectedModel;

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                signal: controller.signal,
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: file.mimeType, data: file.data } }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 16384
                    }
                })
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error?.message || `API request failed with status ${response.status}`;
                console.error('Gemini API Error:', {
                    status: response.status,
                    statusText: response.statusText,
                    error: errorData,
                    model: model,
                    endpoint: `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`
                });
                throw new Error(`Gemini API Error (${response.status}): ${errorMsg}`);
            }

            const data = await response.json();

            // Check for blocked content or safety issues
            if (data.promptFeedback?.blockReason) {
                throw new Error(`Content blocked: ${data.promptFeedback.blockReason}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) {
                console.error('Empty API response:', data);
                const finishReason = data.candidates?.[0]?.finishReason;
                if (finishReason && finishReason !== 'STOP') {
                    throw new Error(`API returned no text. Finish reason: ${finishReason}`);
                }
                throw new Error('No response from API - the model returned empty content');
            }

            // Parse JSON
            let jsonStr = text;
            if (text.includes('```json')) {
                jsonStr = text.split('```json')[1].split('```')[0];
            } else if (text.includes('```')) {
                jsonStr = text.split('```')[1].split('```')[0];
            }

            return JSON.parse(jsonStr.trim());
        } catch (error) {
            clearTimeout(timeoutId);
            if (error.name === 'AbortError') {
                throw new Error('Request timed out after 2 minutes');
            }
            throw error;
        }
    }

    // Merge results from multiple documents into one report
    function mergeDocumentResults(results) {
        if (results.length === 0) return null;
        if (results.length === 1) return results[0];

        // Start with first result as base
        const merged = {
            businessInfo: results[0].businessInfo || {},
            monthlySummary: [],
            riskIndicators: {
                nsfCount: 0,
                overdraftCount: 0,
                negativeDays: 0,
                lowBalanceDays: 0,
                mcaFound: 0,
                achReturns: 0,
                ownerDrawRatio: 0,
                netMargin: 0
            },
            mcaAnalysis: {
                positionsFound: [],
                lendersScanned: ["Credibly", "Libertas", "Yellowstone", "Fora Financial", "OnDeck", "Kabbage", "BlueVine", "Rapid Finance", "Square Capital", "PayPal Working Capital", "Amazon Lending", "Fundbox", "Kapitus", "CAN Capital", "Forward Financing"],
                totalMonthlyPayments: 0
            },
            revenueSources: [],
            expenseCategories: [],
            cashFlowData: {
                dailyBalances: [],
                weeklyDeposits: [],
                weeklyWithdrawals: [],
                dayOfWeekRevenue: [0, 0, 0, 0, 0, 0, 0]
            },
            depositDistribution: {
                ranges: ["$0-50", "$51-100", "$101-200", "$201-500", "$500+"],
                counts: [0, 0, 0, 0, 0]
            },
            underwritingScore: { overall: 0, recommendation: "Manual Review", tier: 2, criteria: [] },
            recommendedPosition: {},
            paymentCapacity: {},
            benchmarks: { businessScores: [], industryAvg: [], percentiles: [] }
        };

        // Merge monthly summaries from all documents
        const allMonths = [];
        const mcaPositions = new Map(); // Track unique MCA positions

        for (const result of results) {
            // Add monthly summaries
            if (result.monthlySummary) {
                for (const month of result.monthlySummary) {
                    allMonths.push(month);
                }
            }

            // Merge daily balances
            if (result.dailyBalances) {
                merged.cashFlowData.dailyBalances.push(...result.dailyBalances);
            }
            if (result.cashFlowData?.dailyBalances) {
                merged.cashFlowData.dailyBalances.push(...result.cashFlowData.dailyBalances);
            }

            // Sum risk indicators
            if (result.riskIndicators) {
                merged.riskIndicators.nsfCount += result.riskIndicators.nsfCount || 0;
                merged.riskIndicators.overdraftCount += result.riskIndicators.overdraftCount || 0;
                merged.riskIndicators.negativeDays += result.riskIndicators.negativeDays || 0;
                merged.riskIndicators.lowBalanceDays += result.riskIndicators.lowBalanceDays || 0;
                merged.riskIndicators.achReturns += result.riskIndicators.achReturns || 0;
            }

            // Merge MCA positions (dedupe by name)
            if (result.mcaAnalysis?.positionsFound) {
                for (const pos of result.mcaAnalysis.positionsFound) {
                    if (pos.name && !mcaPositions.has(pos.name)) {
                        mcaPositions.set(pos.name, pos);
                    }
                }
            }
        }

        // Sort months chronologically
        allMonths.sort((a, b) => {
            const parseMonth = (m) => {
                if (!m.month) return 0;
                const parts = m.month.split(' ');
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                const monthIdx = monthNames.findIndex(n => m.month.toLowerCase().includes(n.toLowerCase()));
                const year = parseInt(parts.find(p => /^\d{4}$/.test(p))) || 2025;
                return year * 12 + monthIdx;
            };
            return parseMonth(a) - parseMonth(b);
        });

        merged.monthlySummary = allMonths;
        merged.mcaAnalysis.positionsFound = Array.from(mcaPositions.values());
        merged.riskIndicators.mcaFound = merged.mcaAnalysis.positionsFound.length;

        // Calculate trueCredits/trueDebits from transaction arrays and totals
        let totalCredits = 0, totalDebits = 0, totalCreditCount = 0, totalDebitCount = 0;
        for (const month of allMonths) {
            // Calculate true values from transaction arrays
            const trueCredits = (month.credits || []).reduce((sum, t) => sum + (t.amount || 0), 0);
            const trueDebits = (month.debits || []).reduce((sum, t) => sum + (t.amount || 0), 0);
            const trueCreditCount = (month.credits || []).length;
            const trueDebitCount = (month.debits || []).length;

            // Store calculated values
            month.trueCredits = Math.round(trueCredits * 100) / 100;
            month.trueDebits = Math.round(trueDebits * 100) / 100;

            // Use bank's totals if available, fall back to calculated
            month.totalCredits = month.totalCredits || trueCredits;
            month.totalDebits = month.totalDebits || trueDebits;
            month.creditCount = month.creditCount || trueCreditCount;
            month.debitCount = month.debitCount || trueDebitCount;

            totalCredits += month.totalCredits || 0;
            totalDebits += month.totalDebits || 0;
            totalCreditCount += month.creditCount || 0;
            totalDebitCount += month.debitCount || 0;
        }

        // Calculate derived metrics
        const numMonths = allMonths.length || 1;
        const avgMonthlyCredits = totalCredits / numMonths;
        const avgMonthlyDebits = totalDebits / numMonths;

        merged.riskIndicators.netMargin = totalCredits > 0
            ? Math.round(((totalCredits - totalDebits) / totalCredits) * 100 * 10) / 10
            : 0;

        // Calculate owner draw ratio from actual transactions
        let ownerDrawTotal = 0;
        for (const month of allMonths) {
            for (const debit of (month.debits || [])) {
                const desc = (debit.description || '').toUpperCase();
                if (desc.includes('OWNER') || desc.includes('DRAW') ||
                    desc.includes('WIRE OUT') || desc.includes('WIRE TRANSFER OUT') ||
                    desc.includes('TRANSFER TO SAVINGS') || desc.includes('PERSONAL') ||
                    desc.includes('DISTRIBUTION')) {
                    ownerDrawTotal += debit.amount || 0;
                }
            }
        }
        merged.riskIndicators.ownerDrawRatio = totalDebits > 0
            ? Math.round((ownerDrawTotal / totalDebits) * 100)
            : 0;

        // Update statement period
        if (allMonths.length > 0) {
            const firstMonth = allMonths[0].month || '';
            const lastMonth = allMonths[allMonths.length - 1].month || '';
            merged.businessInfo.statementPeriod = firstMonth === lastMonth ? firstMonth : `${firstMonth} - ${lastMonth}`;
            merged.businessInfo.totalDays = allMonths.length * 30;
        }

        // Generate underwriting score
        merged.underwritingScore = calculateUnderwritingScore(merged);
        merged.recommendedPosition = calculateRecommendedPosition(merged);
        merged.paymentCapacity = calculatePaymentCapacity(merged);

        // Aggregate revenue sources and expense categories
        merged.revenueSources = aggregateCategories(allMonths, 'credits');
        merged.expenseCategories = aggregateCategories(allMonths, 'debits');

        return merged;
    }

    // Helper: Aggregate transaction categories
    function aggregateCategories(months, type) {
        const categories = new Map();

        for (const month of months) {
            const transactions = month[type] || [];
            for (const txn of transactions) {
                const category = categorizeTransaction(txn.description, type);
                const current = categories.get(category) || 0;
                categories.set(category, current + (txn.amount || 0));
            }
        }

        const total = Array.from(categories.values()).reduce((a, b) => a + b, 0) || 1;
        return Array.from(categories.entries())
            .map(([name, amount]) => ({
                name,
                amount: Math.round(amount),
                percentage: Math.round((amount / total) * 100 * 10) / 10
            }))
            .sort((a, b) => b.amount - a.amount)
            .slice(0, 6);
    }

    // Helper: Categorize transaction by description
    function categorizeTransaction(desc, type) {
        if (!desc) return 'Other';
        const d = desc.toUpperCase();

        if (type === 'credits') {
            if (d.includes('SQUARE') || d.includes('STRIPE') || d.includes('PAYPAL') || d.includes('CLOVER')) return 'Card Processing';
            if (d.includes('ACH') || d.includes('DEPOSIT')) return 'ACH Deposits';
            if (d.includes('WIRE') || d.includes('TRANSFER')) return 'Wire Transfers';
            if (d.includes('CHECK') || d.includes('DEP')) return 'Check Deposits';
            return 'Other Deposits';
        } else {
            if (d.includes('WIRE') || d.includes('OWNER') || d.includes('DRAW')) return 'Owner Draws/Wires';
            if (d.includes('PAYROLL') || d.includes('GUSTO') || d.includes('ADP')) return 'Payroll';
            if (d.includes('RENT') || d.includes('LEASE')) return 'Rent/Lease';
            if (d.includes('UTILITY') || d.includes('ELECTRIC') || d.includes('GAS')) return 'Utilities';
            if (d.includes('FEE') || d.includes('SERVICE')) return 'Bank Fees';
            if (d.includes('LOAN') || d.includes('PAYMENT')) return 'Loan Payments';
            return 'Other Expenses';
        }
    }

    // Helper: Calculate underwriting score
    function calculateUnderwritingScore(data) {
        const months = data.monthlySummary || [];
        const avgCredits = months.length > 0
            ? months.reduce((sum, m) => sum + (m.totalCredits || 0), 0) / months.length
            : 0;
        const avgBalance = months.length > 0
            ? months.reduce((sum, m) => sum + (m.avgBalance || 0), 0) / months.length
            : 0;
        const avgCreditCount = months.length > 0
            ? months.reduce((sum, m) => sum + (m.creditCount || 0), 0) / months.length
            : 0;
        const risk = data.riskIndicators || {};

        const criteria = [
            { name: "Minimum Monthly Revenue ($5,000)", passed: avgCredits >= 5000, value: "$" + Math.round(avgCredits).toLocaleString() },
            { name: "Minimum Average Balance ($250)", passed: avgBalance >= 250, value: "$" + Math.round(avgBalance).toLocaleString() },
            { name: "Maximum NSF Count (3)", passed: (risk.nsfCount || 0) <= 3, value: String(risk.nsfCount || 0) },
            { name: "No Negative Balance Days", passed: (risk.negativeDays || 0) === 0, value: (risk.negativeDays || 0) + " days" },
            { name: "Deposit Consistency (Min 20/mo)", passed: avgCreditCount >= 20, value: String(Math.round(avgCreditCount)) },
            { name: "No Existing MCA Stacking", passed: (risk.mcaFound || 0) <= 1, value: (risk.mcaFound || 0) === 0 ? "None Found" : risk.mcaFound + " Found" },
            { name: "Positive Net Cash Flow", passed: (risk.netMargin || 0) >= 0, value: (risk.netMargin || 0) + "%" },
            { name: "Owner Draw Ratio (<50%)", passed: (risk.ownerDrawRatio || 0) < 50, value: (risk.ownerDrawRatio || 0) + "%" }
        ];

        const passedCount = criteria.filter(c => c.passed).length;
        const overall = Math.round((passedCount / criteria.length) * 100);

        let recommendation = "Decline";
        let tier = 3;
        if (overall >= 80) { recommendation = "Approve"; tier = 1; }
        else if (overall >= 50) { recommendation = "Manual Review"; tier = 2; }

        return { overall, recommendation, tier, criteria };
    }

    // Helper: Calculate recommended position
    function calculateRecommendedPosition(data) {
        const months = data.monthlySummary || [];
        const avgCredits = months.length > 0
            ? months.reduce((sum, m) => sum + (m.totalCredits || 0), 0) / months.length
            : 0;
        const tier = data.underwritingScore?.tier || 2;

        const multiplier = tier === 1 ? 1.2 : tier === 2 ? 0.8 : 0.5;
        const amount = Math.round(avgCredits * multiplier / 500) * 500;
        const factorRate = tier === 1 ? 1.29 : tier === 2 ? 1.39 : 1.49;
        const termDays = tier === 1 ? 150 : tier === 2 ? 120 : 90;

        return {
            amount,
            rangeMin: Math.round(amount * 0.7 / 500) * 500,
            rangeMax: Math.round(amount * 1.3 / 500) * 500,
            factorRate,
            paybackAmount: Math.round(amount * factorRate),
            dailyPayment: Math.round((amount * factorRate) / termDays),
            termDays
        };
    }

    // Helper: Calculate payment capacity
    function calculatePaymentCapacity(data) {
        const months = data.monthlySummary || [];
        const totalCredits = months.reduce((sum, m) => sum + (m.totalCredits || 0), 0);
        const totalDays = (months.length || 1) * 30;
        const dailyRevenue = totalCredits / totalDays;

        return {
            maxDaily10Pct: Math.round(dailyRevenue * 0.10),
            maxDaily15Pct: Math.round(dailyRevenue * 0.15),
            maxWeekly: Math.round(dailyRevenue * 0.15 * 7),
            recommendedHoldback: 12,
            dailyRevenue: Math.round(dailyRevenue)
        };
    }

    // Render Report Functions
    function renderReport(data) {
        // Ensure all required data structures exist with defaults
        data.businessInfo = data.businessInfo || {};
        data.monthlySummary = data.monthlySummary || [{}];
        data.riskIndicators = data.riskIndicators || {};
        data.mcaAnalysis = data.mcaAnalysis || { positionsFound: [], lendersScanned: [] };
        data.revenueSources = data.revenueSources || [];
        data.expenseCategories = data.expenseCategories || [];
        data.cashFlowData = data.cashFlowData || {};
        data.depositDistribution = data.depositDistribution || { ranges: [], counts: [] };
        data.underwritingScore = data.underwritingScore || { overall: 0, recommendation: 'Manual Review', tier: 2, criteria: [] };
        data.recommendedPosition = data.recommendedPosition || {};
        data.paymentCapacity = data.paymentCapacity || {};
        data.benchmarks = data.benchmarks || { businessScores: [], industryAvg: [], percentiles: [] };

        // Calculate trueCredits/trueDebits for each month if not present
        let totalCredits = 0, totalDebits = 0, ownerDrawTotal = 0;
        for (const month of data.monthlySummary) {
            // Calculate true values from transaction arrays
            const credits = month.credits || [];
            const debits = month.debits || [];

            if (!month.trueCredits || month.trueCredits === 0) {
                month.trueCredits = credits.reduce((sum, t) => sum + (t.amount || 0), 0);
                month.trueCredits = Math.round(month.trueCredits * 100) / 100;
            }
            if (!month.trueDebits || month.trueDebits === 0) {
                month.trueDebits = debits.reduce((sum, t) => sum + (t.amount || 0), 0);
                month.trueDebits = Math.round(month.trueDebits * 100) / 100;
            }

            totalCredits += month.totalCredits || month.trueCredits || 0;
            totalDebits += month.totalDebits || month.trueDebits || 0;

            // Calculate owner draws from transactions
            for (const debit of debits) {
                const desc = (debit.description || '').toUpperCase();
                if (desc.includes('OWNER') || desc.includes('DRAW') ||
                    desc.includes('WIRE OUT') || desc.includes('WIRE TRANSFER OUT') ||
                    desc.includes('TRANSFER TO SAVINGS') || desc.includes('PERSONAL') ||
                    desc.includes('DISTRIBUTION')) {
                    ownerDrawTotal += debit.amount || 0;
                }
            }
        }

        // Calculate netMargin and ownerDrawRatio if not present
        if (typeof data.riskIndicators.netMargin !== 'number' || isNaN(data.riskIndicators.netMargin)) {
            data.riskIndicators.netMargin = totalCredits > 0
                ? Math.round(((totalCredits - totalDebits) / totalCredits) * 100 * 10) / 10
                : 0;
        }
        if (typeof data.riskIndicators.ownerDrawRatio !== 'number' || isNaN(data.riskIndicators.ownerDrawRatio)) {
            data.riskIndicators.ownerDrawRatio = totalDebits > 0
                ? Math.round((ownerDrawTotal / totalDebits) * 100)
                : 0;
        }

        // Ensure arrays have data
        if (!data.cashFlowData.dailyBalances || data.cashFlowData.dailyBalances.length === 0) {
            data.cashFlowData.dailyBalances = [0];
        }
        if (!data.cashFlowData.weeklyDeposits || data.cashFlowData.weeklyDeposits.length === 0) {
            data.cashFlowData.weeklyDeposits = [0];
        }
        if (!data.cashFlowData.weeklyWithdrawals || data.cashFlowData.weeklyWithdrawals.length === 0) {
            data.cashFlowData.weeklyWithdrawals = [0];
        }
        if (!data.cashFlowData.dayOfWeekRevenue || data.cashFlowData.dayOfWeekRevenue.length === 0) {
            data.cashFlowData.dayOfWeekRevenue = [0, 0, 0, 0, 0, 0, 0];
        }
        if (!data.depositDistribution.counts || data.depositDistribution.counts.length === 0) {
            data.depositDistribution.ranges = ['$0-100', '$100-500', '$500+'];
            data.depositDistribution.counts = [1, 1, 1];
        }
        if (!data.benchmarks.businessScores || data.benchmarks.businessScores.length === 0) {
            data.benchmarks.businessScores = [50, 50, 50, 50, 50, 50];
        }
        if (!data.benchmarks.industryAvg || data.benchmarks.industryAvg.length === 0) {
            data.benchmarks.industryAvg = [50, 50, 50, 50, 50, 50];
        }
        if (!data.benchmarks.percentiles || data.benchmarks.percentiles.length === 0) {
            data.benchmarks.percentiles = [50, 50, 50, 50, 50];
        }

        renderBusinessInfo(data);
        renderMetricsRow(data);
        renderAccountTable(data);
        renderRiskIndicators(data);
        renderPaymentCapacity(data);
        renderUnderwritingScorecard(data);
        renderCashFlowCharts(data);
        renderRevenueAnalysis(data);
        renderExpenseAnalysis(data);
        renderMCAAnalysis(data);
        renderBenchmarks(data);
        renderRecommendedPosition(data);
    }

    function renderBusinessInfo(data) {
        const info = data.businessInfo;
        document.getElementById('businessName').textContent = info.name || '--';
        document.getElementById('bankAccount').textContent = `${info.bankName} ${info.accountNumber}`;
        document.getElementById('statementPeriod').textContent = info.statementPeriod;
        document.getElementById('industryType').textContent = info.industry;
        document.getElementById('accountBadge').textContent = `${info.bankName} ${info.accountNumber}`;
        document.getElementById('periodBadge').textContent = `${info.totalDays} Days`;
        document.getElementById('benchmarkIndustry').textContent = info.industry;

        // Score and status
        const score = data.underwritingScore;
        document.getElementById('overallScore').textContent = score.overall;

        const statusPill = document.getElementById('statusPill');
        const recommendation = score.recommendation || 'Manual Review';
        statusPill.textContent = recommendation;
        statusPill.className = 'status-pill';
        if (recommendation.toLowerCase().includes('approve')) {
            statusPill.classList.add('approve');
        } else if (recommendation.toLowerCase().includes('decline')) {
            statusPill.classList.add('decline');
        } else {
            statusPill.classList.add('review');
        }
    }

    function renderMetricsRow(data) {
        // Calculate totals across all months
        const totals = data.monthlySummary.reduce((acc, row) => ({
            totalCredits: (acc.totalCredits || 0) + (row.totalCredits || 0),
            totalDebits: (acc.totalDebits || 0) + (row.totalDebits || 0),
            creditCount: (acc.creditCount || 0) + (row.creditCount || 0),
            avgBalance: row.avgBalance || acc.avgBalance || 0,
            minBalance: Math.min(acc.minBalance || Infinity, row.minBalance || Infinity)
        }), {});

        const cashFlow = (totals.totalCredits || 0) - (totals.totalDebits || 0);
        const avgDeposit = totals.creditCount > 0 ? Math.round(totals.totalCredits / totals.creditCount) : 0;
        const totalDays = data.businessInfo.totalDays || 30;
        const consistency = totalDays > 0 ? Math.round((totals.creditCount / totalDays) * 100) : 0;
        const minBal = totals.minBalance === Infinity ? 0 : totals.minBalance;
        const avgBal = totals.avgBalance || 0;

        const metrics = [
            { label: 'Revenue', value: formatCurrency(totals.totalCredits || 0), class: 'positive' },
            { label: 'Expenses', value: formatCurrency(totals.totalDebits || 0), class: 'negative' },
            { label: 'Cash Flow', value: formatCurrency(cashFlow), class: cashFlow >= 0 ? 'positive' : 'warning' },
            { label: 'Avg Balance', value: formatCurrency(avgBal), class: '' },
            { label: 'Min Balance', value: formatCurrency(minBal), class: minBal < 250 ? 'warning' : '' },
            { label: 'Deposits', value: totals.creditCount || 0, class: '' },
            { label: 'Avg Deposit', value: formatCurrency(avgDeposit), class: '' },
            { label: 'Consistency', value: consistency + '%', class: consistency > 50 ? 'positive' : 'warning' },
            { label: 'Volatility', value: minBal < avgBal * 0.3 ? 'High' : 'Low', class: minBal < avgBal * 0.3 ? 'warning' : 'positive' },
            { label: 'Period', value: totalDays + ' days', class: '' }
        ];

        document.getElementById('metricsRow').innerHTML = metrics.map(m => `
            <div class="metric">
                <div class="metric-label">${m.label}</div>
                <div class="metric-value ${m.class}">${m.value}</div>
            </div>
        `).join('');
    }

    function renderAccountTable(data) {
        const tbody = document.getElementById('accountTableBody');
        const tfoot = document.getElementById('accountTableFoot');
        const numMonths = data.monthlySummary.length;

        tbody.innerHTML = data.monthlySummary.map((row, idx) => {
            const prev = idx > 0 ? data.monthlySummary[idx - 1] : null;
            const creditTrend = prev ? getTrendArrow(row.totalCredits, prev.totalCredits) : '';
            const debitTrend = prev ? getTrendArrow(row.totalDebits, prev.totalDebits) : '';
            const hasCredits = row.credits && row.credits.length > 0;
            const hasDebits = row.debits && row.debits.length > 0;

            const nsfCount = row.nsfCount || 0;
            const odCount = row.overdraftCount || 0;

            // Calculate true revenue from credits marked as isTrueRevenue
            const trueRevenue = row.trueRevenue || (row.credits || [])
                .filter(t => t.isTrueRevenue !== false)
                .reduce((sum, t) => sum + (t.amount || 0), 0);

            // Reconciliation status indicator
            const calcCredits = row.trueCredits || 0;
            const bankCredits = row.totalCredits || 0;
            const creditDiff = Math.abs(calcCredits - bankCredits);
            const creditMatch = creditDiff < 1 ? '' : creditDiff < bankCredits * 0.01 ? '~' : '';

            return `
            <tr>
                <td>${row.month || '--'}</td>
                <td class="text-success ${hasCredits ? 'clickable' : ''}" ${hasCredits ? `onclick="showTransactions(${idx}, 'credits')"` : ''} title="Bank's printed total">${formatCurrency(row.totalCredits || 0)}${creditTrend}</td>
                <td class="text-success ${hasCredits ? 'clickable' : ''}" ${hasCredits ? `onclick="showTransactions(${idx}, 'credits')"` : ''} title="Sum of extracted transactions ${creditMatch}">${formatCurrency(row.trueCredits || 0)}</td>
                <td class="text-success" style="font-weight: 600;" title="True operational revenue (excludes transfers, loans)">${formatCurrency(trueRevenue)}</td>
                <td class="${hasCredits ? 'clickable' : ''}" ${hasCredits ? `onclick="showTransactions(${idx}, 'credits')"` : ''}>${row.creditCount || 0}</td>
                <td class="text-danger ${hasDebits ? 'clickable' : ''}" ${hasDebits ? `onclick="showTransactions(${idx}, 'debits')"` : ''} title="Bank's printed total">${formatCurrency(row.totalDebits || 0)}${debitTrend}</td>
                <td class="text-danger ${hasDebits ? 'clickable' : ''}" ${hasDebits ? `onclick="showTransactions(${idx}, 'debits')"` : ''} title="Sum of extracted transactions">${formatCurrency(row.trueDebits || 0)}</td>
                <td class="${hasDebits ? 'clickable' : ''}" ${hasDebits ? `onclick="showTransactions(${idx}, 'debits')"` : ''}>${row.debitCount || 0}</td>
                <td>${formatCurrency(row.startBalance || 0)}</td>
                <td>${formatCurrency(row.endBalance || 0)}</td>
                <td>${formatCurrency(row.avgBalance || 0)}</td>
                <td class="${(row.minBalance || 0) < 250 ? 'text-warning' : ''}">${formatCurrency(row.minBalance || 0)}</td>
                <td class="${nsfCount > 0 ? 'text-danger' : ''}">${nsfCount}</td>
                <td class="${odCount > 0 ? 'text-danger' : ''}">${odCount}</td>
            </tr>
        `}).join('');

        // Calculate totals
        const totals = data.monthlySummary.reduce((acc, row) => {
            // Calculate true revenue for this month
            const monthTrueRevenue = row.trueRevenue || (row.credits || [])
                .filter(t => t.isTrueRevenue !== false)
                .reduce((sum, t) => sum + (t.amount || 0), 0);

            return {
                totalCredits: acc.totalCredits + (row.totalCredits || 0),
                trueCredits: acc.trueCredits + (row.trueCredits || 0),
                trueRevenue: acc.trueRevenue + monthTrueRevenue,
                creditCount: acc.creditCount + (row.creditCount || 0),
                totalDebits: acc.totalDebits + (row.totalDebits || 0),
                trueDebits: acc.trueDebits + (row.trueDebits || 0),
                debitCount: acc.debitCount + (row.debitCount || 0),
                avgBalanceSum: acc.avgBalanceSum + (row.avgBalance || 0),
                nsfCount: acc.nsfCount + (row.nsfCount || 0),
                overdraftCount: acc.overdraftCount + (row.overdraftCount || 0)
            };
        }, { totalCredits: 0, trueCredits: 0, trueRevenue: 0, creditCount: 0, totalDebits: 0, trueDebits: 0, debitCount: 0, avgBalanceSum: 0, nsfCount: 0, overdraftCount: 0 });

        const first = data.monthlySummary[0] || {};
        const last = data.monthlySummary[data.monthlySummary.length - 1] || {};
        const minBalanceAll = Math.min(...data.monthlySummary.map(r => r.minBalance || 0));
        const avgBalanceAll = numMonths > 0 ? Math.round(totals.avgBalanceSum / numMonths) : 0;

        // Calculate averages
        const averages = {
            totalCredits: numMonths > 0 ? Math.round(totals.totalCredits / numMonths) : 0,
            trueCredits: numMonths > 0 ? Math.round(totals.trueCredits / numMonths) : 0,
            trueRevenue: numMonths > 0 ? Math.round(totals.trueRevenue / numMonths) : 0,
            creditCount: numMonths > 0 ? Math.round(totals.creditCount / numMonths) : 0,
            totalDebits: numMonths > 0 ? Math.round(totals.totalDebits / numMonths) : 0,
            trueDebits: numMonths > 0 ? Math.round(totals.trueDebits / numMonths) : 0,
            debitCount: numMonths > 0 ? Math.round(totals.debitCount / numMonths) : 0
        };

        tfoot.innerHTML = `
            <tr>
                <td>TOTALS</td>
                <td>${formatCurrency(totals.totalCredits)}</td>
                <td>${formatCurrency(totals.trueCredits)}</td>
                <td class="text-success" style="font-weight: 600;">${formatCurrency(totals.trueRevenue)}</td>
                <td>${totals.creditCount}</td>
                <td>${formatCurrency(totals.totalDebits)}</td>
                <td>${formatCurrency(totals.trueDebits)}</td>
                <td>${totals.debitCount}</td>
                <td>${formatCurrency(first.startBalance || 0)}</td>
                <td>${formatCurrency(last.endBalance || 0)}</td>
                <td>${formatCurrency(avgBalanceAll)}</td>
                <td>${formatCurrency(minBalanceAll)}</td>
                <td class="${totals.nsfCount > 0 ? 'text-danger' : ''}">${totals.nsfCount}</td>
                <td class="${totals.overdraftCount > 0 ? 'text-danger' : ''}">${totals.overdraftCount}</td>
            </tr>
            <tr>
                <td>AVERAGES</td>
                <td>${formatCurrency(averages.totalCredits)}</td>
                <td>${formatCurrency(averages.trueCredits)}</td>
                <td class="text-success" style="font-weight: 600;">${formatCurrency(averages.trueRevenue)}</td>
                <td>${averages.creditCount}</td>
                <td>${formatCurrency(averages.totalDebits)}</td>
                <td>${formatCurrency(averages.trueDebits)}</td>
                <td>${averages.debitCount}</td>
                <td>--</td>
                <td>--</td>
                <td>${formatCurrency(avgBalanceAll)}</td>
                <td>${formatCurrency(minBalanceAll)}</td>
                <td>--</td>
                <td>--</td>
            </tr>
        `;
    }

    function renderRiskIndicators(data) {
        const risk = data.riskIndicators || {};

        // Ensure all values have defaults
        const nsfCount = risk.nsfCount || 0;
        const overdraftCount = risk.overdraftCount || 0;
        const negativeDays = risk.negativeDays || 0;
        const lowBalanceDays = risk.lowBalanceDays || 0;
        const mcaFound = risk.mcaFound || 0;
        const achReturns = risk.achReturns || 0;
        const ownerDrawRatio = typeof risk.ownerDrawRatio === 'number' ? risk.ownerDrawRatio : 0;
        const netMargin = typeof risk.netMargin === 'number' ? risk.netMargin : 0;

        // Calculate reconciliation status from monthly data
        let reconciliationStatus = 'MATCH';
        let reconciliationPct = 100;
        if (data.monthlySummary && data.monthlySummary.length > 0) {
            let totalBankCredits = 0;
            let totalCalcCredits = 0;
            for (const month of data.monthlySummary) {
                totalBankCredits += month.totalCredits || 0;
                totalCalcCredits += month.trueCredits || 0;
            }
            if (totalBankCredits > 0) {
                reconciliationPct = Math.round((totalCalcCredits / totalBankCredits) * 100);
                if (reconciliationPct >= 99) reconciliationStatus = 'MATCH';
                else if (reconciliationPct >= 95) reconciliationStatus = 'CLOSE';
                else reconciliationStatus = 'MISMATCH';
            }
        }

        // Calculate True Revenue ratio
        let trueRevRatio = 100;
        if (data.monthlySummary && data.monthlySummary.length > 0) {
            let totalCredits = 0;
            let totalTrueRev = 0;
            for (const month of data.monthlySummary) {
                totalCredits += month.trueCredits || 0;
                const monthTrueRev = month.trueRevenue || (month.credits || [])
                    .filter(t => t.isTrueRevenue !== false)
                    .reduce((sum, t) => sum + (t.amount || 0), 0);
                totalTrueRev += monthTrueRev;
            }
            if (totalCredits > 0) {
                trueRevRatio = Math.round((totalTrueRev / totalCredits) * 100);
            }
        }

        const indicators = [
            { label: 'NSF Items', value: nsfCount, good: nsfCount === 0 },
            { label: 'Overdrafts', value: overdraftCount, good: overdraftCount === 0 },
            { label: 'Neg Days', value: negativeDays, good: negativeDays === 0 },
            { label: 'Low Bal Days', value: lowBalanceDays, good: lowBalanceDays <= 2, warn: lowBalanceDays > 2 && lowBalanceDays <= 5 },
            { label: 'MCA Found', value: mcaFound, good: mcaFound === 0 },
            { label: 'ACH Returns', value: achReturns, good: achReturns === 0 },
            { label: 'Owner Draw', value: ownerDrawRatio + '%', good: ownerDrawRatio < 50, neutral: true },
            { label: 'Net Margin', value: netMargin + '%', good: netMargin > 0, warn: netMargin < 0 },
            { label: 'Reconciled', value: reconciliationPct + '%', good: reconciliationStatus === 'MATCH', warn: reconciliationStatus === 'CLOSE' },
            { label: 'True Rev %', value: trueRevRatio + '%', good: trueRevRatio >= 90, warn: trueRevRatio >= 70 && trueRevRatio < 90, neutral: trueRevRatio < 70 }
        ];

        document.getElementById('riskStrip').innerHTML = indicators.map(ind => {
            let chipClass = 'neutral';
            if (ind.good) chipClass = 'good';
            else if (ind.warn) chipClass = 'warn';
            else if (!ind.good && !ind.neutral) chipClass = 'bad';

            return `
                <div class="risk-chip ${chipClass}">
                    <div class="risk-chip-value">${ind.value}</div>
                    <div class="risk-chip-label">${ind.label}</div>
                </div>
            `;
        }).join('');
    }

    function renderPaymentCapacity(data) {
        const cap = data.paymentCapacity || {};

        // Calculate daily revenue if not provided
        if (!cap.dailyRevenue && data.monthlySummary && data.monthlySummary.length > 0) {
            const totalCredits = data.monthlySummary.reduce((sum, m) => sum + (m.totalCredits || 0), 0);
            const totalDays = data.businessInfo.totalDays || 30;
            cap.dailyRevenue = Math.round(totalCredits / totalDays);
        }
        cap.dailyRevenue = cap.dailyRevenue || 100;

        // Calculate payment capacity if not provided
        cap.maxDaily10Pct = cap.maxDaily10Pct || Math.round(cap.dailyRevenue * 0.10);
        cap.maxDaily15Pct = cap.maxDaily15Pct || Math.round(cap.dailyRevenue * 0.15);
        cap.maxWeekly = cap.maxWeekly || Math.round(cap.dailyRevenue * 0.10 * 7);
        cap.recommendedHoldback = cap.recommendedHoldback || 12;

        document.getElementById('paymentScorecard').innerHTML = `
            <div class="scorecard-item">
                <span class="scorecard-label">Max Daily Payment (10%)</span>
                <span class="scorecard-value pass">$${cap.maxDaily10Pct}</span>
            </div>
            <div class="scorecard-item">
                <span class="scorecard-label">Max Daily Payment (15%)</span>
                <span class="scorecard-value warn">$${cap.maxDaily15Pct}</span>
            </div>
            <div class="scorecard-item">
                <span class="scorecard-label">Max Weekly Payment</span>
                <span class="scorecard-value pass">$${cap.maxWeekly}</span>
            </div>
            <div class="scorecard-item">
                <span class="scorecard-label">Recommended Holdback</span>
                <span class="scorecard-value neutral">${cap.recommendedHoldback}%</span>
            </div>
        `;

        // Store calculated values back
        data.paymentCapacity = cap;

        // Render charts
        renderHoldbackChart(cap);
        renderCapacityGauge(data);
        renderLoadChart(data);
    }

    function renderUnderwritingScorecard(data) {
        document.getElementById('underwritingScorecard').innerHTML = data.underwritingScore.criteria.map(c => `
            <div class="scorecard-item">
                <span class="scorecard-label">${c.name}</span>
                <span class="scorecard-value ${c.passed ? 'pass' : 'fail'}">${c.passed ? 'PASS' : 'FAIL'} - ${c.value}</span>
            </div>
        `).join('');
    }

    function renderCashFlowCharts(data) {
        // Daily Balance Chart
        destroyChart('balanceChart');
        chartInstances['balanceChart'] = new Chart(document.getElementById('balanceChart'), {
            type: 'line',
            data: {
                labels: data.cashFlowData.dailyBalances.map((_, i) => i + 1),
                datasets: [{
                    label: 'Daily Balance',
                    data: data.cashFlowData.dailyBalances,
                    borderColor: '#0284c7',
                    backgroundColor: 'rgba(2, 132, 199, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }, {
                    label: 'Low Balance Threshold ($250)',
                    data: Array(data.cashFlowData.dailyBalances.length).fill(250),
                    borderColor: '#d97706',
                    borderDash: [5, 5],
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } } },
                scales: {
                    x: { title: { display: true, text: 'Day of Month' }, grid: { display: false } },
                    y: { title: { display: true, text: 'Balance ($)' }, beginAtZero: true }
                }
            }
        });

        // Weekly Flow Chart
        destroyChart('flowChart');
        chartInstances['flowChart'] = new Chart(document.getElementById('flowChart'), {
            type: 'bar',
            data: {
                labels: data.cashFlowData.weeklyDeposits.map((_, i) => `Week ${i + 1}`),
                datasets: [{
                    label: 'Deposits',
                    data: data.cashFlowData.weeklyDeposits,
                    backgroundColor: '#059669'
                }, {
                    label: 'Withdrawals',
                    data: data.cashFlowData.weeklyWithdrawals,
                    backgroundColor: '#dc2626'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
            }
        });
    }

    function renderRevenueAnalysis(data) {
        // Day of Week Chart
        destroyChart('dayOfWeekChart');
        chartInstances['dayOfWeekChart'] = new Chart(document.getElementById('dayOfWeekChart'), {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Revenue',
                    data: data.cashFlowData.dayOfWeekRevenue,
                    backgroundColor: ['#059669', '#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#059669', '#10b981']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true } }
            }
        });

        // Deposit Distribution Chart
        destroyChart('depositDistChart');
        chartInstances['depositDistChart'] = new Chart(document.getElementById('depositDistChart'), {
            type: 'doughnut',
            data: {
                labels: data.depositDistribution.ranges,
                datasets: [{
                    data: data.depositDistribution.counts,
                    backgroundColor: ['#e0f2fe', '#7dd3fc', '#38bdf8', '#0284c7', '#0369a1'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } }
            }
        });

        // Revenue Sources Chart
        destroyChart('revenueSourceChart');
        chartInstances['revenueSourceChart'] = new Chart(document.getElementById('revenueSourceChart'), {
            type: 'doughnut',
            data: {
                labels: data.revenueSources.map(s => s.name),
                datasets: [{
                    data: data.revenueSources.map(s => s.amount),
                    backgroundColor: ['#059669', '#10b981', '#34d399', '#6ee7b7'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } }
            }
        });

        // Revenue Breakdown
        const breakdown = document.getElementById('revenueBreakdown');
        breakdown.innerHTML = '<div class="chart-title">Revenue Source Breakdown</div>' +
            data.revenueSources.map(s => `
                <div class="breakdown-item">
                    <span class="breakdown-name">${s.name}</span>
                    <div class="breakdown-data">
                        <span class="breakdown-amt text-success">${formatCurrency(s.amount)}</span>
                        <span class="breakdown-pct">${s.percentage}%</span>
                    </div>
                </div>
            `).join('');
    }

    function renderExpenseAnalysis(data) {
        // Expense Categories Chart
        destroyChart('expenseCatChart');
        chartInstances['expenseCatChart'] = new Chart(document.getElementById('expenseCatChart'), {
            type: 'bar',
            data: {
                labels: data.expenseCategories.map(e => e.name.split('/')[0]),
                datasets: [{
                    data: data.expenseCategories.map(e => e.amount),
                    backgroundColor: ['#dc2626', '#ef4444', '#f87171', '#fca5a5']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true }, y: { grid: { display: false } } }
            }
        });

        // Fixed vs Variable Chart
        destroyChart('fixedVarChart');
        const expenses = data.expenseCategories || [];
        const variableAmt = expenses.find(e => (e.name || '').toLowerCase().includes('owner') || (e.name || '').toLowerCase().includes('draw'))?.amount || 0;
        const fixedAmt = expenses.find(e => (e.name || '').toLowerCase().includes('fee'))?.amount || 0;
        const operatingAmt = expenses.reduce((sum, e) => sum + (e.amount || 0), 0) - variableAmt - fixedAmt;

        chartInstances['fixedVarChart'] = new Chart(document.getElementById('fixedVarChart'), {
            type: 'doughnut',
            data: {
                labels: ['Variable (Owner Draws)', 'Fixed (Fees)', 'Operating'],
                datasets: [{
                    data: [variableAmt, fixedAmt, operatingAmt],
                    backgroundColor: ['#7c3aed', '#a78bfa', '#c4b5fd'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '55%',
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 12, font: { size: 11 } } } }
            }
        });

        // Expense Breakdown
        const breakdown = document.getElementById('expenseBreakdown');
        breakdown.innerHTML = '<div class="chart-title">Expense Category Breakdown</div>' +
            data.expenseCategories.map(e => `
                <div class="breakdown-item">
                    <span class="breakdown-name">${e.name}</span>
                    <div class="breakdown-data">
                        <span class="breakdown-amt text-danger">${formatCurrency(e.amount)}</span>
                        <span class="breakdown-pct">${e.percentage}%</span>
                    </div>
                </div>
            `).join('');
    }

    function renderMCAAnalysis(data) {
        const mca = data.mcaAnalysis;
        const positions = mca.positionsFound || [];

        // Update badge
        document.getElementById('mcaBadge').textContent = `${positions.length} Positions Detected`;
        document.getElementById('mcaTotalPositions').textContent = positions.length;

        // Calculate totals
        let totalDailyBurden = 0;
        let totalWeeklyBurden = 0;
        let totalEstBalance = 0;

        positions.forEach(p => {
            const amount = parseFloat(p.amount) || 0;
            const balance = parseFloat(p.estimatedBalance) || 0;

            if (p.frequency === 'Daily') {
                totalDailyBurden += amount;
                totalWeeklyBurden += amount * 5;
            } else if (p.frequency === 'Weekly') {
                totalDailyBurden += amount / 5;
                totalWeeklyBurden += amount;
            } else if (p.frequency === 'Monthly') {
                totalDailyBurden += amount / 22;
                totalWeeklyBurden += amount / 4;
            }
            totalEstBalance += balance;
        });

        // Update summary cards
        document.getElementById('mcaDailyBurden').textContent = formatCurrency(totalDailyBurden);
        document.getElementById('mcaWeeklyBurden').textContent = formatCurrency(totalWeeklyBurden);
        document.getElementById('mcaEstBalance').textContent = formatCurrency(totalEstBalance);

        // Render table
        const tbody = document.getElementById('mcaTableBody');
        const tfoot = document.getElementById('mcaTableFoot');

        if (positions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 30px;">
                        <div style="font-size: 14px; font-weight: 500;">No MCA positions detected</div>
                        <div style="font-size: 12px; margin-top: 4px;">No recurring ACH debits matching known MCA payment patterns were identified.</div>
                    </td>
                </tr>
            `;
            tfoot.innerHTML = '';
        } else {
            tbody.innerHTML = positions.map(p => {
                const confidenceClass = p.confidence === 'High' ? 'text-success' : (p.confidence === 'Medium' ? 'text-warning' : 'text-danger');
                const confidenceIcon = p.confidence === 'High' ? '' : (p.confidence === 'Medium' ? '' : '');
                return `
                <tr>
                    <td style="font-weight: 500;">${p.lenderName || p.name || 'Unknown Lender'}</td>
                    <td>${p.frequency || 'Daily'}</td>
                    <td class="text-danger" style="font-weight: 600;">${formatCurrency(p.amount || 0)}</td>
                    <td>${formatCurrency(p.estimatedBalance || 0)}</td>
                    <td>${p.estimatedPayoffDate || 'Unknown'}</td>
                    <td class="${confidenceClass}">${confidenceIcon} ${p.confidence || 'Low'}</td>
                </tr>
            `}).join('');

            tfoot.innerHTML = `
                <tr>
                    <td>TOTAL (${positions.length} positions)</td>
                    <td>-</td>
                    <td class="text-danger">${formatCurrency(totalDailyBurden)}/day</td>
                    <td>${formatCurrency(totalEstBalance)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `;
        }

        // Status box
        const statusBox = document.getElementById('mcaStatusBox');
        const statusTitle = document.getElementById('mcaStatusTitle');
        const statusText = document.getElementById('mcaStatusText');

        if (positions.length === 0) {
            statusBox.style.background = 'var(--success-bg)';
            statusBox.style.borderColor = '#a7f3d0';
            statusTitle.style.color = 'var(--success)';
            statusTitle.textContent = 'No Stacking Detected';
            statusText.textContent = 'This business appears clear of existing MCA obligations. Low risk for stacking issues.';
        } else if (positions.length <= 2 && totalDailyBurden < 500) {
            statusBox.style.background = 'var(--warning-bg)';
            statusBox.style.borderColor = '#fde68a';
            statusTitle.style.color = 'var(--warning)';
            statusTitle.textContent = `${positions.length} Position(s) - Moderate Risk`;
            statusText.textContent = `Daily payment burden of ${formatCurrency(totalDailyBurden)} detected. Verify payoff dates and consider remaining runway before additional funding.`;
        } else {
            statusBox.style.background = 'var(--danger-bg)';
            statusBox.style.borderColor = '#fca5a5';
            statusTitle.style.color = 'var(--danger)';
            statusTitle.textContent = `${positions.length} Position(s) - High Risk`;
            statusText.textContent = `Heavy stacking detected with ${formatCurrency(totalDailyBurden)}/day burden. Est. total balance: ${formatCurrency(totalEstBalance)}. Exercise extreme caution.`;
        }

        // Render MCA charts
        renderMCACharts(positions);

        // Keywords - show which lenders were found vs scanned
        const lendersScanned = mca.lendersScanned || ['Libertas', 'Yellowstone', 'Credibly', 'OnDeck', 'Kapitus', 'BlueVine', 'Fundbox', 'PayPal WC', 'Square Capital', 'Amazon Lending', 'Kabbage', 'CAN Capital', 'Rapid Finance', 'Forward Financing', 'Clearco'];
        const foundLenders = positions.map(p => (p.lenderName || p.name || '').toLowerCase());

        document.getElementById('mcaKeywords').innerHTML = lendersScanned.map(lender => {
            const isFound = foundLenders.some(f => f.includes(lender.toLowerCase()) || lender.toLowerCase().includes(f));
            return `
                <div style="padding: 6px 10px; background: ${isFound ? 'var(--danger-bg)' : 'var(--gray-50)'}; border-radius: var(--radius); font-size: 11px; color: ${isFound ? 'var(--danger)' : 'var(--gray-600)'}; border: 1px solid ${isFound ? 'var(--danger)' : 'var(--gray-200)'};">
                    <span style="margin-right: 4px;">${isFound ? '' : ''}</span>${lender}${isFound ? ' - FOUND' : ''}
                </div>
            `;
        }).join('');
    }

    function renderMCACharts(positions) {
        // Timeline chart showing payment schedule
        destroyChart('mcaTimelineChart');
        destroyChart('mcaBurdenChart');

        if (positions.length === 0) {
            document.getElementById('mcaTimelineChart').parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--gray-400);">No positions to display</div>';
            document.getElementById('mcaBurdenChart').parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--gray-400);">No positions to display</div>';
            return;
        }

        // Ensure canvas elements exist
        const timelineCanvas = document.getElementById('mcaTimelineChart');
        const burdenCanvas = document.getElementById('mcaBurdenChart');

        if (!timelineCanvas || !burdenCanvas) return;

        // Create burden by lender pie chart
        const colors = ['#dc2626', '#ea580c', '#d97706', '#ca8a04', '#65a30d', '#16a34a', '#0d9488', '#0891b2'];

        chartInstances['mcaBurdenChart'] = new Chart(burdenCanvas, {
            type: 'doughnut',
            data: {
                labels: positions.map(p => p.lenderName || p.name || 'Unknown'),
                datasets: [{
                    data: positions.map(p => parseFloat(p.amount) || 0),
                    backgroundColor: colors.slice(0, positions.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { font: { size: 11 } }
                    }
                }
            }
        });

        // Create payment timeline bar chart
        const monthlyData = positions.map(p => {
            const amount = parseFloat(p.amount) || 0;
            if (p.frequency === 'Daily') return amount * 22;
            if (p.frequency === 'Weekly') return amount * 4;
            return amount;
        });

        chartInstances['mcaTimelineChart'] = new Chart(timelineCanvas, {
            type: 'bar',
            data: {
                labels: positions.map(p => p.lenderName || p.name || 'Unknown'),
                datasets: [{
                    label: 'Est. Monthly Payment',
                    data: monthlyData,
                    backgroundColor: '#dc2626',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: value => '$' + value.toLocaleString()
                        }
                    }
                }
            }
        });
    }

    function renderBenchmarks(data) {
        const bench = data.benchmarks;

        // Radar Chart
        destroyChart('benchmarkChart');
        chartInstances['benchmarkChart'] = new Chart(document.getElementById('benchmarkChart'), {
            type: 'radar',
            data: {
                labels: ['Revenue', 'Deposit Freq', 'Avg Balance', 'Cash Flow', 'Risk Score', 'Consistency'],
                datasets: [{
                    label: 'This Business',
                    data: bench.businessScores,
                    borderColor: '#c9a227',
                    backgroundColor: 'rgba(201, 162, 39, 0.2)',
                    pointBackgroundColor: '#c9a227'
                }, {
                    label: 'Industry Avg',
                    data: bench.industryAvg,
                    borderColor: '#6b7280',
                    backgroundColor: 'rgba(107, 114, 128, 0.1)',
                    pointBackgroundColor: '#6b7280'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 16 } } },
                scales: { r: { beginAtZero: true, max: 100 } }
            }
        });

        // Percentile Chart
        destroyChart('percentileChart');
        chartInstances['percentileChart'] = new Chart(document.getElementById('percentileChart'), {
            type: 'bar',
            data: {
                labels: ['Revenue', 'Deposits', 'Balance', 'Risk', 'Score'],
                datasets: [{
                    label: 'Percentile Rank',
                    data: bench.percentiles,
                    backgroundColor: ['#0284c7', '#059669', '#d97706', '#7c3aed', '#c9a227']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { grid: { display: false } }, y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percentile' } } }
            }
        });
    }

    function renderRecommendedPosition(data) {
        const pos = data.recommendedPosition || {};

        // Calculate recommended position if not provided
        if (!pos.amount && data.monthlySummary && data.monthlySummary.length > 0) {
            const avgMonthlyRevenue = data.monthlySummary.reduce((sum, m) => sum + (m.totalCredits || 0), 0) / data.monthlySummary.length;
            pos.amount = Math.round(avgMonthlyRevenue);
            pos.rangeMin = Math.round(avgMonthlyRevenue * 0.5);
            pos.rangeMax = Math.round(avgMonthlyRevenue * 1.5);
        }

        pos.amount = pos.amount || 10000;
        pos.rangeMin = pos.rangeMin || Math.round(pos.amount * 0.5);
        pos.rangeMax = pos.rangeMax || Math.round(pos.amount * 1.5);
        pos.factorRate = pos.factorRate || 1.35;
        pos.paybackAmount = pos.paybackAmount || Math.round(pos.amount * pos.factorRate);
        pos.dailyPayment = pos.dailyPayment || Math.round(pos.paybackAmount / 150);
        pos.termDays = pos.termDays || 150;

        const tier = data.underwritingScore.tier || 2;

        document.getElementById('tierBadge').textContent = `Tier ${tier}`;
        document.getElementById('recommendedAmount').textContent = formatCurrency(pos.amount);
        document.getElementById('positionRange').textContent =
            `Approval Range: ${formatCurrency(pos.rangeMin)} - ${formatCurrency(pos.rangeMax)} | Based on 1x monthly revenue`;

        document.getElementById('positionMetrics').innerHTML = `
            <div class="position-metric">
                <div class="position-metric-value">${pos.factorRate}</div>
                <div class="position-metric-label">Factor Rate</div>
            </div>
            <div class="position-metric">
                <div class="position-metric-value">${formatCurrency(pos.paybackAmount)}</div>
                <div class="position-metric-label">Payback Amount</div>
            </div>
            <div class="position-metric">
                <div class="position-metric-value">$${pos.dailyPayment}/day</div>
                <div class="position-metric-label">Daily Payment</div>
            </div>
            <div class="position-metric">
                <div class="position-metric-value">${pos.termDays} days</div>
                <div class="position-metric-label">Term Length</div>
            </div>
        `;

        // Store back for other functions
        data.recommendedPosition = pos;
    }

    function renderHoldbackChart(cap) {
        const holdbackPcts = [10, 12, 15, 18, 20];
        const dailyPayments = holdbackPcts.map(pct => Math.round(cap.dailyRevenue * pct / 100));

        destroyChart('holdbackChart');
        chartInstances['holdbackChart'] = new Chart(document.getElementById('holdbackChart'), {
            type: 'bar',
            data: {
                labels: holdbackPcts.map(p => p + '%'),
                datasets: [{
                    label: 'Daily Payment',
                    data: dailyPayments,
                    backgroundColor: '#c9a227'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { title: { display: true, text: 'Holdback %' }, grid: { display: false } },
                    y: { title: { display: true, text: 'Daily Payment ($)' }, beginAtZero: true }
                }
            }
        });
    }

    function renderCapacityGauge(data) {
        const proposed = data.recommendedPosition.dailyPayment;
        const available = data.paymentCapacity.dailyRevenue - proposed;

        destroyChart('capacityGauge');
        chartInstances['capacityGauge'] = new Chart(document.getElementById('capacityGauge'), {
            type: 'doughnut',
            data: {
                labels: ['Used Capacity', 'Available'],
                datasets: [{
                    data: [proposed, available],
                    backgroundColor: ['#c9a227', '#e5e7eb'],
                    borderWidth: 0,
                    circumference: 180,
                    rotation: 270
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });
    }

    function renderLoadChart(data) {
        const daily = data.paymentCapacity.dailyRevenue;
        const proposed = data.recommendedPosition.dailyPayment;

        destroyChart('loadChart');
        chartInstances['loadChart'] = new Chart(document.getElementById('loadChart'), {
            type: 'bar',
            data: {
                labels: ['Revenue', 'Current Load', 'Proposed', 'Remaining'],
                datasets: [{
                    data: [daily, 0, proposed, daily - proposed],
                    backgroundColor: ['#059669', '#6b7280', '#c9a227', '#e5e7eb']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { title: { display: true, text: 'Daily Amount ($)' }, beginAtZero: true }
                }
            }
        });
    }

    // Utility Functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
    }

    function destroyChart(id) {
        if (chartInstances[id]) {
            chartInstances[id].destroy();
            delete chartInstances[id];
        }
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    // ============================================
    // SNOOD GAME ENGINE (Enhanced)
    // ============================================
    let snoodGame = null;
    let snoodModalGame = null;

    function createSnoodGame(canvasId, scoreId, levelId = null, isModal = false) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return null;
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const RADIUS = isModal ? 18 : 14;
        const COLORS = ['#c9a227', '#ef4444', '#22c55e', '#3b82f6', '#a855f7', '#ec4899', '#06b6d4', '#f97316'];

        let bubbles = [];
        let shooter = { x: W / 2, y: H - 30, angle: -Math.PI / 2, color: COLORS[0], nextColor: COLORS[1] };
        let projectile = null;
        let score = 0;
        let level = 1;
        let combo = 0;
        let gameLoop = null;
        let particles = [];

        function initBubbles() {
            bubbles = [];
            const rows = isModal ? 6 + Math.floor(level / 2) : 5;
            const colCount = isModal ? Math.floor((W - RADIUS) / (RADIUS * 2)) : 10;
            for (let row = 0; row < rows; row++) {
                const offset = (row % 2) * RADIUS;
                const cols = row % 2 === 0 ? colCount : colCount - 1;
                for (let col = 0; col < cols; col++) {
                    bubbles.push({
                        x: offset + col * RADIUS * 2 + RADIUS,
                        y: row * RADIUS * 1.7 + RADIUS + 10,
                        color: COLORS[Math.floor(Math.random() * (Math.min(4 + level, COLORS.length)))],
                        alive: true
                    });
                }
            }
        }

        function createParticle(x, y, color) {
            for (let i = 0; i < 8; i++) {
                particles.push({
                    x, y, color,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 30
                });
            }
        }

        function drawBubble(x, y, color, scale = 1) {
            const r = (RADIUS - 1) * scale;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            const grad = ctx.createRadialGradient(x - r * 0.3, y - r * 0.3, 0, x, y, r);
            grad.addColorStop(0, '#ffffff66');
            grad.addColorStop(0.3, color);
            grad.addColorStop(1, color + '88');
            ctx.fillStyle = grad;
            ctx.fill();
            ctx.strokeStyle = '#ffffff33';
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function draw() {
            ctx.clearRect(0, 0, W, H);

            // Draw particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life / 30;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Draw bubbles
            bubbles.forEach(b => {
                if (b.alive) drawBubble(b.x, b.y, b.color);
            });

            // Draw aim line with trajectory preview
            ctx.beginPath();
            ctx.moveTo(shooter.x, shooter.y);
            let previewX = shooter.x, previewY = shooter.y;
            let previewVx = Math.cos(shooter.angle) * 10;
            let previewVy = Math.sin(shooter.angle) * 10;
            for (let i = 0; i < 15; i++) {
                previewX += previewVx;
                previewY += previewVy;
                if (previewX < RADIUS || previewX > W - RADIUS) previewVx *= -1;
                if (previewY < RADIUS) break;
                if (i % 2 === 0) {
                    ctx.lineTo(previewX, previewY);
                } else {
                    ctx.moveTo(previewX, previewY);
                }
            }
            ctx.strokeStyle = '#ffffff44';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw shooter base
            ctx.beginPath();
            ctx.arc(shooter.x, shooter.y + 15, 30, Math.PI, 0);
            ctx.fillStyle = '#333';
            ctx.fill();

            // Draw next bubble preview
            drawBubble(shooter.x + 35, shooter.y + 10, shooter.nextColor, 0.6);
            ctx.fillStyle = '#666';
            ctx.font = '10px sans-serif';
            ctx.fillText('NEXT', shooter.x + 25, shooter.y + 25);

            // Draw shooter bubble
            drawBubble(shooter.x, shooter.y, shooter.color);

            // Draw projectile
            if (projectile) {
                drawBubble(projectile.x, projectile.y, projectile.color);
            }

            // Draw combo text
            if (combo > 1) {
                ctx.fillStyle = '#c9a227';
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`${combo}x COMBO!`, W / 2, H / 2);
                ctx.textAlign = 'left';
            }
        }

        function update() {
            // Update particles
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.3;
                p.life--;
                return p.life > 0;
            });

            if (projectile) {
                projectile.x += projectile.vx;
                projectile.y += projectile.vy;

                if (projectile.x < RADIUS || projectile.x > W - RADIUS) {
                    projectile.vx *= -1;
                }

                if (projectile.y < RADIUS) {
                    snapToGrid(projectile);
                    projectile = null;
                    advanceShooter();
                    return;
                }

                for (const b of bubbles) {
                    if (!b.alive) continue;
                    const dx = projectile.x - b.x;
                    const dy = projectile.y - b.y;
                    if (Math.sqrt(dx * dx + dy * dy) < RADIUS * 1.8) {
                        snapToGrid(projectile);
                        checkMatches(projectile.color);
                        projectile = null;
                        advanceShooter();
                        return;
                    }
                }
            }

            // Check win condition
            if (bubbles.filter(b => b.alive).length === 0) {
                level++;
                if (levelId) document.getElementById(levelId).textContent = 'Level: ' + level;
                initBubbles();
            }
        }

        function advanceShooter() {
            shooter.color = shooter.nextColor;
            shooter.nextColor = COLORS[Math.floor(Math.random() * Math.min(4 + level, COLORS.length))];
            combo = 0;
        }

        function snapToGrid(p) {
            const row = Math.max(0, Math.round((p.y - RADIUS - 10) / (RADIUS * 1.7)));
            const offset = (row % 2) * RADIUS;
            const col = Math.round((p.x - offset - RADIUS) / (RADIUS * 2));
            bubbles.push({
                x: Math.max(RADIUS, Math.min(W - RADIUS, offset + col * RADIUS * 2 + RADIUS)),
                y: row * RADIUS * 1.7 + RADIUS + 10,
                color: p.color,
                alive: true
            });
        }

        function checkMatches(color) {
            const lastBubble = bubbles[bubbles.length - 1];

            function findConnected(bubble, found = new Set()) {
                if (found.has(bubble)) return found;
                found.add(bubble);
                bubbles.forEach(b => {
                    if (!b.alive || b.color !== color || found.has(b)) return;
                    const dx = bubble.x - b.x;
                    const dy = bubble.y - b.y;
                    if (Math.sqrt(dx * dx + dy * dy) < RADIUS * 2.5) {
                        findConnected(b, found);
                    }
                });
                return found;
            }

            const connected = findConnected(lastBubble);
            if (connected.size >= 3) {
                combo++;
                connected.forEach(b => {
                    createParticle(b.x, b.y, b.color);
                    b.alive = false;
                    score += 10 * combo;
                });
                updateScore();
                removeFloating();
            }
        }

        function removeFloating() {
            const attached = new Set();

            function markAttached(bubble) {
                if (attached.has(bubble)) return;
                attached.add(bubble);
                bubbles.forEach(b => {
                    if (!b.alive || attached.has(b)) return;
                    const dx = bubble.x - b.x;
                    const dy = bubble.y - b.y;
                    if (Math.sqrt(dx * dx + dy * dy) < RADIUS * 2.5) {
                        markAttached(b);
                    }
                });
            }

            bubbles.forEach(b => {
                if (b.alive && b.y < RADIUS * 2 + 15) {
                    markAttached(b);
                }
            });

            let floatCount = 0;
            bubbles.forEach(b => {
                if (b.alive && !attached.has(b)) {
                    createParticle(b.x, b.y, b.color);
                    b.alive = false;
                    floatCount++;
                    score += 25 * combo;
                }
            });
            if (floatCount > 0) updateScore();
        }

        function updateScore() {
            const scoreEl = document.getElementById(scoreId);
            if (scoreEl) scoreEl.textContent = '$' + score.toLocaleString();
        }

        function shoot() {
            if (projectile) return;
            projectile = {
                x: shooter.x,
                y: shooter.y,
                vx: Math.cos(shooter.angle) * (isModal ? 12 : 8),
                vy: Math.sin(shooter.angle) * (isModal ? 12 : 8),
                color: shooter.color
            };
        }

        function handleMouse(e) {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            shooter.angle = Math.atan2(my - shooter.y, mx - shooter.x);
            if (shooter.angle > -0.15) shooter.angle = -0.15;
            if (shooter.angle < -Math.PI + 0.15) shooter.angle = -Math.PI + 0.15;
        }

        canvas.addEventListener('mousemove', handleMouse);
        canvas.addEventListener('click', shoot);

        initBubbles();

        gameLoop = setInterval(() => {
            update();
            draw();
        }, 1000 / 60);

        return {
            stop: () => {
                clearInterval(gameLoop);
                canvas.removeEventListener('mousemove', handleMouse);
                canvas.removeEventListener('click', shoot);
            },
            restart: () => {
                score = 0;
                level = 1;
                combo = 0;
                particles = [];
                projectile = null;
                shooter.color = COLORS[0];
                shooter.nextColor = COLORS[1];
                updateScore();
                if (levelId) document.getElementById(levelId).textContent = 'Level: 1';
                initBubbles();
            }
        };
    }

    // Mini game for loading screen
    function initSnoodGame() {
        if (snoodGame) return;
        snoodGame = createSnoodGame('snoodCanvas', 'snoodScore', null, false);
    }

    function stopSnoodGame() {
        if (snoodGame) {
            snoodGame.stop();
            snoodGame = null;
        }
    }

    // Modal game functions
    function toggleSnoodModal() {
        const overlay = document.getElementById('snoodModalOverlay');
        const modal = document.getElementById('snoodModal');
        const isOpen = modal.classList.contains('active');

        if (isOpen) {
            closeSnoodModal();
        } else {
            overlay.classList.add('active');
            modal.classList.add('active');
            if (!snoodModalGame) {
                snoodModalGame = createSnoodGame('snoodModalCanvas', 'snoodModalScore', 'snoodModalLevel', true);
            }
        }
    }

    function closeSnoodModal() {
        document.getElementById('snoodModalOverlay').classList.remove('active');
        document.getElementById('snoodModal').classList.remove('active');
        if (snoodModalGame) {
            snoodModalGame.stop();
            snoodModalGame = null;
        }
    }

    function restartSnoodGame() {
        if (snoodModalGame) {
            snoodModalGame.restart();
        }
    }

    function updateLoadingStatus(text) {
        document.getElementById('loadingStatus').textContent = text;
    }

    function showError(message) {
        const errorEl = document.getElementById('errorMessage');
        document.getElementById('errorText').textContent = message;
        errorEl.classList.add('visible');
    }

    function hideError() {
        document.getElementById('errorMessage').classList.remove('visible');
    }

    // Initialize Chart.js defaults
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';

    // Update chart colors for dark mode
    function updateChartColors() {
        const isDark = document.body.classList.contains('dark-theme');
        Chart.defaults.color = isDark ? '#9ca3af' : '#6b7280';
        Chart.defaults.borderColor = isDark ? '#374151' : '#e5e7eb';

        // Update all existing charts
        Object.values(chartInstances).forEach(chart => {
            if (chart.options.scales) {
                if (chart.options.scales.x) {
                    chart.options.scales.x.ticks = chart.options.scales.x.ticks || {};
                    chart.options.scales.x.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                    chart.options.scales.x.grid = chart.options.scales.x.grid || {};
                    chart.options.scales.x.grid.color = isDark ? '#374151' : '#e5e7eb';
                }
                if (chart.options.scales.y) {
                    chart.options.scales.y.ticks = chart.options.scales.y.ticks || {};
                    chart.options.scales.y.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                    chart.options.scales.y.grid = chart.options.scales.y.grid || {};
                    chart.options.scales.y.grid.color = isDark ? '#374151' : '#e5e7eb';
                }
                if (chart.options.scales.r) {
                    chart.options.scales.r.ticks = chart.options.scales.r.ticks || {};
                    chart.options.scales.r.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                    chart.options.scales.r.grid = chart.options.scales.r.grid || {};
                    chart.options.scales.r.grid.color = isDark ? '#374151' : '#e5e7eb';
                    chart.options.scales.r.pointLabels = chart.options.scales.r.pointLabels || {};
                    chart.options.scales.r.pointLabels.color = isDark ? '#9ca3af' : '#6b7280';
                }
            }
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                chart.options.plugins.legend.labels.color = isDark ? '#9ca3af' : '#6b7280';
            }
            chart.update();
        });
    }

    // ============================================
    // NEW FEATURES
    // ============================================

    // Retry Logic for API
    const MAX_RETRIES = 3;
    let retryCount = 0;

    async function callGeminiAPIWithRetry(apiKey, files) {
        retryCount = 0;
        while (retryCount < MAX_RETRIES) {
            try {
                return await callGeminiAPI(apiKey, files);
            } catch (error) {
                retryCount++;
                if (retryCount < MAX_RETRIES) {
                    showUploadStatus(`Retry ${retryCount}/${MAX_RETRIES}: ${error.message}`);
                    await new Promise(r => setTimeout(r, 2000 * retryCount));
                } else {
                    throw error;
                }
            }
        }
    }

    // Export to PDF
    function exportToPDF() {
        // Use browser print with PDF option
        const originalTitle = document.title;
        const businessName = document.getElementById('businessName').textContent;
        document.title = `MCA Report - ${businessName} - ${new Date().toLocaleDateString()}`;
        window.print();
        document.title = originalTitle;
    }

    // Print Report
    function printReport() {
        window.print();
    }

    // New Analysis
    function newAnalysis() {
        // Reset state
        uploadedFiles = [];
        analysisData = null;

        // Clear notes
        document.getElementById('underwriterNotes').value = '';

        // Hide report, show upload
        document.getElementById('reportContainer').classList.remove('visible');
        document.getElementById('uploadSection').style.display = 'block';

        // Clear file list
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('uploadFooter').style.display = 'none';
        hideUploadStatus();

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Save Report to localStorage
    function saveReport() {
        if (!analysisData) {
            alert('No report to save. Please analyze a bank statement first.');
            return;
        }

        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
        const businessName = analysisData.businessInfo?.name || 'Unknown Business';
        const notes = document.getElementById('underwriterNotes').value;

        const report = {
            id: Date.now(),
            name: businessName,
            date: new Date().toISOString(),
            data: analysisData,
            notes: notes
        };

        reports.unshift(report);
        // Keep only last 20 reports
        if (reports.length > 20) reports.pop();

        localStorage.setItem('savedReports', JSON.stringify(reports));

        // Show confirmation
        alert(`Report saved for "${businessName}"`);
    }

    // Toggle Saved Reports Menu
    function toggleSavedReports() {
        const menu = document.getElementById('savedReportsMenu');
        menu.classList.toggle('visible');

        if (menu.classList.contains('visible')) {
            renderSavedReports();
        }
    }

    // Render Saved Reports List
    function renderSavedReports() {
        const menu = document.getElementById('savedReportsMenu');
        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        if (reports.length === 0) {
            menu.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray-500);">No saved reports</div>';
            return;
        }

        menu.innerHTML = reports.map(r => `
            <div class="saved-report-item" onclick="loadReport(${r.id})">
                <div>
                    <div class="saved-report-name">${r.name}</div>
                    <div class="saved-report-date">${new Date(r.date).toLocaleDateString()}</div>
                </div>
                <div class="saved-report-delete" onclick="event.stopPropagation(); deleteReport(${r.id})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </div>
            </div>
        `).join('');
    }

    // Load Report from localStorage
    function loadReport(id) {
        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
        const report = reports.find(r => r.id === id);

        if (report) {
            analysisData = report.data;
            renderReport(analysisData);
            document.getElementById('underwriterNotes').value = report.notes || '';

            // Hide upload, show report
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('reportContainer').classList.add('visible');

            // Close menu
            document.getElementById('savedReportsMenu').classList.remove('visible');
        }
    }

    // Delete Report from localStorage
    function deleteReport(id) {
        let reports = JSON.parse(localStorage.getItem('savedReports') || '[]');
        reports = reports.filter(r => r.id !== id);
        localStorage.setItem('savedReports', JSON.stringify(reports));
        renderSavedReports();
    }

    // Close saved reports menu when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.querySelector('.saved-reports-dropdown');
        const menu = document.getElementById('savedReportsMenu');
        if (dropdown && !dropdown.contains(e.target)) {
            menu.classList.remove('visible');
        }
    });

    // Collapsible Sections
    function toggleSection(header) {
        header.classList.toggle('collapsed');
        const content = header.nextElementSibling;
        content.classList.toggle('collapsed');
    }

    // Make Field Editable
    function makeEditable(element, field) {
        if (element.querySelector('input')) return; // Already editing

        const currentValue = element.textContent.replace(/[$,]/g, '');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentValue;

        input.onblur = () => {
            const newValue = parseFloat(input.value.replace(/[$,]/g, '')) || 0;
            element.textContent = formatCurrency(newValue);

            // Update analysisData
            if (field === 'amount' && analysisData) {
                analysisData.recommendedPosition.amount = newValue;
            }
        };

        input.onkeydown = (e) => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') {
                element.textContent = formatCurrency(parseFloat(currentValue) || 0);
            }
        };

        element.textContent = '';
        element.appendChild(input);
        input.focus();
        input.select();
    }

    // Math Verification with Agentic Model
    async function runMathVerification() {
        if (!analysisData) {
            alert('No report data to verify.');
            return;
        }

        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            alert('Please configure your API key in Settings.');
            return;
        }

        const btn = document.getElementById('verifyBtn');
        const badge = document.getElementById('verificationBadge');
        const status = document.getElementById('verificationStatus');
        const results = document.getElementById('verificationResults');

        // Also get bar elements
        const barBtn = document.getElementById('verificationBarBtn');
        const barStatus = document.getElementById('verificationBarStatus');

        // Update UI to show loading
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> Verifying...`;
        }
        if (barBtn) {
            barBtn.disabled = true;
            barBtn.textContent = 'Verifying...';
        }
        if (badge) {
            badge.className = 'verification-badge checking';
            badge.textContent = 'Checking...';
        }
        if (barStatus) {
            barStatus.className = 'verification-bar-status checking';
            barStatus.textContent = 'Checking...';
        }
        status.innerHTML = '<div class="verification-placeholder">AI is verifying calculations...</div>';
        results.style.display = 'none';

        try {
            // Build verification prompt with the data
            const verifyPrompt = `Verify mathematical accuracy of this bank statement analysis. Return JSON only.

DATA:
${JSON.stringify(analysisData, null, 2)}

CHECKS FOR EACH MONTH:

1. BALANCE EQUATION: endBalance = startBalance + totalCredits - totalDebits
   PASS if within $10, WARNING if within $100, FAIL if more

2. TRANSACTION ARRAY SUMS:
   - trueCredits should equal sum of credits array amounts
   - trueDebits should equal sum of debits array amounts
   PASS if exact match, WARNING if within 1%, FAIL otherwise

3. TRANSACTION COUNTS:
   - creditCount should match credits array length
   - debitCount should match debits array length
   PASS if match, FAIL if different

4. BANK vs CALCULATED TOTALS:
   - Compare totalCredits (bank's number) vs trueCredits (calculated)
   - Compare totalDebits (bank's number) vs trueDebits (calculated)
   PASS if within 1%, WARNING if within 5%, FAIL otherwise

5. BALANCE REASONABILITY:
   - minBalance <= startBalance and endBalance
   - avgBalance between minBalance and max(startBalance, endBalance)
   PASS if reasonable, FAIL if impossible

6. UNDERWRITING SCORE: Verify criteria pass/fail matches values

OUTPUT (JSON ONLY):
{
    "overallStatus": "pass|warning|fail",
    "checks": [
        {"name": "Balance Equation", "status": "pass", "note": "$X + $Y - $Z = $W vs endBalance $W"},
        {"name": "Credits Array Sum", "status": "pass", "note": "Sum: $X, trueCredits: $X"},
        {"name": "Debits Array Sum", "status": "pass", "note": "Sum: $X, trueDebits: $X"},
        {"name": "Transaction Counts", "status": "pass", "note": "Credits: X (expected X), Debits: Y (expected Y)"},
        {"name": "Bank vs Calculated", "status": "pass", "note": "totalCredits $X vs trueCredits $Y (diff: $Z)"},
        {"name": "Balance Reasonability", "status": "pass", "note": "avgBalance $X, minBalance $Y, maxBalance $Z"},
        {"name": "Underwriting Score", "status": "pass", "note": "X of 8 criteria passed, score of Y% is correct"}
    ],
    "summary": "All mathematical checks passed. Data appears accurate.",
    "discrepancies": []
}

RULES:
- "status" must be exactly "pass", "fail", or "warning"
- "overallStatus" = "fail" if ANY check fails, "warning" if any warnings but no fails, "pass" if all pass
- Show actual numbers in the "note" field so user can verify
- List specific discrepancies found in the discrepancies array`;

            // Use selected model for verification (fall back to gemini-2.5-flash for text-only)
            const selectedModel = getSelectedModel();
            const verifyModel = selectedModel.startsWith('agent:') ? 'gemini-2.5-flash' : selectedModel;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${verifyModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: verifyPrompt }] }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 4096
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error?.message || `Verification API request failed with status ${response.status}`;
                console.error('Verification API Error:', {
                    status: response.status,
                    statusText: response.statusText,
                    error: errorData,
                    model: verifyModel
                });
                throw new Error(`Verification API Error (${response.status}): ${errorMsg}`);
            }

            const data = await response.json();

            // Check for blocked content
            if (data.promptFeedback?.blockReason) {
                throw new Error(`Verification blocked: ${data.promptFeedback.blockReason}`);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) {
                console.error('Empty verification response:', data);
                const finishReason = data.candidates?.[0]?.finishReason;
                if (finishReason && finishReason !== 'STOP') {
                    throw new Error(`Verification returned no text. Finish reason: ${finishReason}`);
                }
                throw new Error('No response from verification API - model returned empty content');
            }

            // Parse JSON
            let jsonStr = text;
            if (text.includes('```json')) {
                jsonStr = text.split('```json')[1].split('```')[0];
            } else if (text.includes('```')) {
                jsonStr = text.split('```')[1].split('```')[0];
            }

            const verificationData = JSON.parse(jsonStr.trim());

            // Update badge
            const badgeClass = verificationData.overallStatus === 'pass' ? 'verified' : verificationData.overallStatus === 'fail' ? 'error' : 'checking';
            const badgeText = verificationData.overallStatus === 'pass' ? 'Verified ' : verificationData.overallStatus === 'fail' ? 'Issues Found' : 'Warnings';

            if (badge) {
                badge.className = `verification-badge ${badgeClass}`;
                badge.textContent = badgeText;
            }
            if (barStatus) {
                barStatus.className = `verification-bar-status ${badgeClass}`;
                barStatus.textContent = badgeText;
            }

            // Render results
            status.style.display = 'none';
            results.style.display = 'block';
            results.innerHTML = `
                ${verificationData.checks.map(check => `
                    <div class="verification-item">
                        <span class="verification-item-label">${check.name}</span>
                        <span class="verification-item-status ${check.status}">
                            ${check.status === 'pass' ? ' Pass' : check.status === 'fail' ? ' Fail' : ' Warning'}
                        </span>
                    </div>
                `).join('')}
                <div class="verification-summary">
                    <strong>Summary:</strong> ${verificationData.summary}
                    ${verificationData.discrepancies && verificationData.discrepancies.length > 0 ? `
                        <br><br><strong>Discrepancies:</strong>
                        <ul style="margin: 8px 0 0 16px;">
                            ${verificationData.discrepancies.map(d => `<li>${d}</li>`).join('')}
                        </ul>
                    ` : ''}
                </div>
            `;

        } catch (error) {
            console.error('Verification error:', error);
            if (badge) {
                badge.className = 'verification-badge error';
                badge.textContent = 'Error';
            }
            if (barStatus) {
                barStatus.className = 'verification-bar-status error';
                barStatus.textContent = 'Error';
            }
            status.innerHTML = `<div class="verification-placeholder" style="color: var(--danger);">Verification failed: ${error.message}</div>`;
        }

        // Reset buttons
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Verify with AI`;
        }
        if (barBtn) {
            barBtn.disabled = false;
            barBtn.textContent = 'Verify Calculations';
        }
    }

    // Red Flag Detection
    function detectRedFlags(data) {
        const flags = [];
        const risk = data.riskIndicators || {};

        if (risk.nsfCount > 3) flags.push(`High NSF count: ${risk.nsfCount} items found`);
        if (risk.overdraftCount > 5) flags.push(`Excessive overdrafts: ${risk.overdraftCount} occurrences`);
        if (risk.negativeDays > 10) flags.push(`Extended negative balance: ${risk.negativeDays} days`);
        if (risk.mcaFound > 3) flags.push(`Multiple MCA positions detected: ${risk.mcaFound} lenders`);
        if (risk.achReturns > 2) flags.push(`ACH return issues: ${risk.achReturns} returns`);
        if (risk.netMargin < -20) flags.push(`Severe negative cash flow: ${risk.netMargin}% margin`);

        // Check monthly trends
        const months = data.monthlySummary || [];
        if (months.length >= 2) {
            const last = months[months.length - 1];
            const prev = months[months.length - 2];
            const revenueChange = ((last.totalCredits - prev.totalCredits) / prev.totalCredits) * 100;
            if (revenueChange < -30) {
                flags.push(`Revenue declining: ${revenueChange.toFixed(0)}% drop month-over-month`);
            }
        }

        // Show/hide alert
        const alertEl = document.getElementById('redFlagAlert');
        const listEl = document.getElementById('redFlagList');

        if (flags.length > 0) {
            listEl.innerHTML = flags.map(f => `<li>${f}</li>`).join('');
            alertEl.classList.add('visible');
        } else {
            alertEl.classList.remove('visible');
        }
    }

    // Heat Calendar Rendering
    function renderHeatCalendar(data) {
        const calendar = document.getElementById('heatCalendar');
        const balances = data.cashFlowData?.dailyBalances || [];

        if (balances.length === 0) {
            calendar.innerHTML = '<div style="color: var(--gray-500); text-align: center; padding: 20px;">No daily data available</div>';
            return;
        }

        // Find min/max for scaling
        const positiveBalances = balances.filter(b => b > 0);
        const maxBalance = Math.max(...positiveBalances, 1);
        const minBalance = Math.min(...balances);

        // Create calendar grid (assume data starts from a date)
        // For simplicity, we'll just show the days we have
        let html = '';

        // Add empty cells for alignment (assume first day is Sunday for simplicity)
        const startDay = 0; // Can be made dynamic
        for (let i = 0; i < startDay; i++) {
            html += '<div class="heat-day empty"></div>';
        }

        balances.forEach((balance, idx) => {
            let levelClass = 'level-0';

            if (balance < 0) {
                levelClass = balance < -1000 ? 'very-negative' : 'negative';
            } else {
                const ratio = balance / maxBalance;
                if (ratio > 0.8) levelClass = 'level-5';
                else if (ratio > 0.6) levelClass = 'level-4';
                else if (ratio > 0.4) levelClass = 'level-3';
                else if (ratio > 0.2) levelClass = 'level-2';
                else if (ratio > 0) levelClass = 'level-1';
            }

            html += `<div class="heat-day ${levelClass}" title="Day ${idx + 1}: ${formatCurrency(balance)}">${idx + 1}</div>`;
        });

        calendar.innerHTML = html;

        // Calculate and display stats
        const negativeDays = balances.filter(b => b < 0).length;
        const lowBalanceDays = balances.filter(b => b >= 0 && b < 500).length;
        const avgBalance = balances.reduce((a, b) => a + b, 0) / balances.length;
        const maxBal = Math.max(...balances);
        const minBal = Math.min(...balances);
        const maxBalIdx = balances.indexOf(maxBal);
        const minBalIdx = balances.indexOf(minBal);

        // Calculate volatility (standard deviation / mean)
        const mean = avgBalance;
        const squaredDiffs = balances.map(b => Math.pow(b - mean, 2));
        const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / squaredDiffs.length;
        const stdDev = Math.sqrt(avgSquaredDiff);
        const volatility = mean !== 0 ? (stdDev / Math.abs(mean)) * 100 : 0;

        document.getElementById('highestBalanceDay').textContent = `Day ${maxBalIdx + 1} (${formatCurrency(maxBal)})`;
        document.getElementById('lowestBalanceDay').textContent = `Day ${minBalIdx + 1} (${formatCurrency(minBal)})`;
        document.getElementById('negativeDaysCount').textContent = negativeDays;
        document.getElementById('negativeDaysCount').className = `heat-stat-value ${negativeDays > 0 ? 'text-danger' : 'text-success'}`;
        document.getElementById('lowBalanceDaysCount').textContent = lowBalanceDays;
        document.getElementById('lowBalanceDaysCount').className = `heat-stat-value ${lowBalanceDays > 5 ? 'text-warning' : ''}`;
        document.getElementById('avgDailyBalance').textContent = formatCurrency(avgBalance);
        document.getElementById('balanceVolatility').textContent = volatility.toFixed(0) + '%';
        document.getElementById('balanceVolatility').className = `heat-stat-value ${volatility > 100 ? 'text-danger' : volatility > 50 ? 'text-warning' : ''}`;
    }

    // Trend Arrows for Month-over-Month Changes
    function getTrendArrow(current, previous) {
        if (!previous || previous === 0) return '';

        const change = ((current - previous) / Math.abs(previous)) * 100;

        if (Math.abs(change) < 2) {
            return `<span class="trend-arrow neutral">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" />
                </svg>
                ${change.toFixed(0)}%
            </span>`;
        } else if (change > 0) {
            return `<span class="trend-arrow up">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
                </svg>
                +${change.toFixed(0)}%
            </span>`;
        } else {
            return `<span class="trend-arrow down">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
                ${change.toFixed(0)}%
            </span>`;
        }
    }

    // Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        // Don't trigger when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch(e.key) {
            case '?':
                showKeyboardShortcuts();
                break;
            case 'n':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    newAnalysis();
                }
                break;
            case 'p':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    printReport();
                }
                break;
            case 's':
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    saveReport();
                }
                break;
            case 'Escape':
                document.getElementById('savedReportsMenu').classList.remove('visible');
                closeSettings();
                break;
        }
    });

    function showKeyboardShortcuts() {
        alert(`Keyboard Shortcuts:

? - Show this help
Ctrl/Cmd + N - New Analysis
Ctrl/Cmd + P - Print Report
Ctrl/Cmd + S - Save Report
Esc - Close menus/dialogs`);
    }

    // Interactive Charts - Add click handlers
    function setupInteractiveCharts() {
        // This would be called after chart rendering
        // Add click listeners for chart data points
        Object.values(chartInstances).forEach(chart => {
            chart.options.onClick = (evt, elements) => {
                if (elements.length > 0) {
                    const element = elements[0];
                    const datasetIndex = element.datasetIndex;
                    const index = element.index;
                    const label = chart.data.labels[index];
                    const value = chart.data.datasets[datasetIndex].data[index];

                    // Show detail popup (simple alert for now)
                    console.log(`Chart clicked: ${label} = ${formatCurrency(value)}`);
                }
            };
        });
    }

    // Custom Scoring Weights (stored in localStorage)
    let scoringWeights = {
        revenue: 25,
        cashFlow: 20,
        nsfOd: 20,
        avgBalance: 15,
        mcaStacking: 20
    };

    function loadScoringWeights() {
        const saved = localStorage.getItem('scoringWeights');
        if (saved) {
            scoringWeights = JSON.parse(saved);
        }
    }

    function saveScoringWeights() {
        localStorage.setItem('scoringWeights', JSON.stringify(scoringWeights));
    }

    function recalculateScore(data) {
        // Custom score calculation based on weights
        let score = 0;
        const risk = data.riskIndicators || {};
        const months = data.monthlySummary || [];

        // Revenue stability
        const revenueScore = months.length > 0 ? Math.min(100, (months[0].totalCredits || 0) / 1000) : 50;
        score += (revenueScore * scoringWeights.revenue) / 100;

        // Cash flow health
        const marginScore = Math.max(0, Math.min(100, (risk.netMargin || 0) + 50));
        score += (marginScore * scoringWeights.cashFlow) / 100;

        // NSF/OD score
        const nsfScore = Math.max(0, 100 - ((risk.nsfCount || 0) + (risk.overdraftCount || 0)) * 10);
        score += (nsfScore * scoringWeights.nsfOd) / 100;

        // Average balance
        const avgBal = months.length > 0 ? months[0].avgBalance || 0 : 0;
        const balScore = Math.min(100, avgBal / 100);
        score += (balScore * scoringWeights.avgBalance) / 100;

        // MCA stacking
        const mcaScore = Math.max(0, 100 - (risk.mcaFound || 0) * 25);
        score += (mcaScore * scoringWeights.mcaStacking) / 100;

        return Math.round(score);
    }

    // Enhanced Stacking Analysis
    function renderEnhancedStackingAnalysis(data) {
        const mca = data.mcaAnalysis || {};
        const positions = mca.positionsFound || [];

        // Calculate total daily payment burden
        let totalDailyBurden = 0;
        positions.forEach(p => {
            if (p.frequency === 'Daily') {
                totalDailyBurden += parseFloat(p.amount) || 0;
            } else if (p.frequency === 'Weekly') {
                totalDailyBurden += (parseFloat(p.amount) || 0) / 5;
            }
        });

        // Update MCA status box with more detail
        const statusBox = document.getElementById('mcaStatusBox');
        const statusTitle = document.getElementById('mcaStatusTitle');
        const statusText = document.getElementById('mcaStatusText');

        if (positions.length === 0) {
            statusBox.style.borderColor = 'var(--success)';
            statusBox.style.background = 'var(--success-bg)';
            statusTitle.textContent = 'No Active MCA Positions Detected';
            statusTitle.style.color = 'var(--success)';
            statusText.textContent = 'This business appears to have no current merchant cash advance obligations.';
        } else {
            statusBox.style.borderColor = 'var(--warning)';
            statusBox.style.background = 'var(--warning-bg)';
            statusTitle.textContent = `${positions.length} Position(s) Detected - Est. ${formatCurrency(totalDailyBurden)}/day burden`;
            statusTitle.style.color = 'var(--warning)';
            statusText.textContent = `Review recurring ACH debits carefully. Total estimated daily payment: ${formatCurrency(totalDailyBurden)}. Consider stacking limits before approval.`;
        }
    }

    // Industry Benchmark Data (mock data - would come from API in production)
    const industryBenchmarks = {
        restaurant: { avgRevenue: 180000, avgMargin: 8, avgBalance: 12000 },
        retail: { avgRevenue: 150000, avgMargin: 12, avgBalance: 15000 },
        services: { avgRevenue: 120000, avgMargin: 15, avgBalance: 10000 },
        construction: { avgRevenue: 250000, avgMargin: 10, avgBalance: 20000 },
        default: { avgRevenue: 150000, avgMargin: 10, avgBalance: 12000 }
    };

    function getIndustryBenchmark(industry) {
        const key = (industry || '').toLowerCase();
        if (key.includes('restaurant') || key.includes('food')) return industryBenchmarks.restaurant;
        if (key.includes('retail') || key.includes('store')) return industryBenchmarks.retail;
        if (key.includes('construct')) return industryBenchmarks.construction;
        if (key.includes('service')) return industryBenchmarks.services;
        return industryBenchmarks.default;
    }

    // Update the original renderReport to call new functions
    const originalRenderReport = renderReport;
    renderReport = function(data) {
        originalRenderReport(data);

        // Call new feature functions
        detectRedFlags(data);
        renderHeatCalendar(data);
        renderEnhancedStackingAnalysis(data);
        setupInteractiveCharts();

        // Load scoring weights
        loadScoringWeights();
    };

    // Initialize on load
    loadScoringWeights();

    // Comparison Mode Functions
    function openComparisonMode() {
        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        // Add current analysis if available
        const options = [...reports];
        if (analysisData && analysisData.businessInfo?.name) {
            options.unshift({
                id: 'current',
                name: analysisData.businessInfo.name + ' (Current)',
                data: analysisData
            });
        }

        if (options.length < 2) {
            alert('You need at least 2 saved reports to compare. Save some reports first!');
            return;
        }

        // Populate dropdowns
        const select1 = document.getElementById('compareSelect1');
        const select2 = document.getElementById('compareSelect2');

        const optionsHtml = '<option value="">Select a business...</option>' +
            options.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

        select1.innerHTML = optionsHtml;
        select2.innerHTML = optionsHtml;

        // Show modal
        document.getElementById('comparisonModal').classList.add('visible');
    }

    function closeComparisonMode() {
        document.getElementById('comparisonModal').classList.remove('visible');
    }

    // Transaction Modal Functions
    function showTransactions(monthIdx, type) {
        if (!analysisData || !analysisData.monthlySummary) return;

        const month = analysisData.monthlySummary[monthIdx];
        if (!month) return;

        const transactions = type === 'credits' ? month.credits : month.debits;
        if (!transactions || transactions.length === 0) return;

        const title = type === 'credits' ? `Deposits - ${month.month}` : `Withdrawals - ${month.month}`;
        document.getElementById('transactionModalTitle').textContent = title;

        const tbody = document.getElementById('transactionTableBody');
        tbody.innerHTML = transactions.map(t => `
            <tr>
                <td>${t.date || '--'}</td>
                <td>${t.description || '--'}</td>
                <td class="${type === 'credits' ? 'amount-credit' : 'amount-debit'}">${type === 'credits' ? '+' : '-'}${formatCurrency(t.amount || 0)}</td>
            </tr>
        `).join('');

        document.getElementById('transactionModal').classList.add('visible');
    }

    function closeTransactionModal() {
        document.getElementById('transactionModal').classList.remove('visible');
    }

    function updateComparison() {
        const select1 = document.getElementById('compareSelect1');
        const select2 = document.getElementById('compareSelect2');
        const grid = document.getElementById('comparisonGrid');

        const id1 = select1.value;
        const id2 = select2.value;

        if (!id1 || !id2) {
            grid.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 40px; grid-column: span 2;">Select two saved reports to compare</div>';
            return;
        }

        const reports = JSON.parse(localStorage.getItem('savedReports') || '[]');

        let data1, data2;

        if (id1 === 'current') {
            data1 = analysisData;
        } else {
            const report1 = reports.find(r => r.id == id1);
            data1 = report1?.data;
        }

        if (id2 === 'current') {
            data2 = analysisData;
        } else {
            const report2 = reports.find(r => r.id == id2);
            data2 = report2?.data;
        }

        if (!data1 || !data2) {
            grid.innerHTML = '<div style="text-align: center; color: var(--danger); padding: 40px; grid-column: span 2;">Error loading report data</div>';
            return;
        }

        // Generate comparison
        grid.innerHTML = renderComparisonCards(data1, data2);
    }

    function renderComparisonCards(data1, data2) {
        const getMonthlyAvg = (data, field) => {
            const months = data.monthlySummary || [];
            if (months.length === 0) return 0;
            return months.reduce((sum, m) => sum + (m[field] || 0), 0) / months.length;
        };

        const metrics = [
            { label: 'Avg Monthly Revenue', key: 'totalCredits', format: formatCurrency, higherBetter: true },
            { label: 'Avg Monthly Debits', key: 'totalDebits', format: formatCurrency, higherBetter: false },
            { label: 'Avg Balance', key: 'avgBalance', format: formatCurrency, higherBetter: true },
            { label: 'Min Balance', key: 'minBalance', format: formatCurrency, higherBetter: true },
            { label: 'NSF Count', key: 'nsfCount', source: 'risk', format: v => v, higherBetter: false },
            { label: 'Overdraft Count', key: 'overdraftCount', source: 'risk', format: v => v, higherBetter: false },
            { label: 'MCA Positions', key: 'mcaFound', source: 'risk', format: v => v, higherBetter: false },
            { label: 'Net Margin', key: 'netMargin', source: 'risk', format: v => v + '%', higherBetter: true }
        ];

        const getValue = (data, metric) => {
            if (metric.source === 'risk') {
                return data.riskIndicators?.[metric.key] || 0;
            }
            return getMonthlyAvg(data, metric.key);
        };

        const name1 = data1.businessInfo?.name || 'Business 1';
        const name2 = data2.businessInfo?.name || 'Business 2';

        let html = `
            <div class="comparison-card">
                <div class="comparison-card-title">${name1}</div>
                ${metrics.map(m => {
                    const val1 = getValue(data1, m);
                    const val2 = getValue(data2, m);
                    const isBetter = m.higherBetter ? val1 > val2 : val1 < val2;
                    const isWorse = m.higherBetter ? val1 < val2 : val1 > val2;
                    const className = val1 === val2 ? '' : (isBetter ? 'comparison-better' : 'comparison-worse');
                    return `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">${m.label}</span>
                            <span class="comparison-metric-value ${className}">${m.format(Math.round(val1))}</span>
                        </div>
                    `;
                }).join('')}
            </div>
            <div class="comparison-card">
                <div class="comparison-card-title">${name2}</div>
                ${metrics.map(m => {
                    const val1 = getValue(data1, m);
                    const val2 = getValue(data2, m);
                    const isBetter = m.higherBetter ? val2 > val1 : val2 < val1;
                    const isWorse = m.higherBetter ? val2 < val1 : val2 > val1;
                    const className = val1 === val2 ? '' : (isBetter ? 'comparison-better' : 'comparison-worse');
                    return `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">${m.label}</span>
                            <span class="comparison-metric-value ${className}">${m.format(Math.round(val2))}</span>
                        </div>
                    `;
                }).join('')}
            </div>
        `;

        return html;
    }
</script>

</body>
</html>
